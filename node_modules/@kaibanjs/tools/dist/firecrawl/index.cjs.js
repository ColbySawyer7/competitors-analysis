"use strict";var e,t;!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const r of e)t[r]=r;return t},e.getValidEnumValues=t=>{const r=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),a={};for(const e of r)a[e]=t[e];return e.objectValues(a)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t},e.find=(e,t)=>{for(const r of e)if(t(r))return r},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(e||(e={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(t||(t={}));const r=e.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),a=e=>{switch(typeof e){case"undefined":return r.undefined;case"string":return r.string;case"number":return isNaN(e)?r.nan:r.number;case"boolean":return r.boolean;case"function":return r.function;case"bigint":return r.bigint;case"symbol":return r.symbol;case"object":return Array.isArray(e)?r.array:null===e?r.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?r.promise:"undefined"!=typeof Map&&e instanceof Map?r.map:"undefined"!=typeof Set&&e instanceof Set?r.set:"undefined"!=typeof Date&&e instanceof Date?r.date:r.object;default:return r.unknown}},n=e.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class i extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},r={_errors:[]},a=e=>{for(const n of e.issues)if("invalid_union"===n.code)n.unionErrors.map(a);else if("invalid_return_type"===n.code)a(n.returnTypeError);else if("invalid_arguments"===n.code)a(n.argumentsError);else if(0===n.path.length)r._errors.push(t(n));else{let e=r,a=0;for(;a<n.path.length;){const r=n.path[a];a===n.path.length-1?(e[r]=e[r]||{_errors:[]},e[r]._errors.push(t(n))):e[r]=e[r]||{_errors:[]},e=e[r],a++}}};return a(this),r}static assert(e){if(!(e instanceof i))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,e.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},r=[];for(const a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}i.create=e=>new i(e);const s=(t,a)=>{let i;switch(t.code){case n.invalid_type:i=t.received===r.undefined?"Required":`Expected ${t.expected}, received ${t.received}`;break;case n.invalid_literal:i=`Invalid literal value, expected ${JSON.stringify(t.expected,e.jsonStringifyReplacer)}`;break;case n.unrecognized_keys:i=`Unrecognized key(s) in object: ${e.joinValues(t.keys,", ")}`;break;case n.invalid_union:i="Invalid input";break;case n.invalid_union_discriminator:i=`Invalid discriminator value. Expected ${e.joinValues(t.options)}`;break;case n.invalid_enum_value:i=`Invalid enum value. Expected ${e.joinValues(t.options)}, received '${t.received}'`;break;case n.invalid_arguments:i="Invalid function arguments";break;case n.invalid_return_type:i="Invalid function return type";break;case n.invalid_date:i="Invalid date";break;case n.invalid_string:"object"==typeof t.validation?"includes"in t.validation?(i=`Invalid input: must include "${t.validation.includes}"`,"number"==typeof t.validation.position&&(i=`${i} at one or more positions greater than or equal to ${t.validation.position}`)):"startsWith"in t.validation?i=`Invalid input: must start with "${t.validation.startsWith}"`:"endsWith"in t.validation?i=`Invalid input: must end with "${t.validation.endsWith}"`:e.assertNever(t.validation):i="regex"!==t.validation?`Invalid ${t.validation}`:"Invalid";break;case n.too_small:i="array"===t.type?`Array must contain ${t.exact?"exactly":t.inclusive?"at least":"more than"} ${t.minimum} element(s)`:"string"===t.type?`String must contain ${t.exact?"exactly":t.inclusive?"at least":"over"} ${t.minimum} character(s)`:"number"===t.type?`Number must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${t.minimum}`:"date"===t.type?`Date must be ${t.exact?"exactly equal to ":t.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(t.minimum))}`:"Invalid input";break;case n.too_big:i="array"===t.type?`Array must contain ${t.exact?"exactly":t.inclusive?"at most":"less than"} ${t.maximum} element(s)`:"string"===t.type?`String must contain ${t.exact?"exactly":t.inclusive?"at most":"under"} ${t.maximum} character(s)`:"number"===t.type?`Number must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:"bigint"===t.type?`BigInt must be ${t.exact?"exactly":t.inclusive?"less than or equal to":"less than"} ${t.maximum}`:"date"===t.type?`Date must be ${t.exact?"exactly":t.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(t.maximum))}`:"Invalid input";break;case n.custom:i="Invalid input";break;case n.invalid_intersection_types:i="Intersection results could not be merged";break;case n.not_multiple_of:i=`Number must be a multiple of ${t.multipleOf}`;break;case n.not_finite:i="Number must be finite";break;default:i=a.defaultError,e.assertNever(t)}return{message:i}};let o=s;function c(){return o}const l=e=>{const{data:t,path:r,errorMaps:a,issueData:n}=e,i=[...r,...n.path||[]],s={...n,path:i};if(void 0!==n.message)return{...n,path:i,message:n.message};let o="";const c=a.filter((e=>!!e)).slice().reverse();for(const e of c)o=e(s,{data:t,defaultError:o}).message;return{...n,path:i,message:o}};function u(e,t){const r=c(),a=l({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,r,r===s?void 0:s].filter((e=>!!e))});e.common.issues.push(a)}class d{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const r=[];for(const a of t){if("aborted"===a.status)return h;"dirty"===a.status&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){const r=[];for(const e of t){const t=await e.key,a=await e.value;r.push({key:t,value:a})}return d.mergeObjectSync(e,r)}static mergeObjectSync(e,t){const r={};for(const a of t){const{key:t,value:n}=a;if("aborted"===t.status)return h;if("aborted"===n.status)return h;"dirty"===t.status&&e.dirty(),"dirty"===n.status&&e.dirty(),"__proto__"===t.value||void 0===n.value&&!a.alwaysSet||(r[t.value]=n.value)}return{status:e.value,value:r}}}const h=Object.freeze({status:"aborted"}),p=e=>({status:"dirty",value:e}),m=e=>({status:"valid",value:e}),f=e=>"aborted"===e.status,g=e=>"dirty"===e.status,y=e=>"valid"===e.status,v=e=>"undefined"!=typeof Promise&&e instanceof Promise;function _(e,t,r,a){if("function"==typeof t?e!==t||!a:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}function b(e,t,r,a,n){if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,r),r}var w,E,O;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(w||(w={}));class T{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const I=(e,t)=>{if(y(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new i(e.common.issues);return this._error=t,this._error}}};function x(e){if(!e)return{};const{errorMap:t,invalid_type_error:r,required_error:a,description:n}=e;if(t&&(r||a))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');if(t)return{errorMap:t,description:n};return{errorMap:(t,n)=>{var i,s;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:n.defaultError}:void 0===n.data?{message:null!==(i=null!=o?o:a)&&void 0!==i?i:n.defaultError}:"invalid_type"!==t.code?{message:n.defaultError}:{message:null!==(s=null!=o?o:r)&&void 0!==s?s:n.defaultError}},description:n}}class k{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return a(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:a(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new d,ctx:{common:e.parent.common,data:e.data,parsedType:a(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(v(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;const n={common:{issues:[],async:null!==(r=null==t?void 0:t.async)&&void 0!==r&&r,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:a(e)},i=this._parseSync({data:e,path:n.path,parent:n});return I(n,i)}async parseAsync(e,t){const r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){const r={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:a(e)},n=this._parse({data:e,path:r.path,parent:r}),i=await(v(n)?n:Promise.resolve(n));return I(r,i)}refine(e,t){const r=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,a)=>{const i=e(t),s=()=>a.addIssue({code:n.custom,...r(t)});return"undefined"!=typeof Promise&&i instanceof Promise?i.then((e=>!!e||(s(),!1))):!!i||(s(),!1)}))}refinement(e,t){return this._refinement(((r,a)=>!!e(r)||(a.addIssue("function"==typeof t?t(r,a):t),!1)))}_refinement(e){return new Ee({schema:this,typeName:je.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Oe.create(this,this._def)}nullable(){return Te.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ae.create(this,this._def)}promise(){return we.create(this,this._def)}or(e){return se.create([this,e],this._def)}and(e){return ue.create(this,e,this._def)}transform(e){return new Ee({...x(this._def),schema:this,typeName:je.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new Ie({...x(this._def),innerType:this,defaultValue:t,typeName:je.ZodDefault})}brand(){return new $e({typeName:je.ZodBranded,type:this,...x(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new xe({...x(this._def),innerType:this,catchValue:t,typeName:je.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return Ne.create(this,e)}readonly(){return Pe.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const S=/^c[^\s-]{8,}$/i,$=/^[0-9a-z]+$/,N=/^[0-9A-HJKMNP-TV-Z]{26}$/,P=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,R=/^[a-z0-9_-]{21}$/i,A=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,j=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let C;const L=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,M=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,U=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,D="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",Z=new RegExp(`^${D}$`);function F(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function H(e){let t=`${D}T${F(e)}`;const r=[];return r.push(e.local?"Z?":"Z"),e.offset&&r.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${r.join("|")})`,new RegExp(`^${t}$`)}function B(e,t){return!("v4"!==t&&t||!L.test(e))||!("v6"!==t&&t||!M.test(e))}class q extends k{_parse(t){this._def.coerce&&(t.data=String(t.data));if(this._getType(t)!==r.string){const e=this._getOrReturnCtx(t);return u(e,{code:n.invalid_type,expected:r.string,received:e.parsedType}),h}const a=new d;let i;for(const r of this._def.checks)if("min"===r.kind)t.data.length<r.value&&(i=this._getOrReturnCtx(t,i),u(i,{code:n.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),a.dirty());else if("max"===r.kind)t.data.length>r.value&&(i=this._getOrReturnCtx(t,i),u(i,{code:n.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),a.dirty());else if("length"===r.kind){const e=t.data.length>r.value,s=t.data.length<r.value;(e||s)&&(i=this._getOrReturnCtx(t,i),e?u(i,{code:n.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}):s&&u(i,{code:n.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}),a.dirty())}else if("email"===r.kind)j.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"email",code:n.invalid_string,message:r.message}),a.dirty());else if("emoji"===r.kind)C||(C=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),C.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"emoji",code:n.invalid_string,message:r.message}),a.dirty());else if("uuid"===r.kind)P.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"uuid",code:n.invalid_string,message:r.message}),a.dirty());else if("nanoid"===r.kind)R.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"nanoid",code:n.invalid_string,message:r.message}),a.dirty());else if("cuid"===r.kind)S.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"cuid",code:n.invalid_string,message:r.message}),a.dirty());else if("cuid2"===r.kind)$.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"cuid2",code:n.invalid_string,message:r.message}),a.dirty());else if("ulid"===r.kind)N.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"ulid",code:n.invalid_string,message:r.message}),a.dirty());else if("url"===r.kind)try{new URL(t.data)}catch(e){i=this._getOrReturnCtx(t,i),u(i,{validation:"url",code:n.invalid_string,message:r.message}),a.dirty()}else if("regex"===r.kind){r.regex.lastIndex=0;r.regex.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"regex",code:n.invalid_string,message:r.message}),a.dirty())}else if("trim"===r.kind)t.data=t.data.trim();else if("includes"===r.kind)t.data.includes(r.value,r.position)||(i=this._getOrReturnCtx(t,i),u(i,{code:n.invalid_string,validation:{includes:r.value,position:r.position},message:r.message}),a.dirty());else if("toLowerCase"===r.kind)t.data=t.data.toLowerCase();else if("toUpperCase"===r.kind)t.data=t.data.toUpperCase();else if("startsWith"===r.kind)t.data.startsWith(r.value)||(i=this._getOrReturnCtx(t,i),u(i,{code:n.invalid_string,validation:{startsWith:r.value},message:r.message}),a.dirty());else if("endsWith"===r.kind)t.data.endsWith(r.value)||(i=this._getOrReturnCtx(t,i),u(i,{code:n.invalid_string,validation:{endsWith:r.value},message:r.message}),a.dirty());else if("datetime"===r.kind){H(r).test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{code:n.invalid_string,validation:"datetime",message:r.message}),a.dirty())}else if("date"===r.kind){Z.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{code:n.invalid_string,validation:"date",message:r.message}),a.dirty())}else if("time"===r.kind){new RegExp(`^${F(r)}$`).test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{code:n.invalid_string,validation:"time",message:r.message}),a.dirty())}else"duration"===r.kind?A.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"duration",code:n.invalid_string,message:r.message}),a.dirty()):"ip"===r.kind?B(t.data,r.version)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"ip",code:n.invalid_string,message:r.message}),a.dirty()):"base64"===r.kind?U.test(t.data)||(i=this._getOrReturnCtx(t,i),u(i,{validation:"base64",code:n.invalid_string,message:r.message}),a.dirty()):e.assertNever(r);return{status:a.value,value:t.data}}_regex(e,t,r){return this.refinement((t=>e.test(t)),{validation:t,code:n.invalid_string,...w.errToObj(r)})}_addCheck(e){return new q({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...w.errToObj(e)})}url(e){return this._addCheck({kind:"url",...w.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...w.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...w.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...w.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...w.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...w.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...w.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...w.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...w.errToObj(e)})}datetime(e){var t,r;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(r=null==e?void 0:e.local)&&void 0!==r&&r,...w.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...w.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...w.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...w.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...w.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...w.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...w.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...w.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...w.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...w.errToObj(t)})}nonempty(e){return this.min(1,w.errToObj(e))}trim(){return new q({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new q({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new q({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function G(e,t){const r=(e.toString().split(".")[1]||"").length,a=(t.toString().split(".")[1]||"").length,n=r>a?r:a;return parseInt(e.toFixed(n).replace(".",""))%parseInt(t.toFixed(n).replace(".",""))/Math.pow(10,n)}q.create=e=>{var t;return new q({checks:[],typeName:je.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...x(e)})};class z extends k{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(t){this._def.coerce&&(t.data=Number(t.data));if(this._getType(t)!==r.number){const e=this._getOrReturnCtx(t);return u(e,{code:n.invalid_type,expected:r.number,received:e.parsedType}),h}let a;const i=new d;for(const r of this._def.checks)if("int"===r.kind)e.isInteger(t.data)||(a=this._getOrReturnCtx(t,a),u(a,{code:n.invalid_type,expected:"integer",received:"float",message:r.message}),i.dirty());else if("min"===r.kind){(r.inclusive?t.data<r.value:t.data<=r.value)&&(a=this._getOrReturnCtx(t,a),u(a,{code:n.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),i.dirty())}else if("max"===r.kind){(r.inclusive?t.data>r.value:t.data>=r.value)&&(a=this._getOrReturnCtx(t,a),u(a,{code:n.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),i.dirty())}else"multipleOf"===r.kind?0!==G(t.data,r.value)&&(a=this._getOrReturnCtx(t,a),u(a,{code:n.not_multiple_of,multipleOf:r.value,message:r.message}),i.dirty()):"finite"===r.kind?Number.isFinite(t.data)||(a=this._getOrReturnCtx(t,a),u(a,{code:n.not_finite,message:r.message}),i.dirty()):e.assertNever(r);return{status:i.value,value:t.data}}gte(e,t){return this.setLimit("min",e,!0,w.toString(t))}gt(e,t){return this.setLimit("min",e,!1,w.toString(t))}lte(e,t){return this.setLimit("max",e,!0,w.toString(t))}lt(e,t){return this.setLimit("max",e,!1,w.toString(t))}setLimit(e,t,r,a){return new z({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:w.toString(a)}]})}_addCheck(e){return new z({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:w.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:w.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:w.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:w.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:w.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:w.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:w.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:w.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:w.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((t=>"int"===t.kind||"multipleOf"===t.kind&&e.isInteger(t.value)))}get isFinite(){let e=null,t=null;for(const r of this._def.checks){if("finite"===r.kind||"int"===r.kind||"multipleOf"===r.kind)return!0;"min"===r.kind?(null===t||r.value>t)&&(t=r.value):"max"===r.kind&&(null===e||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}}z.create=e=>new z({checks:[],typeName:je.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...x(e)});class V extends k{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(t){this._def.coerce&&(t.data=BigInt(t.data));if(this._getType(t)!==r.bigint){const e=this._getOrReturnCtx(t);return u(e,{code:n.invalid_type,expected:r.bigint,received:e.parsedType}),h}let a;const i=new d;for(const r of this._def.checks)if("min"===r.kind){(r.inclusive?t.data<r.value:t.data<=r.value)&&(a=this._getOrReturnCtx(t,a),u(a,{code:n.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),i.dirty())}else if("max"===r.kind){(r.inclusive?t.data>r.value:t.data>=r.value)&&(a=this._getOrReturnCtx(t,a),u(a,{code:n.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),i.dirty())}else"multipleOf"===r.kind?t.data%r.value!==BigInt(0)&&(a=this._getOrReturnCtx(t,a),u(a,{code:n.not_multiple_of,multipleOf:r.value,message:r.message}),i.dirty()):e.assertNever(r);return{status:i.value,value:t.data}}gte(e,t){return this.setLimit("min",e,!0,w.toString(t))}gt(e,t){return this.setLimit("min",e,!1,w.toString(t))}lte(e,t){return this.setLimit("max",e,!0,w.toString(t))}lt(e,t){return this.setLimit("max",e,!1,w.toString(t))}setLimit(e,t,r,a){return new V({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:w.toString(a)}]})}_addCheck(e){return new V({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:w.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:w.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:w.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:w.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:w.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}V.create=e=>{var t;return new V({checks:[],typeName:je.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...x(e)})};class J extends k{_parse(e){this._def.coerce&&(e.data=Boolean(e.data));if(this._getType(e)!==r.boolean){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.boolean,received:t.parsedType}),h}return m(e.data)}}J.create=e=>new J({typeName:je.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...x(e)});class W extends k{_parse(t){this._def.coerce&&(t.data=new Date(t.data));if(this._getType(t)!==r.date){const e=this._getOrReturnCtx(t);return u(e,{code:n.invalid_type,expected:r.date,received:e.parsedType}),h}if(isNaN(t.data.getTime())){return u(this._getOrReturnCtx(t),{code:n.invalid_date}),h}const a=new d;let i;for(const r of this._def.checks)"min"===r.kind?t.data.getTime()<r.value&&(i=this._getOrReturnCtx(t,i),u(i,{code:n.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),a.dirty()):"max"===r.kind?t.data.getTime()>r.value&&(i=this._getOrReturnCtx(t,i),u(i,{code:n.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),a.dirty()):e.assertNever(r);return{status:a.value,value:new Date(t.data.getTime())}}_addCheck(e){return new W({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:w.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:w.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}W.create=e=>new W({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:je.ZodDate,...x(e)});class K extends k{_parse(e){if(this._getType(e)!==r.symbol){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.symbol,received:t.parsedType}),h}return m(e.data)}}K.create=e=>new K({typeName:je.ZodSymbol,...x(e)});class X extends k{_parse(e){if(this._getType(e)!==r.undefined){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.undefined,received:t.parsedType}),h}return m(e.data)}}X.create=e=>new X({typeName:je.ZodUndefined,...x(e)});class Y extends k{_parse(e){if(this._getType(e)!==r.null){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.null,received:t.parsedType}),h}return m(e.data)}}Y.create=e=>new Y({typeName:je.ZodNull,...x(e)});class Q extends k{constructor(){super(...arguments),this._any=!0}_parse(e){return m(e.data)}}Q.create=e=>new Q({typeName:je.ZodAny,...x(e)});class ee extends k{constructor(){super(...arguments),this._unknown=!0}_parse(e){return m(e.data)}}ee.create=e=>new ee({typeName:je.ZodUnknown,...x(e)});class te extends k{_parse(e){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.never,received:t.parsedType}),h}}te.create=e=>new te({typeName:je.ZodNever,...x(e)});class re extends k{_parse(e){if(this._getType(e)!==r.undefined){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.void,received:t.parsedType}),h}return m(e.data)}}re.create=e=>new re({typeName:je.ZodVoid,...x(e)});class ae extends k{_parse(e){const{ctx:t,status:a}=this._processInputParams(e),i=this._def;if(t.parsedType!==r.array)return u(t,{code:n.invalid_type,expected:r.array,received:t.parsedType}),h;if(null!==i.exactLength){const e=t.data.length>i.exactLength.value,r=t.data.length<i.exactLength.value;(e||r)&&(u(t,{code:e?n.too_big:n.too_small,minimum:r?i.exactLength.value:void 0,maximum:e?i.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:i.exactLength.message}),a.dirty())}if(null!==i.minLength&&t.data.length<i.minLength.value&&(u(t,{code:n.too_small,minimum:i.minLength.value,type:"array",inclusive:!0,exact:!1,message:i.minLength.message}),a.dirty()),null!==i.maxLength&&t.data.length>i.maxLength.value&&(u(t,{code:n.too_big,maximum:i.maxLength.value,type:"array",inclusive:!0,exact:!1,message:i.maxLength.message}),a.dirty()),t.common.async)return Promise.all([...t.data].map(((e,r)=>i.type._parseAsync(new T(t,e,t.path,r))))).then((e=>d.mergeArray(a,e)));const s=[...t.data].map(((e,r)=>i.type._parseSync(new T(t,e,t.path,r))));return d.mergeArray(a,s)}get element(){return this._def.type}min(e,t){return new ae({...this._def,minLength:{value:e,message:w.toString(t)}})}max(e,t){return new ae({...this._def,maxLength:{value:e,message:w.toString(t)}})}length(e,t){return new ae({...this._def,exactLength:{value:e,message:w.toString(t)}})}nonempty(e){return this.min(1,e)}}function ne(e){if(e instanceof ie){const t={};for(const r in e.shape){const a=e.shape[r];t[r]=Oe.create(ne(a))}return new ie({...e._def,shape:()=>t})}return e instanceof ae?new ae({...e._def,type:ne(e.element)}):e instanceof Oe?Oe.create(ne(e.unwrap())):e instanceof Te?Te.create(ne(e.unwrap())):e instanceof de?de.create(e.items.map((e=>ne(e)))):e}ae.create=(e,t)=>new ae({type:e,minLength:null,maxLength:null,exactLength:null,typeName:je.ZodArray,...x(t)});class ie extends k{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const t=this._def.shape(),r=e.objectKeys(t);return this._cached={shape:t,keys:r}}_parse(e){if(this._getType(e)!==r.object){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.object,received:t.parsedType}),h}const{status:t,ctx:a}=this._processInputParams(e),{shape:i,keys:s}=this._getCached(),o=[];if(!(this._def.catchall instanceof te&&"strip"===this._def.unknownKeys))for(const e in a.data)s.includes(e)||o.push(e);const c=[];for(const e of s){const t=i[e],r=a.data[e];c.push({key:{status:"valid",value:e},value:t._parse(new T(a,r,a.path,e)),alwaysSet:e in a.data})}if(this._def.catchall instanceof te){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of o)c.push({key:{status:"valid",value:e},value:{status:"valid",value:a.data[e]}});else if("strict"===e)o.length>0&&(u(a,{code:n.unrecognized_keys,keys:o}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of o){const r=a.data[t];c.push({key:{status:"valid",value:t},value:e._parse(new T(a,r,a.path,t)),alwaysSet:t in a.data})}}return a.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of c){const r=await t.key,a=await t.value;e.push({key:r,value:a,alwaysSet:t.alwaysSet})}return e})).then((e=>d.mergeObjectSync(t,e))):d.mergeObjectSync(t,c)}get shape(){return this._def.shape()}strict(e){return w.errToObj,new ie({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,r)=>{var a,n,i,s;const o=null!==(i=null===(n=(a=this._def).errorMap)||void 0===n?void 0:n.call(a,t,r).message)&&void 0!==i?i:r.defaultError;return"unrecognized_keys"===t.code?{message:null!==(s=w.errToObj(e).message)&&void 0!==s?s:o}:{message:o}}}:{}})}strip(){return new ie({...this._def,unknownKeys:"strip"})}passthrough(){return new ie({...this._def,unknownKeys:"passthrough"})}extend(e){return new ie({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new ie({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:je.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new ie({...this._def,catchall:e})}pick(t){const r={};return e.objectKeys(t).forEach((e=>{t[e]&&this.shape[e]&&(r[e]=this.shape[e])})),new ie({...this._def,shape:()=>r})}omit(t){const r={};return e.objectKeys(this.shape).forEach((e=>{t[e]||(r[e]=this.shape[e])})),new ie({...this._def,shape:()=>r})}deepPartial(){return ne(this)}partial(t){const r={};return e.objectKeys(this.shape).forEach((e=>{const a=this.shape[e];t&&!t[e]?r[e]=a:r[e]=a.optional()})),new ie({...this._def,shape:()=>r})}required(t){const r={};return e.objectKeys(this.shape).forEach((e=>{if(t&&!t[e])r[e]=this.shape[e];else{let t=this.shape[e];for(;t instanceof Oe;)t=t._def.innerType;r[e]=t}})),new ie({...this._def,shape:()=>r})}keyof(){return ve(e.objectKeys(this.shape))}}ie.create=(e,t)=>new ie({shape:()=>e,unknownKeys:"strip",catchall:te.create(),typeName:je.ZodObject,...x(t)}),ie.strictCreate=(e,t)=>new ie({shape:()=>e,unknownKeys:"strict",catchall:te.create(),typeName:je.ZodObject,...x(t)}),ie.lazycreate=(e,t)=>new ie({shape:e,unknownKeys:"strip",catchall:te.create(),typeName:je.ZodObject,...x(t)});class se extends k{_parse(e){const{ctx:t}=this._processInputParams(e),r=this._def.options;if(t.common.async)return Promise.all(r.map((async e=>{const r={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:r}),ctx:r}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const r of e)if("dirty"===r.result.status)return t.common.issues.push(...r.ctx.common.issues),r.result;const r=e.map((e=>new i(e.ctx.common.issues)));return u(t,{code:n.invalid_union,unionErrors:r}),h}));{let e;const a=[];for(const n of r){const r={...t,common:{...t.common,issues:[]},parent:null},i=n._parseSync({data:t.data,path:t.path,parent:r});if("valid"===i.status)return i;"dirty"!==i.status||e||(e={result:i,ctx:r}),r.common.issues.length&&a.push(r.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const s=a.map((e=>new i(e)));return u(t,{code:n.invalid_union,unionErrors:s}),h}}get options(){return this._def.options}}se.create=(e,t)=>new se({options:e,typeName:je.ZodUnion,...x(t)});const oe=t=>t instanceof ge?oe(t.schema):t instanceof Ee?oe(t.innerType()):t instanceof ye?[t.value]:t instanceof _e?t.options:t instanceof be?e.objectValues(t.enum):t instanceof Ie?oe(t._def.innerType):t instanceof X?[void 0]:t instanceof Y?[null]:t instanceof Oe?[void 0,...oe(t.unwrap())]:t instanceof Te?[null,...oe(t.unwrap())]:t instanceof $e||t instanceof Pe?oe(t.unwrap()):t instanceof xe?oe(t._def.innerType):[];class ce extends k{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==r.object)return u(t,{code:n.invalid_type,expected:r.object,received:t.parsedType}),h;const a=this.discriminator,i=t.data[a],s=this.optionsMap.get(i);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(u(t,{code:n.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[a]}),h)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){const a=new Map;for(const r of t){const t=oe(r.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const n of t){if(a.has(n))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(n)}`);a.set(n,r)}}return new ce({typeName:je.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...x(r)})}}function le(t,n){const i=a(t),s=a(n);if(t===n)return{valid:!0,data:t};if(i===r.object&&s===r.object){const r=e.objectKeys(n),a=e.objectKeys(t).filter((e=>-1!==r.indexOf(e))),i={...t,...n};for(const e of a){const r=le(t[e],n[e]);if(!r.valid)return{valid:!1};i[e]=r.data}return{valid:!0,data:i}}if(i===r.array&&s===r.array){if(t.length!==n.length)return{valid:!1};const e=[];for(let r=0;r<t.length;r++){const a=le(t[r],n[r]);if(!a.valid)return{valid:!1};e.push(a.data)}return{valid:!0,data:e}}return i===r.date&&s===r.date&&+t==+n?{valid:!0,data:t}:{valid:!1}}class ue extends k{_parse(e){const{status:t,ctx:r}=this._processInputParams(e),a=(e,a)=>{if(f(e)||f(a))return h;const i=le(e.value,a.value);return i.valid?((g(e)||g(a))&&t.dirty(),{status:t.value,value:i.data}):(u(r,{code:n.invalid_intersection_types}),h)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then((([e,t])=>a(e,t))):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}}ue.create=(e,t,r)=>new ue({left:e,right:t,typeName:je.ZodIntersection,...x(r)});class de extends k{_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==r.array)return u(a,{code:n.invalid_type,expected:r.array,received:a.parsedType}),h;if(a.data.length<this._def.items.length)return u(a,{code:n.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),h;!this._def.rest&&a.data.length>this._def.items.length&&(u(a,{code:n.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const i=[...a.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new T(a,e,a.path,t)):null})).filter((e=>!!e));return a.common.async?Promise.all(i).then((e=>d.mergeArray(t,e))):d.mergeArray(t,i)}get items(){return this._def.items}rest(e){return new de({...this._def,rest:e})}}de.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new de({items:e,typeName:je.ZodTuple,rest:null,...x(t)})};class he extends k{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==r.object)return u(a,{code:n.invalid_type,expected:r.object,received:a.parsedType}),h;const i=[],s=this._def.keyType,o=this._def.valueType;for(const e in a.data)i.push({key:s._parse(new T(a,e,a.path,e)),value:o._parse(new T(a,a.data[e],a.path,e)),alwaysSet:e in a.data});return a.common.async?d.mergeObjectAsync(t,i):d.mergeObjectSync(t,i)}get element(){return this._def.valueType}static create(e,t,r){return new he(t instanceof k?{keyType:e,valueType:t,typeName:je.ZodRecord,...x(r)}:{keyType:q.create(),valueType:e,typeName:je.ZodRecord,...x(t)})}}class pe extends k{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==r.map)return u(a,{code:n.invalid_type,expected:r.map,received:a.parsedType}),h;const i=this._def.keyType,s=this._def.valueType,o=[...a.data.entries()].map((([e,t],r)=>({key:i._parse(new T(a,e,a.path,[r,"key"])),value:s._parse(new T(a,t,a.path,[r,"value"]))})));if(a.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const r of o){const a=await r.key,n=await r.value;if("aborted"===a.status||"aborted"===n.status)return h;"dirty"!==a.status&&"dirty"!==n.status||t.dirty(),e.set(a.value,n.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const r of o){const a=r.key,n=r.value;if("aborted"===a.status||"aborted"===n.status)return h;"dirty"!==a.status&&"dirty"!==n.status||t.dirty(),e.set(a.value,n.value)}return{status:t.value,value:e}}}}pe.create=(e,t,r)=>new pe({valueType:t,keyType:e,typeName:je.ZodMap,...x(r)});class me extends k{_parse(e){const{status:t,ctx:a}=this._processInputParams(e);if(a.parsedType!==r.set)return u(a,{code:n.invalid_type,expected:r.set,received:a.parsedType}),h;const i=this._def;null!==i.minSize&&a.data.size<i.minSize.value&&(u(a,{code:n.too_small,minimum:i.minSize.value,type:"set",inclusive:!0,exact:!1,message:i.minSize.message}),t.dirty()),null!==i.maxSize&&a.data.size>i.maxSize.value&&(u(a,{code:n.too_big,maximum:i.maxSize.value,type:"set",inclusive:!0,exact:!1,message:i.maxSize.message}),t.dirty());const s=this._def.valueType;function o(e){const r=new Set;for(const a of e){if("aborted"===a.status)return h;"dirty"===a.status&&t.dirty(),r.add(a.value)}return{status:t.value,value:r}}const c=[...a.data.values()].map(((e,t)=>s._parse(new T(a,e,a.path,t))));return a.common.async?Promise.all(c).then((e=>o(e))):o(c)}min(e,t){return new me({...this._def,minSize:{value:e,message:w.toString(t)}})}max(e,t){return new me({...this._def,maxSize:{value:e,message:w.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}me.create=(e,t)=>new me({valueType:e,minSize:null,maxSize:null,typeName:je.ZodSet,...x(t)});class fe extends k{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==r.function)return u(t,{code:n.invalid_type,expected:r.function,received:t.parsedType}),h;function a(e,r){return l({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,c(),s].filter((e=>!!e)),issueData:{code:n.invalid_arguments,argumentsError:r}})}function o(e,r){return l({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,c(),s].filter((e=>!!e)),issueData:{code:n.invalid_return_type,returnTypeError:r}})}const d={errorMap:t.common.contextualErrorMap},p=t.data;if(this._def.returns instanceof we){const e=this;return m((async function(...t){const r=new i([]),n=await e._def.args.parseAsync(t,d).catch((e=>{throw r.addIssue(a(t,e)),r})),s=await Reflect.apply(p,this,n);return await e._def.returns._def.type.parseAsync(s,d).catch((e=>{throw r.addIssue(o(s,e)),r}))}))}{const e=this;return m((function(...t){const r=e._def.args.safeParse(t,d);if(!r.success)throw new i([a(t,r.error)]);const n=Reflect.apply(p,this,r.data),s=e._def.returns.safeParse(n,d);if(!s.success)throw new i([o(n,s.error)]);return s.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new fe({...this._def,args:de.create(e).rest(ee.create())})}returns(e){return new fe({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new fe({args:e||de.create([]).rest(ee.create()),returns:t||ee.create(),typeName:je.ZodFunction,...x(r)})}}class ge extends k{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}ge.create=(e,t)=>new ge({getter:e,typeName:je.ZodLazy,...x(t)});class ye extends k{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return u(t,{received:t.data,code:n.invalid_literal,expected:this._def.value}),h}return{status:"valid",value:e.data}}get value(){return this._def.value}}function ve(e,t){return new _e({values:e,typeName:je.ZodEnum,...x(t)})}ye.create=(e,t)=>new ye({value:e,typeName:je.ZodLiteral,...x(t)});class _e extends k{constructor(){super(...arguments),E.set(this,void 0)}_parse(t){if("string"!=typeof t.data){const r=this._getOrReturnCtx(t),a=this._def.values;return u(r,{expected:e.joinValues(a),received:r.parsedType,code:n.invalid_type}),h}if(_(this,E)||b(this,E,new Set(this._def.values)),!_(this,E).has(t.data)){const e=this._getOrReturnCtx(t),r=this._def.values;return u(e,{received:e.data,code:n.invalid_enum_value,options:r}),h}return m(t.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return _e.create(e,{...this._def,...t})}exclude(e,t=this._def){return _e.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}E=new WeakMap,_e.create=ve;class be extends k{constructor(){super(...arguments),O.set(this,void 0)}_parse(t){const a=e.getValidEnumValues(this._def.values),i=this._getOrReturnCtx(t);if(i.parsedType!==r.string&&i.parsedType!==r.number){const t=e.objectValues(a);return u(i,{expected:e.joinValues(t),received:i.parsedType,code:n.invalid_type}),h}if(_(this,O)||b(this,O,new Set(e.getValidEnumValues(this._def.values))),!_(this,O).has(t.data)){const t=e.objectValues(a);return u(i,{received:i.data,code:n.invalid_enum_value,options:t}),h}return m(t.data)}get enum(){return this._def.values}}O=new WeakMap,be.create=(e,t)=>new be({values:e,typeName:je.ZodNativeEnum,...x(t)});class we extends k{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==r.promise&&!1===t.common.async)return u(t,{code:n.invalid_type,expected:r.promise,received:t.parsedType}),h;const a=t.parsedType===r.promise?t.data:Promise.resolve(t.data);return m(a.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}we.create=(e,t)=>new we({type:e,typeName:je.ZodPromise,...x(t)});class Ee extends k{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===je.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(t){const{status:r,ctx:a}=this._processInputParams(t),n=this._def.effect||null,i={addIssue:e=>{u(a,e),e.fatal?r.abort():r.dirty()},get path(){return a.path}};if(i.addIssue=i.addIssue.bind(i),"preprocess"===n.type){const e=n.transform(a.data,i);if(a.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===r.value)return h;const t=await this._def.schema._parseAsync({data:e,path:a.path,parent:a});return"aborted"===t.status?h:"dirty"===t.status||"dirty"===r.value?p(t.value):t}));{if("aborted"===r.value)return h;const t=this._def.schema._parseSync({data:e,path:a.path,parent:a});return"aborted"===t.status?h:"dirty"===t.status||"dirty"===r.value?p(t.value):t}}if("refinement"===n.type){const e=e=>{const t=n.refinement(e,i);if(a.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===a.common.async){const t=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});return"aborted"===t.status?h:("dirty"===t.status&&r.dirty(),e(t.value),{status:r.value,value:t.value})}return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then((t=>"aborted"===t.status?h:("dirty"===t.status&&r.dirty(),e(t.value).then((()=>({status:r.value,value:t.value}))))))}if("transform"===n.type){if(!1===a.common.async){const e=this._def.schema._parseSync({data:a.data,path:a.path,parent:a});if(!y(e))return e;const t=n.transform(e.value,i);if(t instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:r.value,value:t}}return this._def.schema._parseAsync({data:a.data,path:a.path,parent:a}).then((e=>y(e)?Promise.resolve(n.transform(e.value,i)).then((e=>({status:r.value,value:e}))):e))}e.assertNever(n)}}Ee.create=(e,t,r)=>new Ee({schema:e,typeName:je.ZodEffects,effect:t,...x(r)}),Ee.createWithPreprocess=(e,t,r)=>new Ee({schema:t,effect:{type:"preprocess",transform:e},typeName:je.ZodEffects,...x(r)});class Oe extends k{_parse(e){return this._getType(e)===r.undefined?m(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Oe.create=(e,t)=>new Oe({innerType:e,typeName:je.ZodOptional,...x(t)});class Te extends k{_parse(e){return this._getType(e)===r.null?m(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}Te.create=(e,t)=>new Te({innerType:e,typeName:je.ZodNullable,...x(t)});class Ie extends k{_parse(e){const{ctx:t}=this._processInputParams(e);let a=t.data;return t.parsedType===r.undefined&&(a=this._def.defaultValue()),this._def.innerType._parse({data:a,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}Ie.create=(e,t)=>new Ie({innerType:e,typeName:je.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...x(t)});class xe extends k{_parse(e){const{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return v(a)?a.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new i(r.common.issues)},input:r.data})}))):{status:"valid",value:"valid"===a.status?a.value:this._def.catchValue({get error(){return new i(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}}xe.create=(e,t)=>new xe({innerType:e,typeName:je.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...x(t)});class ke extends k{_parse(e){if(this._getType(e)!==r.nan){const t=this._getOrReturnCtx(e);return u(t,{code:n.invalid_type,expected:r.nan,received:t.parsedType}),h}return{status:"valid",value:e.data}}}ke.create=e=>new ke({typeName:je.ZodNaN,...x(e)});const Se=Symbol("zod_brand");class $e extends k{_parse(e){const{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}}class Ne extends k{_parse(e){const{status:t,ctx:r}=this._processInputParams(e);if(r.common.async){return(async()=>{const e=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?h:"dirty"===e.status?(t.dirty(),p(e.value)):this._def.out._parseAsync({data:e.value,path:r.path,parent:r})})()}{const e=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return"aborted"===e.status?h:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:r.path,parent:r})}}static create(e,t){return new Ne({in:e,out:t,typeName:je.ZodPipeline})}}class Pe extends k{_parse(e){const t=this._def.innerType._parse(e),r=e=>(y(e)&&(e.value=Object.freeze(e.value)),e);return v(t)?t.then((e=>r(e))):r(t)}unwrap(){return this._def.innerType}}function Re(e,t={},r){return e?Q.create().superRefine(((a,n)=>{var i,s;if(!e(a)){const e="function"==typeof t?t(a):"string"==typeof t?{message:t}:t,o=null===(s=null!==(i=e.fatal)&&void 0!==i?i:r)||void 0===s||s,c="string"==typeof e?{message:e}:e;n.addIssue({code:"custom",...c,fatal:o})}})):Q.create()}Pe.create=(e,t)=>new Pe({innerType:e,typeName:je.ZodReadonly,...x(t)});const Ae={object:ie.lazycreate};var je;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(je||(je={}));const Ce=q.create,Le=z.create,Me=ke.create,Ue=V.create,De=J.create,Ze=W.create,Fe=K.create,He=X.create,Be=Y.create,qe=Q.create,Ge=ee.create,ze=te.create,Ve=re.create,Je=ae.create,We=ie.create,Ke=ie.strictCreate,Xe=se.create,Ye=ce.create,Qe=ue.create,et=de.create,tt=he.create,rt=pe.create,at=me.create,nt=fe.create,it=ge.create,st=ye.create,ot=_e.create,ct=be.create,lt=we.create,ut=Ee.create,dt=Oe.create,ht=Te.create,pt=Ee.createWithPreprocess,mt=Ne.create,ft={string:e=>q.create({...e,coerce:!0}),number:e=>z.create({...e,coerce:!0}),boolean:e=>J.create({...e,coerce:!0}),bigint:e=>V.create({...e,coerce:!0}),date:e=>W.create({...e,coerce:!0})},gt=h;var yt=Object.freeze({__proto__:null,defaultErrorMap:s,setErrorMap:function(e){o=e},getErrorMap:c,makeIssue:l,EMPTY_PATH:[],addIssueToContext:u,ParseStatus:d,INVALID:h,DIRTY:p,OK:m,isAborted:f,isDirty:g,isValid:y,isAsync:v,get util(){return e},get objectUtil(){return t},ZodParsedType:r,getParsedType:a,ZodType:k,datetimeRegex:H,ZodString:q,ZodNumber:z,ZodBigInt:V,ZodBoolean:J,ZodDate:W,ZodSymbol:K,ZodUndefined:X,ZodNull:Y,ZodAny:Q,ZodUnknown:ee,ZodNever:te,ZodVoid:re,ZodArray:ae,ZodObject:ie,ZodUnion:se,ZodDiscriminatedUnion:ce,ZodIntersection:ue,ZodTuple:de,ZodRecord:he,ZodMap:pe,ZodSet:me,ZodFunction:fe,ZodLazy:ge,ZodLiteral:ye,ZodEnum:_e,ZodNativeEnum:be,ZodPromise:we,ZodEffects:Ee,ZodTransformer:Ee,ZodOptional:Oe,ZodNullable:Te,ZodDefault:Ie,ZodCatch:xe,ZodNaN:ke,BRAND:Se,ZodBranded:$e,ZodPipeline:Ne,ZodReadonly:Pe,custom:Re,Schema:k,ZodSchema:k,late:Ae,get ZodFirstPartyTypeKind(){return je},coerce:ft,any:qe,array:Je,bigint:Ue,boolean:De,date:Ze,discriminatedUnion:Ye,effect:ut,enum:ot,function:nt,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>Re((t=>t instanceof e),t),intersection:Qe,lazy:it,literal:st,map:rt,nan:Me,nativeEnum:ct,never:ze,null:Be,nullable:ht,number:Le,object:We,oboolean:()=>De().optional(),onumber:()=>Le().optional(),optional:dt,ostring:()=>Ce().optional(),pipeline:mt,preprocess:pt,promise:lt,record:tt,set:at,strictObject:Ke,string:Ce,symbol:Fe,transformer:ut,tuple:et,undefined:He,union:Xe,unknown:Ge,void:Ve,NEVER:gt,ZodIssueCode:n,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:i}),vt=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i;function _t(e){return"string"==typeof e&&vt.test(e)}for(var bt,wt=[],Et=0;Et<256;++Et)wt.push((Et+256).toString(16).slice(1));var Ot=new Uint8Array(16);function Tt(){if(!bt&&!(bt="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return bt(Ot)}var It={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function xt(e,t,r){if(It.randomUUID&&!t&&!e)return It.randomUUID();var a=(e=e||{}).random||(e.rng||Tt)();return a[6]=15&a[6]|64,a[8]=63&a[8]|128,function(e,t=0){return(wt[e[t+0]]+wt[e[t+1]]+wt[e[t+2]]+wt[e[t+3]]+"-"+wt[e[t+4]]+wt[e[t+5]]+"-"+wt[e[t+6]]+wt[e[t+7]]+"-"+wt[e[t+8]]+wt[e[t+9]]+"-"+wt[e[t+10]]+wt[e[t+11]]+wt[e[t+12]]+wt[e[t+13]]+wt[e[t+14]]+wt[e[t+15]]).toLowerCase()}(a)}function kt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var St=kt((function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()})),$t={exports:{}};const Nt=/[\p{Lu}]/u,Pt=/[\p{Ll}]/u,Rt=/^[\p{Lu}](?![\p{Lu}])/gu,At=/([\p{Alpha}\p{N}_]|$)/u,jt=/[_.\- ]+/,Ct=new RegExp("^"+jt.source),Lt=new RegExp(jt.source+At.source,"gu"),Mt=new RegExp("\\d+"+At.source,"gu"),Ut=(e,t)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(t={pascalCase:!1,preserveConsecutiveUppercase:!1,...t},0===(e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim()).length)return"";const r=!1===t.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(t.locale),a=!1===t.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(t.locale);if(1===e.length)return t.pascalCase?a(e):r(e);return e!==r(e)&&(e=((e,t,r)=>{let a=!1,n=!1,i=!1;for(let s=0;s<e.length;s++){const o=e[s];a&&Nt.test(o)?(e=e.slice(0,s)+"-"+e.slice(s),a=!1,i=n,n=!0,s++):n&&i&&Pt.test(o)?(e=e.slice(0,s-1)+"-"+e.slice(s-1),i=n,n=!1,a=!0):(a=t(o)===o&&r(o)!==o,i=n,n=r(o)===o&&t(o)!==o)}return e})(e,r,a)),e=e.replace(Ct,""),e=t.preserveConsecutiveUppercase?((e,t)=>(Rt.lastIndex=0,e.replace(Rt,(e=>t(e)))))(e,r):r(e),t.pascalCase&&(e=a(e.charAt(0))+e.slice(1)),((e,t)=>(Lt.lastIndex=0,Mt.lastIndex=0,e.replace(Lt,((e,r)=>t(r))).replace(Mt,(e=>t(e)))))(e,a)};function Dt(e,t){return t?.[e]||St(e)}function Zt(e,t,r){const a={};for(const n in e)Object.hasOwn(e,n)&&(a[t(n,r)]=e[n]);return a}function Ft(e){return Array.isArray(e)?[...e]:{...e}}function Ht(e,t){const r=Ft(e);for(const[e,a]of Object.entries(t)){const[t,...n]=e.split(".").reverse();let i=r;for(const e of n.reverse()){if(void 0===i[e])break;i[e]=Ft(i[e]),i=i[e]}void 0!==i[t]&&(i[t]={lc:1,type:"secret",id:[a]})}return r}function Bt(e){const t=Object.getPrototypeOf(e);return"function"==typeof e.lc_name&&("function"!=typeof t.lc_name||e.lc_name()!==t.lc_name())?e.lc_name():e.name}$t.exports=Ut,$t.exports.default=Ut;class qt{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Bt(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof qt||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,a=r;const[n,...i]=e.split(".").reverse();for(const e of i.reverse()){if(!(e in t)||void 0===t[e])return;e in a&&void 0!==a[e]||("object"==typeof t[e]&&null!=t[e]?a[e]={}:Array.isArray(t[e])&&(a[e]=[])),t=t[e],a=a[e]}n in t&&void 0!==t[n]&&(a[n]=a[n]||t[n])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:Zt(Object.keys(t).length?Ht(r,t):r,Dt,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}var Gt="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};function zt(){throw new Error("setTimeout has not been defined")}function Vt(){throw new Error("clearTimeout has not been defined")}var Jt=zt,Wt=Vt;function Kt(e){if(Jt===setTimeout)return setTimeout(e,0);if((Jt===zt||!Jt)&&setTimeout)return Jt=setTimeout,setTimeout(e,0);try{return Jt(e,0)}catch(t){try{return Jt.call(null,e,0)}catch(t){return Jt.call(this,e,0)}}}"function"==typeof Gt.setTimeout&&(Jt=setTimeout),"function"==typeof Gt.clearTimeout&&(Wt=clearTimeout);var Xt,Yt=[],Qt=!1,er=-1;function tr(){Qt&&Xt&&(Qt=!1,Xt.length?Yt=Xt.concat(Yt):er=-1,Yt.length&&rr())}function rr(){if(!Qt){var e=Kt(tr);Qt=!0;for(var t=Yt.length;t;){for(Xt=Yt,Yt=[];++er<t;)Xt&&Xt[er].run();er=-1,t=Yt.length}Xt=null,Qt=!1,function(e){if(Wt===clearTimeout)return clearTimeout(e);if((Wt===Vt||!Wt)&&clearTimeout)return Wt=clearTimeout,clearTimeout(e);try{return Wt(e)}catch(t){try{return Wt.call(null,e)}catch(t){return Wt.call(this,e)}}}(e)}}function ar(e,t){this.fun=e,this.array=t}ar.prototype.run=function(){this.fun.apply(null,this.array)};function nr(){}var ir=nr,sr=nr,or=nr,cr=nr,lr=nr,ur=nr,dr=nr;var hr=Gt.performance||{},pr=hr.now||hr.mozNow||hr.msNow||hr.oNow||hr.webkitNow||function(){return(new Date).getTime()};var mr=new Date;var fr={nextTick:function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];Yt.push(new ar(e,t)),1!==Yt.length||Qt||Kt(rr)},title:"browser",browser:!0,env:{},argv:[],version:"",versions:{},on:ir,addListener:sr,once:or,off:cr,removeListener:lr,removeAllListeners:ur,emit:dr,binding:function(e){throw new Error("process.binding is not supported")},cwd:function(){return"/"},chdir:function(e){throw new Error("process.chdir is not supported")},umask:function(){return 0},hrtime:function(e){var t=.001*pr.call(hr),r=Math.floor(t),a=Math.floor(t%1*1e9);return e&&(r-=e[0],(a-=e[1])<0&&(r--,a+=1e9)),[r,a]},platform:"browser",release:{},config:{},uptime:function(){return(new Date-mr)/1e3}};const gr=()=>"undefined"!=typeof Deno,yr=()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":void 0===fr.versions||void 0===fr.versions.node||gr()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":gr()?"deno":"other":"node",e};let vr;async function _r(){if(void 0===vr){const e=yr();vr={library:"langchain-js",runtime:e}}return vr}function br(e){try{return fr.env?.[e]}catch(e){return}}class wr{}class Er extends wr{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Bt(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==br("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return qt.prototype.toJSON.call(this)}toJSONNotImplemented(){return qt.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends Er{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:xt()}),Object.assign(this,e)}}}}var Or={exports:{}};!function(e){const t=(e=0)=>t=>`[${38+e};5;${t}m`,r=(e=0)=>(t,r,a)=>`[${38+e};2;${t};${r};${a}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[t,r]of Object.entries(a)){for(const[t,n]of Object.entries(r))a[t]={open:`[${n[0]}m`,close:`[${n[1]}m`},r[t]=a[t],e.set(n[0],n[1]);Object.defineProperty(a,t,{value:r,enumerable:!1})}return Object.defineProperty(a,"codes",{value:e,enumerable:!1}),a.color.close="[39m",a.bgColor.close="[49m",a.color.ansi256=t(),a.color.ansi16m=r(),a.bgColor.ansi256=t(10),a.bgColor.ansi16m=r(10),Object.defineProperties(a,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map((e=>e+e)).join(""));const a=Number.parseInt(r,16);return[a>>16&255,a>>8&255,255&a]},enumerable:!1},hexToAnsi256:{value:e=>a.rgbToAnsi256(...a.hexToRgb(e)),enumerable:!1}}),a}})}(Or);var Tr=kt(Or.exports);function Ir(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class xr extends Er{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,r){const a=r.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${a}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),r={...e};if(void 0!==r.parent_run_id){const e=this.runMap.get(r.parent_run_id);e&&(this._addChildRun(e,r),e.child_execution_order=Math.max(e.child_execution_order,r.child_execution_order),r.trace_id=e.trace_id,void 0!==e.dotted_order&&(r.dotted_order=[e.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await(this.onRunCreate?.(r))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,n,i,s,o){const c=this._getExecutionOrder(a),l=Date.now(),u=s?{...n,metadata:s}:n,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleChatModelStart(e,t,r,a,n,i,s,o){const c=this._getExecutionOrder(a),l=Date.now(),u=s?{...n,metadata:s}:n,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:u??{},tags:i||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleLLMEnd(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onLLMEnd?.(r)),await this._endTrace(r),r}async handleLLMError(e,t){const r=this.runMap.get(t);if(!r||"llm"!==r?.run_type)throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onLLMError?.(r)),await this._endTrace(r),r}async handleChainStart(e,t,r,a,n,i,s,o){const c=this._getExecutionOrder(a),l=Date.now(),u={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:s??"chain",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(u),await(this.onChainStart?.(u)),u}async handleChainEnd(e,t,r,a,n){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Ir(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),void 0!==n?.inputs&&(i.inputs=Ir(n.inputs,"input")),await(this.onChainEnd?.(i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,n){const i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),void 0!==n?.inputs&&(i.inputs=Ir(n.inputs,"input")),await(this.onChainError?.(i)),await this._endTrace(i),i}async handleToolStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(l),await(this.onToolStart?.(l)),l}async handleToolEnd(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onToolEnd?.(r)),await this._endTrace(r),r}async handleToolError(e,t){const r=this.runMap.get(t);if(!r||"tool"!==r?.run_type)throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onToolError?.(r)),await this._endTrace(r),r}async handleAgentAction(e,t){const r=this.runMap.get(t);if(!r||"chain"!==r?.run_type)return;const a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(r))}async handleAgentEnd(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(r)))}async handleRetrieverStart(e,t,r,a,n,i,s){const o=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:n||[]};return await this._startTrace(l),await(this.onRetrieverStart?.(l)),l}async handleRetrieverEnd(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverEnd?.(r)),await this._endTrace(r),r}async handleRetrieverError(e,t){const r=this.runMap.get(t);if(!r||"retriever"!==r?.run_type)throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await(this.onRetrieverError?.(r)),await this._endTrace(r),r}async handleText(e,t){const r=this.runMap.get(t);r&&"chain"===r?.run_type&&(r.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(r)))}async handleLLMNewToken(e,t,r,a,n,i){const s=this.runMap.get(r);if(!s||"llm"!==s?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:i?.chunk}}),await(this.onLLMNewToken?.(s,e,{chunk:i?.chunk})),s}}function kr(e,t){return`${e.open}${t}${e.close}`}function Sr(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function $r(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:Nr}=Tr;class Pr extends xr{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const e=this.runMap.get(r.parent_run_id);if(!e)break;t.push(e),r=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,r)=>{const a=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?kr(Tr.bold,a):a})).join(" > ");return kr(Nr.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Sr(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.cyan,"[chain/end]")} [${t}] [${$r(e)}] Exiting Chain run with output: ${Sr(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.red,"[chain/error]")} [${t}] [${$r(e)}] Chain run errored with error: ${Sr(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${kr(Nr.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Sr(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.cyan,"[llm/end]")} [${t}] [${$r(e)}] Exiting LLM run with output: ${Sr(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.red,"[llm/error]")} [${t}] [${$r(e)}] LLM run errored with error: ${Sr(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.cyan,"[tool/end]")} [${t}] [${$r(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.red,"[tool/error]")} [${t}] [${$r(e)}] Tool run errored with error: ${Sr(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Sr(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.cyan,"[retriever/end]")} [${t}] [${$r(e)}] Exiting Retriever run with output: ${Sr(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${kr(Nr.red,"[retriever/error]")} [${t}] [${$r(e)}] Retriever run errored with error: ${Sr(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${kr(Nr.blue,"[agent/action]")} [${r}] Agent selected action: ${Sr(t.actions[t.actions.length-1],"[action]")}`)}}function Rr(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const r=[];let a=!1,n=!1;for(let i of e){if(a)'"'!==i||n?"\n"!==i||n?n="\\"===i&&!n:i="\\n":a=!1;else if('"'===i)a=!0,n=!1;else if("{"===i)r.push("}");else if("["===i)r.push("]");else if("}"===i||"]"===i){if(!r||r[r.length-1]!==i)return null;r.pop()}t+=i}a&&(t+='"');for(let e=r.length-1;e>=0;e-=1)t+=r[e];try{return JSON.parse(t)}catch(e){return null}}class Ar extends qt{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function jr(e,t){const r={...e};for(const[e,a]of Object.entries(t))if(null==r[e])r[e]=a;else{if(null==a)continue;if(typeof r[e]!=typeof a||Array.isArray(r[e])!==Array.isArray(a))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof r[e]){if("type"===e)continue;r[e]+=a}else if("object"!=typeof r[e]||Array.isArray(r[e]))if(Array.isArray(r[e]))r[e]=Cr(r[e],a);else{if(r[e]===a)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else r[e]=jr(r[e],a)}return r}function Cr(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const r=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=r.findIndex((t=>t.index===e.index));-1!==t?r[t]=jr(r[t],e):r.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;r.push(e)}return r}}}class Lr extends Ar{}class Mr extends Ar{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){"string"==typeof e&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}}class Ur extends Lr{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{const r=[],a=[];for(const t of e.tool_call_chunks){let e={};try{if(e=Rr(t.args??"{}")??{},"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");r.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){a.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:r,invalid_tool_calls:a}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:(r=this.content,a=e.content,"string"==typeof r?"string"==typeof a?r+a:[{type:"text",text:r},...a]:Array.isArray(a)?Cr(r,a)??[...r,...a]:[...r,{type:"text",text:a}]),additional_kwargs:jr(this.additional_kwargs,e.additional_kwargs),response_metadata:jr(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};var r,a;if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const r=Cr(this.tool_call_chunks,e.tool_call_chunks);void 0!==r&&r.length>0&&(t.tool_call_chunks=r)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const r=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},a=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},n={input_tokens:r.input_tokens+a.input_tokens,output_tokens:r.output_tokens+a.output_tokens,total_tokens:r.total_tokens+a.total_tokens};t.usage_metadata=n}return new Ur(t)}}var Dr={exports:{}},Zr={};function Fr(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Hr=Fr;Fr.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},Fr.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},Fr.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var a=this;return this._timer=setTimeout((function(){a._attempts++,a._operationTimeoutCb&&(a._timeout=setTimeout((function(){a._operationTimeoutCb(a._attempts)}),a._operationTimeout),a._options.unref&&a._timeout.unref()),a._fn(a._attempts)}),r),this._options.unref&&this._timer.unref(),!0},Fr.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},Fr.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},Fr.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},Fr.prototype.start=Fr.prototype.try,Fr.prototype.errors=function(){return this._errors},Fr.prototype.attempts=function(){return this._attempts},Fr.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,a=0;a<this._errors.length;a++){var n=this._errors[a],i=n.message,s=(e[i]||0)+1;e[i]=s,s>=r&&(t=n,r=s)}return t},function(e){var t=Hr;e.operation=function(r){var a=e.timeouts(r);return new t(a,{forever:r&&(r.forever||r.retries===1/0),unref:r&&r.unref,maxRetryTime:r&&r.maxRetryTime})},e.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var a=[],n=0;n<t.retries;n++)a.push(this.createTimeout(n,t));return e&&e.forever&&!a.length&&a.push(this.createTimeout(n,t)),a.sort((function(e,t){return e-t})),a},e.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,a=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return a=Math.min(a,t.maxTimeout)},e.wrap=function(t,r,a){if(r instanceof Array&&(a=r,r=null),!a)for(var n in a=[],t)"function"==typeof t[n]&&a.push(n);for(var i=0;i<a.length;i++){var s=a[i],o=t[s];t[s]=function(a){var n=e.operation(r),i=Array.prototype.slice.call(arguments,1),s=i.pop();i.push((function(e){n.retry(e)||(e&&(arguments[0]=n.mainError()),s.apply(this,arguments))})),n.attempt((function(){a.apply(t,i)}))}.bind(t,o),t[s].options=r}}}(Zr);const Br=Zr,qr=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class Gr extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const zr=(e,t)=>new Promise(((r,a)=>{t={onFailedAttempt:()=>{},retries:10,...t};const n=Br.operation(t);n.attempt((async i=>{try{r(await e(i))}catch(e){if(!(e instanceof Error))return void a(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof Gr)n.stop(),a(e.originalError);else if(e instanceof TypeError&&(s=e.message,!qr.includes(s)))n.stop(),a(e);else{((e,t,r)=>{const a=r.retries-(t-1);e.attemptNumber=t,e.retriesLeft=a})(e,i,t);try{await t.onFailedAttempt(e)}catch(e){return void a(e)}n.retry(e)||a(n.mainError())}}var s}))}));Dr.exports=zr,Dr.exports.default=zr,Dr.exports.AbortError=Gr;var Vr=kt(Dr.exports),Jr={},Wr={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,r="~";function a(){}function n(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function i(e,t,a,i,s){if("function"!=typeof a)throw new TypeError("The listener must be a function");var o=new n(a,i||e,s),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],o]:e._events[c].push(o):(e._events[c]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new a:delete e._events[t]}function o(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),(new a).__proto__||(r=!1)),o.prototype.eventNames=function(){var e,a,n=[];if(0===this._eventsCount)return n;for(a in e=this._events)t.call(e,a)&&n.push(r?a.slice(1):a);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=r?r+e:e,a=this._events[t];if(!a)return[];if(a.fn)return[a.fn];for(var n=0,i=a.length,s=new Array(i);n<i;n++)s[n]=a[n].fn;return s},o.prototype.listenerCount=function(e){var t=r?r+e:e,a=this._events[t];return a?a.fn?1:a.length:0},o.prototype.emit=function(e,t,a,n,i,s){var o=r?r+e:e;if(!this._events[o])return!1;var c,l,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,a),!0;case 4:return u.fn.call(u.context,t,a,n),!0;case 5:return u.fn.call(u.context,t,a,n,i),!0;case 6:return u.fn.call(u.context,t,a,n,i,s),!0}for(l=1,c=new Array(d-1);l<d;l++)c[l-1]=arguments[l];u.fn.apply(u.context,c)}else{var h,p=u.length;for(l=0;l<p;l++)switch(u[l].once&&this.removeListener(e,u[l].fn,void 0,!0),d){case 1:u[l].fn.call(u[l].context);break;case 2:u[l].fn.call(u[l].context,t);break;case 3:u[l].fn.call(u[l].context,t,a);break;case 4:u[l].fn.call(u[l].context,t,a,n);break;default:if(!c)for(h=1,c=new Array(d-1);h<d;h++)c[h-1]=arguments[h];u[l].fn.apply(u[l].context,c)}}return!0},o.prototype.on=function(e,t,r){return i(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return i(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,a,n){var i=r?r+e:e;if(!this._events[i])return this;if(!t)return s(this,i),this;var o=this._events[i];if(o.fn)o.fn!==t||n&&!o.once||a&&o.context!==a||s(this,i);else{for(var c=0,l=[],u=o.length;c<u;c++)(o[c].fn!==t||n&&!o[c].once||a&&o[c].context!==a)&&l.push(o[c]);l.length?this._events[i]=1===l.length?l[0]:l:s(this,i)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new a,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o}(Wr);var Kr=Wr.exports,Xr={exports:{}};const Yr=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))));let Qr=class extends Error{constructor(e){super(e),this.name="TimeoutError"}};const ea=(e,t,r)=>new Promise(((a,n)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void a(e);const i=setTimeout((()=>{if("function"==typeof r){try{a(r())}catch(e){n(e)}return}const i=r instanceof Error?r:new Qr("string"==typeof r?r:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),n(i)}),t);Yr(e.then(a,n),(()=>{clearTimeout(i)}))}));Xr.exports=ea,Xr.exports.default=ea,Xr.exports.TimeoutError=Qr;var ta=Xr.exports,ra={},aa={};Object.defineProperty(aa,"__esModule",{value:!0}),aa.default=function(e,t,r){let a=0,n=e.length;for(;n>0;){const i=n/2|0;let s=a+i;r(e[s],t)<=0?(a=++s,n-=i+1):n=i}return a},Object.defineProperty(ra,"__esModule",{value:!0});const na=aa;ra.default=class{constructor(){this._queue=[]}enqueue(e,t){const r={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(r);const a=na.default(this._queue,r,((e,t)=>t.priority-e.priority));this._queue.splice(a,0,r)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}},Object.defineProperty(Jr,"__esModule",{value:!0});const ia=Kr,sa=ta,oa=ra,ca=()=>{},la=new sa.TimeoutError;var ua=Jr.default=class extends ia{constructor(e){var t,r,a,n;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=ca,this._resolveIdle=ca,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:oa.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(r=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==r?r:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(n=null===(a=e.interval)||void 0===a?void 0:a.toString())&&void 0!==n?n:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=ca,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=ca,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((r,a)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const n=void 0===this._timeout&&void 0===t.timeout?e():sa.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&a(la)}));r(await n)}catch(e){a(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};const da=(...e)=>fetch(...e),ha=Symbol.for("ls:fetch_implementation"),pa=()=>globalThis[ha]??da,ma=[400,401,403,404,405,406,407,408],fa=[409];let ga,ya=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue="default"in ua?new ua.default({concurrency:this.maxConcurrency}):new ua({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const r=this.onFailedResponseHook;return this.queue.add((()=>Vr((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,a=t?.status;if(a){if(ma.includes(+a))throw e;if(fa.includes(+a))return;r&&await r(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>pa()(...e).then((e=>e.ok?e:Promise.reject(e)))))}};function va(e){return"function"==typeof e?._getType}function _a(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}const ba=()=>"undefined"!=typeof Deno,wa=()=>ga||(ga="undefined"!=typeof window&&void 0!==window.document?"browser":void 0===fr.versions||void 0===fr.versions.node||ba()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":ba()?"deno":"other":"node",ga);let Ea,Oa;async function Ta(){if(void 0===Ea){const e=wa(),t=function(){if(void 0!==Oa)return Oa;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const r of e){const e=xa(r);void 0!==e&&(t[r]=e)}return Oa=t,t}();Ea={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:ms,...t}}return Ea}function Ia(){const e=function(){try{return fr.env?Object.entries(fr.env).reduce(((e,[t,r])=>(e[t]=String(r),e)),{}):void 0}catch(e){return}}()||{},t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[a,n]of Object.entries(e))!a.startsWith("LANGCHAIN_")||"string"!=typeof n||r.includes(a)||a.toLowerCase().includes("key")||a.toLowerCase().includes("secret")||a.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===a?t.revision_id=n:t[a]=n);return t}function xa(e){try{return fr.env?.[e]}catch(e){return}}function ka(e){return xa(`LANGSMITH_${e}`)||xa(`LANGCHAIN_${e}`)}function Sa(e,t){if(!_t(e)){throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`)}return e}const $a={};var Na={exports:{}};var Pa={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||9007199254740991,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2};var Ra=fr.env&&fr.env.NODE_DEBUG&&/\bsemver\b/i.test(fr.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};!function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:r,MAX_SAFE_BUILD_LENGTH:a,MAX_LENGTH:n}=Pa,i=Ra,s=(t=e.exports={}).re=[],o=t.safeRe=[],c=t.src=[],l=t.t={};let u=0;const d="[a-zA-Z0-9-]",h=[["\\s",1],["\\d",n],[d,a]],p=(e,t,r)=>{const a=(e=>{for(const[t,r]of h)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),n=u++;i(e,n,t),l[e]=n,c[n]=t,s[n]=new RegExp(t,r?"g":void 0),o[n]=new RegExp(a,r?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),p("MAINVERSION",`(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})\\.(${c[l.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})\\.(${c[l.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${c[l.NUMERICIDENTIFIER]}|${c[l.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${c[l.NUMERICIDENTIFIERLOOSE]}|${c[l.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${c[l.PRERELEASEIDENTIFIER]}(?:\\.${c[l.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${c[l.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${c[l.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${d}+`),p("BUILD",`(?:\\+(${c[l.BUILDIDENTIFIER]}(?:\\.${c[l.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${c[l.MAINVERSION]}${c[l.PRERELEASE]}?${c[l.BUILD]}?`),p("FULL",`^${c[l.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${c[l.MAINVERSIONLOOSE]}${c[l.PRERELEASELOOSE]}?${c[l.BUILD]}?`),p("LOOSE",`^${c[l.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${c[l.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${c[l.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:\\.(${c[l.XRANGEIDENTIFIER]})(?:${c[l.PRERELEASE]})?${c[l.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:\\.(${c[l.XRANGEIDENTIFIERLOOSE]})(?:${c[l.PRERELEASELOOSE]})?${c[l.BUILD]}?)?)?`),p("XRANGE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${c[l.GTLT]}\\s*${c[l.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${r}})(?:\\.(\\d{1,${r}}))?(?:\\.(\\d{1,${r}}))?`),p("COERCE",`${c[l.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",c[l.COERCEPLAIN]+`(?:${c[l.PRERELEASE]})?`+`(?:${c[l.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",c[l.COERCE],!0),p("COERCERTLFULL",c[l.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${c[l.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",p("TILDE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${c[l.LONETILDE]}${c[l.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${c[l.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",p("CARET",`^${c[l.LONECARET]}${c[l.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${c[l.LONECARET]}${c[l.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${c[l.GTLT]}\\s*(${c[l.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${c[l.GTLT]}\\s*(${c[l.LOOSEPLAIN]}|${c[l.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${c[l.XRANGEPLAIN]})\\s+-\\s+(${c[l.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${c[l.XRANGEPLAINLOOSE]})\\s+-\\s+(${c[l.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(Na,Na.exports);var Aa=Na.exports;const ja=Object.freeze({loose:!0}),Ca=Object.freeze({});var La=e=>e?"object"!=typeof e?ja:e:Ca;const Ma=/^[0-9]+$/,Ua=(e,t)=>{const r=Ma.test(e),a=Ma.test(t);return r&&a&&(e=+e,t=+t),e===t?0:r&&!a?-1:a&&!r?1:e<t?-1:1};var Da={compareIdentifiers:Ua,rcompareIdentifiers:(e,t)=>Ua(t,e)};const Za=Ra,{MAX_LENGTH:Fa,MAX_SAFE_INTEGER:Ha}=Pa,{safeRe:Ba,t:qa}=Aa,Ga=La,{compareIdentifiers:za}=Da;var Va=class e{constructor(t,r){if(r=Ga(r),t instanceof e){if(t.loose===!!r.loose&&t.includePrerelease===!!r.includePrerelease)return t;t=t.version}else if("string"!=typeof t)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof t}".`);if(t.length>Fa)throw new TypeError(`version is longer than ${Fa} characters`);Za("SemVer",t,r),this.options=r,this.loose=!!r.loose,this.includePrerelease=!!r.includePrerelease;const a=t.trim().match(r.loose?Ba[qa.LOOSE]:Ba[qa.FULL]);if(!a)throw new TypeError(`Invalid Version: ${t}`);if(this.raw=t,this.major=+a[1],this.minor=+a[2],this.patch=+a[3],this.major>Ha||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Ha||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Ha||this.patch<0)throw new TypeError("Invalid patch version");a[4]?this.prerelease=a[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<Ha)return t}return e})):this.prerelease=[],this.build=a[5]?a[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(t){if(Za("SemVer.compare",this.version,this.options,t),!(t instanceof e)){if("string"==typeof t&&t===this.version)return 0;t=new e(t,this.options)}return t.version===this.version?0:this.compareMain(t)||this.comparePre(t)}compareMain(t){return t instanceof e||(t=new e(t,this.options)),za(this.major,t.major)||za(this.minor,t.minor)||za(this.patch,t.patch)}comparePre(t){if(t instanceof e||(t=new e(t,this.options)),this.prerelease.length&&!t.prerelease.length)return-1;if(!this.prerelease.length&&t.prerelease.length)return 1;if(!this.prerelease.length&&!t.prerelease.length)return 0;let r=0;do{const e=this.prerelease[r],a=t.prerelease[r];if(Za("prerelease compare",r,e,a),void 0===e&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===e)return-1;if(e!==a)return za(e,a)}while(++r)}compareBuild(t){t instanceof e||(t=new e(t,this.options));let r=0;do{const e=this.build[r],a=t.build[r];if(Za("build compare",r,e,a),void 0===e&&void 0===a)return 0;if(void 0===a)return 1;if(void 0===e)return-1;if(e!==a)return za(e,a)}while(++r)}inc(e,t,r){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(r)?1:0;if(!t&&!1===r)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let a=this.prerelease.length;for(;--a>=0;)"number"==typeof this.prerelease[a]&&(this.prerelease[a]++,a=-2);if(-1===a){if(t===this.prerelease.join(".")&&!1===r)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let a=[t,e];!1===r&&(a=[t]),0===za(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};const Ja=Va;var Wa=(e,t,r=!1)=>{if(e instanceof Ja)return e;try{return new Ja(e,t)}catch(e){if(!r)return null;throw e}};const Ka=Wa;var Xa=(e,t)=>{const r=Ka(e,t);return r?r.version:null};const Ya=Wa;var Qa=(e,t)=>{const r=Ya(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null};const en=Va;var tn=(e,t,r,a,n)=>{"string"==typeof r&&(n=a,a=r,r=void 0);try{return new en(e instanceof en?e.version:e,r).inc(t,a,n).version}catch(e){return null}};const rn=Wa;var an=(e,t)=>{const r=rn(e,null,!0),a=rn(t,null,!0),n=r.compare(a);if(0===n)return null;const i=n>0,s=i?r:a,o=i?a:r,c=!!s.prerelease.length;if(!!o.prerelease.length&&!c)return o.patch||o.minor?s.patch?"patch":s.minor?"minor":"major":"major";const l=c?"pre":"";return r.major!==a.major?l+"major":r.minor!==a.minor?l+"minor":r.patch!==a.patch?l+"patch":"prerelease"};const nn=Va;var sn=(e,t)=>new nn(e,t).major;const on=Va;var cn=(e,t)=>new on(e,t).minor;const ln=Va;var un=(e,t)=>new ln(e,t).patch;const dn=Wa;var hn=(e,t)=>{const r=dn(e,t);return r&&r.prerelease.length?r.prerelease:null};const pn=Va;var mn=(e,t,r)=>new pn(e,r).compare(new pn(t,r));const fn=mn;var gn=(e,t,r)=>fn(t,e,r);const yn=mn;var vn=(e,t)=>yn(e,t,!0);const _n=Va;var bn=(e,t,r)=>{const a=new _n(e,r),n=new _n(t,r);return a.compare(n)||a.compareBuild(n)};const wn=bn;var En=(e,t)=>e.sort(((e,r)=>wn(e,r,t)));const On=bn;var Tn=(e,t)=>e.sort(((e,r)=>On(r,e,t)));const In=mn;var xn=(e,t,r)=>In(e,t,r)>0;const kn=mn;var Sn=(e,t,r)=>kn(e,t,r)<0;const $n=mn;var Nn=(e,t,r)=>0===$n(e,t,r);const Pn=mn;var Rn=(e,t,r)=>0!==Pn(e,t,r);const An=mn;var jn=(e,t,r)=>An(e,t,r)>=0;const Cn=mn;var Ln=(e,t,r)=>Cn(e,t,r)<=0;const Mn=Nn,Un=Rn,Dn=xn,Zn=jn,Fn=Sn,Hn=Ln;var Bn=(e,t,r,a)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return Mn(e,r,a);case"!=":return Un(e,r,a);case">":return Dn(e,r,a);case">=":return Zn(e,r,a);case"<":return Fn(e,r,a);case"<=":return Hn(e,r,a);default:throw new TypeError(`Invalid operator: ${t}`)}};const qn=Va,Gn=Wa,{safeRe:zn,t:Vn}=Aa;var Jn=(e,t)=>{if(e instanceof qn)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let r=null;if((t=t||{}).rtl){const a=t.includePrerelease?zn[Vn.COERCERTLFULL]:zn[Vn.COERCERTL];let n;for(;(n=a.exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&n.index+n[0].length===r.index+r[0].length||(r=n),a.lastIndex=n.index+n[1].length+n[2].length;a.lastIndex=-1}else r=e.match(t.includePrerelease?zn[Vn.COERCEFULL]:zn[Vn.COERCE]);if(null===r)return null;const a=r[2],n=r[3]||"0",i=r[4]||"0",s=t.includePrerelease&&r[5]?`-${r[5]}`:"",o=t.includePrerelease&&r[6]?`+${r[6]}`:"";return Gn(`${a}.${n}.${i}${s}${o}`,t)};var Wn,Kn,Xn,Yn,Qn=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}};function ei(){if(Kn)return Wn;Kn=1;const e=/\s+/g;class t{constructor(r,i){if(i=a(i),r instanceof t)return r.loose===!!i.loose&&r.includePrerelease===!!i.includePrerelease?r:new t(r.raw,i);if(r instanceof n)return this.raw=r.value,this.set=[[r]],this.formatted=void 0,this;if(this.options=i,this.loose=!!i.loose,this.includePrerelease=!!i.includePrerelease,this.raw=r.trim().replace(e," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!m(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&f(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&h)|(this.options.loose&&p))+":"+e,a=r.get(t);if(a)return a;const s=this.options.loose,f=s?o[c.HYPHENRANGELOOSE]:o[c.HYPHENRANGE];e=e.replace(f,k(this.options.includePrerelease)),i("hyphen replace",e),e=e.replace(o[c.COMPARATORTRIM],l),i("comparator trim",e),e=e.replace(o[c.TILDETRIM],u),i("tilde trim",e),e=e.replace(o[c.CARETTRIM],d),i("caret trim",e);let g=e.split(" ").map((e=>y(e,this.options))).join(" ").split(/\s+/).map((e=>x(e,this.options)));s&&(g=g.filter((e=>(i("loose invalid filter",e,this.options),!!e.match(o[c.COMPARATORLOOSE]))))),i("range list",g);const v=new Map,_=g.map((e=>new n(e,this.options)));for(const e of _){if(m(e))return[e];v.set(e.value,e)}v.size>1&&v.has("")&&v.delete("");const b=[...v.values()];return r.set(t,b),b}intersects(e,r){if(!(e instanceof t))throw new TypeError("a Range is required");return this.set.some((t=>g(t,r)&&e.set.some((e=>g(e,r)&&t.every((t=>e.every((e=>t.intersects(e,r)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new s(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(S(this.set[t],e,this.options))return!0;return!1}}Wn=t;const r=new Qn,a=La,n=ti(),i=Ra,s=Va,{safeRe:o,t:c,comparatorTrimReplace:l,tildeTrimReplace:u,caretTrimReplace:d}=Aa,{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:p}=Pa,m=e=>"<0.0.0-0"===e.value,f=e=>""===e.value,g=(e,t)=>{let r=!0;const a=e.slice();let n=a.pop();for(;r&&a.length;)r=a.every((e=>n.intersects(e,t))),n=a.pop();return r},y=(e,t)=>(i("comp",e,t),e=w(e,t),i("caret",e),e=_(e,t),i("tildes",e),e=O(e,t),i("xrange",e),e=I(e,t),i("stars",e),e),v=e=>!e||"x"===e.toLowerCase()||"*"===e,_=(e,t)=>e.trim().split(/\s+/).map((e=>b(e,t))).join(" "),b=(e,t)=>{const r=t.loose?o[c.TILDELOOSE]:o[c.TILDE];return e.replace(r,((t,r,a,n,s)=>{let o;return i("tilde",e,t,r,a,n,s),v(r)?o="":v(a)?o=`>=${r}.0.0 <${+r+1}.0.0-0`:v(n)?o=`>=${r}.${a}.0 <${r}.${+a+1}.0-0`:s?(i("replaceTilde pr",s),o=`>=${r}.${a}.${n}-${s} <${r}.${+a+1}.0-0`):o=`>=${r}.${a}.${n} <${r}.${+a+1}.0-0`,i("tilde return",o),o}))},w=(e,t)=>e.trim().split(/\s+/).map((e=>E(e,t))).join(" "),E=(e,t)=>{i("caret",e,t);const r=t.loose?o[c.CARETLOOSE]:o[c.CARET],a=t.includePrerelease?"-0":"";return e.replace(r,((t,r,n,s,o)=>{let c;return i("caret",e,t,r,n,s,o),v(r)?c="":v(n)?c=`>=${r}.0.0${a} <${+r+1}.0.0-0`:v(s)?c="0"===r?`>=${r}.${n}.0${a} <${r}.${+n+1}.0-0`:`>=${r}.${n}.0${a} <${+r+1}.0.0-0`:o?(i("replaceCaret pr",o),c="0"===r?"0"===n?`>=${r}.${n}.${s}-${o} <${r}.${n}.${+s+1}-0`:`>=${r}.${n}.${s}-${o} <${r}.${+n+1}.0-0`:`>=${r}.${n}.${s}-${o} <${+r+1}.0.0-0`):(i("no pr"),c="0"===r?"0"===n?`>=${r}.${n}.${s}${a} <${r}.${n}.${+s+1}-0`:`>=${r}.${n}.${s}${a} <${r}.${+n+1}.0-0`:`>=${r}.${n}.${s} <${+r+1}.0.0-0`),i("caret return",c),c}))},O=(e,t)=>(i("replaceXRanges",e,t),e.split(/\s+/).map((e=>T(e,t))).join(" ")),T=(e,t)=>{e=e.trim();const r=t.loose?o[c.XRANGELOOSE]:o[c.XRANGE];return e.replace(r,((r,a,n,s,o,c)=>{i("xRange",e,r,a,n,s,o,c);const l=v(n),u=l||v(s),d=u||v(o),h=d;return"="===a&&h&&(a=""),c=t.includePrerelease?"-0":"",l?r=">"===a||"<"===a?"<0.0.0-0":"*":a&&h?(u&&(s=0),o=0,">"===a?(a=">=",u?(n=+n+1,s=0,o=0):(s=+s+1,o=0)):"<="===a&&(a="<",u?n=+n+1:s=+s+1),"<"===a&&(c="-0"),r=`${a+n}.${s}.${o}${c}`):u?r=`>=${n}.0.0${c} <${+n+1}.0.0-0`:d&&(r=`>=${n}.${s}.0${c} <${n}.${+s+1}.0-0`),i("xRange return",r),r}))},I=(e,t)=>(i("replaceStars",e,t),e.trim().replace(o[c.STAR],"")),x=(e,t)=>(i("replaceGTE0",e,t),e.trim().replace(o[t.includePrerelease?c.GTE0PRE:c.GTE0],"")),k=e=>(t,r,a,n,i,s,o,c,l,u,d,h)=>`${r=v(a)?"":v(n)?`>=${a}.0.0${e?"-0":""}`:v(i)?`>=${a}.${n}.0${e?"-0":""}`:s?`>=${r}`:`>=${r}${e?"-0":""}`} ${c=v(l)?"":v(u)?`<${+l+1}.0.0-0`:v(d)?`<${l}.${+u+1}.0-0`:h?`<=${l}.${u}.${d}-${h}`:e?`<${l}.${u}.${+d+1}-0`:`<=${c}`}`.trim(),S=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(i(e[r].semver),e[r].semver!==n.ANY&&e[r].semver.prerelease.length>0){const a=e[r].semver;if(a.major===t.major&&a.minor===t.minor&&a.patch===t.patch)return!0}return!1}return!0};return Wn}function ti(){if(Yn)return Xn;Yn=1;const e=Symbol("SemVer ANY");class t{static get ANY(){return e}constructor(a,n){if(n=r(n),a instanceof t){if(a.loose===!!n.loose)return a;a=a.value}a=a.trim().split(/\s+/).join(" "),s("comparator",a,n),this.options=n,this.loose=!!n.loose,this.parse(a),this.semver===e?this.value="":this.value=this.operator+this.semver.version,s("comp",this)}parse(t){const r=this.options.loose?a[n.COMPARATORLOOSE]:a[n.COMPARATOR],i=t.match(r);if(!i)throw new TypeError(`Invalid comparator: ${t}`);this.operator=void 0!==i[1]?i[1]:"","="===this.operator&&(this.operator=""),i[2]?this.semver=new o(i[2],this.options.loose):this.semver=e}toString(){return this.value}test(t){if(s("Comparator.test",t,this.options.loose),this.semver===e||t===e)return!0;if("string"==typeof t)try{t=new o(t,this.options)}catch(e){return!1}return i(t,this.operator,this.semver,this.options)}intersects(e,a){if(!(e instanceof t))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new c(e.value,a).test(this.value):""===e.operator?""===e.value||new c(this.value,a).test(e.semver):(!(a=r(a)).includePrerelease||"<0.0.0-0"!==this.value&&"<0.0.0-0"!==e.value)&&(!(!a.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&(!(!this.operator.startsWith(">")||!e.operator.startsWith(">"))||(!(!this.operator.startsWith("<")||!e.operator.startsWith("<"))||(!(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))||(!!(i(this.semver,"<",e.semver,a)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))||!!(i(this.semver,">",e.semver,a)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))))))}}Xn=t;const r=La,{safeRe:a,t:n}=Aa,i=Bn,s=Ra,o=Va,c=ei();return Xn}const ri=ei();var ai=(e,t,r)=>{try{t=new ri(t,r)}catch(e){return!1}return t.test(e)};const ni=ei();var ii=(e,t)=>new ni(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")));const si=Va,oi=ei();var ci=(e,t,r)=>{let a=null,n=null,i=null;try{i=new oi(t,r)}catch(e){return null}return e.forEach((e=>{i.test(e)&&(a&&-1!==n.compare(e)||(a=e,n=new si(a,r)))})),a};const li=Va,ui=ei();var di=(e,t,r)=>{let a=null,n=null,i=null;try{i=new ui(t,r)}catch(e){return null}return e.forEach((e=>{i.test(e)&&(a&&1!==n.compare(e)||(a=e,n=new li(a,r)))})),a};const hi=Va,pi=ei(),mi=xn;var fi=(e,t)=>{e=new pi(e,t);let r=new hi("0.0.0");if(e.test(r))return r;if(r=new hi("0.0.0-0"),e.test(r))return r;r=null;for(let t=0;t<e.set.length;++t){const a=e.set[t];let n=null;a.forEach((e=>{const t=new hi(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":n&&!mi(t,n)||(n=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!n||r&&!mi(r,n)||(r=n)}return r&&e.test(r)?r:null};const gi=ei();var yi=(e,t)=>{try{return new gi(e,t).range||"*"}catch(e){return null}};const vi=Va,_i=ti(),{ANY:bi}=_i,wi=ei(),Ei=ai,Oi=xn,Ti=Sn,Ii=Ln,xi=jn;var ki=(e,t,r,a)=>{let n,i,s,o,c;switch(e=new vi(e,a),t=new wi(t,a),r){case">":n=Oi,i=Ii,s=Ti,o=">",c=">=";break;case"<":n=Ti,i=xi,s=Oi,o="<",c="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(Ei(e,t,a))return!1;for(let r=0;r<t.set.length;++r){const l=t.set[r];let u=null,d=null;if(l.forEach((e=>{e.semver===bi&&(e=new _i(">=0.0.0")),u=u||e,d=d||e,n(e.semver,u.semver,a)?u=e:s(e.semver,d.semver,a)&&(d=e)})),u.operator===o||u.operator===c)return!1;if((!d.operator||d.operator===o)&&i(e,d.semver))return!1;if(d.operator===c&&s(e,d.semver))return!1}return!0};const Si=ki;var $i=(e,t,r)=>Si(e,t,">",r);const Ni=ki;var Pi=(e,t,r)=>Ni(e,t,"<",r);const Ri=ei();var Ai=(e,t,r)=>(e=new Ri(e,r),t=new Ri(t,r),e.intersects(t,r));const ji=ai,Ci=mn;const Li=ei(),Mi=ti(),{ANY:Ui}=Mi,Di=ai,Zi=mn,Fi=[new Mi(">=0.0.0-0")],Hi=[new Mi(">=0.0.0")],Bi=(e,t,r)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===Ui){if(1===t.length&&t[0].semver===Ui)return!0;e=r.includePrerelease?Fi:Hi}if(1===t.length&&t[0].semver===Ui){if(r.includePrerelease)return!0;t=Hi}const a=new Set;let n,i,s,o,c,l,u;for(const t of e)">"===t.operator||">="===t.operator?n=qi(n,t,r):"<"===t.operator||"<="===t.operator?i=Gi(i,t,r):a.add(t.semver);if(a.size>1)return null;if(n&&i){if(s=Zi(n.semver,i.semver,r),s>0)return null;if(0===s&&(">="!==n.operator||"<="!==i.operator))return null}for(const e of a){if(n&&!Di(e,String(n),r))return null;if(i&&!Di(e,String(i),r))return null;for(const a of t)if(!Di(e,String(a),r))return!1;return!0}let d=!(!i||r.includePrerelease||!i.semver.prerelease.length)&&i.semver,h=!(!n||r.includePrerelease||!n.semver.prerelease.length)&&n.semver;d&&1===d.prerelease.length&&"<"===i.operator&&0===d.prerelease[0]&&(d=!1);for(const e of t){if(u=u||">"===e.operator||">="===e.operator,l=l||"<"===e.operator||"<="===e.operator,n)if(h&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===h.major&&e.semver.minor===h.minor&&e.semver.patch===h.patch&&(h=!1),">"===e.operator||">="===e.operator){if(o=qi(n,e,r),o===e&&o!==n)return!1}else if(">="===n.operator&&!Di(n.semver,String(e),r))return!1;if(i)if(d&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===d.major&&e.semver.minor===d.minor&&e.semver.patch===d.patch&&(d=!1),"<"===e.operator||"<="===e.operator){if(c=Gi(i,e,r),c===e&&c!==i)return!1}else if("<="===i.operator&&!Di(i.semver,String(e),r))return!1;if(!e.operator&&(i||n)&&0!==s)return!1}return!(n&&l&&!i&&0!==s)&&(!(i&&u&&!n&&0!==s)&&(!h&&!d))},qi=(e,t,r)=>{if(!e)return t;const a=Zi(e.semver,t.semver,r);return a>0?e:a<0||">"===t.operator&&">="===e.operator?t:e},Gi=(e,t,r)=>{if(!e)return t;const a=Zi(e.semver,t.semver,r);return a<0?e:a>0||"<"===t.operator&&"<="===e.operator?t:e};var zi=(e,t,r={})=>{if(e===t)return!0;e=new Li(e,r),t=new Li(t,r);let a=!1;e:for(const n of e.set){for(const e of t.set){const t=Bi(n,e,r);if(a=a||null!==t,t)continue e}if(a)return!1}return!0};const Vi=Aa,Ji=Pa,Wi=Va,Ki=Da,Xi=(e,t,r)=>{const a=[];let n=null,i=null;const s=e.sort(((e,t)=>Ci(e,t,r)));for(const e of s){ji(e,t,r)?(i=e,n||(n=e)):(i&&a.push([n,i]),i=null,n=null)}n&&a.push([n,null]);const o=[];for(const[e,t]of a)e===t?o.push(e):t||e!==s[0]?t?e===s[0]?o.push(`<=${t}`):o.push(`${e} - ${t}`):o.push(`>=${e}`):o.push("*");const c=o.join(" || "),l="string"==typeof t.raw?t.raw:String(t);return c.length<l.length?c:t};var Yi={parse:Wa,valid:Xa,clean:Qa,inc:tn,diff:an,major:sn,minor:cn,patch:un,prerelease:hn,compare:mn,rcompare:gn,compareLoose:vn,compareBuild:bn,sort:En,rsort:Tn,gt:xn,lt:Sn,eq:Nn,neq:Rn,gte:jn,lte:Ln,cmp:Bn,coerce:Jn,Comparator:ti(),Range:ei(),satisfies:ai,toComparators:ii,maxSatisfying:ci,minSatisfying:di,minVersion:fi,validRange:yi,outside:ki,gtr:$i,ltr:Pi,intersects:Ai,simplifyRange:Xi,subset:zi,SemVer:Wi,re:Vi.re,src:Vi.src,tokens:Vi.t,SEMVER_SPEC_VERSION:Ji.SEMVER_SPEC_VERSION,RELEASE_TYPES:Ji.RELEASE_TYPES,compareIdentifiers:Ki.compareIdentifiers,rcompareIdentifiers:Ki.rcompareIdentifiers};function Qi(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,r]=e.split(":"),a=r||"latest";if(t.includes("/")){const[r,n]=t.split("/",2);if(!r||!n)throw new Error(`Invalid identifier format: ${e}`);return[r,n,a]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,a]}class es extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function ts(e,t,r){let a;if(e.ok)return void(r&&(a=await e.text()));a=await e.text();const n=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${a}`;if(409===e.status)throw new es(n);throw new Error(n)}var rs="[...]",as={result:"[Circular]"},ns=[],is=[];function ss(e,t,r,a){var n;void 0===a&&(a={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),cs(e,"",0,[],void 0,0,a);try{n=0===is.length?JSON.stringify(e,t,r):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,r){if(is.length>0)for(var a=0;a<is.length;a++){var n=is[a];if(n[1]===t&&n[0]===r){r=n[2],is.splice(a,1);break}}return e.call(this,t,r)}}(t),r)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==ns.length;){var i=ns.pop();4===i.length?Object.defineProperty(i[0],i[1],i[3]):i[0][i[1]]=i[2]}}return n}function os(e,t,r,a){var n=Object.getOwnPropertyDescriptor(a,r);void 0!==n.get?n.configurable?(Object.defineProperty(a,r,{value:e}),ns.push([a,r,t,n])):is.push([t,r,e]):(a[r]=e,ns.push([a,r,t]))}function cs(e,t,r,a,n,i,s){var o;if(i+=1,"object"==typeof e&&null!==e){for(o=0;o<a.length;o++)if(a[o]===e)return void os(as,e,t,n);if(void 0!==s.depthLimit&&i>s.depthLimit)return void os(rs,e,t,n);if(void 0!==s.edgesLimit&&r+1>s.edgesLimit)return void os(rs,e,t,n);if(a.push(e),Array.isArray(e))for(o=0;o<e.length;o++)cs(e[o],o,o,a,e,i,s);else{var c=Object.keys(e);for(o=0;o<c.length;o++){var l=c[o];cs(e[l],l,o,a,e,i,s)}}a.pop()}}async function ls(e){const t=await Ta(),r=Ia();return e.map((e=>{const a=e.extra??{},n=a.metadata;return e.extra={...a,runtime:{...t,...a?.runtime},metadata:{...r,...r.revision_id||e.revision_id?{revision_id:e.revision_id??r.revision_id}:{},...n}},e}))}function us(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const ds=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class hs{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){let t;const r=new Promise((e=>{t=e}));return this.items.push([e,t,r]),r}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");const t=[];for(;t.length<e&&this.items.length;){const e=this.items.shift();if(!e)break;t.push(e)}return[t.map((e=>e[0])),()=>t.forEach((e=>e[1]()))]}}class ps{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new hs}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=ps.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=ka("TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=us(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=us(e.apiKey??t.apiKey),this.webUrl=us(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??12e3,this.caller=new ya(e.callerOptions??{}),this.batchIngestCaller=new ya({...e.callerOptions??{},onFailedResponseHook:ds}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.pendingAutoBatchedRunLimit=e.pendingAutoBatchedRunLimit??this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=ka("API_KEY");return{apiUrl:ka("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===ka("HIDE_INPUTS"),hideOutputs:"true"===ka("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${ms}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`,n=await this.caller.call(pa(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ts(n,`Failed to fetch ${e}`),n}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0;const n=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(n));const i=`${this.apiUrl}${e}?${t}`,s=await this.caller.call(pa(),i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(s,`Failed to fetch ${e}`);const o=r?r(await s.json()):await s.json();if(0===o.length)break;if(yield o,o.length<n)break;a+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){const n=t?{...t}:{};for(;;){const t=await this.caller.call(pa(),`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(n)}),i=await t.json();if(!i)break;if(!i[a])break;yield i[a];const s=i.cursors;if(!s)break;if(!s.next)break;n.cursor=s.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const r of e)this.filteredPostUuids.has(r.id)?this.filteredPostUuids.delete(r.id):t.push(r);return t}{const t=[];for(const r of e)r.id!==r.trace_id&&!this.filteredPostUuids.has(r.trace_id)||Math.random()<this.tracingSampleRate?t.push(r):this.filteredPostUuids.add(r.id);return t}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){const[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length)return void t();try{await this.batchIngestRuns({runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))})}finally{t()}}}async processRunOperation(e,t){const r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;const a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue().catch(console.error),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)}),r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){const e=await pa()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ts(e,"get server info"),e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch(e){return!1}return!0}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;const a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order)return void this.processRunOperation({action:"create",item:a}).catch(console.error);const n=await ls([a]),i=await this.caller.call(pa(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:ss(n[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(i,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let r=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],a=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(r.length>0&&a.length>0){const e=r.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const r of a)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);r=Object.values(e),a=t}const n={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!n.post.length&&!n.patch.length)return;if(r=await ls(r),void 0===this.batchEndpointSupported&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(const e of n.post)await this.createRun(e);for(const e of n.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const i=this.serverInfo?.batch_ingest_config?.size_limit_bytes??20971520,s={post:[],patch:[]};let o=0;for(const e of["post","patch"]){const t=e,r=n[t].reverse();let a=r.pop();for(;void 0!==a;){const e=ss(a);o>0&&o+e.length>i&&(await this._postBatchIngestRuns(ss(s)),o=0,s.post=[],s.patch=[]),o+=e.length,s[t].push(a),a=r.pop()}}(s.post.length>0||s.patch.length>0)&&await this._postBatchIngestRuns(ss(s))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(pa(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(r,"batch create run",!0)}async updateRun(e,t){Sa(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void 0!==t.end_time&&void 0===r.parent_run_id&&this.blockOnRootRunFinalization?void await this.processRunOperation({action:"update",item:r},!0):void this.processRunOperation({action:"update",item:r}).catch(console.error);const a={...this.headers,"Content-Type":"application/json"},n=await this.caller.call(pa(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:ss(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(n,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){Sa(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;if(t.session_id)e=t.session_id;else if(r?.projectName)e=(await this.readProject({projectName:r?.projectName})).id;else if(r?.projectId)e=r?.projectId;else{e=(await this.readProject({projectName:ka("PROJECT")||"default"})).id}const a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const r of e)t.push(r);return t}(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in r||(r[e.parent_run_id]=[]),r[e.parent_run_id].push(e),a[e.id]=e}e.child_runs=r[e.id]||[];for(const t in r)t!==e.id&&(a[t].child_runs=r[t]);return e}async*listRuns(e){const{projectId:t,projectName:r,parentRunId:a,traceId:n,referenceExampleId:i,startTime:s,executionOrder:o,isRoot:c,runType:l,error:u,id:d,query:h,filter:p,traceFilter:m,treeFilter:f,limit:g,select:y}=e;let v=[];if(t&&(v=Array.isArray(t)?t:[t]),r){const e=Array.isArray(r)?r:[r],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));v.push(...t)}const _={session:v.length?v:null,run_type:l,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:f,execution_order:o,parent_run:a,start_time:s?s.toISOString():null,error:u,id:d,limit:g,trace:n,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:c};let b=0;for await(const e of this._getCursorPaginatedList("/runs/query",_))if(g){if(b>=g)break;if(e.length+b>g){const t=e.slice(0,g-b);yield*t;break}b+=e.length,yield*e}else yield*e}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:n,projectIds:i,referenceExampleIds:s,startTime:o,endTime:c,error:l,query:u,filter:d,traceFilter:h,treeFilter:p,isRoot:m,dataSourceType:f}){let g=i||[];n&&(g=[...i||[],...await Promise.all(n.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const y={id:e,trace:t,parent_run:r,run_type:a,session:g,reference_example:s,start_time:o,end_time:c,error:l,query:u,filter:d,trace_filter:h,tree_filter:p,is_root:m,data_source_type:f},v=Object.fromEntries(Object.entries(y).filter((([e,t])=>void 0!==t))),_=await this.caller.call(pa(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(v),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await _.json()}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||xt()};Sa(e);const a=await this.caller.call(pa(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await a.json();if(null===n||!("share_token"in n))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${n.share_token}/r`}async unshareRun(e){Sa(e);const t=await this.caller.call(pa(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(t,"unshare run",!0)}async readRunSharedLink(e){Sa(e);const t=await this.caller.call(pa(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)r.append("id",e);Sa(e);const a=await this.caller.call(pa(),`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}Sa(e);const r=await this.caller.call(pa(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}const r={dataset_id:e};Sa(e);const a=await this.caller.call(pa(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await a.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async unshareDataset(e){Sa(e);const t=await this.caller.call(pa(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(t,"unshare dataset",!0)}async readSharedDataset(e){Sa(e);const t=await this.caller.call(pa(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const r={};t?.exampleIds&&(r.id=t.exampleIds);const a=new URLSearchParams;Object.entries(r).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>a.append(e,t))):a.append(e,t)}));const n=await this.caller.call(pa(),`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),i=await n.json();if(!n.ok){if("detail"in i)throw new Error(`Failed to list shared examples.\nStatus: ${n.status}\nMessage: ${i.detail.join("\n")}`);throw new Error(`Failed to list shared examples: ${n.status} ${n.statusText}`)}return i.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:n=null,referenceDatasetId:i=null}){const s=a?"?upsert=true":"",o=`${this.apiUrl}/sessions${s}`,c=n||{};r&&(c.metadata=r);const l={name:e,extra:c,description:t};null!==i&&(l.reference_dataset_id=i);const u=await this.caller.call(pa(),o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(u,"create project");return await u.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:n=null,endTime:i=null}){const s=`${this.apiUrl}/sessions/${e}`;let o=n;a&&(o={...o||{},metadata:a});const c={name:t,extra:o,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(pa(),s,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(l,"update project");return await l.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions";const a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Sa(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");a.append("name",t)}const n=await this.caller.call(pa(),`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await n.json();return!!n.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions";const n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)Sa(e),a+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");n.append("name",t)}void 0!==r&&n.append("include_stats",r.toString());const i=await this._get(a,n);let s;if(Array.isArray(i)){if(0===i.length)throw new Error(`Project[id=${e}, name=${t}] not found`);s=i[0]}else s=i;return s}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:n,referenceFree:i,metadata:s}={}){const o=new URLSearchParams;if(void 0!==e)for(const t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==r&&o.append("name_contains",r),void 0!==a)o.append("reference_dataset",a);else if(void 0!==n){const e=await this.readDataset({datasetName:n});o.append("reference_dataset",e.id)}void 0!==i&&o.append("reference_free",i.toString()),void 0!==s&&o.append("metadata",JSON.stringify(s));for await(const e of this._getPaginated("/sessions",o))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");r=void 0===e?(await this.readProject({projectName:t})).id:e,Sa(r);const a=await this.caller.call(pa(),`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(a,`delete session ${r} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:n,dataType:i,name:s}){const o=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach((e=>{c.append("input_keys",e)})),a.forEach((e=>{c.append("output_keys",e)})),n&&c.append("description",n),i&&c.append("data_type",i),s&&c.append("name",s);const l=await this.caller.call(pa(),o,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(l,"upload CSV");return await l.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:n,metadata:i}={}){const s={name:e,description:t,extra:i?{metadata:i}:void 0};r&&(s.data_type=r),a&&(s.inputs_schema_definition=a),n&&(s.outputs_schema_definition=n);const o=await this.caller.call(pa(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(o,"create dataset");return await o.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const a=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)Sa(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");a.append("name",t)}const n=await this._get(r,a);let i;if(Array.isArray(n)){if(0===n.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=n[0]}else i=n;return i}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let n=e;if(void 0===n&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==n&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===n){n=(await this.readDataset({datasetName:t})).id}const i=new URLSearchParams({from_version:"string"==typeof r?r:r.toISOString(),to_version:"string"==typeof a?a:a.toISOString()});return await this._get(`/datasets/${n}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:n,metadata:i}={}){const s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(const e of r)s.append("id",e);void 0!==a&&s.append("name",a),void 0!==n&&s.append("name_contains",n),void 0!==i&&s.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/datasets",s))yield*e}async updateDataset(e){const{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw new Error("Must provide either datasetName or datasetId");const n=t??(await this.readDataset({datasetName:r})).id;Sa(n);const i=await this.caller.call(pa(),`${this.apiUrl}/datasets/${n}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ts(i,"update dataset"),await i.json()}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t){a=(await this.readDataset({datasetName:t})).id}if(void 0===a)throw new Error("Must provide datasetName or datasetId");Sa(a),r+=`/${a}`;const n=await this.caller.call(pa(),this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(n,`delete ${r}`),await n.json()}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(!a&&!t)throw new Error("Must provide either datasetName or datasetId");if(a&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(!a){a=(await this.readDataset({datasetName:t})).id}Sa(a);const n={tag:r},i=await this.caller.call(pa(),`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(i,"index dataset"),await i.json()}async similarExamples(e,t,r,{filter:a}={}){const n={limit:r,inputs:e};void 0!==a&&(n.filter=a),Sa(t);const i=await this.caller.call(pa(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(i,"fetch similar examples");return(await i.json()).examples}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:n,exampleId:i,metadata:s,split:o,sourceRunId:c}){let l=r;if(void 0===l&&void 0===a)throw new Error("Must provide either datasetName or datasetId");if(void 0!==l&&void 0!==a)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===l){l=(await this.readDataset({datasetName:a})).id}const u=n||new Date,d={dataset_id:l,inputs:e,outputs:t,created_at:u?.toISOString(),id:i,metadata:s,split:o,source_run_id:c},h=await this.caller.call(pa(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(d),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(h,"create example");return await h.json()}async createExamples(e){const{inputs:t,outputs:r,metadata:a,sourceRunIds:n,exampleIds:i,datasetId:s,datasetName:o}=e;let c=s;if(void 0===c&&void 0===o)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==o)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){const e=await this.readDataset({datasetName:o});c=e.id}const l=t.map(((t,s)=>({dataset_id:c,inputs:t,outputs:r?r[s]:void 0,metadata:a?a[s]:void 0,split:e.splits?e.splits[s]:void 0,id:i?i[s]:void 0,source_run_id:n?n[s]:void 0}))),u=await this.caller.call(pa(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(u,"create examples");return await u.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const a=e.map((e=>va(e)?_a(e):e)),n=va(t)?_a(t):t;return this.createExample({input:a},{output:n},r)}async readExample(e){Sa(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:n,inlineS3Urls:i,metadata:s,limit:o,offset:c,filter:l}={}){let u;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)u=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");u=(await this.readDataset({datasetName:t})).id}const d=new URLSearchParams({dataset:u}),h=a?"string"==typeof a?a:a?.toISOString():void 0;h&&d.append("as_of",h);const p=i??!0;if(d.append("inline_s3_urls",p.toString()),void 0!==r)for(const e of r)d.append("id",e);if(void 0!==n)for(const e of n)d.append("splits",e);if(void 0!==s){const e=JSON.stringify(s);d.append("metadata",e)}void 0!==o&&d.append("limit",o.toString()),void 0!==c&&d.append("offset",c.toString()),void 0!==l&&d.append("filter",l);let m=0;for await(const e of this._getPaginated("/examples",d)){for(const t of e)yield t,m++;if(void 0!==o&&m>=o)break}}async deleteExample(e){Sa(e);const t=`/examples/${e}`,r=await this.caller.call(pa(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(r,`delete ${t}`),await r.json()}async updateExample(e,t){Sa(e);const r=await this.caller.call(pa(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(r,"update example");return await r.json()}async updateExamples(e){const t=await this.caller.call(pa(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(t,"update examples");return await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){a=(await this.readDataset({datasetName:t})).id}else a=e;Sa(a);const n=new URLSearchParams,i=r?"string"==typeof r?r:r?.toISOString():void 0;i&&n.append("as_of",i);return await this._get(`/datasets/${a}/splits`,n)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:n=!1}){let i;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){i=(await this.readDataset({datasetName:t})).id}else i=e;Sa(i);const s={split_name:r,examples:a.map((e=>(Sa(e),e))),remove:n},o=await this.caller.call(pa(),`${this.apiUrl}/datasets/${i}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(o,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:n}={loadChildRuns:!1}){var i;let s;if($a[i="This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."]||(console.warn(i),$a[i]=!0),"string"==typeof e)s=await this.readRun(e,{loadChildRuns:a});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);s=e}null!==s.reference_example_id&&void 0!==s.reference_example_id&&(n=await this.readExample(s.reference_example_id));const o=await t.evaluateRun(s,n),[c,l]=await this._logEvaluationFeedback(o,s,r);return l[0]}async createFeedback(e,t,{score:r,value:a,correction:n,comment:i,sourceInfo:s,feedbackSourceType:o="api",sourceRunId:c,feedbackId:l,feedbackConfig:u,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw new Error("One of runId or projectId must be provided");if(e&&d)throw new Error("Only one of runId or projectId can be provided");const p={type:o??"api",metadata:s??{}};void 0===c||void 0===p?.metadata||p.metadata.__run||(p.metadata.__run={run_id:c}),void 0!==p?.metadata&&void 0!==p.metadata.__run?.run_id&&Sa(p.metadata.__run.run_id);const m={id:l??xt(),run_id:e,key:t,score:r,value:a,correction:n,comment:i,feedback_source:p,comparative_experiment_id:h,feedbackConfig:u,session_id:d},f=`${this.apiUrl}/feedback`,g=await this.caller.call(pa(),f,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ts(g,"create feedback",!0),m}async updateFeedback(e,{score:t,value:r,correction:a,comment:n}){const i={};null!=t&&(i.score=t),null!=r&&(i.value=r),null!=a&&(i.correction=a),null!=n&&(i.comment=n),Sa(e);const s=await this.caller.call(pa(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(s,"update feedback",!0)}async readFeedback(e){Sa(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){Sa(e);const t=`/feedback/${e}`,r=await this.caller.call(pa(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(r,`delete ${t}`),await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(const e of t)a.append("key",e);if(r)for(const e of r)a.append("source",e);for await(const e of this._getPaginated("/feedback",a))yield*e}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){const n={run_id:e,feedback_key:t,feedback_config:a};r?"string"==typeof r?n.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(n.expires_in=r):n.expires_in={hours:3};const i=await this.caller.call(pa(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await i.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:n,metadata:i,id:s}){if(0===t.length)throw new Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!r)throw new Error("A reference dataset is required");const o={id:s,name:e,experiment_ids:t,reference_dataset_id:r,description:n,created_at:(a??new Date)?.toISOString(),extra:{}};i&&(o.extra.metadata=i);const c=await this.caller.call(pa(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await c.json()}async*listPresignedFeedbackTokens(e){Sa(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async _logEvaluationFeedback(e,t,r){const a=this._selectEvalResults(e),n=[];for(const e of a){let a=r||{};e.evaluatorInfo&&(a={...e.evaluatorInfo,...a});let i=null;e.targetRunId?i=e.targetRunId:t&&(i=t.id),n.push(await this.createFeedback(i,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:a,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[a,n]}async logEvaluationFeedback(e,t,r){const[a]=await this._logEvaluationFeedback(e,t,r);return a}async*listAnnotationQueues(e={}){const{queueIds:t,name:r,nameContains:a,limit:n}=e,i=new URLSearchParams;t&&t.forEach(((e,t)=>{Sa(e,`queueIds[${t}]`),i.append("ids",e)})),r&&i.append("name",r),a&&i.append("name_contains",a),i.append("limit",(void 0!==n?Math.min(n,100):100).toString());let s=0;for await(const e of this._getPaginated("/annotation-queues",i))if(yield*e,s++,void 0!==n&&s>=n)break}async createAnnotationQueue(e){const{name:t,description:r,queueId:a}=e,n={name:t,description:r,id:a||xt()},i=await this.caller.call(pa(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(n).filter((([e,t])=>void 0!==t)))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(i,"create annotation queue");return await i.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:r,description:a}=t,n=await this.caller.call(pa(),`${this.apiUrl}/annotation-queues/${Sa(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:r,description:a}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(n,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(pa(),`${this.apiUrl}/annotation-queues/${Sa(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const r=await this.caller.call(pa(),`${this.apiUrl}/annotation-queues/${Sa(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map(((e,t)=>Sa(e,`runIds[${t}]`).toString()))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(r,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const r=`/annotation-queues/${Sa(e,"queueId")}/run`,a=await this.caller.call(pa(),`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ts(a,"get run from annotation queue"),await a.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const r=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${r.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(pa(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await t.json();if(!t.ok){const e="string"==typeof r.detail?r.detail:JSON.stringify(r.detail),a=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw a.statusCode=t.status,a}if(0!==r.commits.length)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[r,a,n]=Qi(e),i=await this.caller.call(pa(),`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ts(i,(t?"like":"unlike")+" prompt"),await i.json()}async _getPromptUrl(e){const[t,r,a]=Qi(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==a?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${e.id}`}return"latest"!==a?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,r,a]=Qi(e),n=await this.caller.call(pa(),`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===n.status)return null;await ts(n,"get prompt");const i=await n.json();return i.repo?i.repo:null}async createPrompt(e,t){const r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[a,n,i]=Qi(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);const s={repo_handle:n,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=await this.caller.call(pa(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(o,"create prompt");const{repo:c}=await o.json();return c}async createCommit(e,t,r){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[a,n,i]=Qi(e),s="latest"!==r?.parentCommitHash&&r?.parentCommitHash?r?.parentCommitHash:await this._getLatestCommitHash(`${a}/${n}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:s},c=await this.caller.call(pa(),`${this.apiUrl}/commits/${a}/${n}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(c,"create commit");const l=await c.json();return this._getPromptUrl(`${a}/${n}${l.commit_hash?`:${l.commit_hash}`:""}`)}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,a]=Qi(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);const n={};if(void 0!==t?.description&&(n.description=t.description),void 0!==t?.readme&&(n.readme=t.readme),void 0!==t?.tags&&(n.tags=t.tags),void 0!==t?.isPublic&&(n.is_public=t.isPublic),void 0!==t?.isArchived&&(n.is_archived=t.isArchived),0===Object.keys(n).length)throw new Error("No valid update options provided");const i=await this.caller.call(pa(),`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",body:JSON.stringify(n),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await ts(i,"update prompt"),i.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,r,a]=Qi(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const n=await this.caller.call(pa(),`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await n.json()}async pullPromptCommit(e,t){const[r,a,n]=Qi(e);let i=n;if(!function(e,t){const r=Yi.parse(e),a=Yi.parse(t);if(!r||!a)throw new Error("Invalid version format.");return r.compare(a)>=0}((await this._getServerInfo()).version,"0.5.23")&&"latest"===n){const e=await this._getLatestCommitHash(`${r}/${a}`);if(!e)throw new Error("No commits found");i=e}const s=await this.caller.call(pa(),`${this.apiUrl}/commits/${r}/${a}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await ts(s,"pull prompt commit");const o=await s.json();return{owner:r,repo:a,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const r=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(r.manifest)}async pushPrompt(e,t){if(await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),!t?.object)return await this._getPromptUrl(e);return await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash})}async clonePublicDataset(e,t={}){const{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[n,i]=this.parseTokenOrUrl(e,r),s=new ps({apiUrl:n,apiKey:"placeholder"}),o=await s.readSharedDataset(i),c=a||o.name;try{if(await this.hasDataset({datasetId:c}))return void console.log(`Dataset ${c} already exists in your tenant. Skipping.`)}catch(e){}const l=await s.listSharedExamples(i),u=await this.createDataset(c,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:l.map((e=>e.inputs)),outputs:l.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${c}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return Sa(e),[t,e]}catch(e){}try{const n=new URL(e).pathname.split("/").filter((e=>""!==e));if(n.length>=r){return[t,n[n.length-r]]}throw new Error(`Invalid public ${a} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${a} URL or token: ${e}`)}}awaitPendingTraceBatches(){return Promise.all(this.autoBatchQueue.items.map((([,,e])=>e)))}}const ms="0.1.66";const fs=Symbol.for("ls:tracing_async_local_storage"),gs=new class{getStore(){}run(e,t){return t()}};const ys=new class{getInstance(){return globalThis[fs]??gs}initializeGlobalInstance(e){void 0===globalThis[fs]&&(globalThis[fs]=e)}};function vs(e){return"function"==typeof e&&"langsmith:traceable"in e}class _s extends xr{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:a}=e;this.projectName=r??br("LANGCHAIN_PROJECT")??br("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a??new ps({});const n=this.getTraceableRunTree();if(n){let e=n;const t=new Set;for(;e.parent_run&&!t.has(e.id)&&(t.add(e.id),e.parent_run);)e=e.parent_run;t.clear();const r=[e];for(;r.length>0;){const e=r.shift();e&&!t.has(e.id)&&(t.add(e.id),this.runMap.set(e.id,e),e.child_runs&&r.push(...e.child_runs))}this.client=n.client??this.client,this.projectName=n.project_name??this.projectName,this.exampleId=n.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await _r()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return(()=>{const e=ys.getInstance().getStore();if(void 0===(t=e)||"function"!=typeof t.createChild||"function"!=typeof t.postRun)throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join("\n"));var t;return e})()}catch{return}}}let bs;async function ws(e,t){!0===t?await e():(void 0===bs&&(bs=new("default"in ua?ua.default:ua)({autoStart:!0,concurrency:1})),bs.add(e))}class Es{setHandler(e){return this.setHandlers([e])}}class Os{constructor(e,t,r,a,n,i,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>ws((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Ts extends Os{getChild(e){const t=new Ss(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(r){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Is extends Os{async handleLLMNewToken(e,t,r,a,n,i){await Promise.all(this.handlers.map((r=>ws((async()=>{if(!r.ignoreLLM)try{await(r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(e){if(console.error(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class xs extends Os{getChild(e){const t=new Ss(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,n){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,r,a,n){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,n))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class ks extends Os{getChild(e){const t=new Ss(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>ws((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Ss extends Es{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,n=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,a)=>{const i=0===a&&r?r:xt();return await Promise.all(this.handlers.map((r=>ws((async()=>{if(!r.ignoreLLM)try{await(r.handleLLMStart?.(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o))}catch(e){if(console.error(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)))),new Is(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,t,r=void 0,a=void 0,n=void 0,i=void 0,s=void 0,o=void 0){return Promise.all(t.map((async(t,a)=>{const i=0===a&&r?r:xt();return await Promise.all(this.handlers.map((r=>ws((async()=>{if(!r.ignoreLLM)try{if(r.handleChatModelStart)await(r.handleChatModelStart?.(e,[t],i,this._parentRunId,n,this.tags,this.metadata,o));else if(r.handleLLMStart){const a=function(e,t="Human",r="AI"){const a=[];for(const n of e){let e;if("human"===n._getType())e=t;else if("ai"===n._getType())e=r;else if("system"===n._getType())e="System";else if("function"===n._getType())e="Function";else if("tool"===n._getType())e="Tool";else{if("generic"!==n._getType())throw new Error(`Got unsupported message type: ${n._getType()}`);e=n.role}const i=n.name?`${n.name}, `:"",s="string"==typeof n.content?n.content:JSON.stringify(n.content,null,2);a.push(`${e}: ${i}${s}`)}return a.join("\n")}(t);await(r.handleLLMStart?.(e,[a],i,this._parentRunId,n,this.tags,this.metadata,o))}}catch(e){if(console.error(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}}),r.awaitHandlers)))),new Is(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,t,r=xt(),a=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((n=>ws((async()=>{if(!n.ignoreChain)try{await(n.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,s))}catch(e){if(console.error(`Error in handler ${n.constructor.name}, handleChainStart: ${e}`),n.raiseError)throw e}}),n.awaitHandlers)))),new xs(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=xt(),a=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((a=>ws((async()=>{if(!a.ignoreAgent)try{await(a.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s))}catch(e){if(console.error(`Error in handler ${a.constructor.name}, handleToolStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)))),new ks(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=xt(),a=void 0,n=void 0,i=void 0,s=void 0){return await Promise.all(this.handlers.map((a=>ws((async()=>{if(!a.ignoreRetriever)try{await(a.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s))}catch(e){if(console.error(`Error in handler ${a.constructor.name}, handleRetrieverStart: ${e}`),a.raiseError)throw e}}),a.awaitHandlers)))),new Ts(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,n){await Promise.all(this.handlers.map((a=>ws((async()=>{if(!a.ignoreCustomEvent)try{await(a.handleCustomEvent?.(e,t,r,this.tags,this.metadata))}catch(e){if(console.error(`Error in handler ${a.constructor.name}, handleCustomEvent: ${e}`),a.raiseError)throw e}}),a.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new Ss(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);r.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(const a of e)r.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===a.name))||r.addHandler(a,t);return r}static fromHandlers(e){const t=new this;return t.addHandler(new class extends Er{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:xt()}),Object.assign(this,e)}}),t}static async configure(e,t,r,a,n,i,s){return this._configureSync(e,t,r,a,n,i,s)}static _configureSync(e,t,r,a,n,i,s){let o;(e||t)&&(Array.isArray(e)||!e?(o=new Ss,o.setHandlers(e?.map($s)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map($s):t?.handlers,!1));const c="true"===br("LANGCHAIN_VERBOSE")||s?.verbose,l=!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===br(e))),u=l||(br("LANGCHAIN_TRACING")??!1);if(c||u){if(o||(o=new Ss),c&&!o.handlers.some((e=>e.name===Pr.prototype.name))){const e=new Pr;o.addHandler(e,!0)}if(u&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&l){const e=new _s;o.addHandler(e,!0),o._parentRunId=e.getTraceableRunTree()?.id??o._parentRunId}}return(r||a)&&o&&(o.addTags(r??[]),o.addTags(a??[],!1)),(n||i)&&o&&(o.addMetadata(n??{}),o.addMetadata(i??{},!1)),o}}function $s(e){return"name"in e?e:Er.fromMethods(e)}const Ns=[400,401,402,403,404,405,406,407,409],Ps=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&Ns.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class Rs{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Ps;const t="default"in ua?ua.default:ua;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>Vr((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise(((t,r)=>{e.signal?.addEventListener("abort",(()=>{r(new Error("AbortError"))}))}))]):this.call(t,...r)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}for(var As={byteLength:function(e){var t=Ds(e),r=t[0],a=t[1];return 3*(r+a)/4-a},toByteArray:function(e){var t,r,a=Ds(e),n=a[0],i=a[1],s=new Ls(function(e,t,r){return 3*(t+r)/4-r}(0,n,i)),o=0,c=i>0?n-4:n;for(r=0;r<c;r+=4)t=Cs[e.charCodeAt(r)]<<18|Cs[e.charCodeAt(r+1)]<<12|Cs[e.charCodeAt(r+2)]<<6|Cs[e.charCodeAt(r+3)],s[o++]=t>>16&255,s[o++]=t>>8&255,s[o++]=255&t;2===i&&(t=Cs[e.charCodeAt(r)]<<2|Cs[e.charCodeAt(r+1)]>>4,s[o++]=255&t);1===i&&(t=Cs[e.charCodeAt(r)]<<10|Cs[e.charCodeAt(r+1)]<<4|Cs[e.charCodeAt(r+2)]>>2,s[o++]=t>>8&255,s[o++]=255&t);return s},fromByteArray:function(e){for(var t,r=e.length,a=r%3,n=[],i=16383,s=0,o=r-a;s<o;s+=i)n.push(Zs(e,s,s+i>o?o:s+i));1===a?(t=e[r-1],n.push(js[t>>2]+js[t<<4&63]+"==")):2===a&&(t=(e[r-2]<<8)+e[r-1],n.push(js[t>>10]+js[t>>4&63]+js[t<<2&63]+"="));return n.join("")}},js=[],Cs=[],Ls="undefined"!=typeof Uint8Array?Uint8Array:Array,Ms="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Us=0;Us<64;++Us)js[Us]=Ms[Us],Cs[Ms.charCodeAt(Us)]=Us;function Ds(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function Zs(e,t,r){for(var a,n,i=[],s=t;s<r;s+=3)a=(e[s]<<16&16711680)+(e[s+1]<<8&65280)+(255&e[s+2]),i.push(js[(n=a)>>18&63]+js[n>>12&63]+js[n>>6&63]+js[63&n]);return i.join("")}Cs["-".charCodeAt(0)]=62,Cs["_".charCodeAt(0)]=63;var Fs=Object.defineProperty;function Hs(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let r=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;r.length>1;){let a=null;for(let n=0;n<r.length-1;n++){const i=e.slice(r[n].start,r[n+1].end),s=t.get(i.join(","));null!=s&&(null==a||s<a[0])&&(a=[s,n])}if(null==a)break;{const e=a[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}}return r}(e,t).map((r=>t.get(e.slice(r.start,r.end).join(",")))).filter((e=>null!=e))}var Bs,qs=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const r=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[r,a,...n]=t.split(" "),i=Number.parseInt(a,10);return n.forEach(((t,r)=>e[t]=i+r)),e}),{});for(const[e,t]of Object.entries(r)){const r=As.toByteArray(e);this.rankMap.set(r.join(","),t),this.textMap.set(t,r)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],r="all"){const a=new RegExp(this.patStr,"ug"),n=qs.specialTokenRegex(Object.keys(this.specialTokens)),i=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter((e=>!s.has(e))):r);if(o.size>0){const t=qs.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw new Error(`The text contains a special token that is not allowed: ${r[0]}`)}let c=0;for(;;){let t=null,r=c;for(;n.lastIndex=r,t=n.exec(e),null!=t&&!s.has(t[0]);)r=t.index+1;const o=t?.index??e.length;for(const t of e.substring(c,o).matchAll(a)){const e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));null==r?i.push(...Hs(e,this.rankMap)):i.push(r)}if(null==t)break;let l=this.specialTokens[t[0]];i.push(l),c=t.index+t[0].length}return i}decode(e){const t=[];let r=0;for(let a=0;a<e.length;++a){const n=e[a],i=this.textMap.get(n)??this.inverseSpecialTokens[n];null!=i&&(t.push(i),r+=i.length)}const a=new Uint8Array(r);let n=0;for(const e of t)a.set(e,n),n+=e.length;return this.textDecoder.decode(a)}};Bs=e=>new RegExp(e.map((e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&"))).join("|"),"g"),((e,t,r)=>{t in e?Fs(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r})(qs,"specialTokenRegex"+"",Bs);
/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */
const Gs=Object.prototype.hasOwnProperty;function zs(e,t){return Gs.call(e,t)}function Vs(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function Js(e){let t=0;const r=e.length;let a;for(;t<r;){if(a=e.charCodeAt(t),!(a>=48&&a<=57))return!1;t++}return!0}function Ws(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Ks(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,r=e.length;t<r;t++)if(Ks(e[t]))return!0}else if("object"==typeof e){const r=function(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)zs(e,r)&&t.push(r);return t}(e),a=r.length;for(var t=0;t<a;t++)if(Ks(e[r[t]]))return!0}return!1}function Xs(e,t){const r=[e];for(const e in t){const a="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==a&&r.push(`${e}: ${a}`)}return r.join("\n")}class Ys extends Error{constructor(e,t,r,a,n){super(Xs(e,{name:t,index:r,operation:a,tree:n})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.setPrototypeOf(this,new.target.prototype),this.message=Xs(e,{name:t,index:r,operation:a,tree:n})}}const Qs=Ys,eo={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var a=e[t];return delete e[t],{newDocument:r,removed:a}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:function(e,t,r){let a=ro(r,this.path);a&&(a=Vs(a));const n=ao(r,{op:"remove",path:this.from}).removed;return ao(r,{op:"add",path:this.path,value:n}),{newDocument:r,removed:a}},copy:function(e,t,r){const a=ro(r,this.from);return ao(r,{op:"add",path:this.path,value:Vs(a)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:so(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var to={add:function(e,t,r){return Js(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:eo.move,copy:eo.copy,test:eo.test,_get:eo._get};function ro(e,t){if(""==t)return e;var r={op:"_get",path:t};return ao(e,r),r.value}function ao(e,t,r=!1,a=!0,n=!0,i=0){if(r&&("function"==typeof r?r(t,0,e,t.path):io(t,0)),""===t.path){let a={newDocument:e};if("add"===t.op)return a.newDocument=t.value,a;if("replace"===t.op)return a.newDocument=t.value,a.removed=e,a;if("move"===t.op||"copy"===t.op)return a.newDocument=ro(e,t.from),"move"===t.op&&(a.removed=e),a;if("test"===t.op){if(a.test=so(e,t.value),!1===a.test)throw new Qs("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a.newDocument=e,a}if("remove"===t.op)return a.removed=e,a.newDocument=null,a;if("_get"===t.op)return t.value=e,a;if(r)throw new Qs("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,t,e);return a}{a||(e=Vs(e));const s=(t.path||"").split("/");let o,c,l,u=e,d=1,h=s.length;for(l="function"==typeof r?r:io;;){if(c=s[d],c&&-1!=c.indexOf("~")&&(c=Ws(c)),n&&("__proto__"==c||"prototype"==c&&d>0&&"constructor"==s[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===o&&(void 0===u[c]?o=s.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&l(t,0,e,o)),d++,Array.isArray(u)){if("-"===c)c=u.length;else{if(r&&!Js(c))throw new Qs("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,t,e);Js(c)&&(c=~~c)}if(d>=h){if(r&&"add"===t.op&&c>u.length)throw new Qs("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,t,e);const a=to[t.op].call(t,u,c,e);if(!1===a.test)throw new Qs("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return a}}else if(d>=h){const r=eo[t.op].call(t,u,c,e);if(!1===r.test)throw new Qs("Test operation failed","TEST_OPERATION_FAILED",i,t,e);return r}if(u=u[c],r&&d<h&&(!u||"object"!=typeof u))throw new Qs("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,t,e)}}}function no(e,t,r,a=!0,n=!0){if(r&&!Array.isArray(t))throw new Qs("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");a||(e=Vs(e));const i=new Array(t.length);for(let a=0,s=t.length;a<s;a++)i[a]=ao(e,t[a],r,!0,n,a),e=i[a].newDocument;return i.newDocument=e,i}function io(e,t,r,a){if("object"!=typeof e||null===e||Array.isArray(e))throw new Qs("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(!eo[e.op])throw new Qs("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r);if("string"!=typeof e.path)throw new Qs("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new Qs('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new Qs("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new Qs("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&Ks(e.value))throw new Qs("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);if(r)if("add"==e.op){var n=e.path.split("/").length,i=a.split("/").length;if(n!==i+1&&n!==i)throw new Qs("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==a)throw new Qs("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=function(e,t,r){try{if(!Array.isArray(e))throw new Qs("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)no(Vs(t),Vs(e),r||!0);else{r=r||io;for(var a=0;a<e.length;a++)r(e[a],a,t,void 0)}}catch(e){if(e instanceof Qs)return e;throw e}}([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new Qs("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}function so(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,a,n,i=Array.isArray(e),s=Array.isArray(t);if(i&&s){if((a=e.length)!=t.length)return!1;for(r=a;0!=r--;)if(!so(e[r],t[r]))return!1;return!0}if(i!=s)return!1;var o=Object.keys(e);if((a=o.length)!==Object.keys(t).length)return!1;for(r=a;0!=r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=a;0!=r--;)if(!so(e[n=o[r]],t[n]))return!1;return!0}return e!=e&&t!=t}const oo=new class{getStore(){}run(e,t){return t()}};const co=new class{getInstance(){return globalThis.__lc_tracing_async_local_storage??oo}initializeGlobalInstance(e){void 0===globalThis.__lc_tracing_async_local_storage&&(globalThis.__lc_tracing_async_local_storage=e)}};class lo extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new lo({start:e=>function r(){return t.read().then((({done:t,value:a})=>{if(!t)return e.enqueue(a),r();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new lo({async pull(t){const{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function uo(e,t=2){const r=Array.from({length:t},(()=>[]));return r.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function ho(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const r={...e};for(const[e,a]of Object.entries(t))e in r&&!Array.isArray(r[e])?r[e]=ho(r[e],a):r[e]=a;return r}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class po{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise(((t,r)=>{co.getInstance().run(e.config,(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then((e=>t(void 0)),r)}))}))}async next(...e){if(!this.firstResultUsed)return this.firstResultUsed=!0,this.firstResult;return co.getInstance().run(this.config,(async()=>this.generator.next(...e)))}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}class mo{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),r=no({},t);return new fo({ops:t,state:r[r.length-1].newDocument})}}class fo extends mo{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=no(this.state,e.ops);return new fo({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){const t=no({},e.ops);return new fo({ops:e.ops,state:t[t.length-1].newDocument})}}const go=e=>"log_stream_tracer"===e.name;async function yo(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||""!==r?.input?r.input:void 0}async function vo(e,t){const{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&void 0!==r?.output?r.output:r}class _o extends xr{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=lo.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async*tapOutputIterable(e,t){for await(const r of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new mo({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new mo({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await yo(e,this._schemaFormat)),await this.writer.write(new mo({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await yo(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await vo(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const a=new mo({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){const t=new mo({ops:[{op:"replace",path:"/final_output",value:await vo(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){const a=this.keyMapByRunId[e.id];if(void 0===a)return;let n;var i;void 0!==e.inputs.messages?(i=r?.chunk,n=void 0!==i&&void 0!==i.message?r?.chunk:new Ur(t)):n=t;const s=new mo({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:n}]});await this.writer.write(s)}}class bo{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new bo({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}function wo({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const Eo=e=>"event_stream_tracer"===e.name;class Oo extends xr{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=lo.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(r=r||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(r=r&&t.every((e=>!this.excludeTags?.includes(e)))),r}async*tapOutputIterable(e,t){const r=await t.next();if(r.done)return;const a=this.runInfoMap.get(e);if(void 0===a)return void(yield r.value);let n=this.tappedPromises.get(e);if(void 0===n){let i;n=new Promise((e=>{i=e})),this.tappedPromises.set(e,n);try{const n={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};await this.send({...n,data:{chunk:r.value}},a),yield r.value;for await(const e of t)"tool"!==a.runType&&"retriever"!==a.runType&&await this.send({...n,data:{chunk:e}},a),yield e}finally{i()}}else{yield r.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const r=this.tappedPromises.get(e.run_id);void 0!==r?r.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=wo(e),r=void 0!==e.inputs.messages?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);const n=`on_${r}_start`;await this.send({event:n,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){const a=this.runInfoMap.get(e.id);let n,i;if(void 0===a)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if("chat_model"===a.runType)i="on_chat_model_stream",n=void 0===r?.chunk?new Ur({content:t}):r.chunk.message;else{if("llm"!==a.runType)throw new Error(`Unexpected run type ${a.runType}`);i="on_llm_stream",n=void 0===r?.chunk?new bo({text:t}):r.chunk}await this.send({event:i,data:{chunk:n},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let r;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const a=e.outputs?.generations;let n;if("chat_model"===t.runType){for(const e of a??[]){if(void 0!==n)break;n=e[0]?.message}r="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);n={generations:a?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},r="on_llm_end"}await this.sendEndEvent({event:r,data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=wo(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let n={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(n={},a.inputs={}):void 0!==e.inputs.input?(n.input=e.inputs.input,a.inputs=e.inputs.input):(n.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:n,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},n={output:e.outputs?.output??e.outputs,input:a};a.input&&1===Object.keys(a).length&&(n.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:n,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=wo(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const r=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=wo(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,r),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){const a=this.runInfoMap.get(r);if(void 0===a)throw new Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}async function To(e){return Ss.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function Io(...e){const t={};for(const r of e.filter((e=>!!e)))for(const e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e){const a=t[e]??[];t[e]=[...new Set(a.concat(r[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...r[e]};else if("callbacks"===e){const e=t.callbacks,a=r.callbacks;if(Array.isArray(a))if(e)if(Array.isArray(e))t.callbacks=e.concat(a);else{const r=e.copy();for(const e of a)r.addHandler($s(e),!0);t.callbacks=r}else t.callbacks=a;else if(a)if(e)if(Array.isArray(e)){const r=a.copy();for(const t of e)r.addHandler($s(t),!0);t.callbacks=r}else t.callbacks=new Ss(a._parentRunId,{handlers:e.handlers.concat(a.handlers),inheritableHandlers:e.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(a.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(a.inheritableTags))),metadata:{...e.metadata,...a.metadata}});else t.callbacks=a}else{const a=e;t[a]=r[a]??t[a]}return t}const xo=new Set(["string","number","boolean"]);function ko(e){const t=co.getInstance().getStore();let r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,...a}=t;r=Object.entries(a).reduce(((e,[t,r])=>(void 0!==r&&(e[t]=r),e)),r)}if(e&&(r=Object.entries(e).reduce(((e,[t,r])=>(void 0!==r&&(e[t]=r),e)),r)),r?.configurable)for(const e of Object.keys(r.configurable))xo.has(typeof r.configurable[e])&&!r.metadata?.[e]&&(r.metadata||(r.metadata={}),r.metadata[e]=r.configurable[e]);return r}function So(e={},{callbacks:t,maxConcurrency:r,recursionLimit:a,runName:n,configurable:i,runId:s}={}){const o=ko(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==a&&(o.recursionLimit=a),void 0!==r&&(o.maxConcurrency=r),void 0!==n&&(o.runName=n),void 0!==i&&(o.configurable={...o.configurable,...i}),void 0!==s&&delete o.runId,o}class $o extends xr{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function No(e){return!!e&&e.lc_runnable}class Po{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const a=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||a.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&a.every((e=>!this.excludeTags?.includes(e)))),r}}const Ro=Symbol("Let zodToJsonSchema decide on which parser to use"),Ao={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},jo=e=>{const t=(e=>"string"==typeof e?{...Ao,name:e}:{...Ao,...e})(e),r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,r])=>[r._def,{def:r._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}};function Co(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function Lo(e,t,r,a,n){e[t]=r,Co(e,t,a,n)}function Mo(e,t,r){const a=r??t.dateStrategy;if(Array.isArray(a))return{anyOf:a.map(((r,a)=>Mo(e,t,r)))};switch(a){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return Uo(e,t)}}const Uo=(e,t)=>{const r={type:"integer",format:"unix-time"};if("openApi3"===t.target)return r;for(const a of e.checks)switch(a.kind){case"min":Lo(r,"minimum",a.value,a.message,t);break;case"max":Lo(r,"maximum",a.value,a.message,t)}return r};let Do;const Zo=/^[cC][^\s-]{8,}$/,Fo=/^[0-9a-z]+$/,Ho=/^[0-9A-HJKMNP-TV-Z]{26}$/,Bo=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,qo=()=>(void 0===Do&&(Do=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),Do),Go=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,zo=/^[a-zA-Z0-9_-]{21}$/;function Vo(e,t){const r={type:"string"};function a(e){return"escape"===t.patternStrategy?Jo(e):e}if(e.checks)for(const n of e.checks)switch(n.kind){case"min":Lo(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t);break;case"max":Lo(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"email":switch(t.emailStrategy){case"format:email":Wo(r,"email",n.message,t);break;case"format:idn-email":Wo(r,"idn-email",n.message,t);break;case"pattern:zod":Ko(r,Bo,n.message,t)}break;case"url":Wo(r,"uri",n.message,t);break;case"uuid":Wo(r,"uuid",n.message,t);break;case"regex":Ko(r,n.regex,n.message,t);break;case"cuid":Ko(r,Zo,n.message,t);break;case"cuid2":Ko(r,Fo,n.message,t);break;case"startsWith":Ko(r,RegExp(`^${a(n.value)}`),n.message,t);break;case"endsWith":Ko(r,RegExp(`${a(n.value)}$`),n.message,t);break;case"datetime":Wo(r,"date-time",n.message,t);break;case"date":Wo(r,"date",n.message,t);break;case"time":Wo(r,"time",n.message,t);break;case"duration":Wo(r,"duration",n.message,t);break;case"length":Lo(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,n.value):n.value,n.message,t),Lo(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,n.value):n.value,n.message,t);break;case"includes":Ko(r,RegExp(a(n.value)),n.message,t);break;case"ip":"v6"!==n.version&&Wo(r,"ipv4",n.message,t),"v4"!==n.version&&Wo(r,"ipv6",n.message,t);break;case"emoji":Ko(r,qo,n.message,t);break;case"ulid":Ko(r,Ho,n.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":Wo(r,"binary",n.message,t);break;case"contentEncoding:base64":Lo(r,"contentEncoding","base64",n.message,t);break;case"pattern:zod":Ko(r,Go,n.message,t)}break;case"nanoid":Ko(r,zo,n.message,t)}return r}const Jo=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),Wo=(e,t,r,a)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):Lo(e,"format",t,r,a)},Ko=(e,t,r,a)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:Xo(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):Lo(e,"pattern",Xo(t,a),r,a)},Xo=(e,t)=>{const r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;const a=r.flags.includes("i"),n=r.flags.includes("m"),i=r.flags.includes("s"),s=a?r.source.toLowerCase():r.source;let o="",c=!1,l=!1,u=!1;for(let e=0;e<s.length;e++)if(c)o+=s[e],c=!1;else{if(a)if(l){if(s[e].match(/[a-z]/)){u?(o+=s[e],o+=`${s[e-2]}-${s[e]}`.toUpperCase(),u=!1):"-"===s[e+1]&&s[e+2]?.match(/[a-z]/)?(o+=s[e],u=!0):o+=`${s[e]}${s[e].toUpperCase()}`;continue}}else if(s[e].match(/[a-z]/)){o+=`[${s[e]}${s[e].toUpperCase()}]`;continue}if(n){if("^"===s[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===s[e]){o+="($|(?=[\r\n]))";continue}}i&&"."===s[e]?o+=l?`${s[e]}\r\n`:`[${s[e]}\r\n]`:(o+=s[e],"\\"===s[e]?c=!0:l&&"]"===s[e]?l=!1:l||"["!==s[e]||(l=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return o};function Yo(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===je.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((r,a)=>({...r,[a]:rc(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??{}})),{}),additionalProperties:!1};const r={type:"object",additionalProperties:rc(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===je.ZodString&&e.keyType._def.checks?.length){const a=Object.entries(Vo(e.keyType._def,t)).reduce(((e,[t,r])=>"type"===t?e:{...e,[t]:r}),{});return{...r,propertyNames:a}}return e.keyType?._def.typeName===je.ZodEnum?{...r,propertyNames:{enum:e.keyType._def.values}}:r}const Qo={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};const ec=(e,t)=>{const r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,r)=>rc(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return r.length?{anyOf:r}:void 0};function tc(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:rc(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:rc(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function rc(e,t,r=!1){const a=t.seen.get(e);if(t.override){const n=t.override?.(e,t,a,r);if(n!==Ro)return n}if(a&&!r){const e=ac(a,t);if(void 0!==e)return e}const n={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,n);const i=ic(e,e.typeName,t);return i&&sc(e,t,i),n.jsonSchema=i,i}const ac=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:nc(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,r)=>t.currentPath[r]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},nc=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},ic=(e,t,r)=>{switch(t){case je.ZodString:return Vo(e,r);case je.ZodNumber:return function(e,t){const r={type:"number"};if(!e.checks)return r;for(const a of e.checks)switch(a.kind){case"int":r.type="integer",Co(r,"type",a.message,t);break;case"min":"jsonSchema7"===t.target?a.inclusive?Lo(r,"minimum",a.value,a.message,t):Lo(r,"exclusiveMinimum",a.value,a.message,t):(a.inclusive||(r.exclusiveMinimum=!0),Lo(r,"minimum",a.value,a.message,t));break;case"max":"jsonSchema7"===t.target?a.inclusive?Lo(r,"maximum",a.value,a.message,t):Lo(r,"exclusiveMaximum",a.value,a.message,t):(a.inclusive||(r.exclusiveMaximum=!0),Lo(r,"maximum",a.value,a.message,t));break;case"multipleOf":Lo(r,"multipleOf",a.value,a.message,t)}return r}(e,r);case je.ZodObject:return function(e,t){const r={type:"object",...Object.entries(e.shape()).reduce(((e,[r,a])=>{if(void 0===a||void 0===a._def)return e;const n=rc(a._def,{...t,currentPath:[...t.currentPath,"properties",r],propertyPath:[...t.currentPath,"properties",r]});return void 0===n?e:{properties:{...e.properties,[r]:n},required:a.isOptional()?e.required:[...e.required,r]}}),{properties:{},required:[]}),additionalProperties:tc(e,t)};return r.required.length||delete r.required,r}(e,r);case je.ZodBigInt:return function(e,t){const r={type:"integer",format:"int64"};if(!e.checks)return r;for(const a of e.checks)switch(a.kind){case"min":"jsonSchema7"===t.target?a.inclusive?Lo(r,"minimum",a.value,a.message,t):Lo(r,"exclusiveMinimum",a.value,a.message,t):(a.inclusive||(r.exclusiveMinimum=!0),Lo(r,"minimum",a.value,a.message,t));break;case"max":"jsonSchema7"===t.target?a.inclusive?Lo(r,"maximum",a.value,a.message,t):Lo(r,"exclusiveMaximum",a.value,a.message,t):(a.inclusive||(r.exclusiveMaximum=!0),Lo(r,"maximum",a.value,a.message,t));break;case"multipleOf":Lo(r,"multipleOf",a.value,a.message,t)}return r}(e,r);case je.ZodBoolean:return{type:"boolean"};case je.ZodDate:return Mo(e,r);case je.ZodUndefined:return{not:{}};case je.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(r);case je.ZodArray:return function(e,t){const r={type:"array"};return e.type?._def?.typeName!==je.ZodAny&&(r.items=rc(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Lo(r,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Lo(r,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Lo(r,"minItems",e.exactLength.value,e.exactLength.message,t),Lo(r,"maxItems",e.exactLength.value,e.exactLength.message,t)),r}(e,r);case je.ZodUnion:case je.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return ec(e,t);const r=e.options instanceof Map?Array.from(e.options.values()):e.options;if(r.every((e=>e._def.typeName in Qo&&(!e._def.checks||!e._def.checks.length)))){const e=r.reduce(((e,t)=>{const r=Qo[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e}),[]);return{type:e.length>1?e:e[0]}}if(r.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=r.reduce(((e,t)=>{const r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===r.length){const t=e.filter(((e,t,r)=>r.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:r.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(r.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:r.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return ec(e,t)}(e,r);case je.ZodIntersection:return function(e,t){const r=[rc(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),rc(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let a="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const n=[];return r.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:r,...a}=e;t=a}else a=void 0;n.push(t)}else n.push(...e.allOf),void 0===e.unevaluatedProperties&&(a=void 0);var t})),n.length?{allOf:n,...a}:void 0}(e,r);case je.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,r)=>rc(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:rc(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,r)=>rc(e._def,{...t,currentPath:[...t.currentPath,"items",`${r}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,r);case je.ZodRecord:return Yo(e,r);case je.ZodLiteral:return function(e,t){const r=typeof e.value;return"bigint"!==r&&"number"!==r&&"boolean"!==r&&"string"!==r?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===r?"integer":r,enum:[e.value]}:{type:"bigint"===r?"integer":r,const:e.value}}(e,r);case je.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case je.ZodNativeEnum:return function(e){const t=e.values,r=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])),a=r.map((e=>t[e])),n=Array.from(new Set(a.map((e=>typeof e))));return{type:1===n.length?"string"===n[0]?"string":"number":["string","number"],enum:a}}(e);case je.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:Qo[e.innerType._def.typeName],nullable:!0}:{type:[Qo[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const r=rc(e.innerType._def,{...t,currentPath:[...t.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}const r=rc(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return r&&{anyOf:[r,{type:"null"}]}}(e,r);case je.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return rc(e.innerType._def,t);const r=rc(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return r?{anyOf:[{not:{}},r]}:{}})(e,r);case je.ZodMap:return function(e,t){return"record"===t.mapStrategy?Yo(e,t):{type:"array",maxItems:125,items:{type:"array",items:[rc(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},rc(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,r);case je.ZodSet:return function(e,t){const r={type:"array",uniqueItems:!0,items:rc(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Lo(r,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Lo(r,"maxItems",e.maxSize.value,e.maxSize.message,t),r}(e,r);case je.ZodLazy:return rc(e.getter()._def,r);case je.ZodPromise:return function(e,t){return rc(e.type._def,t)}(e,r);case je.ZodNaN:case je.ZodNever:return{not:{}};case je.ZodEffects:return function(e,t){return"input"===t.effectStrategy?rc(e.schema._def,t):{}}(e,r);case je.ZodAny:case je.ZodUnknown:return{};case je.ZodDefault:return function(e,t){return{...rc(e.innerType._def,t),default:e.defaultValue()}}(e,r);case je.ZodBranded:return function(e,t){return rc(e.type._def,t)}(e,r);case je.ZodReadonly:case je.ZodCatch:return((e,t)=>rc(e.innerType._def,t))(e,r);case je.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return rc(e.in._def,t);if("output"===t.pipeStrategy)return rc(e.out._def,t);const r=rc(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[r,rc(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",r?"1":"0"]})].filter((e=>void 0!==e))}})(e,r);case je.ZodFunction:case je.ZodVoid:case je.ZodSymbol:default:return}},sc=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r),oc=(e,t)=>{const r=jo(t),a="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce(((e,[t,a])=>({...e,[t]:rc(a._def,{...r,currentPath:[...r.basePath,r.definitionPath,t]},!0)??{}})),{}):void 0,n="string"==typeof t?t:"title"===t?.nameStrategy?void 0:t?.name,i=rc(e._def,void 0===n?r:{...r,currentPath:[...r.basePath,r.definitionPath,n]},!1)??{},s="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==s&&(i.title=s);const o=void 0===n?a?{...i,[r.definitionPath]:a}:i:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,n].join("/"),[r.definitionPath]:{...a,[n]:i}};return"jsonSchema7"===r.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===r.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o};function cc(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}function lc(e,t){return[t[e.source]??e.source,t[e.target]??e.target]}function uc(e,t,r){const{firstNodeLabel:a,lastNodeLabel:n,nodeColors:i,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:c=9}=r??{};let l=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(s){const t="default",r={[t]:"{0}([{1}]):::otherclass"};void 0!==a&&(r[a]="{0}[{0}]:::startclass"),void 0!==n&&(r[n]="{0}[{0}]:::endclass");for(const a of Object.values(e)){const e=r[a]??r[t],n=cc(a),i=a.split(":"),s=i[i.length-1];l+=`\t${e.replace(/\{0\}/g,n).replace(/\{1\}/g,s)};\n`}}let u="";for(const r of t){const t=r.source.includes(":")?r.source.split(":")[0]:void 0,a=r.target.includes(":")?r.target.split(":")[0]:void 0;""===u||u===t&&u===a||(l+="\tend\n",u=""),""===u&&void 0!==t&&t===a&&(l=`\tsubgraph ${t}\n`,u=t);const[n,i]=lc(r,e);let s="";if(void 0!==r.data){let e=r.data;const t=e.split(" ");t.length>c&&(e=t.reduce(((e,t,r)=>(r%c==0&&e.push(""),e[e.length-1]+=` ${t}`,e)),[]).join("<br>")),s=r.conditional?` -. ${e} .-> `:` -- ${e} --\x3e `}else s=r.conditional?" -.-> ":" --\x3e ";l+=`\t${cc(n)}${s}${cc(i)};\n`}return""!==u&&(l+="end\n"),s&&void 0!==i&&(l+=function(e){let t="";for(const[r,a]of Object.entries(e))t+=`\tclassDef ${r}class fill:${a};\n`;return t}(i)),l}function dc(e){if(!_t(e.id))return e.id;if(!No(e.data))return e.data.name??"UnknownSchema";try{let t=e.data.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t.length>42&&(t=`${t.substring(0,42)}...`),t}catch(t){return e.data.getName()}}function hc(e){return No(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...oc(e.data.schema),title:e.data.name}}}class pc{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,r)=>{e[t.id]=_t(t.id)?r:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...hc(t)}))),edges:this.edges.map((t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]}))}}addNode(e,t){if(void 0!==t&&void 0!==this.nodes[t])throw new Error(`Node with id ${t} already exists`);const r=t||xt(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,r,a){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const n={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(n),n}firstNode(){const e=new Set(this.edges.map((e=>e.target))),t=[];return Object.values(this.nodes).forEach((r=>{e.has(r.id)||t.push(r)})),t[0]}lastNode(){const e=new Set(this.edges.map((e=>e.source))),t=[];return Object.values(this.nodes).forEach((r=>{e.has(r.id)||t.push(r)})),t[0]}extend(e,t=""){let r=t;Object.values(e.nodes).map((e=>e.id)).every(_t)&&(r="");const a=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[a(e)]={...t,id:a(e)}}));const n=e.edges.map((e=>({...e,source:a(e.source),target:a(e.target)})));this.edges=[...this.edges,...n];const i=e.firstNode(),s=e.lastNode();return[i?{id:a(i.id),data:i.data}:void 0,s?{id:a(s.id),data:s.data}:void 0]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter((t=>t.source===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter((t=>t.target===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}drawMermaid(e){const{withStyles:t,curveStyle:r,nodeColors:a={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:n}=e??{},i={};for(const e of Object.values(this.nodes))i[e.id]=dc(e);const s=this.firstNode(),o=s?dc(s):void 0,c=this.lastNode(),l=c?dc(c):void 0;return uc(i,this.edges,{firstNodeLabel:o,lastNodeLabel:l,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:n})}async drawMermaidPng(e){return async function(e,t){let{backgroundColor:r="white"}=t??{};const a=btoa(e);void 0!==r&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));const n=`https://mermaid.ink/img/${a}?bgColor=${r}`,i=await fetch(n);if(!i.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${i.status}`,`Status text: ${i.statusText}`].join("\n"));return await i.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function mc(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function fc(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*gc(e,t){const r=co.getInstance();for(;;){const{value:a,done:n}=r.run(e,t.next.bind(t));if(n)break;yield a}}async function*yc(e,t){const r=co.getInstance(),a=t[Symbol.asyncIterator]();for(;;){const{value:n,done:i}=await r.run(e,a.next.bind(t));if(i)break;yield n}}function vc(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class _c extends qt{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new bc({bound:this,kwargs:e,config:{}})}map(){return new wc({bound:this})}withRetry(e){return new Ec({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new bc({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new kc({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(ko);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const r=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,a)=>ko(0===a?e:r)))}return Array.from({length:t},(()=>ko(e)))}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=a[0]?.maxConcurrency??r?.maxConcurrency,i=new Rs({maxConcurrency:n,onFailedAttempt:e=>{throw e}}),s=e.map(((e,t)=>i.call((async()=>{try{return await this.invoke(e,a[t])}catch(e){if(r?.returnExceptions)return e;throw e}}))));return Promise.all(s)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const r=ko(t),a=new po({generator:this._streamIterator(e,r),config:r});return await a.setup,lo.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;t=ko(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,[t,r]}async _callWithConfig(e,t,r){const a=ko(r),n=await To(a),i=await(n?.handleChainStart(this.toJSON(),vc(t,"input"),a.runId,a?.runType,void 0,void 0,a?.runName??this.getName()));let s;delete a.runId;try{s=await e.call(this,t,a,i)}catch(e){throw await(i?.handleChainError(e)),e}return await(i?.handleChainEnd(vc(s,"output"))),s}async _batchWithConfig(e,t,r,a){const n=this._getOptionsList(r??{},t.length),i=await Promise.all(n.map(To)),s=await Promise.all(i.map((async(e,r)=>{const a=await(e?.handleChainStart(this.toJSON(),vc(t[r],"input"),n[r].runId,n[r].runType,void 0,void 0,n[r].runName??this.getName()));return delete n[r].runId,a})));let o;try{o=await e.call(this,t,n,s,a)}catch(e){throw await Promise.all(s.map((t=>t?.handleChainError(e)))),e}return await Promise.all(s.map((e=>e?.handleChainEnd(vc(o,"output"))))),o}async*_transformStreamWithConfig(e,t,r){let a,n,i=!0,s=!0;const o=ko(r),c=await To(o);let l;try{const r=await async function(e,t,r,...a){const n=new po({generator:t,startSetup:r}),i=await n.setup;return{output:e(n,i,...a),setup:i}}(t.bind(this),async function*(){for await(const t of e){if(i)if(void 0===a)a=t;else try{a=ho(a,t)}catch{a=void 0,i=!1}yield t}}(),(async()=>c?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),o);delete o.runId,l=r.setup;const u=l?.handlers.find(Eo);let d=r.output;void 0!==u&&void 0!==l&&(d=u.tapOutputIterable(l.runId,d));const h=l?.handlers.find(go);void 0!==h&&void 0!==l&&(d=h.tapOutputIterable(l.runId,d));for await(const e of d)if(yield e,s)if(void 0===n)n=e;else try{n=ho(n,e)}catch{n=void 0,s=!1}}catch(e){throw await(l?.handleChainError(e,void 0,void 0,void 0,{inputs:vc(a,"input")})),e}await(l?.handleChainEnd(n??{},void 0,void 0,void 0,{inputs:vc(a,"input")}))}getGraph(e){const t=new pc,r=t.addNode({name:`${this.getName()}Input`,schema:yt.any()}),a=t.addNode(this),n=t.addNode({name:`${this.getName()}Output`,schema:yt.any()});return t.addEdge(r,a),t.addEdge(a,n),t}pipe(e){return new Oc({first:this,last:Sc(e)})}pick(e){return this.pipe(new Nc(e))}assign(e){return this.pipe(new $c(new Tc({steps:e})))}async*transform(e,t){let r;for await(const t of e)r=void 0===r?t:ho(r,t);yield*this._streamIterator(r,ko(t))}async*streamLog(e,t,r){const a=new _o({...r,autoClose:!1,_schemaFormat:"original"}),n=ko(t);yield*this._streamLog(e,a,n)}async*_streamLog(e,t,r){const{callbacks:a}=r;if(void 0===a)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{const e=a.copy();e.inheritableHandlers.push(t),r.callbacks=e}const n=this.stream(e,r);const i=async function(){try{const e=await n;for await(const r of e){const e=new mo({ops:[{op:"add",path:"/streamed_output/-",value:r}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await i}}streamEvents(e,t,r){let a;if("v1"===t.version)a=this._streamEventsV1(e,t,r);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');a=this._streamEventsV2(e,t,r)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,r=new ReadableStream({async start(r){for await(const a of e)r.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(a)}\n\n`));r.enqueue(t.encode("event: end\n\n")),r.close()}});return lo.fromReadableStream(r)}(a):lo.fromAsyncGenerator(a)}async*_streamEventsV2(e,t,r){const a=new Oo({...r,autoClose:!1}),n=ko(t),i=n.runId??xt();n.runId=i;const s=n.callbacks;if(void 0===s)n.callbacks=[a];else if(Array.isArray(s))n.callbacks=s.concat(a);else{const e=s.copy();e.inheritableHandlers.push(a),n.callbacks=e}const o=this;const c=async function(){try{const t=await o.stream(e,n),r=a.tapOutputIterable(i,t);for await(const e of r);}finally{await a.finish()}}();let l,u=!1;try{for await(const t of a)u?(t.run_id===l&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,u=!0,l=t.run_id,yield t)}finally{await c}}async*_streamEventsV1(e,t,r){let a,n=!1;const i=ko(t),s=i.tags??[],o=i.metadata??{},c=i.runName??this.getName(),l=new _o({...r,autoClose:!1,_schemaFormat:"streaming_events"}),u=new Po({...r}),d=this._streamLog(e,l,i);for await(const t of d){if(a=a?a.concat(t):fo.fromRunLogPatch(t),void 0===a.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!n){n=!0;const t={...a.state},r={run_id:t.id,event:`on_${t.type}_start`,name:c,tags:s,metadata:o,data:{input:e}};u.includeEvent(r,t.type)&&(yield r)}const r=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),i=[...new Set(r)];for(const e of i){let t,r={};const n=a.state.logs[e];if(t=void 0===n.end_time?n.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==n.inputs&&(r.input=n.inputs);else if("end"===t)void 0!==n.inputs&&(r.input=n.inputs),r.output=n.final_output;else if("stream"===t){const e=n.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${n.name}"`);r={chunk:n.streamed_output[0]},n.streamed_output=[]}yield{event:`on_${n.type}_${t}`,name:n.name,run_id:n.id,tags:n.tags,metadata:n.metadata,data:r}}const{state:l}=a;if(l.streamed_output.length>0){const e=l.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${l.name}"`);const t={chunk:l.streamed_output[0]};l.streamed_output=[];const r={event:`on_${l.type}_stream`,run_id:l.id,tags:s,metadata:o,name:c,data:t};u.includeEvent(r,l.type)&&(yield r)}}const h=a?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:c,run_id:h.id,tags:s,metadata:o,data:{output:h.final_output}};u.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return No(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new bc({bound:this,config:{},configFactories:[a=>({callbacks:[new $o({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return function(e,t){const r=t.name??e.getName(),a=t.description??t.schema.description;return new Pc({name:r,description:a,schema:t.schema,bound:e})}(this,e)}}class bc extends _c{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Io(this.config,...e);return Io(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(ko(t),this.kwargs))}async batch(e,t,r){const a=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(ko(e),this.kwargs)))):await this._mergeConfig(ko(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(ko(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(ko(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(ko(t),this.kwargs))}streamEvents(e,t,r){const a=this;return lo.fromAsyncGenerator(async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(ko(t),a.kwargs),version:t.version},r)}())}static isRunnableBinding(e){return e.bound&&_c.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new bc({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new $o({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class wc extends _c{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new wc({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,So(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new wc({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Ec extends bc{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const a=e>1?`retry:attempt:${e}`:void 0;return So(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return Vr((a=>super.invoke(e,this._patchConfigForRetry(a,t,r))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){const n={};try{await Vr((async i=>{const s=e.map(((e,t)=>t)).filter((e=>void 0===n[e.toString()]||n[e.toString()]instanceof Error)),o=s.map((t=>e[t])),c=s.map((e=>this._patchConfigForRetry(i,t?.[e],r?.[e]))),l=await super.batch(o,c,{...a,returnExceptions:!0});let u;for(let e=0;e<l.length;e+=1){const t=l[e],r=s[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),n[r.toString()]=t}if(u)throw u;return l}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==a?.returnExceptions)throw e}return Object.keys(n).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>n[parseInt(e,10)]))}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class Oc extends _c{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=ko(t),a=await To(r),n=await(a?.handleChainStart(this.toJSON(),vc(e,"input"),r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;let i,s=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const a=e[t];s=await a.invoke(s,So(r,{callbacks:n?.getChild(`seq:step:${t+1}`)}))}i=await this.last.invoke(s,So(r,{callbacks:n?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(n?.handleChainError(e)),e}return await(n?.handleChainEnd(vc(i,"output"))),i}async batch(e,t,r){const a=this._getOptionsList(t??{},e.length),n=await Promise.all(a.map(To)),i=await Promise.all(n.map((async(t,r)=>{const n=await(t?.handleChainStart(this.toJSON(),vc(e[r],"input"),a[r].runId,void 0,void 0,void 0,a[r].runName));return delete a[r].runId,n})));let s=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];s=await t.batch(s,i.map(((t,r)=>{const n=t?.getChild(`seq:step:${e+1}`);return So(a[r],{callbacks:n})})),r)}}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(vc(s,"output"))))),s}async*_streamIterator(e,t){const r=await To(t),{runId:a,...n}=t??{},i=await(r?.handleChainStart(this.toJSON(),vc(e,"input"),a,void 0,void 0,void 0,n?.runName)),s=[this.first,...this.middle,this.last];let o,c=!0;try{let t=s[0].transform(async function*(){yield e}(),So(n,{callbacks:i?.getChild("seq:step:1")}));for(let e=1;e<s.length;e+=1){const r=s[e];t=await r.transform(t,So(n,{callbacks:i?.getChild(`seq:step:${e+1}`)}))}for await(const e of t)if(yield e,c)if(void 0===o)o=e;else try{o=ho(o,e)}catch(e){o=void 0,c=!1}}catch(e){throw await(i?.handleChainError(e)),e}await(i?.handleChainEnd(vc(o,"output")))}getGraph(e){const t=new pc;let r=null;return this.steps.forEach(((a,n)=>{const i=a.getGraph(e);0!==n&&i.trimFirstNode(),n!==this.steps.length-1&&i.trimLastNode(),t.extend(i);const s=i.firstNode();if(!s)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,s),r=i.lastNode()})),t}pipe(e){return Oc.isRunnableSequence(e)?new Oc({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new Oc({first:this.first,middle:[...this.middle,this.last],last:Sc(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&_c.isRunnable(e)}static from([e,...t],r){return new Oc({first:Sc(e),middle:t.slice(0,-1).map(Sc),last:Sc(t[t.length-1]),name:r})}}class Tc extends _c{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=Sc(r)}static from(e){return new Tc({steps:e})}async invoke(e,t){const r=ko(t),a=await To(r),n=await(a?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName));delete r.runId;const i={};try{await Promise.all(Object.entries(this.steps).map((async([t,a])=>{i[t]=await a.invoke(e,So(r,{callbacks:n?.getChild(`map:key:${t}`)}))})))}catch(e){throw await(n?.handleChainError(e)),e}return await(n?.handleChainEnd(i)),i}async*_transform(e,t,r){const a={...this.steps},n=uo(e,Object.keys(a).length),i=new Map(Object.entries(a).map((([e,a],i)=>{const s=a.transform(n[i],So(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then((t=>({key:e,gen:s,result:t})))]})));for(;i.size;){const{key:e,result:t,gen:r}=await Promise.race(i.values());i.delete(e),t.done||(yield{[e]:t.value},i.set(e,r.next().then((t=>({key:e,gen:r,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=ko(t),a=new po({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,lo.fromAsyncGenerator(a)}}class Ic extends _c{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!vs(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[r]=this._getOptionsList(t??{},1),a=await To(r);return await this.func(So(r,{callbacks:a}),e)}async*_streamIterator(e,t){const r=await this.invoke(e,t);var a;if(fc(r))for await(const e of r)yield e;else if(null!=(a=r)&&"object"==typeof a&&"next"in a&&"function"==typeof a.next)for(;;){const e=r.next();if(e.done)break;yield e.value}else yield r}static from(e){return new Ic({func:e})}}class xc extends _c{static lc_name(){return"RunnableLambda"}constructor(e){if(vs(e.func))return Ic.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if(vs(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new xc({func:e})}async _invoke(e,t,r){return new Promise(((a,n)=>{const i=So(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});co.getInstance().run(i,(async()=>{try{let r=await this.func(e,{...i,config:i});if(r&&_c.isRunnable(r)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");r=await r.invoke(e,{...i,recursionLimit:(i.recursionLimit??25)-1})}else if(fc(r)){let e;for await(const t of yc(i,r))if(void 0===e)e=t;else try{e=ho(e,t)}catch(r){e=t}r=e}else if(mc(r)){let e;for(const t of gc(i,r))if(void 0===e)e=t;else try{e=ho(e,t)}catch(r){e=t}r=e}a(r)}catch(e){n(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let a;for await(const t of e)if(void 0===a)a=t;else try{a=ho(a,t)}catch(e){a=t}const n=So(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??25)-1}),i=await new Promise(((e,t)=>{co.getInstance().run(n,(async()=>{try{const t=await this.func(a,{...n,config:n});e(t)}catch(e){t(e)}}))}));if(i&&_c.isRunnable(i)){if(0===r?.recursionLimit)throw new Error("Recursion limit reached.");const e=await i.stream(a,n);for await(const t of e)yield t}else if(fc(i))for await(const e of yc(n,i))yield e;else if(mc(i))for(const e of gc(n,i))yield e;else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=ko(t),a=new po({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,lo.fromAsyncGenerator(a)}}class kc extends _c{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=ko(t),a=await To(t),{runId:n,...i}=r,s=await(a?.handleChainStart(this.toJSON(),vc(e,"input"),n,void 0,void 0,void 0,i?.runName));let o;for(const t of this.runnables())try{const r=await t.invoke(e,So(i,{callbacks:s?.getChild()}));return await(s?.handleChainEnd(vc(r,"output"))),r}catch(e){void 0===o&&(o=e)}if(void 0===o)throw new Error("No error stored at end of fallback.");throw await(s?.handleChainError(o)),o}async batch(e,t,r){if(r?.returnExceptions)throw new Error("Not implemented.");const a=this._getOptionsList(t??{},e.length),n=await Promise.all(a.map((e=>To(e)))),i=await Promise.all(n.map((async(t,r)=>{const n=await(t?.handleChainStart(this.toJSON(),vc(e[r],"input"),a[r].runId,void 0,void 0,void 0,a[r].runName));return delete a[r].runId,n})));let s;for(const t of this.runnables())try{const n=await t.batch(e,i.map(((e,t)=>So(a[t],{callbacks:e?.getChild()}))),r);return await Promise.all(i.map(((e,t)=>e?.handleChainEnd(vc(n[t],"output"))))),n}catch(e){void 0===s&&(s=e)}if(!s)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(i.map((e=>e?.handleChainError(s)))),s}}function Sc(e){if("function"==typeof e)return new xc({func:e});if(_c.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[r,a]of Object.entries(e))t[r]=Sc(a);return new Tc({steps:t})}}class $c extends _c{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Tc&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const a=this.mapper.getStepsKeys(),[n,i]=uo(e),s=this.mapper.transform(i,So(r,{callbacks:t?.getChild()})),o=s.next();for await(const e of n){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!a.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of s)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=ko(t),a=new po({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,lo.fromAsyncGenerator(a)}}class Nc extends _c{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const r=ko(t),a=new po({generator:this.transform(async function*(){yield e}(),r),config:r});return await a.setup,lo.fromAsyncGenerator(a)}}class Pc extends bc{constructor(e){super({bound:e.bound,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}class Rc extends _c{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Ac extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}class jc extends Rc{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),this.responseFormat=e?.responseFormat??this.responseFormat}async invoke(e,t){let r,a;var n;(n=e)&&"object"==typeof n&&"type"in n&&"tool_call"===n.type?(r=e.id,a=e.args):a=e;const i=ko(t);return this.call(a,{...i,configurable:{...i.configurable,tool_call_id:r}})}async call(e,t,r){let a;try{a=await this.schema.parseAsync(e)}catch(t){throw new Ac("Received tool input did not match expected schema",JSON.stringify(e))}const n=function(e){return e?Array.isArray(e)||"name"in e?{callbacks:e}:e:{}}(t),i=await Ss.configure(n.callbacks,this.callbacks,n.tags||r,this.tags,n.metadata,this.metadata,{verbose:this.verbose}),s=await(i?.handleToolStart(this.toJSON(),"string"==typeof a?a:JSON.stringify(a),n.runId,void 0,void 0,void 0,n.runName));let o,c,l,u;delete n.runId;try{o=await this._call(a,s,n)}catch(e){throw await(s?.handleToolError(e)),e}if("content_and_artifact"===this.responseFormat){if(!Array.isArray(o)||2!==o.length)throw new Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.\nResult: ${JSON.stringify(o)}`);[c,l]=o}else c=o;n&&"configurable"in n&&(u=n.configurable.tool_call_id);const d=function(e){const{content:t,artifact:r,toolCallId:a}=e;return a?"string"==typeof t||Array.isArray(t)&&t.every((e=>"object"==typeof e))?new Mr({content:t,artifact:r,tool_call_id:a,name:e.name}):new Mr({content:Lc(t),artifact:r,tool_call_id:a,name:e.name}):t}({content:c,artifact:l,toolCallId:u,name:this.name});return await(s?.handleToolEnd(d)),d}}class Cc extends jc{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:yt.object({input:yt.string().optional()}).transform((e=>e.input))})}call(e,t){return super.call("string"!=typeof e&&e?e:{input:e},t)}}function Lc(e){try{return JSON.stringify(e,null,2)}catch(t){return`${e}`}}class Mc extends Error{response;request;options;constructor(e,t,r){const a=`${e.status||0===e.status?e.status:""} ${e.statusText||""}`.trim();super(`Request failed with ${a?`status code ${a}`:"an unknown error"}: ${t.method} ${t.url}`),this.name="HTTPError",this.response=e,this.request=t,this.options=r}}class Uc extends Error{request;constructor(e){super(`Request timed out: ${e.method} ${e.url}`),this.name="TimeoutError",this.request=e}}const Dc=e=>null!==e&&"object"==typeof e,Zc=(...e)=>{for(const t of e)if((!Dc(t)||Array.isArray(t))&&void 0!==t)throw new TypeError("The `options` argument must be an object");return qc({},...e)},Fc=(e={},t={})=>{const r=new globalThis.Headers(e),a=t instanceof globalThis.Headers,n=new globalThis.Headers(t);for(const[e,t]of n.entries())a&&"undefined"===t||void 0===t?r.delete(e):r.set(e,t);return r};function Hc(e,t,r){return Object.hasOwn(t,r)&&void 0===t[r]?[]:qc(e[r]??[],t[r]??[])}const Bc=(e={},t={})=>({beforeRequest:Hc(e,t,"beforeRequest"),beforeRetry:Hc(e,t,"beforeRetry"),afterResponse:Hc(e,t,"afterResponse"),beforeError:Hc(e,t,"beforeError")}),qc=(...e)=>{let t={},r={},a={};for(const n of e)if(Array.isArray(n))Array.isArray(t)||(t=[]),t=[...t,...n];else if(Dc(n)){for(let[e,r]of Object.entries(n))Dc(r)&&e in t&&(r=qc(t[e],r)),t={...t,[e]:r};Dc(n.hooks)&&(a=Bc(a,n.hooks),t.hooks=a),Dc(n.headers)&&(r=Fc(r,n.headers),t.headers=r)}return t},Gc=(()=>{let e=!1,t=!1;const r="function"==typeof globalThis.ReadableStream,a="function"==typeof globalThis.Request;if(r&&a)try{t=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type")}catch(e){if(e instanceof Error&&"unsupported BodyInit type"===e.message)return!1;throw e}return e&&!t})(),zc="function"==typeof globalThis.AbortController,Vc="function"==typeof globalThis.ReadableStream,Jc="function"==typeof globalThis.FormData,Wc=["get","post","put","patch","head","delete"],Kc={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},Xc=2147483647,Yc=Symbol("stop"),Qc={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},el={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},tl=e=>Wc.includes(e)?e.toUpperCase():e,rl={limit:2,methods:["get","put","head","delete","options","trace"],statusCodes:[408,413,429,500,502,503,504],afterStatusCodes:[413,429,503],maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:e=>.3*2**(e-1)*1e3},al=(e={})=>{if("number"==typeof e)return{...rl,limit:e};if(e.methods&&!Array.isArray(e.methods))throw new Error("retry.methods must be an array");if(e.statusCodes&&!Array.isArray(e.statusCodes))throw new Error("retry.statusCodes must be an array");return{...rl,...e}};class nl{static create(e,t){const r=new nl(e,t),a=async()=>{if("number"==typeof r._options.timeout&&r._options.timeout>Xc)throw new RangeError("The `timeout` option cannot be greater than 2147483647");await Promise.resolve();let e=await r._fetch();for(const t of r._options.hooks.afterResponse){const a=await t(r.request,r._options,r._decorateResponse(e.clone()));a instanceof globalThis.Response&&(e=a)}if(r._decorateResponse(e),!e.ok&&r._options.throwHttpErrors){let t=new Mc(e,r.request,r._options);for(const e of r._options.hooks.beforeError)t=await e(t);throw t}if(r._options.onDownloadProgress){if("function"!=typeof r._options.onDownloadProgress)throw new TypeError("The `onDownloadProgress` option must be a function");if(!Vc)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return r._stream(e.clone(),r._options.onDownloadProgress)}return e},n=r._options.retry.methods.includes(r.request.method.toLowerCase())?r._retry(a):a();for(const[e,a]of Object.entries(Kc))n[e]=async()=>{r.request.headers.set("accept",r.request.headers.get("accept")||a);const i=(await n).clone();if("json"===e){if(204===i.status)return"";if(0===(await i.clone().arrayBuffer()).byteLength)return"";if(t.parseJson)return t.parseJson(await i.text())}return i[e]()};return n}request;abortController;_retryCount=0;_input;_options;constructor(e,t={}){if(this._input=e,this._options={...t,headers:Fc(this._input.headers,t.headers),hooks:Bc({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},t.hooks),method:tl(t.method??this._input.method),prefixUrl:String(t.prefixUrl||""),retry:al(t.retry),throwHttpErrors:!1!==t.throwHttpErrors,timeout:t.timeout??1e4,fetch:t.fetch??globalThis.fetch.bind(globalThis)},"string"!=typeof this._input&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&"string"==typeof this._input){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(zc){this.abortController=new globalThis.AbortController;const e=this._options.signal??this._input.signal;e?.addEventListener("abort",(()=>{this.abortController.abort(e.reason)})),this._options.signal=this.abortController.signal}if(Gc&&(this._options.duplex="half"),void 0!==this._options.json&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const e="?"+("string"==typeof this._options.searchParams?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),t=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,e);!(Jc&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)||this._options.headers&&this._options.headers["content-type"]||this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(t,{...this.request}),this._options)}}_calculateRetryDelay(e){if(this._retryCount++,this._retryCount>this._options.retry.limit||e instanceof Uc)throw e;if(e instanceof Mc){if(!this._options.retry.statusCodes.includes(e.response.status))throw e;const t=e.response.headers.get("Retry-After")??e.response.headers.get("RateLimit-Reset")??e.response.headers.get("X-RateLimit-Reset")??e.response.headers.get("X-Rate-Limit-Reset");if(t&&this._options.retry.afterStatusCodes.includes(e.response.status)){let e=1e3*Number(t);Number.isNaN(e)?e=Date.parse(t)-Date.now():e>=Date.parse("2024-01-01")&&(e-=Date.now());const r=this._options.retry.maxRetryAfter??e;return e<r?e:r}if(413===e.response.status)throw e}const t=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,t)}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(t){const r=Math.min(this._calculateRetryDelay(t),Xc);if(this._retryCount<1)throw t;await async function(e,{signal:t}){return new Promise(((r,a)=>{function n(){clearTimeout(i),a(t.reason)}t&&(t.throwIfAborted(),t.addEventListener("abort",n,{once:!0}));const i=setTimeout((()=>{t?.removeEventListener("abort",n),r()}),e)}))}(r,{signal:this._options.signal});for(const e of this._options.hooks.beforeRetry){if(await e({request:this.request,options:this._options,error:t,retryCount:this._retryCount})===Yc)return}return this._retry(e)}}async _fetch(){for(const e of this._options.hooks.beforeRequest){const t=await e(this.request,this._options);if(t instanceof Request){this.request=t;break}if(t instanceof Response)return t}const e=((e,t)=>{const r={};for(const a in t)a in el||a in Qc||a in e||(r[a]=t[a]);return r})(this.request,this._options),t=this.request;return this.request=t.clone(),!1===this._options.timeout?this._options.fetch(t,e):async function(e,t,r,a){return new Promise(((n,i)=>{const s=setTimeout((()=>{r&&r.abort(),i(new Uc(e))}),a.timeout);a.fetch(e,t).then(n).catch(i).then((()=>{clearTimeout(s)}))}))}(t,e,this.abortController,this._options)}_stream(e,t){const r=Number(e.headers.get("content-length"))||0;let a=0;return 204===e.status?(t&&t({percent:1,totalBytes:r,transferredBytes:a},new Uint8Array),new globalThis.Response(null,{status:e.status,statusText:e.statusText,headers:e.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(n){const i=e.body.getReader();t&&t({percent:0,transferredBytes:0,totalBytes:r},new Uint8Array),await async function e(){const{done:s,value:o}=await i.read();if(s)n.close();else{if(t){a+=o.byteLength;t({percent:0===r?0:a/r,transferredBytes:a,totalBytes:r},o)}n.enqueue(o),await e()}}()}}),{status:e.status,statusText:e.statusText,headers:e.headers})}}
/*! MIT License © Sindre Sorhus */const il=e=>{const t=(t,r)=>nl.create(t,Zc(e,r));for(const r of Wc)t[r]=(t,a)=>nl.create(t,Zc(e,a,{method:r}));return t.create=e=>il(Zc(e)),t.extend=t=>("function"==typeof t&&(t=t(e??{})),il(Zc(e,t))),t.stop=Yc,t},sl=il();exports.Firecrawl=class extends Cc{constructor(e){super(e),this.name="firecrawl",this.apiKey=e.apiKey,this.format=e.format||"markdown",this.mode="scrape",this.description=`Fetches web content from a specified URL and returns it in ${this.format} format. Input should be a JSON object with a "url".`,this.schema=yt.object({url:yt.string().describe("The URL to scrape and retrieve content from.")}),this.httpClient=sl}async _call(e){try{const t=await this.httpClient.post("https://api.firecrawl.dev/v1/scrape",{json:{url:e.url,formats:[this.format]},headers:{Authorization:`Bearer ${this.apiKey}`}}).json();return t?.data?.[this.format]||"The API returned an empty response."}catch(e){if(e instanceof Mc){const t=e.response.status;let r="Unknown";return t>=400&&t<500?r="Client Error":t>=500&&(r="Server Error"),`API request failed: ${r} (${t})`}return`An unexpected error occurred: ${e.message}`}}};
