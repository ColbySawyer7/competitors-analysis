import*as e from"uuid";import{v4 as t,validate as n}from"uuid";import r from"react";function s(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(n){if("default"!==n&&!(n in e)){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}}))})),Object.freeze(e)}const a=e=>{let t;const n=new Set,r=(e,r)=>{const s="function"==typeof e?e(t):e;if(!Object.is(s,t)){const e=t;t=(null!=r?r:"object"!=typeof s||null===s)?s:Object.assign({},t,s),n.forEach((n=>n(t,e)))}},s=()=>t,a={setState:r,getState:s,getInitialState:()=>i,subscribe:e=>(n.add(e),()=>n.delete(e)),destroy:()=>{"production"!==(import.meta.env?import.meta.env.MODE:void 0)&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},i=t=e(r,s,a);return a};var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var l,c={exports:{}},u={},d={exports:{}},h={};var p,f,m,g={};
/**
 * @license React
 * use-sync-external-store-shim.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */function y(){return p||(p=1,"production"!==process.env.NODE_ENV&&function(){"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error);var e=r,t=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function n(e){for(var n=arguments.length,r=new Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];!function(e,n,r){var s=t.ReactDebugCurrentFrame.getStackAddendum();""!==s&&(n+="%s",r=r.concat([s]));var a=r.map((function(e){return String(e)}));a.unshift("Warning: "+n),Function.prototype.apply.call(console[e],console,a)}("error",e,r)}var s="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},a=e.useState,i=e.useEffect,o=e.useLayoutEffect,l=e.useDebugValue,c=!1,u=!1;function d(e){var t=e.getSnapshot,n=e.value;try{var r=t();return!s(n,r)}catch(e){return!0}}var h=!!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement)?function(e,t,n){return t()}:function(t,r,h){c||void 0!==e.startTransition&&(c=!0,n("You are using an outdated, pre-release alpha of React 18 that does not support useSyncExternalStore. The use-sync-external-store shim will not work correctly. Upgrade to a newer pre-release."));var p=r();if(!u){var f=r();s(p,f)||(n("The result of getSnapshot should be cached to avoid an infinite loop"),u=!0)}var m=a({inst:{value:p,getSnapshot:r}}),g=m[0].inst,y=m[1];return o((function(){g.value=p,g.getSnapshot=r,d(g)&&y({inst:g})}),[t,p,r]),i((function(){d(g)&&y({inst:g});return t((function(){d(g)&&y({inst:g})}))}),[t]),l(p),p},p=void 0!==e.useSyncExternalStore?e.useSyncExternalStore:h;g.useSyncExternalStore=p,"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error)}()),g}function w(){return f||(f=1,"production"===process.env.NODE_ENV?d.exports=function(){if(l)return h;l=1;var e=r,t="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},n=e.useState,s=e.useEffect,a=e.useLayoutEffect,i=e.useDebugValue;function o(e){var n=e.getSnapshot;e=e.value;try{var r=n();return!t(e,r)}catch(e){return!0}}var c="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var r=t(),l=n({inst:{value:r,getSnapshot:t}}),c=l[0].inst,u=l[1];return a((function(){c.value=r,c.getSnapshot=t,o(c)&&u({inst:c})}),[e,r,t]),s((function(){return o(c)&&u({inst:c}),e((function(){o(c)&&u({inst:c})}))}),[e]),i(r),r};return h.useSyncExternalStore=void 0!==e.useSyncExternalStore?e.useSyncExternalStore:c,h}():d.exports=y()),d.exports}
/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var b,v={};
/**
 * @license React
 * use-sync-external-store-shim/with-selector.development.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */"production"===process.env.NODE_ENV?c.exports=function(){if(m)return u;m=1;var e=r,t=w(),n="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},s=t.useSyncExternalStore,a=e.useRef,i=e.useEffect,o=e.useMemo,l=e.useDebugValue;return u.useSyncExternalStoreWithSelector=function(e,t,r,c,u){var d=a(null);if(null===d.current){var h={hasValue:!1,value:null};d.current=h}else h=d.current;d=o((function(){function e(e){if(!i){if(i=!0,s=e,e=c(e),void 0!==u&&h.hasValue){var t=h.value;if(u(t,e))return a=t}return a=e}if(t=a,n(s,e))return t;var r=c(e);return void 0!==u&&u(t,r)?t:(s=e,a=r)}var s,a,i=!1,o=void 0===r?null:r;return[function(){return e(t())},null===o?void 0:function(){return e(o())}]}),[t,r,c,u]);var p=s(e,d[0],d[1]);return i((function(){h.hasValue=!0,h.value=p}),[p]),l(p),p},u}():c.exports=(b||(b=1,"production"!==process.env.NODE_ENV&&function(){"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error);var e=r,t=w(),n="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},s=t.useSyncExternalStore,a=e.useRef,i=e.useEffect,o=e.useMemo,l=e.useDebugValue;v.useSyncExternalStoreWithSelector=function(e,t,r,c,u){var d,h=a(null);null===h.current?(d={hasValue:!1,value:null},h.current=d):d=h.current;var p=o((function(){var e,s,a=!1,i=function(t){if(!a){a=!0,e=t;var r=c(t);if(void 0!==u&&d.hasValue){var i=d.value;if(u(i,r))return s=i,i}return s=r,r}var o=s;if(n(e,t))return o;var l=c(t);return void 0!==u&&u(o,l)?o:(e=t,s=l,l)},o=void 0===r?null:r;return[function(){return i(t())},null===o?void 0:function(){return i(o())}]}),[t,r,c,u]),f=p[0],m=p[1],g=s(e,f,m);return i((function(){d.hasValue=!0,d.value=g}),[g]),l(g),g},"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error)}()),v);var _=o(c.exports);const{useDebugValue:k}=r,{useSyncExternalStoreWithSelector:E}=_;let O=!1;const T=e=>e;const S=e=>{"production"!==(import.meta.env?import.meta.env.MODE:void 0)&&"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t="function"==typeof e?(e=>e?a(e):a)(e):e,n=(e,n)=>function(e,t=T,n){"production"!==(import.meta.env?import.meta.env.MODE:void 0)&&n&&!O&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),O=!0);const r=E(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,n);return k(r),r}(t,e,n);return Object.assign(n,t),n},A=new Map,I=e=>{const t=A.get(e);return t?Object.fromEntries(Object.entries(t.stores).map((([e,t])=>[e,t.getState()]))):{}},x=(e,t={})=>(n,r,s)=>{const{enabled:a,anonymousActionType:i,store:o,...l}=t;let c;try{c=(null!=a?a:"production"!==(import.meta.env?import.meta.env.MODE:void 0))&&window.__REDUX_DEVTOOLS_EXTENSION__}catch(e){}if(!c)return"production"!==(import.meta.env?import.meta.env.MODE:void 0)&&a&&console.warn("[zustand devtools middleware] Please install/enable Redux devtools extension"),e(n,r,s);const{connection:u,...d}=((e,t,n)=>{if(void 0===e)return{type:"untracked",connection:t.connect(n)};const r=A.get(n.name);if(r)return{type:"tracked",store:e,...r};const s={connection:t.connect(n),stores:{}};return A.set(n.name,s),{type:"tracked",store:e,...s}})(o,c,l);let h=!0;s.setState=(e,t,a)=>{const c=n(e,t);if(!h)return c;const d=void 0===a?{type:i||"anonymous"}:"string"==typeof a?{type:a}:a;return void 0===o?(null==u||u.send(d,r()),c):(null==u||u.send({...d,type:`${o}/${d.type}`},{...I(l.name),[o]:s.getState()}),c)};const p=(...e)=>{const t=h;h=!1,n(...e),h=t},f=e(s.setState,r,s);if("untracked"===d.type?null==u||u.init(f):(d.stores[d.store]=s,null==u||u.init(Object.fromEntries(Object.entries(d.stores).map((([e,t])=>[e,e===d.store?f:t.getState()]))))),s.dispatchFromDevtools&&"function"==typeof s.dispatch){let e=!1;const t=s.dispatch;s.dispatch=(...n)=>{"production"===(import.meta.env?import.meta.env.MODE:void 0)||"__setState"!==n[0].type||e||(console.warn('[zustand devtools middleware] "__setState" action type is reserved to set state from the devtools. Avoid using it.'),e=!0),t(...n)}}return u.subscribe((e=>{var t;switch(e.type){case"ACTION":return"string"!=typeof e.payload?void console.error("[zustand devtools middleware] Unsupported action format"):P(e.payload,(e=>{if("__setState"!==e.type)s.dispatchFromDevtools&&"function"==typeof s.dispatch&&s.dispatch(e);else{if(void 0===o)return void p(e.state);1!==Object.keys(e.state).length&&console.error('\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using \'store\' option in devtools(), the \'state\' should have only one key, which is a value of \'store\' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }\n                    ');const t=e.state[o];if(null==t)return;JSON.stringify(s.getState())!==JSON.stringify(t)&&p(t)}}));case"DISPATCH":switch(e.payload.type){case"RESET":return p(f),void 0===o?null==u?void 0:u.init(s.getState()):null==u?void 0:u.init(I(l.name));case"COMMIT":return void 0===o?void(null==u||u.init(s.getState())):null==u?void 0:u.init(I(l.name));case"ROLLBACK":return P(e.state,(e=>{if(void 0===o)return p(e),void(null==u||u.init(s.getState()));p(e[o]),null==u||u.init(I(l.name))}));case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return P(e.state,(e=>{void 0!==o?JSON.stringify(s.getState())!==JSON.stringify(e[o])&&p(e[o]):p(e)}));case"IMPORT_STATE":{const{nextLiftedState:n}=e.payload,r=null==(t=n.computedStates.slice(-1)[0])?void 0:t.state;if(!r)return;return p(void 0===o?r:r[o]),void(null==u||u.send(null,n))}case"PAUSE_RECORDING":return h=!h}return}})),f},P=(e,t)=>{let n;try{n=JSON.parse(e)}catch(e){console.error("[zustand devtools middleware] Could not parse the received json",e)}void 0!==n&&t(n)},C=e=>(t,n,r)=>{const s=r.subscribe;r.subscribe=(e,t,n)=>{let a=e;if(t){const s=(null==n?void 0:n.equalityFn)||Object.is;let i=e(r.getState());a=n=>{const r=e(n);if(!s(i,r)){const e=i;t(i=r,e)}},(null==n?void 0:n.fireImmediately)&&t(i,i)}return s(a)};return e(t,n,r)},N="INITIAL",R="THINKING",$="THINKING_END",j="THINKING_ERROR",L="THOUGHT",M="EXECUTING_ACTION",D="USING_TOOL",U="USING_TOOL_END",F="USING_TOOL_ERROR",B="TOOL_DOES_NOT_EXIST",q="OBSERVATION",H="FINAL_ANSWER",z="TASK_COMPLETED",W="MAX_ITERATIONS_ERROR",K="ISSUES_PARSING_LLM_OUTPUT",V="SELF_QUESTION",G="ITERATION_START",Z="ITERATION_END",J="AGENTIC_LOOP_ERROR",X="WEIRD_LLM_OUTPUT",Y="TODO",Q="DOING",ee="BLOCKED",te="REVISE",ne="DONE",re="AWAITING_VALIDATION",se="VALIDATED",ae="INITIAL",ie="RUNNING",oe="STOPPING",le="STOPPED",ce="ERRORED",ue="FINISHED",de="BLOCKED",he="PENDING",pe="PROCESSED";var fe,me={exports:{}};fe=me,function(e,t){fe.exports?fe.exports=t():e.log=t()}(i,(function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},a=null;function i(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(){for(var n=this.getLevel(),s=0;s<r.length;s++){var a=r[s];this[a]=s<n?e:this.methodFactory(a,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function c(e){return function(){typeof console!==t&&(l.call(this),this[e].apply(this,arguments))}}function u(r,s,a){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?o:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):e)}(r)||c.apply(this,arguments)}function d(e,n){var i,o,c,d=this,h="loglevel";function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=encodeURIComponent(h),s=n.indexOf(r+"=");-1!==s&&(e=/^([^;]+)/.exec(n.slice(s+r.length+1))[1])}catch(e){}return void 0===d.levels[e]&&(e=void 0),e}}function f(e){var t=e;if("string"==typeof t&&void 0!==d.levels[t.toUpperCase()]&&(t=d.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=d.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),d.name=e,d.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},d.methodFactory=n||u,d.getLevel=function(){return null!=c?c:null!=o?o:i},d.setLevel=function(e,n){return c=f(e),!1!==n&&function(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+n+";"}catch(e){}}}(c),l.call(d)},d.setDefaultLevel=function(e){o=f(e),p()||d.setLevel(e,!1)},d.resetLevel=function(){c=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),l.call(d)},d.enableAll=function(e){d.setLevel(d.levels.TRACE,e)},d.disableAll=function(e){d.setLevel(d.levels.SILENT,e)},d.rebuild=function(){if(a!==d&&(i=f(a.getLevel())),l.call(d),a===d)for(var e in s)s[e].rebuild()},i=f(a?a.getLevel():"WARN");var m=p();null!=m&&(c=f(m)),l.call(d)}(a=new d).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=s[e];return t||(t=s[e]=new d(e,a.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=h),a},a.getLoggers=function(){return s},a.default=a,a}));var ge=o(me.exports);ge.setLevel(ge.levels.INFO);const ye=(e,t)=>({handleAgentIterationStart:({agent:n,task:r,iterations:s,maxAgentIterations:a})=>{n.status=G;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ Agent ${n.name} - ${G} (${s+1}/${a})`,metadata:{iterations:s,maxAgentIterations:a},logType:"AgentStatusUpdate",agentStatus:n.status});ge.trace(`ðŸ ${G}: Agent ${n.name} -  (${s+1}/${a})`),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentIterationEnd:({agent:n,task:r,iterations:s,maxAgentIterations:a})=>{n.status=Z;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ”„ Agent ${n.name} - ${Z}`,metadata:{iterations:s,maxAgentIterations:a},logType:"AgentStatusUpdate",agentStatus:n.status});ge.trace(`ðŸ”„ ${Z}: Agent ${n.name} ended another iteration.`),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentThinkingStart:({agent:n,task:r,messages:s})=>{n.status=R;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¤” Agent ${n.name} starts thinking...`,metadata:{messages:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ¤” ${R}: Agent ${n.name} starts thinking...`),ge.debug("System Message:",s[0]),ge.debug("Feedback Message:",s[s.length-1].content),ge.debug("All Messages",s),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentThinkingEnd:({agent:n,task:r,output:s})=>{n.status=$;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¤” Agent ${n.name} finished thinking.`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ’¡ ${$}: Agent ${n.name} finished thinking.`),ge.trace("Output:",s.parsedLLMOutput),ge.trace("Usage:",s.llmUsageStats),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentThinkingError:({agent:n,task:r,error:s})=>{const a=s.originalError||s;n.status=j;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ›‘ Agent ${n.name} encountered an error during ${R}.`,metadata:{error:a},logType:"AgentStatusUpdate",agentStatus:n.status});ge.error(`ðŸ›‘ ${j}: Agent ${n.name} encountered an error thinking. Further details: ${s.name?s.name:"No additional error details"}`,a.message),e((e=>({workflowLogs:[...e.workflowLogs,i]}))),t().handleTaskBlocked({task:r,error:s})},handleAgentIssuesParsingLLMOutput:({agent:n,task:r,output:s,error:a})=>{n.status=K;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ˜¡ Agent ${n.name} found some ${K}. ${a.message}`,metadata:{output:s,error:a},logType:"AgentStatusUpdate",agentStatus:n.status});ge.debug(`ðŸ˜¡ ${K}: Agent ${n.name} found issues parsing the LLM output. ${a.message}`),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentActionStart:({agent:n,task:r,action:s,runId:a})=>{n.status=M;const i=t().prepareNewLog({agent:n,task:r,logDescription:`Agent action started: ${s}`,metadata:{action:s,runId:a},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`â–¶ï¸ EXECUTE_ACTION: Agent ${n.name} use tool ${s.tool} with the following input:  ${s.toolInput}`,s),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolStart:({agent:n,task:r,tool:s,input:a})=>{n.status=D;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ› ï¸â³ Agent ${n.name} is ${D} ${s.name}...`,metadata:{tool:s,input:a},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ› ï¸â³ ${D}: Agent ${n.name} is  using ${s.name}...`),ge.debug("Tool Input:",a),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolEnd:({agent:n,task:r,output:s,tool:a})=>{n.status=U;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ› ï¸âœ… ${U}: Agent ${n.name} - got  results from tool:${a.name}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ› ï¸âœ… ${U}: Agent ${n.name} - got  results from tool:${a.name}`),ge.debug("Tool Output:",s),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolError:({agent:n,task:r,tool:s,error:a})=>{n.status=F;const i=t().prepareNewLog({agent:n,task:r,logDescription:"Error during tool use",metadata:{error:a},logType:"AgentStatusUpdate",agentStatus:n.status});ge.error(`ðŸ› ï¸ðŸ›‘ ${F}: Agent ${n.name} found an error using the tool: ${s.name}`),ge.error(a),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolDoesNotExist:({agent:n,task:r,toolName:s})=>{n.status=F;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ› ï¸ðŸš« Agent ${n.name} - Oops... it seems that the tool:${s} ${B}.`,metadata:{toolName:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.warn(`ðŸ› ï¸ðŸš« ${B}: Agent ${n.name} - is trying to use a tool that does not exist. Tool Name:${s}.`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentFinalAnswer:({agent:n,task:r,output:s})=>{n.status=H;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¥³ Agent ${n.name} got the ${H}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ¥³ ${H}: Agent ${n.name} arrived to the Final Answer.`),ge.debug(`${s.finalAnswer}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentThought:({agent:n,task:r,output:s})=>{n.status=L;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ’­ Agent ${n.name} ${L}.`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ’­ ${L}: Agent ${n.name} has a cool though.`),ge.info(`${s.thought}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentSelfQuestion:({agent:n,task:r,output:s})=>{n.status=V;const a=t().prepareNewLog({agent:n,task:r,logDescription:`â“Agent ${n.name} have a ${V}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`â“${V}: Agent ${n.name} have a self question.`),ge.debug(s),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentObservation:({agent:n,task:r,output:s})=>{n.status=q;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ” Agent ${n.name} - ${q}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ” ${q}: Agent ${n.name} made an observation.`),ge.debug(`${s.observation}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleWeirdOutput:({agent:n,task:r,output:s})=>{n.status=X;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¤” Agent ${n.name} - ${X}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ge.warn(`ðŸ¤” ${X} - Agent: ${n.name}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentLoopError:({agent:n,task:r,error:s,iterations:a,maxAgentIterations:i})=>{n.status=J;const o=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸš¨ Agent ${n.name} - ${J} | Iterations: ${a}/${i}`,metadata:{error:s,iterations:a,maxAgentIterations:i},logType:"AgentStatusUpdate",agentStatus:n.status});ge.error(`ðŸš¨ ${J}  - Agent: ${n.name} | Iterations: ${a}/${i}`,s.message),e((e=>({workflowLogs:[...e.workflowLogs,o]}))),t().handleTaskBlocked({task:r,error:s})},handleAgentMaxIterationsError:({agent:n,task:r,error:s,iterations:a=-1,maxAgentIterations:i=-1})=>{n.status=W;const o=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ›‘ Agent ${n.name} - ${W} | Iterations: ${a}`,metadata:{error:s,iterations:a,maxAgentIterations:i},logType:"AgentStatusUpdate",agentStatus:n.status});ge.error(`ðŸ›‘ ${W} - Agent ${n.name} | Iterations: ${a}/${i}. You can adjust the maxAgentIterations property in the agent initialization. Current value is ${i}`),e((e=>({workflowLogs:[...e.workflowLogs,o]}))),t().handleTaskBlocked({task:r,error:s})},handleAgentTaskCompleted:({agent:n,task:r,result:s,iterations:a,maxAgentIterations:i})=>{n.status=z;const o=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ Agent ${n.name} - ${z}`,metadata:{result:s,iterations:a,maxAgentIterations:i},logType:"AgentStatusUpdate",agentStatus:n.status});ge.info(`ðŸ ${z}: Agent ${n.name} finished the given task.`),e((e=>({workflowLogs:[...e.workflowLogs,o]}))),t().handleTaskCompleted({agent:n,task:r,result:s})}});function we(e){return e.title||(e.description?e.description.split(" ").slice(0,3).join(" ")+"...":"Untitled")}function be(e,t){let n=e;for(const e in t){const r=`{${e}}`;n=n.replace(r,t[e])}return n}class ve extends Error{constructor(e,t=null,n=null,r={}){super(e),this.name="LLMInvocationError",this.context=r,this.originalError=t,this.recommendedAction=n,Error.captureStackTrace(this,this.constructor)}}class _e extends Error{constructor({message:e,rootError:t=null,recommendedAction:n=null,context:r={},location:s="",type:a="Error",name:i="PrettyError"}){super(e),this.type=a,this.name=i,this.rootError=t,this.recommendedAction=n,this.context=r,this.location=s,Error.captureStackTrace(this,this.constructor),this.prettyMessage=this.createPrettyMessage()}createPrettyMessage(){let e=`${this.name}: ${this.message}\n`;return this.rootError&&this.rootError.message&&(e+=`Details: ${this.rootError.message}\n\n`),this.recommendedAction&&(e+=`Recommended Action: ${this.recommendedAction}\n`),e}}const ke=[{modelCode:"gpt-4o-mini",provider:"openai",inputPricePerMillionTokens:.15,outputPricePerMillionTokens:.6,features:"Most cost-efficient with vision capabilities"},{modelCode:"gpt-3.5-turbo",provider:"openai",inputPricePerMillionTokens:.5,outputPricePerMillionTokens:1.5,features:"Cost-effective option"},{modelCode:"gpt-3.5-turbo-0125",provider:"openai",inputPricePerMillionTokens:.5,outputPricePerMillionTokens:1.5,features:"Cost-effective option"},{modelCode:"gpt-4o",provider:"openai",inputPricePerMillionTokens:5,outputPricePerMillionTokens:15,features:"Enhanced multimodal capabilities"},{modelCode:"gpt-4-turbo",provider:"openai",inputPricePerMillionTokens:10,outputPricePerMillionTokens:30,features:"High speed and power"},{modelCode:"gpt-4",provider:"openai",inputPricePerMillionTokens:30,outputPricePerMillionTokens:60,features:"Latest generation AI"},{modelCode:"claude-3-5-sonnet-20240620",provider:"anthropic",inputPricePerMillionTokens:3,outputPricePerMillionTokens:15,features:"Highest level of intelligence and capability"},{modelCode:"claude-3-opus-20240229",provider:"anthropic",inputPricePerMillionTokens:15,outputPricePerMillionTokens:75,features:"Top-level performance, intelligence, fluency, and understanding"},{modelCode:"claude-3-sonnet-20240229",provider:"anthropic",inputPricePerMillionTokens:3,outputPricePerMillionTokens:15,features:"Strong utility, balanced for scaled deployments"},{modelCode:"claude-3-haiku-20240307",provider:"anthropic",inputPricePerMillionTokens:.25,outputPricePerMillionTokens:1.25,features:"Quick and accurate targeted performance"},{modelCode:"gemini-1.5-flash",provider:"google",inputPricePerMillionTokens:.35,outputPricePerMillionTokens:1.05,features:"Fast multimodal model with 1 million token context window"},{modelCode:"gemini-1.5-pro",provider:"google",inputPricePerMillionTokens:3.5,outputPricePerMillionTokens:10.5,features:"Next-generation model with 2 million token context window"},{modelCode:"gemini-1.0-pro",provider:"google",inputPricePerMillionTokens:.5,outputPricePerMillionTokens:1.5,features:"First-generation model, only text and image reasoning"},{modelCode:"open-mistral-nemo-2407",provider:"mistral",inputPricePerMillionTokens:.3,outputPricePerMillionTokens:.3,features:"Mistral Nemo is a state-of-the-art 12B model developed with NVIDIA"},{modelCode:"mistral-large-2407",provider:"mistral",inputPricePerMillionTokens:3,outputPricePerMillionTokens:9,features:"Top-tier reasoning for high-complexity tasks, for your most sophisticated needs"},{modelCode:"codestral-2405",provider:"mistral",inputPricePerMillionTokens:1,outputPricePerMillionTokens:3,features:"State-of-the-art Mistral model trained specifically for code tasks"}];function Ee(e,t){const n=ke.find((t=>t.modelCode===e));if(!n)return{costInputTokens:-1,costOutputTokens:-1,totalCost:-1};const r=t.inputTokens/1e6*n.inputPricePerMillionTokens,s=t.outputTokens/1e6*n.outputPricePerMillionTokens,a=r+s;return{costInputTokens:parseFloat(r.toFixed(4)),costOutputTokens:parseFloat(s.toFixed(4)),totalCost:parseFloat(a.toFixed(4))}}const Oe=(e,t)=>({tasksInitialized:!1,getTaskStats(e){const n=Date.now(),r=t().workflowLogs.slice().reverse().find((t=>t.task&&t.task.id===e.id&&"TaskStatusUpdate"===t.logType&&t.taskStatus===Q)),s=r?r.timestamp:n,a=(n-s)/1e3;let i={inputTokens:0,outputTokens:0,callsCount:0,callsErrorCount:0,parsingErrors:0},o=0;return t().workflowLogs.forEach((t=>{t.task&&t.task.id===e.id&&t.timestamp>=s&&"AgentStatusUpdate"===t.logType&&(t.agentStatus===$&&(i.inputTokens+=t.metadata.output.llmUsageStats.inputTokens,i.outputTokens+=t.metadata.output.llmUsageStats.outputTokens,i.callsCount+=1),t.agentStatus===j&&(i.callsErrorCount+=1),t.agentStatus===K&&(i.parsingErrors+=1),t.agentStatus===Z&&(o+=1))})),{startTime:s,endTime:n,duration:a,llmUsageStats:i,iterationCount:o}},handleTaskCompleted:({agent:n,task:r,result:s})=>{const a=t().getTaskStats(r,t);r.result=s;const i=(r.feedbackHistory||[]).map((e=>e.status===he?{...e,status:pe}:e));if(r.externalValidationRequired&&r.status!==se){r.status=re;const o=Ee(n.llmConfig.model,a.llmUsageStats),l=t().prepareNewLog({agent:n,task:r,logDescription:`Task awaiting validation: ${we(r)}. Awaiting validation.`,metadata:{...a,costDetails:o,result:s},logType:"TaskStatusUpdate"});e((e=>({tasks:e.tasks.map((e=>e.id===r.id?{...e,...a,status:re,result:s,feedbackHistory:i}:e)),workflowLogs:[...e.workflowLogs,l]}))),t().handleWorkflowBlocked({task:r,error:new Error("Task awaiting validation")})}else{r.status=ne;const o=Ee(n.llmConfig.model,a.llmUsageStats),l=t().prepareNewLog({agent:n,task:r,logDescription:`Task completed: ${we(r)}.`,metadata:{...a,costDetails:o,result:s},logType:"TaskStatusUpdate"});ge.debug(`Task completed with ID ${r.id}, Duration: ${a.duration} seconds`),e((e=>({...e,workflowLogs:[...e.workflowLogs,l],tasks:e.tasks.map((e=>e.id===r.id?{...e,...a,status:ne,result:s,feedbackHistory:i}:e))})));const c=t().tasks.every((e=>e.status===ne));c&&t().finishWorkflowAction()}},handleTaskError:({task:n,error:r})=>{const s=t().getTaskStats(n,t);n.status=ee;const a=Ee(n.agent.llmConfig.model,s.llmUsageStats),i=n.feedbackHistory.map((e=>e.status===he?{...e,status:pe}:e)),o=t().prepareNewLog({agent:n.agent,task:n,logDescription:`Task error: ${we(n)}, Error: ${r.message}`,metadata:{...s,costDetails:a,error:r.message},logType:"TaskStatusUpdate"});e((e=>({tasks:e.tasks.map((e=>e.id===n.id?{...e,...s,status:ee,error:r.message,feedbackHistory:i}:e)),workflowLogs:[...e.workflowLogs,o]})));const l=new _e({message:"Task Error Encountered",recommendedAction:"Try to debug the application to find the root cause of the error.",rootError:r,context:{task:n,error:r},location:"taskStore.js -> handleTaskError()"});ge.error(l.prettyMessage)},handleTaskBlocked:({task:n,error:r})=>{const s=t().getTaskStats(n,t);n.status=ee;const a=Ee(n.agent.llmConfig.model,s.llmUsageStats),i=n.feedbackHistory.map((e=>e.status===he?{...e,status:pe}:e)),o=t().prepareNewLog({agent:n.agent,task:n,logDescription:`Task blocked: ${we(n)}, Reason: ${r.message}`,metadata:{...s,costDetails:a,error:r},logType:"TaskStatusUpdate"}),l=new _e({name:"TASK BLOCKED",message:"Task blocked due to a possible error during execution.",recommendedAction:'Enable logLevel: "debug" during team initialization to obtain more detailed logs and facilitate troubleshooting.',rootError:r,context:{task:n,error:r}});ge.warn(l.prettyMessage),ge.debug(l.context),e((e=>({tasks:e.tasks.map((e=>e.id===n.id?{...e,...s,status:ee,feedbackHistory:i}:e)),workflowLogs:[...e.workflowLogs,o]}))),t().handleWorkflowBlocked({task:n,error:r})}});var Te={exports:{}},Se=Te.exports;Object.defineProperty(Se,"__esModule",{value:!0});const{round:Ae,floor:Ie,max:xe}=Math,Pe=e=>{let[,t]=/([a-f\d]{3,6})/i.exec(e)||[],n=t?t.length:0;if(3===n)t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2];else if(6!==n)return[0,0,0];let r=parseInt(t,16);return[r>>16&255,r>>8&255,255&r]},Ce=(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Ae((e-8)/247*24)+232:16+36*Ae(e/51)+6*Ae(t/51)+Ae(n/51),Ne=e=>{let t,n,r,s,a,i;return e<8?30+e:e<16?e-8+90:(e>=232?t=n=r=(10*(e-232)+8)/255:(i=(e-=16)%36,t=Ie(e/36)/5,n=Ie(i/6)/5,r=i%6/5),s=2*xe(t,n,r),0===s?30:(a=30+(Ae(r)<<2|Ae(n)<<1|Ae(t)),2===s?a+60:a))},Re=(e,t,n)=>Ne(Ce(e,t,n)),$e=(()=>{const e=e=>!!o.find((t=>e.test(t))),t=globalThis,n=t.Deno,r=null!=n,s=t.process||n||{},a=s.stdout,i="win32"===(r?n.build.os:s.platform),o=s.argv||s.args||[];let l=s.env||{},c=-1;if(r)try{l=l.toObject()}catch(e){c=0}const u="FORCE_COLOR",d=l[u],h=parseInt(d),p="false"===d?0:isNaN(h)?3:h,f="NO_COLOR"in l||0===p||e(/^-{1,2}(no-color|color=(false|never))$/),m=u in l&&p||e(/^-{1,2}color=?(true|always)?$/),g=(l.NEXT_RUNTIME||"").indexOf("edge")>-1||"PM2_HOME"in l&&"pm_id"in l||(r?n.isatty(1):a&&"isTTY"in a);return f?0:(c<0&&(c=((e,t,n)=>{const{TERM:r,COLORTERM:s}=e;return"TF_BUILD"in e?1:"TEAMCITY_VERSION"in e?2:"CI"in e?["GITHUB_ACTIONS","GITEA_ACTIONS"].some((t=>t in e))?3:1:!t||/-mono|dumb/i.test(r)?0:n||"truecolor"===s||"24bit"===s||"xterm-kitty"===r?3:/-256(colou?r)?$/i.test(r)?2:/^screen|^tmux|^xterm|^vt[1-5][0-9]([0-9])?|^ansi|color|cygwin|linux|mintty|rxvt/i.test(r)?1:3})(l,g,i)),m&&0===c?3:c)})(),je=$e>0,Le={open:"",close:""},Me=je?(e,t)=>({open:`[${e}m`,close:`[${t}m`}):()=>Le,De=39,Ue=49,Fe=e=>(t,n,r)=>e(Ce(t,n,r)),Be=e=>t=>{let[n,r,s]=Pe(t);return e(n,r,s)};let qe=e=>Me(`38;5;${e}`,De),He=e=>Me(`48;5;${e}`,Ue),ze=(e,t,n)=>Me(`38;2;${e};${t};${n}`,De),We=(e,t,n)=>Me(`48;2;${e};${t};${n}`,Ue);1===$e?(qe=e=>Me(Ne(e),De),He=e=>Me(Ne(e)+10,Ue),ze=(e,t,n)=>Me(Re(e,t,n),De),We=(e,t,n)=>Me(Re(e,t,n)+10,Ue)):2===$e&&(ze=Fe(qe),We=Fe(He));let Ke,Ve,Ge={ansi256:qe,bgAnsi256:He,fg:qe,bg:He,rgb:ze,bgRgb:We,hex:Be(ze),bgHex:Be(We),visible:Le,reset:Me(0,0),inverse:Me(7,27),hidden:Me(8,28),bold:Me(1,22),dim:Me(2,22),italic:Me(3,23),underline:Me(4,24),strikethrough:Me(9,29),strike:Me(9,29),grey:Me(90,De),gray:Me(90,De),bgGrey:Me(100,Ue),bgGray:Me(100,Ue)},Ze=["black","red","green","yellow","blue","magenta","cyan","white"],Je="Bright",Xe=30;for(Ke of Ze)Ve="bg"+Ke[0].toUpperCase()+Ke.slice(1),Ge[Ke]=Me(Xe,De),Ge[Ke+Je]=Me(Xe+60,De),Ge[Ve]=Me(Xe+10,Ue),Ge[Ve+Je]=Me(Xe+70,Ue),Xe++;const{defineProperty:Ye,defineProperties:Qe,setPrototypeOf:et}=Object,tt=/[Â›][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,nt=/(\r?\n)/g,rt={},st=({_p:e},{open:t,close:n})=>{const r=(e,...t)=>{if(!e)return"";let n=r._p,{_a:s,_b:a}=n,i=null!=e.raw?String.raw(e,...t):""+e;if(i.includes(""))for(;null!=n;){let e=n.close,t=e.length;if(t){let r,s=0,a="";for(;~(r=i.indexOf(e,s));)a+=i.slice(s,r)+n.open,s=r+t;s&&(i=a+i.slice(s))}n=n._p}return i.includes("\n")&&(i=i.replace(nt,a+"$1"+s)),s+i+a};let s=t,a=n;return null!=e&&(s=e._a+t,a=n+e._b),et(r,it),r._p={open:t,close:n,_a:s,_b:a,_p:e},r.open=s,r.close=a,r},at=function(){const e=e=>""+e;return e.isSupported=()=>je,e.strip=e=>e.replace(tt,""),e.extend=t=>{for(let e in t){let n=t[e],r=typeof n,s="string"===r?ze(...Pe(n)):n;rt[e]="function"===r?{get(){return(...e)=>st(this,n(...e))}}:{get(){let t=st(this,s);return Ye(this,e,{value:t}),t}}}it=Qe({},rt),et(e,it)},e.extend(Ge),e};let it;const ot=new at;Te.exports=ot,Te.exports.Ansis=at;var lt=o(Te.exports);function ct({status:e,message:t}){ge.info(`[Workflow Status: ${e}] ${t}`)}const ut=e=>{e.subscribe((e=>e.workflowLogs),((e,t)=>{if(e.length>t.length){const t=e[e.length-1];if("WorkflowStatusUpdate"===t.logType)switch(t.workflowStatus){case ae:ct({status:"Initial",message:"Workflow is being initialized."});break;case ie:ct({status:"Running",message:"Workflow is actively processing tasks."});break;case oe:ct({status:"Stopping",message:"Workflow is stopping."});break;case le:ct({status:"Stopped",message:"Workflow has been stopped."});break;case ce:ct({status:"Errored",message:"Workflow encountered an error."});break;case ue:ct({status:"Finished",message:"Workflow has successfully completed all tasks."}),function({metadata:e}){const{result:t,duration:n,llmUsageStats:r,iterationCount:s,costDetails:a,teamName:i,taskCount:o,agentCount:l}=e;ge.info(`Workflow Result: ${t}`);const c=[lt.black("\n+-----------------------------------------+"),lt.bold(`| WORKFLOW - ${lt.green("FINISH")}                       |`),"|-----------------------------------------|",lt.bold("| Summary:"),"|",lt.black("| Team: ")+lt.cyan(i),lt.black("| Tasks: ")+lt.cyan(o),lt.black("| Agents: ")+lt.cyan(l),"|",lt.black("| Iterations: ")+lt.yellow(s),lt.black("| Duration: ")+lt.yellow(n)+lt.yellow(" seconds"),lt.black("| Input Tokens: ")+lt.yellow(r.inputTokens),lt.black("| Output Tokens: ")+lt.yellow(r.outputTokens),"|",lt.black("| Cost Input Tokens: ")+lt.cyan(`$${a.costInputTokens}`),lt.black("| Cost Output Tokens: ")+lt.cyan(`$${a.costOutputTokens}`),lt.black("| Total Cost: ")+lt.cyan(`$${a.totalCost}`),"|",lt.black("| Calls Count: ")+lt.red(r.callsCount),lt.black("| Calls Error Count: ")+lt.red(r.callsErrorCount),lt.black("| Parsing Errors: ")+lt.red(r.parsingErrors),lt.black("+-----------------------------------------+\n")].join("\n");ge.info(c)}({...t});break;case de:ct({status:"Blocked",message:"Workflow is blocked due to one or more blocked tasks."});break;default:console.warn(`Encountered an unexpected workflow status: ${t.workflowStatus}`)}}}))},dt=e=>{e.subscribe((e=>e.workflowLogs),((t,n)=>{if(t.length>n.length){const n=t[t.length-1];if("TaskStatusUpdate"===n.logType){const t=e.getState().tasks.length,r=e.getState().tasks.findIndex((e=>e.id===n.task.id)),s=r+1;switch(n.task.status){case ne:!function({iterationCount:e,duration:t,llmUsageStats:n,agentName:r,agentModel:s,taskTitle:a,currentTaskNumber:i,totalTasks:o,costDetails:l}){const c=[lt.black("\n+-----------------------------------------+"),lt.bold(`| Task (${i}/${o}) - status changed to ${lt.green("DONE")}     |`),"|-----------------------------------------|",lt.bold("| Summary:"),"|",lt.black("| Task: ")+lt.cyan(a),lt.black("| Agent: ")+lt.cyan(r),lt.black("| Model: ")+lt.cyan(s),"|",lt.black("| Iterations: ")+lt.cyan(e),lt.black("| Duration: ")+lt.cyan(t)+lt.cyan(" seconds"),lt.black("| Input Tokens: ")+lt.yellow(n.inputTokens),lt.black("| Output Tokens: ")+lt.yellow(n.outputTokens),"|",lt.black("| Cost Input Tokens: ")+lt.cyan(`$${l.costInputTokens}`),lt.black("| Cost Output Tokens: ")+lt.cyan(`$${l.costOutputTokens}`),lt.black("| Total Cost: ")+lt.cyan(`$${l.totalCost}`),"|",lt.black("| Calls Count: ")+lt.green(n.callsCount),lt.black("| Calls Error Count: ")+lt.green(n.callsErrorCount),lt.black("| Parsing Errors: ")+lt.green(n.parsingErrors),lt.black("+-----------------------------------------+\n\n")].join("\n");ge.info(c)}({task:n.task,llmUsageStats:n.metadata.llmUsageStats,iterationCount:n.metadata.iterationCount,duration:n.metadata.duration,agentName:n.agent.name,agentModel:n.agent.llmConfig.model,taskTitle:we(n.task),currentTaskNumber:s,costDetails:n.metadata.costDetails,totalTasks:t});break;case Q:case ee:case te:case re:case se:case Y:!function({currentTaskNumber:e,totalTasks:t,taskTitle:n,taskStatus:r,agentName:s}){ge.info(lt.bold.black("||===========================================||")),ge.info(lt.bold.black(`|| Task (${e}/${t}) - status changed to ${"DONE"===r?lt.green(r):lt.yellow(r)}`)),ge.info(lt.bold.black(`|| Title: ${n}`)),ge.info(lt.bold.black(`|| Agent: ${s}`)),ge.info(lt.bold.black("||===========================================||\n\n"))}({currentTaskNumber:s,totalTasks:t,taskTitle:we(n.task),taskStatus:n.task.status,agentName:n.agent.name});break;default:console.warn(`Encountered an unexpected task status: ${n.task.status}`)}}}}))};var ht={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,i){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||i(this,a);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[a]=1===c.length?c[0]:c:i(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(ht);var pt=o(ht.exports);let ft=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},mt=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const gt=e=>void 0===globalThis.DOMException?new mt(e):new DOMException(e),yt=e=>{const t=void 0===e.reason?gt("This operation was aborted."):e.reason;return t instanceof Error?t:gt(t)};let wt=class{#e=[];enqueue(e,t){const n={priority:(t={priority:0,...t}).priority,run:e};if(this.size&&this.#e[this.size-1].priority>=t.priority)return void this.#e.push(n);const r=function(e,t,n){let r=0,s=e.length;for(;s>0;){const a=Math.trunc(s/2);let i=r+a;n(e[i],t)<=0?(r=++i,s-=a+1):s=a}return r}(this.#e,n,((e,t)=>t.priority-e.priority));this.#e.splice(r,0,n)}dequeue(){const e=this.#e.shift();return e?.run}filter(e){return this.#e.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this.#e.length}},bt=class extends pt{#t;#n;#r=0;#s;#a;#i=0;#o;#l;#e;#c;#u=0;#d;#h;#p;timeout;constructor(e){if(super(),!("number"==typeof(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:wt,...e}).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#t=e.carryoverConcurrencyCount,this.#n=e.intervalCap===Number.POSITIVE_INFINITY||0===e.interval,this.#s=e.intervalCap,this.#a=e.interval,this.#e=new e.queueClass,this.#c=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#p=!0===e.throwOnTimeout,this.#h=!1===e.autoStart}get#f(){return this.#n||this.#r<this.#s}get#m(){return this.#u<this.#d}#g(){this.#u--,this.#y(),this.emit("next")}#w(){this.#b(),this.#v(),this.#l=void 0}get#_(){const e=Date.now();if(void 0===this.#o){const t=this.#i-e;if(!(t<0))return void 0===this.#l&&(this.#l=setTimeout((()=>{this.#w()}),t)),!0;this.#r=this.#t?this.#u:0}return!1}#y(){if(0===this.#e.size)return this.#o&&clearInterval(this.#o),this.#o=void 0,this.emit("empty"),0===this.#u&&this.emit("idle"),!1;if(!this.#h){const e=!this.#_;if(this.#f&&this.#m){const t=this.#e.dequeue();return!!t&&(this.emit("active"),t(),e&&this.#v(),!0)}}return!1}#v(){this.#n||void 0!==this.#o||(this.#o=setInterval((()=>{this.#b()}),this.#a),this.#i=Date.now()+this.#a)}#b(){0===this.#r&&0===this.#u&&this.#o&&(clearInterval(this.#o),this.#o=void 0),this.#r=this.#t?this.#u:0,this.#k()}#k(){for(;this.#y(););}get concurrency(){return this.#d}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#d=e,this.#k()}async#E(e){return new Promise(((t,n)=>{e.addEventListener("abort",(()=>{n(e.reason)}),{once:!0})}))}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:this.#p,...t},new Promise(((n,r)=>{this.#e.enqueue((async()=>{this.#u++,this.#r++;try{t.signal?.throwIfAborted();let r=e({signal:t.signal});t.timeout&&(r=function(e,t){const{milliseconds:n,fallback:r,message:s,customTimers:a={setTimeout:setTimeout,clearTimeout:clearTimeout}}=t;let i;const o=new Promise(((o,l)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(t.signal){const{signal:n}=t;n.aborted&&l(yt(n));const r=()=>{l(yt(n))};n.addEventListener("abort",r,{once:!0}),e.finally((()=>{n.removeEventListener("abort",r)}))}if(n===Number.POSITIVE_INFINITY)return void e.then(o,l);const c=new ft;i=a.setTimeout.call(void 0,(()=>{if(r)try{o(r())}catch(e){l(e)}else"function"==typeof e.cancel&&e.cancel(),!1===s?o():s instanceof Error?l(s):(c.message=s??`Promise timed out after ${n} milliseconds`,l(c))}),n),(async()=>{try{o(await e)}catch(e){l(e)}})()})),l=o.finally((()=>{l.clear()}));return l.clear=()=>{a.clearTimeout.call(void 0,i),i=void 0},l}(Promise.resolve(r),{milliseconds:t.timeout})),t.signal&&(r=Promise.race([r,this.#E(t.signal)]));const s=await r;n(s),this.emit("completed",s)}catch(e){if(e instanceof ft&&!t.throwOnTimeout)return void n();r(e),this.emit("error",e)}finally{this.#g()}}),t),this.emit("add"),this.#y()}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this.#h?(this.#h=!1,this.#k(),this):this}pause(){this.#h=!0}clear(){this.#e=new this.#c}async onEmpty(){0!==this.#e.size&&await this.#O("empty")}async onSizeLessThan(e){this.#e.size<e||await this.#O("next",(()=>this.#e.size<e))}async onIdle(){0===this.#u&&0===this.#e.size||await this.#O("idle")}async#O(e,t){return new Promise((n=>{const r=()=>{t&&!t()||(this.off(e,r),n())};this.on(e,r)}))}get size(){return this.#e.size}sizeBy(e){return this.#e.filter(e).length}get pending(){return this.#u}get isPaused(){return this.#h}};const vt=e=>{const t=new bt({concurrency:1});e.subscribe((e=>e.tasks.filter((e=>e.status===Q))),((n,r)=>{n.forEach((n=>{r.find((e=>e.id===n.id))||t.add((()=>e.getState().workOnTask(n.agent,n))).catch((t=>{e.getState().handleTaskError({task:n,error:t}),e.getState().handleWorkflowError(n,t)}))}))}));e.subscribe((e=>e.tasks.filter((e=>e.status===te))),((t,n)=>{const r=e.getState().tasks;t.forEach((t=>{if(!n.find((e=>e.id===t.id))){const n=r.findIndex((e=>e.id===t.id));s=t.agent,r.some((e=>e.agent.id===s.id&&e.status===Q))||e.getState().updateTaskStatus(t.id,Q);for(let t=n+1;t<r.length;t++)e.getState().updateTaskStatus(r[t].id,Y)}var s}))})),e.subscribe((e=>e.tasks.filter((e=>"DONE"===e.status))),((t,n)=>{if(t.length>n.length){const t=e.getState().tasks.find((e=>e.status===Y));t&&e.getState().updateTaskStatus(t.id,Q)}}))};class _t{#T=[];async push(e){e=await e,this.#T.push(e)}clear(){this.#T=[]}values(){return this.#T}}class kt{appID="";clientUser="";salt="";target="https://nom.telemetrydeck.com/v2/";testMode=!1;constructor(e={}){const{target:t,appID:n,clientUser:r,sessionID:s,salt:a,testMode:i,store:o,subtleCrypto:l}=e;if(!n)throw new Error("appID is required");this.store=o??new _t,this.target=t??this.target,this.appID=n,this.clientUser=r,this.sessionID=s??(0|9e6*Math.random()).toString(36),this.salt=a??this.salt,this.testMode=i??this.testMode,this.subtleCrypto=l}async signal(e,t,n){const r=await this._build(e,t,n);return this._post([r])}async queue(e,t,n){const r=(new Date).toISOString(),s=this._build(e,t,n,r);return this.store.push(s)}async flush(){const e=this._post(this.store.values());return this.store.clear(),e}_clientUserAndSalt="";_clientUserHashed="";async _hashedClientUser(e,t){return e+t!==this._clientUserAndSalt&&(this._clientUserHashed=await async function(e,t=globalThis?.crypto?.subtle){const n=(new TextEncoder).encode(e),r=await t.digest("SHA-256",n),s=[...new Uint8Array(r)].map((e=>e.toString(16).padStart(2,"0"))).join("");return s}([e,t].join(""),this.subtleCrypto),this._clientUserAndSalt=e+t),this._clientUserHashed}async _build(e,t,n,r){const{appID:s,testMode:a}=this;let{clientUser:i,salt:o,sessionID:l}=this;if(i=(n=n??{}).clientUser??i,o=n.salt??o,l=n.sessionID??l,!e)throw new Error('TelemetryDeck: "type" is not set');if(!s)throw new Error('TelemetryDeck: "appID" is not set');if(!i)throw new Error('TelemetryDeck: "clientUser" is not set');i=await this._hashedClientUser(i,o);const c={clientUser:i,sessionID:l,appID:s,type:e,telemetryClientVersion:"JavaScriptSDK 2.0.4"};return r&&(c.receivedAt=r),a&&(c.isTestMode=!0),this._appendPayload(c,t)}_appendPayload(e,t){if(!t||"object"!=typeof t||0===Object.keys(t).length)return e;e.payload={};for(const[n,r]of Object.entries(t??{}))"floatValue"===n?e.payload[n]=Number.parseFloat(r):r instanceof Date?e.payload[n]=r.toISOString():e.payload[n]="string"==typeof r?r:"object"==typeof r?JSON.stringify(r):`${r}`;return e}_post(e){const{target:t}=this;return fetch(t,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}let Et=null;const Ot=t(),Tt={signal:()=>{}};function St(){if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)return window.crypto.subtle;if("undefined"!=typeof global&&global.crypto&&global.crypto.subtle)return global.crypto.subtle;try{const e=require("crypto");if(e.webcrypto&&e.webcrypto.subtle)return e.webcrypto.subtle}catch{}return console.warn("SubtleCrypto is not available. TelemetryDeck might not function correctly."),null}const At=function(e="15E9347E-9EE5-4971-A8FB-61D91F3EBA12",t=Ot){return("undefined"!=typeof process&&process.env?process.env.KAIBAN_TELEMETRY_OPT_OUT:"undefined"!=typeof window&&window.KAIBAN_TELEMETRY_OPT_OUT)?Et=Tt:Et||(Et=new kt({appID:e,clientUser:t,subtleCrypto:St()})),Et}(),It=(e={})=>{var t;e.logLevel&&(t=e.logLevel,ge.setLevel(ge.levels[t.toUpperCase()]));const n=(r=x(C(((t,r)=>({...ye(t,r),...Oe(t,r),teamWorkflowStatus:e.teamWorkflowStatus||ae,workflowResult:e.workflowResult||null,name:e.name||"",agents:e.agents||[],tasks:e.tasks||[],workflowLogs:e.workflowLogs||[],inputs:e.inputs||{},workflowContext:e.workflowContext||"",env:e.env||{},logLevel:e.logLevel,setInputs:e=>t({inputs:e}),setName:e=>t({name:e}),setEnv:e=>t({env:e}),addAgents:e=>{const{env:s}=r();e.forEach((e=>{e.initialize(n,s)})),t((t=>({agents:[...t.agents,...e]})))},addTasks:e=>{e.forEach((e=>e.setStore(n))),t((t=>({tasks:[...t.tasks,...e.map((e=>({...e,agent:e.agent})))]})))},updateTaskStatus:(e,n)=>t((t=>({tasks:t.tasks.map((t=>t.id===e?{...t,status:n}:t))}))),startWorkflow:async e=>{ge.info(`ðŸš€ Team *${r().name}* is starting to work.`),At.signal("workflow_started"),r().resetWorkflowStateAction(),e&&r().setInputs(e);const n={task:null,agent:null,timestamp:Date.now(),logDescription:`Workflow initiated for team *${r().name}*.`,workflowStatus:ie,metadata:{message:"Workflow has been initialized with input settings.",inputs:e},logType:"WorkflowStatusUpdate"};t((e=>({...e,workflowLogs:[...e.workflowLogs,n],teamWorkflowStatus:ie})));const s=r().tasks;s.length>0&&s[0].status===Y&&r().updateTaskStatus(s[0].id,Q)},resetWorkflowStateAction:()=>{t((e=>{const t=e.tasks.map((e=>({...e,status:"TODO"})));r().agents.forEach((e=>{e.setStatus("INITIAL")}));const n=[...e.agents];return{...e,tasks:t,agents:n,workflowLogs:[],workflowContext:"",workflowResult:null,teamWorkflowStatus:ae}})),ge.debug("Workflow state has been reset.")},finishWorkflowAction:()=>{const e=r().getWorkflowStats(),n=r().tasks,s=n.slice().reverse().find((e=>e.isDeliverable)),a=n[n.length-1].result;ge.debug("Workflow Result:",s?s.result:a);const i={task:null,agent:null,timestamp:Date.now(),logDescription:`Workflow finished with result: ${s?s.result:a}`,workflowStatus:ue,metadata:{result:s?s.result:a,...e},logType:"WorkflowStatusUpdate"};t((e=>({...e,workflowResult:s?s.result:a,teamWorkflowStatus:ue,workflowLogs:[...e.workflowLogs,i]})))},setTeamWorkflowStatus:e=>t({teamWorkflowStatus:e}),handleWorkflowError:(e,n)=>{ge.error("Workflow Error:",n.message);const s=r().getWorkflowStats(),a={task:e,agent:e.agent,timestamp:Date.now(),logDescription:`Workflow error encountered: ${n.message}`,workflowStatus:ce,metadata:{error:n,...s},logType:"WorkflowStatusUpdate"};t((e=>({...e,teamWorkflowStatus:ce,workflowLogs:[...e.workflowLogs,a]})))},handleWorkflowBlocked:({task:e,error:n})=>{ge.warn("WORKFLOW BLOCKED:",n.message);const s=r().getWorkflowStats(),a={task:e,agent:e.agent,timestamp:Date.now(),logDescription:`Workflow blocked: ${n.message}`,workflowStatus:de,metadata:{error:n.message,...s,teamName:r().name,taskCount:r().tasks.length,agentCount:r().agents.length},logType:"WorkflowStatusUpdate"};t((e=>({...e,teamWorkflowStatus:de,workflowLogs:[...e.workflowLogs,a]})))},workOnTask:async(e,n)=>{if(n&&e){ge.debug(`Task: ${we(n)} starting...`),n.status=Q,t((t=>{const s=r().prepareNewLog({agent:e,task:n,logDescription:`Task: ${we(n)} started.`,metadata:{},logType:"TaskStatusUpdate"});return{...t,workflowLogs:[...t.workflowLogs,s]}})),n.inputs=r().inputs;const s=be(n.description,r().inputs);n.interpolatedTaskDescription=s;const a=n.feedbackHistory.filter((e=>e.status===he)),i=r().deriveContextFromLogs(r().workflowLogs,n.id);a.length>0?await e.workOnFeedback(n,n.feedbackHistory,i):await e.workOnTask(n,r().inputs,i)}},deriveContextFromLogs:(e,t)=>{const n=new Map,s=r().tasks,a=s.findIndex((e=>e.id===t));if(-1===a)return console.warn(`Current task with ID ${t} not found in the task list.`),"";for(const t of e)if("TaskStatusUpdate"===t.logType&&t.taskStatus===ne){const e=s.findIndex((e=>e.id===t.task.id));-1!==e&&e<a&&n.set(t.task.id,{taskDescription:t.task.description,result:t.metadata.result,index:e})}return Array.from(n.values()).sort(((e,t)=>e.index-t.index)).map((({taskDescription:e,result:t})=>`Task: ${e}\nResult: ${t}\n`)).join("\n")},provideFeedback:async(e,n)=>{const{tasks:s}=r(),a=s.findIndex((t=>t.id===e));if(-1===a)return void ge.error("Task not found");const i=s[a],o={content:n,status:he,timestamp:Date.now()},l={task:i,agent:i.agent,timestamp:Date.now(),logDescription:"Workflow running again due to feedback on task.",workflowStatus:ie,metadata:{feedback:o},logType:"WorkflowStatusUpdate"},c={...i,feedbackHistory:[...i.feedbackHistory||[],o],status:te},u=r().prepareNewLog({agent:c.agent,task:c,logDescription:`Task with feedback: ${we(c)}.`,metadata:{feedback:o},logType:"TaskStatusUpdate"});t((t=>({...t,teamWorkflowStatus:ie,workflowLogs:[...t.workflowLogs,l,u],tasks:t.tasks.map((t=>t.id===e?c:t))})))},validateTask:async e=>{const n=r().tasks.find((t=>t.id===e));if(!n)return ge.error("Task not found"),null;if(n.status!==re)return ge.error("Task is not awaiting validation"),null;const s={...n,status:se},a={task:s,agent:s.agent,timestamp:Date.now(),logDescription:"Workflow running cause a task was validated.",workflowStatus:ie,metadata:{},logType:"WorkflowStatusUpdate"},i=r().prepareNewLog({agent:s.agent,task:s,metadata:{},logDescription:`Task validated: ${we(s)}.`,logType:"TaskStatusUpdate"});t((t=>({...t,tasks:t.tasks.map((t=>t.id===e?s:t)),workflowLogs:[...t.workflowLogs,a,i],teamWorkflowStatus:ie}))),r().handleTaskCompleted({agent:s.agent,task:s,result:s.result})},prepareNewLog:({agent:e,task:t,logDescription:n,metadata:r,logType:s})=>({timestamp:Date.now(),task:t,agent:e,agentName:e?e.name:"Unknown Agent",taskTitle:t?we(t):"Untitled Task",logDescription:n,taskStatus:t?t.status:"Unknown",agentStatus:e?e.status:"Unknown",metadata:r,logType:s}),clearAll:()=>t({agents:[],tasks:[],inputs:{},workflowLogs:[],workflowContext:"",workflowResult:null,teamWorkflowStatus:ae}),getWorkflowStats(){const e=Date.now(),t=r().workflowLogs,n=t.slice().reverse().find((e=>"WorkflowStatusUpdate"===e.logType&&"RUNNING"===e.workflowStatus)),s=n?n.timestamp:Date.now(),a=(e-s)/1e3;let i={},o={inputTokens:0,outputTokens:0,callsCount:0,callsErrorCount:0,parsingErrors:0},l=0;t.forEach((e=>{if("AgentStatusUpdate"===e.logType&&e.timestamp>=s)if(e.agentStatus===$){const t=e.agent.llmConfig.model;i[t]||(i[t]={inputTokens:0,outputTokens:0,callsCount:0}),i[t].inputTokens+=e.metadata.output.llmUsageStats.inputTokens,i[t].outputTokens+=e.metadata.output.llmUsageStats.outputTokens,i[t].callsCount+=1,o.inputTokens+=e.metadata.output.llmUsageStats.inputTokens,o.outputTokens+=e.metadata.output.llmUsageStats.outputTokens,o.callsCount+=1}else e.agentStatus===j?o.callsErrorCount+=1:e.agentStatus===K?o.parsingErrors+=1:e.agentStatus===Z&&(l+=1)}));const c=function(e){let t=0,n=0,r=0,s=!0;return Object.keys(e).forEach((a=>{const i=e[a],o=ke.find((e=>e.modelCode===a));if(!o)return ge.warn(`No pricing information found for model ${a}`),void(s=!1);const l=i.inputTokens/1e6*o.inputPricePerMillionTokens,c=i.outputTokens/1e6*o.outputPricePerMillionTokens;t+=l,n+=c,r+=l+c})),s?{costInputTokens:parseFloat(t.toFixed(4)),costOutputTokens:parseFloat(n.toFixed(4)),totalCost:parseFloat(r.toFixed(4))}:{costInputTokens:-1,costOutputTokens:-1,totalCost:-1}}(i);return{startTime:s,endTime:e,duration:a,llmUsageStats:o,iterationCount:l,costDetails:c,taskCount:r().tasks.length,agentCount:r().agents.length,teamName:r().name}},getCleanedState(){const e=e=>({...e,id:"[REDACTED]",env:"[REDACTED]",llmConfig:e.llmConfig?{...e.llmConfig,apiKey:"[REDACTED]"}:{},agentInstance:e.agentInstance?{...e.agentInstance,id:"[REDACTED]",env:"[REDACTED]",llmConfig:e.agentInstance.llmConfig?{...e.agentInstance.llmConfig,apiKey:"[REDACTED]"}:{}}:{}}),t=t=>({...t,id:"[REDACTED]",agent:t.agent?e(t.agent):null,duration:"[REDACTED]",endTime:"[REDACTED]",startTime:"[REDACTED]",feedbackHistory:t.feedbackHistory?t.feedbackHistory.map((e=>({...e,timestamp:"[REDACTED]"}))):[]}),n=r().agents.map((t=>e(t))),s=r().tasks.map((e=>t(e))),a=r().workflowLogs.map((n=>{return{...n,agent:n.agent?e(n.agent):null,task:n.task?t(n.task):null,timestamp:"[REDACTED]",metadata:n.metadata?(r=n.metadata,{...r,duration:"[REDACTED]",endTime:"[REDACTED]",startTime:"[REDACTED]",feedback:r.feedback?{...r.feedback,timestamp:"[REDACTED]"}:{}}):{}};var r}));return{teamWorkflowStatus:r().teamWorkflowStatus,workflowResult:r().workflowResult,name:r().name,agents:n,tasks:s,workflowLogs:a,inputs:r().inputs,workflowContext:r().workflowContext,logLevel:r().logLevel}}})))),r?S(r):S);var r;return vt(n),dt(n),ut(n),n},xt=Symbol("Let zodToJsonSchema decide on which parser to use"),Pt={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Ct=e=>{const t=(e=>({...Pt,...e}))(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}};function Nt(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function Rt(e,t,n,r,s){e[t]=n,Nt(e,t,r,s)}var $t,jt;!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}($t||($t={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(jt||(jt={}));const Lt=$t.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Mt=e=>{switch(typeof e){case"undefined":return Lt.undefined;case"string":return Lt.string;case"number":return isNaN(e)?Lt.nan:Lt.number;case"boolean":return Lt.boolean;case"function":return Lt.function;case"bigint":return Lt.bigint;case"symbol":return Lt.symbol;case"object":return Array.isArray(e)?Lt.array:null===e?Lt.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?Lt.promise:"undefined"!=typeof Map&&e instanceof Map?Lt.map:"undefined"!=typeof Set&&e instanceof Set?Lt.set:"undefined"!=typeof Date&&e instanceof Date?Lt.date:Lt.object;default:return Lt.unknown}},Dt=$t.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Ut extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(r);else if("invalid_return_type"===s.code)r(s.returnTypeError);else if("invalid_arguments"===s.code)r(s.argumentsError);else if(0===s.path.length)n._errors.push(t(s));else{let e=n,r=0;for(;r<s.path.length;){const n=s.path[r];r===s.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(s))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof Ut))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,$t.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Ut.create=e=>new Ut(e);const Ft=(e,t)=>{let n;switch(e.code){case Dt.invalid_type:n=e.received===Lt.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case Dt.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,$t.jsonStringifyReplacer)}`;break;case Dt.unrecognized_keys:n=`Unrecognized key(s) in object: ${$t.joinValues(e.keys,", ")}`;break;case Dt.invalid_union:n="Invalid input";break;case Dt.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${$t.joinValues(e.options)}`;break;case Dt.invalid_enum_value:n=`Invalid enum value. Expected ${$t.joinValues(e.options)}, received '${e.received}'`;break;case Dt.invalid_arguments:n="Invalid function arguments";break;case Dt.invalid_return_type:n="Invalid function return type";break;case Dt.invalid_date:n="Invalid date";break;case Dt.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:$t.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case Dt.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case Dt.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case Dt.custom:n="Invalid input";break;case Dt.invalid_intersection_types:n="Intersection results could not be merged";break;case Dt.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case Dt.not_finite:n="Number must be finite";break;default:n=t.defaultError,$t.assertNever(e)}return{message:n}};let Bt=Ft;function qt(){return Bt}const Ht=e=>{const{data:t,path:n,errorMaps:r,issueData:s}=e,a=[...n,...s.path||[]],i={...s,path:a};if(void 0!==s.message)return{...s,path:a,message:s.message};let o="";const l=r.filter((e=>!!e)).slice().reverse();for(const e of l)o=e(i,{data:t,defaultError:o}).message;return{...s,path:a,message:o}};function zt(e,t){const n=qt(),r=Ht({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===Ft?void 0:Ft].filter((e=>!!e))});e.common.issues.push(r)}class Wt{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return Kt;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return Wt.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:s}=r;if("aborted"===t.status)return Kt;if("aborted"===s.status)return Kt;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"===t.value||void 0===s.value&&!r.alwaysSet||(n[t.value]=s.value)}return{status:e.value,value:n}}}const Kt=Object.freeze({status:"aborted"}),Vt=e=>({status:"dirty",value:e}),Gt=e=>({status:"valid",value:e}),Zt=e=>"aborted"===e.status,Jt=e=>"dirty"===e.status,Xt=e=>"valid"===e.status,Yt=e=>"undefined"!=typeof Promise&&e instanceof Promise;function Qt(e,t,n,r){if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}function en(e,t,n,r,s){if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,n),n}var tn,nn,rn;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(tn||(tn={}));class sn{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const an=(e,t)=>{if(Xt(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Ut(e.common.issues);return this._error=t,this._error}}};function on(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:s}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');if(t)return{errorMap:t,description:s};return{errorMap:(t,s)=>{var a,i;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:s.defaultError}:void 0===s.data?{message:null!==(a=null!=o?o:r)&&void 0!==a?a:s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:null!==(i=null!=o?o:n)&&void 0!==i?i:s.defaultError}},description:s}}class ln{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return Mt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Mt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Wt,ctx:{common:e.parent.common,data:e.data,parsedType:Mt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(Yt(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Mt(e)},s=this._parseSync({data:e,path:r.path,parent:r});return an(r,s)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Mt(e)},r=this._parse({data:e,path:n.path,parent:n}),s=await(Yt(r)?r:Promise.resolve(r));return an(n,s)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const s=e(t),a=()=>r.addIssue({code:Dt.custom,...n(t)});return"undefined"!=typeof Promise&&s instanceof Promise?s.then((e=>!!e||(a(),!1))):!!s||(a(),!1)}))}refinement(e,t){return this._refinement(((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)))}_refinement(e){return new rr({schema:this,typeName:mr.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return sr.create(this,this._def)}nullable(){return ar.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Dn.create(this,this._def)}promise(){return nr.create(this,this._def)}or(e){return Bn.create([this,e],this._def)}and(e){return Wn.create(this,e,this._def)}transform(e){return new rr({...on(this._def),schema:this,typeName:mr.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new ir({...on(this._def),innerType:this,defaultValue:t,typeName:mr.ZodDefault})}brand(){return new ur({typeName:mr.ZodBranded,type:this,...on(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new or({...on(this._def),innerType:this,catchValue:t,typeName:mr.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return dr.create(this,e)}readonly(){return hr.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const cn=/^c[^\s-]{8,}$/i,un=/^[0-9a-z]+$/,dn=/^[0-9A-HJKMNP-TV-Z]{26}$/,hn=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,pn=/^[a-z0-9_-]{21}$/i,fn=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,mn=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let gn;const yn=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,wn=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,bn=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,vn="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",_n=new RegExp(`^${vn}$`);function kn(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function En(e){let t=`${vn}T${kn(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function On(e,t){return!("v4"!==t&&t||!yn.test(e))||!("v6"!==t&&t||!wn.test(e))}class Tn extends ln{_parse(e){this._def.coerce&&(e.data=String(e.data));if(this._getType(e)!==Lt.string){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.string,received:t.parsedType}),Kt}const t=new Wt;let n;for(const r of this._def.checks)if("min"===r.kind)e.data.length<r.value&&(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("max"===r.kind)e.data.length>r.value&&(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("length"===r.kind){const s=e.data.length>r.value,a=e.data.length<r.value;(s||a)&&(n=this._getOrReturnCtx(e,n),s?zt(n,{code:Dt.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}):a&&zt(n,{code:Dt.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}),t.dirty())}else if("email"===r.kind)mn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"email",code:Dt.invalid_string,message:r.message}),t.dirty());else if("emoji"===r.kind)gn||(gn=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),gn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"emoji",code:Dt.invalid_string,message:r.message}),t.dirty());else if("uuid"===r.kind)hn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"uuid",code:Dt.invalid_string,message:r.message}),t.dirty());else if("nanoid"===r.kind)pn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"nanoid",code:Dt.invalid_string,message:r.message}),t.dirty());else if("cuid"===r.kind)cn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"cuid",code:Dt.invalid_string,message:r.message}),t.dirty());else if("cuid2"===r.kind)un.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"cuid2",code:Dt.invalid_string,message:r.message}),t.dirty());else if("ulid"===r.kind)dn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"ulid",code:Dt.invalid_string,message:r.message}),t.dirty());else if("url"===r.kind)try{new URL(e.data)}catch(s){n=this._getOrReturnCtx(e,n),zt(n,{validation:"url",code:Dt.invalid_string,message:r.message}),t.dirty()}else if("regex"===r.kind){r.regex.lastIndex=0;r.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"regex",code:Dt.invalid_string,message:r.message}),t.dirty())}else if("trim"===r.kind)e.data=e.data.trim();else if("includes"===r.kind)e.data.includes(r.value,r.position)||(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.invalid_string,validation:{includes:r.value,position:r.position},message:r.message}),t.dirty());else if("toLowerCase"===r.kind)e.data=e.data.toLowerCase();else if("toUpperCase"===r.kind)e.data=e.data.toUpperCase();else if("startsWith"===r.kind)e.data.startsWith(r.value)||(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.invalid_string,validation:{startsWith:r.value},message:r.message}),t.dirty());else if("endsWith"===r.kind)e.data.endsWith(r.value)||(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.invalid_string,validation:{endsWith:r.value},message:r.message}),t.dirty());else if("datetime"===r.kind){En(r).test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.invalid_string,validation:"datetime",message:r.message}),t.dirty())}else if("date"===r.kind){_n.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.invalid_string,validation:"date",message:r.message}),t.dirty())}else if("time"===r.kind){new RegExp(`^${kn(r)}$`).test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.invalid_string,validation:"time",message:r.message}),t.dirty())}else"duration"===r.kind?fn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"duration",code:Dt.invalid_string,message:r.message}),t.dirty()):"ip"===r.kind?On(e.data,r.version)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"ip",code:Dt.invalid_string,message:r.message}),t.dirty()):"base64"===r.kind?bn.test(e.data)||(n=this._getOrReturnCtx(e,n),zt(n,{validation:"base64",code:Dt.invalid_string,message:r.message}),t.dirty()):$t.assertNever(r);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement((t=>e.test(t)),{validation:t,code:Dt.invalid_string,...tn.errToObj(n)})}_addCheck(e){return new Tn({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...tn.errToObj(e)})}url(e){return this._addCheck({kind:"url",...tn.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...tn.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...tn.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...tn.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...tn.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...tn.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...tn.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...tn.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...tn.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...tn.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...tn.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...tn.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...tn.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...tn.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...tn.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...tn.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...tn.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...tn.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...tn.errToObj(t)})}nonempty(e){return this.min(1,tn.errToObj(e))}trim(){return new Tn({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Tn({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Tn({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Sn(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,s=n>r?n:r;return parseInt(e.toFixed(s).replace(".",""))%parseInt(t.toFixed(s).replace(".",""))/Math.pow(10,s)}Tn.create=e=>{var t;return new Tn({checks:[],typeName:mr.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...on(e)})};class An extends ln{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){this._def.coerce&&(e.data=Number(e.data));if(this._getType(e)!==Lt.number){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.number,received:t.parsedType}),Kt}let t;const n=new Wt;for(const r of this._def.checks)if("int"===r.kind)$t.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty());else if("min"===r.kind){(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty())}else if("max"===r.kind){(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty())}else"multipleOf"===r.kind?0!==Sn(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.not_finite,message:r.message}),n.dirty()):$t.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,tn.toString(t))}gt(e,t){return this.setLimit("min",e,!1,tn.toString(t))}lte(e,t){return this.setLimit("max",e,!0,tn.toString(t))}lt(e,t){return this.setLimit("max",e,!1,tn.toString(t))}setLimit(e,t,n,r){return new An({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:tn.toString(r)}]})}_addCheck(e){return new An({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:tn.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:tn.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:tn.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:tn.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:tn.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:tn.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:tn.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:tn.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:tn.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&$t.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}An.create=e=>new An({checks:[],typeName:mr.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...on(e)});class In extends ln{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){this._def.coerce&&(e.data=BigInt(e.data));if(this._getType(e)!==Lt.bigint){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.bigint,received:t.parsedType}),Kt}let t;const n=new Wt;for(const r of this._def.checks)if("min"===r.kind){(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty())}else if("max"===r.kind){(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty())}else"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),zt(t,{code:Dt.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):$t.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,tn.toString(t))}gt(e,t){return this.setLimit("min",e,!1,tn.toString(t))}lte(e,t){return this.setLimit("max",e,!0,tn.toString(t))}lt(e,t){return this.setLimit("max",e,!1,tn.toString(t))}setLimit(e,t,n,r){return new In({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:tn.toString(r)}]})}_addCheck(e){return new In({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:tn.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:tn.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:tn.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:tn.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:tn.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}In.create=e=>{var t;return new In({checks:[],typeName:mr.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...on(e)})};class xn extends ln{_parse(e){this._def.coerce&&(e.data=Boolean(e.data));if(this._getType(e)!==Lt.boolean){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.boolean,received:t.parsedType}),Kt}return Gt(e.data)}}xn.create=e=>new xn({typeName:mr.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...on(e)});class Pn extends ln{_parse(e){this._def.coerce&&(e.data=new Date(e.data));if(this._getType(e)!==Lt.date){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.date,received:t.parsedType}),Kt}if(isNaN(e.data.getTime())){return zt(this._getOrReturnCtx(e),{code:Dt.invalid_date}),Kt}const t=new Wt;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),zt(n,{code:Dt.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):$t.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Pn({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:tn.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:tn.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Pn.create=e=>new Pn({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:mr.ZodDate,...on(e)});class Cn extends ln{_parse(e){if(this._getType(e)!==Lt.symbol){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.symbol,received:t.parsedType}),Kt}return Gt(e.data)}}Cn.create=e=>new Cn({typeName:mr.ZodSymbol,...on(e)});class Nn extends ln{_parse(e){if(this._getType(e)!==Lt.undefined){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.undefined,received:t.parsedType}),Kt}return Gt(e.data)}}Nn.create=e=>new Nn({typeName:mr.ZodUndefined,...on(e)});class Rn extends ln{_parse(e){if(this._getType(e)!==Lt.null){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.null,received:t.parsedType}),Kt}return Gt(e.data)}}Rn.create=e=>new Rn({typeName:mr.ZodNull,...on(e)});class $n extends ln{constructor(){super(...arguments),this._any=!0}_parse(e){return Gt(e.data)}}$n.create=e=>new $n({typeName:mr.ZodAny,...on(e)});class jn extends ln{constructor(){super(...arguments),this._unknown=!0}_parse(e){return Gt(e.data)}}jn.create=e=>new jn({typeName:mr.ZodUnknown,...on(e)});class Ln extends ln{_parse(e){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.never,received:t.parsedType}),Kt}}Ln.create=e=>new Ln({typeName:mr.ZodNever,...on(e)});class Mn extends ln{_parse(e){if(this._getType(e)!==Lt.undefined){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.void,received:t.parsedType}),Kt}return Gt(e.data)}}Mn.create=e=>new Mn({typeName:mr.ZodVoid,...on(e)});class Dn extends ln{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==Lt.array)return zt(t,{code:Dt.invalid_type,expected:Lt.array,received:t.parsedType}),Kt;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,s=t.data.length<r.exactLength.value;(e||s)&&(zt(t,{code:e?Dt.too_big:Dt.too_small,minimum:s?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(zt(t,{code:Dt.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(zt(t,{code:Dt.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map(((e,n)=>r.type._parseAsync(new sn(t,e,t.path,n))))).then((e=>Wt.mergeArray(n,e)));const s=[...t.data].map(((e,n)=>r.type._parseSync(new sn(t,e,t.path,n))));return Wt.mergeArray(n,s)}get element(){return this._def.type}min(e,t){return new Dn({...this._def,minLength:{value:e,message:tn.toString(t)}})}max(e,t){return new Dn({...this._def,maxLength:{value:e,message:tn.toString(t)}})}length(e,t){return new Dn({...this._def,exactLength:{value:e,message:tn.toString(t)}})}nonempty(e){return this.min(1,e)}}function Un(e){if(e instanceof Fn){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=sr.create(Un(r))}return new Fn({...e._def,shape:()=>t})}return e instanceof Dn?new Dn({...e._def,type:Un(e.element)}):e instanceof sr?sr.create(Un(e.unwrap())):e instanceof ar?ar.create(Un(e.unwrap())):e instanceof Kn?Kn.create(e.items.map((e=>Un(e)))):e}Dn.create=(e,t)=>new Dn({type:e,minLength:null,maxLength:null,exactLength:null,typeName:mr.ZodArray,...on(t)});class Fn extends ln{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=$t.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==Lt.object){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.object,received:t.parsedType}),Kt}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:s}=this._getCached(),a=[];if(!(this._def.catchall instanceof Ln&&"strip"===this._def.unknownKeys))for(const e in n.data)s.includes(e)||a.push(e);const i=[];for(const e of s){const t=r[e],s=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new sn(n,s,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof Ln){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of a)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)a.length>0&&(zt(n,{code:Dt.unrecognized_keys,keys:a}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of a){const r=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new sn(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of i){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>Wt.mergeObjectSync(t,e))):Wt.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return tn.errToObj,new Fn({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,s,a,i;const o=null!==(a=null===(s=(r=this._def).errorMap)||void 0===s?void 0:s.call(r,t,n).message)&&void 0!==a?a:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(i=tn.errToObj(e).message)&&void 0!==i?i:o}:{message:o}}}:{}})}strip(){return new Fn({...this._def,unknownKeys:"strip"})}passthrough(){return new Fn({...this._def,unknownKeys:"passthrough"})}extend(e){return new Fn({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Fn({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:mr.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Fn({...this._def,catchall:e})}pick(e){const t={};return $t.objectKeys(e).forEach((n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])})),new Fn({...this._def,shape:()=>t})}omit(e){const t={};return $t.objectKeys(this.shape).forEach((n=>{e[n]||(t[n]=this.shape[n])})),new Fn({...this._def,shape:()=>t})}deepPartial(){return Un(this)}partial(e){const t={};return $t.objectKeys(this.shape).forEach((n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()})),new Fn({...this._def,shape:()=>t})}required(e){const t={};return $t.objectKeys(this.shape).forEach((n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof sr;)e=e._def.innerType;t[n]=e}})),new Fn({...this._def,shape:()=>t})}keyof(){return Qn($t.objectKeys(this.shape))}}Fn.create=(e,t)=>new Fn({shape:()=>e,unknownKeys:"strip",catchall:Ln.create(),typeName:mr.ZodObject,...on(t)}),Fn.strictCreate=(e,t)=>new Fn({shape:()=>e,unknownKeys:"strict",catchall:Ln.create(),typeName:mr.ZodObject,...on(t)}),Fn.lazycreate=(e,t)=>new Fn({shape:e,unknownKeys:"strip",catchall:Ln.create(),typeName:mr.ZodObject,...on(t)});class Bn extends ln{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map((async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map((e=>new Ut(e.ctx.common.issues)));return zt(t,{code:Dt.invalid_union,unionErrors:n}),Kt}));{let e;const r=[];for(const s of n){const n={...t,common:{...t.common,issues:[]},parent:null},a=s._parseSync({data:t.data,path:t.path,parent:n});if("valid"===a.status)return a;"dirty"!==a.status||e||(e={result:a,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const s=r.map((e=>new Ut(e)));return zt(t,{code:Dt.invalid_union,unionErrors:s}),Kt}}get options(){return this._def.options}}Bn.create=(e,t)=>new Bn({options:e,typeName:mr.ZodUnion,...on(t)});const qn=e=>e instanceof Xn?qn(e.schema):e instanceof rr?qn(e.innerType()):e instanceof Yn?[e.value]:e instanceof er?e.options:e instanceof tr?$t.objectValues(e.enum):e instanceof ir?qn(e._def.innerType):e instanceof Nn?[void 0]:e instanceof Rn?[null]:e instanceof sr?[void 0,...qn(e.unwrap())]:e instanceof ar?[null,...qn(e.unwrap())]:e instanceof ur||e instanceof hr?qn(e.unwrap()):e instanceof or?qn(e._def.innerType):[];class Hn extends ln{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==Lt.object)return zt(t,{code:Dt.invalid_type,expected:Lt.object,received:t.parsedType}),Kt;const n=this.discriminator,r=t.data[n],s=this.optionsMap.get(r);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(zt(t,{code:Dt.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),Kt)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=qn(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const s of t){if(r.has(s))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);r.set(s,n)}}return new Hn({typeName:mr.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...on(n)})}}function zn(e,t){const n=Mt(e),r=Mt(t);if(e===t)return{valid:!0,data:e};if(n===Lt.object&&r===Lt.object){const n=$t.objectKeys(t),r=$t.objectKeys(e).filter((e=>-1!==n.indexOf(e))),s={...e,...t};for(const n of r){const r=zn(e[n],t[n]);if(!r.valid)return{valid:!1};s[n]=r.data}return{valid:!0,data:s}}if(n===Lt.array&&r===Lt.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const s=zn(e[r],t[r]);if(!s.valid)return{valid:!1};n.push(s.data)}return{valid:!0,data:n}}return n===Lt.date&&r===Lt.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class Wn extends ln{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(Zt(e)||Zt(r))return Kt;const s=zn(e.value,r.value);return s.valid?((Jt(e)||Jt(r))&&t.dirty(),{status:t.value,value:s.data}):(zt(n,{code:Dt.invalid_intersection_types}),Kt)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Wn.create=(e,t,n)=>new Wn({left:e,right:t,typeName:mr.ZodIntersection,...on(n)});class Kn extends ln{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Lt.array)return zt(n,{code:Dt.invalid_type,expected:Lt.array,received:n.parsedType}),Kt;if(n.data.length<this._def.items.length)return zt(n,{code:Dt.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Kt;!this._def.rest&&n.data.length>this._def.items.length&&(zt(n,{code:Dt.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new sn(n,e,n.path,t)):null})).filter((e=>!!e));return n.common.async?Promise.all(r).then((e=>Wt.mergeArray(t,e))):Wt.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new Kn({...this._def,rest:e})}}Kn.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Kn({items:e,typeName:mr.ZodTuple,rest:null,...on(t)})};class Vn extends ln{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Lt.object)return zt(n,{code:Dt.invalid_type,expected:Lt.object,received:n.parsedType}),Kt;const r=[],s=this._def.keyType,a=this._def.valueType;for(const e in n.data)r.push({key:s._parse(new sn(n,e,n.path,e)),value:a._parse(new sn(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?Wt.mergeObjectAsync(t,r):Wt.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new Vn(t instanceof ln?{keyType:e,valueType:t,typeName:mr.ZodRecord,...on(n)}:{keyType:Tn.create(),valueType:e,typeName:mr.ZodRecord,...on(t)})}}class Gn extends ln{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Lt.map)return zt(n,{code:Dt.invalid_type,expected:Lt.map,received:n.parsedType}),Kt;const r=this._def.keyType,s=this._def.valueType,a=[...n.data.entries()].map((([e,t],a)=>({key:r._parse(new sn(n,e,n.path,[a,"key"])),value:s._parse(new sn(n,t,n.path,[a,"value"]))})));if(n.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const n of a){const r=await n.key,s=await n.value;if("aborted"===r.status||"aborted"===s.status)return Kt;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const n of a){const r=n.key,s=n.value;if("aborted"===r.status||"aborted"===s.status)return Kt;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}}}}Gn.create=(e,t,n)=>new Gn({valueType:t,keyType:e,typeName:mr.ZodMap,...on(n)});class Zn extends ln{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==Lt.set)return zt(n,{code:Dt.invalid_type,expected:Lt.set,received:n.parsedType}),Kt;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(zt(n,{code:Dt.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(zt(n,{code:Dt.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const s=this._def.valueType;function a(e){const n=new Set;for(const r of e){if("aborted"===r.status)return Kt;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map(((e,t)=>s._parse(new sn(n,e,n.path,t))));return n.common.async?Promise.all(i).then((e=>a(e))):a(i)}min(e,t){return new Zn({...this._def,minSize:{value:e,message:tn.toString(t)}})}max(e,t){return new Zn({...this._def,maxSize:{value:e,message:tn.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}Zn.create=(e,t)=>new Zn({valueType:e,minSize:null,maxSize:null,typeName:mr.ZodSet,...on(t)});class Jn extends ln{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==Lt.function)return zt(t,{code:Dt.invalid_type,expected:Lt.function,received:t.parsedType}),Kt;function n(e,n){return Ht({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,qt(),Ft].filter((e=>!!e)),issueData:{code:Dt.invalid_arguments,argumentsError:n}})}function r(e,n){return Ht({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,qt(),Ft].filter((e=>!!e)),issueData:{code:Dt.invalid_return_type,returnTypeError:n}})}const s={errorMap:t.common.contextualErrorMap},a=t.data;if(this._def.returns instanceof nr){const e=this;return Gt((async function(...t){const i=new Ut([]),o=await e._def.args.parseAsync(t,s).catch((e=>{throw i.addIssue(n(t,e)),i})),l=await Reflect.apply(a,this,o),c=await e._def.returns._def.type.parseAsync(l,s).catch((e=>{throw i.addIssue(r(l,e)),i}));return c}))}{const e=this;return Gt((function(...t){const i=e._def.args.safeParse(t,s);if(!i.success)throw new Ut([n(t,i.error)]);const o=Reflect.apply(a,this,i.data),l=e._def.returns.safeParse(o,s);if(!l.success)throw new Ut([r(o,l.error)]);return l.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new Jn({...this._def,args:Kn.create(e).rest(jn.create())})}returns(e){return new Jn({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new Jn({args:e||Kn.create([]).rest(jn.create()),returns:t||jn.create(),typeName:mr.ZodFunction,...on(n)})}}class Xn extends ln{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}Xn.create=(e,t)=>new Xn({getter:e,typeName:mr.ZodLazy,...on(t)});class Yn extends ln{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return zt(t,{received:t.data,code:Dt.invalid_literal,expected:this._def.value}),Kt}return{status:"valid",value:e.data}}get value(){return this._def.value}}function Qn(e,t){return new er({values:e,typeName:mr.ZodEnum,...on(t)})}Yn.create=(e,t)=>new Yn({value:e,typeName:mr.ZodLiteral,...on(t)});class er extends ln{constructor(){super(...arguments),nn.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return zt(t,{expected:$t.joinValues(n),received:t.parsedType,code:Dt.invalid_type}),Kt}if(Qt(this,nn)||en(this,nn,new Set(this._def.values)),!Qt(this,nn).has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return zt(t,{received:t.data,code:Dt.invalid_enum_value,options:n}),Kt}return Gt(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return er.create(e,{...this._def,...t})}exclude(e,t=this._def){return er.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}nn=new WeakMap,er.create=Qn;class tr extends ln{constructor(){super(...arguments),rn.set(this,void 0)}_parse(e){const t=$t.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==Lt.string&&n.parsedType!==Lt.number){const e=$t.objectValues(t);return zt(n,{expected:$t.joinValues(e),received:n.parsedType,code:Dt.invalid_type}),Kt}if(Qt(this,rn)||en(this,rn,new Set($t.getValidEnumValues(this._def.values))),!Qt(this,rn).has(e.data)){const e=$t.objectValues(t);return zt(n,{received:n.data,code:Dt.invalid_enum_value,options:e}),Kt}return Gt(e.data)}get enum(){return this._def.values}}rn=new WeakMap,tr.create=(e,t)=>new tr({values:e,typeName:mr.ZodNativeEnum,...on(t)});class nr extends ln{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==Lt.promise&&!1===t.common.async)return zt(t,{code:Dt.invalid_type,expected:Lt.promise,received:t.parsedType}),Kt;const n=t.parsedType===Lt.promise?t.data:Promise.resolve(t.data);return Gt(n.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}nr.create=(e,t)=>new nr({type:e,typeName:mr.ZodPromise,...on(t)});class rr extends ln{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===mr.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,s={addIssue:e=>{zt(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===r.type){const e=r.transform(n.data,s);if(n.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return Kt;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?Kt:"dirty"===r.status||"dirty"===t.value?Vt(r.value):r}));{if("aborted"===t.value)return Kt;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?Kt:"dirty"===r.status||"dirty"===t.value?Vt(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,s);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?Kt:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((n=>"aborted"===n.status?Kt:("dirty"===n.status&&t.dirty(),e(n.value).then((()=>({status:t.value,value:n.value}))))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!Xt(e))return e;const a=r.transform(e.value,s);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((e=>Xt(e)?Promise.resolve(r.transform(e.value,s)).then((e=>({status:t.value,value:e}))):e))}$t.assertNever(r)}}rr.create=(e,t,n)=>new rr({schema:e,typeName:mr.ZodEffects,effect:t,...on(n)}),rr.createWithPreprocess=(e,t,n)=>new rr({schema:t,effect:{type:"preprocess",transform:e},typeName:mr.ZodEffects,...on(n)});class sr extends ln{_parse(e){return this._getType(e)===Lt.undefined?Gt(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}sr.create=(e,t)=>new sr({innerType:e,typeName:mr.ZodOptional,...on(t)});class ar extends ln{_parse(e){return this._getType(e)===Lt.null?Gt(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ar.create=(e,t)=>new ar({innerType:e,typeName:mr.ZodNullable,...on(t)});class ir extends ln{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===Lt.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}ir.create=(e,t)=>new ir({innerType:e,typeName:mr.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...on(t)});class or extends ln{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return Yt(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new Ut(n.common.issues)},input:n.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new Ut(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}or.create=(e,t)=>new or({innerType:e,typeName:mr.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...on(t)});class lr extends ln{_parse(e){if(this._getType(e)!==Lt.nan){const t=this._getOrReturnCtx(e);return zt(t,{code:Dt.invalid_type,expected:Lt.nan,received:t.parsedType}),Kt}return{status:"valid",value:e.data}}}lr.create=e=>new lr({typeName:mr.ZodNaN,...on(e)});const cr=Symbol("zod_brand");class ur extends ln{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class dr extends ln{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async){return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Kt:"dirty"===e.status?(t.dirty(),Vt(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})()}{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Kt:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new dr({in:e,out:t,typeName:mr.ZodPipeline})}}class hr extends ln{_parse(e){const t=this._def.innerType._parse(e),n=e=>(Xt(e)&&(e.value=Object.freeze(e.value)),e);return Yt(t)?t.then((e=>n(e))):n(t)}unwrap(){return this._def.innerType}}function pr(e,t={},n){return e?$n.create().superRefine(((r,s)=>{var a,i;if(!e(r)){const e="function"==typeof t?t(r):"string"==typeof t?{message:t}:t,o=null===(i=null!==(a=e.fatal)&&void 0!==a?a:n)||void 0===i||i,l="string"==typeof e?{message:e}:e;s.addIssue({code:"custom",...l,fatal:o})}})):$n.create()}hr.create=(e,t)=>new hr({innerType:e,typeName:mr.ZodReadonly,...on(t)});const fr={object:Fn.lazycreate};var mr;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(mr||(mr={}));const gr=Tn.create,yr=An.create,wr=lr.create,br=In.create,vr=xn.create,_r=Pn.create,kr=Cn.create,Er=Nn.create,Or=Rn.create,Tr=$n.create,Sr=jn.create,Ar=Ln.create,Ir=Mn.create,xr=Dn.create,Pr=Fn.create,Cr=Fn.strictCreate,Nr=Bn.create,Rr=Hn.create,$r=Wn.create,jr=Kn.create,Lr=Vn.create,Mr=Gn.create,Dr=Zn.create,Ur=Jn.create,Fr=Xn.create,Br=Yn.create,qr=er.create,Hr=tr.create,zr=nr.create,Wr=rr.create,Kr=sr.create,Vr=ar.create,Gr=rr.createWithPreprocess,Zr=dr.create,Jr={string:e=>Tn.create({...e,coerce:!0}),number:e=>An.create({...e,coerce:!0}),boolean:e=>xn.create({...e,coerce:!0}),bigint:e=>In.create({...e,coerce:!0}),date:e=>Pn.create({...e,coerce:!0})},Xr=Kt;var Yr=Object.freeze({__proto__:null,defaultErrorMap:Ft,setErrorMap:function(e){Bt=e},getErrorMap:qt,makeIssue:Ht,EMPTY_PATH:[],addIssueToContext:zt,ParseStatus:Wt,INVALID:Kt,DIRTY:Vt,OK:Gt,isAborted:Zt,isDirty:Jt,isValid:Xt,isAsync:Yt,get util(){return $t},get objectUtil(){return jt},ZodParsedType:Lt,getParsedType:Mt,ZodType:ln,datetimeRegex:En,ZodString:Tn,ZodNumber:An,ZodBigInt:In,ZodBoolean:xn,ZodDate:Pn,ZodSymbol:Cn,ZodUndefined:Nn,ZodNull:Rn,ZodAny:$n,ZodUnknown:jn,ZodNever:Ln,ZodVoid:Mn,ZodArray:Dn,ZodObject:Fn,ZodUnion:Bn,ZodDiscriminatedUnion:Hn,ZodIntersection:Wn,ZodTuple:Kn,ZodRecord:Vn,ZodMap:Gn,ZodSet:Zn,ZodFunction:Jn,ZodLazy:Xn,ZodLiteral:Yn,ZodEnum:er,ZodNativeEnum:tr,ZodPromise:nr,ZodEffects:rr,ZodTransformer:rr,ZodOptional:sr,ZodNullable:ar,ZodDefault:ir,ZodCatch:or,ZodNaN:lr,BRAND:cr,ZodBranded:ur,ZodPipeline:dr,ZodReadonly:hr,custom:pr,Schema:ln,ZodSchema:ln,late:fr,get ZodFirstPartyTypeKind(){return mr},coerce:Jr,any:Tr,array:xr,bigint:br,boolean:vr,date:_r,discriminatedUnion:Rr,effect:Wr,enum:qr,function:Ur,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>pr((t=>t instanceof e),t),intersection:$r,lazy:Fr,literal:Br,map:Mr,nan:wr,nativeEnum:Hr,never:Ar,null:Or,nullable:Vr,number:yr,object:Pr,oboolean:()=>vr().optional(),onumber:()=>yr().optional(),optional:Kr,ostring:()=>gr().optional(),pipeline:Zr,preprocess:Gr,promise:zr,record:Lr,set:Dr,strictObject:Cr,string:gr,symbol:kr,transformer:Wr,tuple:jr,undefined:Er,union:Nr,unknown:Sr,void:Ir,NEVER:Xr,ZodIssueCode:Dt,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:Ut});function Qr(e,t){return bs(e.type._def,t)}function es(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>es(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return ts(e,t)}}const ts=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":Rt(n,"minimum",r.value,r.message,t);break;case"max":Rt(n,"maximum",r.value,r.message,t)}return n};let ns;const rs=/^[cC][^\s-]{8,}$/,ss=/^[0-9a-z]+$/,as=/^[0-9A-HJKMNP-TV-Z]{26}$/,is=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,os=()=>(void 0===ns&&(ns=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ns),ls=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,cs=/^[a-zA-Z0-9_-]{21}$/;function us(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?ds(e):e}if(e.checks)for(const s of e.checks)switch(s.kind){case"min":Rt(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t);break;case"max":Rt(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"email":switch(t.emailStrategy){case"format:email":hs(n,"email",s.message,t);break;case"format:idn-email":hs(n,"idn-email",s.message,t);break;case"pattern:zod":ps(n,is,s.message,t)}break;case"url":hs(n,"uri",s.message,t);break;case"uuid":hs(n,"uuid",s.message,t);break;case"regex":ps(n,s.regex,s.message,t);break;case"cuid":ps(n,rs,s.message,t);break;case"cuid2":ps(n,ss,s.message,t);break;case"startsWith":ps(n,RegExp(`^${r(s.value)}`),s.message,t);break;case"endsWith":ps(n,RegExp(`${r(s.value)}$`),s.message,t);break;case"datetime":hs(n,"date-time",s.message,t);break;case"date":hs(n,"date",s.message,t);break;case"time":hs(n,"time",s.message,t);break;case"duration":hs(n,"duration",s.message,t);break;case"length":Rt(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t),Rt(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"includes":ps(n,RegExp(r(s.value)),s.message,t);break;case"ip":"v6"!==s.version&&hs(n,"ipv4",s.message,t),"v4"!==s.version&&hs(n,"ipv6",s.message,t);break;case"emoji":ps(n,os,s.message,t);break;case"ulid":ps(n,as,s.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":hs(n,"binary",s.message,t);break;case"contentEncoding:base64":Rt(n,"contentEncoding","base64",s.message,t);break;case"pattern:zod":ps(n,ls,s.message,t)}break;case"nanoid":ps(n,cs,s.message,t)}return n}const ds=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),hs=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Rt(e,"format",t,n,r)},ps=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:fs(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Rt(e,"pattern",fs(t,r),n,r)},fs=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r=n.flags.includes("i"),s=n.flags.includes("m"),a=n.flags.includes("s"),i=r?n.source.toLowerCase():n.source;let o="",l=!1,c=!1,u=!1;for(let e=0;e<i.length;e++)if(l)o+=i[e],l=!1;else{if(r)if(c){if(i[e].match(/[a-z]/)){u?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),u=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],u=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(s){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}a&&"."===i[e]?o+=c?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?l=!0:c&&"]"===i[e]?c=!1:c||"["!==i[e]||(c=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function ms(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===mr.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:bs(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:bs(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===mr.ZodString&&e.keyType._def.checks?.length){const{type:r,...s}=us(e.keyType._def,t);return{...n,propertyNames:s}}if(e.keyType?._def.typeName===mr.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===mr.ZodBranded&&e.keyType._def.type._def.typeName===mr.ZodString&&e.keyType._def.type._def.checks?.length){const{type:r,...s}=Qr(e.keyType._def,t);return{...n,propertyNames:s}}return n}const gs={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};const ys=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>bs(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function ws(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:bs(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:bs(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function bs(e,t,n=!1){const r=t.seen.get(e);if(t.override){const s=t.override?.(e,t,r,n);if(s!==xt)return s}if(r&&!n){const e=vs(r,t);if(void 0!==e)return e}const s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);const a=ks(e,e.typeName,t);return a&&Es(e,t,a),s.jsonSchema=a,a}const vs=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:_s(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},_s=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},ks=(e,t,n)=>{switch(t){case mr.ZodString:return us(e,n);case mr.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",Nt(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?Rt(n,"minimum",r.value,r.message,t):Rt(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Rt(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Rt(n,"maximum",r.value,r.message,t):Rt(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Rt(n,"maximum",r.value,r.message,t));break;case"multipleOf":Rt(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case mr.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const s=bs(r._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===s?e:{properties:{...e.properties,[n]:s},required:r.isOptional()?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:ws(e,t)};return n.required.length||delete n.required,n}(e,n);case mr.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?Rt(n,"minimum",r.value,r.message,t):Rt(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Rt(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Rt(n,"maximum",r.value,r.message,t):Rt(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Rt(n,"maximum",r.value,r.message,t));break;case"multipleOf":Rt(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case mr.ZodBoolean:return{type:"boolean"};case mr.ZodDate:return es(e,n);case mr.ZodUndefined:return{not:{}};case mr.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case mr.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==mr.ZodAny&&(n.items=bs(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Rt(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Rt(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Rt(n,"minItems",e.exactLength.value,e.exactLength.message,t),Rt(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case mr.ZodUnion:case mr.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return ys(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in gs&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=gs[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return ys(e,t)}(e,n);case mr.ZodIntersection:return function(e,t){const n=[bs(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),bs(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;s.push(t)}else s.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),s.length?{allOf:s,...r}:void 0}(e,n);case mr.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>bs(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:bs(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>bs(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case mr.ZodRecord:return ms(e,n);case mr.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case mr.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case mr.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case mr.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:gs[e.innerType._def.typeName],nullable:!0}:{type:[gs[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=bs(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=bs(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case mr.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return bs(e.innerType._def,t);const n=bs(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case mr.ZodMap:return function(e,t){return"record"===t.mapStrategy?ms(e,t):{type:"array",maxItems:125,items:{type:"array",items:[bs(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},bs(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case mr.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:bs(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Rt(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Rt(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case mr.ZodLazy:return bs(e.getter()._def,n);case mr.ZodPromise:return function(e,t){return bs(e.type._def,t)}(e,n);case mr.ZodNaN:case mr.ZodNever:return{not:{}};case mr.ZodEffects:return function(e,t){return"input"===t.effectStrategy?bs(e.schema._def,t):{}}(e,n);case mr.ZodAny:case mr.ZodUnknown:return{};case mr.ZodDefault:return function(e,t){return{...bs(e.innerType._def,t),default:e.defaultValue()}}(e,n);case mr.ZodBranded:return Qr(e,n);case mr.ZodReadonly:case mr.ZodCatch:return((e,t)=>bs(e.innerType._def,t))(e,n);case mr.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return bs(e.in._def,t);if("output"===t.pipeStrategy)return bs(e.out._def,t);const n=bs(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,bs(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case mr.ZodFunction:case mr.ZodVoid:case mr.ZodSymbol:default:return}},Es=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Os=(e,t)=>{const n=Ct(t),r=void 0,s=t?.name,a=bs(e._def,n,!1)??{},i=void 0===s?a:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...r,[s]:a}};return"jsonSchema7"===n.target?i.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i},Ts={SYSTEM_MESSAGE:({agent:e,task:t})=>`You are ${e.name}.\n\nYour role is: ${e.role}.\nYour background is: ${e.background}.\nYour main goal is: ${e.goal}\nYou are working as part of a team.\n\nFor your work you will have available:\n\n- Access to a defined set of tools. \n- Findings and insights from previous tasks. You must use this information to complete your current task.\n- Must follow a specific format for your output.\n\n## Tools available for your use: \n\n${e.tools.length>0?e.tools.map((e=>`${e.name}: ${e.description} Tool Input Schema: ${JSON.stringify(Os(e.schema))}`)).join(", "):"No tools available. You must reply using your internal knowledge."}\n\n**Important:** You ONLY have access to the tools above, and should NEVER make up tools that are not listed here.\n\n## Format of your output\n\nYou will return just one of the following:\n\n- Thought + (Action or Self Question)\nOR\n- Observation\nOR\n- Final Answer\n\nBelow is the explanation of each one:\n\n### Thought + (Action or Self Question)\n\n{\n   "thought": "your thoughts about what to do next" // it could be an action or ask yourself a follow up question\n   "action":  "you decide what action to take based on your previous thought", // the action could be a self follow up question or decide to use a tool from the available tools to use,\n   "actionInput": the input to the action, just a simple JSON object, enclosed in curly braces, using \\" to wrap keys and values. Remember to use the Tool Schema.\n}\n\nExamples: \n\n{\n   "thought": "To find out who won the Copa America in 2024, I need to search for the most recent and relevant information."\n   "action": "tavily_search_results_json",\n   "actionInput": {"query":"Copa America 2024 winner"}\n}\n\nother\n\n{\n   "thought": "To find out who won the Copa America in 2024, I need to search for the most recent and relevant information."\n   "action": "self_question",\n   "actionInput": {"query":"Copa America 2024 winner"}\n}\n\n### Observation\n\n{\n   "observation":  "Reflect about the result of the action. (E.g:  I got the following results from the tool Can I get the Final Answer from there?)", \n    "isFinalAnswerReady": false // If you have the final answer or not\n}\n\n### Final Answer\n\nIMPORTANT: (Please respect the expected output requirements from the user): ${t.expectedOutput}\n\n{\n    "finalAnswer": "The final answer to the Task."\n}\n\n**IMPORTANT**: You must return a valid JSON object. As if you were returning a JSON object from a function.\n`,INITIAL_MESSAGE:({agent:e,task:t,context:n})=>`Hi ${e.name}, please complete the following task: ${t.description}. \n        Your expected output should be: "${t.expectedOutput}". \n        ${n?`Incorporate the following findings and insights from previous tasks: "${n}"`:""}`,INVALID_JSON_FEEDBACK:({_agent:e,_task:t,_llmOutput:n})=>'You returned an invalid JSON object. Please format your answer as a valid JSON object. Just the JSON object not comments or anything else. E.g: {"finalAnswer": "The final answer"}',THOUGHT_WITH_SELF_QUESTION_FEEDBACK:({_agent:e,_task:t,_thought:n,question:r,_parsedLLMOutput:s})=>`Awesome, please answer yourself the question: ${r}.`,THOUGHT_FEEDBACK:({_agent:e,_task:t,_thought:n,_parsedLLMOutput:r})=>"Your thoughts are great, let's keep going.",SELF_QUESTION_FEEDBACK:({_agent:e,_task:t,_question:n,_parsedLLMOutput:r})=>"Awesome, please answer yourself the question.",TOOL_RESULT_FEEDBACK:({_agent:e,_task:t,toolResult:n,_parsedLLMOutput:r})=>`You got this result from the tool: ${JSON.stringify(n)}`,TOOL_ERROR_FEEDBACK:({_agent:e,_task:t,toolName:n,_error:r,_parsedLLMOutput:s})=>`An error occurred while using the tool ${n}. Please try again or use a different method.`,TOOL_NOT_EXIST_FEEDBACK:({_agent:e,_task:t,toolName:n,_parsedLLMOutput:r})=>`Hey, the tool ${n} does not exist. Please find another way.`,OBSERVATION_FEEDBACK:({_agent:e,_task:t,_parsedLLMOutput:n})=>"Great observation. Please keep going. Let's get to the final answer.",WEIRD_OUTPUT_FEEDBACK:({_agent:e,_task:t,_parsedLLMOutput:n})=>"Your latest response does not match the way you are expected to output information. Please correct it.",FORCE_FINAL_ANSWER_FEEDBACK:({_agent:e,_task:t,_iterations:n,_maxAgentIterations:r})=>"We don't have more time to keep looking for the answer. Please use all the information you have gathered until now and give the finalAnswer right away.",WORK_ON_FEEDBACK_FEEDBACK:({_agent:e,_task:t,feedback:n})=>`Here is some feedback for you to address: ${n}`};class Ss{constructor({name:e,role:n,goal:r,background:s,tools:a=[],llmConfig:i={},maxIterations:o=10,forceFinalAnswer:l=!0,promptTemplates:c={},llmInstance:u=null}){this.id=t(),this.name=e,this.role=n,this.goal=r,this.background=s,this.tools=a,this.maxIterations=o,this.store=null,this.status=N,this.env=null,this.llmInstance=u;const d={provider:"openai",model:"gpt-4o-mini",maxRetries:1,...i};this.llmConfig=this.normalizeLlmConfig(d),this.llmSystemMessage=null,this.forceFinalAnswer=l,this.promptTemplates={...Ts},Object.assign(this.promptTemplates,c)}normalizeLlmConfig(e){const{provider:t,apiBaseUrl:n}=e;let r={...e};if(n)switch(t){case"openai":r.configuration={basePath:n};break;case"anthropic":r.anthropicApiUrl=n;break;case"google":r.baseUrl=n;break;case"mistral":r.endpoint=n;break;default:throw new Error(`Unknown provider: ${t}`)}return r}setStore(e){this.store=e}setStatus(e){this.status=e}setEnv(e){this.env=e}workOnTask(e){throw new Error("workOnTask must be implemented by subclasses.")}}const As="RFC3986",Is={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},xs=Array.isArray,Ps=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),Cs=1024;function Ns(e,t){if(xs(e)){const n=[];for(let r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)}const Rs=Object.prototype.hasOwnProperty,$s={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},js=Array.isArray,Ls=Array.prototype.push,Ms=function(e,t){Ls.apply(e,js(t)?t:[t])},Ds=Date.prototype.toISOString,Us={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,r,s)=>{if(0===e.length)return e;let a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));let i="";for(let e=0;e<a.length;e+=Cs){const t=a.length>=Cs?a.slice(e,e+Cs):a,n=[];for(let e=0;e<t.length;++e){let r=t.charCodeAt(e);45===r||46===r||95===r||126===r||r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||"RFC1738"===s&&(40===r||41===r)?n[n.length]=t.charAt(e):r<128?n[n.length]=Ps[r]:r<2048?n[n.length]=Ps[192|r>>6]+Ps[128|63&r]:r<55296||r>=57344?n[n.length]=Ps[224|r>>12]+Ps[128|r>>6&63]+Ps[128|63&r]:(e+=1,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n[n.length]=Ps[240|r>>18]+Ps[128|r>>12&63]+Ps[128|r>>6&63]+Ps[128|63&r])}i+=n.join("")}return i},encodeValuesOnly:!1,format:As,formatter:Is[As],indices:!1,serializeDate:e=>Ds.call(e),skipNulls:!1,strictNullHandling:!1};const Fs={};function Bs(e,t,n,r,s,a,i,o,l,c,u,d,h,p,f,m,g,y){let w=e,b=y,v=0,_=!1;for(;void 0!==(b=b.get(Fs))&&!_;){const t=b.get(e);if(v+=1,void 0!==t){if(t===v)throw new RangeError("Cyclic object value");_=!0}void 0===b.get(Fs)&&(v=0)}if("function"==typeof c?w=c(t,w):w instanceof Date?w=h?.(w):"comma"===n&&js(w)&&(w=Ns(w,(function(e){return e instanceof Date?h?.(e):e}))),null===w){if(a)return l&&!m?l(t,Us.encoder,g,"key",p):t;w=""}if(function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"symbol"==typeof e||"bigint"==typeof e}(w)||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(w)){if(l){const e=m?t:l(t,Us.encoder,g,"key",p);return[f?.(e)+"="+f?.(l(w,Us.encoder,g,"value",p))]}return[f?.(t)+"="+f?.(String(w))]}const k=[];if(void 0===w)return k;let E;if("comma"===n&&js(w))m&&l&&(w=Ns(w,l)),E=[{value:w.length>0?w.join(",")||null:void 0}];else if(js(c))E=c;else{const e=Object.keys(w);E=u?e.sort(u):e}const O=o?String(t).replace(/\./g,"%2E"):String(t),T=r&&js(w)&&1===w.length?O+"[]":O;if(s&&js(w)&&0===w.length)return T+"[]";for(let t=0;t<E.length;++t){const b=E[t],_="object"==typeof b&&void 0!==b.value?b.value:w[b];if(i&&null===_)continue;const O=d&&o?b.replace(/\./g,"%2E"):b,S=js(w)?"function"==typeof n?n(T,O):T:T+(d?"."+O:"["+O+"]");y.set(e,v);const A=new WeakMap;A.set(Fs,y),Ms(k,Bs(_,S,n,r,s,a,i,o,"comma"===n&&m&&js(w)?null:l,c,u,d,h,p,f,m,g,A))}return k}function qs(e,t={}){let n=e;const r=function(e=Us){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||Us.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=As;if(void 0!==e.format){if(!Rs.call(Is,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const r=Is[n];let s,a=Us.filter;if(("function"==typeof e.filter||js(e.filter))&&(a=e.filter),s=e.arrayFormat&&e.arrayFormat in $s?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":Us.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||Us.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:Us.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:Us.allowEmptyArrays,arrayFormat:s,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:Us.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?Us.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:Us.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:Us.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:Us.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:Us.encodeValuesOnly,filter:a,format:n,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:Us.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:Us.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:Us.strictNullHandling}}(t);let s,a;"function"==typeof r.filter?(a=r.filter,n=a("",n)):js(r.filter)&&(a=r.filter,s=a);const i=[];if("object"!=typeof n||null===n)return"";const o=$s[r.arrayFormat],l="comma"===o&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const c=new WeakMap;for(let e=0;e<s.length;++e){const t=s[e];r.skipNulls&&null===n[t]||Ms(i,Bs(n[t],t,o,l,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const u=i.join(r.delimiter);let d=!0===r.addQueryPrefix?"?":"";return r.charsetSentinel&&("iso-8859-1"===r.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}const Hs="4.71.1";let zs,Ws,Ks,Vs,Gs,Zs,Js,Xs,Ys,Qs=!1;let ea=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};zs||function(e,t={auto:!1}){if(Qs)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(zs)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${zs}'\``);Qs=t.auto,zs=e.kind,Ws=e.fetch,Ks=e.FormData,Vs=e.File,Gs=e.ReadableStream,Zs=e.getMultipartRequestOptions,Js=e.getDefaultAgent,Xs=e.fileFromPath,Ys=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new ea(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class ta extends Error{}let na=class e extends ta{constructor(t,n,r,s){super(`${e.makeMessage(t,n,r)}`),this.status=t,this.headers=s,this.request_id=s?.["x-request-id"];const a=n;this.error=a,this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(t,n,r,s){if(!t)return new sa({message:r,cause:Qa(n)});const a=n?.error;return 400===t?new ia(t,a,r,s):401===t?new oa(t,a,r,s):403===t?new la(t,a,r,s):404===t?new ca(t,a,r,s):409===t?new ua(t,a,r,s):422===t?new da(t,a,r,s):429===t?new ha(t,a,r,s):t>=500?new pa(t,a,r,s):new e(t,a,r,s)}},ra=class extends na{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},sa=class extends na{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},aa=class extends sa{constructor({message:e}={}){super({message:e??"Request timed out."})}},ia=class extends na{constructor(){super(...arguments),this.status=400}},oa=class extends na{constructor(){super(...arguments),this.status=401}},la=class extends na{constructor(){super(...arguments),this.status=403}},ca=class extends na{constructor(){super(...arguments),this.status=404}},ua=class extends na{constructor(){super(...arguments),this.status=409}},da=class extends na{constructor(){super(...arguments),this.status=422}},ha=class extends na{constructor(){super(...arguments),this.status=429}},pa=class extends na{};class fa extends ta{constructor(){super("Could not parse response content as the length limit was reached")}}class ma extends ta{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}let ga=class e{constructor(){this.buffer=[],this.trailingCR=!1}decode(t){let n=this.decodeText(t);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];const r=e.NEWLINE_CHARS.has(n[n.length-1]||"");let s=n.split(e.NEWLINE_REGEXP);return r&&s.pop(),1!==s.length||r?(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s):(this.buffer.push(s[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new ta(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new ta(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new ta("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};ga.NEWLINE_CHARS=new Set(["\n","\r"]),ga.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let ya=class e{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(t,n){let r=!1;return new e((async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let e=!1;try{for await(const r of async function*(e,t){if(!e.body)throw t.abort(),new ta("Attempted to iterate over a response with no body");const n=new ba,r=new ga,s=va(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,s=new Uint8Array(t.length+e.length);for(s.set(t),s.set(e,t.length),t=s;-1!==(r=wa(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(s))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(t,n))if(!e)if(r.data.startsWith("[DONE]"))e=!0;else if(null===r.event){let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if(e&&e.error)throw new na(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if("error"==r.event)throw new na(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||n.abort()}}),n)}static fromReadableStream(t,n){let r=!1;return new e((async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let e=!1;try{for await(const n of async function*(){const e=new ga,n=va(t);for await(const t of n)for(const n of e.decode(t))yield n;for(const t of e.flush())yield t}())e||n&&(yield JSON.parse(n));e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||n.abort()}}),n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const t=[],n=[],r=this.iterator(),s=e=>({next:()=>{if(0===e.length){const e=r.next();t.push(e),n.push(e)}return e.shift()}});return[new e((()=>s(t)),this.controller),new e((()=>s(n)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new Gs({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:s}=await t.next();if(s)return e.close();const a=n.encode(JSON.stringify(r)+"\n");e.enqueue(a)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}};function wa(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}let ba=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}};function va(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const _a=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,ka=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Ea(e),Ea=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Oa(e,t,n){if(e=await e,ka(e))return e;if(_a(e)){const r=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const s=Ea(r)?[await r.arrayBuffer()]:[r];return new Vs(s,t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Ea(e))t.push(await e.arrayBuffer());else{if(!Sa(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){const t=Object.getOwnPropertyNames(e);return`[${t.map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return Ta(e.name)||Ta(e.filename)||Ta(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new Vs(r,t,n)}const Ta=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,Sa=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],Aa=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],Ia=async e=>{const t=await xa(e.body);return Zs(t,e)},xa=async e=>{const t=new Ks;return await Promise.all(Object.entries(e||{}).map((([e,n])=>Pa(t,e,n)))),t},Pa=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>ka(e)||_a(e)||Ys(e))(n)){const r=await Oa(n);e.append(t,r)}else if(Array.isArray(n))await Promise.all(n.map((n=>Pa(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,r])=>Pa(e,`${t}[${n}]`,r))))}}};var Ca,Na=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},Ra=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};async function $a(e){const{response:t}=e;if(e.options.stream)return si("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):ya.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return si("response",t.status,t.url,t.headers,e),ja(e,t)}const r=await t.text();return si("response",t.status,t.url,t.headers,r),r}function ja(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}let La=class e extends Promise{constructor(e,t=$a){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(t){return new e(this.responsePromise,(async e=>ja(t(await this.parseResponse(e),e),e.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Ma=class{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:s}){this.baseURL=e,this.maxRetries=Ya("maxRetries",t),this.timeout=Ya("timeout",n),this.httpAgent=r,this.fetch=s??Ws}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Va(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${ai()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const r=n&&Ea(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:r}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder){return(new TextEncoder).encode(e).length.toString()}}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const{method:n,path:r,query:s,headers:a={}}=e,i=ArrayBuffer.isView(e.body)||e.__binaryRequest&&"string"==typeof e.body?e.body:Aa(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),l=this.buildURL(r,s);"timeout"in e&&Ya("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??Js(l),d=c+1e3;"number"==typeof u?.options?.timeout&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);return{req:{method:n,...i&&{body:i},headers:this.buildHeaders({options:e,headers:a,contentLength:o,retryCount:t}),...u&&{agent:u},signal:e.signal??null},url:l,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:r}){const s={};n&&(s["content-length"]=n);const a=this.defaultHeaders(e);return ri(s,a),ri(s,t),Aa(e.body)&&"node"!==zs&&delete s["content-type"],void 0===ii(a,"x-stainless-retry-count")&&void 0===ii(t,"x-stainless-retry-count")&&(s["x-stainless-retry-count"]=String(r)),this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return na.generate(e,t,n,r)}request(e,t=null){return new La(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);const{req:s,url:a,timeout:i}=this.buildRequest(n,{retryCount:r-t});if(await this.prepareRequest(s,{url:a,options:n}),si("request",a,n,s.headers),n.signal?.aborted)throw new ra;const o=new AbortController,l=await this.fetchWithTimeout(a,s,i,o).catch(Qa);if(l instanceof Error){if(n.signal?.aborted)throw new ra;if(t)return this.retryRequest(n,t);if("AbortError"===l.name)throw new aa;throw new sa({cause:l})}const c=Fa(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){return si(`response (error; ${`retrying, ${t} attempts remaining`})`,l.status,a,c),this.retryRequest(n,t,c)}const e=await l.text().catch((e=>Qa(e).message)),r=Ga(e),s=r?void 0:e;si(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,a,c,s);throw this.makeStatusError(l.status,r,s,c)}return{response:l,options:n,controller:o}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Ua(this,n,e)}buildURL(e,t){const n=Ja(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return ti(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new ta(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:s,...a}=t||{};s&&s.addEventListener("abort",(()=>r.abort()));const i=setTimeout((()=>r.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...a}).finally((()=>{clearTimeout(i)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n){let r;const s=n?.["retry-after-ms"];if(s){const e=parseFloat(s);Number.isNaN(e)||(r=e)}const a=n?.["retry-after"];if(a&&!r){const e=parseFloat(a);r=Number.isNaN(e)?Date.parse(a)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await Xa(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Hs}`}};class Da{constructor(e,t,n,r){Ca.set(this,void 0),Na(this,Ca,e,"f"),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new ta("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,r]of n)e.url.searchParams.set(t,r);t.query=void 0,t.path=e.url.toString()}return await Ra(this,Ca,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ca=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}let Ua=class extends La{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await $a(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}};const Fa=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),Ba={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},qa=e=>"object"==typeof e&&null!==e&&!ti(e)&&Object.keys(e).every((e=>ni(Ba,e))),Ha=()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":Wa(Deno.build.os),"X-Stainless-Arch":za(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":Wa(process.platform),"X-Stainless-Arch":za(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Hs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const za=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Wa=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Ka;const Va=()=>Ka??(Ka=Ha()),Ga=e=>{try{return JSON.parse(e)}catch(e){return}},Za=new RegExp("^(?:[a-z]+:)?//","i"),Ja=e=>Za.test(e),Xa=e=>new Promise((t=>setTimeout(t,e))),Ya=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new ta(`${e} must be an integer`);if(t<0)throw new ta(`${e} must be a positive integer`);return t},Qa=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},ei=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function ti(e){if(!e)return!0;for(const t in e)return!1;return!0}function ni(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ri(e,t){for(const n in t){if(!ni(t,n))continue;const r=n.toLowerCase();if(!r)continue;const s=t[n];null===s?delete e[r]:void 0!==s&&(e[r]=s)}}function si(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`OpenAI:DEBUG:${e}`,...t)}const ai=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),ii=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const r=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const s of[t,n,t.toUpperCase(),r]){const t=e.get(s);if(t)return t}}for(const[r,s]of Object.entries(e))if(r.toLowerCase()===n)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${t} header, using the first entry.`),s[0]):s};function oi(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class li extends Da{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class ci extends Da{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}let ui=class{constructor(e){this._client=e}},di=class extends ui{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}},hi=class extends ui{constructor(){super(...arguments),this.completions=new di(this._client)}};hi.Completions=di;class pi extends ui{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}class fi extends ui{create(e,t){return this._client.post("/audio/transcriptions",Ia({body:e,...t}))}}class mi extends ui{create(e,t){return this._client.post("/audio/translations",Ia({body:e,...t}))}}class gi extends ui{constructor(){super(...arguments),this.transcriptions=new fi(this._client),this.translations=new mi(this._client),this.speech=new pi(this._client)}}gi.Transcriptions=fi,gi.Translations=mi,gi.Speech=pi;class yi extends ui{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return qa(e)?this.list({},e):this._client.getAPIList("/batches",wi,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class wi extends ci{}yi.BatchesPage=wi;class bi extends ui{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return qa(e)?this.list({},e):this._client.getAPIList("/assistants",vi,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class vi extends ci{}function _i(e){return"function"==typeof e.parse}bi.AssistantsPage=vi;const ki=e=>"assistant"===e?.role,Ei=e=>"function"===e?.role,Oi=e=>"tool"===e?.role;var Ti,Si,Ai,Ii,xi,Pi,Ci,Ni,Ri,$i,ji,Li,Mi,Di=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},Ui=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Fi{constructor(){Ti.add(this),this.controller=new AbortController,Si.set(this,void 0),Ai.set(this,(()=>{})),Ii.set(this,(()=>{})),xi.set(this,void 0),Pi.set(this,(()=>{})),Ci.set(this,(()=>{})),Ni.set(this,{}),Ri.set(this,!1),$i.set(this,!1),ji.set(this,!1),Li.set(this,!1),Di(this,Si,new Promise(((e,t)=>{Di(this,Ai,e,"f"),Di(this,Ii,t,"f")})),"f"),Di(this,xi,new Promise(((e,t)=>{Di(this,Pi,e,"f"),Di(this,Ci,t,"f")})),"f"),Ui(this,Si,"f").catch((()=>{})),Ui(this,xi,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),Ui(this,Ti,"m",Mi).bind(this))}),0)}_connected(){this.ended||(Ui(this,Ai,"f").call(this),this._emit("connect"))}get ended(){return Ui(this,Ri,"f")}get errored(){return Ui(this,$i,"f")}get aborted(){return Ui(this,ji,"f")}abort(){this.controller.abort()}on(e,t){return(Ui(this,Ni,"f")[e]||(Ui(this,Ni,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Ui(this,Ni,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(Ui(this,Ni,"f")[e]||(Ui(this,Ni,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Di(this,Li,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Di(this,Li,!0,"f"),await Ui(this,xi,"f")}_emit(e,...t){if(Ui(this,Ri,"f"))return;"end"===e&&(Di(this,Ri,!0,"f"),Ui(this,Pi,"f").call(this));const n=Ui(this,Ni,"f")[e];if(n&&(Ui(this,Ni,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return Ui(this,Li,"f")||n?.length||Promise.reject(e),Ui(this,Ii,"f").call(this,e),Ui(this,Ci,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Ui(this,Li,"f")||n?.length||Promise.reject(e),Ui(this,Ii,"f").call(this,e),Ui(this,Ci,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function Bi(e){return"auto-parseable-response-format"===e?.$brand}function qi(e){return"auto-parseable-tool"===e?.$brand}function Hi(e,t){const n=e.choices.map((e=>{if("length"===e.finish_reason)throw new fa;if("content_filter"===e.finish_reason)throw new ma;return{...e,message:{...e.message,tool_calls:e.message.tool_calls?.map((e=>function(e,t){const n=e.tools?.find((e=>e.function?.name===t.function.name));return{...t,function:{...t.function,parsed_arguments:qi(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e)))??[],parsed:e.message.content&&!e.message.refusal?zi(t,e.message.content):null}}}));return{...e,choices:n}}function zi(e,t){if("json_schema"!==e.response_format?.type)return null;if("json_schema"===e.response_format?.type){if("$parseRaw"in e.response_format){return e.response_format.$parseRaw(t)}return JSON.parse(t)}return null}function Wi(e,t){if(!e)return!1;const n=e.tools?.find((e=>e.function?.name===t.function.name));return qi(n)||n?.function.strict||!1}function Ki(e){return!!Bi(e.response_format)||(e.tools?.some((e=>qi(e)||"function"===e.type&&!0===e.function.strict))??!1)}Si=new WeakMap,Ai=new WeakMap,Ii=new WeakMap,xi=new WeakMap,Pi=new WeakMap,Ci=new WeakMap,Ni=new WeakMap,Ri=new WeakMap,$i=new WeakMap,ji=new WeakMap,Li=new WeakMap,Ti=new WeakSet,Mi=function(e){if(Di(this,$i,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new ra),e instanceof ra)return Di(this,ji,!0,"f"),this._emit("abort",e);if(e instanceof ta)return this._emit("error",e);if(e instanceof Error){const t=new ta(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new ta(String(e)))};var Vi,Gi,Zi,Ji,Xi,Yi,Qi,eo,to=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const no=10;class ro extends Fi{constructor(){super(...arguments),Vi.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(Ei(e)||Oi(e))&&e.content)this._emit("functionCallResult",e.content);else if(ki(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(ki(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new ta("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),to(this,Vi,"m",Gi).call(this)}async finalMessage(){return await this.done(),to(this,Vi,"m",Zi).call(this)}async finalFunctionCall(){return await this.done(),to(this,Vi,"m",Ji).call(this)}async finalFunctionCallResult(){return await this.done(),to(this,Vi,"m",Xi).call(this)}async totalUsage(){return await this.done(),to(this,Vi,"m",Yi).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=to(this,Vi,"m",Zi).call(this);t&&this._emit("finalMessage",t);const n=to(this,Vi,"m",Gi).call(this);n&&this._emit("finalContent",n);const r=to(this,Vi,"m",Ji).call(this);r&&this._emit("finalFunctionCall",r);const s=to(this,Vi,"m",Xi).call(this);null!=s&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",to(this,Vi,"m",Yi).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),to(this,Vi,"m",Qi).call(this,t);const s=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Hi(s,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:s="auto",stream:a,...i}=t,o="string"!=typeof s&&s?.name,{maxChatCompletions:l=no}=n||{},c={};for(const e of t.functions)c[e.name||e.function.name]=e;const u=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,function_call:s,functions:u,messages:[...this.messages]},n),a=t.choices[0]?.message;if(!a)throw new ta("missing message in ChatCompletion response");if(!a.function_call)return;const{name:l,arguments:d}=a.function_call,h=c[l];if(!h){const e=`Invalid function_call: ${JSON.stringify(l)}. Available options are: ${u.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:r,name:l,content:e});continue}if(o&&o!==l){const e=`Invalid function_call: ${JSON.stringify(l)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:l,content:e});continue}let p;try{p=_i(h)?await h.parse(d):d}catch(e){this._addMessage({role:r,name:l,content:e instanceof Error?e.message:String(e)});continue}const f=await h.function(p,this),m=to(this,Vi,"m",eo).call(this,f);if(this._addMessage({role:r,name:l,content:m}),o)return}}async _runTools(e,t,n){const r="tool",{tool_choice:s="auto",stream:a,...i}=t,o="string"!=typeof s&&s?.function?.name,{maxChatCompletions:l=no}=n||{},c=t.tools.map((e=>{if(qi(e)){if(!e.$callback)throw new ta("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e})),u={};for(const e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const d="tools"in t?c.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:s,tools:d,messages:[...this.messages]},n),a=t.choices[0]?.message;if(!a)throw new ta("missing message in ChatCompletion response");if(!a.tool_calls?.length)return;for(const e of a.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:s}=e.function,a=u[n];if(!a){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(u).map((e=>JSON.stringify(e))).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}if(o&&o!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}let i;try{i=_i(a)?await a.parse(s):s}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:t,content:n});continue}const l=await a.function(i,this),c=to(this,Vi,"m",eo).call(this,l);if(this._addMessage({role:r,tool_call_id:t,content:c}),o)return}}}}Vi=new WeakSet,Gi=function(){return to(this,Vi,"m",Zi).call(this).content??null},Zi=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(ki(t)){const{function_call:e,...n}=t,r={...n,content:t.content??null,refusal:t.refusal??null};return e&&(r.function_call=e),r}}throw new ta("stream ended without producing a ChatCompletionMessage with role=assistant")},Ji=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(ki(t)&&t?.function_call)return t.function_call;if(ki(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},Xi=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ei(t)&&null!=t.content)return t.content;if(Oi(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},Yi=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Qi=function(e){if(null!=e.n&&e.n>1)throw new ta("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},eo=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class so extends ro{static runFunctions(e,t,n){const r=new so,s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,s))),r}static runTools(e,t,n){const r=new so,s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,s))),r}_addMessage(e,t=!0){super._addMessage(e,t),ki(e)&&e.content&&this._emit("content",e.content)}}const ao=1,io=2,oo=4,lo=8,co=16,uo=32,ho=64,po=128,fo=256,mo=511;class go extends Error{}class yo extends Error{}const wo=(e,t)=>{const n=e.length;let r=0;const s=e=>{throw new go(`${e} at position ${r}`)},a=e=>{throw new yo(`${e} at position ${r}`)},i=()=>(d(),r>=n&&s("Unexpected end of input"),'"'===e[r]?o():"{"===e[r]?l():"["===e[r]?c():"null"===e.substring(r,r+4)||co&t&&n-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):"true"===e.substring(r,r+4)||uo&t&&n-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):"false"===e.substring(r,r+5)||uo&t&&n-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):"Infinity"===e.substring(r,r+8)||po&t&&n-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):"-Infinity"===e.substring(r,r+9)||fo&t&&1<n-r&&n-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):"NaN"===e.substring(r,r+3)||ho&t&&n-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):u()),o=()=>{const i=r;let o=!1;for(r++;r<n&&('"'!==e[r]||o&&"\\"===e[r-1]);)o="\\"===e[r]&&!o,r++;if('"'==e.charAt(r))try{return JSON.parse(e.substring(i,++r-Number(o)))}catch(e){a(String(e))}else if(ao&t)try{return JSON.parse(e.substring(i,r-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},l=()=>{r++,d();const a={};try{for(;"}"!==e[r];){if(d(),r>=n&&lo&t)return a;const s=o();d(),r++;try{const e=i();Object.defineProperty(a,s,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(lo&t)return a;throw e}d(),","===e[r]&&r++}}catch(e){if(lo&t)return a;s("Expected '}' at end of object")}return r++,a},c=()=>{r++;const n=[];try{for(;"]"!==e[r];)n.push(i()),d(),","===e[r]&&r++}catch(e){if(oo&t)return n;s("Expected ']' at end of array")}return r++,n},u=()=>{if(0===r){"-"===e&&io&t&&s("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(io&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}a(String(n))}}const i=r;for("-"===e[r]&&r++;e[r]&&!",]}".includes(e[r]);)r++;r!=n||io&t||s("Unterminated number literal");try{return JSON.parse(e.substring(i,r))}catch(n){"-"===e.substring(i,r)&&io&t&&s("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){a(String(e))}}},d=()=>{for(;r<n&&" \n\r\t".includes(e[r]);)r++};return i()},bo=e=>function(e,t=mo){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return wo(e.trim(),t)}(e,mo^io);var vo,_o,ko,Eo,Oo,To,So,Ao,Io,xo,Po,Co,No=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},Ro=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class $o extends ro{constructor(e){super(),vo.add(this),_o.set(this,void 0),ko.set(this,void 0),Eo.set(this,void 0),No(this,_o,e,"f"),No(this,ko,[],"f")}get currentChatCompletionSnapshot(){return Ro(this,Eo,"f")}static fromReadableStream(e){const t=new $o(null);return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const r=new $o(t);return r._run((()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Ro(this,vo,"m",Oo).call(this);const s=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of s)Ro(this,vo,"m",So).call(this,e);if(s.controller.signal?.aborted)throw new ra;return this._addChatCompletion(Ro(this,vo,"m",xo).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),Ro(this,vo,"m",Oo).call(this),this._connected();const r=ya.fromReadableStream(e,this.controller);let s;for await(const e of r)s&&s!==e.id&&this._addChatCompletion(Ro(this,vo,"m",xo).call(this)),Ro(this,vo,"m",So).call(this,e),s=e.id;if(r.controller.signal?.aborted)throw new ra;return this._addChatCompletion(Ro(this,vo,"m",xo).call(this))}[(_o=new WeakMap,ko=new WeakMap,Eo=new WeakMap,vo=new WeakSet,Oo=function(){this.ended||No(this,Eo,void 0,"f")},To=function(e){let t=Ro(this,ko,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Ro(this,ko,"f")[e.index]=t,t)},So=function(e){if(this.ended)return;const t=Ro(this,vo,"m",Co).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const r=Ro(this,vo,"m",To).call(this,e);e.finish_reason&&(Ro(this,vo,"m",Io).call(this,e),null!=r.current_tool_call_index&&Ro(this,vo,"m",Ao).call(this,e,r.current_tool_call_index));for(const t of n.delta.tool_calls??[])r.current_tool_call_index!==t.index&&(Ro(this,vo,"m",Io).call(this,e),null!=r.current_tool_call_index&&Ro(this,vo,"m",Ao).call(this,e,r.current_tool_call_index)),r.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type&&this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}))}}},Ao=function(e,t){if(Ro(this,vo,"m",To).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=Ro(this,_o,"f")?.tools?.find((e=>"function"===e.type&&e.function.name===n.function.name));this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:qi(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},Io=function(e){const t=Ro(this,vo,"m",To).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=Ro(this,vo,"m",Po).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},xo=function(){if(this.ended)throw new ta("stream has ended, this shouldn't happen");const e=Ro(this,Eo,"f");if(!e)throw new ta("request ended without sending any chunks");return No(this,Eo,void 0,"f"),No(this,ko,[],"f"),function(e,t){const{id:n,choices:r,created:s,model:a,system_fingerprint:i,...o}=e,l={...o,id:n,choices:r.map((({message:t,finish_reason:n,index:r,logprobs:s,...a})=>{if(!n)throw new ta(`missing finish_reason for choice ${r}`);const{content:i=null,function_call:o,tool_calls:l,...c}=t,u=t.role;if(!u)throw new ta(`missing role for choice ${r}`);if(o){const{arguments:e,name:l}=o;if(null==e)throw new ta(`missing function_call.arguments for choice ${r}`);if(!l)throw new ta(`missing function_call.name for choice ${r}`);return{...a,message:{content:i,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}}return l?{...a,index:r,finish_reason:n,logprobs:s,message:{...c,role:u,content:i,refusal:t.refusal??null,tool_calls:l.map(((t,n)=>{const{function:s,type:a,id:i,...o}=t,{arguments:l,name:c,...u}=s||{};if(null==i)throw new ta(`missing choices[${r}].tool_calls[${n}].id\n${jo(e)}`);if(null==a)throw new ta(`missing choices[${r}].tool_calls[${n}].type\n${jo(e)}`);if(null==c)throw new ta(`missing choices[${r}].tool_calls[${n}].function.name\n${jo(e)}`);if(null==l)throw new ta(`missing choices[${r}].tool_calls[${n}].function.arguments\n${jo(e)}`);return{...o,id:i,type:a,function:{...u,name:c,arguments:l}}}))}}:{...a,message:{...c,content:i,role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}})),created:s,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&Ki(t)?Hi(e,t):{...e,choices:e.choices.map((e=>({...e,message:{...e.message,parsed:null,tool_calls:e.message.tool_calls??[]}})))}}(l,t)}(e,Ro(this,_o,"f"))},Po=function(){const e=Ro(this,_o,"f")?.response_format;return Bi(e)?e:null},Co=function(e){var t,n,r,s;let a=Ro(this,Eo,"f");const{choices:i,...o}=e;a?Object.assign(a,o):a=No(this,Eo,{...o,choices:[]},"f");for(const{delta:i,finish_reason:o,index:l,logprobs:c=null,...u}of e.choices){let e=a.choices[l];if(e||(e=a.choices[l]={finish_reason:o,index:l,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:r,refusal:s,...a}=c;Object.assign(e.logprobs,a),r&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...r)),s&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...s))}else e.logprobs=Object.assign({},c);if(o&&(e.finish_reason=o,Ro(this,_o,"f")&&Ki(Ro(this,_o,"f")))){if("length"===o)throw new fa;if("content_filter"===o)throw new ma}if(Object.assign(e,u),!i)continue;const{content:d,refusal:h,function_call:p,role:f,tool_calls:m,...g}=i;if(Object.assign(e.message,g),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((r=e.message.function_call).arguments??(r.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&Ro(this,vo,"m",Po).call(this)&&(e.message.parsed=bo(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:r,function:a,...i}of m){const o=(s=e.message.tool_calls)[t]??(s[t]={});Object.assign(o,i),n&&(o.id=n),r&&(o.type=r),a&&(o.function??(o.function={name:a.name??"",arguments:""})),a?.name&&(o.function.name=a.name),a?.arguments&&(o.function.arguments+=a.arguments,Wi(Ro(this,_o,"f"),o)&&(o.function.parsed_arguments=bo(o.function.arguments)))}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new ya(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function jo(e){return JSON.stringify(e)}class Lo extends $o{static fromReadableStream(e){const t=new Lo(null);return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const r=new Lo(null),s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,s))),r}static runTools(e,t,n){const r=new Lo(t),s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,s))),r}}let Mo=class extends ui{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new ta(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new ta(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap((t=>Hi(t,e)))}runFunctions(e,t){return e.stream?Lo.runFunctions(this._client,e,t):so.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?Lo.runTools(this._client,e,t):so.runTools(this._client,e,t)}stream(e,t){return $o.createChatCompletion(this._client,e,t)}};class Do extends ui{constructor(){super(...arguments),this.completions=new Mo(this._client)}}!function(e){e.Completions=Mo}(Do||(Do={}));var Uo,Fo,Bo,qo,Ho,zo,Wo,Ko,Vo,Go,Zo,Jo,Xo,Yo,Qo,el,tl,nl,rl,sl,al,il,ol=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},ll=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n};class cl extends Fi{constructor(){super(...arguments),Uo.add(this),Fo.set(this,[]),Bo.set(this,{}),qo.set(this,{}),Ho.set(this,void 0),zo.set(this,void 0),Wo.set(this,void 0),Ko.set(this,void 0),Vo.set(this,void 0),Go.set(this,void 0),Zo.set(this,void 0),Jo.set(this,void 0),Xo.set(this,void 0)}[(Fo=new WeakMap,Bo=new WeakMap,qo=new WeakMap,Ho=new WeakMap,zo=new WeakMap,Wo=new WeakMap,Ko=new WeakMap,Vo=new WeakMap,Go=new WeakMap,Zo=new WeakMap,Jo=new WeakMap,Xo=new WeakMap,Uo=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new cl;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const r=ya.fromReadableStream(e,this.controller);for await(const e of r)ol(this,Uo,"m",Yo).call(this,e);if(r.controller.signal?.aborted)throw new ra;return this._addRun(ol(this,Uo,"m",Qo).call(this))}toReadableStream(){return new ya(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,s){const a=new cl;return a._run((()=>a._runToolAssistantStream(e,t,n,r,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}}))),a}async _createToolAssistantStream(e,t,n,r,s){const a=s?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",(()=>this.controller.abort())));const i={...r,stream:!0},o=await e.submitToolOutputs(t,n,i,{...s,signal:this.controller.signal});this._connected();for await(const e of o)ol(this,Uo,"m",Yo).call(this,e);if(o.controller.signal?.aborted)throw new ra;return this._addRun(ol(this,Uo,"m",Qo).call(this))}static createThreadAssistantStream(e,t,n){const r=new cl;return r._run((()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}static createAssistantStream(e,t,n,r){const s=new cl;return s._run((()=>s._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}currentEvent(){return ol(this,Zo,"f")}currentRun(){return ol(this,Jo,"f")}currentMessageSnapshot(){return ol(this,Ho,"f")}currentRunStepSnapshot(){return ol(this,Xo,"f")}async finalRunSteps(){return await this.done(),Object.values(ol(this,Bo,"f"))}async finalMessages(){return await this.done(),Object.values(ol(this,qo,"f"))}async finalRun(){if(await this.done(),!ol(this,zo,"f"))throw Error("Final run was not received.");return ol(this,zo,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const s={...t,stream:!0},a=await e.createAndRun(s,{...n,signal:this.controller.signal});this._connected();for await(const e of a)ol(this,Uo,"m",Yo).call(this,e);if(a.controller.signal?.aborted)throw new ra;return this._addRun(ol(this,Uo,"m",Qo).call(this))}async _createAssistantStream(e,t,n,r){const s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const a={...n,stream:!0},i=await e.create(t,a,{...r,signal:this.controller.signal});this._connected();for await(const e of i)ol(this,Uo,"m",Yo).call(this,e);if(i.controller.signal?.aborted)throw new ra;return this._addRun(ol(this,Uo,"m",Qo).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else{if(!oi(t)||!oi(r)){if(Array.isArray(t)&&Array.isArray(r)){if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...r);continue}for(const e of r){if(!oi(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const r=t[n];null==r?t.push(e):t[n]=this.accumulateDelta(r,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`)}t=this.accumulateDelta(t,r)}e[n]=t}else e[n]=r;else e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,s){return await this._createToolAssistantStream(n,e,t,r,s)}}Yo=function(e){if(!this.ended)switch(ll(this,Zo,e,"f"),ol(this,Uo,"m",nl).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":ol(this,Uo,"m",il).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ol(this,Uo,"m",tl).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":ol(this,Uo,"m",el).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},Qo=function(){if(this.ended)throw new ta("stream has ended, this shouldn't happen");if(!ol(this,zo,"f"))throw Error("Final run has not been received");return ol(this,zo,"f")},el=function(e){const[t,n]=ol(this,Uo,"m",sl).call(this,e,ol(this,Ho,"f"));ll(this,Ho,t,"f"),ol(this,qo,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=ol(this,Wo,"f")){if(ol(this,Ko,"f"))switch(ol(this,Ko,"f").type){case"text":this._emit("textDone",ol(this,Ko,"f").text,ol(this,Ho,"f"));break;case"image_file":this._emit("imageFileDone",ol(this,Ko,"f").image_file,ol(this,Ho,"f"))}ll(this,Wo,n.index,"f")}ll(this,Ko,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==ol(this,Wo,"f")){const t=e.data.content[ol(this,Wo,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,ol(this,Ho,"f"));break;case"text":this._emit("textDone",t.text,ol(this,Ho,"f"))}}ol(this,Ho,"f")&&this._emit("messageDone",e.data),ll(this,Ho,void 0,"f")}},tl=function(e){const t=ol(this,Uo,"m",rl).call(this,e);switch(ll(this,Xo,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==ol(this,Vo,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(ol(this,Go,"f")&&this._emit("toolCallDone",ol(this,Go,"f")),ll(this,Vo,e.index,"f"),ll(this,Go,t.step_details.tool_calls[e.index],"f"),ol(this,Go,"f")&&this._emit("toolCallCreated",ol(this,Go,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ll(this,Xo,void 0,"f");"tool_calls"==e.data.step_details.type&&ol(this,Go,"f")&&(this._emit("toolCallDone",ol(this,Go,"f")),ll(this,Go,void 0,"f")),this._emit("runStepDone",e.data,t)}},nl=function(e){ol(this,Fo,"f").push(e),this._emit("event",e)},rl=function(e){switch(e.event){case"thread.run.step.created":return ol(this,Bo,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=ol(this,Bo,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=cl.accumulateDelta(t,n.delta);ol(this,Bo,"f")[e.data.id]=r}return ol(this,Bo,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":ol(this,Bo,"f")[e.data.id]=e.data}if(ol(this,Bo,"f")[e.data.id])return ol(this,Bo,"f")[e.data.id];throw new Error("No snapshot available")},sl=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=ol(this,Uo,"m",al).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},al=function(e,t){return cl.accumulateDelta(t,e)},il=function(e){switch(ll(this,Jo,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":ll(this,zo,e.data,"f"),ol(this,Go,"f")&&(this._emit("toolCallDone",ol(this,Go,"f")),ll(this,Go,void 0,"f"))}};let ul=class extends ui{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return qa(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,dl,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}};class dl extends ci{}ul.MessagesPage=dl;class hl extends ui{retrieve(e,t,n,r={},s){return qa(r)?this.retrieve(e,t,n,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t,n={},r){return qa(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,pl,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class pl extends ci{}hl.RunStepsPage=pl;class fl extends ui{constructor(){super(...arguments),this.steps=new hl(this._client)}create(e,t,n){const{include:r,...s}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return qa(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,ml,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return cl.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:s,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Xa(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,n){return cl.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const s=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,s.id,r)}submitToolOutputsStream(e,t,n,r){return cl.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}}class ml extends ci{}fl.RunsPage=ml,fl.Steps=hl,fl.RunStepsPage=pl;class gl extends ui{constructor(){super(...arguments),this.runs=new fl(this._client),this.messages=new ul(this._client)}create(e={},t){return qa(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return cl.createThreadAssistantStream(e,this._client.beta.threads,t)}}gl.Runs=fl,gl.RunsPage=ml,gl.Messages=ul,gl.MessagesPage=dl;let yl=class extends ui{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return qa(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,wl,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const s=await this.retrieve(e,t,{...n,headers:r}).withResponse(),a=s.data;switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Xa(e);break;case"failed":case"completed":return a}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}};class wl extends ci{}yl.VectorStoreFilesPage=wl;class bl extends ui{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return qa(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,wl,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:s,response:a}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await Xa(e);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const s=r?.maxConcurrency??5,a=Math.min(s,t.length),i=this._client,o=t.values(),l=[...n];const c=Array(a).fill(o).map((async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},r);l.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(c),await this.createAndPoll(e,{file_ids:l})}}class vl extends ui{constructor(){super(...arguments),this.files=new yl(this._client),this.fileBatches=new bl(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return qa(e)?this.list({},e):this._client.getAPIList("/vector_stores",_l,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class _l extends ci{}vl.VectorStoresPage=_l,vl.Files=yl,vl.VectorStoreFilesPage=wl,vl.FileBatches=bl;class kl extends ui{constructor(){super(...arguments),this.vectorStores=new vl(this._client),this.chat=new Do(this._client),this.assistants=new bi(this._client),this.threads=new gl(this._client)}}kl.VectorStores=vl,kl.VectorStoresPage=_l,kl.Assistants=bi,kl.AssistantsPage=vi,kl.Threads=gl;let El=class extends ui{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};class Ol extends ui{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}class Tl extends ui{create(e,t){return this._client.post("/files",Ia({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return qa(e)?this.list({},e):this._client.getAPIList("/files",Sl,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),s=Date.now();let a=await this.retrieve(e);for(;!a.status||!r.has(a.status);)if(await Xa(t),a=await this.retrieve(e),Date.now()-s>n)throw new aa({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}}class Sl extends ci{}Tl.FileObjectsPage=Sl;class Al extends ui{list(e,t={},n){return qa(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,Il,{query:t,...n})}}class Il extends ci{}Al.FineTuningJobCheckpointsPage=Il;class xl extends ui{constructor(){super(...arguments),this.checkpoints=new Al(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return qa(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Pl,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return qa(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Cl,{query:t,...n})}}class Pl extends ci{}class Cl extends ci{}xl.FineTuningJobsPage=Pl,xl.FineTuningJobEventsPage=Cl,xl.Checkpoints=Al,xl.FineTuningJobCheckpointsPage=Il;class Nl extends ui{constructor(){super(...arguments),this.jobs=new xl(this._client)}}Nl.Jobs=xl,Nl.FineTuningJobsPage=Pl,Nl.FineTuningJobEventsPage=Cl;class Rl extends ui{createVariation(e,t){return this._client.post("/images/variations",Ia({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Ia({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class $l extends ui{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",jl,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class jl extends li{}$l.ModelsPage=jl;class Ll extends ui{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class Ml extends ui{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,Ia({body:t,...n}))}}class Dl extends ui{constructor(){super(...arguments),this.parts=new Ml(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}var Ul;Dl.Parts=Ml;let Fl=class extends Ma{constructor({baseURL:e=ei("OPENAI_BASE_URL"),apiKey:t=ei("OPENAI_API_KEY"),organization:n=ei("OPENAI_ORG_ID")??null,project:r=ei("OPENAI_PROJECT_ID")??null,...s}={}){if(void 0===t)throw new ta("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:n,project:r,...s,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new ta("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new El(this),this.chat=new hi(this),this.embeddings=new Ol(this),this.files=new Tl(this),this.images=new Rl(this),this.audio=new gi(this),this.moderations=new Ll(this),this.models=new $l(this),this.fineTuning=new Nl(this),this.beta=new kl(this),this.batches=new yi(this),this.uploads=new Dl(this),this._options=a,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return qs(e,{arrayFormat:"brackets"})}};function Bl(e,t=ql){e=e.trim();const n=/```(json)?(.*)```/s.exec(e);return t(n?n[2]:e)}function ql(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,s=!1;for(let a of e){if(r)'"'!==a||s?"\n"!==a||s?s="\\"===a&&!s:a="\\n":r=!1;else if('"'===a)r=!0,s=!1;else if("{"===a)n.push("}");else if("["===a)n.push("]");else if("}"===a||"]"===a){if(!n||n[n.length-1]!==a)return null;n.pop()}t+=a}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}Ul=Fl,Fl.OpenAI=Ul,Fl.DEFAULT_TIMEOUT=6e5,Fl.OpenAIError=ta,Fl.APIError=na,Fl.APIConnectionError=sa,Fl.APIConnectionTimeoutError=aa,Fl.APIUserAbortError=ra,Fl.NotFoundError=ca,Fl.ConflictError=ua,Fl.RateLimitError=ha,Fl.BadRequestError=ia,Fl.AuthenticationError=oa,Fl.InternalServerError=pa,Fl.PermissionDeniedError=la,Fl.UnprocessableEntityError=da,Fl.toFile=Oa,Fl.fileFromPath=Xs,Fl.Completions=El,Fl.Chat=hi,Fl.Embeddings=Ol,Fl.Files=Tl,Fl.FileObjectsPage=Sl,Fl.Images=Rl,Fl.Audio=gi,Fl.Moderations=Ll,Fl.Models=$l,Fl.ModelsPage=jl,Fl.FineTuning=Nl,Fl.Beta=kl,Fl.Batches=yi,Fl.BatchesPage=wi,Fl.Uploads=Dl;var Hl=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()},zl=o(Hl),Wl={exports:{}};const Kl=/[\p{Lu}]/u,Vl=/[\p{Ll}]/u,Gl=/^[\p{Lu}](?![\p{Lu}])/gu,Zl=/([\p{Alpha}\p{N}_]|$)/u,Jl=/[_.\- ]+/,Xl=new RegExp("^"+Jl.source),Yl=new RegExp(Jl.source+Zl.source,"gu"),Ql=new RegExp("\\d+"+Zl.source,"gu"),ec=(e,t)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(t={pascalCase:!1,preserveConsecutiveUppercase:!1,...t},e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim(),0===e.length)return"";const n=!1===t.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(t.locale),r=!1===t.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(t.locale);if(1===e.length)return t.pascalCase?r(e):n(e);return e!==n(e)&&(e=((e,t,n)=>{let r=!1,s=!1,a=!1;for(let i=0;i<e.length;i++){const o=e[i];r&&Kl.test(o)?(e=e.slice(0,i)+"-"+e.slice(i),r=!1,a=s,s=!0,i++):s&&a&&Vl.test(o)?(e=e.slice(0,i-1)+"-"+e.slice(i-1),a=s,s=!1,r=!0):(r=t(o)===o&&n(o)!==o,a=s,s=n(o)===o&&t(o)!==o)}return e})(e,n,r)),e=e.replace(Xl,""),e=t.preserveConsecutiveUppercase?((e,t)=>(Gl.lastIndex=0,e.replace(Gl,(e=>t(e)))))(e,n):n(e),t.pascalCase&&(e=r(e.charAt(0))+e.slice(1)),((e,t)=>(Yl.lastIndex=0,Ql.lastIndex=0,e.replace(Yl,((e,n)=>t(n))).replace(Ql,(e=>t(e)))))(e,r)};function tc(e,t){return t?.[e]||zl(e)}function nc(e,t,n){const r={};for(const s in e)Object.hasOwn(e,s)&&(r[t(s,n)]=e[s]);return r}function rc(e){return Array.isArray(e)?[...e]:{...e}}function sc(e,t){const n=rc(e);for(const[e,r]of Object.entries(t)){const[t,...s]=e.split(".").reverse();let a=n;for(const e of s.reverse()){if(void 0===a[e])break;a[e]=rc(a[e]),a=a[e]}void 0!==a[t]&&(a[t]={lc:1,type:"secret",id:[r]})}return n}function ac(e){const t=Object.getPrototypeOf(e);return"function"==typeof e.lc_name&&("function"!=typeof t.lc_name||e.lc_name()!==t.lc_name())?e.lc_name():e.name}Wl.exports=ec,Wl.exports.default=ec;class ic{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ac(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof ic||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=n;const[s,...a]=e.split(".").reverse();for(const e of a.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}s in t&&void 0!==t[s]&&(r[s]=r[s]||t[s])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:nc(Object.keys(t).length?sc(n,t):n,tc,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function oc(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?uc(e,t)??[...e,...t]:[...e,{type:"text",text:t}]}class lc extends ic{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function cc(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e]){if("type"===e)continue;n[e]+=r}else if("object"!=typeof n[e]||Array.isArray(n[e]))if(Array.isArray(n[e]))n[e]=uc(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=cc(n[e],r)}return n}function uc(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex((t=>t.index===e.index));-1!==t?n[t]=cc(n[t],e):n.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;n.push(e)}return n}}}function dc(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(e&&t){if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return uc(e,t);if("object"==typeof e&&"object"==typeof t)return cc(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}return e||t}class hc extends lc{}function pc(e){return"function"==typeof e?._getType}class fc extends hc{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new fc({content:oc(this.content,e.content),additional_kwargs:cc(this.additional_kwargs,e.additional_kwargs),response_metadata:cc(this.response_metadata,e.response_metadata),artifact:dc(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id})}}class mc extends lc{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=function(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}}function gc(e){return"ai"===e._getType()}class yc extends hc{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{const n=[],r=[];for(const t of e.tool_call_chunks){let e={};try{if(e=ql(t.args??"{}")??{},"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");n.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){r.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:n,invalid_tool_calls:r}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:oc(this.content,e.content),additional_kwargs:cc(this.additional_kwargs,e.additional_kwargs),response_metadata:cc(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=uc(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const n=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},r=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:n.input_tokens+r.input_tokens,output_tokens:n.output_tokens+r.output_tokens,total_tokens:n.total_tokens+r.total_tokens};t.usage_metadata=s}return new yc(t)}}class wc extends lc{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return wc}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}class bc extends hc{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new bc({content:oc(this.content,e.content),additional_kwargs:cc(this.additional_kwargs,e.additional_kwargs),response_metadata:cc(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}}class vc extends hc{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new vc({content:oc(this.content,e.content),additional_kwargs:cc(this.additional_kwargs,e.additional_kwargs),response_metadata:cc(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class _c extends lc{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class kc extends hc{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new kc({content:oc(this.content,e.content),additional_kwargs:cc(this.additional_kwargs,e.additional_kwargs),response_metadata:cc(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class Ec extends lc{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Oc extends hc{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Oc({content:oc(this.content,e.content),additional_kwargs:cc(this.additional_kwargs,e.additional_kwargs),response_metadata:cc(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function Tc(e){const{type:t,...n}=e;if("human"===t||"user"===t)return new _c(n);if("ai"===t||"assistant"===t)return new mc(n);if("system"===t)return new Ec(n);throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Sc(e){if("string"==typeof e)return new _c(e);if(pc(e))return e;if(Array.isArray(e)){const[t,n]=e;return Tc({type:t,content:n})}return Tc(e)}function Ac(e,t="Human",n="AI"){const r=[];for(const s of e){let e;if("human"===s._getType())e=t;else if("ai"===s._getType())e=n;else if("system"===s._getType())e="System";else if("function"===s._getType())e="Function";else if("tool"===s._getType())e="Tool";else{if("generic"!==s._getType())throw new Error(`Got unsupported message type: ${s._getType()}`);e=s.role}const a=s.name?`${s.name}, `:"",i="string"==typeof s.content?s.content:JSON.stringify(s.content,null,2);r.push(`${e}: ${a}${i}`)}return r.join("\n")}function Ic(e){const t=e._getType();if("human"===t)return new kc({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map((e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)})))}),new yc({...t})}if("system"===t)return new Oc({...e});if("function"===t)return new vc({...e});if(wc.isInstance(e))return new bc({...e});throw new Error("Unknown message type.")}var xc={exports:{}},Pc={};function Cc(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Nc=Cc;Cc.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},Cc.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},Cc.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},Cc.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},Cc.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},Cc.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},Cc.prototype.start=Cc.prototype.try,Cc.prototype.errors=function(){return this._errors},Cc.prototype.attempts=function(){return this._attempts},Cc.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,i=(e[a]||0)+1;e[a]=i,i>=n&&(t=s,n=i)}return t},function(e){var t=Nc;e.operation=function(n){var r=e.timeouts(n);return new t(r,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})},e.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<t.retries;s++)r.push(this.createTimeout(s,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(s,t)),r.sort((function(e,t){return e-t})),r},e.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout)},e.wrap=function(t,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var s in r=[],t)"function"==typeof t[s]&&r.push(s);for(var a=0;a<r.length;a++){var i=r[a],o=t[i];t[i]=function(r){var s=e.operation(n),a=Array.prototype.slice.call(arguments,1),i=a.pop();a.push((function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),i.apply(this,arguments))})),s.attempt((function(){r.apply(t,a)}))}.bind(t,o),t[i].options=n}}}(Pc);const Rc=Pc,$c=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class jc extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const Lc=(e,t)=>new Promise(((n,r)=>{t={onFailedAttempt:()=>{},retries:10,...t};const s=Rc.operation(t);s.attempt((async a=>{try{n(await e(a))}catch(e){if(!(e instanceof Error))return void r(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof jc)s.stop(),r(e.originalError);else if(e instanceof TypeError&&(i=e.message,!$c.includes(i)))s.stop(),r(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,a,t);try{await t.onFailedAttempt(e)}catch(e){return void r(e)}s.retry(e)||r(s.mainError())}}var i}))}));xc.exports=Lc,xc.exports.default=Lc,xc.exports.AbortError=jc;var Mc=o(xc.exports),Dc={},Uc={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,i){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||i(this,a);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[a]=1===c.length?c[0]:c:i(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(Uc);var Fc=Uc.exports,Bc={exports:{}},qc=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))));const Hc=qc;let zc=class extends Error{constructor(e){super(e),this.name="TimeoutError"}};const Wc=(e,t,n)=>new Promise(((r,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void r(e);const a=setTimeout((()=>{if("function"==typeof n){try{r(n())}catch(e){s(e)}return}const a=n instanceof Error?n:new zc("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(a)}),t);Hc(e.then(r,s),(()=>{clearTimeout(a)}))}));Bc.exports=Wc,Bc.exports.default=Wc,Bc.exports.TimeoutError=zc;var Kc=Bc.exports,Vc={},Gc={};Object.defineProperty(Gc,"__esModule",{value:!0}),Gc.default=function(e,t,n){let r=0,s=e.length;for(;s>0;){const a=s/2|0;let i=r+a;n(e[i],t)<=0?(r=++i,s-=a+1):s=a}return r},Object.defineProperty(Vc,"__esModule",{value:!0});const Zc=Gc;Vc.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const r=Zc.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(r,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}},Object.defineProperty(Dc,"__esModule",{value:!0});const Jc=Fc,Xc=Kc,Yc=Vc,Qc=()=>{},eu=new Xc.TimeoutError;var tu=Dc.default=class extends Jc{constructor(e){var t,n,r,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Qc,this._resolveIdle=Qc,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Yc.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(s=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==s?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Qc,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=Qc,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():Xc.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(eu)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};const nu=(...e)=>fetch(...e),ru=Symbol.for("ls:fetch_implementation"),su=()=>globalThis[ru]??nu,au=[400,401,403,404,405,406,407,408],iu=[409];let ou=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue="default"in tu?new tu.default({concurrency:this.maxConcurrency}):new tu({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add((()=>Mc((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(au.includes(+r))throw e;if(iu.includes(+r))return;n&&await n(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>su()(...e).then((e=>e.ok?e:Promise.reject(e)))))}};function lu(e){return"function"==typeof e?._getType}function cu(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}function uu(t,n){if(!e.validate(t)){throw new Error(void 0!==n?`Invalid UUID for ${n}: ${t}`:`Invalid UUID: ${t}`)}return t}const du={};var hu={exports:{}};var pu={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||9007199254740991,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2};var fu="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};!function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=pu,a=fu,i=(t=e.exports={}).re=[],o=t.safeRe=[],l=t.src=[],c=t.t={};let u=0;const d="[a-zA-Z0-9-]",h=[["\\s",1],["\\d",s],[d,r]],p=(e,t,n)=>{const r=(e=>{for(const[t,n]of h)e=e.split(`${t}*`).join(`${t}{0,${n}}`).split(`${t}+`).join(`${t}{1,${n}}`);return e})(t),s=u++;a(e,s,t),c[e]=s,l[s]=t,i[s]=new RegExp(t,n?"g":void 0),o[s]=new RegExp(r,n?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),p("MAINVERSION",`(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${l[c.NUMERICIDENTIFIER]}|${l[c.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${l[c.NUMERICIDENTIFIERLOOSE]}|${l[c.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${l[c.PRERELEASEIDENTIFIER]}(?:\\.${l[c.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${l[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[c.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${d}+`),p("BUILD",`(?:\\+(${l[c.BUILDIDENTIFIER]}(?:\\.${l[c.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${l[c.MAINVERSION]}${l[c.PRERELEASE]}?${l[c.BUILD]}?`),p("FULL",`^${l[c.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${l[c.MAINVERSIONLOOSE]}${l[c.PRERELEASELOOSE]}?${l[c.BUILD]}?`),p("LOOSE",`^${l[c.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${l[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${l[c.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:${l[c.PRERELEASE]})?${l[c.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:${l[c.PRERELEASELOOSE]})?${l[c.BUILD]}?)?)?`),p("XRANGE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),p("COERCE",`${l[c.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",l[c.COERCEPLAIN]+`(?:${l[c.PRERELEASE]})?`+`(?:${l[c.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",l[c.COERCE],!0),p("COERCERTLFULL",l[c.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${l[c.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",p("TILDE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${l[c.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",p("CARET",`^${l[c.LONECARET]}${l[c.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${l[c.LONECARET]}${l[c.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${l[c.GTLT]}\\s*(${l[c.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]}|${l[c.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${l[c.XRANGEPLAIN]})\\s+-\\s+(${l[c.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${l[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[c.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(hu,hu.exports);var mu=hu.exports;const gu=Object.freeze({loose:!0}),yu=Object.freeze({});var wu=e=>e?"object"!=typeof e?gu:e:yu;const bu=/^[0-9]+$/,vu=(e,t)=>{const n=bu.test(e),r=bu.test(t);return n&&r&&(e=+e,t=+t),e===t?0:n&&!r?-1:r&&!n?1:e<t?-1:1};var _u={compareIdentifiers:vu,rcompareIdentifiers:(e,t)=>vu(t,e)};const ku=fu,{MAX_LENGTH:Eu,MAX_SAFE_INTEGER:Ou}=pu,{safeRe:Tu,t:Su}=mu,Au=wu,{compareIdentifiers:Iu}=_u;var xu=class e{constructor(t,n){if(n=Au(n),t instanceof e){if(t.loose===!!n.loose&&t.includePrerelease===!!n.includePrerelease)return t;t=t.version}else if("string"!=typeof t)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof t}".`);if(t.length>Eu)throw new TypeError(`version is longer than ${Eu} characters`);ku("SemVer",t,n),this.options=n,this.loose=!!n.loose,this.includePrerelease=!!n.includePrerelease;const r=t.trim().match(n.loose?Tu[Su.LOOSE]:Tu[Su.FULL]);if(!r)throw new TypeError(`Invalid Version: ${t}`);if(this.raw=t,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Ou||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Ou||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Ou||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<Ou)return t}return e})):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(t){if(ku("SemVer.compare",this.version,this.options,t),!(t instanceof e)){if("string"==typeof t&&t===this.version)return 0;t=new e(t,this.options)}return t.version===this.version?0:this.compareMain(t)||this.comparePre(t)}compareMain(t){return t instanceof e||(t=new e(t,this.options)),Iu(this.major,t.major)||Iu(this.minor,t.minor)||Iu(this.patch,t.patch)}comparePre(t){if(t instanceof e||(t=new e(t,this.options)),this.prerelease.length&&!t.prerelease.length)return-1;if(!this.prerelease.length&&t.prerelease.length)return 1;if(!this.prerelease.length&&!t.prerelease.length)return 0;let n=0;do{const e=this.prerelease[n],r=t.prerelease[n];if(ku("prerelease compare",n,e,r),void 0===e&&void 0===r)return 0;if(void 0===r)return 1;if(void 0===e)return-1;if(e!==r)return Iu(e,r)}while(++n)}compareBuild(t){t instanceof e||(t=new e(t,this.options));let n=0;do{const e=this.build[n],r=t.build[n];if(ku("build compare",n,e,r),void 0===e&&void 0===r)return 0;if(void 0===r)return 1;if(void 0===e)return-1;if(e!==r)return Iu(e,r)}while(++n)}inc(e,t,n){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(n)?1:0;if(!t&&!1===n)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let r=this.prerelease.length;for(;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);if(-1===r){if(t===this.prerelease.join(".")&&!1===n)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let r=[t,e];!1===n&&(r=[t]),0===Iu(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=r):this.prerelease=r}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};const Pu=xu;var Cu=(e,t,n=!1)=>{if(e instanceof Pu)return e;try{return new Pu(e,t)}catch(e){if(!n)return null;throw e}};const Nu=Cu;var Ru=(e,t)=>{const n=Nu(e,t);return n?n.version:null};const $u=Cu;var ju=(e,t)=>{const n=$u(e.trim().replace(/^[=v]+/,""),t);return n?n.version:null};const Lu=xu;var Mu=(e,t,n,r,s)=>{"string"==typeof n&&(s=r,r=n,n=void 0);try{return new Lu(e instanceof Lu?e.version:e,n).inc(t,r,s).version}catch(e){return null}};const Du=Cu;var Uu=(e,t)=>{const n=Du(e,null,!0),r=Du(t,null,!0),s=n.compare(r);if(0===s)return null;const a=s>0,i=a?n:r,o=a?r:n,l=!!i.prerelease.length;if(!!o.prerelease.length&&!l)return o.patch||o.minor?i.patch?"patch":i.minor?"minor":"major":"major";const c=l?"pre":"";return n.major!==r.major?c+"major":n.minor!==r.minor?c+"minor":n.patch!==r.patch?c+"patch":"prerelease"};const Fu=xu;var Bu=(e,t)=>new Fu(e,t).major;const qu=xu;var Hu=(e,t)=>new qu(e,t).minor;const zu=xu;var Wu=(e,t)=>new zu(e,t).patch;const Ku=Cu;var Vu=(e,t)=>{const n=Ku(e,t);return n&&n.prerelease.length?n.prerelease:null};const Gu=xu;var Zu=(e,t,n)=>new Gu(e,n).compare(new Gu(t,n));const Ju=Zu;var Xu=(e,t,n)=>Ju(t,e,n);const Yu=Zu;var Qu=(e,t)=>Yu(e,t,!0);const ed=xu;var td=(e,t,n)=>{const r=new ed(e,n),s=new ed(t,n);return r.compare(s)||r.compareBuild(s)};const nd=td;var rd=(e,t)=>e.sort(((e,n)=>nd(e,n,t)));const sd=td;var ad=(e,t)=>e.sort(((e,n)=>sd(n,e,t)));const id=Zu;var od=(e,t,n)=>id(e,t,n)>0;const ld=Zu;var cd=(e,t,n)=>ld(e,t,n)<0;const ud=Zu;var dd=(e,t,n)=>0===ud(e,t,n);const hd=Zu;var pd=(e,t,n)=>0!==hd(e,t,n);const fd=Zu;var md=(e,t,n)=>fd(e,t,n)>=0;const gd=Zu;var yd=(e,t,n)=>gd(e,t,n)<=0;const wd=dd,bd=pd,vd=od,_d=md,kd=cd,Ed=yd;var Od=(e,t,n,r)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e===n;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e!==n;case"":case"=":case"==":return wd(e,n,r);case"!=":return bd(e,n,r);case">":return vd(e,n,r);case">=":return _d(e,n,r);case"<":return kd(e,n,r);case"<=":return Ed(e,n,r);default:throw new TypeError(`Invalid operator: ${t}`)}};const Td=xu,Sd=Cu,{safeRe:Ad,t:Id}=mu;var xd=(e,t)=>{if(e instanceof Td)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let n=null;if((t=t||{}).rtl){const r=t.includePrerelease?Ad[Id.COERCERTLFULL]:Ad[Id.COERCERTL];let s;for(;(s=r.exec(e))&&(!n||n.index+n[0].length!==e.length);)n&&s.index+s[0].length===n.index+n[0].length||(n=s),r.lastIndex=s.index+s[1].length+s[2].length;r.lastIndex=-1}else n=e.match(t.includePrerelease?Ad[Id.COERCEFULL]:Ad[Id.COERCE]);if(null===n)return null;const r=n[2],s=n[3]||"0",a=n[4]||"0",i=t.includePrerelease&&n[5]?`-${n[5]}`:"",o=t.includePrerelease&&n[6]?`+${n[6]}`:"";return Sd(`${r}.${s}.${a}${i}${o}`,t)};var Pd,Cd,Nd,Rd,$d=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}};function jd(){if(Cd)return Pd;Cd=1;const e=/\s+/g;class t{constructor(n,a){if(a=r(a),n instanceof t)return n.loose===!!a.loose&&n.includePrerelease===!!a.includePrerelease?n:new t(n.raw,a);if(n instanceof s)return this.raw=n.value,this.set=[[n]],this.formatted=void 0,this;if(this.options=a,this.loose=!!a.loose,this.includePrerelease=!!a.includePrerelease,this.raw=n.trim().replace(e," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!f(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&m(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&h)|(this.options.loose&&p))+":"+e,r=n.get(t);if(r)return r;const i=this.options.loose,m=i?o[l.HYPHENRANGELOOSE]:o[l.HYPHENRANGE];e=e.replace(m,A(this.options.includePrerelease)),a("hyphen replace",e),e=e.replace(o[l.COMPARATORTRIM],c),a("comparator trim",e),e=e.replace(o[l.TILDETRIM],u),a("tilde trim",e),e=e.replace(o[l.CARETTRIM],d),a("caret trim",e);let g=e.split(" ").map((e=>y(e,this.options))).join(" ").split(/\s+/).map((e=>S(e,this.options)));i&&(g=g.filter((e=>(a("loose invalid filter",e,this.options),!!e.match(o[l.COMPARATORLOOSE]))))),a("range list",g);const w=new Map,b=g.map((e=>new s(e,this.options)));for(const e of b){if(f(e))return[e];w.set(e.value,e)}w.size>1&&w.has("")&&w.delete("");const v=[...w.values()];return n.set(t,v),v}intersects(e,n){if(!(e instanceof t))throw new TypeError("a Range is required");return this.set.some((t=>g(t,n)&&e.set.some((e=>g(e,n)&&t.every((t=>e.every((e=>t.intersects(e,n)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new i(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(I(this.set[t],e,this.options))return!0;return!1}}Pd=t;const n=new $d,r=wu,s=Ld(),a=fu,i=xu,{safeRe:o,t:l,comparatorTrimReplace:c,tildeTrimReplace:u,caretTrimReplace:d}=mu,{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:p}=pu,f=e=>"<0.0.0-0"===e.value,m=e=>""===e.value,g=(e,t)=>{let n=!0;const r=e.slice();let s=r.pop();for(;n&&r.length;)n=r.every((e=>s.intersects(e,t))),s=r.pop();return n},y=(e,t)=>(a("comp",e,t),e=_(e,t),a("caret",e),e=b(e,t),a("tildes",e),e=E(e,t),a("xrange",e),e=T(e,t),a("stars",e),e),w=e=>!e||"x"===e.toLowerCase()||"*"===e,b=(e,t)=>e.trim().split(/\s+/).map((e=>v(e,t))).join(" "),v=(e,t)=>{const n=t.loose?o[l.TILDELOOSE]:o[l.TILDE];return e.replace(n,((t,n,r,s,i)=>{let o;return a("tilde",e,t,n,r,s,i),w(n)?o="":w(r)?o=`>=${n}.0.0 <${+n+1}.0.0-0`:w(s)?o=`>=${n}.${r}.0 <${n}.${+r+1}.0-0`:i?(a("replaceTilde pr",i),o=`>=${n}.${r}.${s}-${i} <${n}.${+r+1}.0-0`):o=`>=${n}.${r}.${s} <${n}.${+r+1}.0-0`,a("tilde return",o),o}))},_=(e,t)=>e.trim().split(/\s+/).map((e=>k(e,t))).join(" "),k=(e,t)=>{a("caret",e,t);const n=t.loose?o[l.CARETLOOSE]:o[l.CARET],r=t.includePrerelease?"-0":"";return e.replace(n,((t,n,s,i,o)=>{let l;return a("caret",e,t,n,s,i,o),w(n)?l="":w(s)?l=`>=${n}.0.0${r} <${+n+1}.0.0-0`:w(i)?l="0"===n?`>=${n}.${s}.0${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.0${r} <${+n+1}.0.0-0`:o?(a("replaceCaret pr",o),l="0"===n?"0"===s?`>=${n}.${s}.${i}-${o} <${n}.${s}.${+i+1}-0`:`>=${n}.${s}.${i}-${o} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${i}-${o} <${+n+1}.0.0-0`):(a("no pr"),l="0"===n?"0"===s?`>=${n}.${s}.${i}${r} <${n}.${s}.${+i+1}-0`:`>=${n}.${s}.${i}${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${i} <${+n+1}.0.0-0`),a("caret return",l),l}))},E=(e,t)=>(a("replaceXRanges",e,t),e.split(/\s+/).map((e=>O(e,t))).join(" ")),O=(e,t)=>{e=e.trim();const n=t.loose?o[l.XRANGELOOSE]:o[l.XRANGE];return e.replace(n,((n,r,s,i,o,l)=>{a("xRange",e,n,r,s,i,o,l);const c=w(s),u=c||w(i),d=u||w(o),h=d;return"="===r&&h&&(r=""),l=t.includePrerelease?"-0":"",c?n=">"===r||"<"===r?"<0.0.0-0":"*":r&&h?(u&&(i=0),o=0,">"===r?(r=">=",u?(s=+s+1,i=0,o=0):(i=+i+1,o=0)):"<="===r&&(r="<",u?s=+s+1:i=+i+1),"<"===r&&(l="-0"),n=`${r+s}.${i}.${o}${l}`):u?n=`>=${s}.0.0${l} <${+s+1}.0.0-0`:d&&(n=`>=${s}.${i}.0${l} <${s}.${+i+1}.0-0`),a("xRange return",n),n}))},T=(e,t)=>(a("replaceStars",e,t),e.trim().replace(o[l.STAR],"")),S=(e,t)=>(a("replaceGTE0",e,t),e.trim().replace(o[t.includePrerelease?l.GTE0PRE:l.GTE0],"")),A=e=>(t,n,r,s,a,i,o,l,c,u,d,h)=>`${n=w(r)?"":w(s)?`>=${r}.0.0${e?"-0":""}`:w(a)?`>=${r}.${s}.0${e?"-0":""}`:i?`>=${n}`:`>=${n}${e?"-0":""}`} ${l=w(c)?"":w(u)?`<${+c+1}.0.0-0`:w(d)?`<${c}.${+u+1}.0-0`:h?`<=${c}.${u}.${d}-${h}`:e?`<${c}.${u}.${+d+1}-0`:`<=${l}`}`.trim(),I=(e,t,n)=>{for(let n=0;n<e.length;n++)if(!e[n].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(let n=0;n<e.length;n++)if(a(e[n].semver),e[n].semver!==s.ANY&&e[n].semver.prerelease.length>0){const r=e[n].semver;if(r.major===t.major&&r.minor===t.minor&&r.patch===t.patch)return!0}return!1}return!0};return Pd}function Ld(){if(Rd)return Nd;Rd=1;const e=Symbol("SemVer ANY");class t{static get ANY(){return e}constructor(r,s){if(s=n(s),r instanceof t){if(r.loose===!!s.loose)return r;r=r.value}r=r.trim().split(/\s+/).join(" "),i("comparator",r,s),this.options=s,this.loose=!!s.loose,this.parse(r),this.semver===e?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(t){const n=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],a=t.match(n);if(!a)throw new TypeError(`Invalid comparator: ${t}`);this.operator=void 0!==a[1]?a[1]:"","="===this.operator&&(this.operator=""),a[2]?this.semver=new o(a[2],this.options.loose):this.semver=e}toString(){return this.value}test(t){if(i("Comparator.test",t,this.options.loose),this.semver===e||t===e)return!0;if("string"==typeof t)try{t=new o(t,this.options)}catch(e){return!1}return a(t,this.operator,this.semver,this.options)}intersects(e,r){if(!(e instanceof t))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new l(e.value,r).test(this.value):""===e.operator?""===e.value||new l(this.value,r).test(e.semver):(!(r=n(r)).includePrerelease||"<0.0.0-0"!==this.value&&"<0.0.0-0"!==e.value)&&(!(!r.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&(!(!this.operator.startsWith(">")||!e.operator.startsWith(">"))||(!(!this.operator.startsWith("<")||!e.operator.startsWith("<"))||(!(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))||(!!(a(this.semver,"<",e.semver,r)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))||!!(a(this.semver,">",e.semver,r)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))))))}}Nd=t;const n=wu,{safeRe:r,t:s}=mu,a=Od,i=fu,o=xu,l=jd();return Nd}const Md=jd();var Dd=(e,t,n)=>{try{t=new Md(t,n)}catch(e){return!1}return t.test(e)};const Ud=jd();var Fd=(e,t)=>new Ud(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")));const Bd=xu,qd=jd();var Hd=(e,t,n)=>{let r=null,s=null,a=null;try{a=new qd(t,n)}catch(e){return null}return e.forEach((e=>{a.test(e)&&(r&&-1!==s.compare(e)||(r=e,s=new Bd(r,n)))})),r};const zd=xu,Wd=jd();var Kd=(e,t,n)=>{let r=null,s=null,a=null;try{a=new Wd(t,n)}catch(e){return null}return e.forEach((e=>{a.test(e)&&(r&&1!==s.compare(e)||(r=e,s=new zd(r,n)))})),r};const Vd=xu,Gd=jd(),Zd=od;var Jd=(e,t)=>{e=new Gd(e,t);let n=new Vd("0.0.0");if(e.test(n))return n;if(n=new Vd("0.0.0-0"),e.test(n))return n;n=null;for(let t=0;t<e.set.length;++t){const r=e.set[t];let s=null;r.forEach((e=>{const t=new Vd(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":s&&!Zd(t,s)||(s=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!s||n&&!Zd(n,s)||(n=s)}return n&&e.test(n)?n:null};const Xd=jd();var Yd=(e,t)=>{try{return new Xd(e,t).range||"*"}catch(e){return null}};const Qd=xu,eh=Ld(),{ANY:th}=eh,nh=jd(),rh=Dd,sh=od,ah=cd,ih=yd,oh=md;var lh=(e,t,n,r)=>{let s,a,i,o,l;switch(e=new Qd(e,r),t=new nh(t,r),n){case">":s=sh,a=ih,i=ah,o=">",l=">=";break;case"<":s=ah,a=oh,i=sh,o="<",l="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(rh(e,t,r))return!1;for(let n=0;n<t.set.length;++n){const c=t.set[n];let u=null,d=null;if(c.forEach((e=>{e.semver===th&&(e=new eh(">=0.0.0")),u=u||e,d=d||e,s(e.semver,u.semver,r)?u=e:i(e.semver,d.semver,r)&&(d=e)})),u.operator===o||u.operator===l)return!1;if((!d.operator||d.operator===o)&&a(e,d.semver))return!1;if(d.operator===l&&i(e,d.semver))return!1}return!0};const ch=lh;var uh=(e,t,n)=>ch(e,t,">",n);const dh=lh;var hh=(e,t,n)=>dh(e,t,"<",n);const ph=jd();var fh=(e,t,n)=>(e=new ph(e,n),t=new ph(t,n),e.intersects(t,n));const mh=Dd,gh=Zu;const yh=jd(),wh=Ld(),{ANY:bh}=wh,vh=Dd,_h=Zu,kh=[new wh(">=0.0.0-0")],Eh=[new wh(">=0.0.0")],Oh=(e,t,n)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===bh){if(1===t.length&&t[0].semver===bh)return!0;e=n.includePrerelease?kh:Eh}if(1===t.length&&t[0].semver===bh){if(n.includePrerelease)return!0;t=Eh}const r=new Set;let s,a,i,o,l,c,u;for(const t of e)">"===t.operator||">="===t.operator?s=Th(s,t,n):"<"===t.operator||"<="===t.operator?a=Sh(a,t,n):r.add(t.semver);if(r.size>1)return null;if(s&&a){if(i=_h(s.semver,a.semver,n),i>0)return null;if(0===i&&(">="!==s.operator||"<="!==a.operator))return null}for(const e of r){if(s&&!vh(e,String(s),n))return null;if(a&&!vh(e,String(a),n))return null;for(const r of t)if(!vh(e,String(r),n))return!1;return!0}let d=!(!a||n.includePrerelease||!a.semver.prerelease.length)&&a.semver,h=!(!s||n.includePrerelease||!s.semver.prerelease.length)&&s.semver;d&&1===d.prerelease.length&&"<"===a.operator&&0===d.prerelease[0]&&(d=!1);for(const e of t){if(u=u||">"===e.operator||">="===e.operator,c=c||"<"===e.operator||"<="===e.operator,s)if(h&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===h.major&&e.semver.minor===h.minor&&e.semver.patch===h.patch&&(h=!1),">"===e.operator||">="===e.operator){if(o=Th(s,e,n),o===e&&o!==s)return!1}else if(">="===s.operator&&!vh(s.semver,String(e),n))return!1;if(a)if(d&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===d.major&&e.semver.minor===d.minor&&e.semver.patch===d.patch&&(d=!1),"<"===e.operator||"<="===e.operator){if(l=Sh(a,e,n),l===e&&l!==a)return!1}else if("<="===a.operator&&!vh(a.semver,String(e),n))return!1;if(!e.operator&&(a||s)&&0!==i)return!1}return!(s&&c&&!a&&0!==i)&&(!(a&&u&&!s&&0!==i)&&(!h&&!d))},Th=(e,t,n)=>{if(!e)return t;const r=_h(e.semver,t.semver,n);return r>0?e:r<0||">"===t.operator&&">="===e.operator?t:e},Sh=(e,t,n)=>{if(!e)return t;const r=_h(e.semver,t.semver,n);return r<0?e:r>0||"<"===t.operator&&"<="===e.operator?t:e};var Ah=(e,t,n={})=>{if(e===t)return!0;e=new yh(e,n),t=new yh(t,n);let r=!1;e:for(const s of e.set){for(const e of t.set){const t=Oh(s,e,n);if(r=r||null!==t,t)continue e}if(r)return!1}return!0};const Ih=mu,xh=pu,Ph=xu,Ch=_u,Nh=(e,t,n)=>{const r=[];let s=null,a=null;const i=e.sort(((e,t)=>gh(e,t,n)));for(const e of i){mh(e,t,n)?(a=e,s||(s=e)):(a&&r.push([s,a]),a=null,s=null)}s&&r.push([s,null]);const o=[];for(const[e,t]of r)e===t?o.push(e):t||e!==i[0]?t?e===i[0]?o.push(`<=${t}`):o.push(`${e} - ${t}`):o.push(`>=${e}`):o.push("*");const l=o.join(" || "),c="string"==typeof t.raw?t.raw:String(t);return l.length<c.length?l:t};var Rh={parse:Cu,valid:Ru,clean:ju,inc:Mu,diff:Uu,major:Bu,minor:Hu,patch:Wu,prerelease:Vu,compare:Zu,rcompare:Xu,compareLoose:Qu,compareBuild:td,sort:rd,rsort:ad,gt:od,lt:cd,eq:dd,neq:pd,gte:md,lte:yd,cmp:Od,coerce:xd,Comparator:Ld(),Range:jd(),satisfies:Dd,toComparators:Fd,maxSatisfying:Hd,minSatisfying:Kd,minVersion:Jd,validRange:Yd,outside:lh,gtr:uh,ltr:hh,intersects:fh,simplifyRange:Nh,subset:Ah,SemVer:Ph,re:Ih.re,src:Ih.src,tokens:Ih.t,SEMVER_SPEC_VERSION:xh.SEMVER_SPEC_VERSION,RELEASE_TYPES:xh.RELEASE_TYPES,compareIdentifiers:Ch.compareIdentifiers,rcompareIdentifiers:Ch.rcompareIdentifiers};function $h(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,n]=e.split(":"),r=n||"latest";if(t.includes("/")){const[n,s]=t.split("/",2);if(!n||!s)throw new Error(`Invalid identifier format: ${e}`);return[n,s,r]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}class jh extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function Lh(e,t,n){let r;if(e.ok)return void(n&&(r=await e.text()));r=await e.text();const s=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${r}`;if(409===e.status)throw new jh(s);throw new Error(s)}var Mh="[...]",Dh={result:"[Circular]"},Uh=[],Fh=[];function Bh(e,t,n,r){try{return JSON.stringify(e,t,n)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";var s;console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),void 0===r&&(r={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),Hh(e,"",0,[],void 0,0,r);try{s=0===Fh.length?JSON.stringify(e,t,n):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,n){if(Fh.length>0)for(var r=0;r<Fh.length;r++){var s=Fh[r];if(s[1]===t&&s[0]===n){n=s[2],Fh.splice(r,1);break}}return e.call(this,t,n)}}(t),n)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==Uh.length;){var a=Uh.pop();4===a.length?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return s}}function qh(e,t,n,r){var s=Object.getOwnPropertyDescriptor(r,n);void 0!==s.get?s.configurable?(Object.defineProperty(r,n,{value:e}),Uh.push([r,n,t,s])):Fh.push([t,n,e]):(r[n]=e,Uh.push([r,n,t]))}function Hh(e,t,n,r,s,a,i){var o;if(a+=1,"object"==typeof e&&null!==e){for(o=0;o<r.length;o++)if(r[o]===e)return void qh(Dh,e,t,s);if(void 0!==i.depthLimit&&a>i.depthLimit)return void qh(Mh,e,t,s);if(void 0!==i.edgesLimit&&n+1>i.edgesLimit)return void qh(Mh,e,t,s);if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Hh(e[o],o,o,r,e,a,i);else{var l=Object.keys(e);for(o=0;o<l.length;o++){var c=l[o];Hh(e[c],c,o,r,e,a,i)}}r.pop()}}function zh(e){const t=function(){if(void 0===Qh){const e=Yh(),t=function(){if(void 0!==ep)return ep;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=tp(n);void 0!==e&&(t[n]=e)}return ep=t,t}();Qh={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:Zh,...t}}return Qh}(),n=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,n])=>(e[t]=String(n),e)),{}):void 0}catch(e){return}}()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,s]of Object.entries(e))!r.startsWith("LANGCHAIN_")||"string"!=typeof s||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=s:t[r]=s);return t}(),r=e.extra??{},s=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||e.revision_id?{revision_id:e.revision_id??n.revision_id}:{},...s}},e}function Wh(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Kh=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class Vh{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const n=new Promise((e=>{t=e})),r=Bh(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:n,size:r}),this.sizeBytes+=r,n}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let n=0;for(;n+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),n+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),n+=e.size,this.sizeBytes-=e.size}return[t.map((e=>({action:e.action,item:e.payload}))),()=>t.forEach((e=>e.itemPromiseResolve()))]}}class Gh{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Vh}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=Gh.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=np("TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=Wh(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Wh(e.apiKey??t.apiKey),this.webUrl=Wh(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??12e3,this.caller=new ou(e.callerOptions??{}),this.batchIngestCaller=new ou({...e.callerOptions??{},onFailedResponseHook:Kh}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=np("API_KEY");return{apiUrl:np("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===np("HIDE_INPUTS"),hideOutputs:"true"===np("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${Zh}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`,s=await this.caller.call(su(),r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Lh(s,`Failed to fetch ${e}`),s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let r=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));const a=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(su(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(i,`Failed to fetch ${e}`);const o=n?n(await i.json()):await i.json();if(0===o.length)break;if(yield o,o.length<s)break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const s=t?{...t}:{};for(;;){const t=await this.caller.call(su(),`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)}),a=await t.json();if(!a)break;if(!a[r])break;yield a[r];const i=a.cursors;if(!i)break;if(!i.next)break;s.cursor=i.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.filteredPostUuids.has(n.id)?this.filteredPostUuids.delete(n.id):t.push(n);return t}{const t=[];for(const n of e)n.id!==n.trace_id&&!this.filteredPostUuids.has(n.trace_id)||Math.random()<this.tracingSampleRate?t.push(n):this.filteredPostUuids.add(n.id);return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??20971520}async drainAutoBatchQueue(){for(;this.autoBatchQueue.items.length>=0;){const[e,t]=this.autoBatchQueue.pop(await this._getBatchSizeLimitBytes());if(!e.length)return void t();try{const t={runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))},n=await this._ensureServerInfo();n?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}}}async processRunOperation(e,t){const n=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=zh(e.item));const r=this.autoBatchQueue.push(e),s=await this._getBatchSizeLimitBytes();return(t||this.autoBatchQueue.sizeBytes>s)&&await this.drainAutoBatchQueue().catch(console.error),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)}),n?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),r}async _getServerInfo(){const e=await su()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e3),...this.fetchOptions});return await Lh(e,"get server info"),e.json()}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to single calls and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then((e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e)))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const s=zh(r),a=await this.caller.call(su(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:Bh(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(a,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let n=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],r=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(n.length>0&&r.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of r)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);n=Object.values(e),r=t}const s={post:this._filterForSampling(n),patch:this._filterForSampling(r,!0)};if(!s.post.length&&!s.patch.length)return;if(void 0===(await this._ensureServerInfo()).version){this.autoBatchTracing=!1;for(const e of s.post)await this.createRun(e);for(const e of s.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const a={post:[],patch:[]};for(const e of["post","patch"]){const t=e,n=s[t].reverse();let r=n.pop();for(;void 0!==r;)a[t].push(r),r=n.pop()}(a.post.length>0||a.patch.length>0)&&await this._postBatchIngestRuns(Bh(a))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(su(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(n,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;const n={};let r=[];for(const t of e??[]){const e=this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(n[e.id]=e.attachments),delete e.attachments,r.push(e)}let s=[];for(const e of t??[])s.push(this.prepareRunCreateOrUpdateInputs(e));if(void 0!==r.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==s.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(r.length>0&&s.length>0){const e=r.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of s)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);r=Object.values(e),s=t}if(0===r.length&&0===s.length)return;const a=[],i=[];for(const[e,t]of[["post",r],["patch",s]])for(const r of t){const{inputs:t,outputs:s,events:o,...l}=r,c={inputs:t,outputs:s,events:o},u=Bh(l);i.push({name:`${e}.${l.id}`,payload:new Blob([u],{type:`application/json; length=${u.length}`})});for(const[t,n]of Object.entries(c)){if(void 0===n)continue;const r=Bh(n);i.push({name:`${e}.${l.id}.${t}`,payload:new Blob([r],{type:`application/json; length=${r.length}`})})}if(void 0!==l.id){const e=n[l.id];if(e){delete n[l.id];for(const[t,[n,r]]of Object.entries(e))i.push({name:`attachment.${l.id}.${t}`,payload:new Blob([r],{type:`${n}; length=${r.length}`})})}}a.push(`trace=${l.trace_id},id=${l.id}`)}await this._sendMultipartRequest(i,a.join("; "))}async _sendMultipartRequest(e,t){try{const t=new FormData;for(const n of e)t.append(n.name,n.payload);await this.batchIngestCaller.call(su(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers},body:t,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})}catch(e){let n="Failed to multipart ingest runs";e instanceof Error?n+=`: ${e.stack||e.message}`:n+=`: ${String(e)}`,console.warn(`${n.trim()}\n\nContext: ${t}`)}}async updateRun(e,t){uu(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void 0!==t.end_time&&void 0===n.parent_run_id&&this.blockOnRootRunFinalization?void await this.processRunOperation({action:"update",item:n},!0):void this.processRunOperation({action:"update",item:n}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(su(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:Bh(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(s,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){uu(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;if(t.session_id)e=t.session_id;else if(n?.projectName)e=(await this.readProject({projectName:n?.projectName})).id;else if(n?.projectId)e=n?.projectId;else{e=(await this.readProject({projectName:np("PROJECT")||"default"})).id}const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({id:e.child_run_ids})),n={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in n||(n[e.parent_run_id]=[]),n[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:s,referenceExampleId:a,startTime:i,executionOrder:o,isRoot:l,runType:c,error:u,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:y}=e;let w=[];if(t&&(w=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));w.push(...t)}const b={session:w.length?w:null,run_type:c,reference_example:a,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:r,start_time:i?i.toISOString():null,error:u,id:d,limit:g,trace:s,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:l};let v=0;for await(const e of this._getCursorPaginatedList("/runs/query",b))if(g){if(v>=g)break;if(e.length+v>g){const t=e.slice(0,g-v);yield*t;break}v+=e.length,yield*e}else yield*e}async getRunStats({id:e,trace:t,parentRun:n,runType:r,projectNames:s,projectIds:a,referenceExampleIds:i,startTime:o,endTime:l,error:c,query:u,filter:d,traceFilter:h,treeFilter:p,isRoot:f,dataSourceType:m}){let g=a||[];s&&(g=[...a||[],...await Promise.all(s.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const y={id:e,trace:t,parent_run:n,run_type:r,session:g,reference_example:i,start_time:o,end_time:l,error:c,query:u,filter:d,trace_filter:h,tree_filter:p,is_root:f,data_source_type:m},w=Object.fromEntries(Object.entries(y).filter((([e,t])=>void 0!==t))),b=await this.caller.call(su(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(w),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await b.json()}async shareRun(t,{shareId:n}={}){const r={run_id:t,share_token:n||e.v4()};uu(t);const s=await this.caller.call(su(),`${this.apiUrl}/runs/${t}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await s.json();if(null===a||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){uu(e);const t=await this.caller.call(su(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(t,"unshare run",!0)}async readRunSharedLink(e){uu(e);const t=await this.caller.call(su(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);uu(e);const r=await this.caller.call(su(),`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}uu(e);const n=await this.caller.call(su(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}const n={dataset_id:e};uu(e);const r=await this.caller.call(su(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),s=await r.json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){uu(e);const t=await this.caller.call(su(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(t,"unshare dataset",!0)}async readSharedDataset(e){uu(e);const t=await this.caller.call(su(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const n={};t?.exampleIds&&(n.id=t.exampleIds);const r=new URLSearchParams;Object.entries(n).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>r.append(e,t))):r.append(e,t)}));const s=await this.caller.call(su(),`${this.apiUrl}/public/${e}/examples?${r.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await s.json();if(!s.ok){if("detail"in a)throw new Error(`Failed to list shared examples.\nStatus: ${s.status}\nMessage: ${a.detail.join("\n")}`);throw new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`)}return a.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:s=null,referenceDatasetId:a=null}){const i=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${i}`,l=s||{};n&&(l.metadata=n);const c={name:e,extra:l,description:t};null!==a&&(c.reference_dataset_id=a);const u=await this.caller.call(su(),o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(u,"create project");return await u.json()}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:s=null,endTime:a=null}){const i=`${this.apiUrl}/sessions/${e}`;let o=s;r&&(o={...o||{},metadata:r});const l={name:t,extra:o,description:n,end_time:a?new Date(a).toISOString():null},c=await this.caller.call(su(),i,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(c,"update project");return await c.json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)uu(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const s=await this.caller.call(su(),`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await s.json();return!!s.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const s=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)uu(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");s.append("name",t)}void 0!==n&&s.append("include_stats",n.toString());const a=await this._get(r,s);let i;if(Array.isArray(a)){if(0===a.length)throw new Error(`Project[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:s,referenceFree:a,metadata:i}={}){const o=new URLSearchParams;if(void 0!==e)for(const t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==n&&o.append("name_contains",n),void 0!==r)o.append("reference_dataset",r);else if(void 0!==s){const e=await this.readDataset({datasetName:s});o.append("reference_dataset",e.id)}void 0!==a&&o.append("reference_free",a.toString()),void 0!==i&&o.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/sessions",o))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,uu(n);const r=await this.caller.call(su(),`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(r,`delete session ${n} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:s,dataType:a,name:i}){const o=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),n.forEach((e=>{l.append("input_keys",e)})),r.forEach((e=>{l.append("output_keys",e)})),s&&l.append("description",s),a&&l.append("data_type",a),i&&l.append("name",i);const c=await this.caller.call(su(),o,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(c,"upload CSV");return await c.json()}async createDataset(e,{description:t,dataType:n,inputsSchema:r,outputsSchema:s,metadata:a}={}){const i={name:e,description:t,extra:a?{metadata:a}:void 0};n&&(i.data_type=n),r&&(i.inputs_schema_definition=r),s&&(i.outputs_schema_definition=s);const o=await this.caller.call(su(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(o,"create dataset");return await o.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)uu(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const s=await this._get(n,r);let a;if(Array.isArray(s)){if(0===s.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=s[0]}else a=s;return a}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let s=e;if(void 0===s&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==s&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===s){s=(await this.readDataset({datasetName:t})).id}const a=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:s,metadata:a}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)i.append("id",e);void 0!==r&&i.append("name",r),void 0!==s&&i.append("name_contains",s),void 0!==a&&i.append("metadata",JSON.stringify(a));for await(const e of this._getPaginated("/datasets",i))yield*e}async updateDataset(e){const{datasetId:t,datasetName:n,...r}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:n})).id;uu(s);const a=await this.caller.call(su(),`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Lh(a,"update dataset"),await a.json()}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t){r=(await this.readDataset({datasetName:t})).id}if(void 0===r)throw new Error("Must provide datasetName or datasetId");uu(r),n+=`/${r}`;const s=await this.caller.call(su(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(s,`delete ${n}`),await s.json()}async indexDataset({datasetId:e,datasetName:t,tag:n}){let r=e;if(!r&&!t)throw new Error("Must provide either datasetName or datasetId");if(r&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(!r){r=(await this.readDataset({datasetName:t})).id}uu(r);const s={tag:n},a=await this.caller.call(su(),`${this.apiUrl}/datasets/${r}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(a,"index dataset"),await a.json()}async similarExamples(e,t,n,{filter:r}={}){const s={limit:n,inputs:e};void 0!==r&&(s.filter=r),uu(t);const a=await this.caller.call(su(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(a,"fetch similar examples");return(await a.json()).examples}async createExample(e,t,{datasetId:n,datasetName:r,createdAt:s,exampleId:a,metadata:i,split:o,sourceRunId:l}){let c=n;if(void 0===c&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){c=(await this.readDataset({datasetName:r})).id}const u=s||new Date,d={dataset_id:c,inputs:e,outputs:t,created_at:u?.toISOString(),id:a,metadata:i,split:o,source_run_id:l},h=await this.caller.call(su(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(d),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(h,"create example");return await h.json()}async createExamples(e){const{inputs:t,outputs:n,metadata:r,sourceRunIds:s,exampleIds:a,datasetId:i,datasetName:o}=e;let l=i;if(void 0===l&&void 0===o)throw new Error("Must provide either datasetName or datasetId");if(void 0!==l&&void 0!==o)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===l){const e=await this.readDataset({datasetName:o});l=e.id}const c=t.map(((t,i)=>({dataset_id:l,inputs:t,outputs:n?n[i]:void 0,metadata:r?r[i]:void 0,split:e.splits?e.splits[i]:void 0,id:a?a[i]:void 0,source_run_id:s?s[i]:void 0}))),u=await this.caller.call(su(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(u,"create examples");return await u.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map((e=>lu(e)?cu(e):e)),s=lu(t)?cu(t):t;return this.createExample({input:r},{output:s},n)}async readExample(e){uu(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:s,inlineS3Urls:a,metadata:i,limit:o,offset:l,filter:c}={}){let u;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)u=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");u=(await this.readDataset({datasetName:t})).id}const d=new URLSearchParams({dataset:u}),h=r?"string"==typeof r?r:r?.toISOString():void 0;h&&d.append("as_of",h);const p=a??!0;if(d.append("inline_s3_urls",p.toString()),void 0!==n)for(const e of n)d.append("id",e);if(void 0!==s)for(const e of s)d.append("splits",e);if(void 0!==i){const e=JSON.stringify(i);d.append("metadata",e)}void 0!==o&&d.append("limit",o.toString()),void 0!==l&&d.append("offset",l.toString()),void 0!==c&&d.append("filter",c);let f=0;for await(const e of this._getPaginated("/examples",d)){for(const t of e)yield t,f++;if(void 0!==o&&f>=o)break}}async deleteExample(e){uu(e);const t=`/examples/${e}`,n=await this.caller.call(su(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(n,`delete ${t}`),await n.json()}async updateExample(e,t){uu(e);const n=await this.caller.call(su(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(n,"update example");return await n.json()}async updateExamples(e){const t=await this.caller.call(su(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(t,"update examples");return await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){r=(await this.readDataset({datasetName:t})).id}else r=e;uu(r);const s=new URLSearchParams,a=n?"string"==typeof n?n:n?.toISOString():void 0;a&&s.append("as_of",a);return await this._get(`/datasets/${r}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:r,remove:s=!1}){let a;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){a=(await this.readDataset({datasetName:t})).id}else a=e;uu(a);const i={split_name:n,examples:r.map((e=>(uu(e),e))),remove:s},o=await this.caller.call(su(),`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(o,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:s}={loadChildRuns:!1}){var a;let i;if(du[a="This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."]||(console.warn(a),du[a]=!0),"string"==typeof e)i=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(s=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,s),[l,c]=await this._logEvaluationFeedback(o,i,n);return c[0]}async createFeedback(t,n,{score:r,value:s,correction:a,comment:i,sourceInfo:o,feedbackSourceType:l="api",sourceRunId:c,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:p}){if(!t&&!h)throw new Error("One of runId or projectId must be provided");if(t&&h)throw new Error("Only one of runId or projectId can be provided");const f={type:l??"api",metadata:o??{}};void 0===c||void 0===f?.metadata||f.metadata.__run||(f.metadata.__run={run_id:c}),void 0!==f?.metadata&&void 0!==f.metadata.__run?.run_id&&uu(f.metadata.__run.run_id);const m={id:u??e.v4(),run_id:t,key:n,score:r,value:s,correction:a,comment:i,feedback_source:f,comparative_experiment_id:p,feedbackConfig:d,session_id:h},g=`${this.apiUrl}/feedback`,y=await this.caller.call(su(),g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Lh(y,"create feedback",!0),m}async updateFeedback(e,{score:t,value:n,correction:r,comment:s}){const a={};null!=t&&(a.score=t),null!=n&&(a.value=n),null!=r&&(a.correction=r),null!=s&&(a.comment=s),uu(e);const i=await this.caller.call(su(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(i,"update feedback",!0)}async readFeedback(e){uu(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){uu(e);const t=`/feedback/${e}`,n=await this.caller.call(su(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(n,`delete ${t}`),await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const s={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?s.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(s.expires_in=n):s.expires_in={hours:3};const a=await this.caller.call(su(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:s,metadata:a,id:i}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:i,name:e,experiment_ids:t,reference_dataset_id:n,description:s,created_at:(r??new Date)?.toISOString(),extra:{}};a&&(o.extra.metadata=a);const l=await this.caller.call(su(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await l.json()}async*listPresignedFeedbackTokens(e){uu(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async _logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e),s=[];for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let a=null;e.targetRunId?a=e.targetRunId:t&&(a=t.id),s.push(await this.createFeedback(a,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[r,s]}async logEvaluationFeedback(e,t,n){const[r]=await this._logEvaluationFeedback(e,t,n);return r}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:r,limit:s}=e,a=new URLSearchParams;t&&t.forEach(((e,t)=>{uu(e,`queueIds[${t}]`),a.append("ids",e)})),n&&a.append("name",n),r&&a.append("name_contains",r),a.append("limit",(void 0!==s?Math.min(s,100):100).toString());let i=0;for await(const e of this._getPaginated("/annotation-queues",a))if(yield*e,i++,void 0!==s&&i>=s)break}async createAnnotationQueue(t){const{name:n,description:r,queueId:s}=t,a={name:n,description:r,id:s||e.v4()},i=await this.caller.call(su(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(a).filter((([e,t])=>void 0!==t)))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(i,"create annotation queue");return await i.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:n,description:r}=t,s=await this.caller.call(su(),`${this.apiUrl}/annotation-queues/${uu(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:n,description:r}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(s,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(su(),`${this.apiUrl}/annotation-queues/${uu(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const n=await this.caller.call(su(),`${this.apiUrl}/annotation-queues/${uu(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map(((e,t)=>uu(e,`runIds[${t}]`).toString()))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(n,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${uu(e,"queueId")}/run`,r=await this.caller.call(su(),`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Lh(r,"get run from annotation queue"),await r.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${n.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(su(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(!t.ok){const e="string"==typeof n.detail?n.detail:JSON.stringify(n.detail),r=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw r.statusCode=t.status,r}if(0!==n.commits.length)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,r,s]=$h(e),a=await this.caller.call(su(),`${this.apiUrl}/likes/${n}/${r}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Lh(a,(t?"like":"unlike")+" prompt"),await a.json()}async _getPromptUrl(e){const[t,n,r]=$h(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==r?`${this.getHostUrl()}/prompts/${n}/${r.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${e.id}`}return"latest"!==r?`${this.getHostUrl()}/hub/${t}/${n}/${r.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,n,r]=$h(e),s=await this.caller.call(su(),`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===s.status)return null;await Lh(s,"get prompt");const a=await s.json();return a.repo?a.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[r,s,a]=$h(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("create a prompt",r);const i={repo_handle:s,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=await this.caller.call(su(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(o,"create prompt");const{repo:l}=await o.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s,a]=$h(e),i="latest"!==n?.parentCommitHash&&n?.parentCommitHash?n?.parentCommitHash:await this._getLatestCommitHash(`${r}/${s}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:i},l=await this.caller.call(su(),`${this.apiUrl}/commits/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(l,"create commit");const c=await l.json();return this._getPromptUrl(`${r}/${s}${c.commit_hash?`:${c.commit_hash}`:""}`)}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r]=$h(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const s={};if(void 0!==t?.description&&(s.description=t.description),void 0!==t?.readme&&(s.readme=t.readme),void 0!==t?.tags&&(s.tags=t.tags),void 0!==t?.isPublic&&(s.is_public=t.isPublic),void 0!==t?.isArchived&&(s.is_archived=t.isArchived),0===Object.keys(s).length)throw new Error("No valid update options provided");const a=await this.caller.call(su(),`${this.apiUrl}/repos/${n}/${r}`,{method:"PATCH",body:JSON.stringify(s),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Lh(a,"update prompt"),a.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,r]=$h(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const s=await this.caller.call(su(),`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await s.json()}async pullPromptCommit(e,t){const[n,r,s]=$h(e);let a=s;if(!function(e,t){const n=Rh.parse(e),r=Rh.parse(t);if(!n||!r)throw new Error("Invalid version format.");return n.compare(r)>=0}((await this._getServerInfo()).version,"0.5.23")&&"latest"===s){const e=await this._getLatestCommitHash(`${n}/${r}`);if(!e)throw new Error("No commits found");a=e}const i=await this.caller.call(su(),`${this.apiUrl}/commits/${n}/${r}/${a}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Lh(i,"pull prompt commit");const o=await i.json();return{owner:n,repo:r,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){if(await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),!t?.object)return await this._getPromptUrl(e);return await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash})}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:r}=t,[s,a]=this.parseTokenOrUrl(e,n),i=new Gh({apiUrl:s,apiKey:"placeholder"}),o=await i.readSharedDataset(a),l=r||o.name;try{if(await this.hasDataset({datasetId:l}))return void console.log(`Dataset ${l} already exists in your tenant. Skipping.`)}catch(e){}const c=await i.listSharedExamples(a),u=await this.createDataset(l,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map((e=>e.inputs)),outputs:c.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,n=2,r="dataset"){try{return uu(e),[t,e]}catch(e){}try{const s=new URL(e).pathname.split("/").filter((e=>""!==e));if(s.length>=n){return[t,s[s.length-n]]}throw new Error(`Invalid public ${r} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${r} URL or token: ${e}`)}}awaitPendingTraceBatches(){return Promise.all(this.autoBatchQueue.items.map((({itemPromise:e})=>e)))}}const Zh="0.1.68";let Jh;const Xh=()=>"undefined"!=typeof Deno,Yh=()=>Jh||(Jh="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Xh()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Xh()?"deno":"other":"node",Jh);let Qh,ep;function tp(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function np(e){return tp(`LANGSMITH_${e}`)||tp(`LANGCHAIN_${e}`)}const rp=Symbol.for("ls:tracing_async_local_storage"),sp=new class{getStore(){}run(e,t){return t()}};const ap=new class{getInstance(){return globalThis[rp]??sp}initializeGlobalInstance(e){void 0===globalThis[rp]&&(globalThis[rp]=e)}};function ip(e){return"function"==typeof e&&"langsmith:traceable"in e}
/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const op=Object.prototype.hasOwnProperty;function lp(e,t){return op.call(e,t)}function cp(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)lp(e,n)&&t.push(n);return t}function up(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function dp(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function hp(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function pp(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function fp(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(fp(e[t]))return!0}else if("object"==typeof e){const n=cp(e),r=n.length;for(var t=0;t<r;t++)if(fp(e[n[t]]))return!0}return!1}function mp(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class gp extends Error{constructor(e,t,n,r,s){super(mp(e,{name:t,index:n,operation:r,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=mp(e,{name:t,index:n,operation:r,tree:s})}}const yp=gp,wp={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=vp(n,this.path);r&&(r=up(r));const s=_p(n,{op:"remove",path:this.from}).removed;return _p(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=vp(n,this.from);return _p(n,{op:"add",path:this.path,value:up(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:Op(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var bp={add:function(e,t,n){return dp(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:wp.move,copy:wp.copy,test:wp.test,_get:wp._get};function vp(e,t){if(""==t)return e;var n={op:"_get",path:t};return _p(e,n),n.value}function _p(e,t,n=!1,r=!0,s=!0,a=0){if(n&&("function"==typeof n?n(t,0,e,t.path):Ep(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=vp(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=Op(e,t.value),!1===r.test)throw new yp("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new yp("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,t,e);return r}{r||(e=up(e));const i=(t.path||"").split("/");let o,l,c,u=e,d=1,h=i.length;for(c="function"==typeof n?n:Ep;;){if(l=i[d],l&&-1!=l.indexOf("~")&&(l=pp(l)),s&&("__proto__"==l||"prototype"==l&&d>0&&"constructor"==i[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===o&&(void 0===u[l]?o=i.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&c(t,0,e,o)),d++,Array.isArray(u)){if("-"===l)l=u.length;else{if(n&&!dp(l))throw new yp("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,t,e);dp(l)&&(l=~~l)}if(d>=h){if(n&&"add"===t.op&&l>u.length)throw new yp("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,t,e);const r=bp[t.op].call(t,u,l,e);if(!1===r.test)throw new yp("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r}}else if(d>=h){const n=wp[t.op].call(t,u,l,e);if(!1===n.test)throw new yp("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return n}if(u=u[l],n&&d<h&&(!u||"object"!=typeof u))throw new yp("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,t,e)}}}function kp(e,t,n,r=!0,s=!0){if(n&&!Array.isArray(t))throw new yp("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=up(e));const a=new Array(t.length);for(let r=0,i=t.length;r<i;r++)a[r]=_p(e,t[r],n,!0,s,r),e=a[r].newDocument;return a.newDocument=e,a}function Ep(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new yp("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!wp[e.op])throw new yp("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new yp("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new yp('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new yp("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new yp("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&fp(e.value))throw new yp("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var s=e.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new yp("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new yp("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var i=function(e,t,n){try{if(!Array.isArray(e))throw new yp("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)kp(up(t),up(e),n||!0);else{n=n||Ep;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof yp)return e;throw e}}([{op:"_get",path:e.from,value:void 0}],n);if(i&&"OPERATION_PATH_UNRESOLVABLE"===i.name)throw new yp("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function Op(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,s,a=Array.isArray(e),i=Array.isArray(t);if(a&&i){if((r=e.length)!=t.length)return!1;for(n=r;0!=n--;)if(!Op(e[n],t[n]))return!1;return!0}if(a!=i)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!=n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!=n--;)if(!Op(e[s=o[n]],t[s]))return!1;return!0}return e!=e&&t!=t}
/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2013-2021 Joachim Wester
 * MIT license
 */function Tp(e,t,n,r,s){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var a=cp(t),i=cp(e),o=!1,l=i.length-1;l>=0;l--){var c=e[d=i[l]];if(!lp(t,d)||void 0===t[d]&&void 0!==c&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(s&&n.push({op:"test",path:r+"/"+hp(d),value:up(c)}),n.push({op:"remove",path:r+"/"+hp(d)}),o=!0):(s&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var u=t[d];"object"==typeof c&&null!=c&&"object"==typeof u&&null!=u&&Array.isArray(c)===Array.isArray(u)?Tp(c,u,n,r+"/"+hp(d),s):c!==u&&(s&&n.push({op:"test",path:r+"/"+hp(d),value:up(c)}),n.push({op:"replace",path:r+"/"+hp(d),value:up(u)}))}}if(o||a.length!=i.length)for(l=0;l<a.length;l++){var d;lp(e,d=a[l])||void 0===t[d]||n.push({op:"add",path:r+"/"+hp(d),value:up(t[d])})}}}function Sp(e,t,n=!1){var r=[];return Tp(e,t,r,"",n),r}const Ap=()=>"undefined"!=typeof Deno,Ip=()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Ap()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Ap()?"deno":"other":"node",e};let xp;async function Pp(){if(void 0===xp){const e=Ip();xp={library:"langchain-js",runtime:e}}return xp}function Cp(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}class Np{}class Rp extends Np{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,ac(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==Cp("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return ic.prototype.toJSON.call(this)}toJSONNotImplemented(){return ic.prototype.toJSONNotImplemented.call(this)}static fromMethods(t){return new class extends Rp{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:e.v4()}),Object.assign(this,t)}}}}function $p(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class jp extends Rp{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;this.runMap.set(n.id,n),await(this.onRunCreate?.(n))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,n,r,s,a,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u=i?{...s,metadata:i}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:a||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleChatModelStart(e,t,n,r,s,a,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u=i?{...s,metadata:i}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:a||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleLLMEnd(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onLLMEnd?.(n)),await this._endTrace(n),n}async handleLLMError(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onLLMError?.(n)),await this._endTrace(n),n}async handleChainStart(e,t,n,r,s,a,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:i??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return await this._startTrace(u),await(this.onChainStart?.(u)),u}async handleChainEnd(e,t,n,r,s){const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=$p(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),void 0!==s?.inputs&&(a.inputs=$p(s.inputs,"input")),await(this.onChainEnd?.(a)),await this._endTrace(a),a}async handleChainError(e,t,n,r,s){const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),void 0!==s?.inputs&&(a.inputs=$p(s.inputs,"input")),await(this.onChainError?.(a)),await this._endTrace(a),a}async handleToolStart(e,t,n,r,s,a,i){const o=this._getExecutionOrder(r),l=Date.now(),c={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return await this._startTrace(c),await(this.onToolStart?.(c)),c}async handleToolEnd(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.runMap.get(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}async handleRetrieverStart(e,t,n,r,s,a,i){const o=this._getExecutionOrder(r),l=Date.now(),c={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return await this._startTrace(c),await(this.onRetrieverStart?.(c)),c}async handleRetrieverEnd(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,s,a){const i=this.runMap.get(n);if(!i||"llm"!==i?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return i.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:a?.chunk}}),await(this.onLLMNewToken?.(i,e,{chunk:a?.chunk})),i}}const Lp=new class{getStore(){}run(e,t){return t()}};const Mp=new class{getInstance(){return globalThis.__lc_tracing_async_local_storage??Lp}initializeGlobalInstance(e){void 0===globalThis.__lc_tracing_async_local_storage&&(globalThis.__lc_tracing_async_local_storage=e)}};class Dp extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new Dp({start:e=>function n(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Dp({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function Up(e,t=2){const n=Array.from({length:t},(()=>[]));return n.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function Fp(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=Fp(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class Bp{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise(((t,n)=>{Mp.getInstance().run(e.config,(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then((e=>t(void 0)),n)}))}))}async next(...e){if(!this.firstResultUsed)return this.firstResultUsed=!0,this.firstResult;return Mp.getInstance().run(this.config,(async()=>this.generator.next(...e)))}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}class qp{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=kp({},t);return new Hp({ops:t,state:n[n.length-1].newDocument})}}class Hp extends qp{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=kp(this.state,e.ops);return new Hp({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=kp({},e.ops);return new Hp({ops:e.ops,state:t[t.length-1].newDocument})}}const zp=e=>"log_stream_tracer"===e.name;async function Wp(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function Kp(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class Vp extends jp{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Dp.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new qp({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new qp({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await Wp(e,this._schemaFormat)),await this.writer.write(new qp({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await Wp(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await Kp(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new qp({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new qp({ops:[{op:"replace",path:"/final_output",value:await Kp(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let s;s=void 0!==e.inputs.messages?function(e){return void 0!==e&&void 0!==e.message}(n?.chunk)?n?.chunk:new yc(t):t;const a=new qp({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:s}]});await this.writer.write(a)}}const Gp="__run";class Zp{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Zp({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Jp extends Zp{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Jp({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function Xp({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const Yp=e=>"event_stream_tracer"===e.name;class Qp extends jp{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Dp.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const r=this.runInfoMap.get(e);if(void 0===r)return void(yield n.value);let s=this.tappedPromises.get(e);if(void 0===s){let a;s=new Promise((e=>{a=e})),this.tappedPromises.set(e,s);try{const s={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...s,data:{chunk:n.value}},r),yield n.value;for await(const e of t)"tool"!==r.runType&&"retriever"!==r.runType&&await this.send({...s,data:{chunk:e}},r),yield e}finally{a()}}else{yield n.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);void 0!==n?n.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=Xp(e),n=void 0!==e.inputs.messages?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,r);const s=`on_${n}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,n){const r=this.runInfoMap.get(e.id);let s,a;if(void 0===r)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if("chat_model"===r.runType)a="on_chat_model_stream",s=void 0===n?.chunk?new yc({content:t}):n.chunk.message;else{if("llm"!==r.runType)throw new Error(`Unexpected run type ${r.runType}`);a="on_llm_stream",s=void 0===n?.chunk?new Zp({text:t}):n.chunk}await this.send({event:a,data:{chunk:s},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let n;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const r=e.outputs?.generations;let s;if("chat_model"===t.runType){for(const e of r??[]){if(void 0!==s)break;s=e[0]?.message}n="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);s={generations:r?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end"}await this.sendEndEvent({event:n,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=Xp(e),n=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let s={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(s={},r.inputs={}):void 0!==e.inputs.input?(s.input=e.inputs.input,r.inputs=e.inputs.input):(s.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${n}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},s={output:e.outputs?.output??e.outputs,input:r};r.input&&1===Object.keys(r).length&&(s.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:n,data:s,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=Xp(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=Xp(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const r=this.runInfoMap.get(n);if(void 0===r)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}var ef={exports:{}};!function(e){const t=(e=0)=>t=>`[${38+e};5;${t}m`,n=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,r={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};r.color.gray=r.color.blackBright,r.bgColor.bgGray=r.bgColor.bgBlackBright,r.color.grey=r.color.blackBright,r.bgColor.bgGrey=r.bgColor.bgBlackBright;for(const[t,n]of Object.entries(r)){for(const[t,s]of Object.entries(n))r[t]={open:`[${s[0]}m`,close:`[${s[1]}m`},n[t]=r[t],e.set(s[0],s[1]);Object.defineProperty(r,t,{value:n,enumerable:!1})}return Object.defineProperty(r,"codes",{value:e,enumerable:!1}),r.color.close="[39m",r.bgColor.close="[49m",r.color.ansi256=t(),r.color.ansi16m=n(),r.bgColor.ansi256=t(10),r.bgColor.ansi16m=n(10),Object.defineProperties(r,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map((e=>e+e)).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>r.rgbToAnsi256(...r.hexToRgb(e)),enumerable:!1}}),r}})}(ef);var tf=o(ef.exports);function nf(e,t){return`${e.open}${t}${e.close}`}function rf(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function sf(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:af}=tf;class of extends jp{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?nf(tf.bold,r):r})).join(" > ");return nf(af.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.green,"[chain/start]")} [${t}] Entering Chain run with input: ${rf(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.cyan,"[chain/end]")} [${t}] [${sf(e)}] Exiting Chain run with output: ${rf(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.red,"[chain/error]")} [${t}] [${sf(e)}] Chain run errored with error: ${rf(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${nf(af.green,"[llm/start]")} [${t}] Entering LLM run with input: ${rf(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.cyan,"[llm/end]")} [${t}] [${sf(e)}] Exiting LLM run with output: ${rf(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.red,"[llm/error]")} [${t}] [${sf(e)}] LLM run errored with error: ${rf(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.cyan,"[tool/end]")} [${t}] [${sf(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.red,"[tool/error]")} [${t}] [${sf(e)}] Tool run errored with error: ${rf(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${rf(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.cyan,"[retriever/end]")} [${t}] [${sf(e)}] Exiting Retriever run with output: ${rf(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${nf(af.red,"[retriever/error]")} [${t}] [${sf(e)}] Retriever run errored with error: ${rf(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${nf(af.blue,"[agent/action]")} [${n}] Agent selected action: ${rf(t.actions[t.actions.length-1],"[action]")}`)}}class lf extends jp{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:r}=e;this.projectName=n??Cp("LANGCHAIN_PROJECT")??Cp("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??new Gh({});const s=this.getTraceableRunTree();if(s){let e=s;const t=new Set;for(;e.parent_run&&!t.has(e.id)&&(t.add(e.id),e.parent_run);)e=e.parent_run;t.clear();const n=[e];for(;n.length>0;){const e=n.shift();e&&!t.has(e.id)&&(t.add(e.id),this.runMap.set(e.id,e),e.child_runs&&n.push(...e.child_runs))}this.client=s.client??this.client,this.projectName=s.project_name??this.projectName,this.exampleId=s.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Pp()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return(()=>{const e=ap.getInstance().getStore();if(!function(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}(e))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join("\n"));return e})()}catch{return}}}var cf={},uf={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,i){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||i(this,a);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[a]=1===c.length?c[0]:c:i(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(uf);var df=uf.exports,hf={exports:{}};const pf=qc;class ff extends Error{constructor(e){super(e),this.name="TimeoutError"}}const mf=(e,t,n)=>new Promise(((r,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void r(e);const a=setTimeout((()=>{if("function"==typeof n){try{r(n())}catch(e){s(e)}return}const a=n instanceof Error?n:new ff("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(a)}),t);pf(e.then(r,s),(()=>{clearTimeout(a)}))}));hf.exports=mf,hf.exports.default=mf,hf.exports.TimeoutError=ff;var gf=hf.exports,yf={},wf={};Object.defineProperty(wf,"__esModule",{value:!0}),wf.default=function(e,t,n){let r=0,s=e.length;for(;s>0;){const a=s/2|0;let i=r+a;n(e[i],t)<=0?(r=++i,s-=a+1):s=a}return r},Object.defineProperty(yf,"__esModule",{value:!0});const bf=wf;yf.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const r=bf.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(r,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}},Object.defineProperty(cf,"__esModule",{value:!0});const vf=df,_f=gf,kf=yf,Ef=()=>{},Of=new _f.TimeoutError;var Tf=cf.default=class extends vf{constructor(e){var t,n,r,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=Ef,this._resolveIdle=Ef,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:kf.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(s=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==s?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=Ef,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=Ef,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():_f.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(Of)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};let Sf;async function Af(e,t){!0===t?await e():(void 0===Sf&&(Sf=new("default"in Tf?Tf.default:Tf)({autoStart:!0,concurrency:1})),Sf.add(e))}class If{setHandler(e){return this.setHandlers([e])}}class xf{constructor(e,t,n,r,s,a,i,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>Af((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Pf extends xf{getChild(e){const t=new $f(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(n){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Cf extends xf{async handleLLMNewToken(e,t,n,r,s,a){await Promise.all(this.handlers.map((n=>Af((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(e){if(console.error(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Nf extends xf{getChild(e){const t=new $f(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,s){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,n,r,s){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Rf extends xf{getChild(e){const t=new $f(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class $f extends If{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,l=void 0){return Promise.all(n.map((async(n,s)=>{const i=0===s&&r?r:t();return await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMStart?.(e,[n],i,this._parentRunId,a,this.tags,this.metadata,l))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Cf(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,l=void 0){return Promise.all(n.map((async(n,s)=>{const i=0===s&&r?r:t();return await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreLLM)try{if(t.handleChatModelStart)await(t.handleChatModelStart?.(e,[n],i,this._parentRunId,a,this.tags,this.metadata,l));else if(t.handleLLMStart){const r=Ac(n);await(t.handleLLMStart?.(e,[r],i,this._parentRunId,a,this.tags,this.metadata,l))}}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Cf(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,n,r=t(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreChain)try{await(t.handleChainStart?.(e,n,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Nf(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,n,r=t(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreAgent)try{await(t.handleToolStart?.(e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Rf(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,n,r=t(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map((t=>Af((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverStart?.(e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Pf(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,r,s){await Promise.all(this.handlers.map((r=>Af((async()=>{if(!r.ignoreCustomEvent)try{await(r.handleCustomEvent?.(e,t,n,this.tags,this.metadata))}catch(e){if(console.error(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new $f(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||n.addHandler(r,t);return n}static fromHandlers(e){const n=new this;return n.addHandler(new class extends Rp{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t()}),Object.assign(this,e)}}),n}static async configure(e,t,n,r,s,a,i){return this._configureSync(e,t,n,r,s,a,i)}static _configureSync(e,t,n,r,s,a,i){let o;(e||t)&&(Array.isArray(e)||!e?(o=new $f,o.setHandlers(e?.map(jf)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(jf):t?.handlers,!1));const l="true"===Cp("LANGCHAIN_VERBOSE")||i?.verbose,c=!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===Cp(e))),u=c||(Cp("LANGCHAIN_TRACING")??!1);if(l||u){if(o||(o=new $f),l&&!o.handlers.some((e=>e.name===of.prototype.name))){const e=new of;o.addHandler(e,!0)}if(u&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&c){const e=new lf;o.addHandler(e,!0),o._parentRunId=e.getTraceableRunTree()?.id??o._parentRunId}}return(n||r)&&o&&(o.addTags(n??[]),o.addTags(r??[],!1)),(s||a)&&o&&(o.addMetadata(s??{}),o.addMetadata(a??{},!1)),o}}function jf(e){return"name"in e?e:Rp.fromMethods(e)}async function Lf(e){return $f.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function Mf(...e){const t={};for(const n of e.filter((e=>!!e)))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("callbacks"===e){const e=t.callbacks,r=n.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const n=e.copy();for(const e of r)n.addHandler(jf(e),!0);t.callbacks=n}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const n=r.copy();for(const t of e)n.addHandler(jf(t),!0);t.callbacks=n}else t.callbacks=new $f(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=n[r]??t[r]}return t}const Df=new Set(["string","number","boolean"]);function Uf(e){const t=Mp.getInstance().getStore();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,...r}=t;n=Object.entries(r).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)}if(e&&(n=Object.entries(e).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)),n?.configurable)for(const e of Object.keys(n.configurable))Df.has(typeof n.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=n.configurable[e]);return n}function Ff(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:s,configurable:a,runId:i}={}){const o=Uf(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==s&&(o.runName=s),void 0!==a&&(o.configurable={...o.configurable,...a}),void 0!==i&&delete o.runId,o}const Bf=[400,401,402,403,404,405,406,407,409],qf=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&Bf.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class Hf{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??qf;const t="default"in Tf?Tf.default:Tf;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>Mc((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}class zf extends jp{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function Wf(e){return!!e&&e.lc_runnable}class Kf{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every((e=>!this.excludeTags?.includes(e)))),n}}function Vf(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}function Gf(e,t){return[t[e.source]??e.source,t[e.target]??e.target]}function Zf(e,t,n){const{firstNodeLabel:r,lastNodeLabel:s,nodeColors:a,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=n??{};let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(i){const t="default",n={[t]:"{0}([{1}]):::otherclass"};void 0!==r&&(n[r]="{0}[{0}]:::startclass"),void 0!==s&&(n[s]="{0}[{0}]:::endclass");for(const r of Object.values(e)){const e=n[r]??n[t],s=Vf(r),a=r.split(":"),i=a[a.length-1];c+=`\t${e.replace(/\{0\}/g,s).replace(/\{1\}/g,i)};\n`}}let u="";for(const n of t){const t=n.source.includes(":")?n.source.split(":")[0]:void 0,r=n.target.includes(":")?n.target.split(":")[0]:void 0;""===u||u===t&&u===r||(c+="\tend\n",u=""),""===u&&void 0!==t&&t===r&&(c=`\tsubgraph ${t}\n`,u=t);const[s,a]=Gf(n,e);let i="";if(void 0!==n.data){let e=n.data;const t=e.split(" ");t.length>l&&(e=t.reduce(((e,t,n)=>(n%l==0&&e.push(""),e[e.length-1]+=` ${t}`,e)),[]).join("<br>")),i=n.conditional?` -. ${e} .-> `:` -- ${e} --\x3e `}else i=n.conditional?" -.-> ":" --\x3e ";c+=`\t${Vf(s)}${i}${Vf(a)};\n`}return""!==u&&(c+="end\n"),i&&void 0!==a&&(c+=function(e){let t="";for(const[n,r]of Object.entries(e))t+=`\tclassDef ${n}class fill:${r};\n`;return t}(a)),c}function Jf(e){if(!n(e.id))return e.id;if(!Wf(e.data))return e.data.name??"UnknownSchema";try{let t=e.data.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t.length>42&&(t=`${t.substring(0,42)}...`),t}catch(t){return e.data.getName()}}function Xf(e){return Wf(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Os(e.data.schema),title:e.data.name}}}class Yf{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach(((t,r)=>{e[t.id]=n(t.id)?r:t.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...Xf(t)}))),edges:this.edges.map((t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]}))}}addNode(e,n){if(void 0!==n&&void 0!==this.nodes[n])throw new Error(`Node with id ${n} already exists`);const r=n||t(),s={id:r,data:e};return this.nodes[r]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,n,r){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:n,conditional:r};return this.edges.push(s),s}firstNode(){const e=new Set(this.edges.map((e=>e.target))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}lastNode(){const e=new Set(this.edges.map((e=>e.source))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}extend(e,t=""){let r=t;Object.values(e.nodes).map((e=>e.id)).every(n)&&(r="");const s=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[s(e)]={...t,id:s(e)}}));const a=e.edges.map((e=>({...e,source:s(e.source),target:s(e.target)})));this.edges=[...this.edges,...a];const i=e.firstNode(),o=e.lastNode();return[i?{id:s(i.id),data:i.data}:void 0,o?{id:s(o.id),data:o.data}:void 0]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter((t=>t.source===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter((t=>t.target===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:r={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:s}=e??{},a={};for(const e of Object.values(this.nodes))a[e.id]=Jf(e);const i=this.firstNode(),o=i?Jf(i):void 0,l=this.lastNode(),c=l?Jf(l):void 0;return Zf(a,this.edges,{firstNodeLabel:o,lastNodeLabel:c,withStyles:t,curveStyle:n,nodeColors:r,wrapLabelNWords:s})}async drawMermaidPng(e){return async function(e,t){let{backgroundColor:n="white"}=t??{};const r=btoa(e);void 0!==n&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const s=`https://mermaid.ink/img/${r}?bgColor=${n}`,a=await fetch(s);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join("\n"));return await a.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function Qf(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function em(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*tm(e,t){const n=Mp.getInstance();for(;;){const{value:r,done:s}=n.run(e,t.next.bind(t));if(s)break;yield r}}async function*nm(e,t){const n=Mp.getInstance(),r=t[Symbol.asyncIterator]();for(;;){const{value:s,done:a}=await n.run(e,r.next.bind(t));if(a)break;yield s}}function rm(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class sm extends ic{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new am({bound:this,kwargs:e,config:{}})}map(){return new im({bound:this})}withRetry(e){return new om({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new am({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new hm({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Uf);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>Uf(0===r?e:n)))}return Array.from({length:t},(()=>Uf(e)))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=r[0]?.maxConcurrency??n?.maxConcurrency,a=new Hf({maxConcurrency:s,onFailedAttempt:e=>{throw e}}),i=e.map(((e,t)=>a.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}))));return Promise.all(i)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=Uf(t),r=new Bp({generator:this._streamIterator(e,n),config:n});return await r.setup,Dp.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=Uf(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,[t,n]}async _callWithConfig(e,t,n){const r=Uf(n),s=await Lf(r),a=await(s?.handleChainStart(this.toJSON(),rm(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let i;delete r.runId;try{i=await e.call(this,t,r,a)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(rm(i,"output"))),i}async _batchWithConfig(e,t,n,r){const s=this._getOptionsList(n??{},t.length),a=await Promise.all(s.map(Lf)),i=await Promise.all(a.map((async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),rm(t[n],"input"),s[n].runId,s[n].runType,void 0,void 0,s[n].runName??this.getName()));return delete s[n].runId,r})));let o;try{o=await e.call(this,t,s,i,r)}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(rm(o,"output"))))),o}async*_transformStreamWithConfig(e,t,n){let r,s,a=!0,i=!0;const o=Uf(n),l=await Lf(o);let c;try{const n=await async function(e,t,n,...r){const s=new Bp({generator:t,startSetup:n}),a=await s.setup;return{output:e(s,a,...r),setup:a}}(t.bind(this),async function*(){for await(const t of e){if(a)if(void 0===r)r=t;else try{r=Fp(r,t)}catch{r=void 0,a=!1}yield t}}(),(async()=>l?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),o);delete o.runId,c=n.setup;const u=c?.handlers.find(Yp);let d=n.output;void 0!==u&&void 0!==c&&(d=u.tapOutputIterable(c.runId,d));const h=c?.handlers.find(zp);void 0!==h&&void 0!==c&&(d=h.tapOutputIterable(c.runId,d));for await(const e of d)if(yield e,i)if(void 0===s)s=e;else try{s=Fp(s,e)}catch{s=void 0,i=!1}}catch(e){throw await(c?.handleChainError(e,void 0,void 0,void 0,{inputs:rm(r,"input")})),e}await(c?.handleChainEnd(s??{},void 0,void 0,void 0,{inputs:rm(r,"input")}))}getGraph(e){const t=new Yf,n=t.addNode({name:`${this.getName()}Input`,schema:Yr.any()}),r=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:Yr.any()});return t.addEdge(n,r),t.addEdge(r,s),t}pipe(e){return new lm({first:this,last:pm(e)})}pick(e){return this.pipe(new mm(e))}assign(e){return this.pipe(new fm(new cm({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:Fp(n,t);yield*this._streamIterator(n,Uf(t))}async*streamLog(e,t,n){const r=new Vp({...n,autoClose:!1,_schemaFormat:"original"}),s=Uf(t);yield*this._streamLog(e,r,s)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.inheritableHandlers.push(t),n.callbacks=e}const s=this.stream(e,n);const a=async function(){try{const e=await s;for await(const n of e){const e=new qp({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await a}}streamEvents(e,t,n){let r;if("v1"===t.version)r=this._streamEventsV1(e,t,n);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');r=this._streamEventsV2(e,t,n)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return Dp.fromReadableStream(n)}(r):Dp.fromAsyncGenerator(r)}async*_streamEventsV2(e,n,r){const s=new Qp({...r,autoClose:!1}),a=Uf(n),i=a.runId??t();a.runId=i;const o=a.callbacks;if(void 0===o)a.callbacks=[s];else if(Array.isArray(o))a.callbacks=o.concat(s);else{const e=o.copy();e.inheritableHandlers.push(s),a.callbacks=e}const l=this;const c=async function(){try{const t=await l.stream(e,a),n=s.tapOutputIterable(i,t);for await(const e of n);}finally{await s.finish()}}();let u,d=!1;try{for await(const t of s)d?(t.run_id===u&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,u=t.run_id,yield t)}finally{await c}}async*_streamEventsV1(e,t,n){let r,s=!1;const a=Uf(t),i=a.tags??[],o=a.metadata??{},l=a.runName??this.getName(),c=new Vp({...n,autoClose:!1,_schemaFormat:"streaming_events"}),u=new Kf({...n}),d=this._streamLog(e,c,a);for await(const t of d){if(r=r?r.concat(t):Hp.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:i,metadata:o,data:{input:e}};u.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),a=[...new Set(n)];for(const e of a){let t,n={};const s=r.state.logs[e];if(t=void 0===s.end_time?s.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==s.inputs&&(n.input=s.inputs);else if("end"===t)void 0!==s.inputs&&(n.input=s.inputs),n.output=s.final_output;else if("stream"===t){const e=s.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${s.name}"`);n={chunk:s.streamed_output[0]},s.streamed_output=[]}yield{event:`on_${s.type}_${t}`,name:s.name,run_id:s.id,tags:s.tags,metadata:s.metadata,data:n}}const{state:c}=r;if(c.streamed_output.length>0){const e=c.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${c.name}"`);const t={chunk:c.streamed_output[0]};c.streamed_output=[];const n={event:`on_${c.type}_stream`,run_id:c.id,tags:i,metadata:o,name:l,data:t};u.includeEvent(n,c.type)&&(yield n)}}const h=r?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:i,metadata:o,data:{output:h.final_output}};u.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return Wf(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new am({bound:this,config:{},configFactories:[r=>({callbacks:[new zf({config:r,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return function(e,t){const n=t.name??e.getName(),r=t.description??t.schema.description;return new gm({name:n,description:r,schema:t.schema,bound:e})}
/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */(this,e)}}class am extends sm{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=Mf(this.config,...e);return Mf(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(Uf(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(Uf(e),this.kwargs)))):await this._mergeConfig(Uf(t),this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(Uf(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(Uf(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(Uf(t),this.kwargs))}streamEvents(e,t,n){const r=this;return Dp.fromAsyncGenerator(async function*(){yield*r.bound.streamEvents(e,{...await r._mergeConfig(Uf(t),r.kwargs),version:t.version},n)}())}static isRunnableBinding(e){return e.bound&&sm.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new am({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new zf({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class im extends sm{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new im({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,n){return this.bound.batch(e,Ff(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new im({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class om extends am{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return Ff(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return Mc((r=>super.invoke(e,this._patchConfigForRetry(r,t,n))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,n,r){const s={};try{await Mc((async a=>{const i=e.map(((e,t)=>t)).filter((e=>void 0===s[e.toString()]||s[e.toString()]instanceof Error)),o=i.map((t=>e[t])),l=i.map((e=>this._patchConfigForRetry(a,t?.[e],n?.[e]))),c=await super.batch(o,l,{...r,returnExceptions:!0});let u;for(let e=0;e<c.length;e+=1){const t=c[e],n=i[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),s[n.toString()]=t}if(u)throw u;return c}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(s).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>s[parseInt(e,10)]))}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class lm extends sm{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=Uf(t),r=await Lf(n),s=await(r?.handleChainStart(this.toJSON(),rm(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let a,i=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const r=e[t];i=await r.invoke(i,Ff(n,{callbacks:s?.getChild(`seq:step:${t+1}`)}))}a=await this.last.invoke(i,Ff(n,{callbacks:s?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(rm(a,"output"))),a}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map(Lf)),a=await Promise.all(s.map((async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),rm(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s})));let i=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];i=await t.batch(i,a.map(((t,n)=>{const s=t?.getChild(`seq:step:${e+1}`);return Ff(r[n],{callbacks:s})})),n)}}catch(e){throw await Promise.all(a.map((t=>t?.handleChainError(e)))),e}return await Promise.all(a.map((e=>e?.handleChainEnd(rm(i,"output"))))),i}async*_streamIterator(e,t){const n=await Lf(t),{runId:r,...s}=t??{},a=await(n?.handleChainStart(this.toJSON(),rm(e,"input"),r,void 0,void 0,void 0,s?.runName)),i=[this.first,...this.middle,this.last];let o,l=!0;try{let t=i[0].transform(async function*(){yield e}(),Ff(s,{callbacks:a?.getChild("seq:step:1")}));for(let e=1;e<i.length;e+=1){const n=i[e];t=await n.transform(t,Ff(s,{callbacks:a?.getChild(`seq:step:${e+1}`)}))}for await(const e of t)if(yield e,l)if(void 0===o)o=e;else try{o=Fp(o,e)}catch(e){o=void 0,l=!1}}catch(e){throw await(a?.handleChainError(e)),e}await(a?.handleChainEnd(rm(o,"output")))}getGraph(e){const t=new Yf;let n=null;return this.steps.forEach(((r,s)=>{const a=r.getGraph(e);0!==s&&a.trimFirstNode(),s!==this.steps.length-1&&a.trimLastNode(),t.extend(a);const i=a.firstNode();if(!i)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,i),n=a.lastNode()})),t}pipe(e){return lm.isRunnableSequence(e)?new lm({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new lm({first:this.first,middle:[...this.middle,this.last],last:pm(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&sm.isRunnable(e)}static from([e,...t],n){return new lm({first:pm(e),middle:t.slice(0,-1).map(pm),last:pm(t[t.length-1]),name:n})}}class cm extends sm{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=pm(n)}static from(e){return new cm({steps:e})}async invoke(e,t){const n=Uf(t),r=await Lf(n),s=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const a={};try{await Promise.all(Object.entries(this.steps).map((async([t,r])=>{a[t]=await r.invoke(e,Ff(n,{callbacks:s?.getChild(`map:key:${t}`)}))})))}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(a)),a}async*_transform(e,t,n){const r={...this.steps},s=Up(e,Object.keys(r).length),a=new Map(Object.entries(r).map((([e,r],a)=>{const i=r.transform(s[a],Ff(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,i.next().then((t=>({key:e,gen:i,result:t})))]})));for(;a.size;){const{key:e,result:t,gen:n}=await Promise.race(a.values());a.delete(e),t.done||(yield{[e]:t.value},a.set(e,n.next().then((t=>({key:e,gen:n,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Uf(t),r=new Bp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Dp.fromAsyncGenerator(r)}}class um extends sm{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!ip(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[n]=this._getOptionsList(t??{},1),r=await Lf(n);return await this.func(Ff(n,{callbacks:r}),e)}async*_streamIterator(e,t){const n=await this.invoke(e,t);if(em(n))for await(const e of n)yield e;else if((e=>null!=e&&"object"==typeof e&&"next"in e&&"function"==typeof e.next)(n))for(;;){const e=n.next();if(e.done)break;yield e.value}else yield n}static from(e){return new um({func:e})}}class dm extends sm{static lc_name(){return"RunnableLambda"}constructor(e){if(ip(e.func))return um.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if(ip(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new dm({func:e})}async _invoke(e,t,n){return new Promise(((r,s)=>{const a=Ff(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});Mp.getInstance().run(a,(async()=>{try{let n=await this.func(e,{...a,config:a});if(n&&sm.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...a,recursionLimit:(a.recursionLimit??25)-1})}else if(em(n)){let e;for await(const t of nm(a,n))if(void 0===e)e=t;else try{e=Fp(e,t)}catch(n){e=t}n=e}else if(Qf(n)){let e;for(const t of tm(a,n))if(void 0===e)e=t;else try{e=Fp(e,t)}catch(n){e=t}n=e}r(n)}catch(e){s(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=Fp(r,t)}catch(e){r=t}const s=Ff(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??25)-1}),a=await new Promise(((e,t)=>{Mp.getInstance().run(s,(async()=>{try{const t=await this.func(r,{...s,config:s});e(t)}catch(e){t(e)}}))}));if(a&&sm.isRunnable(a)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await a.stream(r,s);for await(const t of e)yield t}else if(em(a))for await(const e of nm(s,a))yield e;else if(Qf(a))for(const e of tm(s,a))yield e;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Uf(t),r=new Bp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Dp.fromAsyncGenerator(r)}}class hm extends sm{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=Uf(t),r=await Lf(t),{runId:s,...a}=n,i=await(r?.handleChainStart(this.toJSON(),rm(e,"input"),s,void 0,void 0,void 0,a?.runName));let o;for(const t of this.runnables())try{const n=await t.invoke(e,Ff(a,{callbacks:i?.getChild()}));return await(i?.handleChainEnd(rm(n,"output"))),n}catch(e){void 0===o&&(o=e)}if(void 0===o)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(o)),o}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map((e=>Lf(e)))),a=await Promise.all(s.map((async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),rm(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s})));let i;for(const t of this.runnables())try{const s=await t.batch(e,a.map(((e,t)=>Ff(r[t],{callbacks:e?.getChild()}))),n);return await Promise.all(a.map(((e,t)=>e?.handleChainEnd(rm(s[t],"output"))))),s}catch(e){void 0===i&&(i=e)}if(!i)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(a.map((e=>e?.handleChainError(i)))),i}}function pm(e){if("function"==typeof e)return new dm({func:e});if(sm.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=pm(r);return new cm({steps:t})}}class fm extends sm{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof cm&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[s,a]=Up(e),i=this.mapper.transform(a,Ff(n,{callbacks:t?.getChild()})),o=i.next();for await(const e of s){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of i)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Uf(t),r=new Bp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Dp.fromAsyncGenerator(r)}}class mm extends sm{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Uf(t),r=new Bp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Dp.fromAsyncGenerator(r)}}class gm extends am{constructor(e){super({bound:e.bound,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}var ym="object"==typeof window?window:{},wm="0123456789abcdef".split(""),bm=[-2147483648,8388608,32768,128],vm=[24,16,8,0],_m=[];function km(e){e?(_m[0]=_m[16]=_m[1]=_m[2]=_m[3]=_m[4]=_m[5]=_m[6]=_m[7]=_m[8]=_m[9]=_m[10]=_m[11]=_m[12]=_m[13]=_m[14]=_m[15]=0,this.blocks=_m):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}km.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===ym.ArrayBuffer&&(e=new Uint8Array(e));for(var n,r,s=0,a=e.length||0,i=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),t)for(r=this.start;s<a&&r<64;++s)i[r>>2]|=e[s]<<vm[3&r++];else for(r=this.start;s<a&&r<64;++s)(n=e.charCodeAt(s))<128?i[r>>2]|=n<<vm[3&r++]:n<2048?(i[r>>2]|=(192|n>>6)<<vm[3&r++],i[r>>2]|=(128|63&n)<<vm[3&r++]):n<55296||n>=57344?(i[r>>2]|=(224|n>>12)<<vm[3&r++],i[r>>2]|=(128|n>>6&63)<<vm[3&r++],i[r>>2]|=(128|63&n)<<vm[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++s)),i[r>>2]|=(240|n>>18)<<vm[3&r++],i[r>>2]|=(128|n>>12&63)<<vm[3&r++],i[r>>2]|=(128|n>>6&63)<<vm[3&r++],i[r>>2]|=(128|63&n)<<vm[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=i[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},km.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=bm[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},km.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,s=this.h2,a=this.h3,i=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r&s|~r&a)+i+1518500249+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|~n&s)+a+1518500249+o[e+1]|0)<<5|a>>>27)+(i&(n=n<<30|n>>>2)|~i&r)+s+1518500249+o[e+2]|0)<<5|s>>>27)+(a&(i=i<<30|i>>>2)|~a&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|~s&i)+n+1518500249+o[e+4]|0,s=s<<30|s>>>2;for(;e<40;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r^s^a)+i+1859775393+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^s)+a+1859775393+o[e+1]|0)<<5|a>>>27)+(i^(n=n<<30|n>>>2)^r)+s+1859775393+o[e+2]|0)<<5|s>>>27)+(a^(i=i<<30|i>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^i)+n+1859775393+o[e+4]|0,s=s<<30|s>>>2;for(;e<60;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r&s|r&a|s&a)+i-1894007588+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|n&s|r&s)+a-1894007588+o[e+1]|0)<<5|a>>>27)+(i&(n=n<<30|n>>>2)|i&r|n&r)+s-1894007588+o[e+2]|0)<<5|s>>>27)+(a&(i=i<<30|i>>>2)|a&n|i&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|s&i|a&i)+n-1894007588+o[e+4]|0,s=s<<30|s>>>2;for(;e<80;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r^s^a)+i-899497514+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^s)+a-899497514+o[e+1]|0)<<5|a>>>27)+(i^(n=n<<30|n>>>2)^r)+s-899497514+o[e+2]|0)<<5|s>>>27)+(a^(i=i<<30|i>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^i)+n-899497514+o[e+4]|0,s=s<<30|s>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+s|0,this.h3=this.h3+a|0,this.h4=this.h4+i|0},km.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4;return wm[e>>28&15]+wm[e>>24&15]+wm[e>>20&15]+wm[e>>16&15]+wm[e>>12&15]+wm[e>>8&15]+wm[e>>4&15]+wm[15&e]+wm[t>>28&15]+wm[t>>24&15]+wm[t>>20&15]+wm[t>>16&15]+wm[t>>12&15]+wm[t>>8&15]+wm[t>>4&15]+wm[15&t]+wm[n>>28&15]+wm[n>>24&15]+wm[n>>20&15]+wm[n>>16&15]+wm[n>>12&15]+wm[n>>8&15]+wm[n>>4&15]+wm[15&n]+wm[r>>28&15]+wm[r>>24&15]+wm[r>>20&15]+wm[r>>16&15]+wm[r>>12&15]+wm[r>>8&15]+wm[r>>4&15]+wm[15&r]+wm[s>>28&15]+wm[s>>24&15]+wm[s>>20&15]+wm[s>>16&15]+wm[s>>12&15]+wm[s>>8&15]+wm[s>>4&15]+wm[15&s]},km.prototype.toString=km.prototype.hex,km.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,s>>24&255,s>>16&255,s>>8&255,255&s]},km.prototype.array=km.prototype.digest,km.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const Em=(...e)=>{return t=e.join("_"),new km(!0).update(t).hex();var t};class Om{}const Tm=new Map;class Sm extends Om{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Em(e,t))??null)}async update(e,t,n){this.cache.set(Em(e,t),n)}static global(){return new Sm(Tm)}}class Am extends ic{}class Im extends Am{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new _c(this.value)]}}class xm extends Am{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Ac(this.messages)}toChatMessages(){return this.messages}}class Pm extends Am{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new _c({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}for(var Cm={byteLength:function(e){var t=Mm(e),n=t[0],r=t[1];return 3*(n+r)/4-r},toByteArray:function(e){var t,n,r=Mm(e),s=r[0],a=r[1],i=new $m(function(e,t,n){return 3*(t+n)/4-n}(0,s,a)),o=0,l=a>0?s-4:s;for(n=0;n<l;n+=4)t=Rm[e.charCodeAt(n)]<<18|Rm[e.charCodeAt(n+1)]<<12|Rm[e.charCodeAt(n+2)]<<6|Rm[e.charCodeAt(n+3)],i[o++]=t>>16&255,i[o++]=t>>8&255,i[o++]=255&t;2===a&&(t=Rm[e.charCodeAt(n)]<<2|Rm[e.charCodeAt(n+1)]>>4,i[o++]=255&t);1===a&&(t=Rm[e.charCodeAt(n)]<<10|Rm[e.charCodeAt(n+1)]<<4|Rm[e.charCodeAt(n+2)]>>2,i[o++]=t>>8&255,i[o++]=255&t);return i},fromByteArray:function(e){for(var t,n=e.length,r=n%3,s=[],a=16383,i=0,o=n-r;i<o;i+=a)s.push(Dm(e,i,i+a>o?o:i+a));1===r?(t=e[n-1],s.push(Nm[t>>2]+Nm[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],s.push(Nm[t>>10]+Nm[t>>4&63]+Nm[t<<2&63]+"="));return s.join("")}},Nm=[],Rm=[],$m="undefined"!=typeof Uint8Array?Uint8Array:Array,jm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Lm=0;Lm<64;++Lm)Nm[Lm]=jm[Lm],Rm[jm.charCodeAt(Lm)]=Lm;function Mm(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function Dm(e,t,n){for(var r,s,a=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),a.push(Nm[(s=r)>>18&63]+Nm[s>>12&63]+Nm[s>>6&63]+Nm[63&s]);return a.join("")}Rm["-".charCodeAt(0)]=62,Rm["_".charCodeAt(0)]=63;var Um=Object.defineProperty;function Fm(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const a=e.slice(n[s].start,n[s+1].end),i=t.get(a.join(","));null!=i&&(null==r||i<r[0])&&(r=[i,s])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map((n=>t.get(e.slice(n.start,n.end).join(",")))).filter((e=>null!=e))}var Bm,qm=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[n,r,...s]=t.split(" "),a=Number.parseInt(r,10);return s.forEach(((t,n)=>e[t]=a+n)),e}),{});for(const[e,t]of Object.entries(n)){const n=Cm.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=qm.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter((e=>!i.has(e))):n);if(o.size>0){const t=qm.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let l=0;for(;;){let t=null,n=l;for(;s.lastIndex=n,t=s.exec(e),null!=t&&!i.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(l,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?a.push(...Fm(e,this.rankMap)):a.push(n)}if(null==t)break;let c=this.specialTokens[t[0]];a.push(c),l=t.index+t[0].length}return a}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const s=e[r],a=this.textMap.get(s)??this.inverseSpecialTokens[s];null!=a&&(t.push(a),n+=a.length)}const r=new Uint8Array(n);let s=0;for(const e of t)r.set(e,s),s+=e.length;return this.textDecoder.decode(r)}},Hm=qm;Bm=e=>new RegExp(e.map((e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e))).join("|"),"g"),((e,t,n)=>{t in e?Um(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(Hm,"specialTokenRegex"+"",Bm);const zm={},Wm=new Hf({});async function Km(e){return async function(e){return e in zm||(zm[e]=Wm.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new Hm(e))).catch((t=>{throw delete zm[e],t}))),await zm[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}(e))}function Vm(e){return!("object"!=typeof e||!e)&&!!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function)}class Gm extends sm{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Zm extends Gm{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof n.cache?this.cache=n.cache:n.cache?this.cache=Sm.global():this.cache=void 0,this.caller=new Hf(n??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Km("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new Im(e):Array.isArray(e)?new xm(e.map(Sc)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter((([e,t])=>void 0!==t)),s=r.map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return s}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class Jm extends sm{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=Uf(t);return this.func&&await this.func(e,n),this._callWithConfig((e=>Promise.resolve(e)),e,n)}async*transform(e,t){const n=Uf(t);let r,s=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),n))if(yield t,s)if(void 0===r)r=t;else try{r=Fp(r,t)}catch{r=void 0,s=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new fm(new cm({steps:e}))}}function Xm(e){return"function"==typeof e?.parse}class Ym extends Zm{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[t,n]}async invoke(e,t){const n=Ym._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===Ym.prototype._streamResponseChunks)yield this.invoke(e,t);else{const n=Ym._convertInputToPromptValue(e).toChatMessages(),[r,s]=this._separateRunnableConfigFromCallOptions(t),a={...r.metadata,...this.getLsParams(s)},i=await $f.configure(r.callbacks,this.callbacks,r.tags,this.tags,a,this.metadata,{verbose:this.verbose}),o={options:s,invocation_params:this?.invocationParams(s),batch_size:1},l=await(i?.handleChatModelStart(this.toJSON(),[n],r.runId,void 0,o,void 0,void 0,r.runName));let c;try{for await(const e of this._streamResponseChunks(n,s,l?.[0]))e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,c=c?c.concat(e):e}catch(e){throw await Promise.all((l??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((l??[]).map((e=>e?.handleLLMEnd({generations:[[c]]}))))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,n){const r=e.map((e=>e.map(Sc))),s={...n.metadata,...this.getLsParams(t)},a=await $f.configure(n.callbacks,this.callbacks,n.tags,this.tags,s,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this?.invocationParams(t),batch_size:1},o=await(a?.handleChatModelStart(this.toJSON(),r,n.runId,void 0,i,void 0,void 0,n.runName)),l=[],c=[];if(!!o?.[0].handlers.find((e=>Yp(e)||zp(e)))&&1===r.length&&this._streamResponseChunks!==Ym.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(r[0],t,o?.[0]);let n;for await(const t of e)n=void 0===n?t:Fp(n,t);if(void 0===n)throw new Error("Received empty response from chat model call.");l.push([n]),await(o?.[0].handleLLMEnd({generations:l,llmOutput:{}}))}catch(e){throw await(o?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(r.map(((e,n)=>this._generate(e,{...t,promptIndex:n},o?.[n]))));await Promise.all(e.map((async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),l[t]=n.generations,c[t]=n.llmOutput,o?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(o?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})))}const u={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(u,Gp,{value:o?{runIds:o?.map((e=>e.runId))}:void 0,configurable:!0}),u}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:s}){const a=e.map((e=>e.map(Sc))),i={...s.metadata,...this.getLsParams(r)},o=await $f.configure(s.callbacks,this.callbacks,s.tags,this.tags,i,this.metadata,{verbose:this.verbose}),l={options:r,invocation_params:this?.invocationParams(r),batch_size:1,cached:!0},c=await(o?.handleChatModelStart(this.toJSON(),a,s.runId,void 0,l,void 0,void 0,s.runName)),u=[],d=await Promise.allSettled(a.map((async(e,r)=>{const s=Ym._convertInputToPromptValue(e).toString(),a=await t.lookup(s,n);return null==a&&u.push(r),a}))),h=d.map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),p=[];await Promise.all(h.map((async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return p[n]=r,r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const f={generations:p,missingPromptIndices:u};return Object.defineProperty(f,Gp,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),f}async generate(e,t,n){let r;r=Array.isArray(t)?{stop:t}:t;const s=e.map((e=>e.map(Sc))),[a,i]=this._separateRunnableConfigFromCallOptions(r);if(a.callbacks=a.callbacks??n,!this.cache)return this._generateUncached(s,i,a);const{cache:o}=this,l=this._getSerializedCacheKeyParametersForCall(i),{generations:c,missingPromptIndices:u}=await this._generateCached({messages:s,cache:o,llmStringKey:l,parsedOptions:i,handledOptions:a});let d={};if(u.length>0){const e=await this._generateUncached(u.map((e=>s[e])),i,a);await Promise.all(e.generations.map((async(e,t)=>{const n=u[t];c[n]=e;const r=Ym._convertInputToPromptValue(s[n]).toString();return o.update(r,l,e)}))),d=e.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map((e=>e.toChatMessages()));return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map(Sc)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new _c(e),s=await this.call([r],t,n);if("string"!=typeof s.content)throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');const n=e,r=t?.name,s=n.description??"A function available to call.",a=t?.method,i=t?.includeRaw;if("jsonMode"===a)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o,l=r??"extract";Xm(n)?o=[{type:"function",function:{name:l,description:s,parameters:Os(n)}}]:("name"in n&&(l=n.name),o=[{type:"function",function:{name:l,description:s,parameters:n}}]);const c=this.bindTools(o),u=dm.from((e=>{if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find((e=>e.name===l));if(!t)throw new Error(`No tool call found with name ${l}.`);return t.args}));if(!i)return c.pipe(u).withConfig({runName:"StructuredOutput"});const d=Jm.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),h=Jm.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return lm.from([{raw:c},p]).withConfig({runName:"StructuredOutputRunnable"})}}function Qm(e){return{name:e.name,description:e.description,parameters:Os(e.schema)}}function eg(e){return tg(e)||function(e){return void 0!==e&&sm.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}(e)?{type:"function",function:Qm(e)}:e}function tg(e){return void 0!==e&&Array.isArray(e.lc_namespace)}class ng extends am{constructor(e){let t=new dm({func:(e,t)=>this._enterHistory(e,t??{})}).withConfig({runName:"loadHistory"});const n=e.historyMessagesKey??e.inputMessagesKey;n&&(t=Jm.assign({[n]:t}).withConfig({runName:"insertHistory"}));const r=t.pipe(e.runnable.withListeners({onEnd:(e,t)=>this._exitHistory(e,t??{})})).withConfig({runName:"RunnableWithMessageHistory"}),s=e.config??{};super({...e,config:s,bound:r}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"historyMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getMessageHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if("object"!=typeof e||Array.isArray(e)||pc(e))t=e;else{let n;n=this.inputMessagesKey?this.inputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"input",t=Array.isArray(e[n])&&Array.isArray(e[n][0])?e[n][0]:e[n]}if("string"==typeof t)return[new _c(t)];if(Array.isArray(t))return t;if(pc(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.\nGot ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(Array.isArray(e)||pc(e)||"string"==typeof e)t=e;else{let n;n=void 0!==this.outputMessagesKey?this.outputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"output",t=void 0!==e.generations?e.generations[0][0].message:e[n]}if("string"==typeof t)return[new mc(t)];if(Array.isArray(t))return t;if(pc(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){const n=t?.configurable?.messageHistory,r=await n.getMessages();return void 0===this.historyMessagesKey?r.concat(this._getInputMessages(e)):r}async _exitHistory(e,t){const n=t.configurable?.messageHistory;let r;r=Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?e.inputs[0]:e.inputs;let s=this._getInputMessages(r);if(void 0===this.historyMessagesKey){const e=await n.getMessages();s=s.slice(e.length)}const a=e.outputs;if(!a)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const i=this._getOutputMessages(a);await n.addMessages([...s,...i])}async _mergeConfig(...e){const t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){const e={[this.inputMessagesKey??"input"]:"foo"},t={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()\neg. chain.invoke(${JSON.stringify(e)}, ${JSON.stringify(t)})`)}const{sessionId:n}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(n),t}}class rg extends sm{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class sg extends rg{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class ag extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}function ig(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!ig(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!ig(e[r],t[r]))return!1;return!0}return e===t}class og extends sg{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class lg extends og{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const s of e){if("string"!=typeof s&&"string"!=typeof s.content)throw new Error("Cannot handle non-string output.");let e;if(pc(r=s)&&"function"==typeof r.concat){if("string"!=typeof s.content)throw new Error("Cannot handle non-string message output.");e=new Jp({message:s,text:s.content})}else if(pc(s)){if("string"!=typeof s.content)throw new Error("Cannot handle non-string message output.");e=new Jp({message:Ic(s),text:s.content})}else e=new Zp({text:s});n=void 0===n?e:n.concat(e);const a=await this.parsePartialResult([n]);null==a||ig(a,t)||(this.diff?yield this._diff(t,a):yield a,t=a)}var r}}class cg extends og{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce(((e,t)=>e+this._messageContentComplexToString(t)),"")}}class ug extends sg{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(Yr.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,Yr.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify(Os(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new ag(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class dg extends lg{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Sp(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Bl(e[0].text)}async parse(e){return Bl(e,JSON.parse)}getFormatInstructions(){return""}}function hg(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=ql(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new ag([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function pg(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function fg(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class mg extends rg{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){const t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);const n=JSON.parse(JSON.stringify(t)),r=[];for(const e of n){const t=hg(e,{partial:!0});if(void 0!==t){const e={type:t.name,args:t.args,id:t.id};Object.defineProperty(e,"name",{get(){return this.type}}),Object.defineProperty(e,"arguments",{get(){return this.args}}),r.push(e)}}return r}}class gg extends rg{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new mg(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new ag(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=(await this.initialParser.parseResult(e)).filter((e=>e.type===this.keyName));let n=t;if(this.returnId||(n=t.map((e=>e.args))),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map((e=>this._validateResult(e))));return r}}function yg(e,t){const n=[];for(const[r,s]of Object.entries(e.properties??{}))s.description&&t<2&&n.push(`// ${s.description}`),e.required?.includes(r)?n.push(`${r}: ${wg(s,t)},`):n.push(`${r}?: ${wg(s,t)},`);return n.map((e=>" ".repeat(t)+e)).join("\n")}function wg(e,t){if(void 0!==(n=e).anyOf&&Array.isArray(n.anyOf))return e.anyOf.map((e=>wg(e,t))).join(" | ");var n;switch(e.type){case"string":return e.enum?e.enum.map((e=>`"${e}"`)).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map((e=>`${e}`)).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",yg(e,t+2),"}"].join("\n");case"array":return e.items?`${wg(e.items,t)}[]`:"any[]";default:return""}}function bg(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!wc.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function vg(e,t){const n=e.tool_calls;if("assistant"===e.role){const r=[],s=[];for(const e of n??[])try{r.push(hg(e,{returnId:!0}))}catch(t){s.push(fg(e,t.message))}return new mc({content:e.content||"",tool_calls:r,invalid_tool_calls:s,additional_kwargs:{function_call:e.function_call,tool_calls:n},id:t})}return new wc(e.content||"",e.role??"unknown")}function _g(e,t,n){const r=e.role??n,s=e.content??"";let a;if(a=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},"user"===r)return new kc({content:s});if("assistant"===r){const n=[];if(Array.isArray(e.tool_calls))for(const t of e.tool_calls)n.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new yc({content:s,tool_call_chunks:n,additional_kwargs:a,id:t})}return"system"===r?new Oc({content:s}):"function"===r?new vc({content:s,additional_kwargs:a,name:e.name}):"tool"===r?new fc({content:s,additional_kwargs:a,tool_call_id:e.tool_call_id}):new bc({content:s,role:r})}function kg(e){return e.map((e=>{const t={role:bg(e),content:e.content};return null!=e.name&&(t.name=e.name),null!=e.additional_kwargs.function_call&&(t.function_call=e.additional_kwargs.function_call,t.content=null),gc(e)&&e.tool_calls?.length?(t.tool_calls=e.tool_calls.map(pg),t.content=null):(null!=e.additional_kwargs.tool_calls&&(t.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(t.tool_call_id=e.tool_call_id)),t}))}class Eg extends Ym{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??Cp("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??Cp("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??Cp("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??Cp("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??Cp("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??Cp("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??Cp("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){return this.bind({tools:e.map(eg),...t})}invocationParams(e,t){let n={};void 0!==e?.stream_options?n={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(n={stream_options:{include_usage:!0}});var r;return{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:(r=e?.tools,void 0!==r&&r.every((e=>Array.isArray(e.lc_namespace)))?e?.tools.map(eg):e?.tools),tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...n,parallel_tool_calls:e?.parallel_tool_calls,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){const r=kg(e),s={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0};let a;const i=await this.completionWithRetry(s,t);let o;for await(const e of i){const r=e?.choices[0];if(e.usage&&(o=e.usage),!r)continue;const{delta:s}=r;if(!s)continue;const i=_g(s,e.id,a);a=s.role??a;const l={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof i.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const c={...l};void 0!==r.finish_reason&&(c.finish_reason=r.finish_reason),this.logprobs&&(c.logprobs=r.logprobs);const u=new Jp({message:i,text:i.content,generationInfo:c});yield u,await(n?.handleLLMNewToken(u.text??"",l,void 0,void 0,void 0,{chunk:u}))}if(o){const e=new Jp({message:new yc({content:"",usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens}}),text:""});yield e}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){const r={},s=this.invocationParams(t),a=kg(e);if(s.stream){const s=this._streamResponseChunks(e,t,n),a={};for await(const e of s){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===a[t]?a[t]=e:a[t]=a[t].concat(e)}const i=Object.entries(a).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t)),{functions:o,function_call:l}=this.invocationParams(t),c=await this.getEstimatedTokenCountFromPrompt(e,o,l),u=await this.getNumTokensFromGenerations(i);return r.promptTokens=c,r.completionTokens=u,r.totalTokens=c+u,{generations:i,llmOutput:{estimatedTokenUsage:r}}}{const e=await this.completionWithRetry({...s,stream:!1,messages:a},{signal:t?.signal,...t?.options}),{completion_tokens:n,prompt_tokens:i,total_tokens:o}=e?.usage??{};n&&(r.completionTokens=(r.completionTokens??0)+n),i&&(r.promptTokens=(r.promptTokens??0)+i),o&&(r.totalTokens=(r.totalTokens??0)+o);const l=[];for(const t of e?.choices??[]){const n={text:t.message?.content??"",message:vg(t.message??{role:"assistant"},e.id)};n.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},gc(n.message)&&(n.message.usage_metadata={input_tokens:r.promptTokens??0,output_tokens:r.completionTokens??0,total_tokens:r.totalTokens??0}),l.push(n)}return{generations:l,llmOutput:{tokenUsage:r}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(yg(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find((e=>"system"===e._getType()))&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map((async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content))))).reduce(((e,t)=>e+t),0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const s=await Promise.all(e.map((async e=>{const s=await this.getNumTokens(e.content),a=await this.getNumTokens(bg(e)),i=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=s+n+a+i;const l=e;if("function"===l._getType()&&(o-=2),l.additional_kwargs?.function_call&&(o+=3),l?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(l.additional_kwargs.function_call?.name)),l.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(l.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(l.additional_kwargs.function_call)),o+=await this.getNumTokens(l.additional_kwargs.function_call?.arguments)}return t+=o,o})));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){const t=function(e){let t;return e.constructor.name===aa.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===ra.name?(t=new Error(e.message),t.name="AbortError"):t=e,t}(e);throw t}}))}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:a,azureADTokenProvider:i}=e;if((r||i)&&s&&t)return`${s}/${t}`;if(r||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return a}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new Fl(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce(((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e)),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,s,a,i,o;if(!function(e){return void 0!==e&&"object"==typeof e.schema}(e)?(n=e,r=t?.name,s=t?.method,a=t?.includeRaw):(n=e.schema,r=e.name,s=e.method,a=e.includeRaw),"jsonMode"===s)i=this.bind({response_format:{type:"json_object"}}),o=Og(n)?ug.fromZodSchema(n):new dg;else{let e=r??"extract";if(Og(n)){const t=Os(n);i=this.bind({tools:[{type:"function",function:{name:e,description:t.description,parameters:t}}],tool_choice:{type:"function",function:{name:e}}}),o=new gg({returnSingle:!0,keyName:e,zodSchema:n})}else{let t;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(t=n,e=n.name):(e=n.title??e,t={name:e,description:n.description??"",parameters:n}),i=this.bind({tools:[{type:"function",function:t}],tool_choice:{type:"function",function:{name:e}}}),o=new gg({returnSingle:!0,keyName:e})}}if(!a)return i.pipe(o);const l=Jm.assign({parsed:(e,t)=>o.invoke(e.raw,t)}),c=Jm.assign({parsed:()=>null}),u=l.withFallbacks({fallbacks:[c]});return lm.from([{raw:i},u])}}function Og(e){return"function"==typeof e?.parse}const Tg="0.22.0";let Sg,Ag,Ig,xg,Pg,Cg,Ng=!1;class Rg{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}Sg||function(e,t={auto:!1}){if(Ng)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${e.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(Sg)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${e.kind}'\` after \`import '@anthropic-ai/sdk/shims/${Sg}'\``);Ng=t.auto,Sg=e.kind,Ag=e.fetch,Ig=e.File,xg=e.ReadableStream,Pg=e.getDefaultAgent,Cg=e.fileFromPath}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new Rg(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class $g extends Error{}class jg extends $g{constructor(e,t,n,r){super(`${jg.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.error=t}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e)return new Mg({cause:yy(t)});const s=t;return 400===e?new Ug(e,s,n,r):401===e?new Fg(e,s,n,r):403===e?new Bg(e,s,n,r):404===e?new qg(e,s,n,r):409===e?new Hg(e,s,n,r):422===e?new zg(e,s,n,r):429===e?new Wg(e,s,n,r):e>=500?new Kg(e,s,n,r):new jg(e,s,n,r)}}class Lg extends jg{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}}class Mg extends jg{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}}class Dg extends Mg{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Ug extends jg{constructor(){super(...arguments),this.status=400}}class Fg extends jg{constructor(){super(...arguments),this.status=401}}class Bg extends jg{constructor(){super(...arguments),this.status=403}}class qg extends jg{constructor(){super(...arguments),this.status=404}}class Hg extends jg{constructor(){super(...arguments),this.status=409}}class zg extends jg{constructor(){super(...arguments),this.status=422}}class Wg extends jg{constructor(){super(...arguments),this.status=429}}class Kg extends jg{}class Vg{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new Vg((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new $g("Attempted to iterate over a response with no body");const n=new Zg,r=new Jg,s=Xg(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,s=new Uint8Array(t.length+e.length);for(s.set(t),s.set(e,t.length),t=s;-1!==(r=Gg(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(s))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t)){if("completion"===n.event)try{yield JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("message_start"===n.event||"message_delta"===n.event||"message_stop"===n.event||"content_block_start"===n.event||"content_block_delta"===n.event||"content_block_stop"===n.event)try{yield JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("ping"!==n.event&&"error"===n.event){const t=n.data,r=hy(t),s=r?void 0:t;throw jg.generate(void 0,r,s,iy(e.headers))}}r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new Vg((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const t of async function*(){const t=new Jg,n=Xg(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())r||t&&(yield JSON.parse(t));r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new Vg((()=>r(e)),this.controller),new Vg((()=>r(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new xg({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:s}=await t.next();if(s)return e.close();const a=n.encode(JSON.stringify(r)+"\n");e.enqueue(a)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function Gg(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class Zg{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}class Jg{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=Jg.NEWLINE_CHARS.has(t[t.length-1]||"");let r=t.split(Jg.NEWLINE_REGEXP);return n&&r.pop(),1!==r.length||n?(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),n||(this.buffer=[r.pop()||""]),r):(this.buffer.push(r[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new $g(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new $g(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new $g("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}function Xg(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}Jg.NEWLINE_CHARS=new Set(["\n","\r"]),Jg.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const Yg=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;const Qg=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,ey=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],ty=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag];async function ny(e){const{response:t}=e;if(e.options.stream)return ky("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Vg.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return ky("response",t.status,t.url,t.headers,e),e}const r=await t.text();return ky("response",t.status,t.url,t.headers,r),r}class ry extends Promise{constructor(e,t=ny){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new ry(this.responsePromise,(async t=>e(await this.parseResponse(t))))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class sy{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:s}){this.baseURL=e,this.maxRetries=gy("maxRetries",t),this.timeout=gy("timeout",n),this.httpAgent=r,this.fetch=s??Ag}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...dy(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Ey()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((n=>({method:e,path:t,...n}))))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder){return(new TextEncoder).encode(e).length.toString()}}return null}buildRequest(e){const{method:t,path:n,query:r,headers:s={}}=e,a=ty(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,i=this.calculateContentLength(a),o=this.buildURL(n,r);"timeout"in e&&gy("timeout",e.timeout);const l=e.timeout??this.timeout,c=e.httpAgent??this.httpAgent??Pg(o),u=l+1e3;"number"==typeof c?.options?.timeout&&u>(c.options.timeout??0)&&(c.options.timeout=u),this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);return{req:{method:t,...a&&{body:a},headers:this.buildHeaders({options:e,headers:s,contentLength:i}),...c&&{agent:c},signal:e.signal??null},url:o,timeout:l}}buildHeaders({options:e,headers:t,contentLength:n}){const r={};n&&(r["content-length"]=n);return _y(r,this.defaultHeaders(e)),_y(r,t),ty(e.body)&&"node"!==Sg&&delete r["content-type"],this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return jg.generate(e,t,n,r)}request(e,t=null){return new ry(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e;null==t&&(t=n.maxRetries??this.maxRetries),await this.prepareOptions(n);const{req:r,url:s,timeout:a}=this.buildRequest(n);if(await this.prepareRequest(r,{url:s,options:n}),ky("request",s,n,r.headers),n.signal?.aborted)throw new Lg;const i=new AbortController,o=await this.fetchWithTimeout(s,r,a,i).catch(yy);if(o instanceof Error){if(n.signal?.aborted)throw new Lg;if(t)return this.retryRequest(n,t);if("AbortError"===o.name)throw new Dg;throw new Mg({cause:o})}const l=iy(o.headers);if(!o.ok){if(t&&this.shouldRetry(o)){return ky(`response (error; ${`retrying, ${t} attempts remaining`})`,o.status,s,l),this.retryRequest(n,t,l)}const e=await o.text().catch((e=>yy(e).message)),r=hy(e),a=r?void 0:e;ky(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,o.status,s,l,a);throw this.makeStatusError(o.status,r,a,l)}return{response:o,options:n,controller:i}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new ay(this,n,e)}buildURL(e,t){const n=fy(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return by(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new $g(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:s,...a}=t||{};s&&s.addEventListener("abort",(()=>r.abort()));const i=setTimeout((()=>r.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...a}).finally((()=>{clearTimeout(i)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n){let r;const s=n?.["retry-after-ms"];if(s){const e=parseFloat(s);Number.isNaN(e)||(r=e)}const a=n?.["retry-after"];if(a&&!r){const e=parseFloat(a);r=Number.isNaN(e)?Date.parse(a)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await my(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Tg}`}}class ay extends ry{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await ny(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const iy=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),oy=()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tg,"X-Stainless-OS":cy(Deno.build.os),"X-Stainless-Arch":ly(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tg,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tg,"X-Stainless-OS":cy(process.platform),"X-Stainless-Arch":ly(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tg,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Tg,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const ly=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",cy=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let uy;const dy=()=>uy??(uy=oy()),hy=e=>{try{return JSON.parse(e)}catch(e){return}},py=new RegExp("^(?:[a-z]+:)?//","i"),fy=e=>py.test(e),my=e=>new Promise((t=>setTimeout(t,e))),gy=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new $g(`${e} must be an integer`);if(t<0)throw new $g(`${e} must be a positive integer`);return t},yy=e=>e instanceof Error?e:new Error(e),wy=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function by(e){if(!e)return!0;for(const t in e)return!1;return!0}function vy(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function _y(e,t){for(const n in t){if(!vy(t,n))continue;const r=n.toLowerCase();if(!r)continue;const s=t[n];null===s?delete e[r]:void 0!==s&&(e[r]=s)}}function ky(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`Anthropic:DEBUG:${e}`,...t)}const Ey=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));class Oy{constructor(e){this._client=e}}class Ty extends Oy{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:6e5,...t,stream:e.stream??!1})}}Ty||(Ty={});const Sy=e=>{if(0===e.length)return e;let t=e[e.length-1];switch(t.type){case"separator":return e=e.slice(0,e.length-1),Sy(e);case"number":let n=t.value[t.value.length-1];if("."===n||"-"===n)return e=e.slice(0,e.length-1),Sy(e);case"string":let r=e[e.length-2];if("delimiter"===r?.type)return e=e.slice(0,e.length-1),Sy(e);if("brace"===r?.type&&"{"===r.value)return e=e.slice(0,e.length-1),Sy(e);break;case"delimiter":return e=e.slice(0,e.length-1),Sy(e)}return e},Ay=e=>JSON.parse((e=>{let t="";return e.map((e=>{"string"===e.type?t+='"'+e.value+'"':t+=e.value})),t})((e=>{let t=[];return e.map((e=>{"brace"===e.type&&("{"===e.value?t.push("}"):t.splice(t.lastIndexOf("}"),1)),"paren"===e.type&&("["===e.value?t.push("]"):t.splice(t.lastIndexOf("]"),1))})),t.length>0&&t.reverse().map((t=>{"}"===t?e.push({type:"brace",value:"}"}):"]"===t&&e.push({type:"paren",value:"]"})})),e})(Sy((e=>{let t=0,n=[];for(;t<e.length;){let r=e[t];if("\\"===r){t++;continue}if("{"===r){n.push({type:"brace",value:"{"}),t++;continue}if("}"===r){n.push({type:"brace",value:"}"}),t++;continue}if("["===r){n.push({type:"paren",value:"["}),t++;continue}if("]"===r){n.push({type:"paren",value:"]"}),t++;continue}if(":"===r){n.push({type:"separator",value:":"}),t++;continue}if(","===r){n.push({type:"delimiter",value:","}),t++;continue}if('"'===r){let s="",a=!1;for(r=e[++t];'"'!==r;){if(t===e.length){a=!0;break}if("\\"===r){if(t++,t===e.length){a=!0;break}s+=r+e[t],r=e[++t]}else s+=r,r=e[++t]}r=e[++t],a||n.push({type:"string",value:s});continue}if(r&&/\s/.test(r)){t++;continue}let s=/[0-9]/;if(r&&s.test(r)||"-"===r||"."===r){let a="";for("-"===r&&(a+=r,r=e[++t]);r&&s.test(r)||"."===r;)a+=r,r=e[++t];n.push({type:"number",value:a});continue}let a=/[a-z]/i;if(r&&a.test(r)){let s="";for(;r&&a.test(r)&&t!==e.length;)s+=r,r=e[++t];if("true"!=s&&"false"!=s)throw new Error(`Invalid token: ${s} is not a valid token!`);n.push({type:"name",value:s})}else t++}return n})(e)))));var Iy,xy,Py,Cy,Ny,Ry,$y,jy,Ly,My,Dy,Uy,Fy,By,qy,Hy,zy,Wy,Ky,Vy,Gy=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},Zy=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const Jy="__json_buf";class Xy{constructor(){Iy.add(this),this.messages=[],this.receivedMessages=[],xy.set(this,void 0),this.controller=new AbortController,Py.set(this,void 0),Cy.set(this,(()=>{})),Ny.set(this,(()=>{})),Ry.set(this,void 0),$y.set(this,(()=>{})),jy.set(this,(()=>{})),Ly.set(this,{}),My.set(this,!1),Dy.set(this,!1),Uy.set(this,!1),Fy.set(this,!1),Hy.set(this,(e=>{if(Gy(this,Dy,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new Lg),e instanceof Lg)return Gy(this,Uy,!0,"f"),this._emit("abort",e);if(e instanceof $g)return this._emit("error",e);if(e instanceof Error){const t=new $g(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new $g(String(e)))})),Gy(this,Py,new Promise(((e,t)=>{Gy(this,Cy,e,"f"),Gy(this,Ny,t,"f")})),"f"),Gy(this,Ry,new Promise(((e,t)=>{Gy(this,$y,e,"f"),Gy(this,jy,t,"f")})),"f"),Zy(this,Py,"f").catch((()=>{})),Zy(this,Ry,"f").catch((()=>{}))}static fromReadableStream(e){const t=new Xy;return t._run((()=>t._fromReadableStream(e))),t}static createMessage(e,t,n){const r=new Xy;for(const e of t.messages)r._addMessageParam(e);return r._run((()=>r._createMessage(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}_run(e){e().then((()=>{this._emitFinal(),this._emit("end")}),Zy(this,Hy,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Zy(this,Iy,"m",zy).call(this);const s=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of s)Zy(this,Iy,"m",Wy).call(this,e);if(s.controller.signal?.aborted)throw new Lg;Zy(this,Iy,"m",Ky).call(this)}_connected(){this.ended||(Zy(this,Cy,"f").call(this),this._emit("connect"))}get ended(){return Zy(this,My,"f")}get errored(){return Zy(this,Dy,"f")}get aborted(){return Zy(this,Uy,"f")}abort(){this.controller.abort()}on(e,t){return(Zy(this,Ly,"f")[e]||(Zy(this,Ly,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Zy(this,Ly,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(Zy(this,Ly,"f")[e]||(Zy(this,Ly,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Gy(this,Fy,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Gy(this,Fy,!0,"f"),await Zy(this,Ry,"f")}get currentMessage(){return Zy(this,xy,"f")}async finalMessage(){return await this.done(),Zy(this,Iy,"m",By).call(this)}async finalText(){return await this.done(),Zy(this,Iy,"m",qy).call(this)}_emit(e,...t){if(Zy(this,My,"f"))return;"end"===e&&(Gy(this,My,!0,"f"),Zy(this,$y,"f").call(this));const n=Zy(this,Ly,"f")[e];if(n&&(Zy(this,Ly,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return Zy(this,Fy,"f")||n?.length||Promise.reject(e),Zy(this,Ny,"f").call(this,e),Zy(this,jy,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Zy(this,Fy,"f")||n?.length||Promise.reject(e),Zy(this,Ny,"f").call(this,e),Zy(this,jy,"f").call(this,e),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",Zy(this,Iy,"m",By).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),Zy(this,Iy,"m",zy).call(this),this._connected();const r=Vg.fromReadableStream(e,this.controller);for await(const e of r)Zy(this,Iy,"m",Wy).call(this,e);if(r.controller.signal?.aborted)throw new Lg;Zy(this,Iy,"m",Ky).call(this)}[(xy=new WeakMap,Py=new WeakMap,Cy=new WeakMap,Ny=new WeakMap,Ry=new WeakMap,$y=new WeakMap,jy=new WeakMap,Ly=new WeakMap,My=new WeakMap,Dy=new WeakMap,Uy=new WeakMap,Fy=new WeakMap,Hy=new WeakMap,Iy=new WeakSet,By=function(){if(0===this.receivedMessages.length)throw new $g("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},qy=function(){if(0===this.receivedMessages.length)throw new $g("stream ended without producing a Message with role=assistant");const e=this.receivedMessages.at(-1).content.filter((e=>"text"===e.type)).map((e=>e.text));if(0===e.length)throw new $g("stream ended without producing a content block with type=text");return e.join(" ")},zy=function(){this.ended||Gy(this,xy,void 0,"f")},Wy=function(e){if(this.ended)return;const t=Zy(this,Iy,"m",Vy).call(this,e);switch(this._emit("streamEvent",e,t),e.type){case"content_block_delta":{const n=t.content.at(-1);"text_delta"===e.delta.type&&"text"===n.type?this._emit("text",e.delta.text,n.text||""):"input_json_delta"===e.delta.type&&"tool_use"===n.type&&n.input&&this._emit("inputJson",e.delta.partial_json,n.input);break}case"message_stop":this._addMessageParam(t),this._addMessage(t,!0);break;case"content_block_stop":this._emit("contentBlock",t.content.at(-1));break;case"message_start":Gy(this,xy,t,"f")}},Ky=function(){if(this.ended)throw new $g("stream has ended, this shouldn't happen");const e=Zy(this,xy,"f");if(!e)throw new $g("request ended without sending any chunks");return Gy(this,xy,void 0,"f"),e},Vy=function(e){let t=Zy(this,xy,"f");if("message_start"===e.type){if(t)throw new $g(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!t)throw new $g(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":case"content_block_stop":return t;case"message_delta":return t.stop_reason=e.delta.stop_reason,t.stop_sequence=e.delta.stop_sequence,t.usage.output_tokens=e.usage.output_tokens,t;case"content_block_start":return t.content.push(e.content_block),t;case"content_block_delta":{const n=t.content.at(e.index);if("text"===n?.type&&"text_delta"===e.delta.type)n.text+=e.delta.text;else if("tool_use"===n?.type&&"input_json_delta"===e.delta.type){let t=n[Jy]||"";t+=e.delta.partial_json,Object.defineProperty(n,Jy,{value:t,enumerable:!1,writable:!0}),t&&(n.input=Ay(t))}return t}}},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("streamEvent",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Vg(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class Yy extends Oy{create(e,t){return this._client.post("/v1/messages",{body:e,timeout:6e5,...t,stream:e.stream??!1})}stream(e,t){return Xy.createMessage(this,e,t)}}var Qy;Yy||(Yy={});class ew extends sy{constructor({baseURL:e=wy("ANTHROPIC_BASE_URL"),apiKey:t=wy("ANTHROPIC_API_KEY")??null,authToken:n=wy("ANTHROPIC_AUTH_TOKEN")??null,...r}={}){const s={apiKey:t,authToken:n,...r,baseURL:e||"https://api.anthropic.com"};super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Ty(this),this.messages=new Yy(this),this._options=s,this.apiKey=t,this.authToken=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"]||null===t["x-api-key"]||this.authToken&&e.authorization||null===t.authorization))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){const t=this.apiKeyAuth(e),n=this.bearerAuth(e);return null==t||by(t)?null==n||by(n)?{}:n:t}apiKeyAuth(e){return null==this.apiKey?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return null==this.authToken?{}:{Authorization:`Bearer ${this.authToken}`}}}Qy=ew,ew.Anthropic=Qy,ew.HUMAN_PROMPT="\n\nHuman:",ew.AI_PROMPT="\n\nAssistant:",ew.AnthropicError=$g,ew.APIError=jg,ew.APIConnectionError=Mg,ew.APIConnectionTimeoutError=Dg,ew.APIUserAbortError=Lg,ew.NotFoundError=qg,ew.ConflictError=Hg,ew.RateLimitError=Wg,ew.BadRequestError=Ug,ew.AuthenticationError=Fg,ew.InternalServerError=Kg,ew.PermissionDeniedError=Bg,ew.UnprocessableEntityError=zg,ew.toFile=async function(e,t,n){if(e=await e,n??(n=(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Yg(e))(e)?{lastModified:e.lastModified,type:e.type}:{}),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new Ig([r],t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Yg(e))t.push(await e.arrayBuffer());else{if(!ey(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){const t=Object.getOwnPropertyNames(e);return`[${t.map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return Qg(e.name)||Qg(e.filename)||Qg(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new Ig(r,t,n)},ew.fileFromPath=Cg,function(e){e.Completions=Ty,e.Messages=Yy}(ew||(ew={}));class tw extends rg{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new ag(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap((e=>{const{message:t}=e;if(!Array.isArray(t.content))return[];return nw(t.content)[0]}));if(void 0===t[0])throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}function nw(e){const t=[];for(const n of e)"tool_use"===n.type&&t.push({name:n.name,args:n.input,id:n.id});return t}function rw(e){const t=e.match(/^data:(image\/.+);base64,(.+)$/);if(null===t)throw new Error(["Anthropic only supports base64-encoded images currently.","Example: data:image/png;base64,/9j/4AAQSk..."].join("\n\n"));return{type:"base64",media_type:t[1]??"",data:t[2]??""}}function sw(e){return"input_schema"in e}function aw(e){if(void 0===e.id)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:e.id,name:e.name,input:e.args}}function iw(e){if("string"==typeof e)return e;return e.map((e=>{if("image_url"===e.type){let t;return t="string"==typeof e.image_url?rw(e.image_url):rw(e.image_url.url),{type:"image",source:t}}if("text"===e.type)return{type:"text",text:e.text};if("tool_use"===e.type||"tool_result"===e.type)return{...e};throw new Error("Unsupported message content format")}))}function ow(e){const t=function(e){const t=[];for(const n of e)if("tool"===n._getType())"string"==typeof n.content?t.push(new _c({content:[{type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}]})):t.push(new _c({content:n.content}));else{const e=t[t.length-1];if("human"===e?._getType()&&"human"===n._getType()){let t;t="string"==typeof e.content?[{type:"text",text:e.content}]:e.content,"string"==typeof n.content?t.push({type:"text",text:n.content}):t=t.concat(n.content),e.content=t}else t.push(n)}return t}(e);let n;if(t.length>0&&"system"===t[0]._getType()){if("string"!=typeof e[0].content)throw new Error("System message content must be a string.");n=e[0].content}return{messages:(void 0!==n?t.slice(1):t).map((e=>{let t;if("human"===e._getType())t="user";else if("ai"===e._getType())t="assistant";else{if("tool"!==e._getType())throw"system"===e._getType()?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${e._getType()}" is not supported.`);t="user"}if(gc(e)&&e.tool_calls?.length){if("string"==typeof e.content)return""===e.content?{role:t,content:e.tool_calls.map(aw)}:{role:t,content:[{type:"text",text:e.content},...e.tool_calls.map(aw)]};{const{content:n}=e;return!e.tool_calls.every((e=>n.find((t=>"tool_use"===t.type&&t.id===e.id))))&&console.warn('The "tool_calls" field on a message is only respected if content is a string.'),{role:t,content:iw(e.content)}}}return{role:t,content:iw(e.content)}})),system:n}}class lw extends Ym{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.anthropicApiKey=e?.apiKey??e?.anthropicApiKey??Cp("ANTHROPIC_API_KEY"),!this.anthropicApiKey)throw new Error("Anthropic API key not found");this.apiKey=this.anthropicApiKey,this.apiUrl=e?.anthropicApiUrl,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.invocationKwargs=e?.invocationKwargs??{},this.temperature=e?.temperature??this.temperature,this.topK=e?.topK??this.topK,this.topP=e?.topP??this.topP,this.maxTokens=e?.maxTokensToSample??e?.maxTokens??this.maxTokens,this.stopSequences=e?.stopSequences??this.stopSequences,this.streaming=e?.streaming??!1,this.clientOptions=e?.clientOptions??{},this.streamUsage=e?.streamUsage??this.streamUsage}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(e&&e.length){if(e.every((e=>sw(e))))return e;if(e.every((e=>Vm(e))))return e.map((e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters})));if(e.some((e=>sw(e))))throw new Error("Can not pass in a mix of tool schemas to ChatAnthropic");return e.map((e=>({name:e.name,description:e.description,input_schema:Os(e.schema)})))}}bindTools(e,t){return this.bind({tools:this.formatStructuredToolToAnthropic(e),...t})}invocationParams(e){let t;return e?.tool_choice&&(t="any"===e?.tool_choice?{type:"any"}:"auto"===e?.tool_choice?{type:"auto"}:e?.tool_choice),{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:e?.stop??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e?.tools),tool_choice:t,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,t,n){const r=this.invocationParams(t),s=ow(e);if(void 0!==t.tools&&t.tools.length>0){const{generations:n}=await this._generateNonStreaming(e,r,{signal:t.signal}),s=n[0].message,a=s.tool_calls?.map(((e,t)=>({name:e.name,args:JSON.stringify(e.args),id:e.id,index:t})));yield new Jp({message:new yc({content:s.content,additional_kwargs:s.additional_kwargs,tool_call_chunks:a}),text:n[0].text})}else{const e=await this.createStreamWithRetry({...r,...s,stream:!0});let a,i={input_tokens:0,output_tokens:0};for await(const r of e){if(t.signal?.aborted)throw e.controller.abort(),new Error("AbortError: User aborted the request.");if("message_start"===r.type){const{content:e,usage:n,...s}=r.message,a={};for(const[e,t]of Object.entries(s))null!=t&&(a[e]=t);let o;i=n,(this.streamUsage||t.streamUsage)&&(o={input_tokens:n.input_tokens,output_tokens:n.output_tokens,total_tokens:n.input_tokens+n.output_tokens}),yield new Jp({message:new yc({content:"",additional_kwargs:a,usage_metadata:o}),text:""})}else if("message_delta"===r.type){let e;(this.streamUsage||t.streamUsage)&&(e={input_tokens:r.usage.output_tokens,output_tokens:0,total_tokens:r.usage.output_tokens}),yield new Jp({message:new yc({content:"",additional_kwargs:{...r.delta},usage_metadata:e}),text:""}),void 0!==r?.usage&&(i.output_tokens+=r.usage.output_tokens)}else if("content_block_delta"===r.type&&"text_delta"===r.delta.type){const e=r.delta?.text;void 0!==e&&(yield new Jp({message:new yc({content:e,additional_kwargs:{}}),text:e}),await(n?.handleLLMNewToken(e)))}}(this.streamUsage||t.streamUsage)&&(a={input_tokens:i.input_tokens,output_tokens:i.output_tokens,total_tokens:i.input_tokens+i.output_tokens}),yield new Jp({message:new yc({content:"",additional_kwargs:{usage:i},usage_metadata:a}),text:""})}}async _generateNonStreaming(e,t,n){const r=void 0!==t.tools?{...n,headers:{...n.headers,"anthropic-beta":"tools-2024-04-04"}}:n,s=await this.completionWithRetry({...t,stream:!1,...ow(e)},r),{content:a,...i}=s,o=function(e,t){const n=t.usage,r=null!=n?{input_tokens:n.input_tokens??0,output_tokens:n.output_tokens??0,total_tokens:(n.input_tokens??0)+(n.output_tokens??0)}:void 0;if(1===e.length&&"text"===e[0].type)return[{text:e[0].text,message:new mc({content:e[0].text,additional_kwargs:t,usage_metadata:r})}];{const n=nw(e);return[{text:"",message:new mc({content:e,additional_kwargs:t,tool_calls:n,usage_metadata:r})}]}}(a,i),{role:l,type:c,...u}=i;return{generations:o,llmOutput:u}}async _generate(e,t,n){if(this.stopSequences&&t.stop)throw new Error('"stopSequence" parameter found in input and default params');const r=this.invocationParams(t);if(r.stream){let r;const s=this._streamResponseChunks(e,t,n);for await(const e of s)r=void 0===r?e:r.concat(e);if(void 0===r)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:r.text,message:r.message}]}}return this._generateNonStreaming(e,r,{signal:t.signal})}async createStreamWithRetry(e,t){if(!this.streamingClient){const e=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=new ew({...this.clientOptions,...e,apiKey:this.apiKey,maxRetries:0})}return this.caller.call((async()=>this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},t)))}async completionWithRetry(e,t){if(!this.apiKey)throw new Error("Missing Anthropic API key.");if(!this.batchClient){const e=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.batchClient=new ew({...this.clientOptions,...e,apiKey:this.apiKey,maxRetries:0})}return this.caller.callWithOptions({signal:t.signal??void 0},(async()=>this.batchClient.messages.create({...e,...this.invocationKwargs},t)))}_llmType(){return"anthropic"}withStructuredOutput(e,t){const n=e,r=t?.name,s=t?.method,a=t?.includeRaw;if("jsonMode"===s)throw new Error('Anthropic only supports "functionCalling" as a method.');let i,o,l=r??"extract";if(Xm(n)){const e=Os(n);o=[{name:l,description:e.description??"A function available to call.",input_schema:e}],i=new tw({returnSingle:!0,keyName:l,zodSchema:n})}else{let e;"string"==typeof n.name&&"string"==typeof n.description&&"object"==typeof n.input_schema&&null!=n.input_schema?(e=n,l=n.name):e={name:l,description:n.description??"",input_schema:n},o=[e],i=new tw({returnSingle:!0,keyName:l})}const c=this.bind({tools:o,tool_choice:{type:"tool",name:l}});if(!a)return c.pipe(i).withConfig({runName:"ChatAnthropicStructuredOutput"});const u=Jm.assign({parsed:(e,t)=>i.invoke(e.raw,t)}),d=Jm.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[d]});return lm.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}}class cw extends lw{}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const uw=["user","model","function","system"];var dw,hw,pw,fw,mw,gw,yw,ww;!function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"}(dw||(dw={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(hw||(hw={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(pw||(pw={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(fw||(fw={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.OTHER="OTHER"}(mw||(mw={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(gw||(gw={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"}(yw||(yw={})),function(e){e.STRING="STRING",e.NUMBER="NUMBER",e.INTEGER="INTEGER",e.BOOLEAN="BOOLEAN",e.ARRAY="ARRAY",e.OBJECT="OBJECT"}(ww||(ww={}));
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class bw extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class vw extends bw{constructor(e,t){super(e),this.response=t}}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var _w;!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(_w||(_w={}));class kw{constructor(e,t,n,r,s){this.model=e,this.task=t,this.apiKey=n,this.stream=r,this.requestOptions=s}toString(){var e,t;const n=(null===(e=this.requestOptions)||void 0===e?void 0:e.apiVersion)||"v1beta";let r=`${(null===(t=this.requestOptions)||void 0===t?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com"}/${n}/${this.model}:${this.task}`;return this.stream&&(r+="?alt=sse"),r}}async function Ew(e){const t=new Headers;return t.append("Content-Type","application/json"),t.append("x-goog-api-client",function(e){const t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push("genai-js/0.7.1"),t.join(" ")}(e.requestOptions)),t.append("x-goog-api-key",e.apiKey),t}async function Ow(e,t,n,r,s,a){return async function(e,t,n,r,s,a,i=fetch){const o=new kw(e,t,n,r,a);let l;try{const o=await async function(e,t,n,r,s,a){const i=new kw(e,t,n,r,a);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},Tw(a)),{method:"POST",headers:await Ew(i),body:s})}}(e,t,n,r,s,a);if(l=await i(o.url,o.fetchOptions),!l.ok){let e="";try{const t=await l.json();e=t.error.message,t.error.details&&(e+=` ${JSON.stringify(t.error.details)}`)}catch(e){}throw new Error(`[${l.status} ${l.statusText}] ${e}`)}}catch(e){const t=new bw(`Error fetching from ${o.toString()}: ${e.message}`);throw t.stack=e.stack,t}return l}(e,t,n,r,s,a,fetch)}function Tw(e){const t={};if((null==e?void 0:e.timeout)>=0){const n=new AbortController,r=n.signal;setTimeout((()=>n.abort()),e.timeout),t.signal=r}return t}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Sw(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),xw(e.candidates[0]))throw new vw(`${Pw(e)}`,e);return function(e){var t,n,r,s;return(null===(s=null===(r=null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)||void 0===r?void 0:r[0])||void 0===s?void 0:s.text)?e.candidates[0].content.parts.map((({text:e})=>e)).join(""):""}(e)}if(e.promptFeedback)throw new vw(`Text not available. ${Pw(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),xw(e.candidates[0]))throw new vw(`${Pw(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),Aw(e)[0]}if(e.promptFeedback)throw new vw(`Function call not available. ${Pw(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),xw(e.candidates[0]))throw new vw(`${Pw(e)}`,e);return Aw(e)}if(e.promptFeedback)throw new vw(`Function call not available. ${Pw(e)}`,e)},e}function Aw(e){var t,n,r,s;const a=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(s=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===s?void 0:s.parts)t.functionCall&&a.push(t.functionCall);return a.length>0?a:void 0}const Iw=[mw.RECITATION,mw.SAFETY];function xw(e){return!!e.finishReason&&Iw.includes(e.finishReason)}function Pw(e){var t,n,r;let s="";if(e.candidates&&0!==e.candidates.length||!e.promptFeedback){if(null===(r=e.candidates)||void 0===r?void 0:r[0]){const t=e.candidates[0];xw(t)&&(s+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(s+=`: ${t.finishMessage}`))}}else s+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(s+=` due to ${e.promptFeedback.blockReason}`),(null===(n=e.promptFeedback)||void 0===n?void 0:n.blockReasonMessage)&&(s+=`: ${e.promptFeedback.blockReasonMessage}`);return s}function Cw(e){return this instanceof Cw?(this.v=e,this):new Cw(e)}function Nw(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),a=[];return r={},i("next"),i("throw"),i("return"),r[Symbol.asyncIterator]=function(){return this},r;function i(e){s[e]&&(r[e]=function(t){return new Promise((function(n,r){a.push([e,t,n,r])>1||o(e,t)}))})}function o(e,t){try{!function(e){e.value instanceof Cw?Promise.resolve(e.value.v).then(l,c):u(a[0][2],e)}(s[e](t))}catch(e){u(a[0][3],e)}}function l(e){o("next",e)}function c(e){o("throw",e)}function u(e,t){e(t),a.shift(),a.length&&o(a[0][0],a[0][1])}}"function"==typeof SuppressedError&&SuppressedError;
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Rw=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function $w(e){const t=function(e){const t=e.getReader(),n=new ReadableStream({start(e){let n="";return r();function r(){return t.read().then((({value:t,done:s})=>{if(s)return n.trim()?void e.error(new bw("Failed to parse stream")):void e.close();n+=t;let a,i=n.match(Rw);for(;i;){try{a=JSON.parse(i[1])}catch(t){return void e.error(new bw(`Error parsing JSON response: "${i[1]}"`))}e.enqueue(a),n=n.substring(i[0].length),i=n.match(Rw)}return r()}))}}});return n}(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))),[n,r]=t.tee();return{stream:Lw(n),response:jw(r)}}async function jw(e){const t=[],n=e.getReader();for(;;){const{done:e,value:r}=await n.read();if(e)return Sw(Mw(t));t.push(r)}}function Lw(e){return Nw(this,arguments,(function*(){const t=e.getReader();for(;;){const{value:e,done:n}=yield Cw(t.read());if(n)break;yield yield Cw(Sw(e))}}))}function Mw(e){const t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(const t of e)if(t.candidates)for(const e of t.candidates){const t=e.index;if(n.candidates||(n.candidates=[]),n.candidates[t]||(n.candidates[t]={index:e.index}),n.candidates[t].citationMetadata=e.citationMetadata,n.candidates[t].finishReason=e.finishReason,n.candidates[t].finishMessage=e.finishMessage,n.candidates[t].safetyRatings=e.safetyRatings,e.content&&e.content.parts){n.candidates[t].content||(n.candidates[t].content={role:e.content.role||"user",parts:[]});const r={};for(const s of e.content.parts)s.text&&(r.text=s.text),s.functionCall&&(r.functionCall=s.functionCall),0===Object.keys(r).length&&(r.text=""),n.candidates[t].content.parts.push(r)}}return n}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function Dw(e,t,n,r){return $w(await Ow(t,_w.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),r))}async function Uw(e,t,n,r){const s=await Ow(t,_w.GENERATE_CONTENT,e,!1,JSON.stringify(n),r);return{response:Sw(await s.json())}}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fw(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(const n of e)"string"==typeof n?t.push({text:n}):t.push(n);return function(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let r=!1,s=!1;for(const a of e)"functionResponse"in a?(n.parts.push(a),s=!0):(t.parts.push(a),r=!0);if(r&&s)throw new bw("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!s)throw new bw("No content is provided for sending chat message.");if(r)return t;return n}(t)}function Bw(e){if(e.contents)return e;return{contents:[Fw(e)]}}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const qw=["text","inlineData","functionCall","functionResponse"],Hw={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall"],system:["text"]},zw={user:["model"],function:["model"],model:["user","function"],system:[]};
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
const Ww="SILENT_ERROR";class Kw{constructor(e,t,n,r){this.model=t,this.params=n,this.requestOptions=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==n?void 0:n.history)&&(!function(e){let t;for(const n of e){const{role:e,parts:r}=n;if(!t&&"user"!==e)throw new bw(`First content should be with role 'user', got ${e}`);if(!uw.includes(e))throw new bw(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(uw)}`);if(!Array.isArray(r))throw new bw("Content should have 'parts' property with an array of Parts");if(0===r.length)throw new bw("Each Content should have at least one part");const s={text:0,inlineData:0,functionCall:0,functionResponse:0};for(const e of r)for(const t of qw)t in e&&(s[t]+=1);const a=Hw[e];for(const t of qw)if(!a.includes(t)&&s[t]>0)throw new bw(`Content with role '${e}' can't contain '${t}' part`);if(t&&!zw[e].includes(t.role))throw new bw(`Content with role '${e}' can't follow '${t.role}'. Valid previous roles: ${JSON.stringify(zw)}`);t=n}}(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,n,r,s,a;await this._sendPromise;const i=Fw(e),o={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(n=this.params)||void 0===n?void 0:n.generationConfig,tools:null===(r=this.params)||void 0===r?void 0:r.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(a=this.params)||void 0===a?void 0:a.systemInstruction,contents:[...this._history,i]};let l;return this._sendPromise=this._sendPromise.then((()=>Uw(this._apiKey,this.model,o,this.requestOptions))).then((e=>{var t;if(e.response.candidates&&e.response.candidates.length>0){this._history.push(i);const n=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(n)}else{const t=Pw(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e})),await this._sendPromise,l}async sendMessageStream(e){var t,n,r,s,a;await this._sendPromise;const i=Fw(e),o={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(n=this.params)||void 0===n?void 0:n.generationConfig,tools:null===(r=this.params)||void 0===r?void 0:r.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(a=this.params)||void 0===a?void 0:a.systemInstruction,contents:[...this._history,i]},l=Dw(this._apiKey,this.model,o,this.requestOptions);return this._sendPromise=this._sendPromise.then((()=>l)).catch((e=>{throw new Error(Ww)})).then((e=>e.response)).then((e=>{if(e.candidates&&e.candidates.length>0){this._history.push(i);const t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{const t=Pw(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}})).catch((e=>{e.message!==Ww&&console.error(e)})),l}}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
class Vw{constructor(e,t,n){this.apiKey=e,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=t.systemInstruction,this.requestOptions=n||{}}async generateContent(e){const t=Bw(e);return Uw(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}async generateContentStream(e){const t=Bw(e);return Dw(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}startChat(e){return new Kw(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},e),this.requestOptions)}async countTokens(e){const t=Bw(e);return async function(e,t,n,r){return(await Ow(t,_w.COUNT_TOKENS,e,!1,JSON.stringify(Object.assign(Object.assign({},n),{model:t})),r)).json()}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */(this.apiKey,this.model,t,this.requestOptions)}async embedContent(e){const t=function(e){if("string"==typeof e||Array.isArray(e))return{content:Fw(e)};return e}(e);return async function(e,t,n,r){return(await Ow(t,_w.EMBED_CONTENT,e,!1,JSON.stringify(n),r)).json()}(this.apiKey,this.model,t,this.requestOptions)}async batchEmbedContents(e){return async function(e,t,n,r){const s=n.requests.map((e=>Object.assign(Object.assign({},e),{model:t})));return(await Ow(t,_w.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:s}),r)).json()}(this.apiKey,this.model,e,this.requestOptions)}}
/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gw{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new bw("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Vw(this.apiKey,e,t)}}function Zw(e){if("object"==typeof e&&null!==e){const t={...e};"additionalProperties"in t&&"boolean"==typeof t.additionalProperties&&delete t.additionalProperties;for(const e in t)e in t&&(Array.isArray(t[e])?t[e]=t[e].map(Zw):"object"==typeof t[e]&&null!==t[e]&&(t[e]=Zw(t[e])));return t}return e}function Jw(e){const t=Zw(Os(e)),{$schema:n,...r}=t;return r}function Xw(e){const t=Zw(e),{$schema:n,...r}=t;return r}function Yw(e,t){if("string"==typeof e.content&&""!==e.content)return[{text:e.content}];let n=[],r=[],s=[];return"tool_calls"in e&&Array.isArray(e.tool_calls)&&e.tool_calls.length>0?n=e.tool_calls.map((e=>({functionCall:{name:e.name,args:e.args}}))):"tool"===e._getType()&&e.name&&e.content?r=[{functionResponse:{name:e.name,response:e.content}}]:Array.isArray(e.content)&&(s=e.content.map((e=>{if("text"===e.type)return{text:e.text};if("image_url"===e.type){if(!t)throw new Error("This model does not support images");let n;if("string"==typeof e.image_url)n=e.image_url;else{if("object"!=typeof e.image_url||!("url"in e.image_url))throw new Error("Please provide image as base64 encoded data URL");n=e.image_url.url}const[r,s]=n.split(",");if(!r.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[a,i]=r.replace(/^data:/,"").split(";");if("base64"!==i)throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:s,mimeType:a}}}if("media"===e.type)return function(e){if("mimeType"in e&&"data"in e)return{inlineData:{mimeType:e.mimeType,data:e.data}};throw new Error("Invalid media content")}(e);if("tool_use"===e.type)return{functionCall:{name:e.name,args:e.input}};throw new Error(`Unknown content type ${e.type}`)}))),[...s,...n,...r]}function Qw(e,t){return e.reduce(((e,n,r)=>{if(!pc(n))throw new Error("Unsupported message input");const s=function(e){const t=e._getType();return wc.isInstance(e)?e.role:"tool"===t?t:e.name??t}(n);if("system"===s&&0!==r)throw new Error("System message should be the first one");const a=function(e){switch(e){case"ai":case"model":return"model";case"system":case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${e}`)}}(s),i=e.content[e.content.length];if(!e.mergeWithPreviousContent&&i&&i.role===a)throw new Error("Google Generative AI requires alternate messages between authors");const o=Yw(n,t);if(e.mergeWithPreviousContent){const t=e.content[e.content.length-1];if(!t)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return t.parts.push(...o),{mergeWithPreviousContent:!1,content:e.content}}let l=a;"function"===l&&(l="user");const c={role:l,parts:o};return{mergeWithPreviousContent:"system"===s,content:[...e.content,c]}}),{content:[],mergeWithPreviousContent:!1}).content}function eb(e,t){if(!e.candidates||0===e.candidates.length)return null;const n=e.functionCalls(),[r]=e.candidates,{content:s,...a}=r,i=s?.parts[0]?.text??"",o=[];return n&&o.push(...n.map((e=>({...e,args:JSON.stringify(e.args),index:t.index})))),new Jp({text:i,message:new yc({content:i,name:s?s.role:void 0,tool_call_chunks:o,additional_kwargs:{},usage_metadata:t.usageMetadata}),generationInfo:a})}function tb(e){return e.every((e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations)))?e:[{functionDeclarations:e.map((e=>{if(tg(e)){const t=Jw(e.schema);return{name:e.name,description:e.description,parameters:t}}return Vm(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:Xw(e.function.parameters)}:e}))}]}class nb extends rg{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new ag(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap((e=>{const{message:t}=e;return"tool_calls"in t&&Array.isArray(t.tool_calls)?t.tool_calls:[]}));if(void 0===t[0])throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}class rb extends Ym{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=e?.model?.replace(/^models\//,"")??e?.modelName?.replace(/^models\//,"")??this.model,this.model=this.modelName,this.maxOutputTokens=e?.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e?.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=e?.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e?.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e?.stopSequences??this.stopSequences,this.apiKey=e?.apiKey??Cp("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e?.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0){const e=new Set(this.safetySettings.map((e=>e.category)));if(e.size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique")}this.streaming=e?.streaming??this.streaming,this.client=new Gw(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK}},{apiVersion:e?.apiVersion,baseUrl:e?.baseUrl}),this.streamUsage=e?.streamUsage??this.streamUsage}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){return this.bind({tools:tb(e),...t})}invocationParams(e){const t=e?.tools;return Array.isArray(t)&&!t.some((e=>!("lc_namespace"in e)))?{tools:tb(e?.tools)}:{tools:e?.tools}}async _generate(e,t,n){const r=Qw(e,this._isMultimodalModel),s=this.invocationParams(t);if(this.streaming){const r={},s=this._streamResponseChunks(e,t,n),a={};for await(const e of s){const t=e.generationInfo?.completion??0;void 0===a[t]?a[t]=e:a[t]=a[t].concat(e)}const i=Object.entries(a).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t));return{generations:i,llmOutput:{estimatedTokenUsage:r}}}const a=await this.completionWithRetry({...s,contents:r});let i;if("usageMetadata"in a.response){const e=a.response.usageMetadata;i={input_tokens:e.promptTokenCount??0,output_tokens:e.candidatesTokenCount??0,total_tokens:e.totalTokenCount??0}}const o=function(e,t){if(!e.candidates||0===e.candidates.length||!e.candidates[0])return{generations:[],llmOutput:{filters:e.promptFeedback}};const n=e.functionCalls(),[r]=e.candidates,{content:s,...a}=r,i=s?.parts[0]?.text??"";return{generations:[{text:i,message:new mc({content:i,tool_calls:n,additional_kwargs:{...a},usage_metadata:t?.usageMetadata}),generationInfo:a}]}}(a.response,{usageMetadata:i});return await(n?.handleLLMNewToken(o.generations[0].text??"")),o}async*_streamResponseChunks(e,t,n){const r=Qw(e,this._isMultimodalModel),s={...this.invocationParams(t),contents:r},a=await this.caller.callWithOptions({signal:t?.signal},(async()=>{const{stream:e}=await this.client.generateContentStream(s);return e}));let i,o=0;for await(const e of a){if("usageMetadata"in e&&!1!==this.streamUsage&&!1!==t.streamUsage){const t=e.usageMetadata;if(i){const e=t.candidatesTokenCount-i.output_tokens;i={input_tokens:0,output_tokens:e,total_tokens:e}}else i={input_tokens:t.promptTokenCount,output_tokens:t.candidatesTokenCount,total_tokens:t.totalTokenCount}}const r=eb(e,{usageMetadata:i,index:o});o+=1,r&&(yield r,await(n?.handleLLMNewToken(r.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t?.signal},(async()=>{try{return this.client.generateContent(e)}catch(e){throw e.message?.includes("400 Bad Request")&&(e.status=400),e}}))}withStructuredOutput(e,t){const n=e,r=t?.name,s=t?.method,a=t?.includeRaw;if("jsonMode"===s)throw new Error('ChatGoogleGenerativeAI only supports "functionCalling" as a method.');let i,o,l=r??"extract";if(Xm(n)){const e=Jw(n);o=[{functionDeclarations:[{name:l,description:e.description??"A function available to call.",parameters:e}]}],i=new nb({returnSingle:!0,keyName:l,zodSchema:n})}else{let e;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(e=n,l=n.name):e={name:l,description:n.description??"",parameters:n},o=[{functionDeclarations:[e]}],i=new nb({returnSingle:!0,keyName:l})}const c=this.bind({tools:o});if(!a)return c.pipe(i).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const u=Jm.assign({parsed:(e,t)=>i.invoke(e.raw,t)}),d=Jm.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[d]});return lm.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}}function sb(e){const t=e=>{switch(e){case"human":return"user";case"ai":case"function":return"assistant";case"system":return"system";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}};return e.map((e=>{const n=(e=>{if(gc(e)&&e.tool_calls?.length)return e.tool_calls.map((e=>({...e,id:e.id}))).map(pg);if(!e.additional_kwargs.tool_calls?.length)return;const t=e.additional_kwargs.tool_calls;return t?.map((e=>({id:e.id,type:"function",function:e.function})))})(e),r=void 0===n?(e=>{if("string"==typeof e)return e;throw new Error(`ChatMistralAI does not support non text message content. Received: ${JSON.stringify(e,null,2)}`)})(e.content):"";return{role:t(e._getType()),content:r,tool_calls:n}}))}function ab(e,n){const{message:r}=e;let s=[];if("tool_calls"in r&&Array.isArray(r.tool_calls)&&(s=r.tool_calls),"assistant"===r.role){const e=[],a=[];for(const n of s)try{const r=hg(n,{returnId:!0});e.push({...r,id:r.id??t().replace(/-/g,"")})}catch(e){a.push(fg(n,e.message))}return new mc({content:r.content??"",tool_calls:e,invalid_tool_calls:a,additional_kwargs:{tool_calls:s.length?s.map((e=>({...e,type:"function"}))):void 0},usage_metadata:n?{input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens}:void 0})}return new _c(r.content??"")}function ib(e,n){if(!e.content&&!e.tool_calls)return n?new yc({content:"",usage_metadata:n?{input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens}:void 0}):null;const r=e.tool_calls?.length?e.tool_calls?.map(((e,n)=>({...e,index:n,id:e.id??t().replace(/-/g,""),type:"function"}))):void 0;let s="assistant";e.role&&(s=e.role);const a=e.content??"";let i;const o=[];if(void 0!==r){i={tool_calls:r};for(const e of r)o.push({name:e.function?.name,args:e.function?.arguments,id:e.id,index:e.index})}else i={};return"user"===s?new kc({content:a}):"assistant"===s?new yc({content:a,tool_call_chunks:o,additional_kwargs:i,usage_metadata:n?{input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens}:void 0}):"tool"===s?new fc({content:a,additional_kwargs:i,tool_call_id:r?.[0].id??""}):"function"===s?new vc({content:a,additional_kwargs:i}):new bc({content:a,role:s})}function ob(e){return e.map((e=>{const t=e.description??`Tool: ${e.name}`;return{type:"function",function:{name:e.name,description:t,parameters:Os(e.schema)}}}))}class lb extends Ym{static lc_name(){return"ChatMistralAI"}constructor(e){super(e??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"mistral-small-latest"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"mistral-small-latest"}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"safeMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"safePrompt",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"randomSeed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=e?.apiKey??Cp("MISTRAL_API_KEY");if(!t)throw new Error("API key MISTRAL_API_KEY is missing for MistralAI, but it is required.");this.apiKey=t,this.streaming=e?.streaming??this.streaming,this.endpoint=e?.endpoint,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.maxTokens=e?.maxTokens??this.maxTokens,this.safeMode=e?.safeMode??this.safeMode,this.safePrompt=e?.safePrompt??this.safePrompt,this.randomSeed=e?.seed??e?.randomSeed??this.seed,this.seed=this.randomSeed,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.streamUsage=e?.streamUsage??this.streamUsage}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"mistral",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.maxTokens??void 0}}_llmType(){return"mistral_ai"}invocationParams(e){const{response_format:t,tools:n,tool_choice:r}=e??{},s=n?.map((e=>"lc_namespace"in e?ob([e]):e.function.description?e:{type:"function",function:{name:e.function.name,description:`Tool: ${e.function.name}`,parameters:e.function.parameters}})).flat();return{model:this.model,tools:s,temperature:this.temperature,maxTokens:this.maxTokens,topP:this.topP,randomSeed:this.seed,safeMode:this.safeMode,safePrompt:this.safePrompt,toolChoice:r,responseFormat:t}}bindTools(e,t){const n=e?.map((e=>"lc_namespace"in e?ob([e]):e)).flat();return this.bind({tools:n,...t})}async completionWithRetry(e,t){const{MistralClient:n}=await this.imports(),r=new n(this.apiKey,this.endpoint);return this.caller.call((async()=>{try{let n;return n=t?r.chatStream(e):await r.chat(e),n}catch(e){throw e.message?.includes("status: 400")&&(e.status=400),e}}))}async _generate(e,t,n){const r={},s={...this.invocationParams(t),messages:sb(e)},a=!!t.signal??!!t.timeout;if(this.streaming||a){const s=this._streamResponseChunks(e,t,n),a={};for await(const e of s){const t=e.generationInfo?.completion??0;void 0===a[t]?a[t]=e:a[t]=a[t].concat(e)}const i=Object.entries(a).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t));return{generations:i,llmOutput:{estimatedTokenUsage:r}}}const i=await this.completionWithRetry(s,!1),{completion_tokens:o,prompt_tokens:l,total_tokens:c}=i?.usage??{};o&&(r.completionTokens=(r.completionTokens??0)+o),l&&(r.promptTokens=(r.promptTokens??0)+l),c&&(r.totalTokens=(r.totalTokens??0)+c);const u=[];for(const e of i?.choices??[]){if("delta"in e)throw new Error("Delta not supported in non-streaming mode.");if(!("message"in e))throw new Error("No message found in the choice.");const t={text:e.message?.content??"",message:ab(e,i?.usage)};e.finish_reason&&(t.generationInfo={finish_reason:e.finish_reason}),u.push(t)}return{generations:u,llmOutput:{tokenUsage:r}}}async*_streamResponseChunks(e,t,n){const r=sb(e),s={...this.invocationParams(t),messages:r},a=await this.completionWithRetry(s,!0);for await(const e of a){if(t.signal?.aborted)throw new Error("AbortError");const r=e?.choices[0];if(!r||!("delta"in r))continue;const{delta:s}=r;if(!s)continue;const a={prompt:0,completion:r.index??0},i=ib(s,this.streamUsage||t.streamUsage?e.usage:null);if(null===i)continue;const o=new Jp({message:i,text:s.content??"",generationInfo:a});yield o,n?.handleLLMNewToken(o.text??"",a,void 0,void 0,void 0,{chunk:o})}}_combineLLMOutput(){return[]}withStructuredOutput(e,t){let n,r,s,a,i,o;if(!function(e){return void 0!==e&&"object"==typeof e.schema}(e)?(n=e,r=t?.name,s=t?.method,a=t?.includeRaw):(n=e.schema,r=e.name,s=e.method,a=e.includeRaw),"jsonMode"===s)i=this.bind({response_format:{type:"json_object"}}),o=cb(n)?ug.fromZodSchema(n):new dg;else{let e=r??"extract";if(cb(n)){const t=Os(n);i=this.bind({tools:[{type:"function",function:{name:e,description:t.description,parameters:t}}],tool_choice:"any"}),o=new gg({returnSingle:!0,keyName:e,zodSchema:n})}else{let t;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(t=n,e=n.name):t={name:e,description:n.description??"",parameters:n},i=this.bind({tools:[{type:"function",function:t}],tool_choice:"any"}),o=new gg({returnSingle:!0,keyName:e})}}if(!a)return i.pipe(o);const l=Jm.assign({parsed:(e,t)=>o.invoke(e.raw,t)}),c=Jm.assign({parsed:()=>null}),u=l.withFallbacks({fallbacks:[c]});return lm.from([{raw:i},u])}async imports(){const{default:e}=await Promise.resolve().then((function(){return dv}));return{MistralClient:e}}}function cb(e){return"function"==typeof e?.parse}class ub extends ic{addUserMessage(e){return this.addMessage(new _c(e))}addAIChatMessage(e){return this.addMessage(new mc(e))}addAIMessage(e){return this.addMessage(new mc(e))}async addMessages(e){for(const t of e)await this.addMessage(t)}clear(){throw new Error("Not implemented.")}}class db extends ub{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}}class hb extends sm{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},n={};for(const[e,r]of Object.entries(t))n[e]="string"==typeof r?r:await r();return{...n,...e}}async invoke(e,t){return this._callWithConfig((e=>this.formatPromptValue(e)),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Promise.resolve().then((function(){return Bb}));return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Promise.resolve().then((function(){return Bb}));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Promise.resolve().then((function(){return nv}));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}class pb extends hb{async formatPromptValue(e){const t=await this.format(e);return new Im(t)}}
/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var fb=Object.prototype.toString,mb=Array.isArray||function(e){return"[object Array]"===fb.call(e)};function gb(e){return"function"==typeof e}function yb(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function wb(e,t){return null!=e&&"object"==typeof e&&t in e}var bb=RegExp.prototype.test;var vb=/\S/;function _b(e){return!function(e,t){return bb.call(e,t)}(vb,e)}var kb={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};var Eb=/\s*/,Ob=/\s+/,Tb=/\s*=/,Sb=/\s*\}/,Ab=/#|\^|\/|>|\{|&|=|!/;function Ib(e){this.string=e,this.tail=e,this.pos=0}function xb(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function Pb(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}Ib.prototype.eos=function(){return""===this.tail},Ib.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},Ib.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=t.length,t},xb.prototype.push=function(e){return new xb(e,this)},xb.prototype.lookup=function(e){var t,n,r,s=this.cache;if(s.hasOwnProperty(e))t=s[e];else{for(var a,i,o,l=this,c=!1;l;){if(e.indexOf(".")>0)for(a=l.view,i=e.split("."),o=0;null!=a&&o<i.length;)o===i.length-1&&(c=wb(a,i[o])||(n=a,r=i[o],null!=n&&"object"!=typeof n&&n.hasOwnProperty&&n.hasOwnProperty(r))),a=a[i[o++]];else a=l.view[e],c=wb(l.view,e);if(c){t=a;break}l=l.parent}s[e]=t}return gb(t)&&(t=t.call(this.view)),t},Pb.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},Pb.prototype.parse=function(e,t){var n=this.templateCache,r=e+":"+(t||Cb.tags).join(":"),s=void 0!==n,a=s?n.get(r):void 0;return null==a&&(a=function(e,t){if(!e)return[];var n,r,s,a=!1,i=[],o=[],l=[],c=!1,u=!1,d="",h=0;function p(){if(c&&!u)for(;l.length;)delete o[l.pop()];else l=[];c=!1,u=!1}function f(e){if("string"==typeof e&&(e=e.split(Ob,2)),!mb(e)||2!==e.length)throw new Error("Invalid tags: "+e);n=new RegExp(yb(e[0])+"\\s*"),r=new RegExp("\\s*"+yb(e[1])),s=new RegExp("\\s*"+yb("}"+e[1]))}f(t||Cb.tags);for(var m,g,y,w,b,v,_=new Ib(e);!_.eos();){if(m=_.pos,y=_.scanUntil(n))for(var k=0,E=y.length;k<E;++k)_b(w=y.charAt(k))?(l.push(o.length),d+=w):(u=!0,a=!0,d+=" "),o.push(["text",w,m,m+1]),m+=1,"\n"===w&&(p(),d="",h=0,a=!1);if(!_.scan(n))break;if(c=!0,g=_.scan(Ab)||"name",_.scan(Eb),"="===g?(y=_.scanUntil(Tb),_.scan(Tb),_.scanUntil(r)):"{"===g?(y=_.scanUntil(s),_.scan(Sb),_.scanUntil(r),g="&"):y=_.scanUntil(r),!_.scan(r))throw new Error("Unclosed tag at "+_.pos);if(b=">"==g?[g,y,m,_.pos,d,h,a]:[g,y,m,_.pos],h++,o.push(b),"#"===g||"^"===g)i.push(b);else if("/"===g){if(!(v=i.pop()))throw new Error('Unopened section "'+y+'" at '+m);if(v[1]!==y)throw new Error('Unclosed section "'+v[1]+'" at '+m)}else"name"===g||"{"===g||"&"===g?u=!0:"="===g&&f(y)}if(p(),v=i.pop())throw new Error('Unclosed section "'+v[1]+'" at '+_.pos);return function(e){for(var t,n=[],r=n,s=[],a=0,i=e.length;a<i;++a)switch((t=e[a])[0]){case"#":case"^":r.push(t),s.push(t),r=t[4]=[];break;case"/":s.pop()[5]=t[2],r=s.length>0?s[s.length-1][4]:n;break;default:r.push(t)}return n}(function(e){for(var t,n,r=[],s=0,a=e.length;s<a;++s)(t=e[s])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):(r.push(t),n=t));return r}(o))}(e,t),s&&n.set(r,a)),a},Pb.prototype.render=function(e,t,n,r){var s=this.getConfigTags(r),a=this.parse(e,s),i=t instanceof xb?t:new xb(t,void 0);return this.renderTokens(a,i,n,e,r)},Pb.prototype.renderTokens=function(e,t,n,r,s){for(var a,i,o,l="",c=0,u=e.length;c<u;++c)o=void 0,"#"===(i=(a=e[c])[0])?o=this.renderSection(a,t,n,r,s):"^"===i?o=this.renderInverted(a,t,n,r,s):">"===i?o=this.renderPartial(a,t,n,s):"&"===i?o=this.unescapedValue(a,t):"name"===i?o=this.escapedValue(a,t,s):"text"===i&&(o=this.rawValue(a)),void 0!==o&&(l+=o);return l},Pb.prototype.renderSection=function(e,t,n,r,s){var a=this,i="",o=t.lookup(e[1]);if(o){if(mb(o))for(var l=0,c=o.length;l<c;++l)i+=this.renderTokens(e[4],t.push(o[l]),n,r,s);else if("object"==typeof o||"string"==typeof o||"number"==typeof o)i+=this.renderTokens(e[4],t.push(o),n,r,s);else if(gb(o)){if("string"!=typeof r)throw new Error("Cannot use higher-order sections without the original template");null!=(o=o.call(t.view,r.slice(e[3],e[5]),(function(e){return a.render(e,t,n,s)})))&&(i+=o)}else i+=this.renderTokens(e[4],t,n,r,s);return i}},Pb.prototype.renderInverted=function(e,t,n,r,s){var a=t.lookup(e[1]);if(!a||mb(a)&&0===a.length)return this.renderTokens(e[4],t,n,r,s)},Pb.prototype.indentPartial=function(e,t,n){for(var r=t.replace(/[^ \t]/g,""),s=e.split("\n"),a=0;a<s.length;a++)s[a].length&&(a>0||!n)&&(s[a]=r+s[a]);return s.join("\n")},Pb.prototype.renderPartial=function(e,t,n,r){if(n){var s=this.getConfigTags(r),a=gb(n)?n(e[1]):n[e[1]];if(null!=a){var i=e[6],o=e[5],l=e[4],c=a;0==o&&l&&(c=this.indentPartial(a,l,i));var u=this.parse(c,s);return this.renderTokens(u,t,n,c,r)}}},Pb.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(null!=n)return n},Pb.prototype.escapedValue=function(e,t,n){var r=this.getConfigEscape(n)||Cb.escape,s=t.lookup(e[1]);if(null!=s)return"number"==typeof s&&r===Cb.escape?String(s):r(s)},Pb.prototype.rawValue=function(e){return e[1]},Pb.prototype.getConfigTags=function(e){return mb(e)?e:e&&"object"==typeof e?e.tags:void 0},Pb.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!mb(e)?e.escape:void 0};var Cb={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){Nb.templateCache=e},get templateCache(){return Nb.templateCache}},Nb=new Pb;function Rb(){Cb.escape=e=>e}Cb.clearCache=function(){return Nb.clearCache()},Cb.parse=function(e,t){return Nb.parse(e,t)},Cb.render=function(e,t,n,r){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+function(e){return mb(e)?"array":typeof e}(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Nb.render(e,t,n,r)},Cb.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,(function(e){return kb[e]}))},Cb.Scanner=Ib,Cb.Context=xb,Cb.Writer=Pb;const $b=e=>{const t=e.split(""),n=[],r=(e,n)=>{for(let r=n;r<t.length;r+=1)if(e.includes(t[r]))return r;return-1};let s=0;for(;s<t.length;)if("{"===t[s]&&s+1<t.length&&"{"===t[s+1])n.push({type:"literal",text:"{"}),s+=2;else if("}"===t[s]&&s+1<t.length&&"}"===t[s+1])n.push({type:"literal",text:"}"}),s+=2;else if("{"===t[s]){const e=r("}",s);if(e<0)throw new Error("Unclosed '{' in template.");n.push({type:"variable",name:t.slice(s+1,e).join("")}),s=e+1}else{if("}"===t[s])throw new Error("Single '}' in template.");{const e=r("{}",s),a=(e<0?t.slice(s):t.slice(s,e)).join("");n.push({type:"literal",text:a}),s=e<0?t.length:e}}return n},jb=e=>{Rb();return(e=>e.map((e=>"name"===e[0]?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]})))(Cb.parse(e))},Lb={"f-string":(e,t)=>$b(e).reduce(((e,n)=>{if("variable"===n.type){if(n.name in t)return e+t[n.name];throw new Error(`(f-string) Missing value for input ${n.name}`)}return e+n.text}),""),mustache:(e,t)=>(Rb(),Cb.render(e,t))},Mb={"f-string":$b,mustache:jb},Db=(e,t,n)=>Lb[t](e,n),Ub=(e,t,n)=>{if(!(t in Lb)){const e=Object.keys(Lb);throw new Error(`Invalid template format. Got \`${t}\`;\n                         should be one of ${e}`)}try{const r=n.reduce(((e,t)=>(e[t]="foo",e)),{});Array.isArray(e)?e.forEach((e=>{if("text"===e.type)Db(e.text,t,r);else{if("image_url"!==e.type)throw new Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`);if("string"==typeof e.image_url)Db(e.image_url,t,r);else{const n=e.image_url.url;Db(n,t,r)}}})):Db(e,t,r)}catch(e){throw new Error(`Invalid prompt schema: ${e.message}`)}};class Fb extends pb{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if("mustache"===this.templateFormat)throw new Error("Mustache templates cannot be validated.");let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Ub(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return Db(this.template,this.templateFormat,t)}static fromExamples(e,t,n,r="\n\n",s=""){const a=[s,...e,t].join(r);return new Fb({inputVariables:n,template:a})}static fromTemplate(e,t){const{templateFormat:n="f-string",...r}=t??{},s=new Set;return((e,t)=>Mb[t](e))(e,n).forEach((e=>{"variable"===e.type&&s.add(e.name)})),new Fb({inputVariables:[...s],templateFormat:n,template:e,...r})}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new Fb(r)}serialize(){if(void 0!==this.outputParser)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new Fb({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}var Bb=Object.freeze({__proto__:null,PromptTemplate:Fb});class qb extends hb{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Ub([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new qb(r)}async format(e){const t={};for(const[n,r]of Object.entries(this.template))t[n]="string"==typeof r?Db(r,this.templateFormat,e):r;const n=e.url||t.url,r=e.detail||t.detail;if(!n)throw new Error("Must provide either an image URL.");if("string"!=typeof n)throw new Error("url must be a string.");const s={url:n};return r&&(s.detail=r),s}async formatPromptValue(e){const t=await this.format(e);return new Pm(t)}}class Hb extends sm{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig((e=>this.formatMessages(e)),e,{...t,runType:"prompt"})}}class zb extends Hb{static lc_name(){return"MessagesPlaceholder"}constructor(e){"string"==typeof e&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){const t=e[this.variableName];if(this.optional&&!t)return[];if(!t){const e=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw e.name="InputFormatError",e}let n;try{n=Array.isArray(t)?t.map(Sc):[Sc(t)]}catch(e){const n="string"==typeof t?t:JSON.stringify(t,null,2),r=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${n}`,`Additional message: ${e.message}`].join("\n\n"));throw r.name="InputFormatError",r}return n}}class Wb extends Hb{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class Kb extends hb{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new xm(t)}}class Vb extends Wb{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new wc(await this.prompt.format(e),this.role)}static fromTemplate(e,t,n){return new this(Fb.fromTemplate(e,{templateFormat:n?.templateFormat}),t)}}class Gb extends Hb{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach((t=>{"inputVariables"in t&&(e=e.concat(t.inputVariables))})),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass()){return new(t._messageClass())({content:e})}if(t.chatMessageClass){const n=t.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if("string"==typeof e)return new this(Fb.fromTemplate(e,t));const n=[];for(const r of e)if("string"==typeof r||"object"==typeof r&&"text"in r){let e="";"string"==typeof r?e=r:"string"==typeof r.text&&(e=r.text??""),n.push(Fb.fromTemplate(e,t))}else if("object"==typeof r&&"image_url"in r){let e,s=r.image_url??"",a=[];if("string"==typeof s){let n;n="mustache"===t?.templateFormat?jb(s):$b(s);const r=n.flatMap((e=>"variable"===e.type?[e.name]:[]));if((r?.length??0)>0){if(r.length>1)throw new Error(`Only one format variable allowed per image template.\nGot: ${r}\nFrom: ${s}`);a=[r[0]]}else a=[];s={url:s},e=new qb({template:s,inputVariables:a,templateFormat:t?.templateFormat})}else{if("object"!=typeof s)throw new Error("Invalid image template");if("url"in s){let e;e="mustache"===t?.templateFormat?jb(s.url):$b(s.url),a=e.flatMap((e=>"variable"===e.type?[e.name]:[]))}else a=[];e=new qb({template:s,inputVariables:a,templateFormat:t?.templateFormat})}n.push(e)}return new this({prompt:n,additionalOptions:t})}async format(e){if(this.prompt instanceof pb){const t=await this.prompt.format(e);return this.createMessage(t)}{const t=[];for(const n of this.prompt){let r={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(const t of n.inputVariables)r||(r={[t]:e[t]}),r={...r,[t]:e[t]};if(n instanceof pb){const e=await n.format(r);t.push({type:"text",text:e})}else if(n instanceof qb){const e=await n.format(r);t.push({type:"image_url",image_url:e})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}}class Zb extends Gb{static _messageClass(){return _c}static lc_name(){return"HumanMessagePromptTemplate"}}class Jb extends Gb{static _messageClass(){return mc}static lc_name(){return"AIMessagePromptTemplate"}}class Xb extends Gb{static _messageClass(){return Ec}static lc_name(){return"SystemMessagePromptTemplate"}}function Yb(e,t){if("function"==typeof e.formatMessages||pc(e))return e;if(Array.isArray(e)&&"placeholder"===e[0]){const t=e[1];if("string"!=typeof t||"{"!==t[0]||"}"!==t[t.length-1])throw new Error(`Invalid placeholder template: "${e[1]}". Expected a variable name surrounded by curly braces.`);const n=t.slice(1,-1);return new zb({variableName:n,optional:!0})}const n=Sc(e);let r;if(r="string"==typeof n.content?n.content:n.content.map((e=>"text"in e?{text:e.text}:"image_url"in e?{image_url:e.image_url}:e)),"human"===n._getType())return Zb.fromTemplate(r,t);if("ai"===n._getType())return Jb.fromTemplate(r,t);if("system"===n._getType())return Xb.fromTemplate(r,t);if(wc.isInstance(n))return Vb.fromTemplate(n.content,n.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${n._getType()}".`)}function Qb(e){return"MessagesPlaceholder"===e.constructor.lc_name()}class ev extends Kb{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const e=new Set;for(const t of this.promptMessages)if(!(t instanceof lc))for(const n of t.inputVariables)e.add(n);const t=this.inputVariables,n=new Set(this.partialVariables?t.concat(Object.keys(this.partialVariables)):t),r=new Set([...n].filter((t=>!e.has(t))));if(r.size>0)throw new Error(`Input variables \`${[...r]}\` are not used in any of the prompt messages.`);const s=new Set([...e].filter((e=>!n.has(e))));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if("string"==typeof e.content)return e;const n=await Promise.all(e.content.map((async e=>{if("image_url"!==e.type)return e;let n="";n="string"==typeof e.image_url?e.image_url:e.image_url.url;const r=Fb.fromTemplate(n,{templateFormat:this.templateFormat}),s=await r.format(t);return"string"!=typeof e.image_url&&"url"in e.image_url?e.image_url.url=s:e.image_url=s,e})));return e.content=n,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let n=[];for(const e of this.promptMessages)if(e instanceof lc)n.push(await this._parseImagePrompts(e,t));else{const r=e.inputVariables.reduce(((n,r)=>{if(!(r in t||Qb(e)&&e.optional))throw new Error(`Missing value for input variable \`${r.toString()}\``);return n[r]=t[r],n}),{}),s=await e.formatMessages(r);n=n.concat(s)}return n}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new ev(r)}static fromTemplate(e,t){const n=Fb.fromTemplate(e,t),r=new Zb({prompt:n});return this.fromMessages([r])}static fromMessages(e,t){const n=e.reduce(((e,n)=>e.concat(n instanceof ev?n.promptMessages:[Yb(n,t)])),[]),r=e.reduce(((e,t)=>t instanceof ev?Object.assign(e,t.partialVariables):e),Object.create(null)),s=new Set;for(const e of n)if(!(e instanceof lc))for(const t of e.inputVariables)t in r||s.add(t);return new this({...t,inputVariables:[...s],promptMessages:n,partialVariables:r,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}class tv extends pb{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Ub(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new tv(r)}async format(e){const t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),r=await Promise.all(n.map((e=>this.examplePrompt.format(e)))),s=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return Db(s,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");const n=await Fb.deserialize(t);let r;if(!Array.isArray(e.examples))throw new Error("Invalid examples format. Only list or string are supported.");return r=e.examples,new tv({inputVariables:e.input_variables,examplePrompt:n,examples:r,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}var nv=Object.freeze({__proto__:null,FewShotPromptTemplate:tv});class rv extends Ss{#S;constructor(e){super(e)}get executableAgent(){return{}}initialize(e,t){if(this.store=e,this.env=t,this.llmInstance){const e={...this.llmInstance.lc_kwargs,provider:this.llmInstance.lc_namespace[this.llmInstance.lc_namespace.length-1]};this.llmConfig=e}else{const e=function(e,t){return e?.apiKey?e.apiKey:{anthropic:t.ANTHROPIC_API_KEY,google:t.GOOGLE_API_KEY,mistral:t.MISTRAL_API_KEY,openai:t.OPENAI_API_KEY}[e?.provider]}(this.llmConfig,this.env);if(!e&&!this.llmConfig.apiBaseUrl)throw new Error("API key is missing. Please provide it through the Agent llmConfig or through the team env variable.");this.llmConfig.apiKey=e;const t={anthropic:cw,google:rb,mistral:lb,openai:Eg}[this.llmConfig.provider]||Eg;this.llmInstance=new t(this.llmConfig)}this.interactionsHistory=new db}async workOnTask(e,t,n){const r=this.prepareAgentForTask(e,t,n);return this.#S=r.executableAgent,await this.agenticLoop(this,e,this.#S,r.initialFeedbackMessage)}async workOnFeedback(e,t){const n=t.map((e=>e.content)).join(", "),r=this.promptTemplates.WORK_ON_FEEDBACK_FEEDBACK({agent:this,task:e,feedback:n});return await this.agenticLoop(this,e,this.#S,r)}prepareAgentForTask(e,t,n){const r=be(e.description,t),s=this.buildSystemMessage(this,e,r),a=this.buildInitialMessage(this,e,r,n);this.llmSystemMessage=s;const i=ev.fromMessages([new Ec(s),["placeholder","{chat_history}"],["human","{feedbackMessage}"]]).pipe(this.llmInstance);return{executableAgent:new ng({runnable:i,getMessageHistory:()=>this.interactionsHistory,inputMessagesKey:"feedbackMessage",historyMessagesKey:"chat_history"}),initialFeedbackMessage:a}}async agenticLoop(e,t,n,r){let s=r,a=null,i=0;const o=e.maxIterations;let l=null;for(;!a&&i<o&&!l;){try{e.handleIterationStart({agent:e,task:t,iterations:i,maxAgentIterations:o}),e.forceFinalAnswer&&i===o-2&&(s=this.promptTemplates.FORCE_FINAL_ANSWER_FEEDBACK({agent:e,task:t,iterations:i,maxAgentIterations:o}));const r=await this.executeThinking(e,t,n,s),l=r.parsedLLMOutput,c=this.determineActionType(l);switch(c){case K:s=this.handleIssuesParsingLLMOutput({agent:e,task:t,output:r});break;case H:a=this.handleFinalAnswer({agent:e,task:t,parsedLLMOutput:l});break;case L:s=this.handleThought({agent:e,task:t,parsedLLMOutput:l});break;case V:s=this.handleSelfQuestion({agent:e,task:t,parsedLLMOutput:l});break;case M:ge.debug(`â© Agent ${e.name} will be ${M}...`);{const n=l.action,r=this.tools.find((e=>e.name===n));if(r)try{s=await this.executeUsingTool({agent:e,task:t,parsedLLMOutput:l,tool:r})}catch(n){s=this.handleUsingToolError({agent:e,task:t,parsedLLMOutput:l,tool:r,error:n})}else s=this.handleToolDoesNotExist({agent:e,task:t,parsedLLMOutput:l,toolName:n})}break;case q:s=this.handleObservation({agent:e,task:t,parsedLLMOutput:l});break;case X:s=this.handleWeirdOutput({agent:e,task:t,parsedLLMOutput:l});break;default:ge.warn(`Unhandled agent status: ${c}`)}}catch(n){"LLMInvocationError"===n.name?e.handleThinkingError({agent:e,task:t,error:n}):this.handleAgenticLoopError({agent:e,task:t,error:n,iterations:i,maxAgentIterations:o}),l=n;break}e.handleIterationEnd({agent:e,task:t,iterations:i,maxAgentIterations:o}),i++}return l?{error:"Execution stopped due to a critical error: "+l.message,metadata:{iterations:i,maxAgentIterations:o}}:a?(this.handleTaskCompleted({agent:e,task:t,parsedResultWithFinalAnswer:a,iterations:i,maxAgentIterations:o}),{result:a,metadata:{iterations:i,maxAgentIterations:o}}):i>=o?(this.handleMaxIterationsError({agent:e,task:t,iterations:i,maxAgentIterations:o}),{error:"Task incomplete: reached maximum iterations without final answer.",metadata:{iterations:i,maxAgentIterations:o}}):{error:"Execution terminated unexpectedly without results.",metadata:{iterations:i,maxAgentIterations:o}}}buildSystemMessage(e,t,n){return this.promptTemplates.SYSTEM_MESSAGE({agent:e,task:{...t,description:n}})}buildInitialMessage(e,t,n,r){return this.promptTemplates.INITIAL_MESSAGE({agent:e,task:{...t,description:n},context:r})}determineActionType(e){return null===e?K:e.finalAnswer?H:"self_question"===e.action?e.thought?L:V:e.action?M:e.observation?q:X}handleIterationStart({agent:e,task:t,iterations:n,maxAgentIterations:r}){e.store.getState().handleAgentIterationStart({agent:e,task:t,iterations:n,maxAgentIterations:r})}handleIterationEnd({agent:e,task:t,iterations:n,maxAgentIterations:r}){e.store.getState().handleAgentIterationEnd({agent:e,task:t,iterations:n,maxAgentIterations:r})}async handleThinkingStart({agent:e,task:t,messages:n}){try{const r=n.flatMap((e=>e.map((e=>({type:e.constructor.name,content:e.content})))));return e.store.getState().handleAgentThinkingStart({agent:e,task:t,messages:r}),r}catch(e){throw ge.debug(`AGENT/handleThinkingStart: Error processing thinking messages: ${e.message}`),e}}async handleThinkingEnd({agent:e,task:t,output:n}){try{const r=new cg;if(!n.generations||!n.generations[0]||!n.generations[0][0].message)throw new Error("Invalid output structure");const{message:s}=n.generations[0][0],a=await r.invoke(s),i=function(e){try{return JSON.parse(e)}catch{const t={thought:/"thought"\s*:\s*"([^"]*)"/,action:/"action"\s*:\s*"([^"]*)"/,actionInput:/"actionInput"\s*:\s*({[^}]*})/,observation:/"observation"\s*:\s*"([^"]*)"/,isFinalAnswerReady:/"isFinalAnswerReady"\s*:\s*(true|false)/,finalAnswer:/"finalAnswer"\s*:\s*"([^"]*)"/};let n={};for(let r in t){const s=t[r],a=e.match(s);if(a)if("actionInput"===r)try{n[r]=JSON.parse(a[1].replace(/'/g,'"'))}catch{n[r]=null}else n[r]="isFinalAnswerReady"===r?"true"===a[1]:a[1]}return n}}(a),o={parsedLLMOutput:i,llmOutput:a,llmUsageStats:{inputTokens:s.usage_metadata?.input_tokens??-1,outputTokens:s.usage_metadata?.output_tokens??-1}};return e.store.getState().handleAgentThinkingEnd({agent:e,task:t,output:o}),o}catch(e){throw ge.debug(`AGENT/handleThinkingEnd: Error processing thinking result: ${e}`),e}}handleThinkingError({agent:e,task:t,error:n}){e.store.getState().handleAgentThinkingError({agent:e,task:t,error:n})}async executeThinking(e,t,n,r){return new Promise(((s,a)=>{n.invoke({feedbackMessage:r},{configurable:{sessionId:"foo-bar-baz"},callbacks:[{handleChatModelStart:(n,r)=>{e.handleThinkingStart({agent:e,task:t,messages:r}).catch((e=>{a(e)}))},handleLLMEnd:async n=>{e.handleThinkingEnd({agent:e,task:t,output:n}).then((e=>s(e))).catch((e=>{a(e)}))}}]}).catch((n=>{ge.error(`LLM_INVOCATION_ERROR: Error during LLM API call for Agent: ${e.name}, Task: ${t.id}. Details:`,n),a(new ve(`LLM API Error during executeThinking for Agent: ${e.name}, Task: ${t.id}`,n))}))}))}handleIssuesParsingLLMOutput({agent:e,task:t,output:n}){const r=new Error("Received an invalid JSON object from the LLM. Requesting a correctly formatted JSON response.",n.llmOutput);e.store.getState().handleAgentIssuesParsingLLMOutput({agent:e,task:t,output:n,error:r});return this.promptTemplates.INVALID_JSON_FEEDBACK({agent:e,task:t,llmOutput:n.llmOutput})}handleFinalAnswer({agent:e,task:t,parsedLLMOutput:n}){return n.finalAnswer&&"object"==typeof n.finalAnswer&&null!==n.finalAnswer&&(n.finalAnswer=JSON.stringify(n.finalAnswer)),e.store.getState().handleAgentFinalAnswer({agent:e,task:t,output:n}),n}handleThought({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleAgentThought({agent:e,task:t,output:n});let r=this.promptTemplates.THOUGHT_FEEDBACK({agent:e,task:t,thought:n.thought,parsedLLMOutput:n});if("self_question"===n.action&&n.actionInput){const s="object"==typeof n.actionInput?JSON.stringify(n.actionInput):n.actionInput;r=this.promptTemplates.THOUGHT_WITH_SELF_QUESTION_FEEDBACK({agent:e,task:t,thought:n.thought,question:s,parsedLLMOutput:n})}return r}handleSelfQuestion({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleAgentSelfQuestion({agent:e,task:t,output:n});return this.promptTemplates.SELF_QUESTION_FEEDBACK({agent:e,task:t,question:n.thought,parsedLLMOutput:n})}async executeUsingTool({agent:e,task:t,parsedLLMOutput:n,tool:r}){const s=n.actionInput;e.handleUsingToolStart({agent:e,task:t,tool:r,input:s});const a=await r.call(s);e.handleUsingToolEnd({agent:e,task:t,tool:r,output:a});return this.promptTemplates.TOOL_RESULT_FEEDBACK({agent:e,task:t,toolResult:a,parsedLLMOutput:n})}handleUsingToolStart({agent:e,task:t,tool:n,input:r}){e.store.getState().handleAgentToolStart({agent:e,task:t,tool:n,input:r})}handleUsingToolEnd({agent:e,task:t,tool:n,output:r}){e.store.getState().handleAgentToolEnd({agent:e,task:t,tool:n,output:r})}handleUsingToolError({agent:e,task:t,parsedLLMOutput:n,tool:r,error:s}){e.store.getState().handleAgentToolError({agent:e,task:t,tool:r,error:s});return this.promptTemplates.TOOL_ERROR_FEEDBACK({agent:e,task:t,toolName:n.action,error:s,parsedLLMOutput:n})}handleToolDoesNotExist({agent:e,task:t,parsedLLMOutput:n,toolName:r}){e.store.getState().handleAgentToolDoesNotExist({agent:e,task:t,toolName:r});return this.promptTemplates.TOOL_NOT_EXIST_FEEDBACK({agent:e,task:t,toolName:n.action,parsedLLMOutput:n})}handleObservation({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleAgentObservation({agent:e,task:t,output:n});return this.promptTemplates.OBSERVATION_FEEDBACK({agent:e,task:t,parsedLLMOutput:n})}handleWeirdOutput({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleWeirdOutput({agent:e,task:t,output:n});return this.promptTemplates.WEIRD_OUTPUT_FEEDBACK({agent:e,task:t,parsedLLMOutput:n})}handleAgenticLoopError({agent:e,task:t,error:n,iterations:r,maxAgentIterations:s}){e.store.getState().handleAgentLoopError({agent:e,task:t,error:n,iterations:r,maxAgentIterations:s})}handleMaxIterationsError({agent:e,task:t,iterations:n,maxAgentIterations:r}){const s=new Error(`Agent ${e.name} reached the maximum number of iterations: [${r}] without finding a final answer.`);e.store.getState().handleAgentMaxIterationsError({agent:e,task:t,error:s,iterations:n,maxAgentIterations:r})}handleTaskCompleted({agent:e,task:t,parsedResultWithFinalAnswer:n,iterations:r,maxAgentIterations:s}){e.store.getState().handleAgentTaskCompleted({agent:e,task:t,result:n.finalAnswer,iterations:r,maxAgentIterations:s})}}class sv{constructor({type:e,...t}){this.agentInstance=this.createAgent(e,t),this.type=e||"ReactChampionAgent"}createAgent(e,t){return new rv(t)}workOnTask(e,t,n){return this.agentInstance.workOnTask(e,t,n)}workOnFeedback(e,t,n){return this.agentInstance.workOnFeedback(e,t,n)}setStatus(e){this.agentInstance.setStatus(e)}initialize(e,t){this.agentInstance.initialize(e,t)}get id(){return this.agentInstance.id}get name(){return this.agentInstance.name}get role(){return this.agentInstance.role}get goal(){return this.agentInstance.goal}get background(){return this.agentInstance.background}get tools(){return this.agentInstance.tools}get status(){return this.agentInstance.status}get llmConfig(){return this.agentInstance.llmConfig}get llmSystemMessage(){return this.agentInstance.llmSystemMessage}get forceFinalAnswer(){return this.agentInstance.forceFinalAnswer}get promptTemplates(){return this.agentInstance.promptTemplates}}class av{constructor({title:e="",description:n,expectedOutput:r,agent:s,isDeliverable:a=!1,externalValidationRequired:i=!1}){this.id=t(),this.title=e,this.description=n,this.expectedOutput=r,this.isDeliverable=a,this.agent=s,this.status=Y,this.result=null,this.stats=null,this.duration=null,this.dependencies=[],this.interpolatedTaskDescription=null,this.feedbackHistory=[],this.externalValidationRequired=i}setStore(e){this.store=e}}class iv{constructor({name:e,agents:t,tasks:n,logLevel:r,inputs:s={},env:a=null}){this.store=It({name:e,agents:[],tasks:[],inputs:s,env:a,logLevel:r}),this.store.getState().addAgents(t),this.store.getState().addTasks(n)}async start(e=null){return new Promise(((t,n)=>{const r=this.store.subscribe((e=>e.teamWorkflowStatus),(e=>{const s=this.store.getState();switch(e){case ue:r(),t({status:e,result:s.workflowResult,stats:this.getWorkflowStats()});break;case ce:r(),n(new Error("Workflow encountered an error"));break;case de:r(),t({status:e,result:null,stats:this.getWorkflowStats()})}}));try{this.store.getState().startWorkflow(e)}catch(e){n(e),r()}}))}getStore(){return this.store}useStore(){return this.store}subscribeToChanges(e,t=[]){if(0===t.length)return this.store.subscribe(e);let n=t.reduce(((e,t)=>({...e,[t]:this.store.getState()[t]})),{});return this.store.subscribe((()=>{const r=this.store.getState();let s=!1;const a={};t.forEach((e=>{const t=r[e];t!==n[e]&&(s=!0,a[e]=t)})),s&&(n={...n,...a},e(a))}))}provideFeedback(e,t){this.store.getState().provideFeedback(e,t)}validateTask(e){this.store.getState().validateTask(e)}onWorkflowStatusChange(e){return this.store.subscribe((e=>e.teamWorkflowStatus),e)}getTasksByStatus(e){return this.store.getState().tasks.filter((t=>t.status===e))}getWorkflowStatus(){return this.store.getState().teamWorkflowStatus}getWorkflowResult(){const e=this.store.getState();return e.teamWorkflowStatus===ue?e.workflowResult:null}getTasks(){return this.store.getState().tasks}getWorkflowStats(){const e=this.store.getState().workflowLogs.find((e=>"WorkflowStatusUpdate"===e.logType&&("FINISHED"===e.workflowStatus||"BLOCKED"===e.workflowStatus)));if(e){const{startTime:t,endTime:n,duration:r,llmUsageStats:s,iterationCount:a,costDetails:i,teamName:o,taskCount:l,agentCount:c}=e.metadata;return{startTime:t,endTime:n,duration:r,llmUsageStats:s,iterationCount:a,costDetails:i,teamName:o,taskCount:l,agentCount:c}}return null}}const ov=[429,500,502,503,504],lv=Promise.resolve(globalThis.fetch??Promise.resolve().then((function(){return fv})).then((e=>e.default)));class cv extends Error{constructor(e){super(e),this.name="MistralAPIError"}}function uv(e){const t=new AbortController;return e.forEach((e=>{e&&(e.addEventListener("abort",(()=>{t.abort(e.reason)}),{once:!0}),e.aborted&&t.abort(e.reason))})),t.signal}var dv=Object.freeze({__proto__:null,default:class{constructor(e=process.env.MISTRAL_API_KEY,t="https://api.mistral.ai",n=5,r=120){this.endpoint=t,this.apiKey=e,this.maxRetries=n,this.timeout=r,this.endpoint.indexOf("inference.azure.com")&&(this.modelDefault="mistral")}async _fetch(...e){return(await lv)(...e)}_request=async function(e,t,n,r){const s=`${this.endpoint}/${t}`,a={method:e,headers:{"User-Agent":"mistral-client-js/0.3.0",Accept:n?.stream?"text/event-stream":"application/json","Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:"get"!==e?JSON.stringify(n):null,signal:uv([AbortSignal.timeout(1e3*this.timeout),r])};for(let e=0;e<this.maxRetries;e++)try{const t=await this._fetch(s,a);if(t.ok){if(n?.stream){if(void 0===t.body.getReader)return t.body;{const e=t.body.getReader(),n=async function*(){try{for(;;){const{done:t,value:n}=await e.read();if(t)return;yield n}}finally{e.releaseLock()}};return n()}}return await t.json()}if(!ov.includes(t.status))throw new cv(`HTTP error! status: ${t.status} Response: \n${await t.text()}`);console.debug(`Retrying request on response status: ${t.status}`,`Response: ${await t.text()}`,`Attempt: ${e+1}`),await new Promise((t=>setTimeout(t,500*Math.pow(2,e+1))))}catch(t){if(console.error(`Request failed: ${t.message}`),"MistralAPIError"===t.name)throw t;if(e===this.maxRetries-1)throw t;await new Promise((t=>setTimeout(t,500*Math.pow(2,e+1))))}throw new Error("Max retries reached")};_makeChatCompletionRequest=function(e,t,n,r,s,a,i,o,l,c,u,d){if(!e&&!this.modelDefault)throw new cv("You must provide a model name");return{model:e??this.modelDefault,messages:t,tools:n??void 0,temperature:r??void 0,max_tokens:s??void 0,top_p:a??void 0,random_seed:i??void 0,stream:o??void 0,safe_prompt:(l||c)??void 0,tool_choice:u??void 0,response_format:d??void 0}};_makeCompletionRequest=function(e,t,n,r,s,a,i,o,l){if(!e&&!this.modelDefault)throw new cv("You must provide a model name");return{model:e??this.modelDefault,prompt:t,suffix:n??void 0,temperature:r??void 0,max_tokens:s??void 0,top_p:a??void 0,random_seed:i??void 0,stop:o??void 0,stream:l??void 0}};listModels=async function(){return await this._request("get","v1/models")};chat=async function({model:e,messages:t,tools:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,safeMode:o,safePrompt:l,toolChoice:c,responseFormat:u},{signal:d}={}){const h=this._makeChatCompletionRequest(e,t,n,r,s,a,i,!1,o,l,c,u);return await this._request("post","v1/chat/completions",h,d)};chatStream=async function*({model:e,messages:t,tools:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,safeMode:o,safePrompt:l,toolChoice:c,responseFormat:u},{signal:d}={}){const h=this._makeChatCompletionRequest(e,t,n,r,s,a,i,!0,o,l,c,u),p=await this._request("post","v1/chat/completions",h,d);let f="";const m=new TextDecoder;for await(const e of p){let t;for(f+=m.decode(e,{stream:!0});-1!==(t=f.indexOf("\n"));){const e=f.substring(0,t);if(f=f.substring(t+1),e.startsWith("data:")){const t=e.substring(6).trim();"[DONE]"!==t&&(yield JSON.parse(t))}}}};embeddings=async function({model:e,input:t}){const n={model:e,input:t};return await this._request("post","v1/embeddings",n)};completion=async function({model:e,prompt:t,suffix:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,stop:o},{signal:l}={}){const c=this._makeCompletionRequest(e,t,n,r,s,a,i,o,!1);return await this._request("post","v1/fim/completions",c,l)};completionStream=async function*({model:e,prompt:t,suffix:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,stop:o},{signal:l}={}){const c=this._makeCompletionRequest(e,t,n,r,s,a,i,o,!0),u=await this._request("post","v1/fim/completions",c,l);let d="";const h=new TextDecoder;for await(const e of u){let t;for(d+=h.decode(e,{stream:!0});-1!==(t=d.indexOf("\n"));){const e=d.substring(0,t);if(d=d.substring(t+1),e.startsWith("data:")){const t=e.substring(6).trim();"[DONE]"!==t&&(yield JSON.parse(t))}}}}}}),hv={exports:{}};!function(e,t){var n=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==i)return i;throw new Error("unable to locate global object")}();e.exports=t=n.fetch,n.fetch&&(t.default=n.fetch.bind(n)),t.Headers=n.Headers,t.Request=n.Request,t.Response=n.Response}(hv,hv.exports);var pv=hv.exports,fv=s({__proto__:null,default:o(pv)},[pv]);export{sv as Agent,av as Task,iv as Team};
