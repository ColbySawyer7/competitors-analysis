!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("uuid")):"function"==typeof define&&define.amd?define(["exports","uuid"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).KaibanJS={},e.uuid)}(this,(function(e,t){"use strict";function n(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(n){if("default"!==n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})}})),t.default=e,Object.freeze(t)}function r(e,t){return t.forEach((function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach((function(n){if("default"!==n&&!(n in e)){var r=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(e,n,r.get?r:{enumerable:!0,get:function(){return t[n]}})}}))})),Object.freeze(e)}var s=n(t);const a=e=>{let t;const n=new Set,r=(e,r)=>{const s="function"==typeof e?e(t):e;if(!Object.is(s,t)){const e=t;t=(null!=r?r:"object"!=typeof s||null===s)?s:Object.assign({},t,s),n.forEach((n=>n(t,e)))}},s=()=>t,a={setState:r,getState:s,getInitialState:()=>i,subscribe:e=>(n.add(e),()=>n.delete(e)),destroy:()=>{console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),n.clear()}},i=t=e(r,s,a);return a};var i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function o(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var l,c={exports:{}},u={};var d,h={exports:{}};
/**
   * @license React
   * react.development.js
   *
   * Copyright (c) Facebook, Inc. and its affiliates.
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   */"production"===process.env.NODE_ENV?c.exports=function(){if(l)return u;l=1;var e=Symbol.for("react.element"),t=Symbol.for("react.portal"),n=Symbol.for("react.fragment"),r=Symbol.for("react.strict_mode"),s=Symbol.for("react.profiler"),a=Symbol.for("react.provider"),i=Symbol.for("react.context"),o=Symbol.for("react.forward_ref"),c=Symbol.for("react.suspense"),d=Symbol.for("react.memo"),h=Symbol.for("react.lazy"),p=Symbol.iterator,f={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},m=Object.assign,g={};function y(e,t,n){this.props=e,this.context=t,this.refs=g,this.updater=n||f}function b(){}function w(e,t,n){this.props=e,this.context=t,this.refs=g,this.updater=n||f}y.prototype.isReactComponent={},y.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},y.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")},b.prototype=y.prototype;var v=w.prototype=new b;v.constructor=w,m(v,y.prototype),v.isPureReactComponent=!0;var _=Array.isArray,k=Object.prototype.hasOwnProperty,E={current:null},O={key:!0,ref:!0,__self:!0,__source:!0};function S(t,n,r){var s,a={},i=null,o=null;if(null!=n)for(s in void 0!==n.ref&&(o=n.ref),void 0!==n.key&&(i=""+n.key),n)k.call(n,s)&&!O.hasOwnProperty(s)&&(a[s]=n[s]);var l=arguments.length-2;if(1===l)a.children=r;else if(1<l){for(var c=Array(l),u=0;u<l;u++)c[u]=arguments[u+2];a.children=c}if(t&&t.defaultProps)for(s in l=t.defaultProps)void 0===a[s]&&(a[s]=l[s]);return{$$typeof:e,type:t,key:i,ref:o,props:a,_owner:E.current}}function T(t){return"object"==typeof t&&null!==t&&t.$$typeof===e}var x=/\/+/g;function A(e,t){return"object"==typeof e&&null!==e&&null!=e.key?function(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,(function(e){return t[e]}))}(""+e.key):t.toString(36)}function I(n,r,s,a,i){var o=typeof n;"undefined"!==o&&"boolean"!==o||(n=null);var l=!1;if(null===n)l=!0;else switch(o){case"string":case"number":l=!0;break;case"object":switch(n.$$typeof){case e:case t:l=!0}}if(l)return i=i(l=n),n=""===a?"."+A(l,0):a,_(i)?(s="",null!=n&&(s=n.replace(x,"$&/")+"/"),I(i,r,s,"",(function(e){return e}))):null!=i&&(T(i)&&(i=function(t,n){return{$$typeof:e,type:t.type,key:n,ref:t.ref,props:t.props,_owner:t._owner}}(i,s+(!i.key||l&&l.key===i.key?"":(""+i.key).replace(x,"$&/")+"/")+n)),r.push(i)),1;if(l=0,a=""===a?".":a+":",_(n))for(var c=0;c<n.length;c++){var u=a+A(o=n[c],c);l+=I(o,r,s,u,i)}else if(u=function(e){return null===e||"object"!=typeof e?null:"function"==typeof(e=p&&e[p]||e["@@iterator"])?e:null}(n),"function"==typeof u)for(n=u.call(n),c=0;!(o=n.next()).done;)l+=I(o=o.value,r,s,u=a+A(o,c++),i);else if("object"===o)throw r=String(n),Error("Objects are not valid as a React child (found: "+("[object Object]"===r?"object with keys {"+Object.keys(n).join(", ")+"}":r)+"). If you meant to render a collection of children, use an array instead.");return l}function P(e,t,n){if(null==e)return e;var r=[],s=0;return I(e,r,"","",(function(e){return t.call(n,e,s++)})),r}function C(e){if(-1===e._status){var t=e._result;(t=t()).then((function(t){0!==e._status&&-1!==e._status||(e._status=1,e._result=t)}),(function(t){0!==e._status&&-1!==e._status||(e._status=2,e._result=t)})),-1===e._status&&(e._status=0,e._result=t)}if(1===e._status)return e._result.default;throw e._result}var R={current:null},N={transition:null},$={ReactCurrentDispatcher:R,ReactCurrentBatchConfig:N,ReactCurrentOwner:E};function j(){throw Error("act(...) is not supported in production builds of React.")}return u.Children={map:P,forEach:function(e,t,n){P(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return P(e,(function(){t++})),t},toArray:function(e){return P(e,(function(e){return e}))||[]},only:function(e){if(!T(e))throw Error("React.Children.only expected to receive a single React element child.");return e}},u.Component=y,u.Fragment=n,u.Profiler=s,u.PureComponent=w,u.StrictMode=r,u.Suspense=c,u.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=$,u.act=j,u.cloneElement=function(t,n,r){if(null==t)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+t+".");var s=m({},t.props),a=t.key,i=t.ref,o=t._owner;if(null!=n){if(void 0!==n.ref&&(i=n.ref,o=E.current),void 0!==n.key&&(a=""+n.key),t.type&&t.type.defaultProps)var l=t.type.defaultProps;for(c in n)k.call(n,c)&&!O.hasOwnProperty(c)&&(s[c]=void 0===n[c]&&void 0!==l?l[c]:n[c])}var c=arguments.length-2;if(1===c)s.children=r;else if(1<c){l=Array(c);for(var u=0;u<c;u++)l[u]=arguments[u+2];s.children=l}return{$$typeof:e,type:t.type,key:a,ref:i,props:s,_owner:o}},u.createContext=function(e){return(e={$$typeof:i,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null}).Provider={$$typeof:a,_context:e},e.Consumer=e},u.createElement=S,u.createFactory=function(e){var t=S.bind(null,e);return t.type=e,t},u.createRef=function(){return{current:null}},u.forwardRef=function(e){return{$$typeof:o,render:e}},u.isValidElement=T,u.lazy=function(e){return{$$typeof:h,_payload:{_status:-1,_result:e},_init:C}},u.memo=function(e,t){return{$$typeof:d,type:e,compare:void 0===t?null:t}},u.startTransition=function(e){var t=N.transition;N.transition={};try{e()}finally{N.transition=t}},u.unstable_act=j,u.useCallback=function(e,t){return R.current.useCallback(e,t)},u.useContext=function(e){return R.current.useContext(e)},u.useDebugValue=function(){},u.useDeferredValue=function(e){return R.current.useDeferredValue(e)},u.useEffect=function(e,t){return R.current.useEffect(e,t)},u.useId=function(){return R.current.useId()},u.useImperativeHandle=function(e,t,n){return R.current.useImperativeHandle(e,t,n)},u.useInsertionEffect=function(e,t){return R.current.useInsertionEffect(e,t)},u.useLayoutEffect=function(e,t){return R.current.useLayoutEffect(e,t)},u.useMemo=function(e,t){return R.current.useMemo(e,t)},u.useReducer=function(e,t,n){return R.current.useReducer(e,t,n)},u.useRef=function(e){return R.current.useRef(e)},u.useState=function(e){return R.current.useState(e)},u.useSyncExternalStore=function(e,t,n){return R.current.useSyncExternalStore(e,t,n)},u.useTransition=function(){return R.current.useTransition()},u.version="18.3.1",u}():c.exports=(d||(d=1,function(e,t){"production"!==process.env.NODE_ENV&&function(){"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error);var n=Symbol.for("react.element"),r=Symbol.for("react.portal"),s=Symbol.for("react.fragment"),a=Symbol.for("react.strict_mode"),i=Symbol.for("react.profiler"),o=Symbol.for("react.provider"),l=Symbol.for("react.context"),c=Symbol.for("react.forward_ref"),u=Symbol.for("react.suspense"),d=Symbol.for("react.suspense_list"),h=Symbol.for("react.memo"),p=Symbol.for("react.lazy"),f=Symbol.for("react.offscreen"),m=Symbol.iterator;function g(e){if(null===e||"object"!=typeof e)return null;var t=m&&e[m]||e["@@iterator"];return"function"==typeof t?t:null}var y={current:null},b={transition:null},w={current:null,isBatchingLegacy:!1,didScheduleLegacyUpdate:!1},v={current:null},_={},k=null;function E(e){k=e}_.setExtraStackFrame=function(e){k=e},_.getCurrentStack=null,_.getStackAddendum=function(){var e="";k&&(e+=k);var t=_.getCurrentStack;return t&&(e+=t()||""),e};var O={ReactCurrentDispatcher:y,ReactCurrentBatchConfig:b,ReactCurrentOwner:v};function S(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];x("warn",e,n)}function T(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];x("error",e,n)}function x(e,t,n){var r=O.ReactDebugCurrentFrame.getStackAddendum();""!==r&&(t+="%s",n=n.concat([r]));var s=n.map((function(e){return String(e)}));s.unshift("Warning: "+t),Function.prototype.apply.call(console[e],console,s)}O.ReactDebugCurrentFrame=_,O.ReactCurrentActQueue=w;var A={};function I(e,t){var n=e.constructor,r=n&&(n.displayName||n.name)||"ReactClass",s=r+"."+t;A[s]||(T("Can't call %s on a component that is not yet mounted. This is a no-op, but it might indicate a bug in your application. Instead, assign to `this.state` directly or define a `state = {};` class property with the desired state in the %s component.",t,r),A[s]=!0)}var P={isMounted:function(e){return!1},enqueueForceUpdate:function(e,t,n){I(e,"forceUpdate")},enqueueReplaceState:function(e,t,n,r){I(e,"replaceState")},enqueueSetState:function(e,t,n,r){I(e,"setState")}},C=Object.assign,R={};function N(e,t,n){this.props=e,this.context=t,this.refs=R,this.updater=n||P}Object.freeze(R),N.prototype.isReactComponent={},N.prototype.setState=function(e,t){if("object"!=typeof e&&"function"!=typeof e&&null!=e)throw new Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")},N.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")};var $={isMounted:["isMounted","Instead, make sure to clean up subscriptions and pending requests in componentWillUnmount to prevent memory leaks."],replaceState:["replaceState","Refactor your code to use setState instead (see https://github.com/facebook/react/issues/3236)."]},j=function(e,t){Object.defineProperty(N.prototype,e,{get:function(){S("%s(...) is deprecated in plain JavaScript React classes. %s",t[0],t[1])}})};for(var L in $)$.hasOwnProperty(L)&&j(L,$[L]);function M(){}function D(e,t,n){this.props=e,this.context=t,this.refs=R,this.updater=n||P}M.prototype=N.prototype;var U=D.prototype=new M;U.constructor=D,C(U,N.prototype),U.isPureReactComponent=!0;var F=Array.isArray;function B(e){return F(e)}function q(e){return""+e}function z(e){if(function(e){try{return q(e),!1}catch(e){return!0}}(e))return T("The provided key is an unsupported type %s. This value must be coerced to a string before before using it here.",function(e){return"function"==typeof Symbol&&Symbol.toStringTag&&e[Symbol.toStringTag]||e.constructor.name||"Object"}(e)),q(e)}function H(e){return e.displayName||"Context"}function W(e){if(null==e)return null;if("number"==typeof e.tag&&T("Received an unexpected object in getComponentNameFromType(). This is likely a bug in React. Please file an issue."),"function"==typeof e)return e.displayName||e.name||null;if("string"==typeof e)return e;switch(e){case s:return"Fragment";case r:return"Portal";case i:return"Profiler";case a:return"StrictMode";case u:return"Suspense";case d:return"SuspenseList"}if("object"==typeof e)switch(e.$$typeof){case l:return H(e)+".Consumer";case o:return H(e._context)+".Provider";case c:return function(e,t,n){var r=e.displayName;if(r)return r;var s=t.displayName||t.name||"";return""!==s?n+"("+s+")":n}(e,e.render,"ForwardRef");case h:var t=e.displayName||null;return null!==t?t:W(e.type)||"Memo";case p:var n=e,f=n._payload,m=n._init;try{return W(m(f))}catch(e){return null}}return null}var K,V,G,Z=Object.prototype.hasOwnProperty,J={key:!0,ref:!0,__self:!0,__source:!0};function X(e){if(Z.call(e,"ref")){var t=Object.getOwnPropertyDescriptor(e,"ref").get;if(t&&t.isReactWarning)return!1}return void 0!==e.ref}function Y(e){if(Z.call(e,"key")){var t=Object.getOwnPropertyDescriptor(e,"key").get;if(t&&t.isReactWarning)return!1}return void 0!==e.key}G={};var Q=function(e,t,r,s,a,i,o){var l={$$typeof:n,type:e,key:t,ref:r,props:o,_owner:i,_store:{}};return Object.defineProperty(l._store,"validated",{configurable:!1,enumerable:!1,writable:!0,value:!1}),Object.defineProperty(l,"_self",{configurable:!1,enumerable:!1,writable:!1,value:s}),Object.defineProperty(l,"_source",{configurable:!1,enumerable:!1,writable:!1,value:a}),Object.freeze&&(Object.freeze(l.props),Object.freeze(l)),l};function ee(e,t,n){var r,s={},a=null,i=null,o=null,l=null;if(null!=t)for(r in X(t)&&(i=t.ref,function(e){if("string"==typeof e.ref&&v.current&&e.__self&&v.current.stateNode!==e.__self){var t=W(v.current.type);G[t]||(T('Component "%s" contains the string ref "%s". Support for string refs will be removed in a future major release. This case cannot be automatically converted to an arrow function. We ask you to manually fix this case by using useRef() or createRef() instead. Learn more about using refs safely here: https://reactjs.org/link/strict-mode-string-ref',t,e.ref),G[t]=!0)}}(t)),Y(t)&&(z(t.key),a=""+t.key),o=void 0===t.__self?null:t.__self,l=void 0===t.__source?null:t.__source,t)Z.call(t,r)&&!J.hasOwnProperty(r)&&(s[r]=t[r]);var c=arguments.length-2;if(1===c)s.children=n;else if(c>1){for(var u=Array(c),d=0;d<c;d++)u[d]=arguments[d+2];Object.freeze&&Object.freeze(u),s.children=u}if(e&&e.defaultProps){var h=e.defaultProps;for(r in h)void 0===s[r]&&(s[r]=h[r])}if(a||i){var p="function"==typeof e?e.displayName||e.name||"Unknown":e;a&&function(e,t){var n=function(){K||(K=!0,T("%s: `key` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",t))};n.isReactWarning=!0,Object.defineProperty(e,"key",{get:n,configurable:!0})}(s,p),i&&function(e,t){var n=function(){V||(V=!0,T("%s: `ref` is not a prop. Trying to access it will result in `undefined` being returned. If you need to access the same value within the child component, you should pass it as a different prop. (https://reactjs.org/link/special-props)",t))};n.isReactWarning=!0,Object.defineProperty(e,"ref",{get:n,configurable:!0})}(s,p)}return Q(e,a,i,o,l,v.current,s)}function te(e,t,n){if(null==e)throw new Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var r,s,a=C({},e.props),i=e.key,o=e.ref,l=e._self,c=e._source,u=e._owner;if(null!=t)for(r in X(t)&&(o=t.ref,u=v.current),Y(t)&&(z(t.key),i=""+t.key),e.type&&e.type.defaultProps&&(s=e.type.defaultProps),t)Z.call(t,r)&&!J.hasOwnProperty(r)&&(void 0===t[r]&&void 0!==s?a[r]=s[r]:a[r]=t[r]);var d=arguments.length-2;if(1===d)a.children=n;else if(d>1){for(var h=Array(d),p=0;p<d;p++)h[p]=arguments[p+2];a.children=h}return Q(e.type,i,o,l,c,u,a)}function ne(e){return"object"==typeof e&&null!==e&&e.$$typeof===n}var re,se=!1,ae=/\/+/g;function ie(e){return e.replace(ae,"$&/")}function oe(e,t){return"object"==typeof e&&null!==e&&null!=e.key?(z(e.key),n=""+e.key,r={"=":"=0",":":"=2"},"$"+n.replace(/[=:]/g,(function(e){return r[e]}))):t.toString(36);var n,r}function le(e,t,s,a,i){var o=typeof e;"undefined"!==o&&"boolean"!==o||(e=null);var l,c,u,d=!1;if(null===e)d=!0;else switch(o){case"string":case"number":d=!0;break;case"object":switch(e.$$typeof){case n:case r:d=!0}}if(d){var h=e,p=i(h),f=""===a?"."+oe(h,0):a;if(B(p)){var m="";null!=f&&(m=ie(f)+"/"),le(p,t,m,"",(function(e){return e}))}else null!=p&&(ne(p)&&(!p.key||h&&h.key===p.key||z(p.key),l=p,c=s+(!p.key||h&&h.key===p.key?"":ie(""+p.key)+"/")+f,p=Q(l.type,c,l.ref,l._self,l._source,l._owner,l.props)),t.push(p));return 1}var y=0,b=""===a?".":a+":";if(B(e))for(var w=0;w<e.length;w++)y+=le(u=e[w],t,s,b+oe(u,w),i);else{var v=g(e);if("function"==typeof v){var _=e;v===_.entries&&(se||S("Using Maps as children is not supported. Use an array of keyed ReactElements instead."),se=!0);for(var k,E=v.call(_),O=0;!(k=E.next()).done;)y+=le(u=k.value,t,s,b+oe(u,O++),i)}else if("object"===o){var T=String(e);throw new Error("Objects are not valid as a React child (found: "+("[object Object]"===T?"object with keys {"+Object.keys(e).join(", ")+"}":T)+"). If you meant to render a collection of children, use an array instead.")}}return y}function ce(e,t,n){if(null==e)return e;var r=[],s=0;return le(e,r,"","",(function(e){return t.call(n,e,s++)})),r}function ue(e){if(-1===e._status){var t=(0,e._result)();if(t.then((function(t){if(0===e._status||-1===e._status){var n=e;n._status=1,n._result=t}}),(function(t){if(0===e._status||-1===e._status){var n=e;n._status=2,n._result=t}})),-1===e._status){var n=e;n._status=0,n._result=t}}if(1===e._status){var r=e._result;return void 0===r&&T("lazy: Expected the result of a dynamic import() call. Instead received: %s\n\nYour code should look like: \n  const MyComponent = lazy(() => import('./MyComponent'))\n\nDid you accidentally put curly braces around the import?",r),"default"in r||T("lazy: Expected the result of a dynamic import() call. Instead received: %s\n\nYour code should look like: \n  const MyComponent = lazy(() => import('./MyComponent'))",r),r.default}throw e._result}function de(e){return"string"==typeof e||"function"==typeof e||e===s||e===i||e===a||e===u||e===d||e===f||"object"==typeof e&&null!==e&&(e.$$typeof===p||e.$$typeof===h||e.$$typeof===o||e.$$typeof===l||e.$$typeof===c||e.$$typeof===re||void 0!==e.getModuleId)}function he(){var e=y.current;return null===e&&T("Invalid hook call. Hooks can only be called inside of the body of a function component. This could happen for one of the following reasons:\n1. You might have mismatching versions of React and the renderer (such as React DOM)\n2. You might be breaking the Rules of Hooks\n3. You might have more than one copy of React in the same app\nSee https://reactjs.org/link/invalid-hook-call for tips about how to debug and fix this problem."),e}re=Symbol.for("react.module.reference");var pe,fe,me,ge,ye,be,we,ve=0;function _e(){}_e.__reactDisabledLog=!0;var ke,Ee=O.ReactCurrentDispatcher;function Oe(e,t,n){if(void 0===ke)try{throw Error()}catch(e){var r=e.stack.trim().match(/\n( *(at )?)/);ke=r&&r[1]||""}return"\n"+ke+e}var Se,Te=!1,xe="function"==typeof WeakMap?WeakMap:Map;function Ae(e,t){if(!e||Te)return"";var n,r=Se.get(e);if(void 0!==r)return r;Te=!0;var s,a=Error.prepareStackTrace;Error.prepareStackTrace=void 0,s=Ee.current,Ee.current=null,function(){if(0===ve){pe=console.log,fe=console.info,me=console.warn,ge=console.error,ye=console.group,be=console.groupCollapsed,we=console.groupEnd;var e={configurable:!0,enumerable:!0,value:_e,writable:!0};Object.defineProperties(console,{info:e,log:e,warn:e,error:e,group:e,groupCollapsed:e,groupEnd:e})}ve++}();try{if(t){var i=function(){throw Error()};if(Object.defineProperty(i.prototype,"props",{set:function(){throw Error()}}),"object"==typeof Reflect&&Reflect.construct){try{Reflect.construct(i,[])}catch(e){n=e}Reflect.construct(e,[],i)}else{try{i.call()}catch(e){n=e}e.call(i.prototype)}}else{try{throw Error()}catch(e){n=e}e()}}catch(t){if(t&&n&&"string"==typeof t.stack){for(var o=t.stack.split("\n"),l=n.stack.split("\n"),c=o.length-1,u=l.length-1;c>=1&&u>=0&&o[c]!==l[u];)u--;for(;c>=1&&u>=0;c--,u--)if(o[c]!==l[u]){if(1!==c||1!==u)do{if(c--,--u<0||o[c]!==l[u]){var d="\n"+o[c].replace(" at new "," at ");return e.displayName&&d.includes("<anonymous>")&&(d=d.replace("<anonymous>",e.displayName)),"function"==typeof e&&Se.set(e,d),d}}while(c>=1&&u>=0);break}}}finally{Te=!1,Ee.current=s,function(){if(0==--ve){var e={configurable:!0,enumerable:!0,writable:!0};Object.defineProperties(console,{log:C({},e,{value:pe}),info:C({},e,{value:fe}),warn:C({},e,{value:me}),error:C({},e,{value:ge}),group:C({},e,{value:ye}),groupCollapsed:C({},e,{value:be}),groupEnd:C({},e,{value:we})})}ve<0&&T("disabledDepth fell below zero. This is a bug in React. Please file an issue.")}(),Error.prepareStackTrace=a}var h=e?e.displayName||e.name:"",p=h?Oe(h):"";return"function"==typeof e&&Se.set(e,p),p}function Ie(e,t,n){if(null==e)return"";if("function"==typeof e)return Ae(e,function(e){var t=e.prototype;return!(!t||!t.isReactComponent)}(e));if("string"==typeof e)return Oe(e);switch(e){case u:return Oe("Suspense");case d:return Oe("SuspenseList")}if("object"==typeof e)switch(e.$$typeof){case c:return Ae(e.render,!1);case h:return Ie(e.type,t,n);case p:var r=e,s=r._payload,a=r._init;try{return Ie(a(s),t,n)}catch(e){}}return""}Se=new xe;var Pe,Ce={},Re=O.ReactDebugCurrentFrame;function Ne(e){if(e){var t=e._owner,n=Ie(e.type,e._source,t?t.type:null);Re.setExtraStackFrame(n)}else Re.setExtraStackFrame(null)}function $e(e){if(e){var t=e._owner;E(Ie(e.type,e._source,t?t.type:null))}else E(null)}function je(){if(v.current){var e=W(v.current.type);if(e)return"\n\nCheck the render method of `"+e+"`."}return""}Pe=!1;var Le={};function Me(e,t){if(e._store&&!e._store.validated&&null==e.key){e._store.validated=!0;var n=function(e){var t=je();if(!t){var n="string"==typeof e?e:e.displayName||e.name;n&&(t="\n\nCheck the top-level render call using <"+n+">.")}return t}(t);if(!Le[n]){Le[n]=!0;var r="";e&&e._owner&&e._owner!==v.current&&(r=" It was passed a child from "+W(e._owner.type)+"."),$e(e),T('Each child in a list should have a unique "key" prop.%s%s See https://reactjs.org/link/warning-keys for more information.',n,r),$e(null)}}}function De(e,t){if("object"==typeof e)if(B(e))for(var n=0;n<e.length;n++){var r=e[n];ne(r)&&Me(r,t)}else if(ne(e))e._store&&(e._store.validated=!0);else if(e){var s=g(e);if("function"==typeof s&&s!==e.entries)for(var a,i=s.call(e);!(a=i.next()).done;)ne(a.value)&&Me(a.value,t)}}function Ue(e){var t,n=e.type;if(null!=n&&"string"!=typeof n){if("function"==typeof n)t=n.propTypes;else{if("object"!=typeof n||n.$$typeof!==c&&n.$$typeof!==h)return;t=n.propTypes}if(t){var r=W(n);!function(e,t,n,r,s){var a=Function.call.bind(Z);for(var i in e)if(a(e,i)){var o=void 0;try{if("function"!=typeof e[i]){var l=Error((r||"React class")+": "+n+" type `"+i+"` is invalid; it must be a function, usually from the `prop-types` package, but received `"+typeof e[i]+"`.This often happens because of typos such as `PropTypes.function` instead of `PropTypes.func`.");throw l.name="Invariant Violation",l}o=e[i](t,i,r,n,null,"SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED")}catch(e){o=e}!o||o instanceof Error||(Ne(s),T("%s: type specification of %s `%s` is invalid; the type checker function must return `null` or an `Error` but returned a %s. You may have forgotten to pass an argument to the type checker creator (arrayOf, instanceOf, objectOf, oneOf, oneOfType, and shape all require an argument).",r||"React class",n,i,typeof o),Ne(null)),o instanceof Error&&!(o.message in Ce)&&(Ce[o.message]=!0,Ne(s),T("Failed %s type: %s",n,o.message),Ne(null))}}(t,e.props,"prop",r,e)}else void 0===n.PropTypes||Pe||(Pe=!0,T("Component %s declared `PropTypes` instead of `propTypes`. Did you misspell the property assignment?",W(n)||"Unknown"));"function"!=typeof n.getDefaultProps||n.getDefaultProps.isReactClassApproved||T("getDefaultProps is only used on classic React.createClass definitions. Use a static property named `defaultProps` instead.")}}function Fe(e,t,r){var a,i,o=de(e);if(!o){var l,c="";(void 0===e||"object"==typeof e&&null!==e&&0===Object.keys(e).length)&&(c+=" You likely forgot to export your component from the file it's defined in, or you might have mixed up default and named imports."),c+=(null!=(a=t)&&void 0!==(i=a.__source)?"\n\nCheck your code at "+i.fileName.replace(/^.*[\\\/]/,"")+":"+i.lineNumber+".":"")||je(),null===e?l="null":B(e)?l="array":void 0!==e&&e.$$typeof===n?(l="<"+(W(e.type)||"Unknown")+" />",c=" Did you accidentally export a JSX literal instead of a component?"):l=typeof e,T("React.createElement: type is invalid -- expected a string (for built-in components) or a class/function (for composite components) but got: %s.%s",l,c)}var u=ee.apply(this,arguments);if(null==u)return u;if(o)for(var d=2;d<arguments.length;d++)De(arguments[d],e);return e===s?function(e){for(var t=Object.keys(e.props),n=0;n<t.length;n++){var r=t[n];if("children"!==r&&"key"!==r){$e(e),T("Invalid prop `%s` supplied to `React.Fragment`. React.Fragment can only have `key` and `children` props.",r),$e(null);break}}null!==e.ref&&($e(e),T("Invalid attribute `ref` supplied to `React.Fragment`."),$e(null))}(u):Ue(u),u}var Be=!1,qe=!1,ze=null,He=0,We=!1;function Ke(e){var t=He;He++,null===w.current&&(w.current=[]);var n,r=w.isBatchingLegacy;try{if(w.isBatchingLegacy=!0,n=e(),!r&&w.didScheduleLegacyUpdate){var s=w.current;null!==s&&(w.didScheduleLegacyUpdate=!1,Je(s))}}catch(e){throw Ve(t),e}finally{w.isBatchingLegacy=r}if(null!==n&&"object"==typeof n&&"function"==typeof n.then){var a=n,i=!1,o={then:function(e,n){i=!0,a.then((function(r){Ve(t),0===He?Ge(r,e,n):e(r)}),(function(e){Ve(t),n(e)}))}};return We||"undefined"==typeof Promise||Promise.resolve().then((function(){})).then((function(){i||(We=!0,T("You called act(async () => ...) without await. This could lead to unexpected testing behaviour, interleaving multiple act calls and mixing their scopes. You should - await act(async () => ...);"))})),o}var l=n;if(Ve(t),0===He){var c=w.current;return null!==c&&(Je(c),w.current=null),{then:function(e,t){null===w.current?(w.current=[],Ge(l,e,t)):e(l)}}}return{then:function(e,t){e(l)}}}function Ve(e){e!==He-1&&T("You seem to have overlapping act() calls, this is not supported. Be sure to await previous act() calls before making a new one. "),He=e}function Ge(t,n,r){var s=w.current;if(null!==s)try{Je(s),function(t){if(null===ze)try{var n=("require"+Math.random()).slice(0,7);ze=(e&&e[n]).call(e,"timers").setImmediate}catch(e){ze=function(e){!1===qe&&(qe=!0,"undefined"==typeof MessageChannel&&T("This browser does not have a MessageChannel implementation, so enqueuing tasks via await act(async () => ...) will fail. Please file an issue at https://github.com/facebook/react/issues if you encounter this warning."));var t=new MessageChannel;t.port1.onmessage=e,t.port2.postMessage(void 0)}}ze(t)}((function(){0===s.length?(w.current=null,n(t)):Ge(t,n,r)}))}catch(e){r(e)}else n(t)}var Ze=!1;function Je(e){if(!Ze){Ze=!0;var t=0;try{for(;t<e.length;t++){var n=e[t];do{n=n(!0)}while(null!==n)}e.length=0}catch(n){throw e=e.slice(t+1),n}finally{Ze=!1}}}var Xe=Fe,Ye=function(e,t,n){for(var r=te.apply(this,arguments),s=2;s<arguments.length;s++)De(arguments[s],r.type);return Ue(r),r},Qe=function(e){var t=Fe.bind(null,e);return t.type=e,Be||(Be=!0,S("React.createFactory() is deprecated and will be removed in a future major release. Consider using JSX or use React.createElement() directly instead.")),Object.defineProperty(t,"type",{enumerable:!1,get:function(){return S("Factory.type is deprecated. Access the class directly before passing it to createFactory."),Object.defineProperty(this,"type",{value:e}),e}}),t},et={map:ce,forEach:function(e,t,n){ce(e,(function(){t.apply(this,arguments)}),n)},count:function(e){var t=0;return ce(e,(function(){t++})),t},toArray:function(e){return ce(e,(function(e){return e}))||[]},only:function(e){if(!ne(e))throw new Error("React.Children.only expected to receive a single React element child.");return e}};t.Children=et,t.Component=N,t.Fragment=s,t.Profiler=i,t.PureComponent=D,t.StrictMode=a,t.Suspense=u,t.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=O,t.act=Ke,t.cloneElement=Ye,t.createContext=function(e){var t={$$typeof:l,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null};t.Provider={$$typeof:o,_context:t};var n=!1,r=!1,s=!1,a={$$typeof:l,_context:t};return Object.defineProperties(a,{Provider:{get:function(){return r||(r=!0,T("Rendering <Context.Consumer.Provider> is not supported and will be removed in a future major release. Did you mean to render <Context.Provider> instead?")),t.Provider},set:function(e){t.Provider=e}},_currentValue:{get:function(){return t._currentValue},set:function(e){t._currentValue=e}},_currentValue2:{get:function(){return t._currentValue2},set:function(e){t._currentValue2=e}},_threadCount:{get:function(){return t._threadCount},set:function(e){t._threadCount=e}},Consumer:{get:function(){return n||(n=!0,T("Rendering <Context.Consumer.Consumer> is not supported and will be removed in a future major release. Did you mean to render <Context.Consumer> instead?")),t.Consumer}},displayName:{get:function(){return t.displayName},set:function(e){s||(S("Setting `displayName` on Context.Consumer has no effect. You should set it directly on the context with Context.displayName = '%s'.",e),s=!0)}}}),t.Consumer=a,t._currentRenderer=null,t._currentRenderer2=null,t},t.createElement=Xe,t.createFactory=Qe,t.createRef=function(){var e={current:null};return Object.seal(e),e},t.forwardRef=function(e){null!=e&&e.$$typeof===h?T("forwardRef requires a render function but received a `memo` component. Instead of forwardRef(memo(...)), use memo(forwardRef(...))."):"function"!=typeof e?T("forwardRef requires a render function but was given %s.",null===e?"null":typeof e):0!==e.length&&2!==e.length&&T("forwardRef render functions accept exactly two parameters: props and ref. %s",1===e.length?"Did you forget to use the ref parameter?":"Any additional parameter will be undefined."),null!=e&&(null==e.defaultProps&&null==e.propTypes||T("forwardRef render functions do not support propTypes or defaultProps. Did you accidentally pass a React component?"));var t,n={$$typeof:c,render:e};return Object.defineProperty(n,"displayName",{enumerable:!1,configurable:!0,get:function(){return t},set:function(n){t=n,e.name||e.displayName||(e.displayName=n)}}),n},t.isValidElement=ne,t.lazy=function(e){var t,n,r={$$typeof:p,_payload:{_status:-1,_result:e},_init:ue};return Object.defineProperties(r,{defaultProps:{configurable:!0,get:function(){return t},set:function(e){T("React.lazy(...): It is not supported to assign `defaultProps` to a lazy component import. Either specify them where the component is defined, or create a wrapping component around it."),t=e,Object.defineProperty(r,"defaultProps",{enumerable:!0})}},propTypes:{configurable:!0,get:function(){return n},set:function(e){T("React.lazy(...): It is not supported to assign `propTypes` to a lazy component import. Either specify them where the component is defined, or create a wrapping component around it."),n=e,Object.defineProperty(r,"propTypes",{enumerable:!0})}}}),r},t.memo=function(e,t){de(e)||T("memo: The first argument must be a component. Instead received: %s",null===e?"null":typeof e);var n,r={$$typeof:h,type:e,compare:void 0===t?null:t};return Object.defineProperty(r,"displayName",{enumerable:!1,configurable:!0,get:function(){return n},set:function(t){n=t,e.name||e.displayName||(e.displayName=t)}}),r},t.startTransition=function(e,t){var n=b.transition;b.transition={};var r=b.transition;b.transition._updatedFibers=new Set;try{e()}finally{b.transition=n,null===n&&r._updatedFibers&&(r._updatedFibers.size>10&&S("Detected a large number of updates inside startTransition. If this is due to a subscription please re-write it to use React provided hooks. Otherwise concurrent mode guarantees are off the table."),r._updatedFibers.clear())}},t.unstable_act=Ke,t.useCallback=function(e,t){return he().useCallback(e,t)},t.useContext=function(e){var t=he();if(void 0!==e._context){var n=e._context;n.Consumer===e?T("Calling useContext(Context.Consumer) is not supported, may cause bugs, and will be removed in a future major release. Did you mean to call useContext(Context) instead?"):n.Provider===e&&T("Calling useContext(Context.Provider) is not supported. Did you mean to call useContext(Context) instead?")}return t.useContext(e)},t.useDebugValue=function(e,t){return he().useDebugValue(e,t)},t.useDeferredValue=function(e){return he().useDeferredValue(e)},t.useEffect=function(e,t){return he().useEffect(e,t)},t.useId=function(){return he().useId()},t.useImperativeHandle=function(e,t,n){return he().useImperativeHandle(e,t,n)},t.useInsertionEffect=function(e,t){return he().useInsertionEffect(e,t)},t.useLayoutEffect=function(e,t){return he().useLayoutEffect(e,t)},t.useMemo=function(e,t){return he().useMemo(e,t)},t.useReducer=function(e,t,n){return he().useReducer(e,t,n)},t.useRef=function(e){return he().useRef(e)},t.useState=function(e){return he().useState(e)},t.useSyncExternalStore=function(e,t,n){return he().useSyncExternalStore(e,t,n)},t.useTransition=function(){return he().useTransition()},t.version="18.3.1","undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error)}()}(h,h.exports)),h.exports);var p,f=c.exports,m=o(f),g={exports:{}},y={},b={exports:{}},w={};var v,_,k,E={};
/**
   * @license React
   * use-sync-external-store-shim.development.js
   *
   * Copyright (c) Facebook, Inc. and its affiliates.
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   */function O(){return v||(v=1,"production"!==process.env.NODE_ENV&&function(){"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error);var e=f,t=e.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;function n(e){for(var n=arguments.length,r=new Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];!function(e,n,r){var s=t.ReactDebugCurrentFrame.getStackAddendum();""!==s&&(n+="%s",r=r.concat([s]));var a=r.map((function(e){return String(e)}));a.unshift("Warning: "+n),Function.prototype.apply.call(console[e],console,a)}("error",e,r)}var r="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},s=e.useState,a=e.useEffect,i=e.useLayoutEffect,o=e.useDebugValue,l=!1,c=!1;function u(e){var t=e.getSnapshot,n=e.value;try{var s=t();return!r(n,s)}catch(e){return!0}}var d=!!("undefined"==typeof window||void 0===window.document||void 0===window.document.createElement)?function(e,t,n){return t()}:function(t,d,h){l||void 0!==e.startTransition&&(l=!0,n("You are using an outdated, pre-release alpha of React 18 that does not support useSyncExternalStore. The use-sync-external-store shim will not work correctly. Upgrade to a newer pre-release."));var p=d();if(!c){var f=d();r(p,f)||(n("The result of getSnapshot should be cached to avoid an infinite loop"),c=!0)}var m=s({inst:{value:p,getSnapshot:d}}),g=m[0].inst,y=m[1];return i((function(){g.value=p,g.getSnapshot=d,u(g)&&y({inst:g})}),[t,p,d]),a((function(){u(g)&&y({inst:g});return t((function(){u(g)&&y({inst:g})}))}),[t]),o(p),p},h=void 0!==e.useSyncExternalStore?e.useSyncExternalStore:d;E.useSyncExternalStore=h,"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error)}()),E}function S(){return _||(_=1,"production"===process.env.NODE_ENV?b.exports=function(){if(p)return w;p=1;var e=f,t="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},n=e.useState,r=e.useEffect,s=e.useLayoutEffect,a=e.useDebugValue;function i(e){var n=e.getSnapshot;e=e.value;try{var r=n();return!t(e,r)}catch(e){return!0}}var o="undefined"==typeof window||void 0===window.document||void 0===window.document.createElement?function(e,t){return t()}:function(e,t){var o=t(),l=n({inst:{value:o,getSnapshot:t}}),c=l[0].inst,u=l[1];return s((function(){c.value=o,c.getSnapshot=t,i(c)&&u({inst:c})}),[e,o,t]),r((function(){return i(c)&&u({inst:c}),e((function(){i(c)&&u({inst:c})}))}),[e]),a(o),o};return w.useSyncExternalStore=void 0!==e.useSyncExternalStore?e.useSyncExternalStore:o,w}():b.exports=O()),b.exports}
/**
   * @license React
   * use-sync-external-store-shim/with-selector.production.min.js
   *
   * Copyright (c) Facebook, Inc. and its affiliates.
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   */var T,x={};
/**
   * @license React
   * use-sync-external-store-shim/with-selector.development.js
   *
   * Copyright (c) Facebook, Inc. and its affiliates.
   *
   * This source code is licensed under the MIT license found in the
   * LICENSE file in the root directory of this source tree.
   */"production"===process.env.NODE_ENV?g.exports=function(){if(k)return y;k=1;var e=f,t=S(),n="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},r=t.useSyncExternalStore,s=e.useRef,a=e.useEffect,i=e.useMemo,o=e.useDebugValue;return y.useSyncExternalStoreWithSelector=function(e,t,l,c,u){var d=s(null);if(null===d.current){var h={hasValue:!1,value:null};d.current=h}else h=d.current;d=i((function(){function e(e){if(!a){if(a=!0,r=e,e=c(e),void 0!==u&&h.hasValue){var t=h.value;if(u(t,e))return s=t}return s=e}if(t=s,n(r,e))return t;var i=c(e);return void 0!==u&&u(t,i)?t:(r=e,s=i)}var r,s,a=!1,i=void 0===l?null:l;return[function(){return e(t())},null===i?void 0:function(){return e(i())}]}),[t,l,c,u]);var p=r(e,d[0],d[1]);return a((function(){h.hasValue=!0,h.value=p}),[p]),o(p),p},y}():g.exports=(T||(T=1,"production"!==process.env.NODE_ENV&&function(){"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStart(new Error);var e=f,t=S(),n="function"==typeof Object.is?Object.is:function(e,t){return e===t&&(0!==e||1/e==1/t)||e!=e&&t!=t},r=t.useSyncExternalStore,s=e.useRef,a=e.useEffect,i=e.useMemo,o=e.useDebugValue;x.useSyncExternalStoreWithSelector=function(e,t,l,c,u){var d,h=s(null);null===h.current?(d={hasValue:!1,value:null},h.current=d):d=h.current;var p=i((function(){var e,r,s=!1,a=function(t){if(!s){s=!0,e=t;var a=c(t);if(void 0!==u&&d.hasValue){var i=d.value;if(u(i,a))return r=i,i}return r=a,a}var o=r;if(n(e,t))return o;var l=c(t);return void 0!==u&&u(o,l)?o:(e=t,r=l,l)},i=void 0===l?null:l;return[function(){return a(t())},null===i?void 0:function(){return a(i())}]}),[t,l,c,u]),f=p[0],m=p[1],g=r(e,f,m);return a((function(){d.hasValue=!0,d.value=g}),[g]),o(g),g},"undefined"!=typeof __REACT_DEVTOOLS_GLOBAL_HOOK__&&"function"==typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop&&__REACT_DEVTOOLS_GLOBAL_HOOK__.registerInternalModuleStop(new Error)}()),x);var A=o(g.exports);const{useDebugValue:I}=m,{useSyncExternalStoreWithSelector:P}=A;let C=!1;const R=e=>e;const N=e=>{"function"!=typeof e&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const t="function"==typeof e?(e=>e?a(e):a)(e):e,n=(e,n)=>function(e,t=R,n){n&&!C&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),C=!0);const r=P(e.subscribe,e.getState,e.getServerState||e.getInitialState,t,n);return I(r),r}(t,e,n);return Object.assign(n,t),n},$=new Map,j=e=>{const t=$.get(e);return t?Object.fromEntries(Object.entries(t.stores).map((([e,t])=>[e,t.getState()]))):{}},L=(e,t={})=>(n,r,s)=>{const{enabled:a,anonymousActionType:i,store:o,...l}=t;let c;try{c=(null==a||a)&&window.__REDUX_DEVTOOLS_EXTENSION__}catch(e){}if(!c)return a&&console.warn("[zustand devtools middleware] Please install/enable Redux devtools extension"),e(n,r,s);const{connection:u,...d}=((e,t,n)=>{if(void 0===e)return{type:"untracked",connection:t.connect(n)};const r=$.get(n.name);if(r)return{type:"tracked",store:e,...r};const s={connection:t.connect(n),stores:{}};return $.set(n.name,s),{type:"tracked",store:e,...s}})(o,c,l);let h=!0;s.setState=(e,t,a)=>{const c=n(e,t);if(!h)return c;const d=void 0===a?{type:i||"anonymous"}:"string"==typeof a?{type:a}:a;return void 0===o?(null==u||u.send(d,r()),c):(null==u||u.send({...d,type:`${o}/${d.type}`},{...j(l.name),[o]:s.getState()}),c)};const p=(...e)=>{const t=h;h=!1,n(...e),h=t},f=e(s.setState,r,s);if("untracked"===d.type?null==u||u.init(f):(d.stores[d.store]=s,null==u||u.init(Object.fromEntries(Object.entries(d.stores).map((([e,t])=>[e,e===d.store?f:t.getState()]))))),s.dispatchFromDevtools&&"function"==typeof s.dispatch){let e=!1;const t=s.dispatch;s.dispatch=(...n)=>{"__setState"!==n[0].type||e||(console.warn('[zustand devtools middleware] "__setState" action type is reserved to set state from the devtools. Avoid using it.'),e=!0),t(...n)}}return u.subscribe((e=>{var t;switch(e.type){case"ACTION":return"string"!=typeof e.payload?void console.error("[zustand devtools middleware] Unsupported action format"):M(e.payload,(e=>{if("__setState"!==e.type)s.dispatchFromDevtools&&"function"==typeof s.dispatch&&s.dispatch(e);else{if(void 0===o)return void p(e.state);1!==Object.keys(e.state).length&&console.error('\n                    [zustand devtools middleware] Unsupported __setState action format. \n                    When using \'store\' option in devtools(), the \'state\' should have only one key, which is a value of \'store\' that was passed in devtools(),\n                    and value of this only key should be a state object. Example: { "type": "__setState", "state": { "abc123Store": { "foo": "bar" } } }\n                    ');const t=e.state[o];if(null==t)return;JSON.stringify(s.getState())!==JSON.stringify(t)&&p(t)}}));case"DISPATCH":switch(e.payload.type){case"RESET":return p(f),void 0===o?null==u?void 0:u.init(s.getState()):null==u?void 0:u.init(j(l.name));case"COMMIT":return void 0===o?void(null==u||u.init(s.getState())):null==u?void 0:u.init(j(l.name));case"ROLLBACK":return M(e.state,(e=>{if(void 0===o)return p(e),void(null==u||u.init(s.getState()));p(e[o]),null==u||u.init(j(l.name))}));case"JUMP_TO_STATE":case"JUMP_TO_ACTION":return M(e.state,(e=>{void 0!==o?JSON.stringify(s.getState())!==JSON.stringify(e[o])&&p(e[o]):p(e)}));case"IMPORT_STATE":{const{nextLiftedState:n}=e.payload,r=null==(t=n.computedStates.slice(-1)[0])?void 0:t.state;if(!r)return;return p(void 0===o?r:r[o]),void(null==u||u.send(null,n))}case"PAUSE_RECORDING":return h=!h}return}})),f},M=(e,t)=>{let n;try{n=JSON.parse(e)}catch(e){console.error("[zustand devtools middleware] Could not parse the received json",e)}void 0!==n&&t(n)},D=e=>(t,n,r)=>{const s=r.subscribe;r.subscribe=(e,t,n)=>{let a=e;if(t){const s=(null==n?void 0:n.equalityFn)||Object.is;let i=e(r.getState());a=n=>{const r=e(n);if(!s(i,r)){const e=i;t(i=r,e)}},(null==n?void 0:n.fireImmediately)&&t(i,i)}return s(a)};return e(t,n,r)},U="INITIAL",F="THINKING",B="THINKING_END",q="THINKING_ERROR",z="THOUGHT",H="EXECUTING_ACTION",W="USING_TOOL",K="USING_TOOL_END",V="USING_TOOL_ERROR",G="TOOL_DOES_NOT_EXIST",Z="OBSERVATION",J="FINAL_ANSWER",X="TASK_COMPLETED",Y="MAX_ITERATIONS_ERROR",Q="ISSUES_PARSING_LLM_OUTPUT",ee="SELF_QUESTION",te="ITERATION_START",ne="ITERATION_END",re="AGENTIC_LOOP_ERROR",se="WEIRD_LLM_OUTPUT",ae="TODO",ie="DOING",oe="BLOCKED",le="REVISE",ce="DONE",ue="AWAITING_VALIDATION",de="VALIDATED",he="INITIAL",pe="RUNNING",fe="STOPPING",me="STOPPED",ge="ERRORED",ye="FINISHED",be="BLOCKED",we="PENDING",ve="PROCESSED";var _e={exports:{}};!function(e){!function(t,n){e.exports?e.exports=n():t.log=n()}(i,(function(){var e=function(){},t="undefined",n=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"],s={},a=null;function i(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function l(){for(var n=this.getLevel(),s=0;s<r.length;s++){var a=r[s];this[a]=s<n?e:this.methodFactory(a,n,this.name)}if(this.log=this.debug,typeof console===t&&n<this.levels.SILENT)return"No console available for logging"}function c(e){return function(){typeof console!==t&&(l.call(this),this[e].apply(this,arguments))}}function u(r,s,a){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&("trace"===r&&n?o:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):e)}(r)||c.apply(this,arguments)}function d(e,n){var i,o,c,d=this,h="loglevel";function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(e){}if(typeof e===t)try{var n=window.document.cookie,r=encodeURIComponent(h),s=n.indexOf(r+"=");-1!==s&&(e=/^([^;]+)/.exec(n.slice(s+r.length+1))[1])}catch(e){}return void 0===d.levels[e]&&(e=void 0),e}}function f(e){var t=e;if("string"==typeof t&&void 0!==d.levels[t.toUpperCase()]&&(t=d.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=d.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),d.name=e,d.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},d.methodFactory=n||u,d.getLevel=function(){return null!=c?c:null!=o?o:i},d.setLevel=function(e,n){return c=f(e),!1!==n&&function(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"="+n+";"}catch(e){}}}(c),l.call(d)},d.setDefaultLevel=function(e){o=f(e),p()||d.setLevel(e,!1)},d.resetLevel=function(){c=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),l.call(d)},d.enableAll=function(e){d.setLevel(d.levels.TRACE,e)},d.disableAll=function(e){d.setLevel(d.levels.SILENT,e)},d.rebuild=function(){if(a!==d&&(i=f(a.getLevel())),l.call(d),a===d)for(var e in s)s[e].rebuild()},i=f(a?a.getLevel():"WARN");var m=p();null!=m&&(c=f(m)),l.call(d)}(a=new d).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=s[e];return t||(t=s[e]=new d(e,a.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return a.noConflict=function(){return typeof window!==t&&window.log===a&&(window.log=h),a},a.getLoggers=function(){return s},a.default=a,a}))}(_e);var ke=o(_e.exports);ke.setLevel(ke.levels.INFO);const Ee=(e,t)=>({handleAgentIterationStart:({agent:n,task:r,iterations:s,maxAgentIterations:a})=>{n.status=te;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ Agent ${n.name} - ${te} (${s+1}/${a})`,metadata:{iterations:s,maxAgentIterations:a},logType:"AgentStatusUpdate",agentStatus:n.status});ke.trace(`ðŸ ${te}: Agent ${n.name} -  (${s+1}/${a})`),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentIterationEnd:({agent:n,task:r,iterations:s,maxAgentIterations:a})=>{n.status=ne;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ”„ Agent ${n.name} - ${ne}`,metadata:{iterations:s,maxAgentIterations:a},logType:"AgentStatusUpdate",agentStatus:n.status});ke.trace(`ðŸ”„ ${ne}: Agent ${n.name} ended another iteration.`),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentThinkingStart:({agent:n,task:r,messages:s})=>{n.status=F;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¤” Agent ${n.name} starts thinking...`,metadata:{messages:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ¤” ${F}: Agent ${n.name} starts thinking...`),ke.debug("System Message:",s[0]),ke.debug("Feedback Message:",s[s.length-1].content),ke.debug("All Messages",s),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentThinkingEnd:({agent:n,task:r,output:s})=>{n.status=B;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¤” Agent ${n.name} finished thinking.`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ’¡ ${B}: Agent ${n.name} finished thinking.`),ke.trace("Output:",s.parsedLLMOutput),ke.trace("Usage:",s.llmUsageStats),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentThinkingError:({agent:n,task:r,error:s})=>{const a=s.originalError||s;n.status=q;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ›‘ Agent ${n.name} encountered an error during ${F}.`,metadata:{error:a},logType:"AgentStatusUpdate",agentStatus:n.status});ke.error(`ðŸ›‘ ${q}: Agent ${n.name} encountered an error thinking. Further details: ${s.name?s.name:"No additional error details"}`,a.message),e((e=>({workflowLogs:[...e.workflowLogs,i]}))),t().handleTaskBlocked({task:r,error:s})},handleAgentIssuesParsingLLMOutput:({agent:n,task:r,output:s,error:a})=>{n.status=Q;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ˜¡ Agent ${n.name} found some ${Q}. ${a.message}`,metadata:{output:s,error:a},logType:"AgentStatusUpdate",agentStatus:n.status});ke.debug(`ðŸ˜¡ ${Q}: Agent ${n.name} found issues parsing the LLM output. ${a.message}`),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentActionStart:({agent:n,task:r,action:s,runId:a})=>{n.status=H;const i=t().prepareNewLog({agent:n,task:r,logDescription:`Agent action started: ${s}`,metadata:{action:s,runId:a},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`â–¶ï¸ EXECUTE_ACTION: Agent ${n.name} use tool ${s.tool} with the following input:  ${s.toolInput}`,s),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolStart:({agent:n,task:r,tool:s,input:a})=>{n.status=W;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ› ï¸â³ Agent ${n.name} is ${W} ${s.name}...`,metadata:{tool:s,input:a},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ› ï¸â³ ${W}: Agent ${n.name} is  using ${s.name}...`),ke.debug("Tool Input:",a),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolEnd:({agent:n,task:r,output:s,tool:a})=>{n.status=K;const i=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ› ï¸âœ… ${K}: Agent ${n.name} - got  results from tool:${a.name}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ› ï¸âœ… ${K}: Agent ${n.name} - got  results from tool:${a.name}`),ke.debug("Tool Output:",s),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolError:({agent:n,task:r,tool:s,error:a})=>{n.status=V;const i=t().prepareNewLog({agent:n,task:r,logDescription:"Error during tool use",metadata:{error:a},logType:"AgentStatusUpdate",agentStatus:n.status});ke.error(`ðŸ› ï¸ðŸ›‘ ${V}: Agent ${n.name} found an error using the tool: ${s.name}`),ke.error(a),e((e=>({workflowLogs:[...e.workflowLogs,i]})))},handleAgentToolDoesNotExist:({agent:n,task:r,toolName:s})=>{n.status=V;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ› ï¸ðŸš« Agent ${n.name} - Oops... it seems that the tool:${s} ${G}.`,metadata:{toolName:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.warn(`ðŸ› ï¸ðŸš« ${G}: Agent ${n.name} - is trying to use a tool that does not exist. Tool Name:${s}.`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentFinalAnswer:({agent:n,task:r,output:s})=>{n.status=J;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¥³ Agent ${n.name} got the ${J}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ¥³ ${J}: Agent ${n.name} arrived to the Final Answer.`),ke.debug(`${s.finalAnswer}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentThought:({agent:n,task:r,output:s})=>{n.status=z;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ’­ Agent ${n.name} ${z}.`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ’­ ${z}: Agent ${n.name} has a cool though.`),ke.info(`${s.thought}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentSelfQuestion:({agent:n,task:r,output:s})=>{n.status=ee;const a=t().prepareNewLog({agent:n,task:r,logDescription:`â“Agent ${n.name} have a ${ee}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`â“${ee}: Agent ${n.name} have a self question.`),ke.debug(s),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentObservation:({agent:n,task:r,output:s})=>{n.status=Z;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ” Agent ${n.name} - ${Z}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ” ${Z}: Agent ${n.name} made an observation.`),ke.debug(`${s.observation}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleWeirdOutput:({agent:n,task:r,output:s})=>{n.status=se;const a=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ¤” Agent ${n.name} - ${se}`,metadata:{output:s},logType:"AgentStatusUpdate",agentStatus:n.status});ke.warn(`ðŸ¤” ${se} - Agent: ${n.name}`),e((e=>({workflowLogs:[...e.workflowLogs,a]})))},handleAgentLoopError:({agent:n,task:r,error:s,iterations:a,maxAgentIterations:i})=>{n.status=re;const o=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸš¨ Agent ${n.name} - ${re} | Iterations: ${a}/${i}`,metadata:{error:s,iterations:a,maxAgentIterations:i},logType:"AgentStatusUpdate",agentStatus:n.status});ke.error(`ðŸš¨ ${re}  - Agent: ${n.name} | Iterations: ${a}/${i}`,s.message),e((e=>({workflowLogs:[...e.workflowLogs,o]}))),t().handleTaskBlocked({task:r,error:s})},handleAgentMaxIterationsError:({agent:n,task:r,error:s,iterations:a=-1,maxAgentIterations:i=-1})=>{n.status=Y;const o=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ›‘ Agent ${n.name} - ${Y} | Iterations: ${a}`,metadata:{error:s,iterations:a,maxAgentIterations:i},logType:"AgentStatusUpdate",agentStatus:n.status});ke.error(`ðŸ›‘ ${Y} - Agent ${n.name} | Iterations: ${a}/${i}. You can adjust the maxAgentIterations property in the agent initialization. Current value is ${i}`),e((e=>({workflowLogs:[...e.workflowLogs,o]}))),t().handleTaskBlocked({task:r,error:s})},handleAgentTaskCompleted:({agent:n,task:r,result:s,iterations:a,maxAgentIterations:i})=>{n.status=X;const o=t().prepareNewLog({agent:n,task:r,logDescription:`ðŸ Agent ${n.name} - ${X}`,metadata:{result:s,iterations:a,maxAgentIterations:i},logType:"AgentStatusUpdate",agentStatus:n.status});ke.info(`ðŸ ${X}: Agent ${n.name} finished the given task.`),e((e=>({workflowLogs:[...e.workflowLogs,o]}))),t().handleTaskCompleted({agent:n,task:r,result:s})}});function Oe(e){return e.title||(e.description?e.description.split(" ").slice(0,3).join(" ")+"...":"Untitled")}function Se(e,t){let n=e;for(const e in t){const r=`{${e}}`;n=n.replace(r,t[e])}return n}class Te extends Error{constructor(e,t=null,n=null,r={}){super(e),this.name="LLMInvocationError",this.context=r,this.originalError=t,this.recommendedAction=n,Error.captureStackTrace(this,this.constructor)}}class xe extends Error{constructor({message:e,rootError:t=null,recommendedAction:n=null,context:r={},location:s="",type:a="Error",name:i="PrettyError"}){super(e),this.type=a,this.name=i,this.rootError=t,this.recommendedAction=n,this.context=r,this.location=s,Error.captureStackTrace(this,this.constructor),this.prettyMessage=this.createPrettyMessage()}createPrettyMessage(){let e=`${this.name}: ${this.message}\n`;return this.rootError&&this.rootError.message&&(e+=`Details: ${this.rootError.message}\n\n`),this.recommendedAction&&(e+=`Recommended Action: ${this.recommendedAction}\n`),e}}const Ae=[{modelCode:"gpt-4o-mini",provider:"openai",inputPricePerMillionTokens:.15,outputPricePerMillionTokens:.6,features:"Most cost-efficient with vision capabilities"},{modelCode:"gpt-3.5-turbo",provider:"openai",inputPricePerMillionTokens:.5,outputPricePerMillionTokens:1.5,features:"Cost-effective option"},{modelCode:"gpt-3.5-turbo-0125",provider:"openai",inputPricePerMillionTokens:.5,outputPricePerMillionTokens:1.5,features:"Cost-effective option"},{modelCode:"gpt-4o",provider:"openai",inputPricePerMillionTokens:5,outputPricePerMillionTokens:15,features:"Enhanced multimodal capabilities"},{modelCode:"gpt-4-turbo",provider:"openai",inputPricePerMillionTokens:10,outputPricePerMillionTokens:30,features:"High speed and power"},{modelCode:"gpt-4",provider:"openai",inputPricePerMillionTokens:30,outputPricePerMillionTokens:60,features:"Latest generation AI"},{modelCode:"claude-3-5-sonnet-20240620",provider:"anthropic",inputPricePerMillionTokens:3,outputPricePerMillionTokens:15,features:"Highest level of intelligence and capability"},{modelCode:"claude-3-opus-20240229",provider:"anthropic",inputPricePerMillionTokens:15,outputPricePerMillionTokens:75,features:"Top-level performance, intelligence, fluency, and understanding"},{modelCode:"claude-3-sonnet-20240229",provider:"anthropic",inputPricePerMillionTokens:3,outputPricePerMillionTokens:15,features:"Strong utility, balanced for scaled deployments"},{modelCode:"claude-3-haiku-20240307",provider:"anthropic",inputPricePerMillionTokens:.25,outputPricePerMillionTokens:1.25,features:"Quick and accurate targeted performance"},{modelCode:"gemini-1.5-flash",provider:"google",inputPricePerMillionTokens:.35,outputPricePerMillionTokens:1.05,features:"Fast multimodal model with 1 million token context window"},{modelCode:"gemini-1.5-pro",provider:"google",inputPricePerMillionTokens:3.5,outputPricePerMillionTokens:10.5,features:"Next-generation model with 2 million token context window"},{modelCode:"gemini-1.0-pro",provider:"google",inputPricePerMillionTokens:.5,outputPricePerMillionTokens:1.5,features:"First-generation model, only text and image reasoning"},{modelCode:"open-mistral-nemo-2407",provider:"mistral",inputPricePerMillionTokens:.3,outputPricePerMillionTokens:.3,features:"Mistral Nemo is a state-of-the-art 12B model developed with NVIDIA"},{modelCode:"mistral-large-2407",provider:"mistral",inputPricePerMillionTokens:3,outputPricePerMillionTokens:9,features:"Top-tier reasoning for high-complexity tasks, for your most sophisticated needs"},{modelCode:"codestral-2405",provider:"mistral",inputPricePerMillionTokens:1,outputPricePerMillionTokens:3,features:"State-of-the-art Mistral model trained specifically for code tasks"}];function Ie(e,t){const n=Ae.find((t=>t.modelCode===e));if(!n)return{costInputTokens:-1,costOutputTokens:-1,totalCost:-1};const r=t.inputTokens/1e6*n.inputPricePerMillionTokens,s=t.outputTokens/1e6*n.outputPricePerMillionTokens,a=r+s;return{costInputTokens:parseFloat(r.toFixed(4)),costOutputTokens:parseFloat(s.toFixed(4)),totalCost:parseFloat(a.toFixed(4))}}const Pe=(e,t)=>({tasksInitialized:!1,getTaskStats(e){const n=Date.now(),r=t().workflowLogs.slice().reverse().find((t=>t.task&&t.task.id===e.id&&"TaskStatusUpdate"===t.logType&&t.taskStatus===ie)),s=r?r.timestamp:n,a=(n-s)/1e3;let i={inputTokens:0,outputTokens:0,callsCount:0,callsErrorCount:0,parsingErrors:0},o=0;return t().workflowLogs.forEach((t=>{t.task&&t.task.id===e.id&&t.timestamp>=s&&"AgentStatusUpdate"===t.logType&&(t.agentStatus===B&&(i.inputTokens+=t.metadata.output.llmUsageStats.inputTokens,i.outputTokens+=t.metadata.output.llmUsageStats.outputTokens,i.callsCount+=1),t.agentStatus===q&&(i.callsErrorCount+=1),t.agentStatus===Q&&(i.parsingErrors+=1),t.agentStatus===ne&&(o+=1))})),{startTime:s,endTime:n,duration:a,llmUsageStats:i,iterationCount:o}},handleTaskCompleted:({agent:n,task:r,result:s})=>{const a=t().getTaskStats(r,t);r.result=s;const i=(r.feedbackHistory||[]).map((e=>e.status===we?{...e,status:ve}:e));if(r.externalValidationRequired&&r.status!==de){r.status=ue;const o=Ie(n.llmConfig.model,a.llmUsageStats),l=t().prepareNewLog({agent:n,task:r,logDescription:`Task awaiting validation: ${Oe(r)}. Awaiting validation.`,metadata:{...a,costDetails:o,result:s},logType:"TaskStatusUpdate"});e((e=>({tasks:e.tasks.map((e=>e.id===r.id?{...e,...a,status:ue,result:s,feedbackHistory:i}:e)),workflowLogs:[...e.workflowLogs,l]}))),t().handleWorkflowBlocked({task:r,error:new Error("Task awaiting validation")})}else{r.status=ce;const o=Ie(n.llmConfig.model,a.llmUsageStats),l=t().prepareNewLog({agent:n,task:r,logDescription:`Task completed: ${Oe(r)}.`,metadata:{...a,costDetails:o,result:s},logType:"TaskStatusUpdate"});ke.debug(`Task completed with ID ${r.id}, Duration: ${a.duration} seconds`),e((e=>({...e,workflowLogs:[...e.workflowLogs,l],tasks:e.tasks.map((e=>e.id===r.id?{...e,...a,status:ce,result:s,feedbackHistory:i}:e))})));const c=t().tasks.every((e=>e.status===ce));c&&t().finishWorkflowAction()}},handleTaskError:({task:n,error:r})=>{const s=t().getTaskStats(n,t);n.status=oe;const a=Ie(n.agent.llmConfig.model,s.llmUsageStats),i=n.feedbackHistory.map((e=>e.status===we?{...e,status:ve}:e)),o=t().prepareNewLog({agent:n.agent,task:n,logDescription:`Task error: ${Oe(n)}, Error: ${r.message}`,metadata:{...s,costDetails:a,error:r.message},logType:"TaskStatusUpdate"});e((e=>({tasks:e.tasks.map((e=>e.id===n.id?{...e,...s,status:oe,error:r.message,feedbackHistory:i}:e)),workflowLogs:[...e.workflowLogs,o]})));const l=new xe({message:"Task Error Encountered",recommendedAction:"Try to debug the application to find the root cause of the error.",rootError:r,context:{task:n,error:r},location:"taskStore.js -> handleTaskError()"});ke.error(l.prettyMessage)},handleTaskBlocked:({task:n,error:r})=>{const s=t().getTaskStats(n,t);n.status=oe;const a=Ie(n.agent.llmConfig.model,s.llmUsageStats),i=n.feedbackHistory.map((e=>e.status===we?{...e,status:ve}:e)),o=t().prepareNewLog({agent:n.agent,task:n,logDescription:`Task blocked: ${Oe(n)}, Reason: ${r.message}`,metadata:{...s,costDetails:a,error:r},logType:"TaskStatusUpdate"}),l=new xe({name:"TASK BLOCKED",message:"Task blocked due to a possible error during execution.",recommendedAction:'Enable logLevel: "debug" during team initialization to obtain more detailed logs and facilitate troubleshooting.',rootError:r,context:{task:n,error:r}});ke.warn(l.prettyMessage),ke.debug(l.context),e((e=>({tasks:e.tasks.map((e=>e.id===n.id?{...e,...s,status:oe,feedbackHistory:i}:e)),workflowLogs:[...e.workflowLogs,o]}))),t().handleWorkflowBlocked({task:n,error:r})}});var Ce={exports:{}},Re=Ce.exports;Object.defineProperty(Re,"__esModule",{value:!0});const{round:Ne,floor:$e,max:je}=Math,Le=e=>{let[,t]=/([a-f\d]{3,6})/i.exec(e)||[],n=t?t.length:0;if(3===n)t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2];else if(6!==n)return[0,0,0];let r=parseInt(t,16);return[r>>16&255,r>>8&255,255&r]},Me=(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Ne((e-8)/247*24)+232:16+36*Ne(e/51)+6*Ne(t/51)+Ne(n/51),De=e=>{let t,n,r,s,a,i;return e<8?30+e:e<16?e-8+90:(e>=232?t=n=r=(10*(e-232)+8)/255:(i=(e-=16)%36,t=$e(e/36)/5,n=$e(i/6)/5,r=i%6/5),s=2*je(t,n,r),0===s?30:(a=30+(Ne(r)<<2|Ne(n)<<1|Ne(t)),2===s?a+60:a))},Ue=(e,t,n)=>De(Me(e,t,n)),Fe=(()=>{const e=e=>!!o.find((t=>e.test(t))),t=globalThis,n=t.Deno,r=null!=n,s=t.process||n||{},a=s.stdout,i="win32"===(r?n.build.os:s.platform),o=s.argv||s.args||[];let l=s.env||{},c=-1;if(r)try{l=l.toObject()}catch(e){c=0}const u="FORCE_COLOR",d=l[u],h=parseInt(d),p="false"===d?0:isNaN(h)?3:h,f="NO_COLOR"in l||0===p||e(/^-{1,2}(no-color|color=(false|never))$/),m=u in l&&p||e(/^-{1,2}color=?(true|always)?$/),g=(l.NEXT_RUNTIME||"").indexOf("edge")>-1||"PM2_HOME"in l&&"pm_id"in l||(r?n.isatty(1):a&&"isTTY"in a);return f?0:(c<0&&(c=((e,t,n)=>{const{TERM:r,COLORTERM:s}=e;return"TF_BUILD"in e?1:"TEAMCITY_VERSION"in e?2:"CI"in e?["GITHUB_ACTIONS","GITEA_ACTIONS"].some((t=>t in e))?3:1:!t||/-mono|dumb/i.test(r)?0:n||"truecolor"===s||"24bit"===s||"xterm-kitty"===r?3:/-256(colou?r)?$/i.test(r)?2:/^screen|^tmux|^xterm|^vt[1-5][0-9]([0-9])?|^ansi|color|cygwin|linux|mintty|rxvt/i.test(r)?1:3})(l,g,i)),m&&0===c?3:c)})(),Be=Fe>0,qe={open:"",close:""},ze=Be?(e,t)=>({open:`[${e}m`,close:`[${t}m`}):()=>qe,He=39,We=49,Ke=e=>(t,n,r)=>e(Me(t,n,r)),Ve=e=>t=>{let[n,r,s]=Le(t);return e(n,r,s)};let Ge=e=>ze(`38;5;${e}`,He),Ze=e=>ze(`48;5;${e}`,We),Je=(e,t,n)=>ze(`38;2;${e};${t};${n}`,He),Xe=(e,t,n)=>ze(`48;2;${e};${t};${n}`,We);1===Fe?(Ge=e=>ze(De(e),He),Ze=e=>ze(De(e)+10,We),Je=(e,t,n)=>ze(Ue(e,t,n),He),Xe=(e,t,n)=>ze(Ue(e,t,n)+10,We)):2===Fe&&(Je=Ke(Ge),Xe=Ke(Ze));let Ye,Qe,et={ansi256:Ge,bgAnsi256:Ze,fg:Ge,bg:Ze,rgb:Je,bgRgb:Xe,hex:Ve(Je),bgHex:Ve(Xe),visible:qe,reset:ze(0,0),inverse:ze(7,27),hidden:ze(8,28),bold:ze(1,22),dim:ze(2,22),italic:ze(3,23),underline:ze(4,24),strikethrough:ze(9,29),strike:ze(9,29),grey:ze(90,He),gray:ze(90,He),bgGrey:ze(100,We),bgGray:ze(100,We)},tt=["black","red","green","yellow","blue","magenta","cyan","white"],nt="Bright",rt=30;for(Ye of tt)Qe="bg"+Ye[0].toUpperCase()+Ye.slice(1),et[Ye]=ze(rt,He),et[Ye+nt]=ze(rt+60,He),et[Qe]=ze(rt+10,We),et[Qe+nt]=ze(rt+70,We),rt++;const{defineProperty:st,defineProperties:at,setPrototypeOf:it}=Object,ot=/[Â›][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g,lt=/(\r?\n)/g,ct={},ut=({_p:e},{open:t,close:n})=>{const r=(e,...t)=>{if(!e)return"";let n=r._p,{_a:s,_b:a}=n,i=null!=e.raw?String.raw(e,...t):""+e;if(i.includes(""))for(;null!=n;){let e=n.close,t=e.length;if(t){let r,s=0,a="";for(;~(r=i.indexOf(e,s));)a+=i.slice(s,r)+n.open,s=r+t;s&&(i=a+i.slice(s))}n=n._p}return i.includes("\n")&&(i=i.replace(lt,a+"$1"+s)),s+i+a};let s=t,a=n;return null!=e&&(s=e._a+t,a=n+e._b),it(r,ht),r._p={open:t,close:n,_a:s,_b:a,_p:e},r.open=s,r.close=a,r},dt=function(){const e=e=>""+e;return e.isSupported=()=>Be,e.strip=e=>e.replace(ot,""),e.extend=t=>{for(let e in t){let n=t[e],r=typeof n,s="string"===r?Je(...Le(n)):n;ct[e]="function"===r?{get(){return(...e)=>ut(this,n(...e))}}:{get(){let t=ut(this,s);return st(this,e,{value:t}),t}}}ht=at({},ct),it(e,ht)},e.extend(et),e};let ht;const pt=new dt;Ce.exports=pt,Ce.exports.Ansis=dt;var ft=o(Ce.exports);function mt({status:e,message:t}){ke.info(`[Workflow Status: ${e}] ${t}`)}const gt=e=>{e.subscribe((e=>e.workflowLogs),((e,t)=>{if(e.length>t.length){const t=e[e.length-1];if("WorkflowStatusUpdate"===t.logType)switch(t.workflowStatus){case he:mt({status:"Initial",message:"Workflow is being initialized."});break;case pe:mt({status:"Running",message:"Workflow is actively processing tasks."});break;case fe:mt({status:"Stopping",message:"Workflow is stopping."});break;case me:mt({status:"Stopped",message:"Workflow has been stopped."});break;case ge:mt({status:"Errored",message:"Workflow encountered an error."});break;case ye:mt({status:"Finished",message:"Workflow has successfully completed all tasks."}),function({metadata:e}){const{result:t,duration:n,llmUsageStats:r,iterationCount:s,costDetails:a,teamName:i,taskCount:o,agentCount:l}=e;ke.info(`Workflow Result: ${t}`);const c=[ft.black("\n+-----------------------------------------+"),ft.bold(`| WORKFLOW - ${ft.green("FINISH")}                       |`),"|-----------------------------------------|",ft.bold("| Summary:"),"|",ft.black("| Team: ")+ft.cyan(i),ft.black("| Tasks: ")+ft.cyan(o),ft.black("| Agents: ")+ft.cyan(l),"|",ft.black("| Iterations: ")+ft.yellow(s),ft.black("| Duration: ")+ft.yellow(n)+ft.yellow(" seconds"),ft.black("| Input Tokens: ")+ft.yellow(r.inputTokens),ft.black("| Output Tokens: ")+ft.yellow(r.outputTokens),"|",ft.black("| Cost Input Tokens: ")+ft.cyan(`$${a.costInputTokens}`),ft.black("| Cost Output Tokens: ")+ft.cyan(`$${a.costOutputTokens}`),ft.black("| Total Cost: ")+ft.cyan(`$${a.totalCost}`),"|",ft.black("| Calls Count: ")+ft.red(r.callsCount),ft.black("| Calls Error Count: ")+ft.red(r.callsErrorCount),ft.black("| Parsing Errors: ")+ft.red(r.parsingErrors),ft.black("+-----------------------------------------+\n")].join("\n");ke.info(c)}({...t});break;case be:mt({status:"Blocked",message:"Workflow is blocked due to one or more blocked tasks."});break;default:console.warn(`Encountered an unexpected workflow status: ${t.workflowStatus}`)}}}))},yt=e=>{e.subscribe((e=>e.workflowLogs),((t,n)=>{if(t.length>n.length){const n=t[t.length-1];if("TaskStatusUpdate"===n.logType){const t=e.getState().tasks.length,r=e.getState().tasks.findIndex((e=>e.id===n.task.id)),s=r+1;switch(n.task.status){case ce:!function({iterationCount:e,duration:t,llmUsageStats:n,agentName:r,agentModel:s,taskTitle:a,currentTaskNumber:i,totalTasks:o,costDetails:l}){const c=[ft.black("\n+-----------------------------------------+"),ft.bold(`| Task (${i}/${o}) - status changed to ${ft.green("DONE")}     |`),"|-----------------------------------------|",ft.bold("| Summary:"),"|",ft.black("| Task: ")+ft.cyan(a),ft.black("| Agent: ")+ft.cyan(r),ft.black("| Model: ")+ft.cyan(s),"|",ft.black("| Iterations: ")+ft.cyan(e),ft.black("| Duration: ")+ft.cyan(t)+ft.cyan(" seconds"),ft.black("| Input Tokens: ")+ft.yellow(n.inputTokens),ft.black("| Output Tokens: ")+ft.yellow(n.outputTokens),"|",ft.black("| Cost Input Tokens: ")+ft.cyan(`$${l.costInputTokens}`),ft.black("| Cost Output Tokens: ")+ft.cyan(`$${l.costOutputTokens}`),ft.black("| Total Cost: ")+ft.cyan(`$${l.totalCost}`),"|",ft.black("| Calls Count: ")+ft.green(n.callsCount),ft.black("| Calls Error Count: ")+ft.green(n.callsErrorCount),ft.black("| Parsing Errors: ")+ft.green(n.parsingErrors),ft.black("+-----------------------------------------+\n\n")].join("\n");ke.info(c)}({task:n.task,llmUsageStats:n.metadata.llmUsageStats,iterationCount:n.metadata.iterationCount,duration:n.metadata.duration,agentName:n.agent.name,agentModel:n.agent.llmConfig.model,taskTitle:Oe(n.task),currentTaskNumber:s,costDetails:n.metadata.costDetails,totalTasks:t});break;case ie:case oe:case le:case ue:case de:case ae:!function({currentTaskNumber:e,totalTasks:t,taskTitle:n,taskStatus:r,agentName:s}){ke.info(ft.bold.black("||===========================================||")),ke.info(ft.bold.black(`|| Task (${e}/${t}) - status changed to ${"DONE"===r?ft.green(r):ft.yellow(r)}`)),ke.info(ft.bold.black(`|| Title: ${n}`)),ke.info(ft.bold.black(`|| Agent: ${s}`)),ke.info(ft.bold.black("||===========================================||\n\n"))}({currentTaskNumber:s,totalTasks:t,taskTitle:Oe(n.task),taskStatus:n.task.status,agentName:n.agent.name});break;default:console.warn(`Encountered an unexpected task status: ${n.task.status}`)}}}}))};var bt={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,i){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||i(this,a);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[a]=1===c.length?c[0]:c:i(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(bt);var wt=o(bt.exports);let vt=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},_t=class extends Error{constructor(e){super(),this.name="AbortError",this.message=e}};const kt=e=>void 0===globalThis.DOMException?new _t(e):new DOMException(e),Et=e=>{const t=void 0===e.reason?kt("This operation was aborted."):e.reason;return t instanceof Error?t:kt(t)};let Ot=class{#e=[];enqueue(e,t){const n={priority:(t={priority:0,...t}).priority,run:e};if(this.size&&this.#e[this.size-1].priority>=t.priority)return void this.#e.push(n);const r=function(e,t,n){let r=0,s=e.length;for(;s>0;){const a=Math.trunc(s/2);let i=r+a;n(e[i],t)<=0?(r=++i,s-=a+1):s=a}return r}(this.#e,n,((e,t)=>t.priority-e.priority));this.#e.splice(r,0,n)}dequeue(){const e=this.#e.shift();return e?.run}filter(e){return this.#e.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this.#e.length}},St=class extends wt{#t;#n;#r=0;#s;#a;#i=0;#o;#l;#e;#c;#u=0;#d;#h;#p;timeout;constructor(e){if(super(),!("number"==typeof(e={carryoverConcurrencyCount:!1,intervalCap:Number.POSITIVE_INFINITY,interval:0,concurrency:Number.POSITIVE_INFINITY,autoStart:!0,queueClass:Ot,...e}).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${e.intervalCap?.toString()??""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${e.interval?.toString()??""}\` (${typeof e.interval})`);this.#t=e.carryoverConcurrencyCount,this.#n=e.intervalCap===Number.POSITIVE_INFINITY||0===e.interval,this.#s=e.intervalCap,this.#a=e.interval,this.#e=new e.queueClass,this.#c=e.queueClass,this.concurrency=e.concurrency,this.timeout=e.timeout,this.#p=!0===e.throwOnTimeout,this.#h=!1===e.autoStart}get#f(){return this.#n||this.#r<this.#s}get#m(){return this.#u<this.#d}#g(){this.#u--,this.#y(),this.emit("next")}#b(){this.#w(),this.#v(),this.#l=void 0}get#_(){const e=Date.now();if(void 0===this.#o){const t=this.#i-e;if(!(t<0))return void 0===this.#l&&(this.#l=setTimeout((()=>{this.#b()}),t)),!0;this.#r=this.#t?this.#u:0}return!1}#y(){if(0===this.#e.size)return this.#o&&clearInterval(this.#o),this.#o=void 0,this.emit("empty"),0===this.#u&&this.emit("idle"),!1;if(!this.#h){const e=!this.#_;if(this.#f&&this.#m){const t=this.#e.dequeue();return!!t&&(this.emit("active"),t(),e&&this.#v(),!0)}}return!1}#v(){this.#n||void 0!==this.#o||(this.#o=setInterval((()=>{this.#w()}),this.#a),this.#i=Date.now()+this.#a)}#w(){0===this.#r&&0===this.#u&&this.#o&&(clearInterval(this.#o),this.#o=void 0),this.#r=this.#t?this.#u:0,this.#k()}#k(){for(;this.#y(););}get concurrency(){return this.#d}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this.#d=e,this.#k()}async#E(e){return new Promise(((t,n)=>{e.addEventListener("abort",(()=>{n(e.reason)}),{once:!0})}))}async add(e,t={}){return t={timeout:this.timeout,throwOnTimeout:this.#p,...t},new Promise(((n,r)=>{this.#e.enqueue((async()=>{this.#u++,this.#r++;try{t.signal?.throwIfAborted();let r=e({signal:t.signal});t.timeout&&(r=function(e,t){const{milliseconds:n,fallback:r,message:s,customTimers:a={setTimeout:setTimeout,clearTimeout:clearTimeout}}=t;let i;const o=new Promise(((o,l)=>{if("number"!=typeof n||1!==Math.sign(n))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${n}\``);if(t.signal){const{signal:n}=t;n.aborted&&l(Et(n));const r=()=>{l(Et(n))};n.addEventListener("abort",r,{once:!0}),e.finally((()=>{n.removeEventListener("abort",r)}))}if(n===Number.POSITIVE_INFINITY)return void e.then(o,l);const c=new vt;i=a.setTimeout.call(void 0,(()=>{if(r)try{o(r())}catch(e){l(e)}else"function"==typeof e.cancel&&e.cancel(),!1===s?o():s instanceof Error?l(s):(c.message=s??`Promise timed out after ${n} milliseconds`,l(c))}),n),(async()=>{try{o(await e)}catch(e){l(e)}})()})),l=o.finally((()=>{l.clear()}));return l.clear=()=>{a.clearTimeout.call(void 0,i),i=void 0},l}(Promise.resolve(r),{milliseconds:t.timeout})),t.signal&&(r=Promise.race([r,this.#E(t.signal)]));const s=await r;n(s),this.emit("completed",s)}catch(e){if(e instanceof vt&&!t.throwOnTimeout)return void n();r(e),this.emit("error",e)}finally{this.#g()}}),t),this.emit("add"),this.#y()}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this.#h?(this.#h=!1,this.#k(),this):this}pause(){this.#h=!0}clear(){this.#e=new this.#c}async onEmpty(){0!==this.#e.size&&await this.#O("empty")}async onSizeLessThan(e){this.#e.size<e||await this.#O("next",(()=>this.#e.size<e))}async onIdle(){0===this.#u&&0===this.#e.size||await this.#O("idle")}async#O(e,t){return new Promise((n=>{const r=()=>{t&&!t()||(this.off(e,r),n())};this.on(e,r)}))}get size(){return this.#e.size}sizeBy(e){return this.#e.filter(e).length}get pending(){return this.#u}get isPaused(){return this.#h}};const Tt=e=>{const t=new St({concurrency:1});e.subscribe((e=>e.tasks.filter((e=>e.status===ie))),((n,r)=>{n.forEach((n=>{r.find((e=>e.id===n.id))||t.add((()=>e.getState().workOnTask(n.agent,n))).catch((t=>{e.getState().handleTaskError({task:n,error:t}),e.getState().handleWorkflowError(n,t)}))}))}));e.subscribe((e=>e.tasks.filter((e=>e.status===le))),((t,n)=>{const r=e.getState().tasks;t.forEach((t=>{if(!n.find((e=>e.id===t.id))){const n=r.findIndex((e=>e.id===t.id));s=t.agent,r.some((e=>e.agent.id===s.id&&e.status===ie))||e.getState().updateTaskStatus(t.id,ie);for(let t=n+1;t<r.length;t++)e.getState().updateTaskStatus(r[t].id,ae)}var s}))})),e.subscribe((e=>e.tasks.filter((e=>"DONE"===e.status))),((t,n)=>{if(t.length>n.length){const t=e.getState().tasks.find((e=>e.status===ae));t&&e.getState().updateTaskStatus(t.id,ie)}}))};class xt{#S=[];async push(e){e=await e,this.#S.push(e)}clear(){this.#S=[]}values(){return this.#S}}class At{appID="";clientUser="";salt="";target="https://nom.telemetrydeck.com/v2/";testMode=!1;constructor(e={}){const{target:t,appID:n,clientUser:r,sessionID:s,salt:a,testMode:i,store:o,subtleCrypto:l}=e;if(!n)throw new Error("appID is required");this.store=o??new xt,this.target=t??this.target,this.appID=n,this.clientUser=r,this.sessionID=s??(0|9e6*Math.random()).toString(36),this.salt=a??this.salt,this.testMode=i??this.testMode,this.subtleCrypto=l}async signal(e,t,n){const r=await this._build(e,t,n);return this._post([r])}async queue(e,t,n){const r=(new Date).toISOString(),s=this._build(e,t,n,r);return this.store.push(s)}async flush(){const e=this._post(this.store.values());return this.store.clear(),e}_clientUserAndSalt="";_clientUserHashed="";async _hashedClientUser(e,t){return e+t!==this._clientUserAndSalt&&(this._clientUserHashed=await async function(e,t=globalThis?.crypto?.subtle){const n=(new TextEncoder).encode(e),r=await t.digest("SHA-256",n),s=[...new Uint8Array(r)].map((e=>e.toString(16).padStart(2,"0"))).join("");return s}([e,t].join(""),this.subtleCrypto),this._clientUserAndSalt=e+t),this._clientUserHashed}async _build(e,t,n,r){const{appID:s,testMode:a}=this;let{clientUser:i,salt:o,sessionID:l}=this;if(i=(n=n??{}).clientUser??i,o=n.salt??o,l=n.sessionID??l,!e)throw new Error('TelemetryDeck: "type" is not set');if(!s)throw new Error('TelemetryDeck: "appID" is not set');if(!i)throw new Error('TelemetryDeck: "clientUser" is not set');i=await this._hashedClientUser(i,o);const c={clientUser:i,sessionID:l,appID:s,type:e,telemetryClientVersion:"JavaScriptSDK 2.0.4"};return r&&(c.receivedAt=r),a&&(c.isTestMode=!0),this._appendPayload(c,t)}_appendPayload(e,t){if(!t||"object"!=typeof t||0===Object.keys(t).length)return e;e.payload={};for(const[n,r]of Object.entries(t??{}))"floatValue"===n?e.payload[n]=Number.parseFloat(r):r instanceof Date?e.payload[n]=r.toISOString():e.payload[n]="string"==typeof r?r:"object"==typeof r?JSON.stringify(r):`${r}`;return e}_post(e){const{target:t}=this;return fetch(t,{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}}let It=null;const Pt=t.v4(),Ct={signal:()=>{}};function Rt(){if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)return window.crypto.subtle;if("undefined"!=typeof global&&global.crypto&&global.crypto.subtle)return global.crypto.subtle;try{const e=require("crypto");if(e.webcrypto&&e.webcrypto.subtle)return e.webcrypto.subtle}catch{}return console.warn("SubtleCrypto is not available. TelemetryDeck might not function correctly."),null}const Nt=function(e="15E9347E-9EE5-4971-A8FB-61D91F3EBA12",t=Pt){return("undefined"!=typeof process&&process.env?process.env.KAIBAN_TELEMETRY_OPT_OUT:"undefined"!=typeof window&&window.KAIBAN_TELEMETRY_OPT_OUT)?It=Ct:It||(It=new At({appID:e,clientUser:t,subtleCrypto:Rt()})),It}(),$t=(e={})=>{var t;e.logLevel&&(t=e.logLevel,ke.setLevel(ke.levels[t.toUpperCase()]));const n=(r=L(D(((t,r)=>({...Ee(t,r),...Pe(t,r),teamWorkflowStatus:e.teamWorkflowStatus||he,workflowResult:e.workflowResult||null,name:e.name||"",agents:e.agents||[],tasks:e.tasks||[],workflowLogs:e.workflowLogs||[],inputs:e.inputs||{},workflowContext:e.workflowContext||"",env:e.env||{},logLevel:e.logLevel,setInputs:e=>t({inputs:e}),setName:e=>t({name:e}),setEnv:e=>t({env:e}),addAgents:e=>{const{env:s}=r();e.forEach((e=>{e.initialize(n,s)})),t((t=>({agents:[...t.agents,...e]})))},addTasks:e=>{e.forEach((e=>e.setStore(n))),t((t=>({tasks:[...t.tasks,...e.map((e=>({...e,agent:e.agent})))]})))},updateTaskStatus:(e,n)=>t((t=>({tasks:t.tasks.map((t=>t.id===e?{...t,status:n}:t))}))),startWorkflow:async e=>{ke.info(`ðŸš€ Team *${r().name}* is starting to work.`),Nt.signal("workflow_started"),r().resetWorkflowStateAction(),e&&r().setInputs(e);const n={task:null,agent:null,timestamp:Date.now(),logDescription:`Workflow initiated for team *${r().name}*.`,workflowStatus:pe,metadata:{message:"Workflow has been initialized with input settings.",inputs:e},logType:"WorkflowStatusUpdate"};t((e=>({...e,workflowLogs:[...e.workflowLogs,n],teamWorkflowStatus:pe})));const s=r().tasks;s.length>0&&s[0].status===ae&&r().updateTaskStatus(s[0].id,ie)},resetWorkflowStateAction:()=>{t((e=>{const t=e.tasks.map((e=>({...e,status:"TODO"})));r().agents.forEach((e=>{e.setStatus("INITIAL")}));const n=[...e.agents];return{...e,tasks:t,agents:n,workflowLogs:[],workflowContext:"",workflowResult:null,teamWorkflowStatus:he}})),ke.debug("Workflow state has been reset.")},finishWorkflowAction:()=>{const e=r().getWorkflowStats(),n=r().tasks,s=n.slice().reverse().find((e=>e.isDeliverable)),a=n[n.length-1].result;ke.debug("Workflow Result:",s?s.result:a);const i={task:null,agent:null,timestamp:Date.now(),logDescription:`Workflow finished with result: ${s?s.result:a}`,workflowStatus:ye,metadata:{result:s?s.result:a,...e},logType:"WorkflowStatusUpdate"};t((e=>({...e,workflowResult:s?s.result:a,teamWorkflowStatus:ye,workflowLogs:[...e.workflowLogs,i]})))},setTeamWorkflowStatus:e=>t({teamWorkflowStatus:e}),handleWorkflowError:(e,n)=>{ke.error("Workflow Error:",n.message);const s=r().getWorkflowStats(),a={task:e,agent:e.agent,timestamp:Date.now(),logDescription:`Workflow error encountered: ${n.message}`,workflowStatus:ge,metadata:{error:n,...s},logType:"WorkflowStatusUpdate"};t((e=>({...e,teamWorkflowStatus:ge,workflowLogs:[...e.workflowLogs,a]})))},handleWorkflowBlocked:({task:e,error:n})=>{ke.warn("WORKFLOW BLOCKED:",n.message);const s=r().getWorkflowStats(),a={task:e,agent:e.agent,timestamp:Date.now(),logDescription:`Workflow blocked: ${n.message}`,workflowStatus:be,metadata:{error:n.message,...s,teamName:r().name,taskCount:r().tasks.length,agentCount:r().agents.length},logType:"WorkflowStatusUpdate"};t((e=>({...e,teamWorkflowStatus:be,workflowLogs:[...e.workflowLogs,a]})))},workOnTask:async(e,n)=>{if(n&&e){ke.debug(`Task: ${Oe(n)} starting...`),n.status=ie,t((t=>{const s=r().prepareNewLog({agent:e,task:n,logDescription:`Task: ${Oe(n)} started.`,metadata:{},logType:"TaskStatusUpdate"});return{...t,workflowLogs:[...t.workflowLogs,s]}})),n.inputs=r().inputs;const s=Se(n.description,r().inputs);n.interpolatedTaskDescription=s;const a=n.feedbackHistory.filter((e=>e.status===we)),i=r().deriveContextFromLogs(r().workflowLogs,n.id);a.length>0?await e.workOnFeedback(n,n.feedbackHistory,i):await e.workOnTask(n,r().inputs,i)}},deriveContextFromLogs:(e,t)=>{const n=new Map,s=r().tasks,a=s.findIndex((e=>e.id===t));if(-1===a)return console.warn(`Current task with ID ${t} not found in the task list.`),"";for(const t of e)if("TaskStatusUpdate"===t.logType&&t.taskStatus===ce){const e=s.findIndex((e=>e.id===t.task.id));-1!==e&&e<a&&n.set(t.task.id,{taskDescription:t.task.description,result:t.metadata.result,index:e})}return Array.from(n.values()).sort(((e,t)=>e.index-t.index)).map((({taskDescription:e,result:t})=>`Task: ${e}\nResult: ${t}\n`)).join("\n")},provideFeedback:async(e,n)=>{const{tasks:s}=r(),a=s.findIndex((t=>t.id===e));if(-1===a)return void ke.error("Task not found");const i=s[a],o={content:n,status:we,timestamp:Date.now()},l={task:i,agent:i.agent,timestamp:Date.now(),logDescription:"Workflow running again due to feedback on task.",workflowStatus:pe,metadata:{feedback:o},logType:"WorkflowStatusUpdate"},c={...i,feedbackHistory:[...i.feedbackHistory||[],o],status:le},u=r().prepareNewLog({agent:c.agent,task:c,logDescription:`Task with feedback: ${Oe(c)}.`,metadata:{feedback:o},logType:"TaskStatusUpdate"});t((t=>({...t,teamWorkflowStatus:pe,workflowLogs:[...t.workflowLogs,l,u],tasks:t.tasks.map((t=>t.id===e?c:t))})))},validateTask:async e=>{const n=r().tasks.find((t=>t.id===e));if(!n)return ke.error("Task not found"),null;if(n.status!==ue)return ke.error("Task is not awaiting validation"),null;const s={...n,status:de},a={task:s,agent:s.agent,timestamp:Date.now(),logDescription:"Workflow running cause a task was validated.",workflowStatus:pe,metadata:{},logType:"WorkflowStatusUpdate"},i=r().prepareNewLog({agent:s.agent,task:s,metadata:{},logDescription:`Task validated: ${Oe(s)}.`,logType:"TaskStatusUpdate"});t((t=>({...t,tasks:t.tasks.map((t=>t.id===e?s:t)),workflowLogs:[...t.workflowLogs,a,i],teamWorkflowStatus:pe}))),r().handleTaskCompleted({agent:s.agent,task:s,result:s.result})},prepareNewLog:({agent:e,task:t,logDescription:n,metadata:r,logType:s})=>({timestamp:Date.now(),task:t,agent:e,agentName:e?e.name:"Unknown Agent",taskTitle:t?Oe(t):"Untitled Task",logDescription:n,taskStatus:t?t.status:"Unknown",agentStatus:e?e.status:"Unknown",metadata:r,logType:s}),clearAll:()=>t({agents:[],tasks:[],inputs:{},workflowLogs:[],workflowContext:"",workflowResult:null,teamWorkflowStatus:he}),getWorkflowStats(){const e=Date.now(),t=r().workflowLogs,n=t.slice().reverse().find((e=>"WorkflowStatusUpdate"===e.logType&&"RUNNING"===e.workflowStatus)),s=n?n.timestamp:Date.now(),a=(e-s)/1e3;let i={},o={inputTokens:0,outputTokens:0,callsCount:0,callsErrorCount:0,parsingErrors:0},l=0;t.forEach((e=>{if("AgentStatusUpdate"===e.logType&&e.timestamp>=s)if(e.agentStatus===B){const t=e.agent.llmConfig.model;i[t]||(i[t]={inputTokens:0,outputTokens:0,callsCount:0}),i[t].inputTokens+=e.metadata.output.llmUsageStats.inputTokens,i[t].outputTokens+=e.metadata.output.llmUsageStats.outputTokens,i[t].callsCount+=1,o.inputTokens+=e.metadata.output.llmUsageStats.inputTokens,o.outputTokens+=e.metadata.output.llmUsageStats.outputTokens,o.callsCount+=1}else e.agentStatus===q?o.callsErrorCount+=1:e.agentStatus===Q?o.parsingErrors+=1:e.agentStatus===ne&&(l+=1)}));const c=function(e){let t=0,n=0,r=0,s=!0;return Object.keys(e).forEach((a=>{const i=e[a],o=Ae.find((e=>e.modelCode===a));if(!o)return ke.warn(`No pricing information found for model ${a}`),void(s=!1);const l=i.inputTokens/1e6*o.inputPricePerMillionTokens,c=i.outputTokens/1e6*o.outputPricePerMillionTokens;t+=l,n+=c,r+=l+c})),s?{costInputTokens:parseFloat(t.toFixed(4)),costOutputTokens:parseFloat(n.toFixed(4)),totalCost:parseFloat(r.toFixed(4))}:{costInputTokens:-1,costOutputTokens:-1,totalCost:-1}}(i);return{startTime:s,endTime:e,duration:a,llmUsageStats:o,iterationCount:l,costDetails:c,taskCount:r().tasks.length,agentCount:r().agents.length,teamName:r().name}},getCleanedState(){const e=e=>({...e,id:"[REDACTED]",env:"[REDACTED]",llmConfig:e.llmConfig?{...e.llmConfig,apiKey:"[REDACTED]"}:{},agentInstance:e.agentInstance?{...e.agentInstance,id:"[REDACTED]",env:"[REDACTED]",llmConfig:e.agentInstance.llmConfig?{...e.agentInstance.llmConfig,apiKey:"[REDACTED]"}:{}}:{}}),t=t=>({...t,id:"[REDACTED]",agent:t.agent?e(t.agent):null,duration:"[REDACTED]",endTime:"[REDACTED]",startTime:"[REDACTED]",feedbackHistory:t.feedbackHistory?t.feedbackHistory.map((e=>({...e,timestamp:"[REDACTED]"}))):[]}),n=r().agents.map((t=>e(t))),s=r().tasks.map((e=>t(e))),a=r().workflowLogs.map((n=>{return{...n,agent:n.agent?e(n.agent):null,task:n.task?t(n.task):null,timestamp:"[REDACTED]",metadata:n.metadata?(r=n.metadata,{...r,duration:"[REDACTED]",endTime:"[REDACTED]",startTime:"[REDACTED]",feedback:r.feedback?{...r.feedback,timestamp:"[REDACTED]"}:{}}):{}};var r}));return{teamWorkflowStatus:r().teamWorkflowStatus,workflowResult:r().workflowResult,name:r().name,agents:n,tasks:s,workflowLogs:a,inputs:r().inputs,workflowContext:r().workflowContext,logLevel:r().logLevel}}})))),r?N(r):N);var r;return Tt(n),yt(n),gt(n),n},jt=Symbol("Let zodToJsonSchema decide on which parser to use"),Lt={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},Mt=e=>{const t=(e=>({...Lt,...e}))(e),n=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:n,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map((([e,n])=>[n._def,{def:n._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}])))}};function Dt(e,t,n,r){r?.errorMessages&&n&&(e.errorMessage={...e.errorMessage,[t]:n})}function Ut(e,t,n,r,s){e[t]=n,Dt(e,t,r,s)}var Ft,Bt;!function(e){e.assertEqual=e=>e,e.assertIs=function(e){},e.assertNever=function(e){throw new Error},e.arrayToEnum=e=>{const t={};for(const n of e)t[n]=n;return t},e.getValidEnumValues=t=>{const n=e.objectKeys(t).filter((e=>"number"!=typeof t[t[e]])),r={};for(const e of n)r[e]=t[e];return e.objectValues(r)},e.objectValues=t=>e.objectKeys(t).map((function(e){return t[e]})),e.objectKeys="function"==typeof Object.keys?e=>Object.keys(e):e=>{const t=[];for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},e.find=(e,t)=>{for(const n of e)if(t(n))return n},e.isInteger="function"==typeof Number.isInteger?e=>Number.isInteger(e):e=>"number"==typeof e&&isFinite(e)&&Math.floor(e)===e,e.joinValues=function(e,t=" | "){return e.map((e=>"string"==typeof e?`'${e}'`:e)).join(t)},e.jsonStringifyReplacer=(e,t)=>"bigint"==typeof t?t.toString():t}(Ft||(Ft={})),function(e){e.mergeShapes=(e,t)=>({...e,...t})}(Bt||(Bt={}));const qt=Ft.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),zt=e=>{switch(typeof e){case"undefined":return qt.undefined;case"string":return qt.string;case"number":return isNaN(e)?qt.nan:qt.number;case"boolean":return qt.boolean;case"function":return qt.function;case"bigint":return qt.bigint;case"symbol":return qt.symbol;case"object":return Array.isArray(e)?qt.array:null===e?qt.null:e.then&&"function"==typeof e.then&&e.catch&&"function"==typeof e.catch?qt.promise:"undefined"!=typeof Map&&e instanceof Map?qt.map:"undefined"!=typeof Set&&e instanceof Set?qt.set:"undefined"!=typeof Date&&e instanceof Date?qt.date:qt.object;default:return qt.unknown}},Ht=Ft.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);class Wt extends Error{constructor(e){super(),this.issues=[],this.addIssue=e=>{this.issues=[...this.issues,e]},this.addIssues=(e=[])=>{this.issues=[...this.issues,...e]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(e){return e.message},n={_errors:[]},r=e=>{for(const s of e.issues)if("invalid_union"===s.code)s.unionErrors.map(r);else if("invalid_return_type"===s.code)r(s.returnTypeError);else if("invalid_arguments"===s.code)r(s.argumentsError);else if(0===s.path.length)n._errors.push(t(s));else{let e=n,r=0;for(;r<s.path.length;){const n=s.path[r];r===s.path.length-1?(e[n]=e[n]||{_errors:[]},e[n]._errors.push(t(s))):e[n]=e[n]||{_errors:[]},e=e[n],r++}}};return r(this),n}static assert(e){if(!(e instanceof Wt))throw new Error(`Not a ZodError: ${e}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,Ft.jsonStringifyReplacer,2)}get isEmpty(){return 0===this.issues.length}flatten(e=e=>e.message){const t={},n=[];for(const r of this.issues)r.path.length>0?(t[r.path[0]]=t[r.path[0]]||[],t[r.path[0]].push(e(r))):n.push(e(r));return{formErrors:n,fieldErrors:t}}get formErrors(){return this.flatten()}}Wt.create=e=>new Wt(e);const Kt=(e,t)=>{let n;switch(e.code){case Ht.invalid_type:n=e.received===qt.undefined?"Required":`Expected ${e.expected}, received ${e.received}`;break;case Ht.invalid_literal:n=`Invalid literal value, expected ${JSON.stringify(e.expected,Ft.jsonStringifyReplacer)}`;break;case Ht.unrecognized_keys:n=`Unrecognized key(s) in object: ${Ft.joinValues(e.keys,", ")}`;break;case Ht.invalid_union:n="Invalid input";break;case Ht.invalid_union_discriminator:n=`Invalid discriminator value. Expected ${Ft.joinValues(e.options)}`;break;case Ht.invalid_enum_value:n=`Invalid enum value. Expected ${Ft.joinValues(e.options)}, received '${e.received}'`;break;case Ht.invalid_arguments:n="Invalid function arguments";break;case Ht.invalid_return_type:n="Invalid function return type";break;case Ht.invalid_date:n="Invalid date";break;case Ht.invalid_string:"object"==typeof e.validation?"includes"in e.validation?(n=`Invalid input: must include "${e.validation.includes}"`,"number"==typeof e.validation.position&&(n=`${n} at one or more positions greater than or equal to ${e.validation.position}`)):"startsWith"in e.validation?n=`Invalid input: must start with "${e.validation.startsWith}"`:"endsWith"in e.validation?n=`Invalid input: must end with "${e.validation.endsWith}"`:Ft.assertNever(e.validation):n="regex"!==e.validation?`Invalid ${e.validation}`:"Invalid";break;case Ht.too_small:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at least":"more than"} ${e.minimum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at least":"over"} ${e.minimum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${e.minimum}`:"date"===e.type?`Date must be ${e.exact?"exactly equal to ":e.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(e.minimum))}`:"Invalid input";break;case Ht.too_big:n="array"===e.type?`Array must contain ${e.exact?"exactly":e.inclusive?"at most":"less than"} ${e.maximum} element(s)`:"string"===e.type?`String must contain ${e.exact?"exactly":e.inclusive?"at most":"under"} ${e.maximum} character(s)`:"number"===e.type?`Number must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"bigint"===e.type?`BigInt must be ${e.exact?"exactly":e.inclusive?"less than or equal to":"less than"} ${e.maximum}`:"date"===e.type?`Date must be ${e.exact?"exactly":e.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(e.maximum))}`:"Invalid input";break;case Ht.custom:n="Invalid input";break;case Ht.invalid_intersection_types:n="Intersection results could not be merged";break;case Ht.not_multiple_of:n=`Number must be a multiple of ${e.multipleOf}`;break;case Ht.not_finite:n="Number must be finite";break;default:n=t.defaultError,Ft.assertNever(e)}return{message:n}};let Vt=Kt;function Gt(){return Vt}const Zt=e=>{const{data:t,path:n,errorMaps:r,issueData:s}=e,a=[...n,...s.path||[]],i={...s,path:a};if(void 0!==s.message)return{...s,path:a,message:s.message};let o="";const l=r.filter((e=>!!e)).slice().reverse();for(const e of l)o=e(i,{data:t,defaultError:o}).message;return{...s,path:a,message:o}};function Jt(e,t){const n=Gt(),r=Zt({issueData:t,data:e.data,path:e.path,errorMaps:[e.common.contextualErrorMap,e.schemaErrorMap,n,n===Kt?void 0:Kt].filter((e=>!!e))});e.common.issues.push(r)}class Xt{constructor(){this.value="valid"}dirty(){"valid"===this.value&&(this.value="dirty")}abort(){"aborted"!==this.value&&(this.value="aborted")}static mergeArray(e,t){const n=[];for(const r of t){if("aborted"===r.status)return Yt;"dirty"===r.status&&e.dirty(),n.push(r.value)}return{status:e.value,value:n}}static async mergeObjectAsync(e,t){const n=[];for(const e of t){const t=await e.key,r=await e.value;n.push({key:t,value:r})}return Xt.mergeObjectSync(e,n)}static mergeObjectSync(e,t){const n={};for(const r of t){const{key:t,value:s}=r;if("aborted"===t.status)return Yt;if("aborted"===s.status)return Yt;"dirty"===t.status&&e.dirty(),"dirty"===s.status&&e.dirty(),"__proto__"===t.value||void 0===s.value&&!r.alwaysSet||(n[t.value]=s.value)}return{status:e.value,value:n}}}const Yt=Object.freeze({status:"aborted"}),Qt=e=>({status:"dirty",value:e}),en=e=>({status:"valid",value:e}),tn=e=>"aborted"===e.status,nn=e=>"dirty"===e.status,rn=e=>"valid"===e.status,sn=e=>"undefined"!=typeof Promise&&e instanceof Promise;function an(e,t,n,r){if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t.get(e)}function on(e,t,n,r,s){if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return t.set(e,n),n}var ln,cn,un;"function"==typeof SuppressedError&&SuppressedError,function(e){e.errToObj=e=>"string"==typeof e?{message:e}:e||{},e.toString=e=>"string"==typeof e?e:null==e?void 0:e.message}(ln||(ln={}));class dn{constructor(e,t,n,r){this._cachedPath=[],this.parent=e,this.data=t,this._path=n,this._key=r}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const hn=(e,t)=>{if(rn(t))return{success:!0,data:t.value};if(!e.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const t=new Wt(e.common.issues);return this._error=t,this._error}}};function pn(e){if(!e)return{};const{errorMap:t,invalid_type_error:n,required_error:r,description:s}=e;if(t&&(n||r))throw new Error('Can\'t use "invalid_type_error" or "required_error" in conjunction with custom error map.');if(t)return{errorMap:t,description:s};return{errorMap:(t,s)=>{var a,i;const{message:o}=e;return"invalid_enum_value"===t.code?{message:null!=o?o:s.defaultError}:void 0===s.data?{message:null!==(a=null!=o?o:r)&&void 0!==a?a:s.defaultError}:"invalid_type"!==t.code?{message:s.defaultError}:{message:null!==(i=null!=o?o:n)&&void 0!==i?i:s.defaultError}},description:s}}class fn{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return zt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:zt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new Xt,ctx:{common:e.parent.common,data:e.data,parsedType:zt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){const t=this._parse(e);if(sn(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){const t=this._parse(e);return Promise.resolve(t)}parse(e,t){const n=this.safeParse(e,t);if(n.success)return n.data;throw n.error}safeParse(e,t){var n;const r={common:{issues:[],async:null!==(n=null==t?void 0:t.async)&&void 0!==n&&n,contextualErrorMap:null==t?void 0:t.errorMap},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:zt(e)},s=this._parseSync({data:e,path:r.path,parent:r});return hn(r,s)}async parseAsync(e,t){const n=await this.safeParseAsync(e,t);if(n.success)return n.data;throw n.error}async safeParseAsync(e,t){const n={common:{issues:[],contextualErrorMap:null==t?void 0:t.errorMap,async:!0},path:(null==t?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:zt(e)},r=this._parse({data:e,path:n.path,parent:n}),s=await(sn(r)?r:Promise.resolve(r));return hn(n,s)}refine(e,t){const n=e=>"string"==typeof t||void 0===t?{message:t}:"function"==typeof t?t(e):t;return this._refinement(((t,r)=>{const s=e(t),a=()=>r.addIssue({code:Ht.custom,...n(t)});return"undefined"!=typeof Promise&&s instanceof Promise?s.then((e=>!!e||(a(),!1))):!!s||(a(),!1)}))}refinement(e,t){return this._refinement(((n,r)=>!!e(n)||(r.addIssue("function"==typeof t?t(n,r):t),!1)))}_refinement(e){return new cr({schema:this,typeName:_r.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return ur.create(this,this._def)}nullable(){return dr.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return Hn.create(this,this._def)}promise(){return lr.create(this,this._def)}or(e){return Vn.create([this,e],this._def)}and(e){return Xn.create(this,e,this._def)}transform(e){return new cr({...pn(this._def),schema:this,typeName:_r.ZodEffects,effect:{type:"transform",transform:e}})}default(e){const t="function"==typeof e?e:()=>e;return new hr({...pn(this._def),innerType:this,defaultValue:t,typeName:_r.ZodDefault})}brand(){return new gr({typeName:_r.ZodBranded,type:this,...pn(this._def)})}catch(e){const t="function"==typeof e?e:()=>e;return new pr({...pn(this._def),innerType:this,catchValue:t,typeName:_r.ZodCatch})}describe(e){return new(0,this.constructor)({...this._def,description:e})}pipe(e){return yr.create(this,e)}readonly(){return br.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}const mn=/^c[^\s-]{8,}$/i,gn=/^[0-9a-z]+$/,yn=/^[0-9A-HJKMNP-TV-Z]{26}$/,bn=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,wn=/^[a-z0-9_-]{21}$/i,vn=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,_n=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let kn;const En=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,On=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Sn=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,Tn="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",xn=new RegExp(`^${Tn}$`);function An(e){let t="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return e.precision?t=`${t}\\.\\d{${e.precision}}`:null==e.precision&&(t=`${t}(\\.\\d+)?`),t}function In(e){let t=`${Tn}T${An(e)}`;const n=[];return n.push(e.local?"Z?":"Z"),e.offset&&n.push("([+-]\\d{2}:?\\d{2})"),t=`${t}(${n.join("|")})`,new RegExp(`^${t}$`)}function Pn(e,t){return!("v4"!==t&&t||!En.test(e))||!("v6"!==t&&t||!On.test(e))}class Cn extends fn{_parse(e){this._def.coerce&&(e.data=String(e.data));if(this._getType(e)!==qt.string){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.string,received:t.parsedType}),Yt}const t=new Xt;let n;for(const r of this._def.checks)if("min"===r.kind)e.data.length<r.value&&(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("max"===r.kind)e.data.length>r.value&&(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!1,message:r.message}),t.dirty());else if("length"===r.kind){const s=e.data.length>r.value,a=e.data.length<r.value;(s||a)&&(n=this._getOrReturnCtx(e,n),s?Jt(n,{code:Ht.too_big,maximum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}):a&&Jt(n,{code:Ht.too_small,minimum:r.value,type:"string",inclusive:!0,exact:!0,message:r.message}),t.dirty())}else if("email"===r.kind)_n.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"email",code:Ht.invalid_string,message:r.message}),t.dirty());else if("emoji"===r.kind)kn||(kn=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),kn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"emoji",code:Ht.invalid_string,message:r.message}),t.dirty());else if("uuid"===r.kind)bn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"uuid",code:Ht.invalid_string,message:r.message}),t.dirty());else if("nanoid"===r.kind)wn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"nanoid",code:Ht.invalid_string,message:r.message}),t.dirty());else if("cuid"===r.kind)mn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"cuid",code:Ht.invalid_string,message:r.message}),t.dirty());else if("cuid2"===r.kind)gn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"cuid2",code:Ht.invalid_string,message:r.message}),t.dirty());else if("ulid"===r.kind)yn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"ulid",code:Ht.invalid_string,message:r.message}),t.dirty());else if("url"===r.kind)try{new URL(e.data)}catch(s){n=this._getOrReturnCtx(e,n),Jt(n,{validation:"url",code:Ht.invalid_string,message:r.message}),t.dirty()}else if("regex"===r.kind){r.regex.lastIndex=0;r.regex.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"regex",code:Ht.invalid_string,message:r.message}),t.dirty())}else if("trim"===r.kind)e.data=e.data.trim();else if("includes"===r.kind)e.data.includes(r.value,r.position)||(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.invalid_string,validation:{includes:r.value,position:r.position},message:r.message}),t.dirty());else if("toLowerCase"===r.kind)e.data=e.data.toLowerCase();else if("toUpperCase"===r.kind)e.data=e.data.toUpperCase();else if("startsWith"===r.kind)e.data.startsWith(r.value)||(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.invalid_string,validation:{startsWith:r.value},message:r.message}),t.dirty());else if("endsWith"===r.kind)e.data.endsWith(r.value)||(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.invalid_string,validation:{endsWith:r.value},message:r.message}),t.dirty());else if("datetime"===r.kind){In(r).test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.invalid_string,validation:"datetime",message:r.message}),t.dirty())}else if("date"===r.kind){xn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.invalid_string,validation:"date",message:r.message}),t.dirty())}else if("time"===r.kind){new RegExp(`^${An(r)}$`).test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.invalid_string,validation:"time",message:r.message}),t.dirty())}else"duration"===r.kind?vn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"duration",code:Ht.invalid_string,message:r.message}),t.dirty()):"ip"===r.kind?Pn(e.data,r.version)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"ip",code:Ht.invalid_string,message:r.message}),t.dirty()):"base64"===r.kind?Sn.test(e.data)||(n=this._getOrReturnCtx(e,n),Jt(n,{validation:"base64",code:Ht.invalid_string,message:r.message}),t.dirty()):Ft.assertNever(r);return{status:t.value,value:e.data}}_regex(e,t,n){return this.refinement((t=>e.test(t)),{validation:t,code:Ht.invalid_string,...ln.errToObj(n)})}_addCheck(e){return new Cn({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...ln.errToObj(e)})}url(e){return this._addCheck({kind:"url",...ln.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...ln.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...ln.errToObj(e)})}nanoid(e){return this._addCheck({kind:"nanoid",...ln.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...ln.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...ln.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...ln.errToObj(e)})}base64(e){return this._addCheck({kind:"base64",...ln.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...ln.errToObj(e)})}datetime(e){var t,n;return"string"==typeof e?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:e}):this._addCheck({kind:"datetime",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,offset:null!==(t=null==e?void 0:e.offset)&&void 0!==t&&t,local:null!==(n=null==e?void 0:e.local)&&void 0!==n&&n,...ln.errToObj(null==e?void 0:e.message)})}date(e){return this._addCheck({kind:"date",message:e})}time(e){return"string"==typeof e?this._addCheck({kind:"time",precision:null,message:e}):this._addCheck({kind:"time",precision:void 0===(null==e?void 0:e.precision)?null:null==e?void 0:e.precision,...ln.errToObj(null==e?void 0:e.message)})}duration(e){return this._addCheck({kind:"duration",...ln.errToObj(e)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...ln.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:null==t?void 0:t.position,...ln.errToObj(null==t?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...ln.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...ln.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...ln.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...ln.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...ln.errToObj(t)})}nonempty(e){return this.min(1,ln.errToObj(e))}trim(){return new Cn({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new Cn({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new Cn({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find((e=>"datetime"===e.kind))}get isDate(){return!!this._def.checks.find((e=>"date"===e.kind))}get isTime(){return!!this._def.checks.find((e=>"time"===e.kind))}get isDuration(){return!!this._def.checks.find((e=>"duration"===e.kind))}get isEmail(){return!!this._def.checks.find((e=>"email"===e.kind))}get isURL(){return!!this._def.checks.find((e=>"url"===e.kind))}get isEmoji(){return!!this._def.checks.find((e=>"emoji"===e.kind))}get isUUID(){return!!this._def.checks.find((e=>"uuid"===e.kind))}get isNANOID(){return!!this._def.checks.find((e=>"nanoid"===e.kind))}get isCUID(){return!!this._def.checks.find((e=>"cuid"===e.kind))}get isCUID2(){return!!this._def.checks.find((e=>"cuid2"===e.kind))}get isULID(){return!!this._def.checks.find((e=>"ulid"===e.kind))}get isIP(){return!!this._def.checks.find((e=>"ip"===e.kind))}get isBase64(){return!!this._def.checks.find((e=>"base64"===e.kind))}get minLength(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}function Rn(e,t){const n=(e.toString().split(".")[1]||"").length,r=(t.toString().split(".")[1]||"").length,s=n>r?n:r;return parseInt(e.toFixed(s).replace(".",""))%parseInt(t.toFixed(s).replace(".",""))/Math.pow(10,s)}Cn.create=e=>{var t;return new Cn({checks:[],typeName:_r.ZodString,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...pn(e)})};class Nn extends fn{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){this._def.coerce&&(e.data=Number(e.data));if(this._getType(e)!==qt.number){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.number,received:t.parsedType}),Yt}let t;const n=new Xt;for(const r of this._def.checks)if("int"===r.kind)Ft.isInteger(e.data)||(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.invalid_type,expected:"integer",received:"float",message:r.message}),n.dirty());else if("min"===r.kind){(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.too_small,minimum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty())}else if("max"===r.kind){(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.too_big,maximum:r.value,type:"number",inclusive:r.inclusive,exact:!1,message:r.message}),n.dirty())}else"multipleOf"===r.kind?0!==Rn(e.data,r.value)&&(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):"finite"===r.kind?Number.isFinite(e.data)||(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.not_finite,message:r.message}),n.dirty()):Ft.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,ln.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ln.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ln.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ln.toString(t))}setLimit(e,t,n,r){return new Nn({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:ln.toString(r)}]})}_addCheck(e){return new Nn({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:ln.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:ln.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:ln.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:ln.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:ln.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ln.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:ln.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:ln.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:ln.toString(e)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find((e=>"int"===e.kind||"multipleOf"===e.kind&&Ft.isInteger(e.value)))}get isFinite(){let e=null,t=null;for(const n of this._def.checks){if("finite"===n.kind||"int"===n.kind||"multipleOf"===n.kind)return!0;"min"===n.kind?(null===t||n.value>t)&&(t=n.value):"max"===n.kind&&(null===e||n.value<e)&&(e=n.value)}return Number.isFinite(t)&&Number.isFinite(e)}}Nn.create=e=>new Nn({checks:[],typeName:_r.ZodNumber,coerce:(null==e?void 0:e.coerce)||!1,...pn(e)});class $n extends fn{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){this._def.coerce&&(e.data=BigInt(e.data));if(this._getType(e)!==qt.bigint){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.bigint,received:t.parsedType}),Yt}let t;const n=new Xt;for(const r of this._def.checks)if("min"===r.kind){(r.inclusive?e.data<r.value:e.data<=r.value)&&(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.too_small,type:"bigint",minimum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty())}else if("max"===r.kind){(r.inclusive?e.data>r.value:e.data>=r.value)&&(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.too_big,type:"bigint",maximum:r.value,inclusive:r.inclusive,message:r.message}),n.dirty())}else"multipleOf"===r.kind?e.data%r.value!==BigInt(0)&&(t=this._getOrReturnCtx(e,t),Jt(t,{code:Ht.not_multiple_of,multipleOf:r.value,message:r.message}),n.dirty()):Ft.assertNever(r);return{status:n.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,ln.toString(t))}gt(e,t){return this.setLimit("min",e,!1,ln.toString(t))}lte(e,t){return this.setLimit("max",e,!0,ln.toString(t))}lt(e,t){return this.setLimit("max",e,!1,ln.toString(t))}setLimit(e,t,n,r){return new $n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:n,message:ln.toString(r)}]})}_addCheck(e){return new $n({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:ln.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:ln.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:ln.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:ln.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:ln.toString(t)})}get minValue(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return e}}$n.create=e=>{var t;return new $n({checks:[],typeName:_r.ZodBigInt,coerce:null!==(t=null==e?void 0:e.coerce)&&void 0!==t&&t,...pn(e)})};class jn extends fn{_parse(e){this._def.coerce&&(e.data=Boolean(e.data));if(this._getType(e)!==qt.boolean){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.boolean,received:t.parsedType}),Yt}return en(e.data)}}jn.create=e=>new jn({typeName:_r.ZodBoolean,coerce:(null==e?void 0:e.coerce)||!1,...pn(e)});class Ln extends fn{_parse(e){this._def.coerce&&(e.data=new Date(e.data));if(this._getType(e)!==qt.date){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.date,received:t.parsedType}),Yt}if(isNaN(e.data.getTime())){return Jt(this._getOrReturnCtx(e),{code:Ht.invalid_date}),Yt}const t=new Xt;let n;for(const r of this._def.checks)"min"===r.kind?e.data.getTime()<r.value&&(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.too_small,message:r.message,inclusive:!0,exact:!1,minimum:r.value,type:"date"}),t.dirty()):"max"===r.kind?e.data.getTime()>r.value&&(n=this._getOrReturnCtx(e,n),Jt(n,{code:Ht.too_big,message:r.message,inclusive:!0,exact:!1,maximum:r.value,type:"date"}),t.dirty()):Ft.assertNever(r);return{status:t.value,value:new Date(e.data.getTime())}}_addCheck(e){return new Ln({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:ln.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:ln.toString(t)})}get minDate(){let e=null;for(const t of this._def.checks)"min"===t.kind&&(null===e||t.value>e)&&(e=t.value);return null!=e?new Date(e):null}get maxDate(){let e=null;for(const t of this._def.checks)"max"===t.kind&&(null===e||t.value<e)&&(e=t.value);return null!=e?new Date(e):null}}Ln.create=e=>new Ln({checks:[],coerce:(null==e?void 0:e.coerce)||!1,typeName:_r.ZodDate,...pn(e)});class Mn extends fn{_parse(e){if(this._getType(e)!==qt.symbol){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.symbol,received:t.parsedType}),Yt}return en(e.data)}}Mn.create=e=>new Mn({typeName:_r.ZodSymbol,...pn(e)});class Dn extends fn{_parse(e){if(this._getType(e)!==qt.undefined){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.undefined,received:t.parsedType}),Yt}return en(e.data)}}Dn.create=e=>new Dn({typeName:_r.ZodUndefined,...pn(e)});class Un extends fn{_parse(e){if(this._getType(e)!==qt.null){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.null,received:t.parsedType}),Yt}return en(e.data)}}Un.create=e=>new Un({typeName:_r.ZodNull,...pn(e)});class Fn extends fn{constructor(){super(...arguments),this._any=!0}_parse(e){return en(e.data)}}Fn.create=e=>new Fn({typeName:_r.ZodAny,...pn(e)});class Bn extends fn{constructor(){super(...arguments),this._unknown=!0}_parse(e){return en(e.data)}}Bn.create=e=>new Bn({typeName:_r.ZodUnknown,...pn(e)});class qn extends fn{_parse(e){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.never,received:t.parsedType}),Yt}}qn.create=e=>new qn({typeName:_r.ZodNever,...pn(e)});class zn extends fn{_parse(e){if(this._getType(e)!==qt.undefined){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.void,received:t.parsedType}),Yt}return en(e.data)}}zn.create=e=>new zn({typeName:_r.ZodVoid,...pn(e)});class Hn extends fn{_parse(e){const{ctx:t,status:n}=this._processInputParams(e),r=this._def;if(t.parsedType!==qt.array)return Jt(t,{code:Ht.invalid_type,expected:qt.array,received:t.parsedType}),Yt;if(null!==r.exactLength){const e=t.data.length>r.exactLength.value,s=t.data.length<r.exactLength.value;(e||s)&&(Jt(t,{code:e?Ht.too_big:Ht.too_small,minimum:s?r.exactLength.value:void 0,maximum:e?r.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:r.exactLength.message}),n.dirty())}if(null!==r.minLength&&t.data.length<r.minLength.value&&(Jt(t,{code:Ht.too_small,minimum:r.minLength.value,type:"array",inclusive:!0,exact:!1,message:r.minLength.message}),n.dirty()),null!==r.maxLength&&t.data.length>r.maxLength.value&&(Jt(t,{code:Ht.too_big,maximum:r.maxLength.value,type:"array",inclusive:!0,exact:!1,message:r.maxLength.message}),n.dirty()),t.common.async)return Promise.all([...t.data].map(((e,n)=>r.type._parseAsync(new dn(t,e,t.path,n))))).then((e=>Xt.mergeArray(n,e)));const s=[...t.data].map(((e,n)=>r.type._parseSync(new dn(t,e,t.path,n))));return Xt.mergeArray(n,s)}get element(){return this._def.type}min(e,t){return new Hn({...this._def,minLength:{value:e,message:ln.toString(t)}})}max(e,t){return new Hn({...this._def,maxLength:{value:e,message:ln.toString(t)}})}length(e,t){return new Hn({...this._def,exactLength:{value:e,message:ln.toString(t)}})}nonempty(e){return this.min(1,e)}}function Wn(e){if(e instanceof Kn){const t={};for(const n in e.shape){const r=e.shape[n];t[n]=ur.create(Wn(r))}return new Kn({...e._def,shape:()=>t})}return e instanceof Hn?new Hn({...e._def,type:Wn(e.element)}):e instanceof ur?ur.create(Wn(e.unwrap())):e instanceof dr?dr.create(Wn(e.unwrap())):e instanceof Yn?Yn.create(e.items.map((e=>Wn(e)))):e}Hn.create=(e,t)=>new Hn({type:e,minLength:null,maxLength:null,exactLength:null,typeName:_r.ZodArray,...pn(t)});class Kn extends fn{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(null!==this._cached)return this._cached;const e=this._def.shape(),t=Ft.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==qt.object){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.object,received:t.parsedType}),Yt}const{status:t,ctx:n}=this._processInputParams(e),{shape:r,keys:s}=this._getCached(),a=[];if(!(this._def.catchall instanceof qn&&"strip"===this._def.unknownKeys))for(const e in n.data)s.includes(e)||a.push(e);const i=[];for(const e of s){const t=r[e],s=n.data[e];i.push({key:{status:"valid",value:e},value:t._parse(new dn(n,s,n.path,e)),alwaysSet:e in n.data})}if(this._def.catchall instanceof qn){const e=this._def.unknownKeys;if("passthrough"===e)for(const e of a)i.push({key:{status:"valid",value:e},value:{status:"valid",value:n.data[e]}});else if("strict"===e)a.length>0&&(Jt(n,{code:Ht.unrecognized_keys,keys:a}),t.dirty());else if("strip"!==e)throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const e=this._def.catchall;for(const t of a){const r=n.data[t];i.push({key:{status:"valid",value:t},value:e._parse(new dn(n,r,n.path,t)),alwaysSet:t in n.data})}}return n.common.async?Promise.resolve().then((async()=>{const e=[];for(const t of i){const n=await t.key,r=await t.value;e.push({key:n,value:r,alwaysSet:t.alwaysSet})}return e})).then((e=>Xt.mergeObjectSync(t,e))):Xt.mergeObjectSync(t,i)}get shape(){return this._def.shape()}strict(e){return ln.errToObj,new Kn({...this._def,unknownKeys:"strict",...void 0!==e?{errorMap:(t,n)=>{var r,s,a,i;const o=null!==(a=null===(s=(r=this._def).errorMap)||void 0===s?void 0:s.call(r,t,n).message)&&void 0!==a?a:n.defaultError;return"unrecognized_keys"===t.code?{message:null!==(i=ln.errToObj(e).message)&&void 0!==i?i:o}:{message:o}}}:{}})}strip(){return new Kn({...this._def,unknownKeys:"strip"})}passthrough(){return new Kn({...this._def,unknownKeys:"passthrough"})}extend(e){return new Kn({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new Kn({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:_r.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new Kn({...this._def,catchall:e})}pick(e){const t={};return Ft.objectKeys(e).forEach((n=>{e[n]&&this.shape[n]&&(t[n]=this.shape[n])})),new Kn({...this._def,shape:()=>t})}omit(e){const t={};return Ft.objectKeys(this.shape).forEach((n=>{e[n]||(t[n]=this.shape[n])})),new Kn({...this._def,shape:()=>t})}deepPartial(){return Wn(this)}partial(e){const t={};return Ft.objectKeys(this.shape).forEach((n=>{const r=this.shape[n];e&&!e[n]?t[n]=r:t[n]=r.optional()})),new Kn({...this._def,shape:()=>t})}required(e){const t={};return Ft.objectKeys(this.shape).forEach((n=>{if(e&&!e[n])t[n]=this.shape[n];else{let e=this.shape[n];for(;e instanceof ur;)e=e._def.innerType;t[n]=e}})),new Kn({...this._def,shape:()=>t})}keyof(){return ar(Ft.objectKeys(this.shape))}}Kn.create=(e,t)=>new Kn({shape:()=>e,unknownKeys:"strip",catchall:qn.create(),typeName:_r.ZodObject,...pn(t)}),Kn.strictCreate=(e,t)=>new Kn({shape:()=>e,unknownKeys:"strict",catchall:qn.create(),typeName:_r.ZodObject,...pn(t)}),Kn.lazycreate=(e,t)=>new Kn({shape:e,unknownKeys:"strip",catchall:qn.create(),typeName:_r.ZodObject,...pn(t)});class Vn extends fn{_parse(e){const{ctx:t}=this._processInputParams(e),n=this._def.options;if(t.common.async)return Promise.all(n.map((async e=>{const n={...t,common:{...t.common,issues:[]},parent:null};return{result:await e._parseAsync({data:t.data,path:t.path,parent:n}),ctx:n}}))).then((function(e){for(const t of e)if("valid"===t.result.status)return t.result;for(const n of e)if("dirty"===n.result.status)return t.common.issues.push(...n.ctx.common.issues),n.result;const n=e.map((e=>new Wt(e.ctx.common.issues)));return Jt(t,{code:Ht.invalid_union,unionErrors:n}),Yt}));{let e;const r=[];for(const s of n){const n={...t,common:{...t.common,issues:[]},parent:null},a=s._parseSync({data:t.data,path:t.path,parent:n});if("valid"===a.status)return a;"dirty"!==a.status||e||(e={result:a,ctx:n}),n.common.issues.length&&r.push(n.common.issues)}if(e)return t.common.issues.push(...e.ctx.common.issues),e.result;const s=r.map((e=>new Wt(e)));return Jt(t,{code:Ht.invalid_union,unionErrors:s}),Yt}}get options(){return this._def.options}}Vn.create=(e,t)=>new Vn({options:e,typeName:_r.ZodUnion,...pn(t)});const Gn=e=>e instanceof rr?Gn(e.schema):e instanceof cr?Gn(e.innerType()):e instanceof sr?[e.value]:e instanceof ir?e.options:e instanceof or?Ft.objectValues(e.enum):e instanceof hr?Gn(e._def.innerType):e instanceof Dn?[void 0]:e instanceof Un?[null]:e instanceof ur?[void 0,...Gn(e.unwrap())]:e instanceof dr?[null,...Gn(e.unwrap())]:e instanceof gr||e instanceof br?Gn(e.unwrap()):e instanceof pr?Gn(e._def.innerType):[];class Zn extends fn{_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==qt.object)return Jt(t,{code:Ht.invalid_type,expected:qt.object,received:t.parsedType}),Yt;const n=this.discriminator,r=t.data[n],s=this.optionsMap.get(r);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(Jt(t,{code:Ht.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[n]}),Yt)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,n){const r=new Map;for(const n of t){const t=Gn(n.shape[e]);if(!t.length)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(const s of t){if(r.has(s))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(s)}`);r.set(s,n)}}return new Zn({typeName:_r.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:r,...pn(n)})}}function Jn(e,t){const n=zt(e),r=zt(t);if(e===t)return{valid:!0,data:e};if(n===qt.object&&r===qt.object){const n=Ft.objectKeys(t),r=Ft.objectKeys(e).filter((e=>-1!==n.indexOf(e))),s={...e,...t};for(const n of r){const r=Jn(e[n],t[n]);if(!r.valid)return{valid:!1};s[n]=r.data}return{valid:!0,data:s}}if(n===qt.array&&r===qt.array){if(e.length!==t.length)return{valid:!1};const n=[];for(let r=0;r<e.length;r++){const s=Jn(e[r],t[r]);if(!s.valid)return{valid:!1};n.push(s.data)}return{valid:!0,data:n}}return n===qt.date&&r===qt.date&&+e==+t?{valid:!0,data:e}:{valid:!1}}class Xn extends fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=(e,r)=>{if(tn(e)||tn(r))return Yt;const s=Jn(e.value,r.value);return s.valid?((nn(e)||nn(r))&&t.dirty(),{status:t.value,value:s.data}):(Jt(n,{code:Ht.invalid_intersection_types}),Yt)};return n.common.async?Promise.all([this._def.left._parseAsync({data:n.data,path:n.path,parent:n}),this._def.right._parseAsync({data:n.data,path:n.path,parent:n})]).then((([e,t])=>r(e,t))):r(this._def.left._parseSync({data:n.data,path:n.path,parent:n}),this._def.right._parseSync({data:n.data,path:n.path,parent:n}))}}Xn.create=(e,t,n)=>new Xn({left:e,right:t,typeName:_r.ZodIntersection,...pn(n)});class Yn extends fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==qt.array)return Jt(n,{code:Ht.invalid_type,expected:qt.array,received:n.parsedType}),Yt;if(n.data.length<this._def.items.length)return Jt(n,{code:Ht.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),Yt;!this._def.rest&&n.data.length>this._def.items.length&&(Jt(n,{code:Ht.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());const r=[...n.data].map(((e,t)=>{const r=this._def.items[t]||this._def.rest;return r?r._parse(new dn(n,e,n.path,t)):null})).filter((e=>!!e));return n.common.async?Promise.all(r).then((e=>Xt.mergeArray(t,e))):Xt.mergeArray(t,r)}get items(){return this._def.items}rest(e){return new Yn({...this._def,rest:e})}}Yn.create=(e,t)=>{if(!Array.isArray(e))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Yn({items:e,typeName:_r.ZodTuple,rest:null,...pn(t)})};class Qn extends fn{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==qt.object)return Jt(n,{code:Ht.invalid_type,expected:qt.object,received:n.parsedType}),Yt;const r=[],s=this._def.keyType,a=this._def.valueType;for(const e in n.data)r.push({key:s._parse(new dn(n,e,n.path,e)),value:a._parse(new dn(n,n.data[e],n.path,e)),alwaysSet:e in n.data});return n.common.async?Xt.mergeObjectAsync(t,r):Xt.mergeObjectSync(t,r)}get element(){return this._def.valueType}static create(e,t,n){return new Qn(t instanceof fn?{keyType:e,valueType:t,typeName:_r.ZodRecord,...pn(n)}:{keyType:Cn.create(),valueType:e,typeName:_r.ZodRecord,...pn(t)})}}class er extends fn{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==qt.map)return Jt(n,{code:Ht.invalid_type,expected:qt.map,received:n.parsedType}),Yt;const r=this._def.keyType,s=this._def.valueType,a=[...n.data.entries()].map((([e,t],a)=>({key:r._parse(new dn(n,e,n.path,[a,"key"])),value:s._parse(new dn(n,t,n.path,[a,"value"]))})));if(n.common.async){const e=new Map;return Promise.resolve().then((async()=>{for(const n of a){const r=await n.key,s=await n.value;if("aborted"===r.status||"aborted"===s.status)return Yt;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}}))}{const e=new Map;for(const n of a){const r=n.key,s=n.value;if("aborted"===r.status||"aborted"===s.status)return Yt;"dirty"!==r.status&&"dirty"!==s.status||t.dirty(),e.set(r.value,s.value)}return{status:t.value,value:e}}}}er.create=(e,t,n)=>new er({valueType:t,keyType:e,typeName:_r.ZodMap,...pn(n)});class tr extends fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.parsedType!==qt.set)return Jt(n,{code:Ht.invalid_type,expected:qt.set,received:n.parsedType}),Yt;const r=this._def;null!==r.minSize&&n.data.size<r.minSize.value&&(Jt(n,{code:Ht.too_small,minimum:r.minSize.value,type:"set",inclusive:!0,exact:!1,message:r.minSize.message}),t.dirty()),null!==r.maxSize&&n.data.size>r.maxSize.value&&(Jt(n,{code:Ht.too_big,maximum:r.maxSize.value,type:"set",inclusive:!0,exact:!1,message:r.maxSize.message}),t.dirty());const s=this._def.valueType;function a(e){const n=new Set;for(const r of e){if("aborted"===r.status)return Yt;"dirty"===r.status&&t.dirty(),n.add(r.value)}return{status:t.value,value:n}}const i=[...n.data.values()].map(((e,t)=>s._parse(new dn(n,e,n.path,t))));return n.common.async?Promise.all(i).then((e=>a(e))):a(i)}min(e,t){return new tr({...this._def,minSize:{value:e,message:ln.toString(t)}})}max(e,t){return new tr({...this._def,maxSize:{value:e,message:ln.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}}tr.create=(e,t)=>new tr({valueType:e,minSize:null,maxSize:null,typeName:_r.ZodSet,...pn(t)});class nr extends fn{constructor(){super(...arguments),this.validate=this.implement}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==qt.function)return Jt(t,{code:Ht.invalid_type,expected:qt.function,received:t.parsedType}),Yt;function n(e,n){return Zt({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Gt(),Kt].filter((e=>!!e)),issueData:{code:Ht.invalid_arguments,argumentsError:n}})}function r(e,n){return Zt({data:e,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,Gt(),Kt].filter((e=>!!e)),issueData:{code:Ht.invalid_return_type,returnTypeError:n}})}const s={errorMap:t.common.contextualErrorMap},a=t.data;if(this._def.returns instanceof lr){const e=this;return en((async function(...t){const i=new Wt([]),o=await e._def.args.parseAsync(t,s).catch((e=>{throw i.addIssue(n(t,e)),i})),l=await Reflect.apply(a,this,o),c=await e._def.returns._def.type.parseAsync(l,s).catch((e=>{throw i.addIssue(r(l,e)),i}));return c}))}{const e=this;return en((function(...t){const i=e._def.args.safeParse(t,s);if(!i.success)throw new Wt([n(t,i.error)]);const o=Reflect.apply(a,this,i.data),l=e._def.returns.safeParse(o,s);if(!l.success)throw new Wt([r(o,l.error)]);return l.data}))}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new nr({...this._def,args:Yn.create(e).rest(Bn.create())})}returns(e){return new nr({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,n){return new nr({args:e||Yn.create([]).rest(Bn.create()),returns:t||Bn.create(),typeName:_r.ZodFunction,...pn(n)})}}class rr extends fn{get schema(){return this._def.getter()}_parse(e){const{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}}rr.create=(e,t)=>new rr({getter:e,typeName:_r.ZodLazy,...pn(t)});class sr extends fn{_parse(e){if(e.data!==this._def.value){const t=this._getOrReturnCtx(e);return Jt(t,{received:t.data,code:Ht.invalid_literal,expected:this._def.value}),Yt}return{status:"valid",value:e.data}}get value(){return this._def.value}}function ar(e,t){return new ir({values:e,typeName:_r.ZodEnum,...pn(t)})}sr.create=(e,t)=>new sr({value:e,typeName:_r.ZodLiteral,...pn(t)});class ir extends fn{constructor(){super(...arguments),cn.set(this,void 0)}_parse(e){if("string"!=typeof e.data){const t=this._getOrReturnCtx(e),n=this._def.values;return Jt(t,{expected:Ft.joinValues(n),received:t.parsedType,code:Ht.invalid_type}),Yt}if(an(this,cn)||on(this,cn,new Set(this._def.values)),!an(this,cn).has(e.data)){const t=this._getOrReturnCtx(e),n=this._def.values;return Jt(t,{received:t.data,code:Ht.invalid_enum_value,options:n}),Yt}return en(e.data)}get options(){return this._def.values}get enum(){const e={};for(const t of this._def.values)e[t]=t;return e}get Values(){const e={};for(const t of this._def.values)e[t]=t;return e}get Enum(){const e={};for(const t of this._def.values)e[t]=t;return e}extract(e,t=this._def){return ir.create(e,{...this._def,...t})}exclude(e,t=this._def){return ir.create(this.options.filter((t=>!e.includes(t))),{...this._def,...t})}}cn=new WeakMap,ir.create=ar;class or extends fn{constructor(){super(...arguments),un.set(this,void 0)}_parse(e){const t=Ft.getValidEnumValues(this._def.values),n=this._getOrReturnCtx(e);if(n.parsedType!==qt.string&&n.parsedType!==qt.number){const e=Ft.objectValues(t);return Jt(n,{expected:Ft.joinValues(e),received:n.parsedType,code:Ht.invalid_type}),Yt}if(an(this,un)||on(this,un,new Set(Ft.getValidEnumValues(this._def.values))),!an(this,un).has(e.data)){const e=Ft.objectValues(t);return Jt(n,{received:n.data,code:Ht.invalid_enum_value,options:e}),Yt}return en(e.data)}get enum(){return this._def.values}}un=new WeakMap,or.create=(e,t)=>new or({values:e,typeName:_r.ZodNativeEnum,...pn(t)});class lr extends fn{unwrap(){return this._def.type}_parse(e){const{ctx:t}=this._processInputParams(e);if(t.parsedType!==qt.promise&&!1===t.common.async)return Jt(t,{code:Ht.invalid_type,expected:qt.promise,received:t.parsedType}),Yt;const n=t.parsedType===qt.promise?t.data:Promise.resolve(t.data);return en(n.then((e=>this._def.type.parseAsync(e,{path:t.path,errorMap:t.common.contextualErrorMap}))))}}lr.create=(e,t)=>new lr({type:e,typeName:_r.ZodPromise,...pn(t)});class cr extends fn{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===_r.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){const{status:t,ctx:n}=this._processInputParams(e),r=this._def.effect||null,s={addIssue:e=>{Jt(n,e),e.fatal?t.abort():t.dirty()},get path(){return n.path}};if(s.addIssue=s.addIssue.bind(s),"preprocess"===r.type){const e=r.transform(n.data,s);if(n.common.async)return Promise.resolve(e).then((async e=>{if("aborted"===t.value)return Yt;const r=await this._def.schema._parseAsync({data:e,path:n.path,parent:n});return"aborted"===r.status?Yt:"dirty"===r.status||"dirty"===t.value?Qt(r.value):r}));{if("aborted"===t.value)return Yt;const r=this._def.schema._parseSync({data:e,path:n.path,parent:n});return"aborted"===r.status?Yt:"dirty"===r.status||"dirty"===t.value?Qt(r.value):r}}if("refinement"===r.type){const e=e=>{const t=r.refinement(e,s);if(n.common.async)return Promise.resolve(t);if(t instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return e};if(!1===n.common.async){const r=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===r.status?Yt:("dirty"===r.status&&t.dirty(),e(r.value),{status:t.value,value:r.value})}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((n=>"aborted"===n.status?Yt:("dirty"===n.status&&t.dirty(),e(n.value).then((()=>({status:t.value,value:n.value}))))))}if("transform"===r.type){if(!1===n.common.async){const e=this._def.schema._parseSync({data:n.data,path:n.path,parent:n});if(!rn(e))return e;const a=r.transform(e.value,s);if(a instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:a}}return this._def.schema._parseAsync({data:n.data,path:n.path,parent:n}).then((e=>rn(e)?Promise.resolve(r.transform(e.value,s)).then((e=>({status:t.value,value:e}))):e))}Ft.assertNever(r)}}cr.create=(e,t,n)=>new cr({schema:e,typeName:_r.ZodEffects,effect:t,...pn(n)}),cr.createWithPreprocess=(e,t,n)=>new cr({schema:t,effect:{type:"preprocess",transform:e},typeName:_r.ZodEffects,...pn(n)});class ur extends fn{_parse(e){return this._getType(e)===qt.undefined?en(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}ur.create=(e,t)=>new ur({innerType:e,typeName:_r.ZodOptional,...pn(t)});class dr extends fn{_parse(e){return this._getType(e)===qt.null?en(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}}dr.create=(e,t)=>new dr({innerType:e,typeName:_r.ZodNullable,...pn(t)});class hr extends fn{_parse(e){const{ctx:t}=this._processInputParams(e);let n=t.data;return t.parsedType===qt.undefined&&(n=this._def.defaultValue()),this._def.innerType._parse({data:n,path:t.path,parent:t})}removeDefault(){return this._def.innerType}}hr.create=(e,t)=>new hr({innerType:e,typeName:_r.ZodDefault,defaultValue:"function"==typeof t.default?t.default:()=>t.default,...pn(t)});class pr extends fn{_parse(e){const{ctx:t}=this._processInputParams(e),n={...t,common:{...t.common,issues:[]}},r=this._def.innerType._parse({data:n.data,path:n.path,parent:{...n}});return sn(r)?r.then((e=>({status:"valid",value:"valid"===e.status?e.value:this._def.catchValue({get error(){return new Wt(n.common.issues)},input:n.data})}))):{status:"valid",value:"valid"===r.status?r.value:this._def.catchValue({get error(){return new Wt(n.common.issues)},input:n.data})}}removeCatch(){return this._def.innerType}}pr.create=(e,t)=>new pr({innerType:e,typeName:_r.ZodCatch,catchValue:"function"==typeof t.catch?t.catch:()=>t.catch,...pn(t)});class fr extends fn{_parse(e){if(this._getType(e)!==qt.nan){const t=this._getOrReturnCtx(e);return Jt(t,{code:Ht.invalid_type,expected:qt.nan,received:t.parsedType}),Yt}return{status:"valid",value:e.data}}}fr.create=e=>new fr({typeName:_r.ZodNaN,...pn(e)});const mr=Symbol("zod_brand");class gr extends fn{_parse(e){const{ctx:t}=this._processInputParams(e),n=t.data;return this._def.type._parse({data:n,path:t.path,parent:t})}unwrap(){return this._def.type}}class yr extends fn{_parse(e){const{status:t,ctx:n}=this._processInputParams(e);if(n.common.async){return(async()=>{const e=await this._def.in._parseAsync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Yt:"dirty"===e.status?(t.dirty(),Qt(e.value)):this._def.out._parseAsync({data:e.value,path:n.path,parent:n})})()}{const e=this._def.in._parseSync({data:n.data,path:n.path,parent:n});return"aborted"===e.status?Yt:"dirty"===e.status?(t.dirty(),{status:"dirty",value:e.value}):this._def.out._parseSync({data:e.value,path:n.path,parent:n})}}static create(e,t){return new yr({in:e,out:t,typeName:_r.ZodPipeline})}}class br extends fn{_parse(e){const t=this._def.innerType._parse(e),n=e=>(rn(e)&&(e.value=Object.freeze(e.value)),e);return sn(t)?t.then((e=>n(e))):n(t)}unwrap(){return this._def.innerType}}function wr(e,t={},n){return e?Fn.create().superRefine(((r,s)=>{var a,i;if(!e(r)){const e="function"==typeof t?t(r):"string"==typeof t?{message:t}:t,o=null===(i=null!==(a=e.fatal)&&void 0!==a?a:n)||void 0===i||i,l="string"==typeof e?{message:e}:e;s.addIssue({code:"custom",...l,fatal:o})}})):Fn.create()}br.create=(e,t)=>new br({innerType:e,typeName:_r.ZodReadonly,...pn(t)});const vr={object:Kn.lazycreate};var _r;!function(e){e.ZodString="ZodString",e.ZodNumber="ZodNumber",e.ZodNaN="ZodNaN",e.ZodBigInt="ZodBigInt",e.ZodBoolean="ZodBoolean",e.ZodDate="ZodDate",e.ZodSymbol="ZodSymbol",e.ZodUndefined="ZodUndefined",e.ZodNull="ZodNull",e.ZodAny="ZodAny",e.ZodUnknown="ZodUnknown",e.ZodNever="ZodNever",e.ZodVoid="ZodVoid",e.ZodArray="ZodArray",e.ZodObject="ZodObject",e.ZodUnion="ZodUnion",e.ZodDiscriminatedUnion="ZodDiscriminatedUnion",e.ZodIntersection="ZodIntersection",e.ZodTuple="ZodTuple",e.ZodRecord="ZodRecord",e.ZodMap="ZodMap",e.ZodSet="ZodSet",e.ZodFunction="ZodFunction",e.ZodLazy="ZodLazy",e.ZodLiteral="ZodLiteral",e.ZodEnum="ZodEnum",e.ZodEffects="ZodEffects",e.ZodNativeEnum="ZodNativeEnum",e.ZodOptional="ZodOptional",e.ZodNullable="ZodNullable",e.ZodDefault="ZodDefault",e.ZodCatch="ZodCatch",e.ZodPromise="ZodPromise",e.ZodBranded="ZodBranded",e.ZodPipeline="ZodPipeline",e.ZodReadonly="ZodReadonly"}(_r||(_r={}));const kr=Cn.create,Er=Nn.create,Or=fr.create,Sr=$n.create,Tr=jn.create,xr=Ln.create,Ar=Mn.create,Ir=Dn.create,Pr=Un.create,Cr=Fn.create,Rr=Bn.create,Nr=qn.create,$r=zn.create,jr=Hn.create,Lr=Kn.create,Mr=Kn.strictCreate,Dr=Vn.create,Ur=Zn.create,Fr=Xn.create,Br=Yn.create,qr=Qn.create,zr=er.create,Hr=tr.create,Wr=nr.create,Kr=rr.create,Vr=sr.create,Gr=ir.create,Zr=or.create,Jr=lr.create,Xr=cr.create,Yr=ur.create,Qr=dr.create,es=cr.createWithPreprocess,ts=yr.create,ns={string:e=>Cn.create({...e,coerce:!0}),number:e=>Nn.create({...e,coerce:!0}),boolean:e=>jn.create({...e,coerce:!0}),bigint:e=>$n.create({...e,coerce:!0}),date:e=>Ln.create({...e,coerce:!0})},rs=Yt;var ss=Object.freeze({__proto__:null,defaultErrorMap:Kt,setErrorMap:function(e){Vt=e},getErrorMap:Gt,makeIssue:Zt,EMPTY_PATH:[],addIssueToContext:Jt,ParseStatus:Xt,INVALID:Yt,DIRTY:Qt,OK:en,isAborted:tn,isDirty:nn,isValid:rn,isAsync:sn,get util(){return Ft},get objectUtil(){return Bt},ZodParsedType:qt,getParsedType:zt,ZodType:fn,datetimeRegex:In,ZodString:Cn,ZodNumber:Nn,ZodBigInt:$n,ZodBoolean:jn,ZodDate:Ln,ZodSymbol:Mn,ZodUndefined:Dn,ZodNull:Un,ZodAny:Fn,ZodUnknown:Bn,ZodNever:qn,ZodVoid:zn,ZodArray:Hn,ZodObject:Kn,ZodUnion:Vn,ZodDiscriminatedUnion:Zn,ZodIntersection:Xn,ZodTuple:Yn,ZodRecord:Qn,ZodMap:er,ZodSet:tr,ZodFunction:nr,ZodLazy:rr,ZodLiteral:sr,ZodEnum:ir,ZodNativeEnum:or,ZodPromise:lr,ZodEffects:cr,ZodTransformer:cr,ZodOptional:ur,ZodNullable:dr,ZodDefault:hr,ZodCatch:pr,ZodNaN:fr,BRAND:mr,ZodBranded:gr,ZodPipeline:yr,ZodReadonly:br,custom:wr,Schema:fn,ZodSchema:fn,late:vr,get ZodFirstPartyTypeKind(){return _r},coerce:ns,any:Cr,array:jr,bigint:Sr,boolean:Tr,date:xr,discriminatedUnion:Ur,effect:Xr,enum:Gr,function:Wr,instanceof:(e,t={message:`Input not instance of ${e.name}`})=>wr((t=>t instanceof e),t),intersection:Fr,lazy:Kr,literal:Vr,map:zr,nan:Or,nativeEnum:Zr,never:Nr,null:Pr,nullable:Qr,number:Er,object:Lr,oboolean:()=>Tr().optional(),onumber:()=>Er().optional(),optional:Yr,ostring:()=>kr().optional(),pipeline:ts,preprocess:es,promise:Jr,record:qr,set:Hr,strictObject:Mr,string:kr,symbol:Ar,transformer:Xr,tuple:Br,undefined:Ir,union:Dr,unknown:Rr,void:$r,NEVER:rs,ZodIssueCode:Ht,quotelessJson:e=>JSON.stringify(e,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:Wt});function as(e,t){return Ss(e.type._def,t)}function is(e,t,n){const r=n??t.dateStrategy;if(Array.isArray(r))return{anyOf:r.map(((n,r)=>is(e,t,n)))};switch(r){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":return os(e,t)}}const os=(e,t)=>{const n={type:"integer",format:"unix-time"};if("openApi3"===t.target)return n;for(const r of e.checks)switch(r.kind){case"min":Ut(n,"minimum",r.value,r.message,t);break;case"max":Ut(n,"maximum",r.value,r.message,t)}return n};let ls;const cs=/^[cC][^\s-]{8,}$/,us=/^[0-9a-z]+$/,ds=/^[0-9A-HJKMNP-TV-Z]{26}$/,hs=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,ps=()=>(void 0===ls&&(ls=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),ls),fs=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,ms=/^[a-zA-Z0-9_-]{21}$/;function gs(e,t){const n={type:"string"};function r(e){return"escape"===t.patternStrategy?ys(e):e}if(e.checks)for(const s of e.checks)switch(s.kind){case"min":Ut(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t);break;case"max":Ut(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"email":switch(t.emailStrategy){case"format:email":bs(n,"email",s.message,t);break;case"format:idn-email":bs(n,"idn-email",s.message,t);break;case"pattern:zod":ws(n,hs,s.message,t)}break;case"url":bs(n,"uri",s.message,t);break;case"uuid":bs(n,"uuid",s.message,t);break;case"regex":ws(n,s.regex,s.message,t);break;case"cuid":ws(n,cs,s.message,t);break;case"cuid2":ws(n,us,s.message,t);break;case"startsWith":ws(n,RegExp(`^${r(s.value)}`),s.message,t);break;case"endsWith":ws(n,RegExp(`${r(s.value)}$`),s.message,t);break;case"datetime":bs(n,"date-time",s.message,t);break;case"date":bs(n,"date",s.message,t);break;case"time":bs(n,"time",s.message,t);break;case"duration":bs(n,"duration",s.message,t);break;case"length":Ut(n,"minLength","number"==typeof n.minLength?Math.max(n.minLength,s.value):s.value,s.message,t),Ut(n,"maxLength","number"==typeof n.maxLength?Math.min(n.maxLength,s.value):s.value,s.message,t);break;case"includes":ws(n,RegExp(r(s.value)),s.message,t);break;case"ip":"v6"!==s.version&&bs(n,"ipv4",s.message,t),"v4"!==s.version&&bs(n,"ipv6",s.message,t);break;case"emoji":ws(n,ps,s.message,t);break;case"ulid":ws(n,ds,s.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":bs(n,"binary",s.message,t);break;case"contentEncoding:base64":Ut(n,"contentEncoding","base64",s.message,t);break;case"pattern:zod":ws(n,fs,s.message,t)}break;case"nanoid":ws(n,ms,s.message,t)}return n}const ys=e=>Array.from(e).map((e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`)).join(""),bs=(e,t,n,r)=>{e.format||e.anyOf?.some((e=>e.format))?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&r.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...n&&r.errorMessages&&{errorMessage:{format:n}}})):Ut(e,"format",t,n,r)},ws=(e,t,n,r)=>{e.pattern||e.allOf?.some((e=>e.pattern))?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&r.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:vs(t,r),...n&&r.errorMessages&&{errorMessage:{pattern:n}}})):Ut(e,"pattern",vs(t,r),n,r)},vs=(e,t)=>{const n="function"==typeof e?e():e;if(!t.applyRegexFlags||!n.flags)return n.source;const r=n.flags.includes("i"),s=n.flags.includes("m"),a=n.flags.includes("s"),i=r?n.source.toLowerCase():n.source;let o="",l=!1,c=!1,u=!1;for(let e=0;e<i.length;e++)if(l)o+=i[e],l=!1;else{if(r)if(c){if(i[e].match(/[a-z]/)){u?(o+=i[e],o+=`${i[e-2]}-${i[e]}`.toUpperCase(),u=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(o+=i[e],u=!0):o+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){o+=`[${i[e]}${i[e].toUpperCase()}]`;continue}if(s){if("^"===i[e]){o+="(^|(?<=[\r\n]))";continue}if("$"===i[e]){o+="($|(?=[\r\n]))";continue}}a&&"."===i[e]?o+=c?`${i[e]}\r\n`:`[${i[e]}\r\n]`:(o+=i[e],"\\"===i[e]?l=!0:c&&"]"===i[e]?c=!1:c||"["!==i[e]||(c=!0))}try{new RegExp(o)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),n.source}return o};function _s(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===_r.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce(((n,r)=>({...n,[r]:Ss(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",r]})??{}})),{}),additionalProperties:!1};const n={type:"object",additionalProperties:Ss(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return n;if(e.keyType?._def.typeName===_r.ZodString&&e.keyType._def.checks?.length){const{type:r,...s}=gs(e.keyType._def,t);return{...n,propertyNames:s}}if(e.keyType?._def.typeName===_r.ZodEnum)return{...n,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===_r.ZodBranded&&e.keyType._def.type._def.typeName===_r.ZodString&&e.keyType._def.type._def.checks?.length){const{type:r,...s}=as(e.keyType._def,t);return{...n,propertyNames:s}}return n}const ks={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};const Es=(e,t)=>{const n=(e.options instanceof Map?Array.from(e.options.values()):e.options).map(((e,n)=>Ss(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${n}`]}))).filter((e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0)));return n.length?{anyOf:n}:void 0};function Os(e,t){return"strict"===t.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:Ss(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:Ss(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??!0}function Ss(e,t,n=!1){const r=t.seen.get(e);if(t.override){const s=t.override?.(e,t,r,n);if(s!==jt)return s}if(r&&!n){const e=Ts(r,t);if(void 0!==e)return e}const s={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,s);const a=As(e,e.typeName,t);return a&&Is(e,t,a),s.jsonSchema=a,a}const Ts=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:xs(t.currentPath,e.path)};case"none":case"seen":return e.path.length<t.currentPath.length&&e.path.every(((e,n)=>t.currentPath[n]===e))?(console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{}):"seen"===t.$refStrategy?{}:void 0}},xs=(e,t)=>{let n=0;for(;n<e.length&&n<t.length&&e[n]===t[n];n++);return[(e.length-n).toString(),...t.slice(n)].join("/")},As=(e,t,n)=>{switch(t){case _r.ZodString:return gs(e,n);case _r.ZodNumber:return function(e,t){const n={type:"number"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"int":n.type="integer",Dt(n,"type",r.message,t);break;case"min":"jsonSchema7"===t.target?r.inclusive?Ut(n,"minimum",r.value,r.message,t):Ut(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Ut(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Ut(n,"maximum",r.value,r.message,t):Ut(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Ut(n,"maximum",r.value,r.message,t));break;case"multipleOf":Ut(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case _r.ZodObject:return function(e,t){const n={type:"object",...Object.entries(e.shape()).reduce(((e,[n,r])=>{if(void 0===r||void 0===r._def)return e;const s=Ss(r._def,{...t,currentPath:[...t.currentPath,"properties",n],propertyPath:[...t.currentPath,"properties",n]});return void 0===s?e:{properties:{...e.properties,[n]:s},required:r.isOptional()?e.required:[...e.required,n]}}),{properties:{},required:[]}),additionalProperties:Os(e,t)};return n.required.length||delete n.required,n}(e,n);case _r.ZodBigInt:return function(e,t){const n={type:"integer",format:"int64"};if(!e.checks)return n;for(const r of e.checks)switch(r.kind){case"min":"jsonSchema7"===t.target?r.inclusive?Ut(n,"minimum",r.value,r.message,t):Ut(n,"exclusiveMinimum",r.value,r.message,t):(r.inclusive||(n.exclusiveMinimum=!0),Ut(n,"minimum",r.value,r.message,t));break;case"max":"jsonSchema7"===t.target?r.inclusive?Ut(n,"maximum",r.value,r.message,t):Ut(n,"exclusiveMaximum",r.value,r.message,t):(r.inclusive||(n.exclusiveMaximum=!0),Ut(n,"maximum",r.value,r.message,t));break;case"multipleOf":Ut(n,"multipleOf",r.value,r.message,t)}return n}(e,n);case _r.ZodBoolean:return{type:"boolean"};case _r.ZodDate:return is(e,n);case _r.ZodUndefined:return{not:{}};case _r.ZodNull:return function(e){return"openApi3"===e.target?{enum:["null"],nullable:!0}:{type:"null"}}(n);case _r.ZodArray:return function(e,t){const n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==_r.ZodAny&&(n.items=Ss(e.type._def,{...t,currentPath:[...t.currentPath,"items"]})),e.minLength&&Ut(n,"minItems",e.minLength.value,e.minLength.message,t),e.maxLength&&Ut(n,"maxItems",e.maxLength.value,e.maxLength.message,t),e.exactLength&&(Ut(n,"minItems",e.exactLength.value,e.exactLength.message,t),Ut(n,"maxItems",e.exactLength.value,e.exactLength.message,t)),n}(e,n);case _r.ZodUnion:case _r.ZodDiscriminatedUnion:return function(e,t){if("openApi3"===t.target)return Es(e,t);const n=e.options instanceof Map?Array.from(e.options.values()):e.options;if(n.every((e=>e._def.typeName in ks&&(!e._def.checks||!e._def.checks.length)))){const e=n.reduce(((e,t)=>{const n=ks[t._def.typeName];return n&&!e.includes(n)?[...e,n]:e}),[]);return{type:e.length>1?e:e[0]}}if(n.every((e=>"ZodLiteral"===e._def.typeName&&!e.description))){const e=n.reduce(((e,t)=>{const n=typeof t._def.value;switch(n){case"string":case"number":case"boolean":return[...e,n];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}}),[]);if(e.length===n.length){const t=e.filter(((e,t,n)=>n.indexOf(e)===t));return{type:t.length>1?t:t[0],enum:n.reduce(((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value]),[])}}}else if(n.every((e=>"ZodEnum"===e._def.typeName)))return{type:"string",enum:n.reduce(((e,t)=>[...e,...t._def.values.filter((t=>!e.includes(t)))]),[])};return Es(e,t)}(e,n);case _r.ZodIntersection:return function(e,t){const n=[Ss(e.left._def,{...t,currentPath:[...t.currentPath,"allOf","0"]}),Ss(e.right._def,{...t,currentPath:[...t.currentPath,"allOf","1"]})].filter((e=>!!e));let r="jsonSchema2019-09"===t.target?{unevaluatedProperties:!1}:void 0;const s=[];return n.forEach((e=>{if("type"in(t=e)&&"string"===t.type||!("allOf"in t)){let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){const{additionalProperties:n,...r}=e;t=r}else r=void 0;s.push(t)}else s.push(...e.allOf),void 0===e.unevaluatedProperties&&(r=void 0);var t})),s.length?{allOf:s,...r}:void 0}(e,n);case _r.ZodTuple:return function(e,t){return e.rest?{type:"array",minItems:e.items.length,items:e.items.map(((e,n)=>Ss(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[]),additionalItems:Ss(e.rest._def,{...t,currentPath:[...t.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map(((e,n)=>Ss(e._def,{...t,currentPath:[...t.currentPath,"items",`${n}`]}))).reduce(((e,t)=>void 0===t?e:[...e,t]),[])}}(e,n);case _r.ZodRecord:return _s(e,n);case _r.ZodLiteral:return function(e,t){const n=typeof e.value;return"bigint"!==n&&"number"!==n&&"boolean"!==n&&"string"!==n?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===t.target?{type:"bigint"===n?"integer":n,enum:[e.value]}:{type:"bigint"===n?"integer":n,const:e.value}}(e,n);case _r.ZodEnum:return function(e){return{type:"string",enum:e.values}}(e);case _r.ZodNativeEnum:return function(e){const t=e.values,n=Object.keys(e.values).filter((e=>"number"!=typeof t[t[e]])).map((e=>t[e])),r=Array.from(new Set(n.map((e=>typeof e))));return{type:1===r.length?"string"===r[0]?"string":"number":["string","number"],enum:n}}(e);case _r.ZodNullable:return function(e,t){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===t.target?{type:ks[e.innerType._def.typeName],nullable:!0}:{type:[ks[e.innerType._def.typeName],"null"]};if("openApi3"===t.target){const n=Ss(e.innerType._def,{...t,currentPath:[...t.currentPath]});return n&&"$ref"in n?{allOf:[n],nullable:!0}:n&&{...n,nullable:!0}}const n=Ss(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","0"]});return n&&{anyOf:[n,{type:"null"}]}}(e,n);case _r.ZodOptional:return((e,t)=>{if(t.currentPath.toString()===t.propertyPath?.toString())return Ss(e.innerType._def,t);const n=Ss(e.innerType._def,{...t,currentPath:[...t.currentPath,"anyOf","1"]});return n?{anyOf:[{not:{}},n]}:{}})(e,n);case _r.ZodMap:return function(e,t){return"record"===t.mapStrategy?_s(e,t):{type:"array",maxItems:125,items:{type:"array",items:[Ss(e.keyType._def,{...t,currentPath:[...t.currentPath,"items","items","0"]})||{},Ss(e.valueType._def,{...t,currentPath:[...t.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}}}(e,n);case _r.ZodSet:return function(e,t){const n={type:"array",uniqueItems:!0,items:Ss(e.valueType._def,{...t,currentPath:[...t.currentPath,"items"]})};return e.minSize&&Ut(n,"minItems",e.minSize.value,e.minSize.message,t),e.maxSize&&Ut(n,"maxItems",e.maxSize.value,e.maxSize.message,t),n}(e,n);case _r.ZodLazy:return Ss(e.getter()._def,n);case _r.ZodPromise:return function(e,t){return Ss(e.type._def,t)}(e,n);case _r.ZodNaN:case _r.ZodNever:return{not:{}};case _r.ZodEffects:return function(e,t){return"input"===t.effectStrategy?Ss(e.schema._def,t):{}}(e,n);case _r.ZodAny:case _r.ZodUnknown:return{};case _r.ZodDefault:return function(e,t){return{...Ss(e.innerType._def,t),default:e.defaultValue()}}(e,n);case _r.ZodBranded:return as(e,n);case _r.ZodReadonly:case _r.ZodCatch:return((e,t)=>Ss(e.innerType._def,t))(e,n);case _r.ZodPipeline:return((e,t)=>{if("input"===t.pipeStrategy)return Ss(e.in._def,t);if("output"===t.pipeStrategy)return Ss(e.out._def,t);const n=Ss(e.in._def,{...t,currentPath:[...t.currentPath,"allOf","0"]});return{allOf:[n,Ss(e.out._def,{...t,currentPath:[...t.currentPath,"allOf",n?"1":"0"]})].filter((e=>void 0!==e))}})(e,n);case _r.ZodFunction:case _r.ZodVoid:case _r.ZodSymbol:default:return}},Is=(e,t,n)=>(e.description&&(n.description=e.description,t.markdownDescription&&(n.markdownDescription=e.description)),n),Ps=(e,t)=>{const n=Mt(t),r=void 0,s=t?.name,a=Ss(e._def,n,!1)??{},i=void 0===s?a:{$ref:[..."relative"===n.$refStrategy?[]:n.basePath,n.definitionPath,s].join("/"),[n.definitionPath]:{...r,[s]:a}};return"jsonSchema7"===n.target?i.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===n.target&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i},Cs={SYSTEM_MESSAGE:({agent:e,task:t})=>`You are ${e.name}.\n\nYour role is: ${e.role}.\nYour background is: ${e.background}.\nYour main goal is: ${e.goal}\nYou are working as part of a team.\n\nFor your work you will have available:\n\n- Access to a defined set of tools. \n- Findings and insights from previous tasks. You must use this information to complete your current task.\n- Must follow a specific format for your output.\n\n## Tools available for your use: \n\n${e.tools.length>0?e.tools.map((e=>`${e.name}: ${e.description} Tool Input Schema: ${JSON.stringify(Ps(e.schema))}`)).join(", "):"No tools available. You must reply using your internal knowledge."}\n\n**Important:** You ONLY have access to the tools above, and should NEVER make up tools that are not listed here.\n\n## Format of your output\n\nYou will return just one of the following:\n\n- Thought + (Action or Self Question)\nOR\n- Observation\nOR\n- Final Answer\n\nBelow is the explanation of each one:\n\n### Thought + (Action or Self Question)\n\n{\n   "thought": "your thoughts about what to do next" // it could be an action or ask yourself a follow up question\n   "action":  "you decide what action to take based on your previous thought", // the action could be a self follow up question or decide to use a tool from the available tools to use,\n   "actionInput": the input to the action, just a simple JSON object, enclosed in curly braces, using \\" to wrap keys and values. Remember to use the Tool Schema.\n}\n\nExamples: \n\n{\n   "thought": "To find out who won the Copa America in 2024, I need to search for the most recent and relevant information."\n   "action": "tavily_search_results_json",\n   "actionInput": {"query":"Copa America 2024 winner"}\n}\n\nother\n\n{\n   "thought": "To find out who won the Copa America in 2024, I need to search for the most recent and relevant information."\n   "action": "self_question",\n   "actionInput": {"query":"Copa America 2024 winner"}\n}\n\n### Observation\n\n{\n   "observation":  "Reflect about the result of the action. (E.g:  I got the following results from the tool Can I get the Final Answer from there?)", \n    "isFinalAnswerReady": false // If you have the final answer or not\n}\n\n### Final Answer\n\nIMPORTANT: (Please respect the expected output requirements from the user): ${t.expectedOutput}\n\n{\n    "finalAnswer": "The final answer to the Task."\n}\n\n**IMPORTANT**: You must return a valid JSON object. As if you were returning a JSON object from a function.\n`,INITIAL_MESSAGE:({agent:e,task:t,context:n})=>`Hi ${e.name}, please complete the following task: ${t.description}. \n        Your expected output should be: "${t.expectedOutput}". \n        ${n?`Incorporate the following findings and insights from previous tasks: "${n}"`:""}`,INVALID_JSON_FEEDBACK:({_agent:e,_task:t,_llmOutput:n})=>'You returned an invalid JSON object. Please format your answer as a valid JSON object. Just the JSON object not comments or anything else. E.g: {"finalAnswer": "The final answer"}',THOUGHT_WITH_SELF_QUESTION_FEEDBACK:({_agent:e,_task:t,_thought:n,question:r,_parsedLLMOutput:s})=>`Awesome, please answer yourself the question: ${r}.`,THOUGHT_FEEDBACK:({_agent:e,_task:t,_thought:n,_parsedLLMOutput:r})=>"Your thoughts are great, let's keep going.",SELF_QUESTION_FEEDBACK:({_agent:e,_task:t,_question:n,_parsedLLMOutput:r})=>"Awesome, please answer yourself the question.",TOOL_RESULT_FEEDBACK:({_agent:e,_task:t,toolResult:n,_parsedLLMOutput:r})=>`You got this result from the tool: ${JSON.stringify(n)}`,TOOL_ERROR_FEEDBACK:({_agent:e,_task:t,toolName:n,_error:r,_parsedLLMOutput:s})=>`An error occurred while using the tool ${n}. Please try again or use a different method.`,TOOL_NOT_EXIST_FEEDBACK:({_agent:e,_task:t,toolName:n,_parsedLLMOutput:r})=>`Hey, the tool ${n} does not exist. Please find another way.`,OBSERVATION_FEEDBACK:({_agent:e,_task:t,_parsedLLMOutput:n})=>"Great observation. Please keep going. Let's get to the final answer.",WEIRD_OUTPUT_FEEDBACK:({_agent:e,_task:t,_parsedLLMOutput:n})=>"Your latest response does not match the way you are expected to output information. Please correct it.",FORCE_FINAL_ANSWER_FEEDBACK:({_agent:e,_task:t,_iterations:n,_maxAgentIterations:r})=>"We don't have more time to keep looking for the answer. Please use all the information you have gathered until now and give the finalAnswer right away.",WORK_ON_FEEDBACK_FEEDBACK:({_agent:e,_task:t,feedback:n})=>`Here is some feedback for you to address: ${n}`};class Rs{constructor({name:e,role:n,goal:r,background:s,tools:a=[],llmConfig:i={},maxIterations:o=10,forceFinalAnswer:l=!0,promptTemplates:c={},llmInstance:u=null}){this.id=t.v4(),this.name=e,this.role=n,this.goal=r,this.background=s,this.tools=a,this.maxIterations=o,this.store=null,this.status=U,this.env=null,this.llmInstance=u;const d={provider:"openai",model:"gpt-4o-mini",maxRetries:1,...i};this.llmConfig=this.normalizeLlmConfig(d),this.llmSystemMessage=null,this.forceFinalAnswer=l,this.promptTemplates={...Cs},Object.assign(this.promptTemplates,c)}normalizeLlmConfig(e){const{provider:t,apiBaseUrl:n}=e;let r={...e};if(n)switch(t){case"openai":r.configuration={basePath:n};break;case"anthropic":r.anthropicApiUrl=n;break;case"google":r.baseUrl=n;break;case"mistral":r.endpoint=n;break;default:throw new Error(`Unknown provider: ${t}`)}return r}setStore(e){this.store=e}setStatus(e){this.status=e}setEnv(e){this.env=e}workOnTask(e){throw new Error("workOnTask must be implemented by subclasses.")}}const Ns="RFC3986",$s={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:e=>String(e)},js=Array.isArray,Ls=(()=>{const e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})(),Ms=1024;function Ds(e,t){if(js(e)){const n=[];for(let r=0;r<e.length;r+=1)n.push(t(e[r]));return n}return t(e)}const Us=Object.prototype.hasOwnProperty,Fs={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},Bs=Array.isArray,qs=Array.prototype.push,zs=function(e,t){qs.apply(e,Bs(t)?t:[t])},Hs=Date.prototype.toISOString,Ws={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,n,r,s)=>{if(0===e.length)return e;let a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===n)return escape(a).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));let i="";for(let e=0;e<a.length;e+=Ms){const t=a.length>=Ms?a.slice(e,e+Ms):a,n=[];for(let e=0;e<t.length;++e){let r=t.charCodeAt(e);45===r||46===r||95===r||126===r||r>=48&&r<=57||r>=65&&r<=90||r>=97&&r<=122||"RFC1738"===s&&(40===r||41===r)?n[n.length]=t.charAt(e):r<128?n[n.length]=Ls[r]:r<2048?n[n.length]=Ls[192|r>>6]+Ls[128|63&r]:r<55296||r>=57344?n[n.length]=Ls[224|r>>12]+Ls[128|r>>6&63]+Ls[128|63&r]:(e+=1,r=65536+((1023&r)<<10|1023&t.charCodeAt(e)),n[n.length]=Ls[240|r>>18]+Ls[128|r>>12&63]+Ls[128|r>>6&63]+Ls[128|63&r])}i+=n.join("")}return i},encodeValuesOnly:!1,format:Ns,formatter:$s[Ns],indices:!1,serializeDate:e=>Hs.call(e),skipNulls:!1,strictNullHandling:!1};const Ks={};function Vs(e,t,n,r,s,a,i,o,l,c,u,d,h,p,f,m,g,y){let b=e,w=y,v=0,_=!1;for(;void 0!==(w=w.get(Ks))&&!_;){const t=w.get(e);if(v+=1,void 0!==t){if(t===v)throw new RangeError("Cyclic object value");_=!0}void 0===w.get(Ks)&&(v=0)}if("function"==typeof c?b=c(t,b):b instanceof Date?b=h?.(b):"comma"===n&&Bs(b)&&(b=Ds(b,(function(e){return e instanceof Date?h?.(e):e}))),null===b){if(a)return l&&!m?l(t,Ws.encoder,g,"key",p):t;b=""}if(function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e||"symbol"==typeof e||"bigint"==typeof e}(b)||function(e){return!(!e||"object"!=typeof e||!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e)))}(b)){if(l){const e=m?t:l(t,Ws.encoder,g,"key",p);return[f?.(e)+"="+f?.(l(b,Ws.encoder,g,"value",p))]}return[f?.(t)+"="+f?.(String(b))]}const k=[];if(void 0===b)return k;let E;if("comma"===n&&Bs(b))m&&l&&(b=Ds(b,l)),E=[{value:b.length>0?b.join(",")||null:void 0}];else if(Bs(c))E=c;else{const e=Object.keys(b);E=u?e.sort(u):e}const O=o?String(t).replace(/\./g,"%2E"):String(t),S=r&&Bs(b)&&1===b.length?O+"[]":O;if(s&&Bs(b)&&0===b.length)return S+"[]";for(let t=0;t<E.length;++t){const w=E[t],_="object"==typeof w&&void 0!==w.value?w.value:b[w];if(i&&null===_)continue;const O=d&&o?w.replace(/\./g,"%2E"):w,T=Bs(b)?"function"==typeof n?n(S,O):S:S+(d?"."+O:"["+O+"]");y.set(e,v);const x=new WeakMap;x.set(Ks,y),zs(k,Vs(_,T,n,r,s,a,i,o,"comma"===n&&m&&Bs(b)?null:l,c,u,d,h,p,f,m,g,x))}return k}function Gs(e,t={}){let n=e;const r=function(e=Ws){if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw new TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw new TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");const t=e.charset||Ws.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let n=Ns;if(void 0!==e.format){if(!Us.call($s,e.format))throw new TypeError("Unknown format option provided.");n=e.format}const r=$s[n];let s,a=Ws.filter;if(("function"==typeof e.filter||Bs(e.filter))&&(a=e.filter),s=e.arrayFormat&&e.arrayFormat in Fs?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":Ws.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw new TypeError("`commaRoundTrip` must be a boolean, or absent");const i=void 0===e.allowDots?1==!!e.encodeDotInKeys||Ws.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:Ws.addQueryPrefix,allowDots:i,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:Ws.allowEmptyArrays,arrayFormat:s,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:Ws.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?Ws.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:Ws.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:Ws.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:Ws.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:Ws.encodeValuesOnly,filter:a,format:n,formatter:r,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:Ws.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:Ws.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:Ws.strictNullHandling}}(t);let s,a;"function"==typeof r.filter?(a=r.filter,n=a("",n)):Bs(r.filter)&&(a=r.filter,s=a);const i=[];if("object"!=typeof n||null===n)return"";const o=Fs[r.arrayFormat],l="comma"===o&&r.commaRoundTrip;s||(s=Object.keys(n)),r.sort&&s.sort(r.sort);const c=new WeakMap;for(let e=0;e<s.length;++e){const t=s[e];r.skipNulls&&null===n[t]||zs(i,Vs(n[t],t,o,l,r.allowEmptyArrays,r.strictNullHandling,r.skipNulls,r.encodeDotInKeys,r.encode?r.encoder:null,r.filter,r.sort,r.allowDots,r.serializeDate,r.format,r.formatter,r.encodeValuesOnly,r.charset,c))}const u=i.join(r.delimiter);let d=!0===r.addQueryPrefix?"?":"";return r.charsetSentinel&&("iso-8859-1"===r.charset?d+="utf8=%26%2310003%3B&":d+="utf8=%E2%9C%93&"),u.length>0?d+u:""}const Zs="4.71.1";let Js,Xs,Ys,Qs,ea,ta,na,ra,sa,aa=!1;let ia=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};Js||function(e,t={auto:!1}){if(aa)throw new Error(`you must \`import 'openai/shims/${e.kind}'\` before importing anything else from openai`);if(Js)throw new Error(`can't \`import 'openai/shims/${e.kind}'\` after \`import 'openai/shims/${Js}'\``);aa=t.auto,Js=e.kind,Xs=e.fetch,Ys=e.FormData,Qs=e.File,ea=e.ReadableStream,ta=e.getMultipartRequestOptions,na=e.getDefaultAgent,ra=e.fileFromPath,sa=e.isFsReadStream}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new ia(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class oa extends Error{}let la=class e extends oa{constructor(t,n,r,s){super(`${e.makeMessage(t,n,r)}`),this.status=t,this.headers=s,this.request_id=s?.["x-request-id"];const a=n;this.error=a,this.code=a?.code,this.param=a?.param,this.type=a?.type}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(t,n,r,s){if(!t)return new ua({message:r,cause:ai(n)});const a=n?.error;return 400===t?new ha(t,a,r,s):401===t?new pa(t,a,r,s):403===t?new fa(t,a,r,s):404===t?new ma(t,a,r,s):409===t?new ga(t,a,r,s):422===t?new ya(t,a,r,s):429===t?new ba(t,a,r,s):t>=500?new wa(t,a,r,s):new e(t,a,r,s)}},ca=class extends la{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},ua=class extends la{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},da=class extends ua{constructor({message:e}={}){super({message:e??"Request timed out."})}},ha=class extends la{constructor(){super(...arguments),this.status=400}},pa=class extends la{constructor(){super(...arguments),this.status=401}},fa=class extends la{constructor(){super(...arguments),this.status=403}},ma=class extends la{constructor(){super(...arguments),this.status=404}},ga=class extends la{constructor(){super(...arguments),this.status=409}},ya=class extends la{constructor(){super(...arguments),this.status=422}},ba=class extends la{constructor(){super(...arguments),this.status=429}},wa=class extends la{};class va extends oa{constructor(){super("Could not parse response content as the length limit was reached")}}class _a extends oa{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}let ka=class e{constructor(){this.buffer=[],this.trailingCR=!1}decode(t){let n=this.decodeText(t);if(this.trailingCR&&(n="\r"+n,this.trailingCR=!1),n.endsWith("\r")&&(this.trailingCR=!0,n=n.slice(0,-1)),!n)return[];const r=e.NEWLINE_CHARS.has(n[n.length-1]||"");let s=n.split(e.NEWLINE_REGEXP);return r&&s.pop(),1!==s.length||r?(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s):(this.buffer.push(s[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new oa(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new oa(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new oa("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};ka.NEWLINE_CHARS=new Set(["\n","\r"]),ka.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let Ea=class e{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(t,n){let r=!1;return new e((async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let e=!1;try{for await(const r of async function*(e,t){if(!e.body)throw t.abort(),new oa("Attempted to iterate over a response with no body");const n=new Sa,r=new ka,s=Ta(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,s=new Uint8Array(t.length+e.length);for(s.set(t),s.set(e,t.length),t=s;-1!==(r=Oa(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(s))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(t,n))if(!e)if(r.data.startsWith("[DONE]"))e=!0;else if(null===r.event){let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if(e&&e.error)throw new la(void 0,e.error,void 0,void 0);yield e}else{let e;try{e=JSON.parse(r.data)}catch(e){throw console.error("Could not parse message into JSON:",r.data),console.error("From chunk:",r.raw),e}if("error"==r.event)throw new la(void 0,e.error,e.message,void 0);yield{event:r.event,data:e}}e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||n.abort()}}),n)}static fromReadableStream(t,n){let r=!1;return new e((async function*(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let e=!1;try{for await(const n of async function*(){const e=new ka,n=Ta(t);for await(const t of n)for(const n of e.decode(t))yield n;for(const t of e.flush())yield t}())e||n&&(yield JSON.parse(n));e=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{e||n.abort()}}),n)}[Symbol.asyncIterator](){return this.iterator()}tee(){const t=[],n=[],r=this.iterator(),s=e=>({next:()=>{if(0===e.length){const e=r.next();t.push(e),n.push(e)}return e.shift()}});return[new e((()=>s(t)),this.controller),new e((()=>s(n)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new ea({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:s}=await t.next();if(s)return e.close();const a=n.encode(JSON.stringify(r)+"\n");e.enqueue(a)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}};function Oa(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}let Sa=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}};function Ta(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const xa=e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob,Aa=e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&Ia(e),Ia=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function Pa(e,t,n){if(e=await e,Aa(e))return e;if(xa(e)){const r=await e.blob();t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file");const s=Ia(r)?[await r.arrayBuffer()]:[r];return new Qs(s,t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(Ia(e))t.push(await e.arrayBuffer());else{if(!Ra(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){const t=Object.getOwnPropertyNames(e);return`[${t.map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return Ca(e.name)||Ca(e.filename)||Ca(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n?.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new Qs(r,t,n)}const Ca=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,Ra=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],Na=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag],$a=async e=>{const t=await ja(e.body);return ta(t,e)},ja=async e=>{const t=new Ys;return await Promise.all(Object.entries(e||{}).map((([e,n])=>La(t,e,n)))),t},La=async(e,t,n)=>{if(void 0!==n){if(null==n)throw new TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof n||"number"==typeof n||"boolean"==typeof n)e.append(t,String(n));else if((e=>Aa(e)||xa(e)||sa(e))(n)){const r=await Pa(n);e.append(t,r)}else if(Array.isArray(n))await Promise.all(n.map((n=>La(e,t+"[]",n))));else{if("object"!=typeof n)throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${n} instead`);await Promise.all(Object.entries(n).map((([n,r])=>La(e,`${t}[${n}]`,r))))}}};var Ma,Da=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},Ua=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};async function Fa(e){const{response:t}=e;if(e.options.stream)return ui("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Ea.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return ui("response",t.status,t.url,t.headers,e),Ba(e,t)}const r=await t.text();return ui("response",t.status,t.url,t.headers,r),r}function Ba(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}let qa=class e extends Promise{constructor(e,t=Fa){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(t){return new e(this.responsePromise,(async e=>Ba(t(await this.parseResponse(e),e),e.response)))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},za=class{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:s}){this.baseURL=e,this.maxRetries=si("maxRetries",t),this.timeout=si("timeout",n),this.httpAgent=r,this.fetch=s??Xs}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Qa(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${di()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((async n=>{const r=n&&Ia(n?.body)?new DataView(await n.body.arrayBuffer()):n?.body instanceof DataView?n.body:n?.body instanceof ArrayBuffer?new DataView(n.body):n&&ArrayBuffer.isView(n?.body)?new DataView(n.body.buffer):n?.body;return{method:e,path:t,...n,body:r}})))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder){return(new TextEncoder).encode(e).length.toString()}}else if(ArrayBuffer.isView(e))return e.byteLength.toString();return null}buildRequest(e,{retryCount:t=0}={}){const{method:n,path:r,query:s,headers:a={}}=e,i=ArrayBuffer.isView(e.body)||e.__binaryRequest&&"string"==typeof e.body?e.body:Na(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),l=this.buildURL(r,s);"timeout"in e&&si("timeout",e.timeout);const c=e.timeout??this.timeout,u=e.httpAgent??this.httpAgent??na(l),d=c+1e3;"number"==typeof u?.options?.timeout&&d>(u.options.timeout??0)&&(u.options.timeout=d),this.idempotencyHeader&&"get"!==n&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);return{req:{method:n,...i&&{body:i},headers:this.buildHeaders({options:e,headers:a,contentLength:o,retryCount:t}),...u&&{agent:u},signal:e.signal??null},url:l,timeout:c}}buildHeaders({options:e,headers:t,contentLength:n,retryCount:r}){const s={};n&&(s["content-length"]=n);const a=this.defaultHeaders(e);return ci(s,a),ci(s,t),Na(e.body)&&"node"!==Js&&delete s["content-type"],void 0===hi(a,"x-stainless-retry-count")&&void 0===hi(t,"x-stainless-retry-count")&&(s["x-stainless-retry-count"]=String(r)),this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return la.generate(e,t,n,r)}request(e,t=null){return new qa(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e,r=n.maxRetries??this.maxRetries;null==t&&(t=r),await this.prepareOptions(n);const{req:s,url:a,timeout:i}=this.buildRequest(n,{retryCount:r-t});if(await this.prepareRequest(s,{url:a,options:n}),ui("request",a,n,s.headers),n.signal?.aborted)throw new ca;const o=new AbortController,l=await this.fetchWithTimeout(a,s,i,o).catch(ai);if(l instanceof Error){if(n.signal?.aborted)throw new ca;if(t)return this.retryRequest(n,t);if("AbortError"===l.name)throw new da;throw new ua({cause:l})}const c=Ka(l.headers);if(!l.ok){if(t&&this.shouldRetry(l)){return ui(`response (error; ${`retrying, ${t} attempts remaining`})`,l.status,a,c),this.retryRequest(n,t,c)}const e=await l.text().catch((e=>ai(e).message)),r=ei(e),s=r?void 0:e;ui(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,l.status,a,c,s);throw this.makeStatusError(l.status,r,s,c)}return{response:l,options:n,controller:o}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new Wa(this,n,e)}buildURL(e,t){const n=ni(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return oi(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new oa(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:s,...a}=t||{};s&&s.addEventListener("abort",(()=>r.abort()));const i=setTimeout((()=>r.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...a}).finally((()=>{clearTimeout(i)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n){let r;const s=n?.["retry-after-ms"];if(s){const e=parseFloat(s);Number.isNaN(e)||(r=e)}const a=n?.["retry-after"];if(a&&!r){const e=parseFloat(a);r=Number.isNaN(e)?Date.parse(a)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await ri(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Zs}`}};class Ha{constructor(e,t,n,r){Ma.set(this,void 0),Da(this,Ma,e,"f"),this.options=r,this.response=t,this.body=n}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageInfo()}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new oa("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e&&"object"==typeof t.query)t.query={...t.query,...e.params};else if("url"in e){const n=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[t,r]of n)e.url.searchParams.set(t,r);t.query=void 0,t.path=e.url.toString()}return await Ua(this,Ma,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ma=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}let Wa=class extends qa{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await Fa(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}};const Ka=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),Va={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryRequest:!0,__binaryResponse:!0,__streamClass:!0},Ga=e=>"object"==typeof e&&null!==e&&!oi(e)&&Object.keys(e).every((e=>li(Va,e))),Za=()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Zs,"X-Stainless-OS":Xa(Deno.build.os),"X-Stainless-Arch":Ja(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Zs,"X-Stainless-OS":Xa(process.platform),"X-Stainless-Arch":Ja(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Zs,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const Ja=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",Xa=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let Ya;const Qa=()=>Ya??(Ya=Za()),ei=e=>{try{return JSON.parse(e)}catch(e){return}},ti=new RegExp("^(?:[a-z]+:)?//","i"),ni=e=>ti.test(e),ri=e=>new Promise((t=>setTimeout(t,e))),si=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new oa(`${e} must be an integer`);if(t<0)throw new oa(`${e} must be a positive integer`);return t},ai=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e)try{return new Error(JSON.stringify(e))}catch{}return new Error(e)},ii=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function oi(e){if(!e)return!0;for(const t in e)return!1;return!0}function li(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function ci(e,t){for(const n in t){if(!li(t,n))continue;const r=n.toLowerCase();if(!r)continue;const s=t[n];null===s?delete e[r]:void 0!==s&&(e[r]=s)}}function ui(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`OpenAI:DEBUG:${e}`,...t)}const di=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})),hi=(e,t)=>{const n=t.toLowerCase();if((e=>"function"==typeof e?.get)(e)){const r=t[0]?.toUpperCase()+t.substring(1).replace(/([^\w])(\w)/g,((e,t,n)=>t+n.toUpperCase()));for(const s of[t,n,t.toUpperCase(),r]){const t=e.get(s);if(t)return t}}for(const[r,s]of Object.entries(e))if(r.toLowerCase()===n)return Array.isArray(s)?(s.length<=1||console.warn(`Received ${s.length} entries for the ${t} header, using the first entry.`),s[0]):s};function pi(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}class fi extends Ha{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[],this.object=n.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class mi extends Ha{constructor(e,t,n,r){super(e,t,n,r),this.data=n.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){const e=this.getPaginatedItems();if(!e.length)return null;const t=e[e.length-1]?.id;return t?{params:{after:t}}:null}}let gi=class{constructor(e){this._client=e}},yi=class extends gi{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}},bi=class extends gi{constructor(){super(...arguments),this.completions=new yi(this._client)}};bi.Completions=yi;class wi extends gi{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}class vi extends gi{create(e,t){return this._client.post("/audio/transcriptions",$a({body:e,...t}))}}class _i extends gi{create(e,t){return this._client.post("/audio/translations",$a({body:e,...t}))}}class ki extends gi{constructor(){super(...arguments),this.transcriptions=new vi(this._client),this.translations=new _i(this._client),this.speech=new wi(this._client)}}ki.Transcriptions=vi,ki.Translations=_i,ki.Speech=wi;class Ei extends gi{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(`/batches/${e}`,t)}list(e={},t){return Ga(e)?this.list({},e):this._client.getAPIList("/batches",Oi,{query:e,...t})}cancel(e,t){return this._client.post(`/batches/${e}/cancel`,t)}}class Oi extends mi{}Ei.BatchesPage=Oi;class Si extends gi{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/assistants/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Ga(e)?this.list({},e):this._client.getAPIList("/assistants",Ti,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class Ti extends mi{}function xi(e){return"function"==typeof e.parse}Si.AssistantsPage=Ti;const Ai=e=>"assistant"===e?.role,Ii=e=>"function"===e?.role,Pi=e=>"tool"===e?.role;var Ci,Ri,Ni,$i,ji,Li,Mi,Di,Ui,Fi,Bi,qi,zi,Hi=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},Wi=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Ki{constructor(){Ci.add(this),this.controller=new AbortController,Ri.set(this,void 0),Ni.set(this,(()=>{})),$i.set(this,(()=>{})),ji.set(this,void 0),Li.set(this,(()=>{})),Mi.set(this,(()=>{})),Di.set(this,{}),Ui.set(this,!1),Fi.set(this,!1),Bi.set(this,!1),qi.set(this,!1),Hi(this,Ri,new Promise(((e,t)=>{Hi(this,Ni,e,"f"),Hi(this,$i,t,"f")})),"f"),Hi(this,ji,new Promise(((e,t)=>{Hi(this,Li,e,"f"),Hi(this,Mi,t,"f")})),"f"),Wi(this,Ri,"f").catch((()=>{})),Wi(this,ji,"f").catch((()=>{}))}_run(e){setTimeout((()=>{e().then((()=>{this._emitFinal(),this._emit("end")}),Wi(this,Ci,"m",zi).bind(this))}),0)}_connected(){this.ended||(Wi(this,Ni,"f").call(this),this._emit("connect"))}get ended(){return Wi(this,Ui,"f")}get errored(){return Wi(this,Fi,"f")}get aborted(){return Wi(this,Bi,"f")}abort(){this.controller.abort()}on(e,t){return(Wi(this,Di,"f")[e]||(Wi(this,Di,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=Wi(this,Di,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(Wi(this,Di,"f")[e]||(Wi(this,Di,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{Hi(this,qi,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){Hi(this,qi,!0,"f"),await Wi(this,ji,"f")}_emit(e,...t){if(Wi(this,Ui,"f"))return;"end"===e&&(Hi(this,Ui,!0,"f"),Wi(this,Li,"f").call(this));const n=Wi(this,Di,"f")[e];if(n&&(Wi(this,Di,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return Wi(this,qi,"f")||n?.length||Promise.reject(e),Wi(this,$i,"f").call(this,e),Wi(this,Mi,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];Wi(this,qi,"f")||n?.length||Promise.reject(e),Wi(this,$i,"f").call(this,e),Wi(this,Mi,"f").call(this,e),this._emit("end")}}_emitFinal(){}}function Vi(e){return"auto-parseable-response-format"===e?.$brand}function Gi(e){return"auto-parseable-tool"===e?.$brand}function Zi(e,t){const n=e.choices.map((e=>{if("length"===e.finish_reason)throw new va;if("content_filter"===e.finish_reason)throw new _a;return{...e,message:{...e.message,tool_calls:e.message.tool_calls?.map((e=>function(e,t){const n=e.tools?.find((e=>e.function?.name===t.function.name));return{...t,function:{...t.function,parsed_arguments:Gi(n)?n.$parseRaw(t.function.arguments):n?.function.strict?JSON.parse(t.function.arguments):null}}}(t,e)))??[],parsed:e.message.content&&!e.message.refusal?Ji(t,e.message.content):null}}}));return{...e,choices:n}}function Ji(e,t){if("json_schema"!==e.response_format?.type)return null;if("json_schema"===e.response_format?.type){if("$parseRaw"in e.response_format){return e.response_format.$parseRaw(t)}return JSON.parse(t)}return null}function Xi(e,t){if(!e)return!1;const n=e.tools?.find((e=>e.function?.name===t.function.name));return Gi(n)||n?.function.strict||!1}function Yi(e){return!!Vi(e.response_format)||(e.tools?.some((e=>Gi(e)||"function"===e.type&&!0===e.function.strict))??!1)}Ri=new WeakMap,Ni=new WeakMap,$i=new WeakMap,ji=new WeakMap,Li=new WeakMap,Mi=new WeakMap,Di=new WeakMap,Ui=new WeakMap,Fi=new WeakMap,Bi=new WeakMap,qi=new WeakMap,Ci=new WeakSet,zi=function(e){if(Hi(this,Fi,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new ca),e instanceof ca)return Hi(this,Bi,!0,"f"),this._emit("abort",e);if(e instanceof oa)return this._emit("error",e);if(e instanceof Error){const t=new oa(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new oa(String(e)))};var Qi,eo,to,no,ro,so,ao,io,oo=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const lo=10;class co extends Ki{constructor(){super(...arguments),Qi.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t)if(this._emit("message",e),(Ii(e)||Pi(e))&&e.content)this._emit("functionCallResult",e.content);else if(Ai(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Ai(e)&&e.tool_calls)for(const t of e.tool_calls)"function"===t.type&&this._emit("functionCall",t.function)}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new oa("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),oo(this,Qi,"m",eo).call(this)}async finalMessage(){return await this.done(),oo(this,Qi,"m",to).call(this)}async finalFunctionCall(){return await this.done(),oo(this,Qi,"m",no).call(this)}async finalFunctionCallResult(){return await this.done(),oo(this,Qi,"m",ro).call(this)}async totalUsage(){return await this.done(),oo(this,Qi,"m",so).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=oo(this,Qi,"m",to).call(this);t&&this._emit("finalMessage",t);const n=oo(this,Qi,"m",eo).call(this);n&&this._emit("finalContent",n);const r=oo(this,Qi,"m",no).call(this);r&&this._emit("finalFunctionCall",r);const s=oo(this,Qi,"m",ro).call(this);null!=s&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some((e=>e.usage))&&this._emit("totalUsage",oo(this,Qi,"m",so).call(this))}async _createChatCompletion(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),oo(this,Qi,"m",ao).call(this,t);const s=await e.chat.completions.create({...t,stream:!1},{...n,signal:this.controller.signal});return this._connected(),this._addChatCompletion(Zi(s,t))}async _runChatCompletion(e,t,n){for(const e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,n)}async _runFunctions(e,t,n){const r="function",{function_call:s="auto",stream:a,...i}=t,o="string"!=typeof s&&s?.name,{maxChatCompletions:l=lo}=n||{},c={};for(const e of t.functions)c[e.name||e.function.name]=e;const u=t.functions.map((e=>({name:e.name||e.function.name,parameters:e.parameters,description:e.description})));for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,function_call:s,functions:u,messages:[...this.messages]},n),a=t.choices[0]?.message;if(!a)throw new oa("missing message in ChatCompletion response");if(!a.function_call)return;const{name:l,arguments:d}=a.function_call,h=c[l];if(!h){const e=`Invalid function_call: ${JSON.stringify(l)}. Available options are: ${u.map((e=>JSON.stringify(e.name))).join(", ")}. Please try again`;this._addMessage({role:r,name:l,content:e});continue}if(o&&o!==l){const e=`Invalid function_call: ${JSON.stringify(l)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,name:l,content:e});continue}let p;try{p=xi(h)?await h.parse(d):d}catch(e){this._addMessage({role:r,name:l,content:e instanceof Error?e.message:String(e)});continue}const f=await h.function(p,this),m=oo(this,Qi,"m",io).call(this,f);if(this._addMessage({role:r,name:l,content:m}),o)return}}async _runTools(e,t,n){const r="tool",{tool_choice:s="auto",stream:a,...i}=t,o="string"!=typeof s&&s?.function?.name,{maxChatCompletions:l=lo}=n||{},c=t.tools.map((e=>{if(Gi(e)){if(!e.$callback)throw new oa("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e})),u={};for(const e of c)"function"===e.type&&(u[e.function.name||e.function.function.name]=e.function);const d="tools"in t?c.map((e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e)):void 0;for(const e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){const t=await this._createChatCompletion(e,{...i,tool_choice:s,tools:d,messages:[...this.messages]},n),a=t.choices[0]?.message;if(!a)throw new oa("missing message in ChatCompletion response");if(!a.tool_calls?.length)return;for(const e of a.tool_calls){if("function"!==e.type)continue;const t=e.id,{name:n,arguments:s}=e.function,a=u[n];if(!a){const e=`Invalid tool_call: ${JSON.stringify(n)}. Available options are: ${Object.keys(u).map((e=>JSON.stringify(e))).join(", ")}. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}if(o&&o!==n){const e=`Invalid tool_call: ${JSON.stringify(n)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:r,tool_call_id:t,content:e});continue}let i;try{i=xi(a)?await a.parse(s):s}catch(e){const n=e instanceof Error?e.message:String(e);this._addMessage({role:r,tool_call_id:t,content:n});continue}const l=await a.function(i,this),c=oo(this,Qi,"m",io).call(this,l);if(this._addMessage({role:r,tool_call_id:t,content:c}),o)return}}}}Qi=new WeakSet,eo=function(){return oo(this,Qi,"m",to).call(this).content??null},to=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Ai(t)){const{function_call:e,...n}=t,r={...n,content:t.content??null,refusal:t.refusal??null};return e&&(r.function_call=e),r}}throw new oa("stream ended without producing a ChatCompletionMessage with role=assistant")},no=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ai(t)&&t?.function_call)return t.function_call;if(Ai(t)&&t?.tool_calls?.length)return t.tool_calls.at(-1)?.function}},ro=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Ii(t)&&null!=t.content)return t.content;if(Pi(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some((e=>"assistant"===e.role&&e.tool_calls?.some((e=>"function"===e.type&&e.id===t.tool_call_id)))))return t.content}},so=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},ao=function(e){if(null!=e.n&&e.n>1)throw new oa("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},io=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class uo extends co{static runFunctions(e,t,n){const r=new uo,s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,s))),r}static runTools(e,t,n){const r=new uo,s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,s))),r}_addMessage(e,t=!0){super._addMessage(e,t),Ai(e)&&e.content&&this._emit("content",e.content)}}const ho=1,po=2,fo=4,mo=8,go=16,yo=32,bo=64,wo=128,vo=256,_o=511;class ko extends Error{}class Eo extends Error{}const Oo=(e,t)=>{const n=e.length;let r=0;const s=e=>{throw new ko(`${e} at position ${r}`)},a=e=>{throw new Eo(`${e} at position ${r}`)},i=()=>(d(),r>=n&&s("Unexpected end of input"),'"'===e[r]?o():"{"===e[r]?l():"["===e[r]?c():"null"===e.substring(r,r+4)||go&t&&n-r<4&&"null".startsWith(e.substring(r))?(r+=4,null):"true"===e.substring(r,r+4)||yo&t&&n-r<4&&"true".startsWith(e.substring(r))?(r+=4,!0):"false"===e.substring(r,r+5)||yo&t&&n-r<5&&"false".startsWith(e.substring(r))?(r+=5,!1):"Infinity"===e.substring(r,r+8)||wo&t&&n-r<8&&"Infinity".startsWith(e.substring(r))?(r+=8,1/0):"-Infinity"===e.substring(r,r+9)||vo&t&&1<n-r&&n-r<9&&"-Infinity".startsWith(e.substring(r))?(r+=9,-1/0):"NaN"===e.substring(r,r+3)||bo&t&&n-r<3&&"NaN".startsWith(e.substring(r))?(r+=3,NaN):u()),o=()=>{const i=r;let o=!1;for(r++;r<n&&('"'!==e[r]||o&&"\\"===e[r-1]);)o="\\"===e[r]&&!o,r++;if('"'==e.charAt(r))try{return JSON.parse(e.substring(i,++r-Number(o)))}catch(e){a(String(e))}else if(ho&t)try{return JSON.parse(e.substring(i,r-Number(o))+'"')}catch(t){return JSON.parse(e.substring(i,e.lastIndexOf("\\"))+'"')}s("Unterminated string literal")},l=()=>{r++,d();const a={};try{for(;"}"!==e[r];){if(d(),r>=n&&mo&t)return a;const s=o();d(),r++;try{const e=i();Object.defineProperty(a,s,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(mo&t)return a;throw e}d(),","===e[r]&&r++}}catch(e){if(mo&t)return a;s("Expected '}' at end of object")}return r++,a},c=()=>{r++;const n=[];try{for(;"]"!==e[r];)n.push(i()),d(),","===e[r]&&r++}catch(e){if(fo&t)return n;s("Expected ']' at end of array")}return r++,n},u=()=>{if(0===r){"-"===e&&po&t&&s("Not sure what '-' is");try{return JSON.parse(e)}catch(n){if(po&t)try{return"."===e[e.length-1]?JSON.parse(e.substring(0,e.lastIndexOf("."))):JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}a(String(n))}}const i=r;for("-"===e[r]&&r++;e[r]&&!",]}".includes(e[r]);)r++;r!=n||po&t||s("Unterminated number literal");try{return JSON.parse(e.substring(i,r))}catch(n){"-"===e.substring(i,r)&&po&t&&s("Not sure what '-' is");try{return JSON.parse(e.substring(i,e.lastIndexOf("e")))}catch(e){a(String(e))}}},d=()=>{for(;r<n&&" \n\r\t".includes(e[r]);)r++};return i()},So=e=>function(e,t=_o){if("string"!=typeof e)throw new TypeError("expecting str, got "+typeof e);if(!e.trim())throw new Error(`${e} is empty`);return Oo(e.trim(),t)}(e,_o^po);var To,xo,Ao,Io,Po,Co,Ro,No,$o,jo,Lo,Mo,Do=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},Uo=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};class Fo extends co{constructor(e){super(),To.add(this),xo.set(this,void 0),Ao.set(this,void 0),Io.set(this,void 0),Do(this,xo,e,"f"),Do(this,Ao,[],"f")}get currentChatCompletionSnapshot(){return Uo(this,Io,"f")}static fromReadableStream(e){const t=new Fo(null);return t._run((()=>t._fromReadableStream(e))),t}static createChatCompletion(e,t,n){const r=new Fo(t);return r._run((()=>r._runChatCompletion(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}async _createChatCompletion(e,t,n){super._createChatCompletion;const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),Uo(this,To,"m",Po).call(this);const s=await e.chat.completions.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of s)Uo(this,To,"m",Ro).call(this,e);if(s.controller.signal?.aborted)throw new ca;return this._addChatCompletion(Uo(this,To,"m",jo).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),Uo(this,To,"m",Po).call(this),this._connected();const r=Ea.fromReadableStream(e,this.controller);let s;for await(const e of r)s&&s!==e.id&&this._addChatCompletion(Uo(this,To,"m",jo).call(this)),Uo(this,To,"m",Ro).call(this,e),s=e.id;if(r.controller.signal?.aborted)throw new ca;return this._addChatCompletion(Uo(this,To,"m",jo).call(this))}[(xo=new WeakMap,Ao=new WeakMap,Io=new WeakMap,To=new WeakSet,Po=function(){this.ended||Do(this,Io,void 0,"f")},Co=function(e){let t=Uo(this,Ao,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},Uo(this,Ao,"f")[e.index]=t,t)},Ro=function(e){if(this.ended)return;const t=Uo(this,To,"m",Mo).call(this,e);this._emit("chunk",e,t);for(const n of e.choices){const e=t.choices[n.index];null!=n.delta.content&&"assistant"===e.message?.role&&e.message?.content&&(this._emit("content",n.delta.content,e.message.content),this._emit("content.delta",{delta:n.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=n.delta.refusal&&"assistant"===e.message?.role&&e.message?.refusal&&this._emit("refusal.delta",{delta:n.delta.refusal,snapshot:e.message.refusal}),null!=n.logprobs?.content&&"assistant"===e.message?.role&&this._emit("logprobs.content.delta",{content:n.logprobs?.content,snapshot:e.logprobs?.content??[]}),null!=n.logprobs?.refusal&&"assistant"===e.message?.role&&this._emit("logprobs.refusal.delta",{refusal:n.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});const r=Uo(this,To,"m",Co).call(this,e);e.finish_reason&&(Uo(this,To,"m",$o).call(this,e),null!=r.current_tool_call_index&&Uo(this,To,"m",No).call(this,e,r.current_tool_call_index));for(const t of n.delta.tool_calls??[])r.current_tool_call_index!==t.index&&(Uo(this,To,"m",$o).call(this,e),null!=r.current_tool_call_index&&Uo(this,To,"m",No).call(this,e,r.current_tool_call_index)),r.current_tool_call_index=t.index;for(const t of n.delta.tool_calls??[]){const n=e.message.tool_calls?.[t.index];n?.type&&("function"===n?.type&&this._emit("tool_calls.function.arguments.delta",{name:n.function?.name,index:t.index,arguments:n.function.arguments,parsed_arguments:n.function.parsed_arguments,arguments_delta:t.function?.arguments??""}))}}},No=function(e,t){if(Uo(this,To,"m",Co).call(this,e).done_tool_calls.has(t))return;const n=e.message.tool_calls?.[t];if(!n)throw new Error("no tool call snapshot");if(!n.type)throw new Error("tool call snapshot missing `type`");if("function"===n.type){const e=Uo(this,xo,"f")?.tools?.find((e=>"function"===e.type&&e.function.name===n.function.name));this._emit("tool_calls.function.arguments.done",{name:n.function.name,index:t,arguments:n.function.arguments,parsed_arguments:Gi(e)?e.$parseRaw(n.function.arguments):e?.function.strict?JSON.parse(n.function.arguments):null})}else n.type},$o=function(e){const t=Uo(this,To,"m",Co).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;const n=Uo(this,To,"m",Lo).call(this);this._emit("content.done",{content:e.message.content,parsed:n?n.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},jo=function(){if(this.ended)throw new oa("stream has ended, this shouldn't happen");const e=Uo(this,Io,"f");if(!e)throw new oa("request ended without sending any chunks");return Do(this,Io,void 0,"f"),Do(this,Ao,[],"f"),function(e,t){const{id:n,choices:r,created:s,model:a,system_fingerprint:i,...o}=e,l={...o,id:n,choices:r.map((({message:t,finish_reason:n,index:r,logprobs:s,...a})=>{if(!n)throw new oa(`missing finish_reason for choice ${r}`);const{content:i=null,function_call:o,tool_calls:l,...c}=t,u=t.role;if(!u)throw new oa(`missing role for choice ${r}`);if(o){const{arguments:e,name:l}=o;if(null==e)throw new oa(`missing function_call.arguments for choice ${r}`);if(!l)throw new oa(`missing function_call.name for choice ${r}`);return{...a,message:{content:i,function_call:{arguments:e,name:l},role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}}return l?{...a,index:r,finish_reason:n,logprobs:s,message:{...c,role:u,content:i,refusal:t.refusal??null,tool_calls:l.map(((t,n)=>{const{function:s,type:a,id:i,...o}=t,{arguments:l,name:c,...u}=s||{};if(null==i)throw new oa(`missing choices[${r}].tool_calls[${n}].id\n${Bo(e)}`);if(null==a)throw new oa(`missing choices[${r}].tool_calls[${n}].type\n${Bo(e)}`);if(null==c)throw new oa(`missing choices[${r}].tool_calls[${n}].function.name\n${Bo(e)}`);if(null==l)throw new oa(`missing choices[${r}].tool_calls[${n}].function.arguments\n${Bo(e)}`);return{...o,id:i,type:a,function:{...u,name:c,arguments:l}}}))}}:{...a,message:{...c,content:i,role:u,refusal:t.refusal??null},finish_reason:n,index:r,logprobs:s}})),created:s,model:a,object:"chat.completion",...i?{system_fingerprint:i}:{}};return function(e,t){return t&&Yi(t)?Zi(e,t):{...e,choices:e.choices.map((e=>({...e,message:{...e.message,parsed:null,tool_calls:e.message.tool_calls??[]}})))}}(l,t)}(e,Uo(this,xo,"f"))},Lo=function(){const e=Uo(this,xo,"f")?.response_format;return Vi(e)?e:null},Mo=function(e){var t,n,r,s;let a=Uo(this,Io,"f");const{choices:i,...o}=e;a?Object.assign(a,o):a=Do(this,Io,{...o,choices:[]},"f");for(const{delta:i,finish_reason:o,index:l,logprobs:c=null,...u}of e.choices){let e=a.choices[l];if(e||(e=a.choices[l]={finish_reason:o,index:l,message:{},logprobs:c,...u}),c)if(e.logprobs){const{content:r,refusal:s,...a}=c;Object.assign(e.logprobs,a),r&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...r)),s&&((n=e.logprobs).refusal??(n.refusal=[]),e.logprobs.refusal.push(...s))}else e.logprobs=Object.assign({},c);if(o&&(e.finish_reason=o,Uo(this,xo,"f")&&Yi(Uo(this,xo,"f")))){if("length"===o)throw new va;if("content_filter"===o)throw new _a}if(Object.assign(e,u),!i)continue;const{content:d,refusal:h,function_call:p,role:f,tool_calls:m,...g}=i;if(Object.assign(e.message,g),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((r=e.message.function_call).arguments??(r.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),d&&(e.message.content=(e.message.content||"")+d,!e.message.refusal&&Uo(this,To,"m",Lo).call(this)&&(e.message.parsed=So(e.message.content))),m){e.message.tool_calls||(e.message.tool_calls=[]);for(const{index:t,id:n,type:r,function:a,...i}of m){const o=(s=e.message.tool_calls)[t]??(s[t]={});Object.assign(o,i),n&&(o.id=n),r&&(o.type=r),a&&(o.function??(o.function={name:a.name??"",arguments:""})),a?.name&&(o.function.name=a.name),a?.arguments&&(o.function.arguments+=a.arguments,Xi(Uo(this,xo,"f"),o)&&(o.function.parsed_arguments=So(o.function.arguments)))}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("chunk",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Ea(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Bo(e){return JSON.stringify(e)}class qo extends Fo{static fromReadableStream(e){const t=new qo(null);return t._run((()=>t._fromReadableStream(e))),t}static runFunctions(e,t,n){const r=new qo(null),s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runFunctions"}};return r._run((()=>r._runFunctions(e,t,s))),r}static runTools(e,t,n){const r=new qo(t),s={...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"runTools"}};return r._run((()=>r._runTools(e,t,s))),r}}let zo=class extends gi{parse(e,t){return function(e){for(const t of e??[]){if("function"!==t.type)throw new oa(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new oa(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}}(e.tools),this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"beta.chat.completions.parse"}})._thenUnwrap((t=>Zi(t,e)))}runFunctions(e,t){return e.stream?qo.runFunctions(this._client,e,t):uo.runFunctions(this._client,e,t)}runTools(e,t){return e.stream?qo.runTools(this._client,e,t):uo.runTools(this._client,e,t)}stream(e,t){return Fo.createChatCompletion(this._client,e,t)}};class Ho extends gi{constructor(){super(...arguments),this.completions=new zo(this._client)}}!function(e){e.Completions=zo}(Ho||(Ho={}));var Wo,Ko,Vo,Go,Zo,Jo,Xo,Yo,Qo,el,tl,nl,rl,sl,al,il,ol,ll,cl,ul,dl,hl,pl=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)},fl=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n};class ml extends Ki{constructor(){super(...arguments),Wo.add(this),Ko.set(this,[]),Vo.set(this,{}),Go.set(this,{}),Zo.set(this,void 0),Jo.set(this,void 0),Xo.set(this,void 0),Yo.set(this,void 0),Qo.set(this,void 0),el.set(this,void 0),tl.set(this,void 0),nl.set(this,void 0),rl.set(this,void 0)}[(Ko=new WeakMap,Vo=new WeakMap,Go=new WeakMap,Zo=new WeakMap,Jo=new WeakMap,Xo=new WeakMap,Yo=new WeakMap,Qo=new WeakMap,el=new WeakMap,tl=new WeakMap,nl=new WeakMap,rl=new WeakMap,Wo=new WeakSet,Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("event",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){const t=new ml;return t._run((()=>t._fromReadableStream(e))),t}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),this._connected();const r=Ea.fromReadableStream(e,this.controller);for await(const e of r)pl(this,Wo,"m",sl).call(this,e);if(r.controller.signal?.aborted)throw new ca;return this._addRun(pl(this,Wo,"m",al).call(this))}toReadableStream(){return new Ea(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,n,r,s){const a=new ml;return a._run((()=>a._runToolAssistantStream(e,t,n,r,{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}}))),a}async _createToolAssistantStream(e,t,n,r,s){const a=s?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",(()=>this.controller.abort())));const i={...r,stream:!0},o=await e.submitToolOutputs(t,n,i,{...s,signal:this.controller.signal});this._connected();for await(const e of o)pl(this,Wo,"m",sl).call(this,e);if(o.controller.signal?.aborted)throw new ca;return this._addRun(pl(this,Wo,"m",al).call(this))}static createThreadAssistantStream(e,t,n){const r=new ml;return r._run((()=>r._threadAssistantStream(e,t,{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}static createAssistantStream(e,t,n,r){const s=new ml;return s._run((()=>s._runAssistantStream(e,t,n,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}}))),s}currentEvent(){return pl(this,tl,"f")}currentRun(){return pl(this,nl,"f")}currentMessageSnapshot(){return pl(this,Zo,"f")}currentRunStepSnapshot(){return pl(this,rl,"f")}async finalRunSteps(){return await this.done(),Object.values(pl(this,Vo,"f"))}async finalMessages(){return await this.done(),Object.values(pl(this,Go,"f"))}async finalRun(){if(await this.done(),!pl(this,Jo,"f"))throw Error("Final run was not received.");return pl(this,Jo,"f")}async _createThreadAssistantStream(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort())));const s={...t,stream:!0},a=await e.createAndRun(s,{...n,signal:this.controller.signal});this._connected();for await(const e of a)pl(this,Wo,"m",sl).call(this,e);if(a.controller.signal?.aborted)throw new ca;return this._addRun(pl(this,Wo,"m",al).call(this))}async _createAssistantStream(e,t,n,r){const s=r?.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",(()=>this.controller.abort())));const a={...n,stream:!0},i=await e.create(t,a,{...r,signal:this.controller.signal});this._connected();for await(const e of i)pl(this,Wo,"m",sl).call(this,e);if(i.controller.signal?.aborted)throw new ca;return this._addRun(pl(this,Wo,"m",al).call(this))}static accumulateDelta(e,t){for(const[n,r]of Object.entries(t)){if(!e.hasOwnProperty(n)){e[n]=r;continue}let t=e[n];if(null!=t)if("index"!==n&&"type"!==n){if("string"==typeof t&&"string"==typeof r)t+=r;else if("number"==typeof t&&"number"==typeof r)t+=r;else{if(!pi(t)||!pi(r)){if(Array.isArray(t)&&Array.isArray(r)){if(t.every((e=>"string"==typeof e||"number"==typeof e))){t.push(...r);continue}for(const e of r){if(!pi(e))throw new Error(`Expected array delta entry to be an object but got: ${e}`);const n=e.index;if(null==n)throw console.error(e),new Error("Expected array delta entry to have an `index` property");if("number"!=typeof n)throw new Error(`Expected array delta entry \`index\` property to be a number but got ${n}`);const r=t[n];null==r?t.push(e):t[n]=this.accumulateDelta(r,e)}continue}throw Error(`Unhandled record type: ${n}, deltaValue: ${r}, accValue: ${t}`)}t=this.accumulateDelta(t,r)}e[n]=t}else e[n]=r;else e[n]=r}return e}_addRun(e){return e}async _threadAssistantStream(e,t,n){return await this._createThreadAssistantStream(t,e,n)}async _runAssistantStream(e,t,n,r){return await this._createAssistantStream(t,e,n,r)}async _runToolAssistantStream(e,t,n,r,s){return await this._createToolAssistantStream(n,e,t,r,s)}}sl=function(e){if(!this.ended)switch(fl(this,tl,e,"f"),pl(this,Wo,"m",ll).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":pl(this,Wo,"m",hl).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":pl(this,Wo,"m",ol).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":pl(this,Wo,"m",il).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},al=function(){if(this.ended)throw new oa("stream has ended, this shouldn't happen");if(!pl(this,Jo,"f"))throw Error("Final run has not been received");return pl(this,Jo,"f")},il=function(e){const[t,n]=pl(this,Wo,"m",ul).call(this,e,pl(this,Zo,"f"));fl(this,Zo,t,"f"),pl(this,Go,"f")[t.id]=t;for(const e of n){const n=t.content[e.index];"text"==n?.type&&this._emit("textCreated",n.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(const n of e.data.delta.content){if("text"==n.type&&n.text){let e=n.text,r=t.content[n.index];if(!r||"text"!=r.type)throw Error("The snapshot associated with this text delta is not text or missing");this._emit("textDelta",e,r.text)}if(n.index!=pl(this,Xo,"f")){if(pl(this,Yo,"f"))switch(pl(this,Yo,"f").type){case"text":this._emit("textDone",pl(this,Yo,"f").text,pl(this,Zo,"f"));break;case"image_file":this._emit("imageFileDone",pl(this,Yo,"f").image_file,pl(this,Zo,"f"))}fl(this,Xo,n.index,"f")}fl(this,Yo,t.content[n.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==pl(this,Xo,"f")){const t=e.data.content[pl(this,Xo,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,pl(this,Zo,"f"));break;case"text":this._emit("textDone",t.text,pl(this,Zo,"f"))}}pl(this,Zo,"f")&&this._emit("messageDone",e.data),fl(this,Zo,void 0,"f")}},ol=function(e){const t=pl(this,Wo,"m",cl).call(this,e);switch(fl(this,rl,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":const n=e.data.delta;if(n.step_details&&"tool_calls"==n.step_details.type&&n.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(const e of n.step_details.tool_calls)e.index==pl(this,Qo,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(pl(this,el,"f")&&this._emit("toolCallDone",pl(this,el,"f")),fl(this,Qo,e.index,"f"),fl(this,el,t.step_details.tool_calls[e.index],"f"),pl(this,el,"f")&&this._emit("toolCallCreated",pl(this,el,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":fl(this,rl,void 0,"f");"tool_calls"==e.data.step_details.type&&pl(this,el,"f")&&(this._emit("toolCallDone",pl(this,el,"f")),fl(this,el,void 0,"f")),this._emit("runStepDone",e.data,t)}},ll=function(e){pl(this,Ko,"f").push(e),this._emit("event",e)},cl=function(e){switch(e.event){case"thread.run.step.created":return pl(this,Vo,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=pl(this,Vo,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let n=e.data;if(n.delta){const r=ml.accumulateDelta(t,n.delta);pl(this,Vo,"f")[e.data.id]=r}return pl(this,Vo,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":pl(this,Vo,"f")[e.data.id]=e.data}if(pl(this,Vo,"f")[e.data.id])return pl(this,Vo,"f")[e.data.id];throw new Error("No snapshot available")},ul=function(e,t){let n=[];switch(e.event){case"thread.message.created":return[e.data,n];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let r=e.data;if(r.delta.content)for(const e of r.delta.content)if(e.index in t.content){let n=t.content[e.index];t.content[e.index]=pl(this,Wo,"m",dl).call(this,e,n)}else t.content[e.index]=e,n.push(e);return[t,n];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,n];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},dl=function(e,t){return ml.accumulateDelta(t,e)},hl=function(e){switch(fl(this,nl,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":fl(this,Jo,e.data,"f"),pl(this,el,"f")&&(this._emit("toolCallDone",pl(this,el,"f")),fl(this,el,void 0,"f"))}};let gl=class extends gi{create(e,t,n){return this._client.post(`/threads/${e}/messages`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/messages/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return Ga(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,yl,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/threads/${e}/messages/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}};class yl extends mi{}gl.MessagesPage=yl;class bl extends gi{retrieve(e,t,n,r={},s){return Ga(r)?this.retrieve(e,t,n,{},r):this._client.get(`/threads/${e}/runs/${t}/steps/${n}`,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v2",...s?.headers}})}list(e,t,n={},r){return Ga(n)?this.list(e,t,{},n):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,wl,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}}class wl extends mi{}bl.RunStepsPage=wl;class vl extends gi{constructor(){super(...arguments),this.steps=new bl(this._client)}create(e,t,n){const{include:r,...s}=t;return this._client.post(`/threads/${e}/runs`,{query:{include:r},body:s,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers},stream:t.stream??!1})}retrieve(e,t,n){return this._client.get(`/threads/${e}/runs/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}update(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}list(e,t={},n){return Ga(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,_l,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}createAndStream(e,t,n){return ml.createAssistantStream(e,this._client.beta.threads.runs,t,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:s,response:a}=await this.retrieve(e,t,{...n,headers:{...n?.headers,...r}}).withResponse();switch(s.status){case"queued":case"in_progress":case"cancelling":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await ri(e);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return s}}}stream(e,t,n){return ml.createAssistantStream(e,this._client.beta.threads.runs,t,n)}submitToolOutputs(e,t,n,r){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers},stream:n.stream??!1})}async submitToolOutputsAndPoll(e,t,n,r){const s=await this.submitToolOutputs(e,t,n,r);return await this.poll(e,s.id,r)}submitToolOutputsStream(e,t,n,r){return ml.createToolAssistantStream(e,t,this._client.beta.threads.runs,n,r)}}class _l extends mi{}vl.RunsPage=_l,vl.Steps=bl,vl.RunStepsPage=wl;class kl extends gi{constructor(){super(...arguments),this.runs=new vl(this._client),this.messages=new gl(this._client)}create(e={},t){return Ga(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/threads/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers},stream:e.stream??!1})}async createAndRunPoll(e,t){const n=await this.createAndRun(e,t);return await this.runs.poll(n.thread_id,n.id,t)}createAndRunStream(e,t){return ml.createThreadAssistantStream(e,this._client.beta.threads,t)}}kl.Runs=vl,kl.RunsPage=_l,kl.Messages=gl,kl.MessagesPage=yl;let El=class extends gi{create(e,t,n){return this._client.post(`/vector_stores/${e}/files`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e,t={},n){return Ga(t)?this.list(e,{},t):this._client.getAPIList(`/vector_stores/${e}/files`,Ol,{query:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}del(e,t,n){return this._client.delete(`/vector_stores/${e}/files/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t,n);return await this.poll(e,r.id,n)}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const s=await this.retrieve(e,t,{...n,headers:r}).withResponse(),a=s.data;switch(a.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=s.response.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await ri(e);break;case"failed":case"completed":return a}}}async upload(e,t,n){const r=await this._client.files.create({file:t,purpose:"assistants"},n);return this.create(e,{file_id:r.id},n)}async uploadAndPoll(e,t,n){const r=await this.upload(e,t,n);return await this.poll(e,r.id,n)}};class Ol extends mi{}El.VectorStoreFilesPage=Ol;class Sl extends gi{create(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}retrieve(e,t,n){return this._client.get(`/vector_stores/${e}/file_batches/${t}`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}cancel(e,t,n){return this._client.post(`/vector_stores/${e}/file_batches/${t}/cancel`,{...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}async createAndPoll(e,t,n){const r=await this.create(e,t);return await this.poll(e,r.id,n)}listFiles(e,t,n={},r){return Ga(n)?this.listFiles(e,t,{},n):this._client.getAPIList(`/vector_stores/${e}/file_batches/${t}/files`,Ol,{query:n,...r,headers:{"OpenAI-Beta":"assistants=v2",...r?.headers}})}async poll(e,t,n){const r={...n?.headers,"X-Stainless-Poll-Helper":"true"};for(n?.pollIntervalMs&&(r["X-Stainless-Custom-Poll-Interval"]=n.pollIntervalMs.toString());;){const{data:s,response:a}=await this.retrieve(e,t,{...n,headers:r}).withResponse();switch(s.status){case"in_progress":let e=5e3;if(n?.pollIntervalMs)e=n.pollIntervalMs;else{const t=a.headers.get("openai-poll-after-ms");if(t){const n=parseInt(t);isNaN(n)||(e=n)}}await ri(e);break;case"failed":case"cancelled":case"completed":return s}}}async uploadAndPoll(e,{files:t,fileIds:n=[]},r){if(null==t||0==t.length)throw new Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");const s=r?.maxConcurrency??5,a=Math.min(s,t.length),i=this._client,o=t.values(),l=[...n];const c=Array(a).fill(o).map((async function(e){for(let t of e){const e=await i.files.create({file:t,purpose:"assistants"},r);l.push(e.id)}}));return await(async e=>{const t=await Promise.allSettled(e),n=t.filter((e=>"rejected"===e.status));if(n.length){for(const e of n)console.error(e.reason);throw new Error(`${n.length} promise(s) failed - see the above errors`)}const r=[];for(const e of t)"fulfilled"===e.status&&r.push(e.value);return r})(c),await this.createAndPoll(e,{file_ids:l})}}class Tl extends gi{constructor(){super(...arguments),this.files=new El(this._client),this.fileBatches=new Sl(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}retrieve(e,t){return this._client.get(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}update(e,t,n){return this._client.post(`/vector_stores/${e}`,{body:t,...n,headers:{"OpenAI-Beta":"assistants=v2",...n?.headers}})}list(e={},t){return Ga(e)?this.list({},e):this._client.getAPIList("/vector_stores",xl,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}del(e,t){return this._client.delete(`/vector_stores/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v2",...t?.headers}})}}class xl extends mi{}Tl.VectorStoresPage=xl,Tl.Files=El,Tl.VectorStoreFilesPage=Ol,Tl.FileBatches=Sl;class Al extends gi{constructor(){super(...arguments),this.vectorStores=new Tl(this._client),this.chat=new Ho(this._client),this.assistants=new Si(this._client),this.threads=new kl(this._client)}}Al.VectorStores=Tl,Al.VectorStoresPage=xl,Al.Assistants=Si,Al.AssistantsPage=Ti,Al.Threads=kl;let Il=class extends gi{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}};class Pl extends gi{create(e,t){return this._client.post("/embeddings",{body:e,...t})}}class Cl extends gi{create(e,t){return this._client.post("/files",$a({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Ga(e)?this.list({},e):this._client.getAPIList("/files",Rl,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t?.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:n=18e5}={}){const r=new Set(["processed","error","deleted"]),s=Date.now();let a=await this.retrieve(e);for(;!a.status||!r.has(a.status);)if(await ri(t),a=await this.retrieve(e),Date.now()-s>n)throw new da({message:`Giving up on waiting for file ${e} to finish processing after ${n} milliseconds.`});return a}}class Rl extends mi{}Cl.FileObjectsPage=Rl;class Nl extends gi{list(e,t={},n){return Ga(t)?this.list(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/checkpoints`,$l,{query:t,...n})}}class $l extends mi{}Nl.FineTuningJobCheckpointsPage=$l;class jl extends gi{constructor(){super(...arguments),this.checkpoints=new Nl(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Ga(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Ll,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},n){return Ga(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Ml,{query:t,...n})}}class Ll extends mi{}class Ml extends mi{}jl.FineTuningJobsPage=Ll,jl.FineTuningJobEventsPage=Ml,jl.Checkpoints=Nl,jl.FineTuningJobCheckpointsPage=$l;class Dl extends gi{constructor(){super(...arguments),this.jobs=new jl(this._client)}}Dl.Jobs=jl,Dl.FineTuningJobsPage=Ll,Dl.FineTuningJobEventsPage=Ml;class Ul extends gi{createVariation(e,t){return this._client.post("/images/variations",$a({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",$a({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}class Fl extends gi{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Bl,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Bl extends fi{}Fl.ModelsPage=Bl;class ql extends gi{create(e,t){return this._client.post("/moderations",{body:e,...t})}}class zl extends gi{create(e,t,n){return this._client.post(`/uploads/${e}/parts`,$a({body:t,...n}))}}class Hl extends gi{constructor(){super(...arguments),this.parts=new zl(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(`/uploads/${e}/cancel`,t)}complete(e,t,n){return this._client.post(`/uploads/${e}/complete`,{body:t,...n})}}var Wl;Hl.Parts=zl;let Kl=class extends za{constructor({baseURL:e=ii("OPENAI_BASE_URL"),apiKey:t=ii("OPENAI_API_KEY"),organization:n=ii("OPENAI_ORG_ID")??null,project:r=ii("OPENAI_PROJECT_ID")??null,...s}={}){if(void 0===t)throw new oa("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const a={apiKey:t,organization:n,project:r,...s,baseURL:e||"https://api.openai.com/v1"};if(!a.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new oa("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");super({baseURL:a.baseURL,timeout:a.timeout??6e5,httpAgent:a.httpAgent,maxRetries:a.maxRetries,fetch:a.fetch}),this.completions=new Il(this),this.chat=new bi(this),this.embeddings=new Pl(this),this.files=new Cl(this),this.images=new Ul(this),this.audio=new ki(this),this.moderations=new ql(this),this.models=new Fl(this),this.fineTuning=new Dl(this),this.beta=new Al(this),this.batches=new Ei(this),this.uploads=new Hl(this),this._options=a,this.apiKey=t,this.organization=n,this.project=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}stringifyQuery(e){return Gs(e,{arrayFormat:"brackets"})}};function Vl(e,t=Gl){e=e.trim();const n=/```(json)?(.*)```/s.exec(e);return t(n?n[2]:e)}function Gl(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="";const n=[];let r=!1,s=!1;for(let a of e){if(r)'"'!==a||s?"\n"!==a||s?s="\\"===a&&!s:a="\\n":r=!1;else if('"'===a)r=!0,s=!1;else if("{"===a)n.push("}");else if("["===a)n.push("]");else if("}"===a||"]"===a){if(!n||n[n.length-1]!==a)return null;n.pop()}t+=a}r&&(t+='"');for(let e=n.length-1;e>=0;e-=1)t+=n[e];try{return JSON.parse(t)}catch(e){return null}}Wl=Kl,Kl.OpenAI=Wl,Kl.DEFAULT_TIMEOUT=6e5,Kl.OpenAIError=oa,Kl.APIError=la,Kl.APIConnectionError=ua,Kl.APIConnectionTimeoutError=da,Kl.APIUserAbortError=ca,Kl.NotFoundError=ma,Kl.ConflictError=ga,Kl.RateLimitError=ba,Kl.BadRequestError=ha,Kl.AuthenticationError=pa,Kl.InternalServerError=wa,Kl.PermissionDeniedError=fa,Kl.UnprocessableEntityError=ya,Kl.toFile=Pa,Kl.fileFromPath=ra,Kl.Completions=Il,Kl.Chat=bi,Kl.Embeddings=Pl,Kl.Files=Cl,Kl.FileObjectsPage=Rl,Kl.Images=Ul,Kl.Audio=ki,Kl.Moderations=ql,Kl.Models=Fl,Kl.ModelsPage=Bl,Kl.FineTuning=Dl,Kl.Beta=Al,Kl.Batches=Ei,Kl.BatchesPage=Oi,Kl.Uploads=Hl;var Zl=function(e,t){if("string"!=typeof e)throw new TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()},Jl=o(Zl),Xl={exports:{}};const Yl=/[\p{Lu}]/u,Ql=/[\p{Ll}]/u,ec=/^[\p{Lu}](?![\p{Lu}])/gu,tc=/([\p{Alpha}\p{N}_]|$)/u,nc=/[_.\- ]+/,rc=new RegExp("^"+nc.source),sc=new RegExp(nc.source+tc.source,"gu"),ac=new RegExp("\\d+"+tc.source,"gu"),ic=(e,t)=>{if("string"!=typeof e&&!Array.isArray(e))throw new TypeError("Expected the input to be `string | string[]`");if(t={pascalCase:!1,preserveConsecutiveUppercase:!1,...t},e=Array.isArray(e)?e.map((e=>e.trim())).filter((e=>e.length)).join("-"):e.trim(),0===e.length)return"";const n=!1===t.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(t.locale),r=!1===t.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(t.locale);if(1===e.length)return t.pascalCase?r(e):n(e);return e!==n(e)&&(e=((e,t,n)=>{let r=!1,s=!1,a=!1;for(let i=0;i<e.length;i++){const o=e[i];r&&Yl.test(o)?(e=e.slice(0,i)+"-"+e.slice(i),r=!1,a=s,s=!0,i++):s&&a&&Ql.test(o)?(e=e.slice(0,i-1)+"-"+e.slice(i-1),a=s,s=!1,r=!0):(r=t(o)===o&&n(o)!==o,a=s,s=n(o)===o&&t(o)!==o)}return e})(e,n,r)),e=e.replace(rc,""),e=t.preserveConsecutiveUppercase?((e,t)=>(ec.lastIndex=0,e.replace(ec,(e=>t(e)))))(e,n):n(e),t.pascalCase&&(e=r(e.charAt(0))+e.slice(1)),((e,t)=>(sc.lastIndex=0,ac.lastIndex=0,e.replace(sc,((e,n)=>t(n))).replace(ac,(e=>t(e)))))(e,r)};function oc(e,t){return t?.[e]||Jl(e)}function lc(e,t,n){const r={};for(const s in e)Object.hasOwn(e,s)&&(r[t(s,n)]=e[s]);return r}function cc(e){return Array.isArray(e)?[...e]:{...e}}function uc(e,t){const n=cc(e);for(const[e,r]of Object.entries(t)){const[t,...s]=e.split(".").reverse();let a=n;for(const e of s.reverse()){if(void 0===a[e])break;a[e]=cc(a[e]),a=a[e]}void 0!==a[t]&&(a[t]={lc:1,type:"secret",id:[r]})}return n}function dc(e){const t=Object.getPrototypeOf(e);return"function"==typeof e.lc_name&&("function"!=typeof t.lc_name||e.lc_name()!==t.lc_name())?e.lc_name():e.name}Xl.exports=ic,Xl.exports.default=ic;class hc{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,dc(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof hc||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},n=Object.keys(this.lc_kwargs).reduce(((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e)),{});for(let r=Object.getPrototypeOf(this);r;r=Object.getPrototypeOf(r))Object.assign(e,Reflect.get(r,"lc_aliases",this)),Object.assign(t,Reflect.get(r,"lc_secrets",this)),Object.assign(n,Reflect.get(r,"lc_attributes",this));return Object.keys(t).forEach((e=>{let t=this,r=n;const[s,...a]=e.split(".").reverse();for(const e of a.reverse()){if(!(e in t)||void 0===t[e])return;e in r&&void 0!==r[e]||("object"==typeof t[e]&&null!=t[e]?r[e]={}:Array.isArray(t[e])&&(r[e]=[])),t=t[e],r=r[e]}s in t&&void 0!==t[s]&&(r[s]=r[s]||t[s])})),{lc:1,type:"constructor",id:this.lc_id,kwargs:lc(Object.keys(t).length?uc(n,t):n,oc,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function pc(e,t){return"string"==typeof e?"string"==typeof t?e+t:[{type:"text",text:e},...t]:Array.isArray(t)?gc(e,t)??[...e,...t]:[...e,{type:"text",text:t}]}class fc extends hc{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:""}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}}function mc(e,t){const n={...e};for(const[e,r]of Object.entries(t))if(null==n[e])n[e]=r;else{if(null==r)continue;if(typeof n[e]!=typeof r||Array.isArray(n[e])!==Array.isArray(r))throw new Error(`field[${e}] already exists in the message chunk, but with a different type.`);if("string"==typeof n[e]){if("type"===e)continue;n[e]+=r}else if("object"!=typeof n[e]||Array.isArray(n[e]))if(Array.isArray(n[e]))n[e]=gc(n[e],r);else{if(n[e]===r)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else n[e]=mc(n[e],r)}return n}function gc(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;{const n=[...e];for(const e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){const t=n.findIndex((t=>t.index===e.index));-1!==t?n[t]=mc(n[t],e):n.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;n.push(e)}return n}}}function yc(e,t){if(!e&&!t)throw new Error("Cannot merge two undefined objects.");if(e&&t){if(typeof e!=typeof t)throw new Error(`Cannot merge objects of different types.\nLeft ${typeof e}\nRight ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return gc(e,t);if("object"==typeof e&&"object"==typeof t)return mc(e,t);if(e===t)return e;throw new Error(`Can not merge objects of different types.\nLeft ${e}\nRight ${t}`)}return e||t}class bc extends fc{}function wc(e){return"function"==typeof e?._getType}class vc extends bc{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new vc({content:pc(this.content,e.content),additional_kwargs:mc(this.additional_kwargs,e.additional_kwargs),response_metadata:mc(this.response_metadata,e.response_metadata),artifact:yc(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id})}}class _c extends fc{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let n;if("string"==typeof e)n={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{n=e;const t=n.additional_kwargs?.tool_calls,r=n.tool_calls;null!=t&&t.length>0&&(void 0===r||0===r.length)&&console.warn(["New LangChain packages are available that more efficiently handle","tool calling.\n\nPlease upgrade your packages to versions that set","message tool calls. e.g., `yarn add @langchain/anthropic`,","yarn add @langchain/openai`, etc."].join(" "));try{if(null!=t&&void 0===r){const[e,r]=function(e){const t=[],n=[];for(const r of e)if(r.function){const e=r.function.name;try{const n={name:e||"",args:JSON.parse(r.function.arguments)||{},id:r.id};t.push(n)}catch(t){n.push({name:e,args:r.function.arguments,id:r.id,error:"Malformed args."})}}return[t,n]}(t);n.tool_calls=e??[],n.invalid_tool_calls=r??[]}else n.tool_calls=n.tool_calls??[],n.invalid_tool_calls=n.invalid_tool_calls??[]}catch(e){n.tool_calls=[],n.invalid_tool_calls=[]}}super(n),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof n&&(this.tool_calls=n.tool_calls??this.tool_calls,this.invalid_tool_calls=n.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=n.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}}function kc(e){return"ai"===e._getType()}class Ec extends bc{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[]};else{const n=[],r=[];for(const t of e.tool_call_chunks){let e={};try{if(e=Gl(t.args??"{}")??{},"object"!=typeof e||Array.isArray(e))throw new Error("Malformed tool call chunk args.");n.push({name:t.name??"",args:e,id:t.id,type:"tool_call"})}catch(e){r.push({name:t.name,args:t.args,id:t.id,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:n,invalid_tool_calls:r}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){const t={content:pc(this.content,e.content),additional_kwargs:mc(this.additional_kwargs,e.additional_kwargs),response_metadata:mc(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){const n=gc(this.tool_call_chunks,e.tool_call_chunks);void 0!==n&&n.length>0&&(t.tool_call_chunks=n)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){const n=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},r=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},s={input_tokens:n.input_tokens+r.input_tokens,output_tokens:n.output_tokens+r.output_tokens,total_tokens:n.total_tokens+r.total_tokens};t.usage_metadata=s}return new Ec(t)}}class Oc extends fc{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return Oc}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}}class Sc extends bc{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new Sc({content:pc(this.content,e.content),additional_kwargs:mc(this.additional_kwargs,e.additional_kwargs),response_metadata:mc(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}}class Tc extends bc{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new Tc({content:pc(this.content,e.content),additional_kwargs:mc(this.additional_kwargs,e.additional_kwargs),response_metadata:mc(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class xc extends fc{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class Ac extends bc{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new Ac({content:pc(this.content,e.content),additional_kwargs:mc(this.additional_kwargs,e.additional_kwargs),response_metadata:mc(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class Ic extends fc{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Pc extends bc{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Pc({content:pc(this.content,e.content),additional_kwargs:mc(this.additional_kwargs,e.additional_kwargs),response_metadata:mc(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function Cc(e){const{type:t,...n}=e;if("human"===t||"user"===t)return new xc(n);if("ai"===t||"assistant"===t)return new _c(n);if("system"===t)return new Ic(n);throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}function Rc(e){if("string"==typeof e)return new xc(e);if(wc(e))return e;if(Array.isArray(e)){const[t,n]=e;return Cc({type:t,content:n})}return Cc(e)}function Nc(e,t="Human",n="AI"){const r=[];for(const s of e){let e;if("human"===s._getType())e=t;else if("ai"===s._getType())e=n;else if("system"===s._getType())e="System";else if("function"===s._getType())e="Function";else if("tool"===s._getType())e="Tool";else{if("generic"!==s._getType())throw new Error(`Got unsupported message type: ${s._getType()}`);e=s.role}const a=s.name?`${s.name}, `:"",i="string"==typeof s.content?s.content:JSON.stringify(s.content,null,2);r.push(`${e}: ${a}${i}`)}return r.join("\n")}function $c(e){const t=e._getType();if("human"===t)return new Ac({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map((e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)})))}),new Ec({...t})}if("system"===t)return new Pc({...e});if("function"===t)return new Tc({...e});if(Oc.isInstance(e))return new Sc({...e});throw new Error("Unknown message type.")}var jc={exports:{}},Lc={};function Mc(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var Dc=Mc;Mc.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},Mc.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},Mc.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var n=this._timeouts.shift();if(void 0===n){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),n=this._cachedTimeouts.slice(-1)}var r=this;return this._timer=setTimeout((function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout((function(){r._operationTimeoutCb(r._attempts)}),r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)}),n),this._options.unref&&this._timer.unref(),!0},Mc.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var n=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){n._operationTimeoutCb()}),n._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},Mc.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},Mc.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},Mc.prototype.start=Mc.prototype.try,Mc.prototype.errors=function(){return this._errors},Mc.prototype.attempts=function(){return this._attempts},Mc.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,n=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,i=(e[a]||0)+1;e[a]=i,i>=n&&(t=s,n=i)}return t},function(e){var t=Dc;e.operation=function(n){var r=e.timeouts(n);return new t(r,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})},e.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var n in e)t[n]=e[n];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<t.retries;s++)r.push(this.createTimeout(s,t));return e&&e.forever&&!r.length&&r.push(this.createTimeout(s,t)),r.sort((function(e,t){return e-t})),r},e.createTimeout=function(e,t){var n=t.randomize?Math.random()+1:1,r=Math.round(n*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return r=Math.min(r,t.maxTimeout)},e.wrap=function(t,n,r){if(n instanceof Array&&(r=n,n=null),!r)for(var s in r=[],t)"function"==typeof t[s]&&r.push(s);for(var a=0;a<r.length;a++){var i=r[a],o=t[i];t[i]=function(r){var s=e.operation(n),a=Array.prototype.slice.call(arguments,1),i=a.pop();a.push((function(e){s.retry(e)||(e&&(arguments[0]=s.mainError()),i.apply(this,arguments))})),s.attempt((function(){r.apply(t,a)}))}.bind(t,o),t[i].options=n}}}(Lc);const Uc=Lc,Fc=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class Bc extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const qc=(e,t)=>new Promise(((n,r)=>{t={onFailedAttempt:()=>{},retries:10,...t};const s=Uc.operation(t);s.attempt((async a=>{try{n(await e(a))}catch(e){if(!(e instanceof Error))return void r(new TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof Bc)s.stop(),r(e.originalError);else if(e instanceof TypeError&&(i=e.message,!Fc.includes(i)))s.stop(),r(e);else{((e,t,n)=>{const r=n.retries-(t-1);e.attemptNumber=t,e.retriesLeft=r})(e,a,t);try{await t.onFailedAttempt(e)}catch(e){return void r(e)}s.retry(e)||r(s.mainError())}}var i}))}));jc.exports=qc,jc.exports.default=qc,jc.exports.AbortError=Bc;var zc=o(jc.exports),Hc={},Wc={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,i){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||i(this,a);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[a]=1===c.length?c[0]:c:i(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(Wc);var Kc=Wc.exports,Vc={exports:{}},Gc=(e,t)=>(t=t||(()=>{}),e.then((e=>new Promise((e=>{e(t())})).then((()=>e))),(e=>new Promise((e=>{e(t())})).then((()=>{throw e})))));const Zc=Gc;let Jc=class extends Error{constructor(e){super(e),this.name="TimeoutError"}};const Xc=(e,t,n)=>new Promise(((r,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void r(e);const a=setTimeout((()=>{if("function"==typeof n){try{r(n())}catch(e){s(e)}return}const a=n instanceof Error?n:new Jc("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(a)}),t);Zc(e.then(r,s),(()=>{clearTimeout(a)}))}));Vc.exports=Xc,Vc.exports.default=Xc,Vc.exports.TimeoutError=Jc;var Yc=Vc.exports,Qc={},eu={};Object.defineProperty(eu,"__esModule",{value:!0}),eu.default=function(e,t,n){let r=0,s=e.length;for(;s>0;){const a=s/2|0;let i=r+a;n(e[i],t)<=0?(r=++i,s-=a+1):s=a}return r},Object.defineProperty(Qc,"__esModule",{value:!0});const tu=eu;Qc.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const r=tu.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(r,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}},Object.defineProperty(Hc,"__esModule",{value:!0});const nu=Kc,ru=Yc,su=Qc,au=()=>{},iu=new ru.TimeoutError;var ou=Hc.default=class extends nu{constructor(e){var t,n,r,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=au,this._resolveIdle=au,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:su.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(s=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==s?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=au,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=au,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():ru.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(iu)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};const lu=(...e)=>fetch(...e),cu=Symbol.for("ls:fetch_implementation"),uu=()=>globalThis[cu]??lu,du=[400,401,403,404,405,406,407,408],hu=[409];let pu=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.queue="default"in ou?new ou.default({concurrency:this.maxConcurrency}):new ou({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){const n=this.onFailedResponseHook;return this.queue.add((()=>zc((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||e.message.startsWith("AbortError"))throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response,r=t?.status;if(r){if(du.includes(+r))throw e;if(hu.includes(+r))return;n&&await n(t)}},retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>uu()(...e).then((e=>e.ok?e:Promise.reject(e)))))}};function fu(e){return"function"==typeof e?._getType}function mu(e){const t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}function gu(e,t){if(!s.validate(e)){throw new Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`)}return e}const yu={};var bu={exports:{}};var wu={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||9007199254740991,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2};var vu="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{};!function(e,t){const{MAX_SAFE_COMPONENT_LENGTH:n,MAX_SAFE_BUILD_LENGTH:r,MAX_LENGTH:s}=wu,a=vu,i=(t=e.exports={}).re=[],o=t.safeRe=[],l=t.src=[],c=t.t={};let u=0;const d="[a-zA-Z0-9-]",h=[["\\s",1],["\\d",s],[d,r]],p=(e,t,n)=>{const r=(e=>{for(const[t,n]of h)e=e.split(`${t}*`).join(`${t}{0,${n}}`).split(`${t}+`).join(`${t}{1,${n}}`);return e})(t),s=u++;a(e,s,t),c[e]=s,l[s]=t,i[s]=new RegExp(t,n?"g":void 0),o[s]=new RegExp(r,n?"g":void 0)};p("NUMERICIDENTIFIER","0|[1-9]\\d*"),p("NUMERICIDENTIFIERLOOSE","\\d+"),p("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${d}*`),p("MAINVERSION",`(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})\\.(${l[c.NUMERICIDENTIFIER]})`),p("MAINVERSIONLOOSE",`(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})\\.(${l[c.NUMERICIDENTIFIERLOOSE]})`),p("PRERELEASEIDENTIFIER",`(?:${l[c.NUMERICIDENTIFIER]}|${l[c.NONNUMERICIDENTIFIER]})`),p("PRERELEASEIDENTIFIERLOOSE",`(?:${l[c.NUMERICIDENTIFIERLOOSE]}|${l[c.NONNUMERICIDENTIFIER]})`),p("PRERELEASE",`(?:-(${l[c.PRERELEASEIDENTIFIER]}(?:\\.${l[c.PRERELEASEIDENTIFIER]})*))`),p("PRERELEASELOOSE",`(?:-?(${l[c.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${l[c.PRERELEASEIDENTIFIERLOOSE]})*))`),p("BUILDIDENTIFIER",`${d}+`),p("BUILD",`(?:\\+(${l[c.BUILDIDENTIFIER]}(?:\\.${l[c.BUILDIDENTIFIER]})*))`),p("FULLPLAIN",`v?${l[c.MAINVERSION]}${l[c.PRERELEASE]}?${l[c.BUILD]}?`),p("FULL",`^${l[c.FULLPLAIN]}$`),p("LOOSEPLAIN",`[v=\\s]*${l[c.MAINVERSIONLOOSE]}${l[c.PRERELEASELOOSE]}?${l[c.BUILD]}?`),p("LOOSE",`^${l[c.LOOSEPLAIN]}$`),p("GTLT","((?:<|>)?=?)"),p("XRANGEIDENTIFIERLOOSE",`${l[c.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),p("XRANGEIDENTIFIER",`${l[c.NUMERICIDENTIFIER]}|x|X|\\*`),p("XRANGEPLAIN",`[v=\\s]*(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:\\.(${l[c.XRANGEIDENTIFIER]})(?:${l[c.PRERELEASE]})?${l[c.BUILD]}?)?)?`),p("XRANGEPLAINLOOSE",`[v=\\s]*(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:\\.(${l[c.XRANGEIDENTIFIERLOOSE]})(?:${l[c.PRERELEASELOOSE]})?${l[c.BUILD]}?)?)?`),p("XRANGE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAIN]}$`),p("XRANGELOOSE",`^${l[c.GTLT]}\\s*${l[c.XRANGEPLAINLOOSE]}$`),p("COERCEPLAIN",`(^|[^\\d])(\\d{1,${n}})(?:\\.(\\d{1,${n}}))?(?:\\.(\\d{1,${n}}))?`),p("COERCE",`${l[c.COERCEPLAIN]}(?:$|[^\\d])`),p("COERCEFULL",l[c.COERCEPLAIN]+`(?:${l[c.PRERELEASE]})?`+`(?:${l[c.BUILD]})?(?:$|[^\\d])`),p("COERCERTL",l[c.COERCE],!0),p("COERCERTLFULL",l[c.COERCEFULL],!0),p("LONETILDE","(?:~>?)"),p("TILDETRIM",`(\\s*)${l[c.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",p("TILDE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAIN]}$`),p("TILDELOOSE",`^${l[c.LONETILDE]}${l[c.XRANGEPLAINLOOSE]}$`),p("LONECARET","(?:\\^)"),p("CARETTRIM",`(\\s*)${l[c.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",p("CARET",`^${l[c.LONECARET]}${l[c.XRANGEPLAIN]}$`),p("CARETLOOSE",`^${l[c.LONECARET]}${l[c.XRANGEPLAINLOOSE]}$`),p("COMPARATORLOOSE",`^${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]})$|^$`),p("COMPARATOR",`^${l[c.GTLT]}\\s*(${l[c.FULLPLAIN]})$|^$`),p("COMPARATORTRIM",`(\\s*)${l[c.GTLT]}\\s*(${l[c.LOOSEPLAIN]}|${l[c.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",p("HYPHENRANGE",`^\\s*(${l[c.XRANGEPLAIN]})\\s+-\\s+(${l[c.XRANGEPLAIN]})\\s*$`),p("HYPHENRANGELOOSE",`^\\s*(${l[c.XRANGEPLAINLOOSE]})\\s+-\\s+(${l[c.XRANGEPLAINLOOSE]})\\s*$`),p("STAR","(<|>)?=?\\s*\\*"),p("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),p("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")}(bu,bu.exports);var _u=bu.exports;const ku=Object.freeze({loose:!0}),Eu=Object.freeze({});var Ou=e=>e?"object"!=typeof e?ku:e:Eu;const Su=/^[0-9]+$/,Tu=(e,t)=>{const n=Su.test(e),r=Su.test(t);return n&&r&&(e=+e,t=+t),e===t?0:n&&!r?-1:r&&!n?1:e<t?-1:1};var xu={compareIdentifiers:Tu,rcompareIdentifiers:(e,t)=>Tu(t,e)};const Au=vu,{MAX_LENGTH:Iu,MAX_SAFE_INTEGER:Pu}=wu,{safeRe:Cu,t:Ru}=_u,Nu=Ou,{compareIdentifiers:$u}=xu;var ju=class e{constructor(t,n){if(n=Nu(n),t instanceof e){if(t.loose===!!n.loose&&t.includePrerelease===!!n.includePrerelease)return t;t=t.version}else if("string"!=typeof t)throw new TypeError(`Invalid version. Must be a string. Got type "${typeof t}".`);if(t.length>Iu)throw new TypeError(`version is longer than ${Iu} characters`);Au("SemVer",t,n),this.options=n,this.loose=!!n.loose,this.includePrerelease=!!n.includePrerelease;const r=t.trim().match(n.loose?Cu[Ru.LOOSE]:Cu[Ru.FULL]);if(!r)throw new TypeError(`Invalid Version: ${t}`);if(this.raw=t,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>Pu||this.major<0)throw new TypeError("Invalid major version");if(this.minor>Pu||this.minor<0)throw new TypeError("Invalid minor version");if(this.patch>Pu||this.patch<0)throw new TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map((e=>{if(/^[0-9]+$/.test(e)){const t=+e;if(t>=0&&t<Pu)return t}return e})):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(t){if(Au("SemVer.compare",this.version,this.options,t),!(t instanceof e)){if("string"==typeof t&&t===this.version)return 0;t=new e(t,this.options)}return t.version===this.version?0:this.compareMain(t)||this.comparePre(t)}compareMain(t){return t instanceof e||(t=new e(t,this.options)),$u(this.major,t.major)||$u(this.minor,t.minor)||$u(this.patch,t.patch)}comparePre(t){if(t instanceof e||(t=new e(t,this.options)),this.prerelease.length&&!t.prerelease.length)return-1;if(!this.prerelease.length&&t.prerelease.length)return 1;if(!this.prerelease.length&&!t.prerelease.length)return 0;let n=0;do{const e=this.prerelease[n],r=t.prerelease[n];if(Au("prerelease compare",n,e,r),void 0===e&&void 0===r)return 0;if(void 0===r)return 1;if(void 0===e)return-1;if(e!==r)return $u(e,r)}while(++n)}compareBuild(t){t instanceof e||(t=new e(t,this.options));let n=0;do{const e=this.build[n],r=t.build[n];if(Au("build compare",n,e,r),void 0===e&&void 0===r)return 0;if(void 0===r)return 1;if(void 0===e)return-1;if(e!==r)return $u(e,r)}while(++n)}inc(e,t,n){switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,n);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,n);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,n),this.inc("pre",t,n);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,n),this.inc("pre",t,n);break;case"major":0===this.minor&&0===this.patch&&0!==this.prerelease.length||this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":0===this.patch&&0!==this.prerelease.length||this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{const e=Number(n)?1:0;if(!t&&!1===n)throw new Error("invalid increment argument: identifier is empty");if(0===this.prerelease.length)this.prerelease=[e];else{let r=this.prerelease.length;for(;--r>=0;)"number"==typeof this.prerelease[r]&&(this.prerelease[r]++,r=-2);if(-1===r){if(t===this.prerelease.join(".")&&!1===n)throw new Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let r=[t,e];!1===n&&(r=[t]),0===$u(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=r):this.prerelease=r}break}default:throw new Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}};const Lu=ju;var Mu=(e,t,n=!1)=>{if(e instanceof Lu)return e;try{return new Lu(e,t)}catch(e){if(!n)return null;throw e}};const Du=Mu;var Uu=(e,t)=>{const n=Du(e,t);return n?n.version:null};const Fu=Mu;var Bu=(e,t)=>{const n=Fu(e.trim().replace(/^[=v]+/,""),t);return n?n.version:null};const qu=ju;var zu=(e,t,n,r,s)=>{"string"==typeof n&&(s=r,r=n,n=void 0);try{return new qu(e instanceof qu?e.version:e,n).inc(t,r,s).version}catch(e){return null}};const Hu=Mu;var Wu=(e,t)=>{const n=Hu(e,null,!0),r=Hu(t,null,!0),s=n.compare(r);if(0===s)return null;const a=s>0,i=a?n:r,o=a?r:n,l=!!i.prerelease.length;if(!!o.prerelease.length&&!l)return o.patch||o.minor?i.patch?"patch":i.minor?"minor":"major":"major";const c=l?"pre":"";return n.major!==r.major?c+"major":n.minor!==r.minor?c+"minor":n.patch!==r.patch?c+"patch":"prerelease"};const Ku=ju;var Vu=(e,t)=>new Ku(e,t).major;const Gu=ju;var Zu=(e,t)=>new Gu(e,t).minor;const Ju=ju;var Xu=(e,t)=>new Ju(e,t).patch;const Yu=Mu;var Qu=(e,t)=>{const n=Yu(e,t);return n&&n.prerelease.length?n.prerelease:null};const ed=ju;var td=(e,t,n)=>new ed(e,n).compare(new ed(t,n));const nd=td;var rd=(e,t,n)=>nd(t,e,n);const sd=td;var ad=(e,t)=>sd(e,t,!0);const id=ju;var od=(e,t,n)=>{const r=new id(e,n),s=new id(t,n);return r.compare(s)||r.compareBuild(s)};const ld=od;var cd=(e,t)=>e.sort(((e,n)=>ld(e,n,t)));const ud=od;var dd=(e,t)=>e.sort(((e,n)=>ud(n,e,t)));const hd=td;var pd=(e,t,n)=>hd(e,t,n)>0;const fd=td;var md=(e,t,n)=>fd(e,t,n)<0;const gd=td;var yd=(e,t,n)=>0===gd(e,t,n);const bd=td;var wd=(e,t,n)=>0!==bd(e,t,n);const vd=td;var _d=(e,t,n)=>vd(e,t,n)>=0;const kd=td;var Ed=(e,t,n)=>kd(e,t,n)<=0;const Od=yd,Sd=wd,Td=pd,xd=_d,Ad=md,Id=Ed;var Pd=(e,t,n,r)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e===n;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof n&&(n=n.version),e!==n;case"":case"=":case"==":return Od(e,n,r);case"!=":return Sd(e,n,r);case">":return Td(e,n,r);case">=":return xd(e,n,r);case"<":return Ad(e,n,r);case"<=":return Id(e,n,r);default:throw new TypeError(`Invalid operator: ${t}`)}};const Cd=ju,Rd=Mu,{safeRe:Nd,t:$d}=_u;var jd=(e,t)=>{if(e instanceof Cd)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let n=null;if((t=t||{}).rtl){const r=t.includePrerelease?Nd[$d.COERCERTLFULL]:Nd[$d.COERCERTL];let s;for(;(s=r.exec(e))&&(!n||n.index+n[0].length!==e.length);)n&&s.index+s[0].length===n.index+n[0].length||(n=s),r.lastIndex=s.index+s[1].length+s[2].length;r.lastIndex=-1}else n=e.match(t.includePrerelease?Nd[$d.COERCEFULL]:Nd[$d.COERCE]);if(null===n)return null;const r=n[2],s=n[3]||"0",a=n[4]||"0",i=t.includePrerelease&&n[5]?`-${n[5]}`:"",o=t.includePrerelease&&n[6]?`+${n[6]}`:"";return Rd(`${r}.${s}.${a}${i}${o}`,t)};var Ld,Md,Dd,Ud,Fd=class{constructor(){this.max=1e3,this.map=new Map}get(e){const t=this.map.get(e);return void 0===t?void 0:(this.map.delete(e),this.map.set(e,t),t)}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){const e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}};function Bd(){if(Md)return Ld;Md=1;const e=/\s+/g;class t{constructor(n,a){if(a=r(a),n instanceof t)return n.loose===!!a.loose&&n.includePrerelease===!!a.includePrerelease?n:new t(n.raw,a);if(n instanceof s)return this.raw=n.value,this.set=[[n]],this.formatted=void 0,this;if(this.options=a,this.loose=!!a.loose,this.includePrerelease=!!a.includePrerelease,this.raw=n.trim().replace(e," "),this.set=this.raw.split("||").map((e=>this.parseRange(e.trim()))).filter((e=>e.length)),!this.set.length)throw new TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){const e=this.set[0];if(this.set=this.set.filter((e=>!f(e[0]))),0===this.set.length)this.set=[e];else if(this.set.length>1)for(const e of this.set)if(1===e.length&&m(e[0])){this.set=[e];break}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");const t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){const t=((this.options.includePrerelease&&h)|(this.options.loose&&p))+":"+e,r=n.get(t);if(r)return r;const i=this.options.loose,m=i?o[l.HYPHENRANGELOOSE]:o[l.HYPHENRANGE];e=e.replace(m,x(this.options.includePrerelease)),a("hyphen replace",e),e=e.replace(o[l.COMPARATORTRIM],c),a("comparator trim",e),e=e.replace(o[l.TILDETRIM],u),a("tilde trim",e),e=e.replace(o[l.CARETTRIM],d),a("caret trim",e);let g=e.split(" ").map((e=>y(e,this.options))).join(" ").split(/\s+/).map((e=>T(e,this.options)));i&&(g=g.filter((e=>(a("loose invalid filter",e,this.options),!!e.match(o[l.COMPARATORLOOSE]))))),a("range list",g);const b=new Map,w=g.map((e=>new s(e,this.options)));for(const e of w){if(f(e))return[e];b.set(e.value,e)}b.size>1&&b.has("")&&b.delete("");const v=[...b.values()];return n.set(t,v),v}intersects(e,n){if(!(e instanceof t))throw new TypeError("a Range is required");return this.set.some((t=>g(t,n)&&e.set.some((e=>g(e,n)&&t.every((t=>e.every((e=>t.intersects(e,n)))))))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new i(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(A(this.set[t],e,this.options))return!0;return!1}}Ld=t;const n=new Fd,r=Ou,s=qd(),a=vu,i=ju,{safeRe:o,t:l,comparatorTrimReplace:c,tildeTrimReplace:u,caretTrimReplace:d}=_u,{FLAG_INCLUDE_PRERELEASE:h,FLAG_LOOSE:p}=wu,f=e=>"<0.0.0-0"===e.value,m=e=>""===e.value,g=(e,t)=>{let n=!0;const r=e.slice();let s=r.pop();for(;n&&r.length;)n=r.every((e=>s.intersects(e,t))),s=r.pop();return n},y=(e,t)=>(a("comp",e,t),e=_(e,t),a("caret",e),e=w(e,t),a("tildes",e),e=E(e,t),a("xrange",e),e=S(e,t),a("stars",e),e),b=e=>!e||"x"===e.toLowerCase()||"*"===e,w=(e,t)=>e.trim().split(/\s+/).map((e=>v(e,t))).join(" "),v=(e,t)=>{const n=t.loose?o[l.TILDELOOSE]:o[l.TILDE];return e.replace(n,((t,n,r,s,i)=>{let o;return a("tilde",e,t,n,r,s,i),b(n)?o="":b(r)?o=`>=${n}.0.0 <${+n+1}.0.0-0`:b(s)?o=`>=${n}.${r}.0 <${n}.${+r+1}.0-0`:i?(a("replaceTilde pr",i),o=`>=${n}.${r}.${s}-${i} <${n}.${+r+1}.0-0`):o=`>=${n}.${r}.${s} <${n}.${+r+1}.0-0`,a("tilde return",o),o}))},_=(e,t)=>e.trim().split(/\s+/).map((e=>k(e,t))).join(" "),k=(e,t)=>{a("caret",e,t);const n=t.loose?o[l.CARETLOOSE]:o[l.CARET],r=t.includePrerelease?"-0":"";return e.replace(n,((t,n,s,i,o)=>{let l;return a("caret",e,t,n,s,i,o),b(n)?l="":b(s)?l=`>=${n}.0.0${r} <${+n+1}.0.0-0`:b(i)?l="0"===n?`>=${n}.${s}.0${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.0${r} <${+n+1}.0.0-0`:o?(a("replaceCaret pr",o),l="0"===n?"0"===s?`>=${n}.${s}.${i}-${o} <${n}.${s}.${+i+1}-0`:`>=${n}.${s}.${i}-${o} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${i}-${o} <${+n+1}.0.0-0`):(a("no pr"),l="0"===n?"0"===s?`>=${n}.${s}.${i}${r} <${n}.${s}.${+i+1}-0`:`>=${n}.${s}.${i}${r} <${n}.${+s+1}.0-0`:`>=${n}.${s}.${i} <${+n+1}.0.0-0`),a("caret return",l),l}))},E=(e,t)=>(a("replaceXRanges",e,t),e.split(/\s+/).map((e=>O(e,t))).join(" ")),O=(e,t)=>{e=e.trim();const n=t.loose?o[l.XRANGELOOSE]:o[l.XRANGE];return e.replace(n,((n,r,s,i,o,l)=>{a("xRange",e,n,r,s,i,o,l);const c=b(s),u=c||b(i),d=u||b(o),h=d;return"="===r&&h&&(r=""),l=t.includePrerelease?"-0":"",c?n=">"===r||"<"===r?"<0.0.0-0":"*":r&&h?(u&&(i=0),o=0,">"===r?(r=">=",u?(s=+s+1,i=0,o=0):(i=+i+1,o=0)):"<="===r&&(r="<",u?s=+s+1:i=+i+1),"<"===r&&(l="-0"),n=`${r+s}.${i}.${o}${l}`):u?n=`>=${s}.0.0${l} <${+s+1}.0.0-0`:d&&(n=`>=${s}.${i}.0${l} <${s}.${+i+1}.0-0`),a("xRange return",n),n}))},S=(e,t)=>(a("replaceStars",e,t),e.trim().replace(o[l.STAR],"")),T=(e,t)=>(a("replaceGTE0",e,t),e.trim().replace(o[t.includePrerelease?l.GTE0PRE:l.GTE0],"")),x=e=>(t,n,r,s,a,i,o,l,c,u,d,h)=>`${n=b(r)?"":b(s)?`>=${r}.0.0${e?"-0":""}`:b(a)?`>=${r}.${s}.0${e?"-0":""}`:i?`>=${n}`:`>=${n}${e?"-0":""}`} ${l=b(c)?"":b(u)?`<${+c+1}.0.0-0`:b(d)?`<${c}.${+u+1}.0-0`:h?`<=${c}.${u}.${d}-${h}`:e?`<${c}.${u}.${+d+1}-0`:`<=${l}`}`.trim(),A=(e,t,n)=>{for(let n=0;n<e.length;n++)if(!e[n].test(t))return!1;if(t.prerelease.length&&!n.includePrerelease){for(let n=0;n<e.length;n++)if(a(e[n].semver),e[n].semver!==s.ANY&&e[n].semver.prerelease.length>0){const r=e[n].semver;if(r.major===t.major&&r.minor===t.minor&&r.patch===t.patch)return!0}return!1}return!0};return Ld}function qd(){if(Ud)return Dd;Ud=1;const e=Symbol("SemVer ANY");class t{static get ANY(){return e}constructor(r,s){if(s=n(s),r instanceof t){if(r.loose===!!s.loose)return r;r=r.value}r=r.trim().split(/\s+/).join(" "),i("comparator",r,s),this.options=s,this.loose=!!s.loose,this.parse(r),this.semver===e?this.value="":this.value=this.operator+this.semver.version,i("comp",this)}parse(t){const n=this.options.loose?r[s.COMPARATORLOOSE]:r[s.COMPARATOR],a=t.match(n);if(!a)throw new TypeError(`Invalid comparator: ${t}`);this.operator=void 0!==a[1]?a[1]:"","="===this.operator&&(this.operator=""),a[2]?this.semver=new o(a[2],this.options.loose):this.semver=e}toString(){return this.value}test(t){if(i("Comparator.test",t,this.options.loose),this.semver===e||t===e)return!0;if("string"==typeof t)try{t=new o(t,this.options)}catch(e){return!1}return a(t,this.operator,this.semver,this.options)}intersects(e,r){if(!(e instanceof t))throw new TypeError("a Comparator is required");return""===this.operator?""===this.value||new l(e.value,r).test(this.value):""===e.operator?""===e.value||new l(this.value,r).test(e.semver):(!(r=n(r)).includePrerelease||"<0.0.0-0"!==this.value&&"<0.0.0-0"!==e.value)&&(!(!r.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&(!(!this.operator.startsWith(">")||!e.operator.startsWith(">"))||(!(!this.operator.startsWith("<")||!e.operator.startsWith("<"))||(!(this.semver.version!==e.semver.version||!this.operator.includes("=")||!e.operator.includes("="))||(!!(a(this.semver,"<",e.semver,r)&&this.operator.startsWith(">")&&e.operator.startsWith("<"))||!!(a(this.semver,">",e.semver,r)&&this.operator.startsWith("<")&&e.operator.startsWith(">")))))))}}Dd=t;const n=Ou,{safeRe:r,t:s}=_u,a=Pd,i=vu,o=ju,l=Bd();return Dd}const zd=Bd();var Hd=(e,t,n)=>{try{t=new zd(t,n)}catch(e){return!1}return t.test(e)};const Wd=Bd();var Kd=(e,t)=>new Wd(e,t).set.map((e=>e.map((e=>e.value)).join(" ").trim().split(" ")));const Vd=ju,Gd=Bd();var Zd=(e,t,n)=>{let r=null,s=null,a=null;try{a=new Gd(t,n)}catch(e){return null}return e.forEach((e=>{a.test(e)&&(r&&-1!==s.compare(e)||(r=e,s=new Vd(r,n)))})),r};const Jd=ju,Xd=Bd();var Yd=(e,t,n)=>{let r=null,s=null,a=null;try{a=new Xd(t,n)}catch(e){return null}return e.forEach((e=>{a.test(e)&&(r&&1!==s.compare(e)||(r=e,s=new Jd(r,n)))})),r};const Qd=ju,eh=Bd(),th=pd;var nh=(e,t)=>{e=new eh(e,t);let n=new Qd("0.0.0");if(e.test(n))return n;if(n=new Qd("0.0.0-0"),e.test(n))return n;n=null;for(let t=0;t<e.set.length;++t){const r=e.set[t];let s=null;r.forEach((e=>{const t=new Qd(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":s&&!th(t,s)||(s=t);break;case"<":case"<=":break;default:throw new Error(`Unexpected operation: ${e.operator}`)}})),!s||n&&!th(n,s)||(n=s)}return n&&e.test(n)?n:null};const rh=Bd();var sh=(e,t)=>{try{return new rh(e,t).range||"*"}catch(e){return null}};const ah=ju,ih=qd(),{ANY:oh}=ih,lh=Bd(),ch=Hd,uh=pd,dh=md,hh=Ed,ph=_d;var fh=(e,t,n,r)=>{let s,a,i,o,l;switch(e=new ah(e,r),t=new lh(t,r),n){case">":s=uh,a=hh,i=dh,o=">",l=">=";break;case"<":s=dh,a=ph,i=uh,o="<",l="<=";break;default:throw new TypeError('Must provide a hilo val of "<" or ">"')}if(ch(e,t,r))return!1;for(let n=0;n<t.set.length;++n){const c=t.set[n];let u=null,d=null;if(c.forEach((e=>{e.semver===oh&&(e=new ih(">=0.0.0")),u=u||e,d=d||e,s(e.semver,u.semver,r)?u=e:i(e.semver,d.semver,r)&&(d=e)})),u.operator===o||u.operator===l)return!1;if((!d.operator||d.operator===o)&&a(e,d.semver))return!1;if(d.operator===l&&i(e,d.semver))return!1}return!0};const mh=fh;var gh=(e,t,n)=>mh(e,t,">",n);const yh=fh;var bh=(e,t,n)=>yh(e,t,"<",n);const wh=Bd();var vh=(e,t,n)=>(e=new wh(e,n),t=new wh(t,n),e.intersects(t,n));const _h=Hd,kh=td;const Eh=Bd(),Oh=qd(),{ANY:Sh}=Oh,Th=Hd,xh=td,Ah=[new Oh(">=0.0.0-0")],Ih=[new Oh(">=0.0.0")],Ph=(e,t,n)=>{if(e===t)return!0;if(1===e.length&&e[0].semver===Sh){if(1===t.length&&t[0].semver===Sh)return!0;e=n.includePrerelease?Ah:Ih}if(1===t.length&&t[0].semver===Sh){if(n.includePrerelease)return!0;t=Ih}const r=new Set;let s,a,i,o,l,c,u;for(const t of e)">"===t.operator||">="===t.operator?s=Ch(s,t,n):"<"===t.operator||"<="===t.operator?a=Rh(a,t,n):r.add(t.semver);if(r.size>1)return null;if(s&&a){if(i=xh(s.semver,a.semver,n),i>0)return null;if(0===i&&(">="!==s.operator||"<="!==a.operator))return null}for(const e of r){if(s&&!Th(e,String(s),n))return null;if(a&&!Th(e,String(a),n))return null;for(const r of t)if(!Th(e,String(r),n))return!1;return!0}let d=!(!a||n.includePrerelease||!a.semver.prerelease.length)&&a.semver,h=!(!s||n.includePrerelease||!s.semver.prerelease.length)&&s.semver;d&&1===d.prerelease.length&&"<"===a.operator&&0===d.prerelease[0]&&(d=!1);for(const e of t){if(u=u||">"===e.operator||">="===e.operator,c=c||"<"===e.operator||"<="===e.operator,s)if(h&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===h.major&&e.semver.minor===h.minor&&e.semver.patch===h.patch&&(h=!1),">"===e.operator||">="===e.operator){if(o=Ch(s,e,n),o===e&&o!==s)return!1}else if(">="===s.operator&&!Th(s.semver,String(e),n))return!1;if(a)if(d&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===d.major&&e.semver.minor===d.minor&&e.semver.patch===d.patch&&(d=!1),"<"===e.operator||"<="===e.operator){if(l=Rh(a,e,n),l===e&&l!==a)return!1}else if("<="===a.operator&&!Th(a.semver,String(e),n))return!1;if(!e.operator&&(a||s)&&0!==i)return!1}return!(s&&c&&!a&&0!==i)&&(!(a&&u&&!s&&0!==i)&&(!h&&!d))},Ch=(e,t,n)=>{if(!e)return t;const r=xh(e.semver,t.semver,n);return r>0?e:r<0||">"===t.operator&&">="===e.operator?t:e},Rh=(e,t,n)=>{if(!e)return t;const r=xh(e.semver,t.semver,n);return r<0?e:r>0||"<"===t.operator&&"<="===e.operator?t:e};var Nh=(e,t,n={})=>{if(e===t)return!0;e=new Eh(e,n),t=new Eh(t,n);let r=!1;e:for(const s of e.set){for(const e of t.set){const t=Ph(s,e,n);if(r=r||null!==t,t)continue e}if(r)return!1}return!0};const $h=_u,jh=wu,Lh=ju,Mh=xu,Dh=(e,t,n)=>{const r=[];let s=null,a=null;const i=e.sort(((e,t)=>kh(e,t,n)));for(const e of i){_h(e,t,n)?(a=e,s||(s=e)):(a&&r.push([s,a]),a=null,s=null)}s&&r.push([s,null]);const o=[];for(const[e,t]of r)e===t?o.push(e):t||e!==i[0]?t?e===i[0]?o.push(`<=${t}`):o.push(`${e} - ${t}`):o.push(`>=${e}`):o.push("*");const l=o.join(" || "),c="string"==typeof t.raw?t.raw:String(t);return l.length<c.length?l:t};var Uh={parse:Mu,valid:Uu,clean:Bu,inc:zu,diff:Wu,major:Vu,minor:Zu,patch:Xu,prerelease:Qu,compare:td,rcompare:rd,compareLoose:ad,compareBuild:od,sort:cd,rsort:dd,gt:pd,lt:md,eq:yd,neq:wd,gte:_d,lte:Ed,cmp:Pd,coerce:jd,Comparator:qd(),Range:Bd(),satisfies:Hd,toComparators:Kd,maxSatisfying:Zd,minSatisfying:Yd,minVersion:nh,validRange:sh,outside:fh,gtr:gh,ltr:bh,intersects:vh,simplifyRange:Dh,subset:Nh,SemVer:Lh,re:$h.re,src:$h.src,tokens:$h.t,SEMVER_SPEC_VERSION:jh.SEMVER_SPEC_VERSION,RELEASE_TYPES:jh.RELEASE_TYPES,compareIdentifiers:Mh.compareIdentifiers,rcompareIdentifiers:Mh.rcompareIdentifiers};function Fh(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw new Error(`Invalid identifier format: ${e}`);const[t,n]=e.split(":"),r=n||"latest";if(t.includes("/")){const[n,s]=t.split("/",2);if(!n||!s)throw new Error(`Invalid identifier format: ${e}`);return[n,s,r]}if(!t)throw new Error(`Invalid identifier format: ${e}`);return["-",t,r]}class Bh extends Error{constructor(e){super(e),this.name="LangSmithConflictError"}}async function qh(e,t,n){let r;if(e.ok)return void(n&&(r=await e.text()));r=await e.text();const s=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${r}`;if(409===e.status)throw new Bh(s);throw new Error(s)}var zh="[...]",Hh={result:"[Circular]"},Wh=[],Kh=[];function Vh(e,t,n,r){try{return JSON.stringify(e,t,n)}catch(i){if(!i.message?.includes("Converting circular structure to JSON"))return console.warn("[WARNING]: LangSmith received unserializable value."),"[Unserializable]";var s;console.warn("[WARNING]: LangSmith received circular JSON. This will decrease tracer performance."),void 0===r&&(r={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),Zh(e,"",0,[],void 0,0,r);try{s=0===Kh.length?JSON.stringify(e,t,n):JSON.stringify(e,function(e){return e=void 0!==e?e:function(e,t){return t},function(t,n){if(Kh.length>0)for(var r=0;r<Kh.length;r++){var s=Kh[r];if(s[1]===t&&s[0]===n){n=s[2],Kh.splice(r,1);break}}return e.call(this,t,n)}}(t),n)}catch(e){return JSON.stringify("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==Wh.length;){var a=Wh.pop();4===a.length?Object.defineProperty(a[0],a[1],a[3]):a[0][a[1]]=a[2]}}return s}}function Gh(e,t,n,r){var s=Object.getOwnPropertyDescriptor(r,n);void 0!==s.get?s.configurable?(Object.defineProperty(r,n,{value:e}),Wh.push([r,n,t,s])):Kh.push([t,n,e]):(r[n]=e,Wh.push([r,n,t]))}function Zh(e,t,n,r,s,a,i){var o;if(a+=1,"object"==typeof e&&null!==e){for(o=0;o<r.length;o++)if(r[o]===e)return void Gh(Hh,e,t,s);if(void 0!==i.depthLimit&&a>i.depthLimit)return void Gh(zh,e,t,s);if(void 0!==i.edgesLimit&&n+1>i.edgesLimit)return void Gh(zh,e,t,s);if(r.push(e),Array.isArray(e))for(o=0;o<e.length;o++)Zh(e[o],o,o,r,e,a,i);else{var l=Object.keys(e);for(o=0;o<l.length;o++){var c=l[o];Zh(e[c],c,o,r,e,a,i)}}r.pop()}}function Jh(e){const t=function(){if(void 0===ap){const e=sp(),t=function(){if(void 0!==ip)return ip;const e=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],t={};for(const n of e){const e=op(n);void 0!==e&&(t[n]=e)}return ip=t,t}();ap={library:"langsmith",runtime:e,sdk:"langsmith-js",sdk_version:tp,...t}}return ap}(),n=function(){const e=function(){try{return"undefined"!=typeof process&&process.env?Object.entries(process.env).reduce(((e,[t,n])=>(e[t]=String(n),e)),{}):void 0}catch(e){return}}()||{},t={},n=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(const[r,s]of Object.entries(e))!r.startsWith("LANGCHAIN_")||"string"!=typeof s||n.includes(r)||r.toLowerCase().includes("key")||r.toLowerCase().includes("secret")||r.toLowerCase().includes("token")||("LANGCHAIN_REVISION_ID"===r?t.revision_id=s:t[r]=s);return t}(),r=e.extra??{},s=r.metadata;return e.extra={...r,runtime:{...t,...r?.runtime},metadata:{...n,...n.revision_id||e.revision_id?{revision_id:e.revision_id??n.revision_id}:{},...s}},e}function Xh(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}const Yh=async e=>{if(429===e?.status){const t=1e3*parseInt(e.headers.get("retry-after")??"30",10);if(t>0)return await new Promise((e=>setTimeout(e,t))),!0}return!1};class Qh{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t;const n=new Promise((e=>{t=e})),r=Vh(e.item).length;return this.items.push({action:e.action,payload:e.item,itemPromiseResolve:t,itemPromise:n,size:r}),this.sizeBytes+=r,n}pop(e){if(e<1)throw new Error("Number of bytes to pop off may not be less than 1.");const t=[];let n=0;for(;n+(this.peek()?.size??0)<e&&this.items.length>0;){const e=this.items.shift();e&&(t.push(e),n+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){const e=this.items.shift();t.push(e),n+=e.size,this.sizeBytes-=e.size}return[t.map((e=>({action:e.action,item:e.payload}))),()=>t.forEach((e=>e.itemPromiseResolve()))]}}class ep{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new Qh}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const t=ep.getDefaultClientConfig();this.tracingSampleRate=(()=>{const e=lp("TRACING_SAMPLING_RATE");if(void 0===e)return;const t=parseFloat(e);if(t<0||t>1)throw new Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${t}`);return t})(),this.apiUrl=Xh(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=Xh(e.apiKey??t.apiKey),this.webUrl=Xh(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.timeout_ms=e.timeout_ms??12e3,this.caller=new pu(e.callerOptions??{}),this.batchIngestCaller=new pu({...e.callerOptions??{},onFailedResponseHook:Yh}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){const e=lp("API_KEY");return{apiUrl:lp("ENDPOINT")??"https://api.smith.langchain.com",apiKey:e,webUrl:void 0,hideInputs:"true"===lp("HIDE_INPUTS"),hideOutputs:"true"===lp("HIDE_OUTPUTS")}}getHostUrl(){return this.webUrl?this.webUrl:(e=>{const t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})(this.apiUrl)?(this.webUrl="http://localhost:3000",this.webUrl):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com",this.webUrl):this.apiUrl.split(".",1)[0].includes("eu")?(this.webUrl="https://eu.smith.langchain.com",this.webUrl):(this.webUrl="https://smith.langchain.com",this.webUrl)}get headers(){const e={"User-Agent":`langsmith-js/${tp}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){const t={...e};return void 0!==t.inputs&&(t.inputs=this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){const n=t?.toString()??"",r=`${this.apiUrl}${e}?${n}`,s=await this.caller.call(uu(),r,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await qh(s,`Failed to fetch ${e}`),s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams,n){let r=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));const a=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(uu(),a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(i,`Failed to fetch ${e}`);const o=n?n(await i.json()):await i.json();if(0===o.length)break;if(yield o,o.length<s)break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,n="POST",r="runs"){const s=t?{...t}:{};for(;;){const t=await this.caller.call(uu(),`${this.apiUrl}${e}`,{method:n,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)}),a=await t.json();if(!a)break;if(!a[r])break;yield a[r];const i=a.cursors;if(!i)break;if(!i.next)break;s.cursor=i.next}}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){const t=[];for(const n of e)this.filteredPostUuids.has(n.id)?this.filteredPostUuids.delete(n.id):t.push(n);return t}{const t=[];for(const n of e)n.id!==n.trace_id&&!this.filteredPostUuids.has(n.trace_id)||Math.random()<this.tracingSampleRate?t.push(n):this.filteredPostUuids.add(n.id);return t}}async _getBatchSizeLimitBytes(){const e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??20971520}async drainAutoBatchQueue(){for(;this.autoBatchQueue.items.length>=0;){const[e,t]=this.autoBatchQueue.pop(await this._getBatchSizeLimitBytes());if(!e.length)return void t();try{const t={runCreates:e.filter((e=>"create"===e.action)).map((e=>e.item)),runUpdates:e.filter((e=>"update"===e.action)).map((e=>e.item))},n=await this._ensureServerInfo();n?.batch_ingest_config?.use_multipart_endpoint?await this.multipartIngestRuns(t):await this.batchIngestRuns(t)}finally{t()}}}async processRunOperation(e,t){const n=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,"create"===e.action&&(e.item=Jh(e.item));const r=this.autoBatchQueue.push(e),s=await this._getBatchSizeLimitBytes();return(t||this.autoBatchQueue.sizeBytes>s)&&await this.drainAutoBatchQueue().catch(console.error),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout((()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)}),n?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),r}async _getServerInfo(){const e=await uu()(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e3),...this.fetchOptions});return await qh(e,"get server info"),e.json()}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn("[WARNING]: LangSmith failed to fetch info on supported operations. Falling back to single calls and default limits.")}return this._serverInfo??{}})()),this._getServerInfoPromise.then((e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e)))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async createRun(e){if(!this._filterForSampling([e]).length)return;const t={...this.headers,"Content-Type":"application/json"},n=e.project_name;delete e.project_name;const r=this.prepareRunCreateOrUpdateInputs({session_name:n,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==r.trace_id&&void 0!==r.dotted_order)return void this.processRunOperation({action:"create",item:r}).catch(console.error);const s=Jh(r),a=await this.caller.call(uu(),`${this.apiUrl}/runs`,{method:"POST",headers:t,body:Vh(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(a,"create run",!0)}async batchIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;let n=e?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[],r=t?.map((e=>this.prepareRunCreateOrUpdateInputs(e)))??[];if(n.length>0&&r.length>0){const e=n.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of r)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);n=Object.values(e),r=t}const s={post:this._filterForSampling(n),patch:this._filterForSampling(r,!0)};if(!s.post.length&&!s.patch.length)return;if(void 0===(await this._ensureServerInfo()).version){this.autoBatchTracing=!1;for(const e of s.post)await this.createRun(e);for(const e of s.patch)void 0!==e.id&&await this.updateRun(e.id,e);return}const a={post:[],patch:[]};for(const e of["post","patch"]){const t=e,n=s[t].reverse();let r=n.pop();for(;void 0!==r;)a[t].push(r),r=n.pop()}(a.post.length>0||a.patch.length>0)&&await this._postBatchIngestRuns(Vh(a))}async _postBatchIngestRuns(e){const t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},n=await this.batchIngestCaller.call(uu(),`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(n,"batch create run",!0)}async multipartIngestRuns({runCreates:e,runUpdates:t}){if(void 0===e&&void 0===t)return;const n={};let r=[];for(const t of e??[]){const e=this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(n[e.id]=e.attachments),delete e.attachments,r.push(e)}let s=[];for(const e of t??[])s.push(this.prepareRunCreateOrUpdateInputs(e));if(void 0!==r.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==s.find((e=>void 0===e.trace_id||void 0===e.dotted_order)))throw new Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(r.length>0&&s.length>0){const e=r.reduce(((e,t)=>t.id?(e[t.id]=t,e):e),{}),t=[];for(const n of s)void 0!==n.id&&e[n.id]?e[n.id]={...e[n.id],...n}:t.push(n);r=Object.values(e),s=t}if(0===r.length&&0===s.length)return;const a=[],i=[];for(const[e,t]of[["post",r],["patch",s]])for(const r of t){const{inputs:t,outputs:s,events:o,...l}=r,c={inputs:t,outputs:s,events:o},u=Vh(l);i.push({name:`${e}.${l.id}`,payload:new Blob([u],{type:`application/json; length=${u.length}`})});for(const[t,n]of Object.entries(c)){if(void 0===n)continue;const r=Vh(n);i.push({name:`${e}.${l.id}.${t}`,payload:new Blob([r],{type:`application/json; length=${r.length}`})})}if(void 0!==l.id){const e=n[l.id];if(e){delete n[l.id];for(const[t,[n,r]]of Object.entries(e))i.push({name:`attachment.${l.id}.${t}`,payload:new Blob([r],{type:`${n}; length=${r.length}`})})}}a.push(`trace=${l.trace_id},id=${l.id}`)}await this._sendMultipartRequest(i,a.join("; "))}async _sendMultipartRequest(e,t){try{const t=new FormData;for(const n of e)t.append(n.name,n.payload);await this.batchIngestCaller.call(uu(),`${this.apiUrl}/runs/multipart`,{method:"POST",headers:{...this.headers},body:t,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})}catch(e){let n="Failed to multipart ingest runs";e instanceof Error?n+=`: ${e.stack||e.message}`:n+=`: ${String(e)}`,console.warn(`${n.trim()}\n\nContext: ${t}`)}}async updateRun(e,t){gu(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));const n={...t,id:e};if(!this._filterForSampling([n],!0).length)return;if(this.autoBatchTracing&&void 0!==n.trace_id&&void 0!==n.dotted_order)return void 0!==t.end_time&&void 0===n.parent_run_id&&this.blockOnRootRunFinalization?void await this.processRunOperation({action:"update",item:n},!0):void this.processRunOperation({action:"update",item:n}).catch(console.error);const r={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(uu(),`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:Vh(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(s,"update run",!0)}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){gu(e);let n=await this._get(`/runs/${e}`);return t&&n.child_run_ids&&(n=await this._loadChildRuns(n)),n}async getRunUrl({runId:e,run:t,projectOpts:n}){if(void 0!==t){let e;if(t.session_id)e=t.session_id;else if(n?.projectName)e=(await this.readProject({projectName:n?.projectName})).id;else if(n?.projectId)e=n?.projectId;else{e=(await this.readProject({projectName:lp("PROJECT")||"default"})).id}const r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){const t=await this.readRun(e);if(!t.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${t.app_path}`}throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await async function(e){const t=[];for await(const n of e)t.push(n);return t}(this.listRuns({id:e.child_run_ids})),n={},r={};t.sort(((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")));for(const e of t){if(null===e.parent_run_id||void 0===e.parent_run_id)throw new Error(`Child run ${e.id} has no parent`);e.parent_run_id in n||(n[e.parent_run_id]=[]),n[e.parent_run_id].push(e),r[e.id]=e}e.child_runs=n[e.id]||[];for(const t in n)t!==e.id&&(r[t].child_runs=n[t]);return e}async*listRuns(e){const{projectId:t,projectName:n,parentRunId:r,traceId:s,referenceExampleId:a,startTime:i,executionOrder:o,isRoot:l,runType:c,error:u,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:y}=e;let b=[];if(t&&(b=Array.isArray(t)?t:[t]),n){const e=Array.isArray(n)?n:[n],t=await Promise.all(e.map((e=>this.readProject({projectName:e}).then((e=>e.id)))));b.push(...t)}const w={session:b.length?b:null,run_type:c,reference_example:a,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:r,start_time:i?i.toISOString():null,error:u,id:d,limit:g,trace:s,select:y||["app_path","child_run_ids","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:l};let v=0;for await(const e of this._getCursorPaginatedList("/runs/query",w))if(g){if(v>=g)break;if(e.length+v>g){const t=e.slice(0,g-v);yield*t;break}v+=e.length,yield*e}else yield*e}async getRunStats({id:e,trace:t,parentRun:n,runType:r,projectNames:s,projectIds:a,referenceExampleIds:i,startTime:o,endTime:l,error:c,query:u,filter:d,traceFilter:h,treeFilter:p,isRoot:f,dataSourceType:m}){let g=a||[];s&&(g=[...a||[],...await Promise.all(s.map((e=>this.readProject({projectName:e}).then((e=>e.id)))))]);const y={id:e,trace:t,parent_run:n,run_type:r,session:g,reference_example:i,start_time:o,end_time:l,error:c,query:u,filter:d,trace_filter:h,tree_filter:p,is_root:f,data_source_type:m},b=Object.fromEntries(Object.entries(y).filter((([e,t])=>void 0!==t))),w=await this.caller.call(uu(),`${this.apiUrl}/runs/stats`,{method:"POST",headers:this.headers,body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await w.json()}async shareRun(e,{shareId:t}={}){const n={run_id:e,share_token:t||s.v4()};gu(e);const r=await this.caller.call(uu(),`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await r.json();if(null===a||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){gu(e);const t=await this.caller.call(uu(),`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(t,"unshare run",!0)}async readRunSharedLink(e){gu(e);const t=await this.caller.call(uu(),`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(null!==n&&"share_token"in n)return`${this.getHostUrl()}/public/${n.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const n=new URLSearchParams({share_token:e});if(void 0!==t)for(const e of t)n.append("id",e);gu(e);const r=await this.caller.call(uu(),`${this.apiUrl}/public/${e}/runs${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await r.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}gu(e);const n=await this.caller.call(uu(),`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),r=await n.json();return r.url=`${this.getHostUrl()}/public/${r.share_token}/d`,r}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");if(!e){e=(await this.readDataset({datasetName:t})).id}const n={dataset_id:e};gu(e);const r=await this.caller.call(uu(),`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(n),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),s=await r.json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){gu(e);const t=await this.caller.call(uu(),`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(t,"unshare dataset",!0)}async readSharedDataset(e){gu(e);const t=await this.caller.call(uu(),`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await t.json()}async listSharedExamples(e,t){const n={};t?.exampleIds&&(n.id=t.exampleIds);const r=new URLSearchParams;Object.entries(n).forEach((([e,t])=>{Array.isArray(t)?t.forEach((t=>r.append(e,t))):r.append(e,t)}));const s=await this.caller.call(uu(),`${this.apiUrl}/public/${e}/examples?${r.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),a=await s.json();if(!s.ok){if("detail"in a)throw new Error(`Failed to list shared examples.\nStatus: ${s.status}\nMessage: ${a.detail.join("\n")}`);throw new Error(`Failed to list shared examples: ${s.status} ${s.statusText}`)}return a.map((e=>({...e,_hostUrl:this.getHostUrl()})))}async createProject({projectName:e,description:t=null,metadata:n=null,upsert:r=!1,projectExtra:s=null,referenceDatasetId:a=null}){const i=r?"?upsert=true":"",o=`${this.apiUrl}/sessions${i}`,l=s||{};n&&(l.metadata=n);const c={name:e,extra:l,description:t};null!==a&&(c.reference_dataset_id=a);const u=await this.caller.call(uu(),o,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(u,"create project");return await u.json()}async updateProject(e,{name:t=null,description:n=null,metadata:r=null,projectExtra:s=null,endTime:a=null}){const i=`${this.apiUrl}/sessions/${e}`;let o=s;r&&(o={...o||{},metadata:r});const l={name:t,extra:o,description:n,end_time:a?new Date(a).toISOString():null},c=await this.caller.call(uu(),i,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(c,"update project");return await c.json()}async hasProject({projectId:e,projectName:t}){let n="/sessions";const r=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)gu(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");r.append("name",t)}const s=await this.caller.call(uu(),`${this.apiUrl}${n}?${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{const e=await s.json();return!!s.ok&&(!Array.isArray(e)||e.length>0)}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:n}){let r="/sessions";const s=new URLSearchParams;if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");if(void 0!==e)gu(e),r+=`/${e}`;else{if(void 0===t)throw new Error("Must provide projectName or projectId");s.append("name",t)}void 0!==n&&s.append("include_stats",n.toString());const a=await this._get(r,s);let i;if(Array.isArray(a)){if(0===a.length)throw new Error(`Project[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either projectName or projectId");const n=await this.readProject({projectId:e,projectName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/projects/p/${n.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw new Error("Must provide either datasetName or datasetId");const n=await this.readDataset({datasetId:e,datasetName:t}),r=await this._getTenantId();return`${this.getHostUrl()}/o/${r}/datasets/${n.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:n,referenceDatasetId:r,referenceDatasetName:s,referenceFree:a,metadata:i}={}){const o=new URLSearchParams;if(void 0!==e)for(const t of e)o.append("id",t);if(void 0!==t&&o.append("name",t),void 0!==n&&o.append("name_contains",n),void 0!==r)o.append("reference_dataset",r);else if(void 0!==s){const e=await this.readDataset({datasetName:s});o.append("reference_dataset",e.id)}void 0!==a&&o.append("reference_free",a.toString()),void 0!==i&&o.append("metadata",JSON.stringify(i));for await(const e of this._getPaginated("/sessions",o))yield*e}async deleteProject({projectId:e,projectName:t}){let n;if(void 0===e&&void 0===t)throw new Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw new Error("Must provide either projectName or projectId, not both");n=void 0===e?(await this.readProject({projectName:t})).id:e,gu(n);const r=await this.caller.call(uu(),`${this.apiUrl}/sessions/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(r,`delete session ${n} (${t})`,!0)}async uploadCsv({csvFile:e,fileName:t,inputKeys:n,outputKeys:r,description:s,dataType:a,name:i}){const o=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),n.forEach((e=>{l.append("input_keys",e)})),r.forEach((e=>{l.append("output_keys",e)})),s&&l.append("description",s),a&&l.append("data_type",a),i&&l.append("name",i);const c=await this.caller.call(uu(),o,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(c,"upload CSV");return await c.json()}async createDataset(e,{description:t,dataType:n,inputsSchema:r,outputsSchema:s,metadata:a}={}){const i={name:e,description:t,extra:a?{metadata:a}:void 0};n&&(i.data_type=n),r&&(i.inputs_schema_definition=r),s&&(i.outputs_schema_definition=s);const o=await this.caller.call(uu(),`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(o,"create dataset");return await o.json()}async readDataset({datasetId:e,datasetName:t}){let n="/datasets";const r=new URLSearchParams({limit:"1"});if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)gu(e),n+=`/${e}`;else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");r.append("name",t)}const s=await this._get(n,r);let a;if(Array.isArray(s)){if(0===s.length)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=s[0]}else a=s;return a}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:n,toVersion:r}){let s=e;if(void 0===s&&void 0===t)throw new Error("Must provide either datasetName or datasetId");if(void 0!==s&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===s){s=(await this.readDataset({datasetName:t})).id}const a=new URLSearchParams({from_version:"string"==typeof n?n:n.toISOString(),to_version:"string"==typeof r?r:r.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,a)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else{if(void 0===t)throw new Error("Must provide datasetName or datasetId");e=(await this.readDataset({datasetName:t})).id}const n=await this._getResponse(`/datasets/${e}/openai_ft`);return(await n.text()).trim().split("\n").map((e=>JSON.parse(e)))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:n,datasetName:r,datasetNameContains:s,metadata:a}={}){const i=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==n)for(const e of n)i.append("id",e);void 0!==r&&i.append("name",r),void 0!==s&&i.append("name_contains",s),void 0!==a&&i.append("metadata",JSON.stringify(a));for await(const e of this._getPaginated("/datasets",i))yield*e}async updateDataset(e){const{datasetId:t,datasetName:n,...r}=e;if(!t&&!n)throw new Error("Must provide either datasetName or datasetId");const s=t??(await this.readDataset({datasetName:n})).id;gu(s);const a=await this.caller.call(uu(),`${this.apiUrl}/datasets/${s}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await qh(a,"update dataset"),await a.json()}async deleteDataset({datasetId:e,datasetName:t}){let n="/datasets",r=e;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==t){r=(await this.readDataset({datasetName:t})).id}if(void 0===r)throw new Error("Must provide datasetName or datasetId");gu(r),n+=`/${r}`;const s=await this.caller.call(uu(),this.apiUrl+n,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(s,`delete ${n}`),await s.json()}async indexDataset({datasetId:e,datasetName:t,tag:n}){let r=e;if(!r&&!t)throw new Error("Must provide either datasetName or datasetId");if(r&&t)throw new Error("Must provide either datasetName or datasetId, not both");if(!r){r=(await this.readDataset({datasetName:t})).id}gu(r);const s={tag:n},a=await this.caller.call(uu(),`${this.apiUrl}/datasets/${r}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(a,"index dataset"),await a.json()}async similarExamples(e,t,n,{filter:r}={}){const s={limit:n,inputs:e};void 0!==r&&(s.filter=r),gu(t);const a=await this.caller.call(uu(),`${this.apiUrl}/datasets/${t}/search`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(a,"fetch similar examples");return(await a.json()).examples}async createExample(e,t,{datasetId:n,datasetName:r,createdAt:s,exampleId:a,metadata:i,split:o,sourceRunId:l}){let c=n;if(void 0===c&&void 0===r)throw new Error("Must provide either datasetName or datasetId");if(void 0!==c&&void 0!==r)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===c){c=(await this.readDataset({datasetName:r})).id}const u=s||new Date,d={dataset_id:c,inputs:e,outputs:t,created_at:u?.toISOString(),id:a,metadata:i,split:o,source_run_id:l},h=await this.caller.call(uu(),`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(d),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(h,"create example");return await h.json()}async createExamples(e){const{inputs:t,outputs:n,metadata:r,sourceRunIds:s,exampleIds:a,datasetId:i,datasetName:o}=e;let l=i;if(void 0===l&&void 0===o)throw new Error("Must provide either datasetName or datasetId");if(void 0!==l&&void 0!==o)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===l){const e=await this.readDataset({datasetName:o});l=e.id}const c=t.map(((t,i)=>({dataset_id:l,inputs:t,outputs:n?n[i]:void 0,metadata:r?r[i]:void 0,split:e.splits?e.splits[i]:void 0,id:a?a[i]:void 0,source_run_id:s?s[i]:void 0}))),u=await this.caller.call(uu(),`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(u,"create examples");return await u.json()}async createLLMExample(e,t,n){return this.createExample({input:e},{output:t},n)}async createChatExample(e,t,n){const r=e.map((e=>fu(e)?mu(e):e)),s=fu(t)?mu(t):t;return this.createExample({input:r},{output:s},n)}async readExample(e){gu(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:n,asOf:r,splits:s,inlineS3Urls:a,metadata:i,limit:o,offset:l,filter:c}={}){let u;if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)u=e;else{if(void 0===t)throw new Error("Must provide a datasetName or datasetId");u=(await this.readDataset({datasetName:t})).id}const d=new URLSearchParams({dataset:u}),h=r?"string"==typeof r?r:r?.toISOString():void 0;h&&d.append("as_of",h);const p=a??!0;if(d.append("inline_s3_urls",p.toString()),void 0!==n)for(const e of n)d.append("id",e);if(void 0!==s)for(const e of s)d.append("splits",e);if(void 0!==i){const e=JSON.stringify(i);d.append("metadata",e)}void 0!==o&&d.append("limit",o.toString()),void 0!==l&&d.append("offset",l.toString()),void 0!==c&&d.append("filter",c);let f=0;for await(const e of this._getPaginated("/examples",d)){for(const t of e)yield t,f++;if(void 0!==o&&f>=o)break}}async deleteExample(e){gu(e);const t=`/examples/${e}`,n=await this.caller.call(uu(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(n,`delete ${t}`),await n.json()}async updateExample(e,t){gu(e);const n=await this.caller.call(uu(),`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(n,"update example");return await n.json()}async updateExamples(e){const t=await this.caller.call(uu(),`${this.apiUrl}/examples/bulk`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(e),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(t,"update examples");return await t.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:n}){let r;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){r=(await this.readDataset({datasetName:t})).id}else r=e;gu(r);const s=new URLSearchParams,a=n?"string"==typeof n?n:n?.toISOString():void 0;a&&s.append("as_of",a);return await this._get(`/datasets/${r}/splits`,s)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:n,exampleIds:r,remove:s=!1}){let a;if(void 0===e&&void 0===t)throw new Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw new Error("Must provide either datasetName or datasetId, not both");if(void 0===e){a=(await this.readDataset({datasetName:t})).id}else a=e;gu(a);const i={split_name:n,examples:r.map((e=>(gu(e),e))),remove:s},o=await this.caller.call(uu(),`${this.apiUrl}/datasets/${a}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(o,"update dataset splits",!0)}async evaluateRun(e,t,{sourceInfo:n,loadChildRuns:r,referenceExample:s}={loadChildRuns:!1}){var a;let i;if(yu[a="This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."]||(console.warn(a),yu[a]=!0),"string"==typeof e)i=await this.readRun(e,{loadChildRuns:r});else{if("object"!=typeof e||!("id"in e))throw new Error("Invalid run type: "+typeof e);i=e}null!==i.reference_example_id&&void 0!==i.reference_example_id&&(s=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,s),[l,c]=await this._logEvaluationFeedback(o,i,n);return c[0]}async createFeedback(e,t,{score:n,value:r,correction:a,comment:i,sourceInfo:o,feedbackSourceType:l="api",sourceRunId:c,feedbackId:u,feedbackConfig:d,projectId:h,comparativeExperimentId:p}){if(!e&&!h)throw new Error("One of runId or projectId must be provided");if(e&&h)throw new Error("Only one of runId or projectId can be provided");const f={type:l??"api",metadata:o??{}};void 0===c||void 0===f?.metadata||f.metadata.__run||(f.metadata.__run={run_id:c}),void 0!==f?.metadata&&void 0!==f.metadata.__run?.run_id&&gu(f.metadata.__run.run_id);const m={id:u??s.v4(),run_id:e,key:t,score:n,value:r,correction:a,comment:i,feedback_source:f,comparative_experiment_id:p,feedbackConfig:d,session_id:h},g=`${this.apiUrl}/feedback`,y=await this.caller.call(uu(),g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(m),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await qh(y,"create feedback",!0),m}async updateFeedback(e,{score:t,value:n,correction:r,comment:s}){const a={};null!=t&&(a.score=t),null!=n&&(a.value=n),null!=r&&(a.correction=r),null!=s&&(a.comment=s),gu(e);const i=await this.caller.call(uu(),`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(i,"update feedback",!0)}async readFeedback(e){gu(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){gu(e);const t=`/feedback/${e}`,n=await this.caller.call(uu(),this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(n,`delete ${t}`),await n.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:n}={}){const r=new URLSearchParams;if(e&&r.append("run",e.join(",")),t)for(const e of t)r.append("key",e);if(n)for(const e of n)r.append("source",e);for await(const e of this._getPaginated("/feedback",r))yield*e}async createPresignedFeedbackToken(e,t,{expiration:n,feedbackConfig:r}={}){const s={run_id:e,feedback_key:t,feedback_config:r};n?"string"==typeof n?s.expires_at=n:(n?.hours||n?.minutes||n?.days)&&(s.expires_in=n):s.expires_in={hours:3};const a=await this.caller.call(uu(),`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await a.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:n,createdAt:r,description:s,metadata:a,id:i}){if(0===t.length)throw new Error("At least one experiment is required");if(n||(n=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!n)throw new Error("A reference dataset is required");const o={id:i,name:e,experiment_ids:t,reference_dataset_id:n,description:s,created_at:(r??new Date)?.toISOString(),extra:{}};a&&(o.extra.metadata=a);const l=await this.caller.call(uu(),`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await l.json()}async*listPresignedFeedbackTokens(e){gu(e);const t=new URLSearchParams({run_id:e});for await(const e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){let t;return t="results"in e?e.results:[e],t}async _logEvaluationFeedback(e,t,n){const r=this._selectEvalResults(e),s=[];for(const e of r){let r=n||{};e.evaluatorInfo&&(r={...e.evaluatorInfo,...r});let a=null;e.targetRunId?a=e.targetRunId:t&&(a=t.id),s.push(await this.createFeedback(a,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:r,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[r,s]}async logEvaluationFeedback(e,t,n){const[r]=await this._logEvaluationFeedback(e,t,n);return r}async*listAnnotationQueues(e={}){const{queueIds:t,name:n,nameContains:r,limit:s}=e,a=new URLSearchParams;t&&t.forEach(((e,t)=>{gu(e,`queueIds[${t}]`),a.append("ids",e)})),n&&a.append("name",n),r&&a.append("name_contains",r),a.append("limit",(void 0!==s?Math.min(s,100):100).toString());let i=0;for await(const e of this._getPaginated("/annotation-queues",a))if(yield*e,i++,void 0!==s&&i>=s)break}async createAnnotationQueue(e){const{name:t,description:n,queueId:r}=e,a={name:t,description:n,id:r||s.v4()},i=await this.caller.call(uu(),`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(Object.fromEntries(Object.entries(a).filter((([e,t])=>void 0!==t)))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(i,"create annotation queue");return await i.json()}async readAnnotationQueue(e){const t=await this.listAnnotationQueues({queueIds:[e]}).next();if(t.done)throw new Error(`Annotation queue with ID ${e} not found`);return t.value}async updateAnnotationQueue(e,t){const{name:n,description:r}=t,s=await this.caller.call(uu(),`${this.apiUrl}/annotation-queues/${gu(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify({name:n,description:r}),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(s,"update annotation queue")}async deleteAnnotationQueue(e){const t=await this.caller.call(uu(),`${this.apiUrl}/annotation-queues/${gu(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(t,"delete annotation queue")}async addRunsToAnnotationQueue(e,t){const n=await this.caller.call(uu(),`${this.apiUrl}/annotation-queues/${gu(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t.map(((e,t)=>gu(e,`runIds[${t}]`).toString()))),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(n,"add runs to annotation queue")}async getRunFromAnnotationQueue(e,t){const n=`/annotation-queues/${gu(e,"queueId")}/run`,r=await this.caller.call(uu(),`${this.apiUrl}${n}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await qh(r,"get run from annotation queue"),await r.json()}async _currentTenantIsOwner(e){const t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){const n=await this._getSettings();return new Error(`Cannot ${e} for another tenant.\n\n      Current tenant: ${n.tenant_handle}\n\n      Requested tenant: ${t}`)}async _getLatestCommitHash(e){const t=await this.caller.call(uu(),`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),n=await t.json();if(!t.ok){const e="string"==typeof n.detail?n.detail:JSON.stringify(n.detail),r=new Error(`Error ${t.status}: ${t.statusText}\n${e}`);throw r.statusCode=t.status,r}if(0!==n.commits.length)return n.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){const[n,r,s]=Fh(e),a=await this.caller.call(uu(),`${this.apiUrl}/likes/${n}/${r}`,{method:"POST",body:JSON.stringify({like:t}),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await qh(a,(t?"like":"unlike")+" prompt"),await a.json()}async _getPromptUrl(e){const[t,n,r]=Fh(e);if(await this._currentTenantIsOwner(t)){const e=await this._getSettings();return"latest"!==r?`${this.getHostUrl()}/prompts/${n}/${r.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${n}?organizationId=${e.id}`}return"latest"!==r?`${this.getHostUrl()}/hub/${t}/${n}/${r.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${n}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async*listCommits(e){for await(const t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,(e=>e.commits)))yield*t}async*listPrompts(e){const t=new URLSearchParams;t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),void 0!==e?.isPublic&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query);for await(const e of this._getPaginated("/repos",t,(e=>e.repos)))yield*e}async getPrompt(e){const[t,n,r]=Fh(e),s=await this.caller.call(uu(),`${this.apiUrl}/repos/${t}/${n}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(404===s.status)return null;await qh(s,"get prompt");const a=await s.json();return a.repo?a.repo:null}async createPrompt(e,t){const n=await this._getSettings();if(t?.isPublic&&!n.tenant_handle)throw new Error("Cannot create a public prompt without first\n\n        creating a LangChain Hub handle. \n        You can add a handle by creating a public prompt at:\n\n        https://smith.langchain.com/prompts");const[r,s,a]=Fh(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("create a prompt",r);const i={repo_handle:s,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic},o=await this.caller.call(uu(),`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(o,"create prompt");const{repo:l}=await o.json();return l}async createCommit(e,t,n){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[r,s,a]=Fh(e),i="latest"!==n?.parentCommitHash&&n?.parentCommitHash?n?.parentCommitHash:await this._getLatestCommitHash(`${r}/${s}`),o={manifest:JSON.parse(JSON.stringify(t)),parent_commit:i},l=await this.caller.call(uu(),`${this.apiUrl}/commits/${r}/${s}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(o),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(l,"create commit");const c=await l.json();return this._getPromptUrl(`${r}/${s}${c.commit_hash?`:${c.commit_hash}`:""}`)}async updatePrompt(e,t){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[n,r]=Fh(e);if(!await this._currentTenantIsOwner(n))throw await this._ownerConflictError("update a prompt",n);const s={};if(void 0!==t?.description&&(s.description=t.description),void 0!==t?.readme&&(s.readme=t.readme),void 0!==t?.tags&&(s.tags=t.tags),void 0!==t?.isPublic&&(s.is_public=t.isPublic),void 0!==t?.isArchived&&(s.is_archived=t.isArchived),0===Object.keys(s).length)throw new Error("No valid update options provided");const a=await this.caller.call(uu(),`${this.apiUrl}/repos/${n}/${r}`,{method:"PATCH",body:JSON.stringify(s),headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await qh(a,"update prompt"),a.json()}async deletePrompt(e){if(!await this.promptExists(e))throw new Error("Prompt does not exist, you must create it first.");const[t,n,r]=Fh(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);const s=await this.caller.call(uu(),`${this.apiUrl}/repos/${t}/${n}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await s.json()}async pullPromptCommit(e,t){const[n,r,s]=Fh(e);let a=s;if(!function(e,t){const n=Uh.parse(e),r=Uh.parse(t);if(!n||!r)throw new Error("Invalid version format.");return n.compare(r)>=0}((await this._getServerInfo()).version,"0.5.23")&&"latest"===s){const e=await this._getLatestCommitHash(`${n}/${r}`);if(!e)throw new Error("No commits found");a=e}const i=await this.caller.call(uu(),`${this.apiUrl}/commits/${n}/${r}/${a}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await qh(i,"pull prompt commit");const o=await i.json();return{owner:n,repo:r,commit_hash:o.commit_hash,manifest:o.manifest,examples:o.examples}}async _pullPrompt(e,t){const n=await this.pullPromptCommit(e,{includeModel:t?.includeModel});return JSON.stringify(n.manifest)}async pushPrompt(e,t){if(await this.promptExists(e)?t&&Object.keys(t).some((e=>"object"!==e))&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),!t?.object)return await this._getPromptUrl(e);return await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash})}async clonePublicDataset(e,t={}){const{sourceApiUrl:n=this.apiUrl,datasetName:r}=t,[s,a]=this.parseTokenOrUrl(e,n),i=new ep({apiUrl:s,apiKey:"placeholder"}),o=await i.readSharedDataset(a),l=r||o.name;try{if(await this.hasDataset({datasetId:l}))return void console.log(`Dataset ${l} already exists in your tenant. Skipping.`)}catch(e){}const c=await i.listSharedExamples(a),u=await this.createDataset(l,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:c.map((e=>e.inputs)),outputs:c.flatMap((e=>e.outputs?[e.outputs]:[])),datasetId:u.id})}catch(e){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,n=2,r="dataset"){try{return gu(e),[t,e]}catch(e){}try{const s=new URL(e).pathname.split("/").filter((e=>""!==e));if(s.length>=n){return[t,s[s.length-n]]}throw new Error(`Invalid public ${r} URL: ${e}`)}catch(t){throw new Error(`Invalid public ${r} URL or token: ${e}`)}}awaitPendingTraceBatches(){return Promise.all(this.autoBatchQueue.items.map((({itemPromise:e})=>e)))}}const tp="0.1.68";let np;const rp=()=>"undefined"!=typeof Deno,sp=()=>np||(np="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||rp()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":rp()?"deno":"other":"node",np);let ap,ip;function op(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function lp(e){return op(`LANGSMITH_${e}`)||op(`LANGCHAIN_${e}`)}const cp=Symbol.for("ls:tracing_async_local_storage"),up=new class{getStore(){}run(e,t){return t()}};const dp=new class{getInstance(){return globalThis[cp]??up}initializeGlobalInstance(e){void 0===globalThis[cp]&&(globalThis[cp]=e)}};function hp(e){return"function"==typeof e&&"langsmith:traceable"in e}
/*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   */const pp=Object.prototype.hasOwnProperty;function fp(e,t){return pp.call(e,t)}function mp(e){if(Array.isArray(e)){const t=new Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let n in e)fp(e,n)&&t.push(n);return t}function gp(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function yp(e){let t=0;const n=e.length;let r;for(;t<n;){if(r=e.charCodeAt(t),!(r>=48&&r<=57))return!1;t++}return!0}function bp(e){return-1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function wp(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function vp(e){if(void 0===e)return!0;if(e)if(Array.isArray(e)){for(let t=0,n=e.length;t<n;t++)if(vp(e[t]))return!0}else if("object"==typeof e){const n=mp(e),r=n.length;for(var t=0;t<r;t++)if(vp(e[n[t]]))return!0}return!1}function _p(e,t){const n=[e];for(const e in t){const r="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==r&&n.push(`${e}: ${r}`)}return n.join("\n")}class kp extends Error{constructor(e,t,n,r,s){super(_p(e,{name:t,index:n,operation:r,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=_p(e,{name:t,index:n,operation:r,tree:s})}}const Ep=kp,Op={add:function(e,t,n){return e[t]=this.value,{newDocument:n}},remove:function(e,t,n){var r=e[t];return delete e[t],{newDocument:n,removed:r}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:function(e,t,n){let r=Tp(n,this.path);r&&(r=gp(r));const s=xp(n,{op:"remove",path:this.from}).removed;return xp(n,{op:"add",path:this.path,value:s}),{newDocument:n,removed:r}},copy:function(e,t,n){const r=Tp(n,this.from);return xp(n,{op:"add",path:this.path,value:gp(r)}),{newDocument:n}},test:function(e,t,n){return{newDocument:n,test:Pp(e[t],this.value)}},_get:function(e,t,n){return this.value=e[t],{newDocument:n}}};var Sp={add:function(e,t,n){return yp(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:n,index:t}},remove:function(e,t,n){return{newDocument:n,removed:e.splice(t,1)[0]}},replace:function(e,t,n){var r=e[t];return e[t]=this.value,{newDocument:n,removed:r}},move:Op.move,copy:Op.copy,test:Op.test,_get:Op._get};function Tp(e,t){if(""==t)return e;var n={op:"_get",path:t};return xp(e,n),n.value}function xp(e,t,n=!1,r=!0,s=!0,a=0){if(n&&("function"==typeof n?n(t,0,e,t.path):Ip(t,0)),""===t.path){let r={newDocument:e};if("add"===t.op)return r.newDocument=t.value,r;if("replace"===t.op)return r.newDocument=t.value,r.removed=e,r;if("move"===t.op||"copy"===t.op)return r.newDocument=Tp(e,t.from),"move"===t.op&&(r.removed=e),r;if("test"===t.op){if(r.test=Pp(e,t.value),!1===r.test)throw new Ep("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r.newDocument=e,r}if("remove"===t.op)return r.removed=e,r.newDocument=null,r;if("_get"===t.op)return t.value=e,r;if(n)throw new Ep("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,t,e);return r}{r||(e=gp(e));const i=(t.path||"").split("/");let o,l,c,u=e,d=1,h=i.length;for(c="function"==typeof n?n:Ip;;){if(l=i[d],l&&-1!=l.indexOf("~")&&(l=wp(l)),s&&("__proto__"==l||"prototype"==l&&d>0&&"constructor"==i[d-1]))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(n&&void 0===o&&(void 0===u[l]?o=i.slice(0,d).join("/"):d==h-1&&(o=t.path),void 0!==o&&c(t,0,e,o)),d++,Array.isArray(u)){if("-"===l)l=u.length;else{if(n&&!yp(l))throw new Ep("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,t,e);yp(l)&&(l=~~l)}if(d>=h){if(n&&"add"===t.op&&l>u.length)throw new Ep("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,t,e);const r=Sp[t.op].call(t,u,l,e);if(!1===r.test)throw new Ep("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return r}}else if(d>=h){const n=Op[t.op].call(t,u,l,e);if(!1===n.test)throw new Ep("Test operation failed","TEST_OPERATION_FAILED",a,t,e);return n}if(u=u[l],n&&d<h&&(!u||"object"!=typeof u))throw new Ep("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,t,e)}}}function Ap(e,t,n,r=!0,s=!0){if(n&&!Array.isArray(t))throw new Ep("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(e=gp(e));const a=new Array(t.length);for(let r=0,i=t.length;r<i;r++)a[r]=xp(e,t[r],n,!0,s,r),e=a[r].newDocument;return a.newDocument=e,a}function Ip(e,t,n,r){if("object"!=typeof e||null===e||Array.isArray(e))throw new Ep("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,n);if(!Op[e.op])throw new Ep("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,n);if("string"!=typeof e.path)throw new Ep("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,n);if(0!==e.path.indexOf("/")&&e.path.length>0)throw new Ep('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,n);if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new Ep("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new Ep("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,n);if(("add"===e.op||"replace"===e.op||"test"===e.op)&&vp(e.value))throw new Ep("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,n);if(n)if("add"==e.op){var s=e.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new Ep("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,n)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==r)throw new Ep("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,n)}else if("move"===e.op||"copy"===e.op){var i=function(e,t,n){try{if(!Array.isArray(e))throw new Ep("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)Ap(gp(t),gp(e),n||!0);else{n=n||Ip;for(var r=0;r<e.length;r++)n(e[r],r,t,void 0)}}catch(e){if(e instanceof Ep)return e;throw e}}([{op:"_get",path:e.from,value:void 0}],n);if(i&&"OPERATION_PATH_UNRESOLVABLE"===i.name)throw new Ep("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,n)}}function Pp(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var n,r,s,a=Array.isArray(e),i=Array.isArray(t);if(a&&i){if((r=e.length)!=t.length)return!1;for(n=r;0!=n--;)if(!Pp(e[n],t[n]))return!1;return!0}if(a!=i)return!1;var o=Object.keys(e);if((r=o.length)!==Object.keys(t).length)return!1;for(n=r;0!=n--;)if(!t.hasOwnProperty(o[n]))return!1;for(n=r;0!=n--;)if(!Pp(e[s=o[n]],t[s]))return!1;return!0}return e!=e&&t!=t}
/*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   */function Cp(e,t,n,r,s){if(t!==e){"function"==typeof t.toJSON&&(t=t.toJSON());for(var a=mp(t),i=mp(e),o=!1,l=i.length-1;l>=0;l--){var c=e[d=i[l]];if(!fp(t,d)||void 0===t[d]&&void 0!==c&&!1===Array.isArray(t))Array.isArray(e)===Array.isArray(t)?(s&&n.push({op:"test",path:r+"/"+bp(d),value:gp(c)}),n.push({op:"remove",path:r+"/"+bp(d)}),o=!0):(s&&n.push({op:"test",path:r,value:e}),n.push({op:"replace",path:r,value:t}));else{var u=t[d];"object"==typeof c&&null!=c&&"object"==typeof u&&null!=u&&Array.isArray(c)===Array.isArray(u)?Cp(c,u,n,r+"/"+bp(d),s):c!==u&&(s&&n.push({op:"test",path:r+"/"+bp(d),value:gp(c)}),n.push({op:"replace",path:r+"/"+bp(d),value:gp(u)}))}}if(o||a.length!=i.length)for(l=0;l<a.length;l++){var d;fp(e,d=a[l])||void 0===t[d]||n.push({op:"add",path:r+"/"+bp(d),value:gp(t[d])})}}}function Rp(e,t,n=!1){var r=[];return Cp(e,t,r,"",n),r}const Np=()=>"undefined"!=typeof Deno,$p=()=>{let e;return e="undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||Np()?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom"))?"jsdom":Np()?"deno":"other":"node",e};let jp;async function Lp(){if(void 0===jp){const e=$p();jp={library:"langchain-js",runtime:e}}return jp}function Mp(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}class Dp{}class Up extends Dp{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,dc(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"true"!==Mp("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return hc.prototype.toJSON.call(this)}toJSONNotImplemented(){return hc.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends Up{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:s.v4()}),Object.assign(this,e)}}}}function Fp(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}class Bp extends Up{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`\n\n${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){const t=function(e,t,n){const r=n.toFixed(0).slice(0,3).padStart(3,"0");return`${new Date(e).toISOString().slice(0,-1)}${r}Z`.replace(/[-:.]/g,"")+t}(e.start_time,e.id,e.execution_order),n={...e};if(void 0!==n.parent_run_id){const e=this.runMap.get(n.parent_run_id);e&&(this._addChildRun(e,n),e.child_execution_order=Math.max(e.child_execution_order,n.child_execution_order),n.trace_id=e.trace_id,void 0!==e.dotted_order&&(n.dotted_order=[e.dotted_order,t].join(".")))}else n.trace_id=n.id,n.dotted_order=t;this.runMap.set(n.id,n),await(this.onRunCreate?.(n))}async _endTrace(e){const t=void 0!==e.parent_run_id&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await(this.onRunUpdate?.(e))}_getExecutionOrder(e){const t=void 0!==e&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,n,r,s,a,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u=i?{...s,metadata:i}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:a||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleChatModelStart(e,t,n,r,s,a,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u=i?{...s,metadata:i}:s,d={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:u??{},tags:a||[]};return await this._startTrace(d),await(this.onLLMStart?.(d)),d}async handleLLMEnd(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onLLMEnd?.(n)),await this._endTrace(n),n}async handleLLMError(e,t){const n=this.runMap.get(t);if(!n||"llm"!==n?.run_type)throw new Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onLLMError?.(n)),await this._endTrace(n),n}async handleChainStart(e,t,n,r,s,a,i,o){const l=this._getExecutionOrder(r),c=Date.now(),u={id:n,name:o??e.id[e.id.length-1],parent_run_id:r,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:i??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return await this._startTrace(u),await(this.onChainStart?.(u)),u}async handleChainEnd(e,t,n,r,s){const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=Fp(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),void 0!==s?.inputs&&(a.inputs=Fp(s.inputs,"input")),await(this.onChainEnd?.(a)),await this._endTrace(a),a}async handleChainError(e,t,n,r,s){const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=this.stringifyError(e),a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),void 0!==s?.inputs&&(a.inputs=Fp(s.inputs,"input")),await(this.onChainError?.(a)),await this._endTrace(a),a}async handleToolStart(e,t,n,r,s,a,i){const o=this._getExecutionOrder(r),l=Date.now(),c={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return await this._startTrace(c),await(this.onToolStart?.(c)),c}async handleToolEnd(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.outputs={output:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onToolEnd?.(n)),await this._endTrace(n),n}async handleToolError(e,t){const n=this.runMap.get(t);if(!n||"tool"!==n?.run_type)throw new Error("No tool run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onToolError?.(n)),await this._endTrace(n),n}async handleAgentAction(e,t){const n=this.runMap.get(t);if(!n||"chain"!==n?.run_type)return;const r=n;r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentAction?.(n))}async handleAgentEnd(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"agent_end",time:(new Date).toISOString(),kwargs:{action:e}}),await(this.onAgentEnd?.(n)))}async handleRetrieverStart(e,t,n,r,s,a,i){const o=this._getExecutionOrder(r),l=Date.now(),c={id:n,name:i??e.id[e.id.length-1],parent_run_id:r,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:s||[]};return await this._startTrace(c),await(this.onRetrieverStart?.(c)),c}async handleRetrieverEnd(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.outputs={documents:e},n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverEnd?.(n)),await this._endTrace(n),n}async handleRetrieverError(e,t){const n=this.runMap.get(t);if(!n||"retriever"!==n?.run_type)throw new Error("No retriever run to end");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),await(this.onRetrieverError?.(n)),await this._endTrace(n),n}async handleText(e,t){const n=this.runMap.get(t);n&&"chain"===n?.run_type&&(n.events.push({name:"text",time:(new Date).toISOString(),kwargs:{text:e}}),await(this.onText?.(n)))}async handleLLMNewToken(e,t,n,r,s,a){const i=this.runMap.get(n);if(!i||"llm"!==i?.run_type)throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return i.events.push({name:"new_token",time:(new Date).toISOString(),kwargs:{token:e,idx:t,chunk:a?.chunk}}),await(this.onLLMNewToken?.(i,e,{chunk:a?.chunk})),i}}const qp=new class{getStore(){}run(e,t){return t()}};const zp=new class{getInstance(){return globalThis.__lc_tracing_async_local_storage??qp}initializeGlobalInstance(e){void 0===globalThis.__lc_tracing_async_local_storage&&(globalThis.__lc_tracing_async_local_storage=e)}};class Hp extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new Hp({start:e=>function n(){return t.read().then((({done:t,value:r})=>{if(!t)return e.enqueue(r),n();e.close()}))}(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Hp({async pull(t){const{value:n,done:r}=await e.next();r&&t.close(),t.enqueue(n)},async cancel(t){await e.return(t)}})}}function Wp(e,t=2){const n=Array.from({length:t},(()=>[]));return n.map((async function*(t){for(;;)if(0===t.length){const t=await e.next();for(const e of n)e.push(t)}else{if(t[0].done)return;yield t.shift().value}}))}function Kp(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){const n={...e};for(const[e,r]of Object.entries(t))e in n&&!Array.isArray(n[e])?n[e]=Kp(n[e],r):n[e]=r;return n}throw new Error(`Cannot concat ${typeof e} and ${typeof t}`)}class Vp{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.setup=new Promise(((t,n)=>{zp.getInstance().run(e.config,(async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,n):this.firstResult.then((e=>t(void 0)),n)}))}))}async next(...e){if(!this.firstResultUsed)return this.firstResultUsed=!0,this.firstResult;return zp.getInstance().run(this.config,(async()=>this.generator.next(...e)))}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}class Gp{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){const t=this.ops.concat(e.ops),n=Ap({},t);return new Zp({ops:t,state:n[n.length-1].newDocument})}}class Zp extends Gp{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),n=Ap(this.state,e.ops);return new Zp({ops:t,state:n[n.length-1].newDocument})}static fromRunLogPatch(e){const t=Ap({},e.ops);return new Zp({ops:e.ops,state:t[t.length-1].newDocument})}}const Jp=e=>"log_stream_tracer"===e.name;async function Xp(e,t){if("original"===t)throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");const{inputs:n}=e;return["retriever","llm","prompt"].includes(e.run_type)?n:1!==Object.keys(n).length||""!==n?.input?n.input:void 0}async function Yp(e,t){const{outputs:n}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?n:void 0!==n&&1===Object.keys(n).length&&void 0!==n?.output?n.output:n}class Qp extends Bp{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Hp.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){for await(const n of t){if(e!==this.rootId){const t=this.keyMapByRunId[e];t&&await this.writer.write(new Gp({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:n}]}))}yield n}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new Gp({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;const n={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(n.inputs=await Xp(e,this._schemaFormat)),await this.writer.write(new Gp({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:n}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(void 0===t)return;const n=[];"streaming_events"===this._schemaFormat&&n.push({op:"replace",path:`/logs/${t}/inputs`,value:await Xp(e,this._schemaFormat)}),n.push({op:"add",path:`/logs/${t}/final_output`,value:await Yp(e,this._schemaFormat)}),void 0!==e.end_time&&n.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const r=new Gp({ops:n});await this.writer.write(r)}finally{if(e.id===this.rootId){const t=new Gp({ops:[{op:"replace",path:"/final_output",value:await Yp(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,n){const r=this.keyMapByRunId[e.id];if(void 0===r)return;let s;s=void 0!==e.inputs.messages?function(e){return void 0!==e&&void 0!==e.message}(n?.chunk)?n?.chunk:new Ec(t):t;const a=new Gp({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${r}/streamed_output/-`,value:s}]});await this.writer.write(a)}}const ef="__run";class tf{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new tf({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class nf extends tf{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new nf({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function rf({name:e,serialized:t}){return void 0!==e?e:void 0!==t?.name?t.name:void 0!==t?.id&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}const sf=e=>"event_stream_tracer"===e.name;class af extends Bp{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Hp.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){const t=e.tags??[];let n=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(n=n||void 0!==t.find((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(n=n&&t.every((e=>!this.excludeTags?.includes(e)))),n}async*tapOutputIterable(e,t){const n=await t.next();if(n.done)return;const r=this.runInfoMap.get(e);if(void 0===r)return void(yield n.value);let s=this.tappedPromises.get(e);if(void 0===s){let a;s=new Promise((e=>{a=e})),this.tappedPromises.set(e,s);try{const s={event:`on_${r.runType}_stream`,run_id:e,name:r.name,tags:r.tags,metadata:r.metadata,data:{}};await this.send({...s,data:{chunk:n.value}},r),yield n.value;for await(const e of t)"tool"!==r.runType&&"retriever"!==r.runType&&await this.send({...s,data:{chunk:e}},r),yield e}finally{a()}}else{yield n.value;for await(const e of t)yield e}}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){const n=this.tappedPromises.get(e.run_id);void 0!==n?n.then((()=>{this.send(e,t)})):await this.send(e,t)}async onLLMStart(e){const t=rf(e),n=void 0!==e.inputs.messages?"chat_model":"llm",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:n,inputs:e.inputs};this.runInfoMap.set(e.id,r);const s=`on_${n}_start`;await this.send({event:s,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onLLMNewToken(e,t,n){const r=this.runInfoMap.get(e.id);let s,a;if(void 0===r)throw new Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if("chat_model"===r.runType)a="on_chat_model_stream",s=void 0===n?.chunk?new Ec({content:t}):n.chunk.message;else{if("llm"!==r.runType)throw new Error(`Unexpected run type ${r.runType}`);a="on_llm_stream",s=void 0===n?.chunk?new tf({text:t}):n.chunk}await this.send({event:a,data:{chunk:s},run_id:e.id,name:r.name,tags:r.tags,metadata:r.metadata},r)}async onLLMEnd(e){const t=this.runInfoMap.get(e.id);let n;if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);const r=e.outputs?.generations;let s;if("chat_model"===t.runType){for(const e of r??[]){if(void 0!==s)break;s=e[0]?.message}n="on_chat_model_end"}else{if("llm"!==t.runType)throw new Error(`onLLMEnd: Unexpected run type: ${t.runType}`);s={generations:r?.map((e=>e.map((e=>({text:e.text,generationInfo:e.generationInfo}))))),llmOutput:e.outputs?.llmOutput??{}},n="on_llm_end"}await this.sendEndEvent({event:n,data:{output:s,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onChainStart(e){const t=rf(e),n=e.run_type??"chain",r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type};let s={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(s={},r.inputs={}):void 0!==e.inputs.input?(s.input=e.inputs.input,r.inputs=e.inputs.input):(s.input=e.inputs,r.inputs=e.inputs),this.runInfoMap.set(e.id,r),await this.send({event:`on_${n}_start`,data:s,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onChainEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onChainEnd: Run ID ${e.id} not found in run map.`);const n=`on_${e.run_type}_end`,r=e.inputs??t.inputs??{},s={output:e.outputs?.output??e.outputs,input:r};r.input&&1===Object.keys(r).length&&(s.input=r.input,t.inputs=r.input),await this.sendEndEvent({event:n,data:s,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){const t=rf(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,n),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},n)}async onToolEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw new Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);const n=void 0===e.outputs?.output?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:n,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){const t=rf(e),n={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,n),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},n)}async onRetrieverEnd(e){const t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw new Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,n){const r=this.runInfoMap.get(n);if(void 0===r)throw new Error(`handleCustomEvent: Run ID ${n} not found in run map.`);await this.send({event:"on_custom_event",run_id:n,name:e,tags:r.tags,metadata:r.metadata,data:t},r)}async finish(){const e=[...this.tappedPromises.values()];Promise.all(e).finally((()=>{this.writer.close()}))}}var of={exports:{}};!function(e){const t=(e=0)=>t=>`[${38+e};5;${t}m`,n=(e=0)=>(t,n,r)=>`[${38+e};2;${t};${n};${r}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){const e=new Map,r={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};r.color.gray=r.color.blackBright,r.bgColor.bgGray=r.bgColor.bgBlackBright,r.color.grey=r.color.blackBright,r.bgColor.bgGrey=r.bgColor.bgBlackBright;for(const[t,n]of Object.entries(r)){for(const[t,s]of Object.entries(n))r[t]={open:`[${s[0]}m`,close:`[${s[1]}m`},n[t]=r[t],e.set(s[0],s[1]);Object.defineProperty(r,t,{value:n,enumerable:!1})}return Object.defineProperty(r,"codes",{value:e,enumerable:!1}),r.color.close="[39m",r.bgColor.close="[49m",r.color.ansi256=t(),r.color.ansi16m=n(),r.bgColor.ansi256=t(10),r.bgColor.ansi16m=n(10),Object.defineProperties(r,{rgbToAnsi256:{value:(e,t,n)=>e===t&&t===n?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(n/255*5),enumerable:!1},hexToRgb:{value:e=>{const t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:n}=t.groups;3===n.length&&(n=n.split("").map((e=>e+e)).join(""));const r=Number.parseInt(n,16);return[r>>16&255,r>>8&255,255&r]},enumerable:!1},hexToAnsi256:{value:e=>r.rgbToAnsi256(...r.hexToRgb(e)),enumerable:!1}}),r}})}(of);var lf=o(of.exports);function cf(e,t){return`${e.open}${t}${e.close}`}function uf(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function df(e){if(!e.end_time)return"";const t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}const{color:hf}=lf;class pf extends Bp{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let n=e;for(;n.parent_run_id;){const e=this.runMap.get(n.parent_run_id);if(!e)break;t.push(e),n=e}return t}getBreadcrumbs(e){const t=[...this.getParents(e).reverse(),e].map(((e,t,n)=>{const r=`${e.execution_order}:${e.run_type}:${e.name}`;return t===n.length-1?cf(lf.bold,r):r})).join(" > ");return cf(hf.grey,t)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.green,"[chain/start]")} [${t}] Entering Chain run with input: ${uf(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.cyan,"[chain/end]")} [${t}] [${df(e)}] Exiting Chain run with output: ${uf(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.red,"[chain/error]")} [${t}] [${df(e)}] Chain run errored with error: ${uf(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),n="prompts"in e.inputs?{prompts:e.inputs.prompts.map((e=>e.trim()))}:e.inputs;console.log(`${cf(hf.green,"[llm/start]")} [${t}] Entering LLM run with input: ${uf(n,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.cyan,"[llm/end]")} [${t}] [${df(e)}] Exiting LLM run with output: ${uf(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.red,"[llm/error]")} [${t}] [${df(e)}] LLM run errored with error: ${uf(e.error,"[error]")}`)}onToolStart(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.green,"[tool/start]")} [${t}] Entering Tool run with input: "${e.inputs.input?.trim()}"`)}onToolEnd(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.cyan,"[tool/end]")} [${t}] [${df(e)}] Exiting Tool run with output: "${e.outputs?.output?.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.red,"[tool/error]")} [${t}] [${df(e)}] Tool run errored with error: ${uf(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${uf(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.cyan,"[retriever/end]")} [${t}] [${df(e)}] Exiting Retriever run with output: ${uf(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${cf(hf.red,"[retriever/error]")} [${t}] [${df(e)}] Retriever run errored with error: ${uf(e.error,"[error]")}`)}onAgentAction(e){const t=e,n=this.getBreadcrumbs(e);console.log(`${cf(hf.blue,"[agent/action]")} [${n}] Agent selected action: ${uf(t.actions[t.actions.length-1],"[action]")}`)}}class ff extends Bp{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:n,client:r}=e;this.projectName=n??Mp("LANGCHAIN_PROJECT")??Mp("LANGCHAIN_SESSION"),this.exampleId=t,this.client=r??new ep({});const s=this.getTraceableRunTree();if(s){let e=s;const t=new Set;for(;e.parent_run&&!t.has(e.id)&&(t.add(e.id),e.parent_run);)e=e.parent_run;t.clear();const n=[e];for(;n.length>0;){const e=n.shift();e&&!t.has(e.id)&&(t.add(e.id),this.runMap.set(e.id,e),e.child_runs&&n.push(...e.child_runs))}this.client=s.client??this.client,this.projectName=s.project_name??this.projectName,this.exampleId=s.reference_example_id??this.exampleId}}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Lp()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}getTraceableRunTree(){try{return(()=>{const e=dp.getInstance().getStore();if(!function(e){return void 0!==e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}(e))throw new Error(["Could not get the current run tree.","","Please make sure you are calling this method within a traceable function or the tracing is enabled."].join("\n"));return e})()}catch{return}}}var mf={},gf={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function s(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function a(e,t,r,a,i){if("function"!=typeof r)throw new TypeError("The listener must be a function");var o=new s(r,a||e,i),l=n?n+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function i(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function o(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),o.prototype.eventNames=function(){var e,r,s=[];if(0===this._eventsCount)return s;for(r in e=this._events)t.call(e,r)&&s.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?s.concat(Object.getOwnPropertySymbols(e)):s},o.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i},o.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},o.prototype.emit=function(e,t,r,s,a,i){var o=n?n+e:e;if(!this._events[o])return!1;var l,c,u=this._events[o],d=arguments.length;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),d){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(c=1,l=new Array(d-1);c<d;c++)l[c-1]=arguments[c];u.fn.apply(u.context,l)}else{var h,p=u.length;for(c=0;c<p;c++)switch(u[c].once&&this.removeListener(e,u[c].fn,void 0,!0),d){case 1:u[c].fn.call(u[c].context);break;case 2:u[c].fn.call(u[c].context,t);break;case 3:u[c].fn.call(u[c].context,t,r);break;case 4:u[c].fn.call(u[c].context,t,r,s);break;default:if(!l)for(h=1,l=new Array(d-1);h<d;h++)l[h-1]=arguments[h];u[c].fn.apply(u[c].context,l)}}return!0},o.prototype.on=function(e,t,n){return a(this,e,t,n,!1)},o.prototype.once=function(e,t,n){return a(this,e,t,n,!0)},o.prototype.removeListener=function(e,t,r,s){var a=n?n+e:e;if(!this._events[a])return this;if(!t)return i(this,a),this;var o=this._events[a];if(o.fn)o.fn!==t||s&&!o.once||r&&o.context!==r||i(this,a);else{for(var l=0,c=[],u=o.length;l<u;l++)(o[l].fn!==t||s&&!o[l].once||r&&o[l].context!==r)&&c.push(o[l]);c.length?this._events[a]=1===c.length?c[0]:c:i(this,a)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&i(this,t)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=n,o.EventEmitter=o,e.exports=o}(gf);var yf=gf.exports,bf={exports:{}};const wf=Gc;class vf extends Error{constructor(e){super(e),this.name="TimeoutError"}}const _f=(e,t,n)=>new Promise(((r,s)=>{if("number"!=typeof t||t<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void r(e);const a=setTimeout((()=>{if("function"==typeof n){try{r(n())}catch(e){s(e)}return}const a=n instanceof Error?n:new vf("string"==typeof n?n:`Promise timed out after ${t} milliseconds`);"function"==typeof e.cancel&&e.cancel(),s(a)}),t);wf(e.then(r,s),(()=>{clearTimeout(a)}))}));bf.exports=_f,bf.exports.default=_f,bf.exports.TimeoutError=vf;var kf=bf.exports,Ef={},Of={};Object.defineProperty(Of,"__esModule",{value:!0}),Of.default=function(e,t,n){let r=0,s=e.length;for(;s>0;){const a=s/2|0;let i=r+a;n(e[i],t)<=0?(r=++i,s-=a+1):s=a}return r},Object.defineProperty(Ef,"__esModule",{value:!0});const Sf=Of;Ef.default=class{constructor(){this._queue=[]}enqueue(e,t){const n={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(n);const r=Sf.default(this._queue,n,((e,t)=>t.priority-e.priority));this._queue.splice(r,0,n)}dequeue(){const e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return this._queue.length}},Object.defineProperty(mf,"__esModule",{value:!0});const Tf=yf,xf=kf,Af=Ef,If=()=>{},Pf=new xf.TimeoutError;var Cf=mf.default=class extends Tf{constructor(e){var t,n,r,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=If,this._resolveIdle=If,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Af.default},e)).intervalCap&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!==(n=null===(t=e.intervalCap)||void 0===t?void 0:t.toString())&&void 0!==n?n:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!==(s=null===(r=e.interval)||void 0===r?void 0:r.toString())&&void 0!==s?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=If,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=If,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(void 0===this._intervalId){const t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout((()=>{this._onResumeInterval()}),t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval((()=>{this._onInterval()}),this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise(((n,r)=>{this._queue.enqueue((async()=>{this._pendingCount++,this._intervalCount++;try{const s=void 0===this._timeout&&void 0===t.timeout?e():xf.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,(()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&r(Pf)}));n(await s)}catch(e){r(e)}this._next()}),t),this._tryToStartAnother(),this.emit("add")}))}async addAll(e,t){return Promise.all(e.map((async e=>this.add(e,t))))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise((e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}}))}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise((e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}}))}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};let Rf;async function Nf(e,t){!0===t?await e():(void 0===Rf&&(Rf=new("default"in Cf?Cf.default:Cf)({autoStart:!0,concurrency:1})),Rf.add(e))}class $f{setHandler(e){return this.setHandlers([e])}}class jf{constructor(e,t,n,r,s,a,i,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{try{await(t.handleText?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Lf extends jf{getChild(e){const t=new Ff(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleRetrieverError(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags))}catch(n){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${n}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Mf extends jf{async handleLLMNewToken(e,t,n,r,s,a){await Promise.all(this.handlers.map((n=>Nf((async()=>{if(!n.ignoreLLM)try{await(n.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(e){if(console.error(`Error in handler ${n.constructor.name}, handleLLMNewToken: ${e}`),n.raiseError)throw e}}),n.awaitHandlers))))}async handleLLMError(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleLLMEnd(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Df extends jf{getChild(e){const t=new Ff(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,n,r,s){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreChain)try{await(t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleChainEnd(e,t,n,r,s){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreChain)try{await(t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,s))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentAction(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleAgentEnd(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreAgent)try{await(t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Uf extends jf{getChild(e){const t=new Ff(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreAgent)try{await(t.handleToolError?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}async handleToolEnd(e){await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreAgent)try{await(t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}}),t.awaitHandlers))))}}class Ff extends $f{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,l=void 0){return Promise.all(n.map((async(n,s)=>{const i=0===s&&r?r:t.v4();return await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreLLM)try{await(t.handleLLMStart?.(e,[n],i,this._parentRunId,a,this.tags,this.metadata,l))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Mf(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChatModelStart(e,n,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,l=void 0){return Promise.all(n.map((async(n,s)=>{const i=0===s&&r?r:t.v4();return await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreLLM)try{if(t.handleChatModelStart)await(t.handleChatModelStart?.(e,[n],i,this._parentRunId,a,this.tags,this.metadata,l));else if(t.handleLLMStart){const r=Nc(n);await(t.handleLLMStart?.(e,[r],i,this._parentRunId,a,this.tags,this.metadata,l))}}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleLLMStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Mf(i,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)})))}async handleChainStart(e,n,r=t.v4(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreChain)try{await(t.handleChainStart?.(e,n,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleChainStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Df(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,n,r=t.v4(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreAgent)try{await(t.handleToolStart?.(e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleToolStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Uf(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,n,r=t.v4(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map((t=>Nf((async()=>{if(!t.ignoreRetriever)try{await(t.handleRetrieverStart?.(e,n,r,this._parentRunId,this.tags,this.metadata,o))}catch(e){if(console.error(`Error in handler ${t.constructor.name}, handleRetrieverStart: ${e}`),t.raiseError)throw e}}),t.awaitHandlers)))),new Lf(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,n,r,s){await Promise.all(this.handlers.map((r=>Nf((async()=>{if(!r.ignoreCustomEvent)try{await(r.handleCustomEvent?.(e,t,n,this.tags,this.metadata))}catch(e){if(console.error(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}}),r.awaitHandlers))))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter((t=>t!==e)),this.inheritableHandlers=this.inheritableHandlers.filter((t=>t!==e))}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const n of e)this.addHandler(n,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter((t=>!e.includes(t))),this.inheritableTags=this.inheritableTags.filter((t=>!e.includes(t)))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const n=new Ff(this._parentRunId);for(const e of this.handlers){const t=this.inheritableHandlers.includes(e);n.addHandler(e,t)}for(const e of this.tags){const t=this.inheritableTags.includes(e);n.addTags([e],t)}for(const e of Object.keys(this.metadata)){const t=Object.keys(this.inheritableMetadata).includes(e);n.addMetadata({[e]:this.metadata[e]},t)}for(const r of e)n.handlers.filter((e=>"console_callback_handler"===e.name)).some((e=>e.name===r.name))||n.addHandler(r,t);return n}static fromHandlers(e){const n=new this;return n.addHandler(new class extends Up{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t.v4()}),Object.assign(this,e)}}),n}static async configure(e,t,n,r,s,a,i){return this._configureSync(e,t,n,r,s,a,i)}static _configureSync(e,t,n,r,s,a,i){let o;(e||t)&&(Array.isArray(e)||!e?(o=new Ff,o.setHandlers(e?.map(Bf)??[],!0)):o=e,o=o.copy(Array.isArray(t)?t.map(Bf):t?.handlers,!1));const l="true"===Mp("LANGCHAIN_VERBOSE")||i?.verbose,c=!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find((e=>"true"===Mp(e))),u=c||(Mp("LANGCHAIN_TRACING")??!1);if(l||u){if(o||(o=new Ff),l&&!o.handlers.some((e=>e.name===pf.prototype.name))){const e=new pf;o.addHandler(e,!0)}if(u&&!o.handlers.some((e=>"langchain_tracer"===e.name))&&c){const e=new ff;o.addHandler(e,!0),o._parentRunId=e.getTraceableRunTree()?.id??o._parentRunId}}return(n||r)&&o&&(o.addTags(n??[]),o.addTags(r??[],!1)),(s||a)&&o&&(o.addMetadata(s??{}),o.addMetadata(a??{},!1)),o}}function Bf(e){return"name"in e?e:Up.fromMethods(e)}async function qf(e){return Ff.configure(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function zf(...e){const t={};for(const n of e.filter((e=>!!e)))for(const e of Object.keys(n))if("metadata"===e)t[e]={...t[e],...n[e]};else if("tags"===e){const r=t[e]??[];t[e]=[...new Set(r.concat(n[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...n[e]};else if("callbacks"===e){const e=t.callbacks,r=n.callbacks;if(Array.isArray(r))if(e)if(Array.isArray(e))t.callbacks=e.concat(r);else{const n=e.copy();for(const e of r)n.addHandler(Bf(e),!0);t.callbacks=n}else t.callbacks=r;else if(r)if(e)if(Array.isArray(e)){const n=r.copy();for(const t of e)n.addHandler(Bf(t),!0);t.callbacks=n}else t.callbacks=new Ff(r._parentRunId,{handlers:e.handlers.concat(r.handlers),inheritableHandlers:e.inheritableHandlers.concat(r.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(r.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(r.inheritableTags))),metadata:{...e.metadata,...r.metadata}});else t.callbacks=r}else{const r=e;t[r]=n[r]??t[r]}return t}const Hf=new Set(["string","number","boolean"]);function Wf(e){const t=zp.getInstance().getStore();let n={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){const{runId:e,...r}=t;n=Object.entries(r).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)}if(e&&(n=Object.entries(e).reduce(((e,[t,n])=>(void 0!==n&&(e[t]=n),e)),n)),n?.configurable)for(const e of Object.keys(n.configurable))Hf.has(typeof n.configurable[e])&&!n.metadata?.[e]&&(n.metadata||(n.metadata={}),n.metadata[e]=n.configurable[e]);return n}function Kf(e={},{callbacks:t,maxConcurrency:n,recursionLimit:r,runName:s,configurable:a,runId:i}={}){const o=Wf(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==r&&(o.recursionLimit=r),void 0!==n&&(o.maxConcurrency=n),void 0!==s&&(o.runName=s),void 0!==a&&(o.configurable={...o.configurable,...a}),void 0!==i&&delete o.runId,o}const Vf=[400,401,402,403,404,405,406,407,409],Gf=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name)throw e;if("ECONNABORTED"===e?.code)throw e;const t=e?.response?.status??e?.status;if(t&&Vf.includes(+t))throw e;if("insufficient_quota"===e?.error?.code){const t=new Error(e?.message);throw t.name="InsufficientQuotaError",t}};class Zf{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??Gf;const t="default"in Cf?Cf.default:Cf;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add((()=>zc((()=>e(...t).catch((e=>{throw e instanceof Error?e:new Error(e)}))),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0})),{throwOnTimeout:!0})}callWithOptions(e,t,...n){return e.signal?Promise.race([this.call(t,...n),new Promise(((t,n)=>{e.signal?.addEventListener("abort",(()=>{n(new Error("AbortError"))}))}))]):this.call(t,...n)}fetch(...e){return this.call((()=>fetch(...e).then((e=>e.ok?e:Promise.reject(e)))))}}class Jf extends Bp{constructor({config:e,onStart:t,onEnd:n,onError:r}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=n,this.argOnError=r}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(1===this.argOnStart.length?await this.argOnStart(e):2===this.argOnStart.length&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(1===this.argOnError.length?await this.argOnError(e):2===this.argOnError.length&&await this.argOnError(e,this.config)):this.argOnEnd&&(1===this.argOnEnd.length?await this.argOnEnd(e):2===this.argOnEnd.length&&await this.argOnEnd(e,this.config)))}}function Xf(e){return!!e&&e.lc_runnable}class Yf{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let n=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags;const r=e.tags??[];return void 0!==this.includeNames&&(n=n||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(n=n||this.includeTypes.includes(t)),void 0!==this.includeTags&&(n=n||r.some((e=>this.includeTags?.includes(e)))),void 0!==this.excludeNames&&(n=n&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(n=n&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(n=n&&r.every((e=>!this.excludeTags?.includes(e)))),n}}function Qf(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}function em(e,t){return[t[e.source]??e.source,t[e.target]??e.target]}function tm(e,t,n){const{firstNodeLabel:r,lastNodeLabel:s,nodeColors:a,withStyles:i=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=n??{};let c=i?`%%{init: {'flowchart': {'curve': '${o}'}}}%%\ngraph TD;\n`:"graph TD;\n";if(i){const t="default",n={[t]:"{0}([{1}]):::otherclass"};void 0!==r&&(n[r]="{0}[{0}]:::startclass"),void 0!==s&&(n[s]="{0}[{0}]:::endclass");for(const r of Object.values(e)){const e=n[r]??n[t],s=Qf(r),a=r.split(":"),i=a[a.length-1];c+=`\t${e.replace(/\{0\}/g,s).replace(/\{1\}/g,i)};\n`}}let u="";for(const n of t){const t=n.source.includes(":")?n.source.split(":")[0]:void 0,r=n.target.includes(":")?n.target.split(":")[0]:void 0;""===u||u===t&&u===r||(c+="\tend\n",u=""),""===u&&void 0!==t&&t===r&&(c=`\tsubgraph ${t}\n`,u=t);const[s,a]=em(n,e);let i="";if(void 0!==n.data){let e=n.data;const t=e.split(" ");t.length>l&&(e=t.reduce(((e,t,n)=>(n%l==0&&e.push(""),e[e.length-1]+=` ${t}`,e)),[]).join("<br>")),i=n.conditional?` -. ${e} .-> `:` -- ${e} --\x3e `}else i=n.conditional?" -.-> ":" --\x3e ";c+=`\t${Qf(s)}${i}${Qf(a)};\n`}return""!==u&&(c+="end\n"),i&&void 0!==a&&(c+=function(e){let t="";for(const[n,r]of Object.entries(e))t+=`\tclassDef ${n}class fill:${r};\n`;return t}(a)),c}function nm(e){if(!t.validate(e.id))return e.id;if(!Xf(e.data))return e.data.name??"UnknownSchema";try{let t=e.data.getName();return t=t.startsWith("Runnable")?t.slice(8):t,t.length>42&&(t=`${t.substring(0,42)}...`),t}catch(t){return e.data.getName()}}function rm(e){return Xf(e.data)?{type:"runnable",data:{id:e.data.lc_id,name:e.data.getName()}}:{type:"schema",data:{...Ps(e.data.schema),title:e.data.name}}}class sm{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){const e={};return Object.values(this.nodes).forEach(((n,r)=>{e[n.id]=t.validate(n.id)?r:n.id})),{nodes:Object.values(this.nodes).map((t=>({id:e[t.id],...rm(t)}))),edges:this.edges.map((t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]}))}}addNode(e,n){if(void 0!==n&&void 0!==this.nodes[n])throw new Error(`Node with id ${n} already exists`);const r=n||t.v4(),s={id:r,data:e};return this.nodes[r]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter((t=>t.source!==e.id&&t.target!==e.id))}addEdge(e,t,n,r){if(void 0===this.nodes[e.id])throw new Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw new Error(`Target node ${t.id} not in graph`);const s={source:e.id,target:t.id,data:n,conditional:r};return this.edges.push(s),s}firstNode(){const e=new Set(this.edges.map((e=>e.target))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}lastNode(){const e=new Set(this.edges.map((e=>e.source))),t=[];return Object.values(this.nodes).forEach((n=>{e.has(n.id)||t.push(n)})),t[0]}extend(e,n=""){let r=n;Object.values(e.nodes).map((e=>e.id)).every(t.validate)&&(r="");const s=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach((([e,t])=>{this.nodes[s(e)]={...t,id:s(e)}}));const a=e.edges.map((e=>({...e,source:s(e.source),target:s(e.target)})));this.edges=[...this.edges,...a];const i=e.firstNode(),o=e.lastNode();return[i?{id:s(i.id),data:i.data}:void 0,o?{id:s(o.id),data:o.data}:void 0]}trimFirstNode(){const e=this.firstNode();if(e){const t=this.edges.filter((t=>t.source===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}trimLastNode(){const e=this.lastNode();if(e){const t=this.edges.filter((t=>t.target===e.id));1!==Object.keys(this.nodes).length&&1!==t.length||this.removeNode(e)}}drawMermaid(e){const{withStyles:t,curveStyle:n,nodeColors:r={start:"#ffdfba",end:"#baffc9",other:"#fad7de"},wrapLabelNWords:s}=e??{},a={};for(const e of Object.values(this.nodes))a[e.id]=nm(e);const i=this.firstNode(),o=i?nm(i):void 0,l=this.lastNode(),c=l?nm(l):void 0;return tm(a,this.edges,{firstNodeLabel:o,lastNodeLabel:c,withStyles:t,curveStyle:n,nodeColors:r,wrapLabelNWords:s})}async drawMermaidPng(e){return async function(e,t){let{backgroundColor:n="white"}=t??{};const r=btoa(e);void 0!==n&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(n)||(n=`!${n}`));const s=`https://mermaid.ink/img/${r}?bgColor=${n}`,a=await fetch(s);if(!a.ok)throw new Error(["Failed to render the graph using the Mermaid.INK API.",`Status code: ${a.status}`,`Status text: ${a.statusText}`].join("\n"));return await a.blob()}(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function am(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function im(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*om(e,t){const n=zp.getInstance();for(;;){const{value:r,done:s}=n.run(e,t.next.bind(t));if(s)break;yield r}}async function*lm(e,t){const n=zp.getInstance(),r=t[Symbol.asyncIterator]();for(;;){const{value:s,done:a}=await n.run(e,r.next.bind(t));if(a)break;yield s}}function cm(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class um extends hc{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new dm({bound:this,kwargs:e,config:{}})}map(){return new hm({bound:this})}withRetry(e){return new pm({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new dm({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new bm({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(Wf);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");const n=Object.fromEntries(Object.entries(e).filter((([e])=>"runId"!==e)));return Array.from({length:t},((t,r)=>Wf(0===r?e:n)))}return Array.from({length:t},(()=>Wf(e)))}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=r[0]?.maxConcurrency??n?.maxConcurrency,a=new Zf({maxConcurrency:s,onFailedAttempt:e=>{throw e}}),i=e.map(((e,t)=>a.call((async()=>{try{return await this.invoke(e,r[t])}catch(e){if(n?.returnExceptions)return e;throw e}}))));return Promise.all(i)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){const n=Wf(t),r=new Vp({generator:this._streamIterator(e,n),config:n});return await r.setup,Hp.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e){let t;t=Wf(void 0===e?e:{callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId});const n={...e};return delete n.callbacks,delete n.tags,delete n.metadata,delete n.runName,delete n.configurable,delete n.recursionLimit,delete n.maxConcurrency,delete n.runId,[t,n]}async _callWithConfig(e,t,n){const r=Wf(n),s=await qf(r),a=await(s?.handleChainStart(this.toJSON(),cm(t,"input"),r.runId,r?.runType,void 0,void 0,r?.runName??this.getName()));let i;delete r.runId;try{i=await e.call(this,t,r,a)}catch(e){throw await(a?.handleChainError(e)),e}return await(a?.handleChainEnd(cm(i,"output"))),i}async _batchWithConfig(e,t,n,r){const s=this._getOptionsList(n??{},t.length),a=await Promise.all(s.map(qf)),i=await Promise.all(a.map((async(e,n)=>{const r=await(e?.handleChainStart(this.toJSON(),cm(t[n],"input"),s[n].runId,s[n].runType,void 0,void 0,s[n].runName??this.getName()));return delete s[n].runId,r})));let o;try{o=await e.call(this,t,s,i,r)}catch(e){throw await Promise.all(i.map((t=>t?.handleChainError(e)))),e}return await Promise.all(i.map((e=>e?.handleChainEnd(cm(o,"output"))))),o}async*_transformStreamWithConfig(e,t,n){let r,s,a=!0,i=!0;const o=Wf(n),l=await qf(o);let c;try{const n=await async function(e,t,n,...r){const s=new Vp({generator:t,startSetup:n}),a=await s.setup;return{output:e(s,a,...r),setup:a}}(t.bind(this),async function*(){for await(const t of e){if(a)if(void 0===r)r=t;else try{r=Kp(r,t)}catch{r=void 0,a=!1}yield t}}(),(async()=>l?.handleChainStart(this.toJSON(),{input:""},o.runId,o.runType,void 0,void 0,o.runName??this.getName())),o);delete o.runId,c=n.setup;const u=c?.handlers.find(sf);let d=n.output;void 0!==u&&void 0!==c&&(d=u.tapOutputIterable(c.runId,d));const h=c?.handlers.find(Jp);void 0!==h&&void 0!==c&&(d=h.tapOutputIterable(c.runId,d));for await(const e of d)if(yield e,i)if(void 0===s)s=e;else try{s=Kp(s,e)}catch{s=void 0,i=!1}}catch(e){throw await(c?.handleChainError(e,void 0,void 0,void 0,{inputs:cm(r,"input")})),e}await(c?.handleChainEnd(s??{},void 0,void 0,void 0,{inputs:cm(r,"input")}))}getGraph(e){const t=new sm,n=t.addNode({name:`${this.getName()}Input`,schema:ss.any()}),r=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:ss.any()});return t.addEdge(n,r),t.addEdge(r,s),t}pipe(e){return new fm({first:this,last:wm(e)})}pick(e){return this.pipe(new _m(e))}assign(e){return this.pipe(new vm(new mm({steps:e})))}async*transform(e,t){let n;for await(const t of e)n=void 0===n?t:Kp(n,t);yield*this._streamIterator(n,Wf(t))}async*streamLog(e,t,n){const r=new Qp({...n,autoClose:!1,_schemaFormat:"original"}),s=Wf(t);yield*this._streamLog(e,r,s)}async*_streamLog(e,t,n){const{callbacks:r}=n;if(void 0===r)n.callbacks=[t];else if(Array.isArray(r))n.callbacks=r.concat([t]);else{const e=r.copy();e.inheritableHandlers.push(t),n.callbacks=e}const s=this.stream(e,n);const a=async function(){try{const e=await s;for await(const n of e){const e=new Gp({ops:[{op:"add",path:"/streamed_output/-",value:n}]});await t.writer.write(e)}}finally{await t.writer.close()}}();try{for await(const e of t)yield e}finally{await a}}streamEvents(e,t,n){let r;if("v1"===t.version)r=this._streamEventsV1(e,t,n);else{if("v2"!==t.version)throw new Error('Only versions "v1" and "v2" of the schema are currently supported.');r=this._streamEventsV2(e,t,n)}return"text/event-stream"===t.encoding?function(e){const t=new TextEncoder,n=new ReadableStream({async start(n){for await(const r of e)n.enqueue(t.encode(`event: data\ndata: ${JSON.stringify(r)}\n\n`));n.enqueue(t.encode("event: end\n\n")),n.close()}});return Hp.fromReadableStream(n)}(r):Hp.fromAsyncGenerator(r)}async*_streamEventsV2(e,n,r){const s=new af({...r,autoClose:!1}),a=Wf(n),i=a.runId??t.v4();a.runId=i;const o=a.callbacks;if(void 0===o)a.callbacks=[s];else if(Array.isArray(o))a.callbacks=o.concat(s);else{const e=o.copy();e.inheritableHandlers.push(s),a.callbacks=e}const l=this;const c=async function(){try{const t=await l.stream(e,a),n=s.tapOutputIterable(i,t);for await(const e of n);}finally{await s.finish()}}();let u,d=!1;try{for await(const t of s)d?(t.run_id===u&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t):(t.data.input=e,d=!0,u=t.run_id,yield t)}finally{await c}}async*_streamEventsV1(e,t,n){let r,s=!1;const a=Wf(t),i=a.tags??[],o=a.metadata??{},l=a.runName??this.getName(),c=new Qp({...n,autoClose:!1,_schemaFormat:"streaming_events"}),u=new Yf({...n}),d=this._streamLog(e,c,a);for await(const t of d){if(r=r?r.concat(t):Zp.fromRunLogPatch(t),void 0===r.state)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;const t={...r.state},n={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:i,metadata:o,data:{input:e}};u.includeEvent(n,t.type)&&(yield n)}const n=t.ops.filter((e=>e.path.startsWith("/logs/"))).map((e=>e.path.split("/")[2])),a=[...new Set(n)];for(const e of a){let t,n={};const s=r.state.logs[e];if(t=void 0===s.end_time?s.streamed_output.length>0?"stream":"start":"end","start"===t)void 0!==s.inputs&&(n.input=s.inputs);else if("end"===t)void 0!==s.inputs&&(n.input=s.inputs),n.output=s.final_output;else if("stream"===t){const e=s.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${s.name}"`);n={chunk:s.streamed_output[0]},s.streamed_output=[]}yield{event:`on_${s.type}_${t}`,name:s.name,run_id:s.id,tags:s.tags,metadata:s.metadata,data:n}}const{state:c}=r;if(c.streamed_output.length>0){const e=c.streamed_output.length;if(1!==e)throw new Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${c.name}"`);const t={chunk:c.streamed_output[0]};c.streamed_output=[];const n={event:`on_${c.type}_stream`,run_id:c.id,tags:i,metadata:o,name:l,data:t};u.includeEvent(n,c.type)&&(yield n)}}const h=r?.state;if(void 0!==h){const e={event:`on_${h.type}_end`,name:l,run_id:h.id,tags:i,metadata:o,data:{output:h.final_output}};u.includeEvent(e,h.type)&&(yield e)}}static isRunnable(e){return Xf(e)}withListeners({onStart:e,onEnd:t,onError:n}){return new dm({bound:this,config:{},configFactories:[r=>({callbacks:[new Jf({config:r,onStart:e,onEnd:t,onError:n})]})]})}asTool(e){return function(e,t){const n=t.name??e.getName(),r=t.description??t.schema.description;return new km({name:n,description:r,schema:t.schema,bound:e})}
/*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   */(this,e)}}class dm extends um{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){const t=zf(this.config,...e);return zf(t,...this.configFactories?await Promise.all(this.configFactories.map((async e=>await e(t)))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(Wf(t),this.kwargs))}async batch(e,t,n){const r=Array.isArray(t)?await Promise.all(t.map((async e=>this._mergeConfig(Wf(e),this.kwargs)))):await this._mergeConfig(Wf(t),this.kwargs);return this.bound.batch(e,r,n)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(Wf(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(Wf(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(Wf(t),this.kwargs))}streamEvents(e,t,n){const r=this;return Hp.fromAsyncGenerator(async function*(){yield*r.bound.streamEvents(e,{...await r._mergeConfig(Wf(t),r.kwargs),version:t.version},n)}())}static isRunnableBinding(e){return e.bound&&um.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:n}){return new dm({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[r=>({callbacks:[new Jf({config:r,onStart:e,onEnd:t,onError:n})]})]})}}class hm extends um{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new hm({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,n){return this.bound.batch(e,Kf(t,{callbacks:n?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:n}){return new hm({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:n})})}}class pm extends dm{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,n){const r=e>1?`retry:attempt:${e}`:void 0;return Kf(t,{callbacks:n?.getChild(r)})}async _invoke(e,t,n){return zc((r=>super.invoke(e,this._patchConfigForRetry(r,t,n))),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,n,r){const s={};try{await zc((async a=>{const i=e.map(((e,t)=>t)).filter((e=>void 0===s[e.toString()]||s[e.toString()]instanceof Error)),o=i.map((t=>e[t])),l=i.map((e=>this._patchConfigForRetry(a,t?.[e],n?.[e]))),c=await super.batch(o,l,{...r,returnExceptions:!0});let u;for(let e=0;e<c.length;e+=1){const t=c[e],n=i[e];t instanceof Error&&void 0===u&&(u=t,u.input=o[e]),s[n.toString()]=t}if(u)throw u;return c}),{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(!0!==r?.returnExceptions)throw e}return Object.keys(s).sort(((e,t)=>parseInt(e,10)-parseInt(t,10))).map((e=>s[parseInt(e,10)]))}async batch(e,t,n){return this._batchWithConfig(this._batch.bind(this),e,t,n)}}class fm extends um{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const n=Wf(t),r=await qf(n),s=await(r?.handleChainStart(this.toJSON(),cm(e,"input"),n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;let a,i=e;try{const e=[this.first,...this.middle];for(let t=0;t<e.length;t+=1){const r=e[t];i=await r.invoke(i,Kf(n,{callbacks:s?.getChild(`seq:step:${t+1}`)}))}a=await this.last.invoke(i,Kf(n,{callbacks:s?.getChild(`seq:step:${this.steps.length}`)}))}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(cm(a,"output"))),a}async batch(e,t,n){const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map(qf)),a=await Promise.all(s.map((async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),cm(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s})));let i=e;try{for(let e=0;e<this.steps.length;e+=1){const t=this.steps[e];i=await t.batch(i,a.map(((t,n)=>{const s=t?.getChild(`seq:step:${e+1}`);return Kf(r[n],{callbacks:s})})),n)}}catch(e){throw await Promise.all(a.map((t=>t?.handleChainError(e)))),e}return await Promise.all(a.map((e=>e?.handleChainEnd(cm(i,"output"))))),i}async*_streamIterator(e,t){const n=await qf(t),{runId:r,...s}=t??{},a=await(n?.handleChainStart(this.toJSON(),cm(e,"input"),r,void 0,void 0,void 0,s?.runName)),i=[this.first,...this.middle,this.last];let o,l=!0;try{let t=i[0].transform(async function*(){yield e}(),Kf(s,{callbacks:a?.getChild("seq:step:1")}));for(let e=1;e<i.length;e+=1){const n=i[e];t=await n.transform(t,Kf(s,{callbacks:a?.getChild(`seq:step:${e+1}`)}))}for await(const e of t)if(yield e,l)if(void 0===o)o=e;else try{o=Kp(o,e)}catch(e){o=void 0,l=!1}}catch(e){throw await(a?.handleChainError(e)),e}await(a?.handleChainEnd(cm(o,"output")))}getGraph(e){const t=new sm;let n=null;return this.steps.forEach(((r,s)=>{const a=r.getGraph(e);0!==s&&a.trimFirstNode(),s!==this.steps.length-1&&a.trimLastNode(),t.extend(a);const i=a.firstNode();if(!i)throw new Error(`Runnable ${r} has no first node`);n&&t.addEdge(n,i),n=a.lastNode()})),t}pipe(e){return fm.isRunnableSequence(e)?new fm({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new fm({first:this.first,middle:[...this.middle,this.last],last:wm(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&um.isRunnable(e)}static from([e,...t],n){return new fm({first:wm(e),middle:t.slice(0,-1).map(wm),last:wm(t[t.length-1]),name:n})}}class mm extends um{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,n]of Object.entries(e.steps))this.steps[t]=wm(n)}static from(e){return new mm({steps:e})}async invoke(e,t){const n=Wf(t),r=await qf(n),s=await(r?.handleChainStart(this.toJSON(),{input:e},n.runId,void 0,void 0,void 0,n?.runName));delete n.runId;const a={};try{await Promise.all(Object.entries(this.steps).map((async([t,r])=>{a[t]=await r.invoke(e,Kf(n,{callbacks:s?.getChild(`map:key:${t}`)}))})))}catch(e){throw await(s?.handleChainError(e)),e}return await(s?.handleChainEnd(a)),a}async*_transform(e,t,n){const r={...this.steps},s=Wp(e,Object.keys(r).length),a=new Map(Object.entries(r).map((([e,r],a)=>{const i=r.transform(s[a],Kf(n,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,i.next().then((t=>({key:e,gen:i,result:t})))]})));for(;a.size;){const{key:e,result:t,gen:n}=await Promise.race(a.values());a.delete(e),t.done||(yield{[e]:t.value},a.set(e,n.next().then((t=>({key:e,gen:n,result:t})))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Wf(t),r=new Vp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Hp.fromAsyncGenerator(r)}}class gm extends um{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!hp(e.func))throw new Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){const[n]=this._getOptionsList(t??{},1),r=await qf(n);return await this.func(Kf(n,{callbacks:r}),e)}async*_streamIterator(e,t){const n=await this.invoke(e,t);if(im(n))for await(const e of n)yield e;else if((e=>null!=e&&"object"==typeof e&&"next"in e&&"function"==typeof e.next)(n))for(;;){const e=n.next();if(e.done)break;yield e.value}else yield n}static from(e){return new gm({func:e})}}class ym extends um{static lc_name(){return"RunnableLambda"}constructor(e){if(hp(e.func))return gm.from(e.func);super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){if(hp(e))throw new Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.")}(e.func),this.func=e.func}static from(e){return new ym({func:e})}async _invoke(e,t,n){return new Promise(((r,s)=>{const a=Kf(t,{callbacks:n?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});zp.getInstance().run(a,(async()=>{try{let n=await this.func(e,{...a,config:a});if(n&&um.isRunnable(n)){if(0===t?.recursionLimit)throw new Error("Recursion limit reached.");n=await n.invoke(e,{...a,recursionLimit:(a.recursionLimit??25)-1})}else if(im(n)){let e;for await(const t of lm(a,n))if(void 0===e)e=t;else try{e=Kp(e,t)}catch(n){e=t}n=e}else if(am(n)){let e;for(const t of om(a,n))if(void 0===e)e=t;else try{e=Kp(e,t)}catch(n){e=t}n=e}r(n)}catch(e){s(e)}}))}))}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,n){let r;for await(const t of e)if(void 0===r)r=t;else try{r=Kp(r,t)}catch(e){r=t}const s=Kf(n,{callbacks:t?.getChild(),recursionLimit:(n?.recursionLimit??25)-1}),a=await new Promise(((e,t)=>{zp.getInstance().run(s,(async()=>{try{const t=await this.func(r,{...s,config:s});e(t)}catch(e){t(e)}}))}));if(a&&um.isRunnable(a)){if(0===n?.recursionLimit)throw new Error("Recursion limit reached.");const e=await a.stream(r,s);for await(const t of e)yield t}else if(im(a))for await(const e of lm(s,a))yield e;else if(am(a))for(const e of om(s,a))yield e;else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Wf(t),r=new Vp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Hp.fromAsyncGenerator(r)}}class bm extends um{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const n=Wf(t),r=await qf(t),{runId:s,...a}=n,i=await(r?.handleChainStart(this.toJSON(),cm(e,"input"),s,void 0,void 0,void 0,a?.runName));let o;for(const t of this.runnables())try{const n=await t.invoke(e,Kf(a,{callbacks:i?.getChild()}));return await(i?.handleChainEnd(cm(n,"output"))),n}catch(e){void 0===o&&(o=e)}if(void 0===o)throw new Error("No error stored at end of fallback.");throw await(i?.handleChainError(o)),o}async batch(e,t,n){if(n?.returnExceptions)throw new Error("Not implemented.");const r=this._getOptionsList(t??{},e.length),s=await Promise.all(r.map((e=>qf(e)))),a=await Promise.all(s.map((async(t,n)=>{const s=await(t?.handleChainStart(this.toJSON(),cm(e[n],"input"),r[n].runId,void 0,void 0,void 0,r[n].runName));return delete r[n].runId,s})));let i;for(const t of this.runnables())try{const s=await t.batch(e,a.map(((e,t)=>Kf(r[t],{callbacks:e?.getChild()}))),n);return await Promise.all(a.map(((e,t)=>e?.handleChainEnd(cm(s[t],"output"))))),s}catch(e){void 0===i&&(i=e)}if(!i)throw new Error("No error stored at end of fallbacks.");throw await Promise.all(a.map((e=>e?.handleChainError(i)))),i}}function wm(e){if("function"==typeof e)return new ym({func:e});if(um.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw new Error("Expected a Runnable, function or object.\nInstead got an unsupported type.");{const t={};for(const[n,r]of Object.entries(e))t[n]=wm(r);return new mm({steps:t})}}class vm extends um{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof mm&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const n=await this.mapper.invoke(e,t);return{...e,...n}}async*_transform(e,t,n){const r=this.mapper.getStepsKeys(),[s,a]=Wp(e),i=this.mapper.transform(a,Kf(n,{callbacks:t?.getChild()})),o=i.next();for await(const e of s){if("object"!=typeof e||Array.isArray(e))throw new Error("RunnableAssign can only be used with objects as input, got "+typeof e);const t=Object.fromEntries(Object.entries(e).filter((([e])=>!r.includes(e))));Object.keys(t).length>0&&(yield t)}yield(await o).value;for await(const e of i)yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Wf(t),r=new Vp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Hp.fromAsyncGenerator(r)}}class _m extends um{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{const t=this.keys.map((t=>[t,e[t]])).filter((e=>void 0!==e[1]));return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){const n=Wf(t),r=new Vp({generator:this.transform(async function*(){yield e}(),n),config:n});return await r.setup,Hp.fromAsyncGenerator(r)}}class km extends dm{constructor(e){super({bound:e.bound,config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}var Em="object"==typeof window?window:{},Om="0123456789abcdef".split(""),Sm=[-2147483648,8388608,32768,128],Tm=[24,16,8,0],xm=[];function Am(e){e?(xm[0]=xm[16]=xm[1]=xm[2]=xm[3]=xm[4]=xm[5]=xm[6]=xm[7]=xm[8]=xm[9]=xm[10]=xm[11]=xm[12]=xm[13]=xm[14]=xm[15]=0,this.blocks=xm):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Am.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===Em.ArrayBuffer&&(e=new Uint8Array(e));for(var n,r,s=0,a=e.length||0,i=this.blocks;s<a;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),t)for(r=this.start;s<a&&r<64;++s)i[r>>2]|=e[s]<<Tm[3&r++];else for(r=this.start;s<a&&r<64;++s)(n=e.charCodeAt(s))<128?i[r>>2]|=n<<Tm[3&r++]:n<2048?(i[r>>2]|=(192|n>>6)<<Tm[3&r++],i[r>>2]|=(128|63&n)<<Tm[3&r++]):n<55296||n>=57344?(i[r>>2]|=(224|n>>12)<<Tm[3&r++],i[r>>2]|=(128|n>>6&63)<<Tm[3&r++],i[r>>2]|=(128|63&n)<<Tm[3&r++]):(n=65536+((1023&n)<<10|1023&e.charCodeAt(++s)),i[r>>2]|=(240|n>>18)<<Tm[3&r++],i[r>>2]|=(128|n>>12&63)<<Tm[3&r++],i[r>>2]|=(128|n>>6&63)<<Tm[3&r++],i[r>>2]|=(128|63&n)<<Tm[3&r++]);this.lastByteIndex=r,this.bytes+=r-this.start,r>=64?(this.block=i[16],this.start=r-64,this.hash(),this.hashed=!0):this.start=r}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296|0,this.bytes=this.bytes%4294967296),this}},Am.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=Sm[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},Am.prototype.hash=function(){var e,t,n=this.h0,r=this.h1,s=this.h2,a=this.h3,i=this.h4,o=this.blocks;for(e=16;e<80;++e)t=o[e-3]^o[e-8]^o[e-14]^o[e-16],o[e]=t<<1|t>>>31;for(e=0;e<20;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r&s|~r&a)+i+1518500249+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|~n&s)+a+1518500249+o[e+1]|0)<<5|a>>>27)+(i&(n=n<<30|n>>>2)|~i&r)+s+1518500249+o[e+2]|0)<<5|s>>>27)+(a&(i=i<<30|i>>>2)|~a&n)+r+1518500249+o[e+3]|0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|~s&i)+n+1518500249+o[e+4]|0,s=s<<30|s>>>2;for(;e<40;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r^s^a)+i+1859775393+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^s)+a+1859775393+o[e+1]|0)<<5|a>>>27)+(i^(n=n<<30|n>>>2)^r)+s+1859775393+o[e+2]|0)<<5|s>>>27)+(a^(i=i<<30|i>>>2)^n)+r+1859775393+o[e+3]|0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^i)+n+1859775393+o[e+4]|0,s=s<<30|s>>>2;for(;e<60;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r&s|r&a|s&a)+i-1894007588+o[e]|0)<<5|i>>>27)+(n&(r=r<<30|r>>>2)|n&s|r&s)+a-1894007588+o[e+1]|0)<<5|a>>>27)+(i&(n=n<<30|n>>>2)|i&r|n&r)+s-1894007588+o[e+2]|0)<<5|s>>>27)+(a&(i=i<<30|i>>>2)|a&n|i&n)+r-1894007588+o[e+3]|0)<<5|r>>>27)+(s&(a=a<<30|a>>>2)|s&i|a&i)+n-1894007588+o[e+4]|0,s=s<<30|s>>>2;for(;e<80;e+=5)n=(t=(r=(t=(s=(t=(a=(t=(i=(t=n<<5|n>>>27)+(r^s^a)+i-899497514+o[e]|0)<<5|i>>>27)+(n^(r=r<<30|r>>>2)^s)+a-899497514+o[e+1]|0)<<5|a>>>27)+(i^(n=n<<30|n>>>2)^r)+s-899497514+o[e+2]|0)<<5|s>>>27)+(a^(i=i<<30|i>>>2)^n)+r-899497514+o[e+3]|0)<<5|r>>>27)+(s^(a=a<<30|a>>>2)^i)+n-899497514+o[e+4]|0,s=s<<30|s>>>2;this.h0=this.h0+n|0,this.h1=this.h1+r|0,this.h2=this.h2+s|0,this.h3=this.h3+a|0,this.h4=this.h4+i|0},Am.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4;return Om[e>>28&15]+Om[e>>24&15]+Om[e>>20&15]+Om[e>>16&15]+Om[e>>12&15]+Om[e>>8&15]+Om[e>>4&15]+Om[15&e]+Om[t>>28&15]+Om[t>>24&15]+Om[t>>20&15]+Om[t>>16&15]+Om[t>>12&15]+Om[t>>8&15]+Om[t>>4&15]+Om[15&t]+Om[n>>28&15]+Om[n>>24&15]+Om[n>>20&15]+Om[n>>16&15]+Om[n>>12&15]+Om[n>>8&15]+Om[n>>4&15]+Om[15&n]+Om[r>>28&15]+Om[r>>24&15]+Om[r>>20&15]+Om[r>>16&15]+Om[r>>12&15]+Om[r>>8&15]+Om[r>>4&15]+Om[15&r]+Om[s>>28&15]+Om[s>>24&15]+Om[s>>20&15]+Om[s>>16&15]+Om[s>>12&15]+Om[s>>8&15]+Om[s>>4&15]+Om[15&s]},Am.prototype.toString=Am.prototype.hex,Am.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,n=this.h2,r=this.h3,s=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,s>>24&255,s>>16&255,s>>8&255,255&s]},Am.prototype.array=Am.prototype.digest,Am.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};const Im=(...e)=>{return t=e.join("_"),new Am(!0).update(t).hex();var t};class Pm{}const Cm=new Map;class Rm extends Pm{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Im(e,t))??null)}async update(e,t,n){this.cache.set(Im(e,t),n)}static global(){return new Rm(Cm)}}class Nm extends hc{}class $m extends Nm{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new xc(this.value)]}}class jm extends Nm{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Nc(this.messages)}toChatMessages(){return this.messages}}class Lm extends Nm{static lc_name(){return"ImagePromptValue"}constructor(e){"imageUrl"in e||(e={imageUrl:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"imageUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.imageUrl=e.imageUrl}toString(){return this.imageUrl.url}toChatMessages(){return[new xc({content:[{type:"image_url",image_url:{detail:this.imageUrl.detail,url:this.imageUrl.url}}]})]}}for(var Mm={byteLength:function(e){var t=zm(e),n=t[0],r=t[1];return 3*(n+r)/4-r},toByteArray:function(e){var t,n,r=zm(e),s=r[0],a=r[1],i=new Fm(function(e,t,n){return 3*(t+n)/4-n}(0,s,a)),o=0,l=a>0?s-4:s;for(n=0;n<l;n+=4)t=Um[e.charCodeAt(n)]<<18|Um[e.charCodeAt(n+1)]<<12|Um[e.charCodeAt(n+2)]<<6|Um[e.charCodeAt(n+3)],i[o++]=t>>16&255,i[o++]=t>>8&255,i[o++]=255&t;2===a&&(t=Um[e.charCodeAt(n)]<<2|Um[e.charCodeAt(n+1)]>>4,i[o++]=255&t);1===a&&(t=Um[e.charCodeAt(n)]<<10|Um[e.charCodeAt(n+1)]<<4|Um[e.charCodeAt(n+2)]>>2,i[o++]=t>>8&255,i[o++]=255&t);return i},fromByteArray:function(e){for(var t,n=e.length,r=n%3,s=[],a=16383,i=0,o=n-r;i<o;i+=a)s.push(Hm(e,i,i+a>o?o:i+a));1===r?(t=e[n-1],s.push(Dm[t>>2]+Dm[t<<4&63]+"==")):2===r&&(t=(e[n-2]<<8)+e[n-1],s.push(Dm[t>>10]+Dm[t>>4&63]+Dm[t<<2&63]+"="));return s.join("")}},Dm=[],Um=[],Fm="undefined"!=typeof Uint8Array?Uint8Array:Array,Bm="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",qm=0;qm<64;++qm)Dm[qm]=Bm[qm],Um[Bm.charCodeAt(qm)]=qm;function zm(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var n=e.indexOf("=");return-1===n&&(n=t),[n,n===t?0:4-n%4]}function Hm(e,t,n){for(var r,s,a=[],i=t;i<n;i+=3)r=(e[i]<<16&16711680)+(e[i+1]<<8&65280)+(255&e[i+2]),a.push(Dm[(s=r)>>18&63]+Dm[s>>12&63]+Dm[s>>6&63]+Dm[63&s]);return a.join("")}Um["-".charCodeAt(0)]=62,Um["_".charCodeAt(0)]=63;var Wm=Object.defineProperty;function Km(e,t){return 1===e.length?[t.get(e.join(","))]:function(e,t){let n=Array.from({length:e.length},((e,t)=>({start:t,end:t+1})));for(;n.length>1;){let r=null;for(let s=0;s<n.length-1;s++){const a=e.slice(n[s].start,n[s+1].end),i=t.get(a.join(","));null!=i&&(null==r||i<r[0])&&(r=[i,s])}if(null==r)break;{const e=r[1];n[e]={start:n[e].start,end:n[e+1].end},n.splice(e+1,1)}}return n}(e,t).map((n=>t.get(e.slice(n.start,n.end).join(",")))).filter((e=>null!=e))}var Vm,Gm=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){this.patStr=e.pat_str;const n=e.bpe_ranks.split("\n").filter(Boolean).reduce(((e,t)=>{const[n,r,...s]=t.split(" "),a=Number.parseInt(r,10);return s.forEach(((t,n)=>e[t]=a+n)),e}),{});for(const[e,t]of Object.entries(n)){const n=Mm.toByteArray(e);this.rankMap.set(n.join(","),t),this.textMap.set(t,n)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce(((e,[t,n])=>(e[n]=this.textEncoder.encode(t),e)),{})}encode(e,t=[],n="all"){const r=new RegExp(this.patStr,"ug"),s=Gm.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===n?Object.keys(this.specialTokens).filter((e=>!i.has(e))):n);if(o.size>0){const t=Gm.specialTokenRegex([...o]),n=e.match(t);if(null!=n)throw new Error(`The text contains a special token that is not allowed: ${n[0]}`)}let l=0;for(;;){let t=null,n=l;for(;s.lastIndex=n,t=s.exec(e),null!=t&&!i.has(t[0]);)n=t.index+1;const o=t?.index??e.length;for(const t of e.substring(l,o).matchAll(r)){const e=this.textEncoder.encode(t[0]),n=this.rankMap.get(e.join(","));null==n?a.push(...Km(e,this.rankMap)):a.push(n)}if(null==t)break;let c=this.specialTokens[t[0]];a.push(c),l=t.index+t[0].length}return a}decode(e){const t=[];let n=0;for(let r=0;r<e.length;++r){const s=e[r],a=this.textMap.get(s)??this.inverseSpecialTokens[s];null!=a&&(t.push(a),n+=a.length)}const r=new Uint8Array(n);let s=0;for(const e of t)r.set(e,s),s+=e.length;return this.textDecoder.decode(r)}},Zm=Gm;Vm=e=>new RegExp(e.map((e=>function(e){return e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}(e))).join("|"),"g"),((e,t,n)=>{t in e?Wm(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n})(Zm,"specialTokenRegex"+"",Vm);const Jm={},Xm=new Zf({});async function Ym(e){return async function(e){return e in Jm||(Jm[e]=Xm.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then((e=>e.json())).then((e=>new Zm(e))).catch((t=>{throw delete Jm[e],t}))),await Jm[e]}(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"o1-mini":case"o1-preview":case"o1-preview-2024-09-12":case"o1-mini-2024-09-12":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":return"o200k_base";default:throw new Error("Unknown model")}}(e))}function Qm(e){return!("object"!=typeof e||!e)&&!!("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&e.function&&"name"in e.function&&"parameters"in e.function)}class eg extends um{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class tg extends eg{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...n}){super({callbacks:e??t,...n}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof n.cache?this.cache=n.cache:n.cache?this.cache=Rm.global():this.cache=void 0,this.caller=new Zf(n??{})}async getNumTokens(e){if("string"!=typeof e)return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Ym("modelName"in this?(n=this.modelName,n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n.startsWith("gpt-4o")?"gpt-4o":n):"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}var n;if(this._encoding)try{t=this._encoding.encode(e).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return t}static _convertInputToPromptValue(e){return"string"==typeof e?new $m(e):Array.isArray(e)?new jm(e.map(Rc)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){const n={...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()},r=Object.entries(n).filter((([e,t])=>void 0!==t)),s=r.map((([e,t])=>`${e}:${JSON.stringify(t)}`)).sort().join(",");return s}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class ng extends um{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){const n=Wf(t);return this.func&&await this.func(e,n),this._callWithConfig((e=>Promise.resolve(e)),e,n)}async*transform(e,t){const n=Wf(t);let r,s=!0;for await(const t of this._transformStreamWithConfig(e,(e=>e),n))if(yield t,s)if(void 0===r)r=t;else try{r=Kp(r,t)}catch{r=void 0,s=!1}this.func&&void 0!==r&&await this.func(r,n)}static assign(e){return new vm(new mm({steps:e}))}}function rg(e){return"function"==typeof e?.parse}class sg extends tg{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,n]=super._separateRunnableConfigFromCallOptions(e);return n?.timeout&&!n.signal&&(n.signal=AbortSignal.timeout(n.timeout)),[t,n]}async invoke(e,t){const n=sg._convertInputToPromptValue(e);return(await this.generatePrompt([n],t,t?.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,n){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===sg.prototype._streamResponseChunks)yield this.invoke(e,t);else{const n=sg._convertInputToPromptValue(e).toChatMessages(),[r,s]=this._separateRunnableConfigFromCallOptions(t),a={...r.metadata,...this.getLsParams(s)},i=await Ff.configure(r.callbacks,this.callbacks,r.tags,this.tags,a,this.metadata,{verbose:this.verbose}),o={options:s,invocation_params:this?.invocationParams(s),batch_size:1},l=await(i?.handleChatModelStart(this.toJSON(),[n],r.runId,void 0,o,void 0,void 0,r.runName));let c;try{for await(const e of this._streamResponseChunks(n,s,l?.[0]))e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,c=c?c.concat(e):e}catch(e){throw await Promise.all((l??[]).map((t=>t?.handleLLMError(e)))),e}await Promise.all((l??[]).map((e=>e?.handleLLMEnd({generations:[[c]]}))))}}getLsParams(e){return{ls_model_type:"chat",ls_stop:e.stop}}async _generateUncached(e,t,n){const r=e.map((e=>e.map(Rc))),s={...n.metadata,...this.getLsParams(t)},a=await Ff.configure(n.callbacks,this.callbacks,n.tags,this.tags,s,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this?.invocationParams(t),batch_size:1},o=await(a?.handleChatModelStart(this.toJSON(),r,n.runId,void 0,i,void 0,void 0,n.runName)),l=[],c=[];if(!!o?.[0].handlers.find((e=>sf(e)||Jp(e)))&&1===r.length&&this._streamResponseChunks!==sg.prototype._streamResponseChunks)try{const e=await this._streamResponseChunks(r[0],t,o?.[0]);let n;for await(const t of e)n=void 0===n?t:Kp(n,t);if(void 0===n)throw new Error("Received empty response from chat model call.");l.push([n]),await(o?.[0].handleLLMEnd({generations:l,llmOutput:{}}))}catch(e){throw await(o?.[0].handleLLMError(e)),e}else{const e=await Promise.allSettled(r.map(((e,n)=>this._generate(e,{...t,promptIndex:n},o?.[n]))));await Promise.all(e.map((async(e,t)=>{if("fulfilled"===e.status){const n=e.value;for(const e of n.generations)e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};return 1===n.generations.length&&(n.generations[0].message.response_metadata={...n.llmOutput,...n.generations[0].message.response_metadata}),l[t]=n.generations,c[t]=n.llmOutput,o?.[t]?.handleLLMEnd({generations:[n.generations],llmOutput:n.llmOutput})}return await(o?.[t]?.handleLLMError(e.reason)),Promise.reject(e.reason)})))}const u={generations:l,llmOutput:c.length?this._combineLLMOutput?.(...c):void 0};return Object.defineProperty(u,ef,{value:o?{runIds:o?.map((e=>e.runId))}:void 0,configurable:!0}),u}async _generateCached({messages:e,cache:t,llmStringKey:n,parsedOptions:r,handledOptions:s}){const a=e.map((e=>e.map(Rc))),i={...s.metadata,...this.getLsParams(r)},o=await Ff.configure(s.callbacks,this.callbacks,s.tags,this.tags,i,this.metadata,{verbose:this.verbose}),l={options:r,invocation_params:this?.invocationParams(r),batch_size:1,cached:!0},c=await(o?.handleChatModelStart(this.toJSON(),a,s.runId,void 0,l,void 0,void 0,s.runName)),u=[],d=await Promise.allSettled(a.map((async(e,r)=>{const s=sg._convertInputToPromptValue(e).toString(),a=await t.lookup(s,n);return null==a&&u.push(r),a}))),h=d.map(((e,t)=>({result:e,runManager:c?.[t]}))).filter((({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status)),p=[];await Promise.all(h.map((async({result:e,runManager:t},n)=>{if("fulfilled"===e.status){const r=e.value;return p[n]=r,r.length&&await(t?.handleLLMNewToken(r[0].text)),t?.handleLLMEnd({generations:[r]})}return await(t?.handleLLMError(e.reason)),Promise.reject(e.reason)})));const f={generations:p,missingPromptIndices:u};return Object.defineProperty(f,ef,{value:c?{runIds:c?.map((e=>e.runId))}:void 0,configurable:!0}),f}async generate(e,t,n){let r;r=Array.isArray(t)?{stop:t}:t;const s=e.map((e=>e.map(Rc))),[a,i]=this._separateRunnableConfigFromCallOptions(r);if(a.callbacks=a.callbacks??n,!this.cache)return this._generateUncached(s,i,a);const{cache:o}=this,l=this._getSerializedCacheKeyParametersForCall(i),{generations:c,missingPromptIndices:u}=await this._generateCached({messages:s,cache:o,llmStringKey:l,parsedOptions:i,handledOptions:a});let d={};if(u.length>0){const e=await this._generateUncached(u.map((e=>s[e])),i,a);await Promise.all(e.generations.map((async(e,t)=>{const n=u[t];c[n]=e;const r=sg._convertInputToPromptValue(s[n]).toString();return o.update(r,l,e)}))),d=e.llmOutput??{}}return{generations:c,llmOutput:d}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,n){const r=e.map((e=>e.toChatMessages()));return this.generate(r,t,n)}async call(e,t,n){return(await this.generate([e.map(Rc)],t,n)).generations[0][0].message}async callPrompt(e,t,n){const r=e.toChatMessages();return this.call(r,t,n)}async predictMessages(e,t,n){return this.call(e,t,n)}async predict(e,t,n){const r=new xc(e),s=await this.call([r],t,n);if("string"!=typeof s.content)throw new Error("Cannot use predict when output is not a string.");return s.content}withStructuredOutput(e,t){if("function"!=typeof this.bindTools)throw new Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');const n=e,r=t?.name,s=n.description??"A function available to call.",a=t?.method,i=t?.includeRaw;if("jsonMode"===a)throw new Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o,l=r??"extract";rg(n)?o=[{type:"function",function:{name:l,description:s,parameters:Ps(n)}}]:("name"in n&&(l=n.name),o=[{type:"function",function:{name:l,description:s,parameters:n}}]);const c=this.bindTools(o),u=ym.from((e=>{if(!e.tool_calls||0===e.tool_calls.length)throw new Error("No tool calls found in the response.");const t=e.tool_calls.find((e=>e.name===l));if(!t)throw new Error(`No tool call found with name ${l}.`);return t.args}));if(!i)return c.pipe(u).withConfig({runName:"StructuredOutput"});const d=ng.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),h=ng.assign({parsed:()=>null}),p=d.withFallbacks({fallbacks:[h]});return fm.from([{raw:c},p]).withConfig({runName:"StructuredOutputRunnable"})}}function ag(e){return{name:e.name,description:e.description,parameters:Ps(e.schema)}}function ig(e){return og(e)||function(e){return void 0!==e&&um.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()}(e)?{type:"function",function:ag(e)}:e}function og(e){return void 0!==e&&Array.isArray(e.lc_namespace)}class lg extends dm{constructor(e){let t=new ym({func:(e,t)=>this._enterHistory(e,t??{})}).withConfig({runName:"loadHistory"});const n=e.historyMessagesKey??e.inputMessagesKey;n&&(t=ng.assign({[n]:t}).withConfig({runName:"insertHistory"}));const r=t.pipe(e.runnable.withListeners({onEnd:(e,t)=>this._exitHistory(e,t??{})})).withConfig({runName:"RunnableWithMessageHistory"}),s=e.config??{};super({...e,config:s,bound:r}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"historyMessagesKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"getMessageHistory",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.getMessageHistory=e.getMessageHistory,this.inputMessagesKey=e.inputMessagesKey,this.outputMessagesKey=e.outputMessagesKey,this.historyMessagesKey=e.historyMessagesKey}_getInputMessages(e){let t;if("object"!=typeof e||Array.isArray(e)||wc(e))t=e;else{let n;n=this.inputMessagesKey?this.inputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"input",t=Array.isArray(e[n])&&Array.isArray(e[n][0])?e[n][0]:e[n]}if("string"==typeof t)return[new xc(t)];if(Array.isArray(t))return t;if(wc(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages.\nGot ${JSON.stringify(t,null,2)}`)}_getOutputMessages(e){let t;if(Array.isArray(e)||wc(e)||"string"==typeof e)t=e;else{let n;n=void 0!==this.outputMessagesKey?this.outputMessagesKey:1===Object.keys(e).length?Object.keys(e)[0]:"output",t=void 0!==e.generations?e.generations[0][0].message:e[n]}if("string"==typeof t)return[new _c(t)];if(Array.isArray(t))return t;if(wc(t))return[t];throw new Error(`Expected a string, BaseMessage, or array of BaseMessages. Received: ${JSON.stringify(t,null,2)}`)}async _enterHistory(e,t){const n=t?.configurable?.messageHistory,r=await n.getMessages();return void 0===this.historyMessagesKey?r.concat(this._getInputMessages(e)):r}async _exitHistory(e,t){const n=t.configurable?.messageHistory;let r;r=Array.isArray(e.inputs)&&Array.isArray(e.inputs[0])?e.inputs[0]:e.inputs;let s=this._getInputMessages(r);if(void 0===this.historyMessagesKey){const e=await n.getMessages();s=s.slice(e.length)}const a=e.outputs;if(!a)throw new Error(`Output values from 'Run' undefined. Run: ${JSON.stringify(e,null,2)}`);const i=this._getOutputMessages(a);await n.addMessages([...s,...i])}async _mergeConfig(...e){const t=await super._mergeConfig(...e);if(!t.configurable||!t.configurable.sessionId){const e={[this.inputMessagesKey??"input"]:"foo"},t={configurable:{sessionId:"123"}};throw new Error(`sessionId is required. Pass it in as part of the config argument to .invoke() or .stream()\neg. chain.invoke(${JSON.stringify(e)}, ${JSON.stringify(t)})`)}const{sessionId:n}=t.configurable;return t.configurable.messageHistory=await this.getMessageHistory(n),t}}class cg extends um{parseResultWithPrompt(e,t,n){return this.parseResult(e,n)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig((async(e,t)=>this.parseResult([{text:e}],t?.callbacks)),e,{...t,runType:"parser"}):this._callWithConfig((async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks)),e,{...t,runType:"parser"})}}class ug extends cg{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,n){return this.parse(e,n)}_type(){throw new Error("_type not implemented")}}class dg extends Error{constructor(e,t,n,r=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=n,this.sendToLLM=r,r&&(void 0===n||void 0===t))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}}function hg(e,t){const n=typeof e;if(n!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;const n=e.length;if(n!==t.length)return!1;for(let r=0;r<n;r++)if(!hg(e[r],t[r]))return!1;return!0}if("object"===n){if(!e||!t)return e===t;const n=Object.keys(e),r=Object.keys(t);if(n.length!==r.length)return!1;for(const r of n)if(!hg(e[r],t[r]))return!1;return!0}return e===t}class pg extends ug{async*_transform(e){for await(const t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class fg extends pg{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async*_transform(e){let t,n;for await(const s of e){if("string"!=typeof s&&"string"!=typeof s.content)throw new Error("Cannot handle non-string output.");let e;if(wc(r=s)&&"function"==typeof r.concat){if("string"!=typeof s.content)throw new Error("Cannot handle non-string message output.");e=new nf({message:s,text:s.content})}else if(wc(s)){if("string"!=typeof s.content)throw new Error("Cannot handle non-string message output.");e=new nf({message:$c(s),text:s.content})}else e=new tf({text:s});n=void 0===n?e:n.concat(e);const a=await this.parsePartialResult([n]);null==a||hg(a,t)||(this.diff?yield this._diff(t,a):yield a,t=a)}var r}}class mg extends pg{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}_textContentToString(e){return e.text}_imageUrlContentToString(e){throw new Error('Cannot coerce a multimodal "image_url" message part into a string.')}_messageContentComplexToString(e){switch(e.type){case"text":if("text"in e)return this._textContentToString(e);break;case"image_url":if("image_url"in e)return this._imageUrlContentToString(e);break;default:throw new Error(`Cannot coerce "${e.type}" message part into a string.`)}throw new Error(`Invalid content type: ${e.type}`)}_baseMessageContentToString(e){return e.reduce(((e,t)=>e+this._messageContentComplexToString(t)),"")}}class gg extends ug{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(ss.object(Object.fromEntries(Object.entries(e).map((([e,t])=>[e,ss.string().describe(t)])))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.\n\n"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.\n\nFor example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}\nwould match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.\nThus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.\n\nYour output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!\n\nHere is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:\n\`\`\`json\n${JSON.stringify(Ps(this.schema))}\n\`\`\`\n`}async parse(e){try{const t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,((e,t)=>`"${t.replace(/\n/g,"\\n")}"`)).replace(/\n/g,"");return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new dg(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class yg extends fg{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Rp(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Vl(e[0].text)}async parse(e){return Vl(e,JSON.parse)}getFormatInstructions(){return""}}function bg(e,t){if(void 0===e.function)return;let n;if(t?.partial)try{n=Gl(e.function.arguments??"{}")}catch(e){return}else try{n=JSON.parse(e.function.arguments)}catch(t){throw new dg([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"","are not valid JSON.",`Error: ${t.message}`].join("\n"))}const r={name:e.function.name,args:n,type:"tool_call"};return t?.returnId&&(r.id=e.id),r}function wg(e){if(void 0===e.id)throw new Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function vg(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class _g extends cg{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}async parseResult(e){const t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);const n=JSON.parse(JSON.stringify(t)),r=[];for(const e of n){const t=bg(e,{partial:!0});if(void 0!==t){const e={type:t.name,args:t.args,id:t.id};Object.defineProperty(e,"name",{get(){return this.type}}),Object.defineProperty(e,"arguments",{get(){return this.args}}),r.push(e)}}return r}}class kg extends cg{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.initialParser=new _g(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new dg(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=(await this.initialParser.parseResult(e)).filter((e=>e.type===this.keyName));let n=t;if(this.returnId||(n=t.map((e=>e.args))),this.returnSingle)return this._validateResult(n[0]);const r=await Promise.all(n.map((e=>this._validateResult(e))));return r}}function Eg(e,t){const n=[];for(const[r,s]of Object.entries(e.properties??{}))s.description&&t<2&&n.push(`// ${s.description}`),e.required?.includes(r)?n.push(`${r}: ${Og(s,t)},`):n.push(`${r}?: ${Og(s,t)},`);return n.map((e=>" ".repeat(t)+e)).join("\n")}function Og(e,t){if(void 0!==(n=e).anyOf&&Array.isArray(n.anyOf))return e.anyOf.map((e=>Og(e,t))).join(" | ");var n;switch(e.type){case"string":return e.enum?e.enum.map((e=>`"${e}"`)).join(" | "):"string";case"number":case"integer":return e.enum?e.enum.map((e=>`${e}`)).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Eg(e,t+2),"}"].join("\n");case"array":return e.items?`${Og(e.items,t)}[]`:"any[]";default:return""}}function Sg(e){const t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!Oc.isInstance(e))throw new Error("Invalid generic chat message");return function(e){return"system"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role}(e);default:throw new Error(`Unknown message type: ${t}`)}}function Tg(e,t){const n=e.tool_calls;if("assistant"===e.role){const r=[],s=[];for(const e of n??[])try{r.push(bg(e,{returnId:!0}))}catch(t){s.push(vg(e,t.message))}return new _c({content:e.content||"",tool_calls:r,invalid_tool_calls:s,additional_kwargs:{function_call:e.function_call,tool_calls:n},id:t})}return new Oc(e.content||"",e.role??"unknown")}function xg(e,t,n){const r=e.role??n,s=e.content??"";let a;if(a=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},"user"===r)return new Ac({content:s});if("assistant"===r){const n=[];if(Array.isArray(e.tool_calls))for(const t of e.tool_calls)n.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new Ec({content:s,tool_call_chunks:n,additional_kwargs:a,id:t})}return"system"===r?new Pc({content:s}):"function"===r?new Tc({content:s,additional_kwargs:a,name:e.name}):"tool"===r?new vc({content:s,additional_kwargs:a,tool_call_id:e.tool_call_id}):new Sc({content:s,role:r})}function Ag(e){return e.map((e=>{const t={role:Sg(e),content:e.content};return null!=e.name&&(t.name=e.name),null!=e.additional_kwargs.function_call&&(t.function_call=e.additional_kwargs.function_call,t.content=null),kc(e)&&e.tool_calls?.length?(t.tool_calls=e.tool_calls.map(wg),t.content=null):(null!=e.additional_kwargs.tool_calls&&(t.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(t.tool_call_id=e.tool_call_id)),t}))}class Ig extends sg{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureADTokenProvider",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??Mp("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.azureOpenAIApiKey=e?.azureOpenAIApiKey??Mp("AZURE_OPENAI_API_KEY"),this.azureADTokenProvider=e?.azureADTokenProvider??void 0,!this.azureOpenAIApiKey&&!this.apiKey&&!this.azureADTokenProvider)throw new Error("OpenAI or Azure OpenAI API key or Token Provider not found");if(this.azureOpenAIApiInstanceName=e?.azureOpenAIApiInstanceName??Mp("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=e?.azureOpenAIApiDeploymentName??Mp("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=e?.azureOpenAIApiVersion??Mp("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=e?.azureOpenAIBasePath??Mp("AZURE_OPENAI_BASE_PATH"),this.organization=e?.configuration?.organization??Mp("OPENAI_ORGANIZATION"),this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.maxTokens=e?.maxTokens,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this?.stop,this.user=e?.user,this.azureOpenAIApiKey||this.azureADTokenProvider){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.apiKey=this.apiKey??"",this.streamUsage=!1}this.streaming=e?.streaming??!1,this.streamUsage=e?.streamUsage??this.streamUsage,this.clientConfig={apiKey:this.apiKey,organization:this.organization,baseURL:t?.basePath??e?.configuration?.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:t?.baseOptions?.headers??e?.configuration?.baseOptions?.headers,defaultQuery:t?.baseOptions?.params??e?.configuration?.baseOptions?.params,...t,...e?.configuration}}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){return this.bind({tools:e.map(ig),...t})}invocationParams(e,t){let n={};void 0!==e?.stream_options?n={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(n={stream_options:{include_usage:!0}});var r;return{model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:-1===this.maxTokens?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:(r=e?.tools,void 0!==r&&r.every((e=>Array.isArray(e.lc_namespace)))?e?.tools.map(ig):e?.tools),tool_choice:e?.tool_choice,response_format:e?.response_format,seed:e?.seed,...n,parallel_tool_calls:e?.parallel_tool_calls,...this.modelKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,n){const r=Ag(e),s={...this.invocationParams(t,{streaming:!0}),messages:r,stream:!0};let a;const i=await this.completionWithRetry(s,t);let o;for await(const e of i){const r=e?.choices[0];if(e.usage&&(o=e.usage),!r)continue;const{delta:s}=r;if(!s)continue;const i=xg(s,e.id,a);a=s.role??a;const l={prompt:t.promptIndex??0,completion:r.index??0};if("string"!=typeof i.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const c={...l};void 0!==r.finish_reason&&(c.finish_reason=r.finish_reason),this.logprobs&&(c.logprobs=r.logprobs);const u=new nf({message:i,text:i.content,generationInfo:c});yield u,await(n?.handleLLMNewToken(u.text??"",l,void 0,void 0,void 0,{chunk:u}))}if(o){const e=new nf({message:new Ec({content:"",usage_metadata:{input_tokens:o.prompt_tokens,output_tokens:o.completion_tokens,total_tokens:o.total_tokens}}),text:""});yield e}if(t.signal?.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,n){const r={},s=this.invocationParams(t),a=Ag(e);if(s.stream){const s=this._streamResponseChunks(e,t,n),a={};for await(const e of s){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};const t=e.generationInfo?.completion??0;void 0===a[t]?a[t]=e:a[t]=a[t].concat(e)}const i=Object.entries(a).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t)),{functions:o,function_call:l}=this.invocationParams(t),c=await this.getEstimatedTokenCountFromPrompt(e,o,l),u=await this.getNumTokensFromGenerations(i);return r.promptTokens=c,r.completionTokens=u,r.totalTokens=c+u,{generations:i,llmOutput:{estimatedTokenUsage:r}}}{const e=await this.completionWithRetry({...s,stream:!1,messages:a},{signal:t?.signal,...t?.options}),{completion_tokens:n,prompt_tokens:i,total_tokens:o}=e?.usage??{};n&&(r.completionTokens=(r.completionTokens??0)+n),i&&(r.promptTokens=(r.promptTokens??0)+i),o&&(r.totalTokens=(r.totalTokens??0)+o);const l=[];for(const t of e?.choices??[]){const n={text:t.message?.content??"",message:Tg(t.message??{role:"assistant"},e.id)};n.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},kc(n.message)&&(n.message.usage_metadata={input_tokens:r.promptTokens??0,output_tokens:r.completionTokens??0,total_tokens:r.totalTokens??0}),l.push(n)}return{generations:l,llmOutput:{tokenUsage:r}}}}async getEstimatedTokenCountFromPrompt(e,t,n){let r=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==n){const e=function(e){const t=["namespace functions {",""];for(const n of e)n.description&&t.push(`// ${n.description}`),Object.keys(n.parameters.properties??{}).length>0?(t.push(`type ${n.name} = (_: {`),t.push(Eg(n.parameters,0)),t.push("}) => any;")):t.push(`type ${n.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);r+=await this.getNumTokens(e),r+=9}return t&&e.find((e=>"system"===e._getType()))&&(r-=4),"none"===n?r+=1:"object"==typeof n&&(r+=await this.getNumTokens(n.name)+4),r}async getNumTokensFromGenerations(e){return(await Promise.all(e.map((async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content))))).reduce(((e,t)=>e+t),0)}async getNumTokensFromMessages(e){let t=0,n=0,r=0;"gpt-3.5-turbo-0301"===this.model?(n=4,r=-1):(n=3,r=1);const s=await Promise.all(e.map((async e=>{const s=await this.getNumTokens(e.content),a=await this.getNumTokens(Sg(e)),i=void 0!==e.name?r+await this.getNumTokens(e.name):0;let o=s+n+a+i;const l=e;if("function"===l._getType()&&(o-=2),l.additional_kwargs?.function_call&&(o+=3),l?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(l.additional_kwargs.function_call?.name)),l.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(l.additional_kwargs.function_call?.arguments)))}catch(e){console.error("Error parsing function arguments",e,JSON.stringify(l.additional_kwargs.function_call)),o+=await this.getNumTokens(l.additional_kwargs.function_call?.arguments)}return t+=o,o})));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){const n=this._getClientOptions(t);return this.caller.call((async()=>{try{return await this.client.chat.completions.create(e,n)}catch(e){const t=function(e){let t;return e.constructor.name===da.name?(t=new Error(e.message),t.name="TimeoutError"):e.constructor.name===ca.name?(t=new Error(e.message),t.name="AbortError"):t=e,t}(e);throw t}}))}_getClientOptions(e){if(!this.client){const e=function(e){const{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:n,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:a,azureADTokenProvider:i}=e;if((r||i)&&s&&t)return`${s}/${t}`;if(r||i){if(!n)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${n}.openai.azure.com/openai/deployments/${t}`}return a}({azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new Kl(t)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce(((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e)),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){let n,r,s,a,i,o;if(!function(e){return void 0!==e&&"object"==typeof e.schema}(e)?(n=e,r=t?.name,s=t?.method,a=t?.includeRaw):(n=e.schema,r=e.name,s=e.method,a=e.includeRaw),"jsonMode"===s)i=this.bind({response_format:{type:"json_object"}}),o=Pg(n)?gg.fromZodSchema(n):new yg;else{let e=r??"extract";if(Pg(n)){const t=Ps(n);i=this.bind({tools:[{type:"function",function:{name:e,description:t.description,parameters:t}}],tool_choice:{type:"function",function:{name:e}}}),o=new kg({returnSingle:!0,keyName:e,zodSchema:n})}else{let t;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(t=n,e=n.name):(e=n.title??e,t={name:e,description:n.description??"",parameters:n}),i=this.bind({tools:[{type:"function",function:t}],tool_choice:{type:"function",function:{name:e}}}),o=new kg({returnSingle:!0,keyName:e})}}if(!a)return i.pipe(o);const l=ng.assign({parsed:(e,t)=>o.invoke(e.raw,t)}),c=ng.assign({parsed:()=>null}),u=l.withFallbacks({fallbacks:[c]});return fm.from([{raw:i},u])}}function Pg(e){return"function"==typeof e?.parse}const Cg="0.22.0";let Rg,Ng,$g,jg,Lg,Mg,Dg=!1;class Ug{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}Rg||function(e,t={auto:!1}){if(Dg)throw new Error(`you must \`import '@anthropic-ai/sdk/shims/${e.kind}'\` before importing anything else from @anthropic-ai/sdk`);if(Rg)throw new Error(`can't \`import '@anthropic-ai/sdk/shims/${e.kind}'\` after \`import '@anthropic-ai/sdk/shims/${Rg}'\``);Dg=t.auto,Rg=e.kind,Ng=e.fetch,$g=e.File,jg=e.ReadableStream,Lg=e.getDefaultAgent,Mg=e.fileFromPath}(function({manuallyImported:e}={}){const t=e?"You may need to use polyfills":"Add one of these imports before your first `import â€¦ from '@anthropic-ai/sdk'`:\n- `import '@anthropic-ai/sdk/shims/node'` (if you're running on Node)\n- `import '@anthropic-ai/sdk/shims/web'` (otherwise)\n";let n,r,s,a;try{n=fetch,r=Request,s=Response,a=Headers}catch(e){throw new Error(`this environment is missing the following Web Fetch API type: ${e.message}. ${t}`)}return{kind:"web",fetch:n,Request:r,Response:s,Headers:a,FormData:"undefined"!=typeof FormData?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${t}`)}},Blob:"undefined"!=typeof Blob?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${t}`)}},File:"undefined"!=typeof File?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${t}`)}},ReadableStream:"undefined"!=typeof ReadableStream?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${t}`)}},getMultipartRequestOptions:async(e,t)=>({...t,body:new Ug(e)}),getDefaultAgent:e=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/anthropics/anthropic-sdk-typescript#file-uploads")},isFsReadStream:e=>!1}}(),{auto:!0});class Fg extends Error{}class Bg extends Fg{constructor(e,t,n,r){super(`${Bg.makeMessage(e,t,n)}`),this.status=e,this.headers=r,this.error=t}static makeMessage(e,t,n){const r=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):n;return e&&r?`${e} ${r}`:e?`${e} status code (no body)`:r||"(no status code or body)"}static generate(e,t,n,r){if(!e)return new zg({cause:Ey(t)});const s=t;return 400===e?new Wg(e,s,n,r):401===e?new Kg(e,s,n,r):403===e?new Vg(e,s,n,r):404===e?new Gg(e,s,n,r):409===e?new Zg(e,s,n,r):422===e?new Jg(e,s,n,r):429===e?new Xg(e,s,n,r):e>=500?new Yg(e,s,n,r):new Bg(e,s,n,r)}}class qg extends Bg{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}}class zg extends Bg{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}}class Hg extends zg{constructor({message:e}={}){super({message:e??"Request timed out."})}}class Wg extends Bg{constructor(){super(...arguments),this.status=400}}class Kg extends Bg{constructor(){super(...arguments),this.status=401}}class Vg extends Bg{constructor(){super(...arguments),this.status=403}}class Gg extends Bg{constructor(){super(...arguments),this.status=404}}class Zg extends Bg{constructor(){super(...arguments),this.status=409}}class Jg extends Bg{constructor(){super(...arguments),this.status=422}}class Xg extends Bg{constructor(){super(...arguments),this.status=429}}class Yg extends Bg{}class Qg{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let n=!1;return new Qg((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const n of async function*(e,t){if(!e.body)throw t.abort(),new Fg("Attempted to iterate over a response with no body");const n=new ty,r=new ny,s=ry(e.body);for await(const e of async function*(e){let t=new Uint8Array;for await(const n of e){if(null==n)continue;const e=n instanceof ArrayBuffer?new Uint8Array(n):"string"==typeof n?(new TextEncoder).encode(n):n;let r,s=new Uint8Array(t.length+e.length);for(s.set(t),s.set(e,t.length),t=s;-1!==(r=ey(t));)yield t.slice(0,r),t=t.slice(r)}t.length>0&&(yield t)}(s))for(const t of r.decode(e)){const e=n.decode(t);e&&(yield e)}for(const e of r.flush()){const t=n.decode(e);t&&(yield t)}}(e,t)){if("completion"===n.event)try{yield JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("message_start"===n.event||"message_delta"===n.event||"message_stop"===n.event||"content_block_start"===n.event||"content_block_delta"===n.event||"content_block_stop"===n.event)try{yield JSON.parse(n.data)}catch(e){throw console.error("Could not parse message into JSON:",n.data),console.error("From chunk:",n.raw),e}if("ping"!==n.event&&"error"===n.event){const t=n.data,r=by(t),s=r?void 0:t;throw Bg.generate(void 0,r,s,hy(e.headers))}}r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}static fromReadableStream(e,t){let n=!1;return new Qg((async function*(){if(n)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let r=!1;try{for await(const t of async function*(){const t=new ny,n=ry(e);for await(const e of n)for(const n of t.decode(e))yield n;for(const e of t.flush())yield e}())r||t&&(yield JSON.parse(t));r=!0}catch(e){if(e instanceof Error&&"AbortError"===e.name)return;throw e}finally{r||t.abort()}}),t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],n=this.iterator(),r=r=>({next:()=>{if(0===r.length){const r=n.next();e.push(r),t.push(r)}return r.shift()}});return[new Qg((()=>r(e)),this.controller),new Qg((()=>r(t)),this.controller)]}toReadableStream(){const e=this;let t;const n=new TextEncoder;return new jg({async start(){t=e[Symbol.asyncIterator]()},async pull(e){try{const{value:r,done:s}=await t.next();if(s)return e.close();const a=n.encode(JSON.stringify(r)+"\n");e.enqueue(a)}catch(t){e.error(t)}},async cancel(){await(t.return?.())}})}}function ey(e){for(let t=0;t<e.length-2;t++){if(10===e[t]&&10===e[t+1])return t+2;if(13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return-1}class ty{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,n,r]=function(e,t){const n=e.indexOf(t);if(-1!==n)return[e.substring(0,n),t,e.substring(n+t.length)];return[e,"",""]}(e,":");return r.startsWith(" ")&&(r=r.substring(1)),"event"===t?this.event=r:"data"===t&&this.data.push(r),null}}class ny{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const n=ny.NEWLINE_CHARS.has(t[t.length-1]||"");let r=t.split(ny.NEWLINE_REGEXP);return n&&r.pop(),1!==r.length||n?(this.buffer.length>0&&(r=[this.buffer.join("")+r[0],...r.slice(1)],this.buffer=[]),n||(this.buffer=[r.pop()||""]),r):(this.buffer.push(r[0]),[])}decodeText(e){if(null==e)return"";if("string"==typeof e)return e;if("undefined"!=typeof Buffer){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new Fg(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if("undefined"!=typeof TextDecoder){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new Fg(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new Fg("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}function ry(e){if(e[Symbol.asyncIterator])return e;const t=e.getReader();return{async next(){try{const e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){const e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}ny.NEWLINE_CHARS=new Set(["\n","\r"]),ny.NEWLINE_REGEXP=/\r\n|[\n\r]/g;const sy=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;const ay=e=>"string"==typeof e?e:"undefined"!=typeof Buffer&&e instanceof Buffer?String(e):void 0,iy=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],oy=e=>e&&"object"==typeof e&&e.body&&"MultipartBody"===e[Symbol.toStringTag];async function ly(e){const{response:t}=e;if(e.options.stream)return Ay("response",t.status,t.url,t.headers,t.body),e.options.__streamClass?e.options.__streamClass.fromSSEResponse(t,e.controller):Qg.fromSSEResponse(t,e.controller);if(204===t.status)return null;if(e.options.__binaryResponse)return t;const n=t.headers.get("content-type");if(n?.includes("application/json")||n?.includes("application/vnd.api+json")){const e=await t.json();return Ay("response",t.status,t.url,t.headers,e),e}const r=await t.text();return Ay("response",t.status,t.url,t.headers,r),r}class cy extends Promise{constructor(e,t=ly){super((e=>{e(null)})),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new cy(this.responsePromise,(async t=>e(await this.parseResponse(t))))}asResponse(){return this.responsePromise.then((e=>e.response))}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class uy{constructor({baseURL:e,maxRetries:t=2,timeout:n=6e5,httpAgent:r,fetch:s}){this.baseURL=e,this.maxRetries=ky("maxRetries",t),this.timeout=ky("timeout",n),this.httpAgent=r,this.fetch=s??Ng}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...yy(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Iy()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,n){return this.request(Promise.resolve(n).then((n=>({method:e,path:t,...n}))))}getAPIList(e,t,n){return this.requestAPIList(t,{method:"get",path:e,...n})}calculateContentLength(e){if("string"==typeof e){if("undefined"!=typeof Buffer)return Buffer.byteLength(e,"utf8").toString();if("undefined"!=typeof TextEncoder){return(new TextEncoder).encode(e).length.toString()}}return null}buildRequest(e){const{method:t,path:n,query:r,headers:s={}}=e,a=oy(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,i=this.calculateContentLength(a),o=this.buildURL(n,r);"timeout"in e&&ky("timeout",e.timeout);const l=e.timeout??this.timeout,c=e.httpAgent??this.httpAgent??Lg(o),u=l+1e3;"number"==typeof c?.options?.timeout&&u>(c.options.timeout??0)&&(c.options.timeout=u),this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);return{req:{method:t,...a&&{body:a},headers:this.buildHeaders({options:e,headers:s,contentLength:i}),...c&&{agent:c},signal:e.signal??null},url:o,timeout:l}}buildHeaders({options:e,headers:t,contentLength:n}){const r={};n&&(r["content-length"]=n);return xy(r,this.defaultHeaders(e)),xy(r,t),oy(e.body)&&"node"!==Rg&&delete r["content-type"],this.validateHeaders(r,t),r}async prepareOptions(e){}async prepareRequest(e,{url:t,options:n}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map((e=>[...e]))):{...e}:{}}makeStatusError(e,t,n,r){return Bg.generate(e,t,n,r)}request(e,t=null){return new cy(this.makeRequest(e,t))}async makeRequest(e,t){const n=await e;null==t&&(t=n.maxRetries??this.maxRetries),await this.prepareOptions(n);const{req:r,url:s,timeout:a}=this.buildRequest(n);if(await this.prepareRequest(r,{url:s,options:n}),Ay("request",s,n,r.headers),n.signal?.aborted)throw new qg;const i=new AbortController,o=await this.fetchWithTimeout(s,r,a,i).catch(Ey);if(o instanceof Error){if(n.signal?.aborted)throw new qg;if(t)return this.retryRequest(n,t);if("AbortError"===o.name)throw new Hg;throw new zg({cause:o})}const l=hy(o.headers);if(!o.ok){if(t&&this.shouldRetry(o)){return Ay(`response (error; ${`retrying, ${t} attempts remaining`})`,o.status,s,l),this.retryRequest(n,t,l)}const e=await o.text().catch((e=>Ey(e).message)),r=by(e),a=r?void 0:e;Ay(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,o.status,s,l,a);throw this.makeStatusError(o.status,r,a,l)}return{response:o,options:n,controller:i}}requestAPIList(e,t){const n=this.makeRequest(t,null);return new dy(this,n,e)}buildURL(e,t){const n=vy(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),r=this.defaultQuery();return Sy(r)||(t={...r,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(n.search=this.stringifyQuery(t)),n.toString()}stringifyQuery(e){return Object.entries(e).filter((([e,t])=>void 0!==t)).map((([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new Fg(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)})).join("&")}async fetchWithTimeout(e,t,n,r){const{signal:s,...a}=t||{};s&&s.addEventListener("abort",(()=>r.abort()));const i=setTimeout((()=>r.abort()),n);return this.getRequestClient().fetch.call(void 0,e,{signal:r.signal,...a}).finally((()=>{clearTimeout(i)}))}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||(409===e.status||(429===e.status||e.status>=500)))}async retryRequest(e,t,n){let r;const s=n?.["retry-after-ms"];if(s){const e=parseFloat(s);Number.isNaN(e)||(r=e)}const a=n?.["retry-after"];if(a&&!r){const e=parseFloat(a);r=Number.isNaN(e)?Date.parse(a)-Date.now():1e3*e}if(!(r&&0<=r&&r<6e4)){const n=e.maxRetries??this.maxRetries;r=this.calculateDefaultRetryTimeoutMillis(t,n)}return await _y(r),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const n=t-e;return Math.min(.5*Math.pow(2,n),8)*(1-.25*Math.random())*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Cg}`}}class dy extends cy{constructor(e,t,n){super(t,(async t=>new n(e,t.response,await ly(t),t.options)))}async*[Symbol.asyncIterator](){const e=await(this);for await(const t of e)yield t}}const hy=e=>new Proxy(Object.fromEntries(e.entries()),{get(e,t){const n=t.toString();return e[n.toLowerCase()]||e[n]}}),py=()=>{if("undefined"!=typeof Deno&&null!=Deno.build)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cg,"X-Stainless-OS":my(Deno.build.os),"X-Stainless-Arch":fy(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cg,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if("[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0))return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cg,"X-Stainless-OS":my(process.platform),"X-Stainless-Arch":fy(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const e=function(){if("undefined"==typeof navigator||!navigator)return null;const e=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:t,pattern:n}of e){const e=n.exec(navigator.userAgent);if(e){return{browser:t,version:`${e[1]||0}.${e[2]||0}.${e[3]||0}`}}}return null}();return e?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cg,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${e.browser}`,"X-Stainless-Runtime-Version":e.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cg,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};const fy=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",my=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";let gy;const yy=()=>gy??(gy=py()),by=e=>{try{return JSON.parse(e)}catch(e){return}},wy=new RegExp("^(?:[a-z]+:)?//","i"),vy=e=>wy.test(e),_y=e=>new Promise((t=>setTimeout(t,e))),ky=(e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new Fg(`${e} must be an integer`);if(t<0)throw new Fg(`${e} must be a positive integer`);return t},Ey=e=>e instanceof Error?e:new Error(e),Oy=e=>"undefined"!=typeof process?process.env?.[e]?.trim()??void 0:"undefined"!=typeof Deno?Deno.env?.get?.(e)?.trim():void 0;function Sy(e){if(!e)return!0;for(const t in e)return!1;return!0}function Ty(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function xy(e,t){for(const n in t){if(!Ty(t,n))continue;const r=n.toLowerCase();if(!r)continue;const s=t[n];null===s?delete e[r]:void 0!==s&&(e[r]=s)}}function Ay(e,...t){"undefined"!=typeof process&&"true"===process?.env?.DEBUG&&console.log(`Anthropic:DEBUG:${e}`,...t)}const Iy=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}));class Py{constructor(e){this._client=e}}class Cy extends Py{create(e,t){return this._client.post("/v1/complete",{body:e,timeout:6e5,...t,stream:e.stream??!1})}}Cy||(Cy={});const Ry=e=>{if(0===e.length)return e;let t=e[e.length-1];switch(t.type){case"separator":return e=e.slice(0,e.length-1),Ry(e);case"number":let n=t.value[t.value.length-1];if("."===n||"-"===n)return e=e.slice(0,e.length-1),Ry(e);case"string":let r=e[e.length-2];if("delimiter"===r?.type)return e=e.slice(0,e.length-1),Ry(e);if("brace"===r?.type&&"{"===r.value)return e=e.slice(0,e.length-1),Ry(e);break;case"delimiter":return e=e.slice(0,e.length-1),Ry(e)}return e},Ny=e=>JSON.parse((e=>{let t="";return e.map((e=>{"string"===e.type?t+='"'+e.value+'"':t+=e.value})),t})((e=>{let t=[];return e.map((e=>{"brace"===e.type&&("{"===e.value?t.push("}"):t.splice(t.lastIndexOf("}"),1)),"paren"===e.type&&("["===e.value?t.push("]"):t.splice(t.lastIndexOf("]"),1))})),t.length>0&&t.reverse().map((t=>{"}"===t?e.push({type:"brace",value:"}"}):"]"===t&&e.push({type:"paren",value:"]"})})),e})(Ry((e=>{let t=0,n=[];for(;t<e.length;){let r=e[t];if("\\"===r){t++;continue}if("{"===r){n.push({type:"brace",value:"{"}),t++;continue}if("}"===r){n.push({type:"brace",value:"}"}),t++;continue}if("["===r){n.push({type:"paren",value:"["}),t++;continue}if("]"===r){n.push({type:"paren",value:"]"}),t++;continue}if(":"===r){n.push({type:"separator",value:":"}),t++;continue}if(","===r){n.push({type:"delimiter",value:","}),t++;continue}if('"'===r){let s="",a=!1;for(r=e[++t];'"'!==r;){if(t===e.length){a=!0;break}if("\\"===r){if(t++,t===e.length){a=!0;break}s+=r+e[t],r=e[++t]}else s+=r,r=e[++t]}r=e[++t],a||n.push({type:"string",value:s});continue}if(r&&/\s/.test(r)){t++;continue}let s=/[0-9]/;if(r&&s.test(r)||"-"===r||"."===r){let a="";for("-"===r&&(a+=r,r=e[++t]);r&&s.test(r)||"."===r;)a+=r,r=e[++t];n.push({type:"number",value:a});continue}let a=/[a-z]/i;if(r&&a.test(r)){let s="";for(;r&&a.test(r)&&t!==e.length;)s+=r,r=e[++t];if("true"!=s&&"false"!=s)throw new Error(`Invalid token: ${s} is not a valid token!`);n.push({type:"name",value:s})}else t++}return n})(e)))));var $y,jy,Ly,My,Dy,Uy,Fy,By,qy,zy,Hy,Wy,Ky,Vy,Gy,Zy,Jy,Xy,Yy,Qy,eb=function(e,t,n,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,n):s?s.value=n:t.set(e,n),n},tb=function(e,t,n,r){if("a"===n&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===n?r:"a"===n?r.call(e):r?r.value:t.get(e)};const nb="__json_buf";class rb{constructor(){$y.add(this),this.messages=[],this.receivedMessages=[],jy.set(this,void 0),this.controller=new AbortController,Ly.set(this,void 0),My.set(this,(()=>{})),Dy.set(this,(()=>{})),Uy.set(this,void 0),Fy.set(this,(()=>{})),By.set(this,(()=>{})),qy.set(this,{}),zy.set(this,!1),Hy.set(this,!1),Wy.set(this,!1),Ky.set(this,!1),Zy.set(this,(e=>{if(eb(this,Hy,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new qg),e instanceof qg)return eb(this,Wy,!0,"f"),this._emit("abort",e);if(e instanceof Fg)return this._emit("error",e);if(e instanceof Error){const t=new Fg(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new Fg(String(e)))})),eb(this,Ly,new Promise(((e,t)=>{eb(this,My,e,"f"),eb(this,Dy,t,"f")})),"f"),eb(this,Uy,new Promise(((e,t)=>{eb(this,Fy,e,"f"),eb(this,By,t,"f")})),"f"),tb(this,Ly,"f").catch((()=>{})),tb(this,Uy,"f").catch((()=>{}))}static fromReadableStream(e){const t=new rb;return t._run((()=>t._fromReadableStream(e))),t}static createMessage(e,t,n){const r=new rb;for(const e of t.messages)r._addMessageParam(e);return r._run((()=>r._createMessage(e,{...t,stream:!0},{...n,headers:{...n?.headers,"X-Stainless-Helper-Method":"stream"}}))),r}_run(e){e().then((()=>{this._emitFinal(),this._emit("end")}),tb(this,Zy,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,n){const r=n?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",(()=>this.controller.abort()))),tb(this,$y,"m",Jy).call(this);const s=await e.create({...t,stream:!0},{...n,signal:this.controller.signal});this._connected();for await(const e of s)tb(this,$y,"m",Xy).call(this,e);if(s.controller.signal?.aborted)throw new qg;tb(this,$y,"m",Yy).call(this)}_connected(){this.ended||(tb(this,My,"f").call(this),this._emit("connect"))}get ended(){return tb(this,zy,"f")}get errored(){return tb(this,Hy,"f")}get aborted(){return tb(this,Wy,"f")}abort(){this.controller.abort()}on(e,t){return(tb(this,qy,"f")[e]||(tb(this,qy,"f")[e]=[])).push({listener:t}),this}off(e,t){const n=tb(this,qy,"f")[e];if(!n)return this;const r=n.findIndex((e=>e.listener===t));return r>=0&&n.splice(r,1),this}once(e,t){return(tb(this,qy,"f")[e]||(tb(this,qy,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise(((t,n)=>{eb(this,Ky,!0,"f"),"error"!==e&&this.once("error",n),this.once(e,t)}))}async done(){eb(this,Ky,!0,"f"),await tb(this,Uy,"f")}get currentMessage(){return tb(this,jy,"f")}async finalMessage(){return await this.done(),tb(this,$y,"m",Vy).call(this)}async finalText(){return await this.done(),tb(this,$y,"m",Gy).call(this)}_emit(e,...t){if(tb(this,zy,"f"))return;"end"===e&&(eb(this,zy,!0,"f"),tb(this,Fy,"f").call(this));const n=tb(this,qy,"f")[e];if(n&&(tb(this,qy,"f")[e]=n.filter((e=>!e.once)),n.forEach((({listener:e})=>e(...t)))),"abort"===e){const e=t[0];return tb(this,Ky,"f")||n?.length||Promise.reject(e),tb(this,Dy,"f").call(this,e),tb(this,By,"f").call(this,e),void this._emit("end")}if("error"===e){const e=t[0];tb(this,Ky,"f")||n?.length||Promise.reject(e),tb(this,Dy,"f").call(this,e),tb(this,By,"f").call(this,e),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",tb(this,$y,"m",Vy).call(this))}async _fromReadableStream(e,t){const n=t?.signal;n&&(n.aborted&&this.controller.abort(),n.addEventListener("abort",(()=>this.controller.abort()))),tb(this,$y,"m",Jy).call(this),this._connected();const r=Qg.fromReadableStream(e,this.controller);for await(const e of r)tb(this,$y,"m",Xy).call(this,e);if(r.controller.signal?.aborted)throw new qg;tb(this,$y,"m",Yy).call(this)}[(jy=new WeakMap,Ly=new WeakMap,My=new WeakMap,Dy=new WeakMap,Uy=new WeakMap,Fy=new WeakMap,By=new WeakMap,qy=new WeakMap,zy=new WeakMap,Hy=new WeakMap,Wy=new WeakMap,Ky=new WeakMap,Zy=new WeakMap,$y=new WeakSet,Vy=function(){if(0===this.receivedMessages.length)throw new Fg("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},Gy=function(){if(0===this.receivedMessages.length)throw new Fg("stream ended without producing a Message with role=assistant");const e=this.receivedMessages.at(-1).content.filter((e=>"text"===e.type)).map((e=>e.text));if(0===e.length)throw new Fg("stream ended without producing a content block with type=text");return e.join(" ")},Jy=function(){this.ended||eb(this,jy,void 0,"f")},Xy=function(e){if(this.ended)return;const t=tb(this,$y,"m",Qy).call(this,e);switch(this._emit("streamEvent",e,t),e.type){case"content_block_delta":{const n=t.content.at(-1);"text_delta"===e.delta.type&&"text"===n.type?this._emit("text",e.delta.text,n.text||""):"input_json_delta"===e.delta.type&&"tool_use"===n.type&&n.input&&this._emit("inputJson",e.delta.partial_json,n.input);break}case"message_stop":this._addMessageParam(t),this._addMessage(t,!0);break;case"content_block_stop":this._emit("contentBlock",t.content.at(-1));break;case"message_start":eb(this,jy,t,"f")}},Yy=function(){if(this.ended)throw new Fg("stream has ended, this shouldn't happen");const e=tb(this,jy,"f");if(!e)throw new Fg("request ended without sending any chunks");return eb(this,jy,void 0,"f"),e},Qy=function(e){let t=tb(this,jy,"f");if("message_start"===e.type){if(t)throw new Fg(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!t)throw new Fg(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":case"content_block_stop":return t;case"message_delta":return t.stop_reason=e.delta.stop_reason,t.stop_sequence=e.delta.stop_sequence,t.usage.output_tokens=e.usage.output_tokens,t;case"content_block_start":return t.content.push(e.content_block),t;case"content_block_delta":{const n=t.content.at(e.index);if("text"===n?.type&&"text_delta"===e.delta.type)n.text+=e.delta.text;else if("tool_use"===n?.type&&"input_json_delta"===e.delta.type){let t=n[nb]||"";t+=e.delta.partial_json,Object.defineProperty(n,nb,{value:t,enumerable:!1,writable:!0}),t&&(n.input=Ny(t))}return t}}},Symbol.asyncIterator)](){const e=[],t=[];let n=!1;return this.on("streamEvent",(n=>{const r=t.shift();r?r.resolve(n):e.push(n)})),this.on("end",(()=>{n=!0;for(const e of t)e.resolve(void 0);t.length=0})),this.on("abort",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),this.on("error",(e=>{n=!0;for(const n of t)n.reject(e);t.length=0})),{next:async()=>{if(!e.length)return n?{value:void 0,done:!0}:new Promise(((e,n)=>t.push({resolve:e,reject:n}))).then((e=>e?{value:e,done:!1}:{value:void 0,done:!0}));return{value:e.shift(),done:!1}},return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new Qg(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}class sb extends Py{create(e,t){return this._client.post("/v1/messages",{body:e,timeout:6e5,...t,stream:e.stream??!1})}stream(e,t){return rb.createMessage(this,e,t)}}var ab;sb||(sb={});class ib extends uy{constructor({baseURL:e=Oy("ANTHROPIC_BASE_URL"),apiKey:t=Oy("ANTHROPIC_API_KEY")??null,authToken:n=Oy("ANTHROPIC_AUTH_TOKEN")??null,...r}={}){const s={apiKey:t,authToken:n,...r,baseURL:e||"https://api.anthropic.com"};super({baseURL:s.baseURL,timeout:s.timeout??6e5,httpAgent:s.httpAgent,maxRetries:s.maxRetries,fetch:s.fetch}),this.completions=new Cy(this),this.messages=new sb(this),this._options=s,this.apiKey=t,this.authToken=n}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"anthropic-version":"2023-06-01",...this._options.defaultHeaders}}validateHeaders(e,t){if(!(this.apiKey&&e["x-api-key"]||null===t["x-api-key"]||this.authToken&&e.authorization||null===t.authorization))throw new Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}authHeaders(e){const t=this.apiKeyAuth(e),n=this.bearerAuth(e);return null==t||Sy(t)?null==n||Sy(n)?{}:n:t}apiKeyAuth(e){return null==this.apiKey?{}:{"X-Api-Key":this.apiKey}}bearerAuth(e){return null==this.authToken?{}:{Authorization:`Bearer ${this.authToken}`}}}ab=ib,ib.Anthropic=ab,ib.HUMAN_PROMPT="\n\nHuman:",ib.AI_PROMPT="\n\nAssistant:",ib.AnthropicError=Fg,ib.APIError=Bg,ib.APIConnectionError=zg,ib.APIConnectionTimeoutError=Hg,ib.APIUserAbortError=qg,ib.NotFoundError=Gg,ib.ConflictError=Zg,ib.RateLimitError=Xg,ib.BadRequestError=Wg,ib.AuthenticationError=Kg,ib.InternalServerError=Yg,ib.PermissionDeniedError=Vg,ib.UnprocessableEntityError=Jg,ib.toFile=async function(e,t,n){if(e=await e,n??(n=(e=>null!=e&&"object"==typeof e&&"string"==typeof e.name&&"number"==typeof e.lastModified&&sy(e))(e)?{lastModified:e.lastModified,type:e.type}:{}),(e=>null!=e&&"object"==typeof e&&"string"==typeof e.url&&"function"==typeof e.blob)(e)){const r=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new $g([r],t,n)}const r=await async function(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(sy(e))t.push(await e.arrayBuffer());else{if(!iy(e))throw new Error(`Unexpected data type: ${typeof e}; constructor: ${e?.constructor?.name}; props: ${function(e){const t=Object.getOwnPropertyNames(e);return`[${t.map((e=>`"${e}"`)).join(", ")}]`}(e)}`);for await(const n of e)t.push(n)}return t}(e);if(t||(t=function(e){return ay(e.name)||ay(e.filename)||ay(e.path)?.split(/[\\/]/).pop()}(e)??"unknown_file"),!n.type){const e=r[0]?.type;"string"==typeof e&&(n={...n,type:e})}return new $g(r,t,n)},ib.fileFromPath=Mg,function(e){e.Completions=Cy,e.Messages=sb}(ib||(ib={}));class ob extends cg{static lc_name(){return"AnthropicToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","anthropic","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new dg(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap((e=>{const{message:t}=e;if(!Array.isArray(t.content))return[];return lb(t.content)[0]}));if(void 0===t[0])throw new Error("No parseable tool calls provided to AnthropicToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}function lb(e){const t=[];for(const n of e)"tool_use"===n.type&&t.push({name:n.name,args:n.input,id:n.id});return t}function cb(e){const t=e.match(/^data:(image\/.+);base64,(.+)$/);if(null===t)throw new Error(["Anthropic only supports base64-encoded images currently.","Example: data:image/png;base64,/9j/4AAQSk..."].join("\n\n"));return{type:"base64",media_type:t[1]??"",data:t[2]??""}}function ub(e){return"input_schema"in e}function db(e){if(void 0===e.id)throw new Error('Anthropic requires all tool calls to have an "id".');return{type:"tool_use",id:e.id,name:e.name,input:e.args}}function hb(e){if("string"==typeof e)return e;return e.map((e=>{if("image_url"===e.type){let t;return t="string"==typeof e.image_url?cb(e.image_url):cb(e.image_url.url),{type:"image",source:t}}if("text"===e.type)return{type:"text",text:e.text};if("tool_use"===e.type||"tool_result"===e.type)return{...e};throw new Error("Unsupported message content format")}))}function pb(e){const t=function(e){const t=[];for(const n of e)if("tool"===n._getType())"string"==typeof n.content?t.push(new xc({content:[{type:"tool_result",content:n.content,tool_use_id:n.tool_call_id}]})):t.push(new xc({content:n.content}));else{const e=t[t.length-1];if("human"===e?._getType()&&"human"===n._getType()){let t;t="string"==typeof e.content?[{type:"text",text:e.content}]:e.content,"string"==typeof n.content?t.push({type:"text",text:n.content}):t=t.concat(n.content),e.content=t}else t.push(n)}return t}(e);let n;if(t.length>0&&"system"===t[0]._getType()){if("string"!=typeof e[0].content)throw new Error("System message content must be a string.");n=e[0].content}return{messages:(void 0!==n?t.slice(1):t).map((e=>{let t;if("human"===e._getType())t="user";else if("ai"===e._getType())t="assistant";else{if("tool"!==e._getType())throw"system"===e._getType()?new Error("System messages are only permitted as the first passed message."):new Error(`Message type "${e._getType()}" is not supported.`);t="user"}if(kc(e)&&e.tool_calls?.length){if("string"==typeof e.content)return""===e.content?{role:t,content:e.tool_calls.map(db)}:{role:t,content:[{type:"text",text:e.content},...e.tool_calls.map(db)]};{const{content:n}=e;return!e.tool_calls.every((e=>n.find((t=>"tool_use"===t.type&&t.id===e.id))))&&console.warn('The "tool_calls" field on a message is only respected if content is a string.'),{role:t,content:hb(e.content)}}}return{role:t,content:hb(e.content)}})),system:n}}class fb extends sg{static lc_name(){return"ChatAnthropic"}get lc_secrets(){return{anthropicApiKey:"ANTHROPIC_API_KEY",apiKey:"ANTHROPIC_API_KEY"}}get lc_aliases(){return{modelName:"model"}}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"anthropicApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:-1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:2048}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"claude-2.1"}),Object.defineProperty(this,"invocationKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"clientOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamingClient",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.anthropicApiKey=e?.apiKey??e?.anthropicApiKey??Mp("ANTHROPIC_API_KEY"),!this.anthropicApiKey)throw new Error("Anthropic API key not found");this.apiKey=this.anthropicApiKey,this.apiUrl=e?.anthropicApiUrl,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.invocationKwargs=e?.invocationKwargs??{},this.temperature=e?.temperature??this.temperature,this.topK=e?.topK??this.topK,this.topP=e?.topP??this.topP,this.maxTokens=e?.maxTokensToSample??e?.maxTokens??this.maxTokens,this.stopSequences=e?.stopSequences??this.stopSequences,this.streaming=e?.streaming??!1,this.clientOptions=e?.clientOptions??{},this.streamUsage=e?.streamUsage??this.streamUsage}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"anthropic",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}formatStructuredToolToAnthropic(e){if(e&&e.length){if(e.every((e=>ub(e))))return e;if(e.every((e=>Qm(e))))return e.map((e=>({name:e.function.name,description:e.function.description,input_schema:e.function.parameters})));if(e.some((e=>ub(e))))throw new Error("Can not pass in a mix of tool schemas to ChatAnthropic");return e.map((e=>({name:e.name,description:e.description,input_schema:Ps(e.schema)})))}}bindTools(e,t){return this.bind({tools:this.formatStructuredToolToAnthropic(e),...t})}invocationParams(e){let t;return e?.tool_choice&&(t="any"===e?.tool_choice?{type:"any"}:"auto"===e?.tool_choice?{type:"auto"}:e?.tool_choice),{model:this.model,temperature:this.temperature,top_k:this.topK,top_p:this.topP,stop_sequences:e?.stop??this.stopSequences,stream:this.streaming,max_tokens:this.maxTokens,tools:this.formatStructuredToolToAnthropic(e?.tools),tool_choice:t,...this.invocationKwargs}}_identifyingParams(){return{model_name:this.model,...this.invocationParams()}}identifyingParams(){return{model_name:this.model,...this.invocationParams()}}async*_streamResponseChunks(e,t,n){const r=this.invocationParams(t),s=pb(e);if(void 0!==t.tools&&t.tools.length>0){const{generations:n}=await this._generateNonStreaming(e,r,{signal:t.signal}),s=n[0].message,a=s.tool_calls?.map(((e,t)=>({name:e.name,args:JSON.stringify(e.args),id:e.id,index:t})));yield new nf({message:new Ec({content:s.content,additional_kwargs:s.additional_kwargs,tool_call_chunks:a}),text:n[0].text})}else{const e=await this.createStreamWithRetry({...r,...s,stream:!0});let a,i={input_tokens:0,output_tokens:0};for await(const r of e){if(t.signal?.aborted)throw e.controller.abort(),new Error("AbortError: User aborted the request.");if("message_start"===r.type){const{content:e,usage:n,...s}=r.message,a={};for(const[e,t]of Object.entries(s))null!=t&&(a[e]=t);let o;i=n,(this.streamUsage||t.streamUsage)&&(o={input_tokens:n.input_tokens,output_tokens:n.output_tokens,total_tokens:n.input_tokens+n.output_tokens}),yield new nf({message:new Ec({content:"",additional_kwargs:a,usage_metadata:o}),text:""})}else if("message_delta"===r.type){let e;(this.streamUsage||t.streamUsage)&&(e={input_tokens:r.usage.output_tokens,output_tokens:0,total_tokens:r.usage.output_tokens}),yield new nf({message:new Ec({content:"",additional_kwargs:{...r.delta},usage_metadata:e}),text:""}),void 0!==r?.usage&&(i.output_tokens+=r.usage.output_tokens)}else if("content_block_delta"===r.type&&"text_delta"===r.delta.type){const e=r.delta?.text;void 0!==e&&(yield new nf({message:new Ec({content:e,additional_kwargs:{}}),text:e}),await(n?.handleLLMNewToken(e)))}}(this.streamUsage||t.streamUsage)&&(a={input_tokens:i.input_tokens,output_tokens:i.output_tokens,total_tokens:i.input_tokens+i.output_tokens}),yield new nf({message:new Ec({content:"",additional_kwargs:{usage:i},usage_metadata:a}),text:""})}}async _generateNonStreaming(e,t,n){const r=void 0!==t.tools?{...n,headers:{...n.headers,"anthropic-beta":"tools-2024-04-04"}}:n,s=await this.completionWithRetry({...t,stream:!1,...pb(e)},r),{content:a,...i}=s,o=function(e,t){const n=t.usage,r=null!=n?{input_tokens:n.input_tokens??0,output_tokens:n.output_tokens??0,total_tokens:(n.input_tokens??0)+(n.output_tokens??0)}:void 0;if(1===e.length&&"text"===e[0].type)return[{text:e[0].text,message:new _c({content:e[0].text,additional_kwargs:t,usage_metadata:r})}];{const n=lb(e);return[{text:"",message:new _c({content:e,additional_kwargs:t,tool_calls:n,usage_metadata:r})}]}}(a,i),{role:l,type:c,...u}=i;return{generations:o,llmOutput:u}}async _generate(e,t,n){if(this.stopSequences&&t.stop)throw new Error('"stopSequence" parameter found in input and default params');const r=this.invocationParams(t);if(r.stream){let r;const s=this._streamResponseChunks(e,t,n);for await(const e of s)r=void 0===r?e:r.concat(e);if(void 0===r)throw new Error("No chunks returned from Anthropic API.");return{generations:[{text:r.text,message:r.message}]}}return this._generateNonStreaming(e,r,{signal:t.signal})}async createStreamWithRetry(e,t){if(!this.streamingClient){const e=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.streamingClient=new ib({...this.clientOptions,...e,apiKey:this.apiKey,maxRetries:0})}return this.caller.call((async()=>this.streamingClient.messages.create({...e,...this.invocationKwargs,stream:!0},t)))}async completionWithRetry(e,t){if(!this.apiKey)throw new Error("Missing Anthropic API key.");if(!this.batchClient){const e=this.apiUrl?{baseURL:this.apiUrl}:void 0;this.batchClient=new ib({...this.clientOptions,...e,apiKey:this.apiKey,maxRetries:0})}return this.caller.callWithOptions({signal:t.signal??void 0},(async()=>this.batchClient.messages.create({...e,...this.invocationKwargs},t)))}_llmType(){return"anthropic"}withStructuredOutput(e,t){const n=e,r=t?.name,s=t?.method,a=t?.includeRaw;if("jsonMode"===s)throw new Error('Anthropic only supports "functionCalling" as a method.');let i,o,l=r??"extract";if(rg(n)){const e=Ps(n);o=[{name:l,description:e.description??"A function available to call.",input_schema:e}],i=new ob({returnSingle:!0,keyName:l,zodSchema:n})}else{let e;"string"==typeof n.name&&"string"==typeof n.description&&"object"==typeof n.input_schema&&null!=n.input_schema?(e=n,l=n.name):e={name:l,description:n.description??"",input_schema:n},o=[e],i=new ob({returnSingle:!0,keyName:l})}const c=this.bind({tools:o,tool_choice:{type:"tool",name:l}});if(!a)return c.pipe(i).withConfig({runName:"ChatAnthropicStructuredOutput"});const u=ng.assign({parsed:(e,t)=>i.invoke(e.raw,t)}),d=ng.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[d]});return fm.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}}class mb extends fb{}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */const gb=["user","model","function","system"];var yb,bb,wb,vb,_b,kb,Eb,Ob;!function(e){e.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",e.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",e.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",e.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",e.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"}(yb||(yb={})),function(e){e.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",e.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",e.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",e.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",e.BLOCK_NONE="BLOCK_NONE"}(bb||(bb={})),function(e){e.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",e.NEGLIGIBLE="NEGLIGIBLE",e.LOW="LOW",e.MEDIUM="MEDIUM",e.HIGH="HIGH"}(wb||(wb={})),function(e){e.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",e.SAFETY="SAFETY",e.OTHER="OTHER"}(vb||(vb={})),function(e){e.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",e.STOP="STOP",e.MAX_TOKENS="MAX_TOKENS",e.SAFETY="SAFETY",e.RECITATION="RECITATION",e.OTHER="OTHER"}(_b||(_b={})),function(e){e.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",e.RETRIEVAL_QUERY="RETRIEVAL_QUERY",e.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",e.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",e.CLASSIFICATION="CLASSIFICATION",e.CLUSTERING="CLUSTERING"}(kb||(kb={})),function(e){e.MODE_UNSPECIFIED="MODE_UNSPECIFIED",e.AUTO="AUTO",e.ANY="ANY",e.NONE="NONE"}(Eb||(Eb={})),function(e){e.STRING="STRING",e.NUMBER="NUMBER",e.INTEGER="INTEGER",e.BOOLEAN="BOOLEAN",e.ARRAY="ARRAY",e.OBJECT="OBJECT"}(Ob||(Ob={}));
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */
class Sb extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}}class Tb extends Sb{constructor(e,t){super(e),this.response=t}}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */var xb;!function(e){e.GENERATE_CONTENT="generateContent",e.STREAM_GENERATE_CONTENT="streamGenerateContent",e.COUNT_TOKENS="countTokens",e.EMBED_CONTENT="embedContent",e.BATCH_EMBED_CONTENTS="batchEmbedContents"}(xb||(xb={}));class Ab{constructor(e,t,n,r,s){this.model=e,this.task=t,this.apiKey=n,this.stream=r,this.requestOptions=s}toString(){var e,t;const n=(null===(e=this.requestOptions)||void 0===e?void 0:e.apiVersion)||"v1beta";let r=`${(null===(t=this.requestOptions)||void 0===t?void 0:t.baseUrl)||"https://generativelanguage.googleapis.com"}/${n}/${this.model}:${this.task}`;return this.stream&&(r+="?alt=sse"),r}}async function Ib(e){const t=new Headers;return t.append("Content-Type","application/json"),t.append("x-goog-api-client",function(e){const t=[];return(null==e?void 0:e.apiClient)&&t.push(e.apiClient),t.push("genai-js/0.7.1"),t.join(" ")}(e.requestOptions)),t.append("x-goog-api-key",e.apiKey),t}async function Pb(e,t,n,r,s,a){return async function(e,t,n,r,s,a,i=fetch){const o=new Ab(e,t,n,r,a);let l;try{const o=await async function(e,t,n,r,s,a){const i=new Ab(e,t,n,r,a);return{url:i.toString(),fetchOptions:Object.assign(Object.assign({},Cb(a)),{method:"POST",headers:await Ib(i),body:s})}}(e,t,n,r,s,a);if(l=await i(o.url,o.fetchOptions),!l.ok){let e="";try{const t=await l.json();e=t.error.message,t.error.details&&(e+=` ${JSON.stringify(t.error.details)}`)}catch(e){}throw new Error(`[${l.status} ${l.statusText}] ${e}`)}}catch(e){const t=new Sb(`Error fetching from ${o.toString()}: ${e.message}`);throw t.stack=e.stack,t}return l}(e,t,n,r,s,a,fetch)}function Cb(e){const t={};if((null==e?void 0:e.timeout)>=0){const n=new AbortController,r=n.signal;setTimeout((()=>n.abort()),e.timeout),t.signal=r}return t}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */function Rb(e){return e.text=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),jb(e.candidates[0]))throw new Tb(`${Lb(e)}`,e);return function(e){var t,n,r,s;return(null===(s=null===(r=null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)||void 0===r?void 0:r[0])||void 0===s?void 0:s.text)?e.candidates[0].content.parts.map((({text:e})=>e)).join(""):""}(e)}if(e.promptFeedback)throw new Tb(`Text not available. ${Lb(e)}`,e);return""},e.functionCall=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),jb(e.candidates[0]))throw new Tb(`${Lb(e)}`,e);return console.warn("response.functionCall() is deprecated. Use response.functionCalls() instead."),Nb(e)[0]}if(e.promptFeedback)throw new Tb(`Function call not available. ${Lb(e)}`,e)},e.functionCalls=()=>{if(e.candidates&&e.candidates.length>0){if(e.candidates.length>1&&console.warn(`This response had ${e.candidates.length} candidates. Returning function calls from the first candidate only. Access response.candidates directly to use the other candidates.`),jb(e.candidates[0]))throw new Tb(`${Lb(e)}`,e);return Nb(e)}if(e.promptFeedback)throw new Tb(`Function call not available. ${Lb(e)}`,e)},e}function Nb(e){var t,n,r,s;const a=[];if(null===(n=null===(t=e.candidates)||void 0===t?void 0:t[0].content)||void 0===n?void 0:n.parts)for(const t of null===(s=null===(r=e.candidates)||void 0===r?void 0:r[0].content)||void 0===s?void 0:s.parts)t.functionCall&&a.push(t.functionCall);return a.length>0?a:void 0}const $b=[_b.RECITATION,_b.SAFETY];function jb(e){return!!e.finishReason&&$b.includes(e.finishReason)}function Lb(e){var t,n,r;let s="";if(e.candidates&&0!==e.candidates.length||!e.promptFeedback){if(null===(r=e.candidates)||void 0===r?void 0:r[0]){const t=e.candidates[0];jb(t)&&(s+=`Candidate was blocked due to ${t.finishReason}`,t.finishMessage&&(s+=`: ${t.finishMessage}`))}}else s+="Response was blocked",(null===(t=e.promptFeedback)||void 0===t?void 0:t.blockReason)&&(s+=` due to ${e.promptFeedback.blockReason}`),(null===(n=e.promptFeedback)||void 0===n?void 0:n.blockReasonMessage)&&(s+=`: ${e.promptFeedback.blockReasonMessage}`);return s}function Mb(e){return this instanceof Mb?(this.v=e,this):new Mb(e)}function Db(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),a=[];return r={},i("next"),i("throw"),i("return"),r[Symbol.asyncIterator]=function(){return this},r;function i(e){s[e]&&(r[e]=function(t){return new Promise((function(n,r){a.push([e,t,n,r])>1||o(e,t)}))})}function o(e,t){try{!function(e){e.value instanceof Mb?Promise.resolve(e.value.v).then(l,c):u(a[0][2],e)}(s[e](t))}catch(e){u(a[0][3],e)}}function l(e){o("next",e)}function c(e){o("throw",e)}function u(e,t){e(t),a.shift(),a.length&&o(a[0][0],a[0][1])}}"function"==typeof SuppressedError&&SuppressedError;
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */
const Ub=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function Fb(e){const t=function(e){const t=e.getReader(),n=new ReadableStream({start(e){let n="";return r();function r(){return t.read().then((({value:t,done:s})=>{if(s)return n.trim()?void e.error(new Sb("Failed to parse stream")):void e.close();n+=t;let a,i=n.match(Ub);for(;i;){try{a=JSON.parse(i[1])}catch(t){return void e.error(new Sb(`Error parsing JSON response: "${i[1]}"`))}e.enqueue(a),n=n.substring(i[0].length),i=n.match(Ub)}return r()}))}}});return n}(e.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0}))),[n,r]=t.tee();return{stream:qb(n),response:Bb(r)}}async function Bb(e){const t=[],n=e.getReader();for(;;){const{done:e,value:r}=await n.read();if(e)return Rb(zb(t));t.push(r)}}function qb(e){return Db(this,arguments,(function*(){const t=e.getReader();for(;;){const{value:e,done:n}=yield Mb(t.read());if(n)break;yield yield Mb(Rb(e))}}))}function zb(e){const t=e[e.length-1],n={promptFeedback:null==t?void 0:t.promptFeedback};for(const t of e)if(t.candidates)for(const e of t.candidates){const t=e.index;if(n.candidates||(n.candidates=[]),n.candidates[t]||(n.candidates[t]={index:e.index}),n.candidates[t].citationMetadata=e.citationMetadata,n.candidates[t].finishReason=e.finishReason,n.candidates[t].finishMessage=e.finishMessage,n.candidates[t].safetyRatings=e.safetyRatings,e.content&&e.content.parts){n.candidates[t].content||(n.candidates[t].content={role:e.content.role||"user",parts:[]});const r={};for(const s of e.content.parts)s.text&&(r.text=s.text),s.functionCall&&(r.functionCall=s.functionCall),0===Object.keys(r).length&&(r.text=""),n.candidates[t].content.parts.push(r)}}return n}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */async function Hb(e,t,n,r){return Fb(await Pb(t,xb.STREAM_GENERATE_CONTENT,e,!0,JSON.stringify(n),r))}async function Wb(e,t,n,r){const s=await Pb(t,xb.GENERATE_CONTENT,e,!1,JSON.stringify(n),r);return{response:Rb(await s.json())}}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */function Kb(e){let t=[];if("string"==typeof e)t=[{text:e}];else for(const n of e)"string"==typeof n?t.push({text:n}):t.push(n);return function(e){const t={role:"user",parts:[]},n={role:"function",parts:[]};let r=!1,s=!1;for(const a of e)"functionResponse"in a?(n.parts.push(a),s=!0):(t.parts.push(a),r=!0);if(r&&s)throw new Sb("Within a single message, FunctionResponse cannot be mixed with other type of part in the request for sending chat message.");if(!r&&!s)throw new Sb("No content is provided for sending chat message.");if(r)return t;return n}(t)}function Vb(e){if(e.contents)return e;return{contents:[Kb(e)]}}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */
const Gb=["text","inlineData","functionCall","functionResponse"],Zb={user:["text","inlineData"],function:["functionResponse"],model:["text","functionCall"],system:["text"]},Jb={user:["model"],function:["model"],model:["user","function"],system:[]};
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */
const Xb="SILENT_ERROR";class Yb{constructor(e,t,n,r){this.model=t,this.params=n,this.requestOptions=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,(null==n?void 0:n.history)&&(!function(e){let t;for(const n of e){const{role:e,parts:r}=n;if(!t&&"user"!==e)throw new Sb(`First content should be with role 'user', got ${e}`);if(!gb.includes(e))throw new Sb(`Each item should include role field. Got ${e} but valid roles are: ${JSON.stringify(gb)}`);if(!Array.isArray(r))throw new Sb("Content should have 'parts' property with an array of Parts");if(0===r.length)throw new Sb("Each Content should have at least one part");const s={text:0,inlineData:0,functionCall:0,functionResponse:0};for(const e of r)for(const t of Gb)t in e&&(s[t]+=1);const a=Zb[e];for(const t of Gb)if(!a.includes(t)&&s[t]>0)throw new Sb(`Content with role '${e}' can't contain '${t}' part`);if(t&&!Jb[e].includes(t.role))throw new Sb(`Content with role '${e}' can't follow '${t.role}'. Valid previous roles: ${JSON.stringify(Jb)}`);t=n}}(n.history),this._history=n.history)}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,n,r,s,a;await this._sendPromise;const i=Kb(e),o={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(n=this.params)||void 0===n?void 0:n.generationConfig,tools:null===(r=this.params)||void 0===r?void 0:r.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(a=this.params)||void 0===a?void 0:a.systemInstruction,contents:[...this._history,i]};let l;return this._sendPromise=this._sendPromise.then((()=>Wb(this._apiKey,this.model,o,this.requestOptions))).then((e=>{var t;if(e.response.candidates&&e.response.candidates.length>0){this._history.push(i);const n=Object.assign({parts:[],role:"model"},null===(t=e.response.candidates)||void 0===t?void 0:t[0].content);this._history.push(n)}else{const t=Lb(e.response);t&&console.warn(`sendMessage() was unsuccessful. ${t}. Inspect response object for details.`)}l=e})),await this._sendPromise,l}async sendMessageStream(e){var t,n,r,s,a;await this._sendPromise;const i=Kb(e),o={safetySettings:null===(t=this.params)||void 0===t?void 0:t.safetySettings,generationConfig:null===(n=this.params)||void 0===n?void 0:n.generationConfig,tools:null===(r=this.params)||void 0===r?void 0:r.tools,toolConfig:null===(s=this.params)||void 0===s?void 0:s.toolConfig,systemInstruction:null===(a=this.params)||void 0===a?void 0:a.systemInstruction,contents:[...this._history,i]},l=Hb(this._apiKey,this.model,o,this.requestOptions);return this._sendPromise=this._sendPromise.then((()=>l)).catch((e=>{throw new Error(Xb)})).then((e=>e.response)).then((e=>{if(e.candidates&&e.candidates.length>0){this._history.push(i);const t=Object.assign({},e.candidates[0].content);t.role||(t.role="model"),this._history.push(t)}else{const t=Lb(e);t&&console.warn(`sendMessageStream() was unsuccessful. ${t}. Inspect response object for details.`)}})).catch((e=>{e.message!==Xb&&console.error(e)})),l}}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */
class Qb{constructor(e,t,n){this.apiKey=e,t.model.includes("/")?this.model=t.model:this.model=`models/${t.model}`,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[],this.tools=t.tools,this.toolConfig=t.toolConfig,this.systemInstruction=t.systemInstruction,this.requestOptions=n||{}}async generateContent(e){const t=Vb(e);return Wb(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}async generateContentStream(e){const t=Vb(e);return Hb(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},t),this.requestOptions)}startChat(e){return new Yb(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings,tools:this.tools,toolConfig:this.toolConfig,systemInstruction:this.systemInstruction},e),this.requestOptions)}async countTokens(e){const t=Vb(e);return async function(e,t,n,r){return(await Pb(t,xb.COUNT_TOKENS,e,!1,JSON.stringify(Object.assign(Object.assign({},n),{model:t})),r)).json()}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */(this.apiKey,this.model,t,this.requestOptions)}async embedContent(e){const t=function(e){if("string"==typeof e||Array.isArray(e))return{content:Kb(e)};return e}(e);return async function(e,t,n,r){return(await Pb(t,xb.EMBED_CONTENT,e,!1,JSON.stringify(n),r)).json()}(this.apiKey,this.model,t,this.requestOptions)}async batchEmbedContents(e){return async function(e,t,n,r){const s=n.requests.map((e=>Object.assign(Object.assign({},e),{model:t})));return(await Pb(t,xb.BATCH_EMBED_CONTENTS,e,!1,JSON.stringify({requests:s}),r)).json()}(this.apiKey,this.model,e,this.requestOptions)}}
/**
   * @license
   * Copyright 2024 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   */class ew{constructor(e){this.apiKey=e}getGenerativeModel(e,t){if(!e.model)throw new Sb("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Qb(this.apiKey,e,t)}}function tw(e){if("object"==typeof e&&null!==e){const t={...e};"additionalProperties"in t&&"boolean"==typeof t.additionalProperties&&delete t.additionalProperties;for(const e in t)e in t&&(Array.isArray(t[e])?t[e]=t[e].map(tw):"object"==typeof t[e]&&null!==t[e]&&(t[e]=tw(t[e])));return t}return e}function nw(e){const t=tw(Ps(e)),{$schema:n,...r}=t;return r}function rw(e){const t=tw(e),{$schema:n,...r}=t;return r}function sw(e,t){if("string"==typeof e.content&&""!==e.content)return[{text:e.content}];let n=[],r=[],s=[];return"tool_calls"in e&&Array.isArray(e.tool_calls)&&e.tool_calls.length>0?n=e.tool_calls.map((e=>({functionCall:{name:e.name,args:e.args}}))):"tool"===e._getType()&&e.name&&e.content?r=[{functionResponse:{name:e.name,response:e.content}}]:Array.isArray(e.content)&&(s=e.content.map((e=>{if("text"===e.type)return{text:e.text};if("image_url"===e.type){if(!t)throw new Error("This model does not support images");let n;if("string"==typeof e.image_url)n=e.image_url;else{if("object"!=typeof e.image_url||!("url"in e.image_url))throw new Error("Please provide image as base64 encoded data URL");n=e.image_url.url}const[r,s]=n.split(",");if(!r.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");const[a,i]=r.replace(/^data:/,"").split(";");if("base64"!==i)throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:s,mimeType:a}}}if("media"===e.type)return function(e){if("mimeType"in e&&"data"in e)return{inlineData:{mimeType:e.mimeType,data:e.data}};throw new Error("Invalid media content")}(e);if("tool_use"===e.type)return{functionCall:{name:e.name,args:e.input}};throw new Error(`Unknown content type ${e.type}`)}))),[...s,...n,...r]}function aw(e,t){return e.reduce(((e,n,r)=>{if(!wc(n))throw new Error("Unsupported message input");const s=function(e){const t=e._getType();return Oc.isInstance(e)?e.role:"tool"===t?t:e.name??t}(n);if("system"===s&&0!==r)throw new Error("System message should be the first one");const a=function(e){switch(e){case"ai":case"model":return"model";case"system":case"human":return"user";case"tool":case"function":return"function";default:throw new Error(`Unknown / unsupported author: ${e}`)}}(s),i=e.content[e.content.length];if(!e.mergeWithPreviousContent&&i&&i.role===a)throw new Error("Google Generative AI requires alternate messages between authors");const o=sw(n,t);if(e.mergeWithPreviousContent){const t=e.content[e.content.length-1];if(!t)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return t.parts.push(...o),{mergeWithPreviousContent:!1,content:e.content}}let l=a;"function"===l&&(l="user");const c={role:l,parts:o};return{mergeWithPreviousContent:"system"===s,content:[...e.content,c]}}),{content:[],mergeWithPreviousContent:!1}).content}function iw(e,t){if(!e.candidates||0===e.candidates.length)return null;const n=e.functionCalls(),[r]=e.candidates,{content:s,...a}=r,i=s?.parts[0]?.text??"",o=[];return n&&o.push(...n.map((e=>({...e,args:JSON.stringify(e.args),index:t.index})))),new nf({text:i,message:new Ec({content:i,name:s?s.role:void 0,tool_call_chunks:o,additional_kwargs:{},usage_metadata:t.usageMetadata}),generationInfo:a})}function ow(e){return e.every((e=>"functionDeclarations"in e&&Array.isArray(e.functionDeclarations)))?e:[{functionDeclarations:e.map((e=>{if(og(e)){const t=nw(e.schema);return{name:e.name,description:e.description,parameters:t}}return Qm(e)?{name:e.function.name,description:e.function.description??"A function available to call.",parameters:rw(e.function.parameters)}:e}))}]}class lw extends cg{static lc_name(){return"GoogleGenerativeAIToolsOutputParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","google_genai","output_parsers"]}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;const t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new dg(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){const t=e.flatMap((e=>{const{message:t}=e;return"tool_calls"in t&&Array.isArray(t.tool_calls)?t.tool_calls:[]}));if(void 0===t[0])throw new Error("No parseable tool calls provided to GoogleGenerativeAIToolsOutputParser.");const[n]=t;return await this._validateResult(n.args)}}class cw extends sg{static lc_name(){return"ChatGoogleGenerativeAI"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get _isMultimodalModel(){return this.model.includes("vision")||this.model.startsWith("gemini-1.5")}constructor(e){if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=e?.model?.replace(/^models\//,"")??e?.modelName?.replace(/^models\//,"")??this.model,this.model=this.modelName,this.maxOutputTokens=e?.maxOutputTokens??this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=e?.temperature??this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=e?.topP??this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=e?.topK??this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=e?.stopSequences??this.stopSequences,this.apiKey=e?.apiKey??Mp("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=e?.safetySettings??this.safetySettings,this.safetySettings&&this.safetySettings.length>0){const e=new Set(this.safetySettings.map((e=>e.category)));if(e.size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique")}this.streaming=e?.streaming??this.streaming,this.client=new ew(this.apiKey).getGenerativeModel({model:this.model,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK}},{apiVersion:e?.apiVersion,baseUrl:e?.baseUrl}),this.streamUsage=e?.streamUsage??this.streamUsage}getLsParams(e){return{ls_provider:"google_genai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:this.client.generationConfig.temperature,ls_max_tokens:this.client.generationConfig.maxOutputTokens,ls_stop:e.stop}}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}bindTools(e,t){return this.bind({tools:ow(e),...t})}invocationParams(e){const t=e?.tools;return Array.isArray(t)&&!t.some((e=>!("lc_namespace"in e)))?{tools:ow(e?.tools)}:{tools:e?.tools}}async _generate(e,t,n){const r=aw(e,this._isMultimodalModel),s=this.invocationParams(t);if(this.streaming){const r={},s=this._streamResponseChunks(e,t,n),a={};for await(const e of s){const t=e.generationInfo?.completion??0;void 0===a[t]?a[t]=e:a[t]=a[t].concat(e)}const i=Object.entries(a).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t));return{generations:i,llmOutput:{estimatedTokenUsage:r}}}const a=await this.completionWithRetry({...s,contents:r});let i;if("usageMetadata"in a.response){const e=a.response.usageMetadata;i={input_tokens:e.promptTokenCount??0,output_tokens:e.candidatesTokenCount??0,total_tokens:e.totalTokenCount??0}}const o=function(e,t){if(!e.candidates||0===e.candidates.length||!e.candidates[0])return{generations:[],llmOutput:{filters:e.promptFeedback}};const n=e.functionCalls(),[r]=e.candidates,{content:s,...a}=r,i=s?.parts[0]?.text??"";return{generations:[{text:i,message:new _c({content:i,tool_calls:n,additional_kwargs:{...a},usage_metadata:t?.usageMetadata}),generationInfo:a}]}}(a.response,{usageMetadata:i});return await(n?.handleLLMNewToken(o.generations[0].text??"")),o}async*_streamResponseChunks(e,t,n){const r=aw(e,this._isMultimodalModel),s={...this.invocationParams(t),contents:r},a=await this.caller.callWithOptions({signal:t?.signal},(async()=>{const{stream:e}=await this.client.generateContentStream(s);return e}));let i,o=0;for await(const e of a){if("usageMetadata"in e&&!1!==this.streamUsage&&!1!==t.streamUsage){const t=e.usageMetadata;if(i){const e=t.candidatesTokenCount-i.output_tokens;i={input_tokens:0,output_tokens:e,total_tokens:e}}else i={input_tokens:t.promptTokenCount,output_tokens:t.candidatesTokenCount,total_tokens:t.totalTokenCount}}const r=iw(e,{usageMetadata:i,index:o});o+=1,r&&(yield r,await(n?.handleLLMNewToken(r.text??"")))}}async completionWithRetry(e,t){return this.caller.callWithOptions({signal:t?.signal},(async()=>{try{return this.client.generateContent(e)}catch(e){throw e.message?.includes("400 Bad Request")&&(e.status=400),e}}))}withStructuredOutput(e,t){const n=e,r=t?.name,s=t?.method,a=t?.includeRaw;if("jsonMode"===s)throw new Error('ChatGoogleGenerativeAI only supports "functionCalling" as a method.');let i,o,l=r??"extract";if(rg(n)){const e=nw(n);o=[{functionDeclarations:[{name:l,description:e.description??"A function available to call.",parameters:e}]}],i=new lw({returnSingle:!0,keyName:l,zodSchema:n})}else{let e;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(e=n,l=n.name):e={name:l,description:n.description??"",parameters:n},o=[{functionDeclarations:[e]}],i=new lw({returnSingle:!0,keyName:l})}const c=this.bind({tools:o});if(!a)return c.pipe(i).withConfig({runName:"ChatGoogleGenerativeAIStructuredOutput"});const u=ng.assign({parsed:(e,t)=>i.invoke(e.raw,t)}),d=ng.assign({parsed:()=>null}),h=u.withFallbacks({fallbacks:[d]});return fm.from([{raw:c},h]).withConfig({runName:"StructuredOutputRunnable"})}}function uw(e){const t=e=>{switch(e){case"human":return"user";case"ai":case"function":return"assistant";case"system":return"system";case"tool":return"tool";default:throw new Error(`Unknown message type: ${e}`)}};return e.map((e=>{const n=(e=>{if(kc(e)&&e.tool_calls?.length)return e.tool_calls.map((e=>({...e,id:e.id}))).map(wg);if(!e.additional_kwargs.tool_calls?.length)return;const t=e.additional_kwargs.tool_calls;return t?.map((e=>({id:e.id,type:"function",function:e.function})))})(e),r=void 0===n?(e=>{if("string"==typeof e)return e;throw new Error(`ChatMistralAI does not support non text message content. Received: ${JSON.stringify(e,null,2)}`)})(e.content):"";return{role:t(e._getType()),content:r,tool_calls:n}}))}function dw(e,n){const{message:r}=e;let s=[];if("tool_calls"in r&&Array.isArray(r.tool_calls)&&(s=r.tool_calls),"assistant"===r.role){const e=[],a=[];for(const n of s)try{const r=bg(n,{returnId:!0});e.push({...r,id:r.id??t.v4().replace(/-/g,"")})}catch(e){a.push(vg(n,e.message))}return new _c({content:r.content??"",tool_calls:e,invalid_tool_calls:a,additional_kwargs:{tool_calls:s.length?s.map((e=>({...e,type:"function"}))):void 0},usage_metadata:n?{input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens}:void 0})}return new xc(r.content??"")}function hw(e,n){if(!e.content&&!e.tool_calls)return n?new Ec({content:"",usage_metadata:n?{input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens}:void 0}):null;const r=e.tool_calls?.length?e.tool_calls?.map(((e,n)=>({...e,index:n,id:e.id??t.v4().replace(/-/g,""),type:"function"}))):void 0;let s="assistant";e.role&&(s=e.role);const a=e.content??"";let i;const o=[];if(void 0!==r){i={tool_calls:r};for(const e of r)o.push({name:e.function?.name,args:e.function?.arguments,id:e.id,index:e.index})}else i={};return"user"===s?new Ac({content:a}):"assistant"===s?new Ec({content:a,tool_call_chunks:o,additional_kwargs:i,usage_metadata:n?{input_tokens:n.prompt_tokens,output_tokens:n.completion_tokens,total_tokens:n.total_tokens}:void 0}):"tool"===s?new vc({content:a,additional_kwargs:i,tool_call_id:r?.[0].id??""}):"function"===s?new Tc({content:a,additional_kwargs:i}):new Sc({content:a,role:s})}function pw(e){return e.map((e=>{const t=e.description??`Tool: ${e.name}`;return{type:"function",function:{name:e.name,description:t,parameters:Ps(e.schema)}}}))}class fw extends sg{static lc_name(){return"ChatMistralAI"}constructor(e){super(e??{}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"mistral-small-latest"}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"mistral-small-latest"}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"endpoint",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:.7}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"safeMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"safePrompt",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"randomSeed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"seed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0});const t=e?.apiKey??Mp("MISTRAL_API_KEY");if(!t)throw new Error("API key MISTRAL_API_KEY is missing for MistralAI, but it is required.");this.apiKey=t,this.streaming=e?.streaming??this.streaming,this.endpoint=e?.endpoint,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.maxTokens=e?.maxTokens??this.maxTokens,this.safeMode=e?.safeMode??this.safeMode,this.safePrompt=e?.safePrompt??this.safePrompt,this.randomSeed=e?.seed??e?.randomSeed??this.seed,this.seed=this.randomSeed,this.modelName=e?.model??e?.modelName??this.model,this.model=this.modelName,this.streamUsage=e?.streamUsage??this.streamUsage}getLsParams(e){const t=this.invocationParams(e);return{ls_provider:"mistral",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.maxTokens??void 0}}_llmType(){return"mistral_ai"}invocationParams(e){const{response_format:t,tools:n,tool_choice:r}=e??{},s=n?.map((e=>"lc_namespace"in e?pw([e]):e.function.description?e:{type:"function",function:{name:e.function.name,description:`Tool: ${e.function.name}`,parameters:e.function.parameters}})).flat();return{model:this.model,tools:s,temperature:this.temperature,maxTokens:this.maxTokens,topP:this.topP,randomSeed:this.seed,safeMode:this.safeMode,safePrompt:this.safePrompt,toolChoice:r,responseFormat:t}}bindTools(e,t){const n=e?.map((e=>"lc_namespace"in e?pw([e]):e)).flat();return this.bind({tools:n,...t})}async completionWithRetry(e,t){const{MistralClient:n}=await this.imports(),r=new n(this.apiKey,this.endpoint);return this.caller.call((async()=>{try{let n;return n=t?r.chatStream(e):await r.chat(e),n}catch(e){throw e.message?.includes("status: 400")&&(e.status=400),e}}))}async _generate(e,t,n){const r={},s={...this.invocationParams(t),messages:uw(e)},a=!!t.signal??!!t.timeout;if(this.streaming||a){const s=this._streamResponseChunks(e,t,n),a={};for await(const e of s){const t=e.generationInfo?.completion??0;void 0===a[t]?a[t]=e:a[t]=a[t].concat(e)}const i=Object.entries(a).sort((([e],[t])=>parseInt(e,10)-parseInt(t,10))).map((([e,t])=>t));return{generations:i,llmOutput:{estimatedTokenUsage:r}}}const i=await this.completionWithRetry(s,!1),{completion_tokens:o,prompt_tokens:l,total_tokens:c}=i?.usage??{};o&&(r.completionTokens=(r.completionTokens??0)+o),l&&(r.promptTokens=(r.promptTokens??0)+l),c&&(r.totalTokens=(r.totalTokens??0)+c);const u=[];for(const e of i?.choices??[]){if("delta"in e)throw new Error("Delta not supported in non-streaming mode.");if(!("message"in e))throw new Error("No message found in the choice.");const t={text:e.message?.content??"",message:dw(e,i?.usage)};e.finish_reason&&(t.generationInfo={finish_reason:e.finish_reason}),u.push(t)}return{generations:u,llmOutput:{tokenUsage:r}}}async*_streamResponseChunks(e,t,n){const r=uw(e),s={...this.invocationParams(t),messages:r},a=await this.completionWithRetry(s,!0);for await(const e of a){if(t.signal?.aborted)throw new Error("AbortError");const r=e?.choices[0];if(!r||!("delta"in r))continue;const{delta:s}=r;if(!s)continue;const a={prompt:0,completion:r.index??0},i=hw(s,this.streamUsage||t.streamUsage?e.usage:null);if(null===i)continue;const o=new nf({message:i,text:s.content??"",generationInfo:a});yield o,n?.handleLLMNewToken(o.text??"",a,void 0,void 0,void 0,{chunk:o})}}_combineLLMOutput(){return[]}withStructuredOutput(e,t){let n,r,s,a,i,o;if(!function(e){return void 0!==e&&"object"==typeof e.schema}(e)?(n=e,r=t?.name,s=t?.method,a=t?.includeRaw):(n=e.schema,r=e.name,s=e.method,a=e.includeRaw),"jsonMode"===s)i=this.bind({response_format:{type:"json_object"}}),o=mw(n)?gg.fromZodSchema(n):new yg;else{let e=r??"extract";if(mw(n)){const t=Ps(n);i=this.bind({tools:[{type:"function",function:{name:e,description:t.description,parameters:t}}],tool_choice:"any"}),o=new kg({returnSingle:!0,keyName:e,zodSchema:n})}else{let t;"string"==typeof n.name&&"object"==typeof n.parameters&&null!=n.parameters?(t=n,e=n.name):t={name:e,description:n.description??"",parameters:n},i=this.bind({tools:[{type:"function",function:t}],tool_choice:"any"}),o=new kg({returnSingle:!0,keyName:e})}}if(!a)return i.pipe(o);const l=ng.assign({parsed:(e,t)=>o.invoke(e.raw,t)}),c=ng.assign({parsed:()=>null}),u=l.withFallbacks({fallbacks:[c]});return fm.from([{raw:i},u])}async imports(){const{default:e}=await Promise.resolve().then((function(){return fv}));return{MistralClient:e}}}function mw(e){return"function"==typeof e?.parse}class gw extends hc{addUserMessage(e){return this.addMessage(new xc(e))}addAIChatMessage(e){return this.addMessage(new _c(e))}addAIMessage(e){return this.addMessage(new _c(e))}async addMessages(e){for(const t of e)await this.addMessage(t)}clear(){throw new Error("Not implemented.")}}class yw extends gw{constructor(e){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","stores","message","in_memory"]}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.messages=e??[]}async getMessages(){return this.messages}async addMessage(e){this.messages.push(e)}async clear(){this.messages=[]}}class bw extends um{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},n={};for(const[e,r]of Object.entries(t))n[e]="string"==typeof r?r:await r();return{...n,...e}}async invoke(e,t){return this._callWithConfig((e=>this.formatPromptValue(e)),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await Promise.resolve().then((function(){return Vw}));return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await Promise.resolve().then((function(){return Vw}));return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await Promise.resolve().then((function(){return lv}));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}class ww extends bw{async formatPromptValue(e){const t=await this.format(e);return new $m(t)}}
/*!
   * mustache.js - Logic-less {{mustache}} templates with JavaScript
   * http://github.com/janl/mustache.js
   */var vw=Object.prototype.toString,_w=Array.isArray||function(e){return"[object Array]"===vw.call(e)};function kw(e){return"function"==typeof e}function Ew(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Ow(e,t){return null!=e&&"object"==typeof e&&t in e}var Sw=RegExp.prototype.test;var Tw=/\S/;function xw(e){return!function(e,t){return Sw.call(e,t)}(Tw,e)}var Aw={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};var Iw=/\s*/,Pw=/\s+/,Cw=/\s*=/,Rw=/\s*\}/,Nw=/#|\^|\/|>|\{|&|=|!/;function $w(e){this.string=e,this.tail=e,this.pos=0}function jw(e,t){this.view=e,this.cache={".":this.view},this.parent=t}function Lw(){this.templateCache={_cache:{},set:function(e,t){this._cache[e]=t},get:function(e){return this._cache[e]},clear:function(){this._cache={}}}}$w.prototype.eos=function(){return""===this.tail},$w.prototype.scan=function(e){var t=this.tail.match(e);if(!t||0!==t.index)return"";var n=t[0];return this.tail=this.tail.substring(n.length),this.pos+=n.length,n},$w.prototype.scanUntil=function(e){var t,n=this.tail.search(e);switch(n){case-1:t=this.tail,this.tail="";break;case 0:t="";break;default:t=this.tail.substring(0,n),this.tail=this.tail.substring(n)}return this.pos+=t.length,t},jw.prototype.push=function(e){return new jw(e,this)},jw.prototype.lookup=function(e){var t,n,r,s=this.cache;if(s.hasOwnProperty(e))t=s[e];else{for(var a,i,o,l=this,c=!1;l;){if(e.indexOf(".")>0)for(a=l.view,i=e.split("."),o=0;null!=a&&o<i.length;)o===i.length-1&&(c=Ow(a,i[o])||(n=a,r=i[o],null!=n&&"object"!=typeof n&&n.hasOwnProperty&&n.hasOwnProperty(r))),a=a[i[o++]];else a=l.view[e],c=Ow(l.view,e);if(c){t=a;break}l=l.parent}s[e]=t}return kw(t)&&(t=t.call(this.view)),t},Lw.prototype.clearCache=function(){void 0!==this.templateCache&&this.templateCache.clear()},Lw.prototype.parse=function(e,t){var n=this.templateCache,r=e+":"+(t||Mw.tags).join(":"),s=void 0!==n,a=s?n.get(r):void 0;return null==a&&(a=function(e,t){if(!e)return[];var n,r,s,a=!1,i=[],o=[],l=[],c=!1,u=!1,d="",h=0;function p(){if(c&&!u)for(;l.length;)delete o[l.pop()];else l=[];c=!1,u=!1}function f(e){if("string"==typeof e&&(e=e.split(Pw,2)),!_w(e)||2!==e.length)throw new Error("Invalid tags: "+e);n=new RegExp(Ew(e[0])+"\\s*"),r=new RegExp("\\s*"+Ew(e[1])),s=new RegExp("\\s*"+Ew("}"+e[1]))}f(t||Mw.tags);for(var m,g,y,b,w,v,_=new $w(e);!_.eos();){if(m=_.pos,y=_.scanUntil(n))for(var k=0,E=y.length;k<E;++k)xw(b=y.charAt(k))?(l.push(o.length),d+=b):(u=!0,a=!0,d+=" "),o.push(["text",b,m,m+1]),m+=1,"\n"===b&&(p(),d="",h=0,a=!1);if(!_.scan(n))break;if(c=!0,g=_.scan(Nw)||"name",_.scan(Iw),"="===g?(y=_.scanUntil(Cw),_.scan(Cw),_.scanUntil(r)):"{"===g?(y=_.scanUntil(s),_.scan(Rw),_.scanUntil(r),g="&"):y=_.scanUntil(r),!_.scan(r))throw new Error("Unclosed tag at "+_.pos);if(w=">"==g?[g,y,m,_.pos,d,h,a]:[g,y,m,_.pos],h++,o.push(w),"#"===g||"^"===g)i.push(w);else if("/"===g){if(!(v=i.pop()))throw new Error('Unopened section "'+y+'" at '+m);if(v[1]!==y)throw new Error('Unclosed section "'+v[1]+'" at '+m)}else"name"===g||"{"===g||"&"===g?u=!0:"="===g&&f(y)}if(p(),v=i.pop())throw new Error('Unclosed section "'+v[1]+'" at '+_.pos);return function(e){for(var t,n=[],r=n,s=[],a=0,i=e.length;a<i;++a)switch((t=e[a])[0]){case"#":case"^":r.push(t),s.push(t),r=t[4]=[];break;case"/":s.pop()[5]=t[2],r=s.length>0?s[s.length-1][4]:n;break;default:r.push(t)}return n}(function(e){for(var t,n,r=[],s=0,a=e.length;s<a;++s)(t=e[s])&&("text"===t[0]&&n&&"text"===n[0]?(n[1]+=t[1],n[3]=t[3]):(r.push(t),n=t));return r}(o))}(e,t),s&&n.set(r,a)),a},Lw.prototype.render=function(e,t,n,r){var s=this.getConfigTags(r),a=this.parse(e,s),i=t instanceof jw?t:new jw(t,void 0);return this.renderTokens(a,i,n,e,r)},Lw.prototype.renderTokens=function(e,t,n,r,s){for(var a,i,o,l="",c=0,u=e.length;c<u;++c)o=void 0,"#"===(i=(a=e[c])[0])?o=this.renderSection(a,t,n,r,s):"^"===i?o=this.renderInverted(a,t,n,r,s):">"===i?o=this.renderPartial(a,t,n,s):"&"===i?o=this.unescapedValue(a,t):"name"===i?o=this.escapedValue(a,t,s):"text"===i&&(o=this.rawValue(a)),void 0!==o&&(l+=o);return l},Lw.prototype.renderSection=function(e,t,n,r,s){var a=this,i="",o=t.lookup(e[1]);if(o){if(_w(o))for(var l=0,c=o.length;l<c;++l)i+=this.renderTokens(e[4],t.push(o[l]),n,r,s);else if("object"==typeof o||"string"==typeof o||"number"==typeof o)i+=this.renderTokens(e[4],t.push(o),n,r,s);else if(kw(o)){if("string"!=typeof r)throw new Error("Cannot use higher-order sections without the original template");null!=(o=o.call(t.view,r.slice(e[3],e[5]),(function(e){return a.render(e,t,n,s)})))&&(i+=o)}else i+=this.renderTokens(e[4],t,n,r,s);return i}},Lw.prototype.renderInverted=function(e,t,n,r,s){var a=t.lookup(e[1]);if(!a||_w(a)&&0===a.length)return this.renderTokens(e[4],t,n,r,s)},Lw.prototype.indentPartial=function(e,t,n){for(var r=t.replace(/[^ \t]/g,""),s=e.split("\n"),a=0;a<s.length;a++)s[a].length&&(a>0||!n)&&(s[a]=r+s[a]);return s.join("\n")},Lw.prototype.renderPartial=function(e,t,n,r){if(n){var s=this.getConfigTags(r),a=kw(n)?n(e[1]):n[e[1]];if(null!=a){var i=e[6],o=e[5],l=e[4],c=a;0==o&&l&&(c=this.indentPartial(a,l,i));var u=this.parse(c,s);return this.renderTokens(u,t,n,c,r)}}},Lw.prototype.unescapedValue=function(e,t){var n=t.lookup(e[1]);if(null!=n)return n},Lw.prototype.escapedValue=function(e,t,n){var r=this.getConfigEscape(n)||Mw.escape,s=t.lookup(e[1]);if(null!=s)return"number"==typeof s&&r===Mw.escape?String(s):r(s)},Lw.prototype.rawValue=function(e){return e[1]},Lw.prototype.getConfigTags=function(e){return _w(e)?e:e&&"object"==typeof e?e.tags:void 0},Lw.prototype.getConfigEscape=function(e){return e&&"object"==typeof e&&!_w(e)?e.escape:void 0};var Mw={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){Dw.templateCache=e},get templateCache(){return Dw.templateCache}},Dw=new Lw;function Uw(){Mw.escape=e=>e}Mw.clearCache=function(){return Dw.clearCache()},Mw.parse=function(e,t){return Dw.parse(e,t)},Mw.render=function(e,t,n,r){if("string"!=typeof e)throw new TypeError('Invalid template! Template should be a "string" but "'+function(e){return _w(e)?"array":typeof e}(e)+'" was given as the first argument for mustache#render(template, view, partials)');return Dw.render(e,t,n,r)},Mw.escape=function(e){return String(e).replace(/[&<>"'`=\/]/g,(function(e){return Aw[e]}))},Mw.Scanner=$w,Mw.Context=jw,Mw.Writer=Lw;const Fw=e=>{const t=e.split(""),n=[],r=(e,n)=>{for(let r=n;r<t.length;r+=1)if(e.includes(t[r]))return r;return-1};let s=0;for(;s<t.length;)if("{"===t[s]&&s+1<t.length&&"{"===t[s+1])n.push({type:"literal",text:"{"}),s+=2;else if("}"===t[s]&&s+1<t.length&&"}"===t[s+1])n.push({type:"literal",text:"}"}),s+=2;else if("{"===t[s]){const e=r("}",s);if(e<0)throw new Error("Unclosed '{' in template.");n.push({type:"variable",name:t.slice(s+1,e).join("")}),s=e+1}else{if("}"===t[s])throw new Error("Single '}' in template.");{const e=r("{}",s),a=(e<0?t.slice(s):t.slice(s,e)).join("");n.push({type:"literal",text:a}),s=e<0?t.length:e}}return n},Bw=e=>{Uw();return(e=>e.map((e=>"name"===e[0]?{type:"variable",name:e[1].includes(".")?e[1].split(".")[0]:e[1]}:["#","&","^",">"].includes(e[0])?{type:"variable",name:e[1]}:{type:"literal",text:e[1]})))(Mw.parse(e))},qw={"f-string":(e,t)=>Fw(e).reduce(((e,n)=>{if("variable"===n.type){if(n.name in t)return e+t[n.name];throw new Error(`(f-string) Missing value for input ${n.name}`)}return e+n.text}),""),mustache:(e,t)=>(Uw(),Mw.render(e,t))},zw={"f-string":Fw,mustache:Bw},Hw=(e,t,n)=>qw[t](e,n),Ww=(e,t,n)=>{if(!(t in qw)){const e=Object.keys(qw);throw new Error(`Invalid template format. Got \`${t}\`;\n                         should be one of ${e}`)}try{const r=n.reduce(((e,t)=>(e[t]="foo",e)),{});Array.isArray(e)?e.forEach((e=>{if("text"===e.type)Hw(e.text,t,r);else{if("image_url"!==e.type)throw new Error(`Invalid message template received. ${JSON.stringify(e,null,2)}`);if("string"==typeof e.image_url)Hw(e.image_url,t,r);else{const n=e.image_url.url;Hw(n,t,r)}}})):Hw(e,t,r)}catch(e){throw new Error(`Invalid prompt schema: ${e.message}`)}};class Kw extends ww{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){if("mustache"===this.templateFormat)throw new Error("Mustache templates cannot be validated.");let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Ww(this.template,this.templateFormat,e)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return Hw(this.template,this.templateFormat,t)}static fromExamples(e,t,n,r="\n\n",s=""){const a=[s,...e,t].join(r);return new Kw({inputVariables:n,template:a})}static fromTemplate(e,t){const{templateFormat:n="f-string",...r}=t??{},s=new Set;return((e,t)=>zw[t](e))(e,n).forEach((e=>{"variable"===e.type&&s.add(e.name)})),new Kw({inputVariables:[...s],templateFormat:n,template:e,...r})}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new Kw(r)}serialize(){if(void 0!==this.outputParser)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new Kw({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}var Vw=Object.freeze({__proto__:null,PromptTemplate:Kw});class Gw extends bw{static lc_name(){return"ImagePromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","image"]}),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.template=e.template,this.templateFormat=e.templateFormat??this.templateFormat,this.validateTemplate=e.validateTemplate??this.validateTemplate,this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Ww([{type:"image_url",image_url:this.template}],this.templateFormat,e)}}_getPromptType(){return"prompt"}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new Gw(r)}async format(e){const t={};for(const[n,r]of Object.entries(this.template))t[n]="string"==typeof r?Hw(r,this.templateFormat,e):r;const n=e.url||t.url,r=e.detail||t.detail;if(!n)throw new Error("Must provide either an image URL.");if("string"!=typeof n)throw new Error("url must be a string.");const s={url:n};return r&&(s.detail=r),s}async formatPromptValue(e){const t=await this.format(e);return new Lm(t)}}class Zw extends um{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}async invoke(e,t){return this._callWithConfig((e=>this.formatMessages(e)),e,{...t,runType:"prompt"})}}class Jw extends Zw{static lc_name(){return"MessagesPlaceholder"}constructor(e){"string"==typeof e&&(e={variableName:e}),super(e),Object.defineProperty(this,"variableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"optional",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.variableName=e.variableName,this.optional=e.optional??!1}get inputVariables(){return[this.variableName]}async formatMessages(e){const t=e[this.variableName];if(this.optional&&!t)return[];if(!t){const e=new Error(`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages as an input value. Received: undefined`);throw e.name="InputFormatError",e}let n;try{n=Array.isArray(t)?t.map(Rc):[Rc(t)]}catch(e){const n="string"==typeof t?t:JSON.stringify(t,null,2),r=new Error([`Field "${this.variableName}" in prompt uses a MessagesPlaceholder, which expects an array of BaseMessages or coerceable values as input.`,`Received value: ${n}`,`Additional message: ${e.message}`].join("\n\n"));throw r.name="InputFormatError",r}return n}}class Xw extends Zw{constructor(e){"prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt}get inputVariables(){return this.prompt.inputVariables}async formatMessages(e){return[await this.format(e)]}}class Yw extends bw{constructor(e){super(e)}async format(e){return(await this.formatPromptValue(e)).toString()}async formatPromptValue(e){const t=await this.formatMessages(e);return new jm(t)}}class Qw extends Xw{static lc_name(){return"ChatMessagePromptTemplate"}constructor(e,t){"prompt"in e||(e={prompt:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}async format(e){return new Oc(await this.prompt.format(e),this.role)}static fromTemplate(e,t,n){return new this(Kw.fromTemplate(e,{templateFormat:n?.templateFormat}),t)}}class ev extends Zw{static _messageClass(){throw new Error("Can not invoke _messageClass from inside _StringImageMessagePromptTemplate")}constructor(e,t){if("prompt"in e||(e={prompt:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts","chat"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"additionalOptions",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"prompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"messageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"chatMessageClass",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.prompt=e.prompt,Array.isArray(this.prompt)){let e=[];this.prompt.forEach((t=>{"inputVariables"in t&&(e=e.concat(t.inputVariables))})),this.inputVariables=e}else this.inputVariables=this.prompt.inputVariables;this.additionalOptions=t??this.additionalOptions}createMessage(e){const t=this.constructor;if(t._messageClass()){return new(t._messageClass())({content:e})}if(t.chatMessageClass){const n=t.chatMessageClass();return new n({content:e,role:this.getRoleFromMessageClass(n.lc_name())})}throw new Error("No message class defined")}getRoleFromMessageClass(e){switch(e){case"HumanMessage":return"human";case"AIMessage":return"ai";case"SystemMessage":return"system";case"ChatMessage":return"chat";default:throw new Error("Invalid message class name")}}static fromTemplate(e,t){if("string"==typeof e)return new this(Kw.fromTemplate(e,t));const n=[];for(const r of e)if("string"==typeof r||"object"==typeof r&&"text"in r){let e="";"string"==typeof r?e=r:"string"==typeof r.text&&(e=r.text??""),n.push(Kw.fromTemplate(e,t))}else if("object"==typeof r&&"image_url"in r){let e,s=r.image_url??"",a=[];if("string"==typeof s){let n;n="mustache"===t?.templateFormat?Bw(s):Fw(s);const r=n.flatMap((e=>"variable"===e.type?[e.name]:[]));if((r?.length??0)>0){if(r.length>1)throw new Error(`Only one format variable allowed per image template.\nGot: ${r}\nFrom: ${s}`);a=[r[0]]}else a=[];s={url:s},e=new Gw({template:s,inputVariables:a,templateFormat:t?.templateFormat})}else{if("object"!=typeof s)throw new Error("Invalid image template");if("url"in s){let e;e="mustache"===t?.templateFormat?Bw(s.url):Fw(s.url),a=e.flatMap((e=>"variable"===e.type?[e.name]:[]))}else a=[];e=new Gw({template:s,inputVariables:a,templateFormat:t?.templateFormat})}n.push(e)}return new this({prompt:n,additionalOptions:t})}async format(e){if(this.prompt instanceof ww){const t=await this.prompt.format(e);return this.createMessage(t)}{const t=[];for(const n of this.prompt){let r={};if(!("inputVariables"in n))throw new Error(`Prompt ${n} does not have inputVariables defined.`);for(const t of n.inputVariables)r||(r={[t]:e[t]}),r={...r,[t]:e[t]};if(n instanceof ww){const e=await n.format(r);t.push({type:"text",text:e})}else if(n instanceof Gw){const e=await n.format(r);t.push({type:"image_url",image_url:e})}}return this.createMessage(t)}}async formatMessages(e){return[await this.format(e)]}}class tv extends ev{static _messageClass(){return xc}static lc_name(){return"HumanMessagePromptTemplate"}}class nv extends ev{static _messageClass(){return _c}static lc_name(){return"AIMessagePromptTemplate"}}class rv extends ev{static _messageClass(){return Ic}static lc_name(){return"SystemMessagePromptTemplate"}}function sv(e,t){if("function"==typeof e.formatMessages||wc(e))return e;if(Array.isArray(e)&&"placeholder"===e[0]){const t=e[1];if("string"!=typeof t||"{"!==t[0]||"}"!==t[t.length-1])throw new Error(`Invalid placeholder template: "${e[1]}". Expected a variable name surrounded by curly braces.`);const n=t.slice(1,-1);return new Jw({variableName:n,optional:!0})}const n=Rc(e);let r;if(r="string"==typeof n.content?n.content:n.content.map((e=>"text"in e?{text:e.text}:"image_url"in e?{image_url:e.image_url}:e)),"human"===n._getType())return tv.fromTemplate(r,t);if("ai"===n._getType())return nv.fromTemplate(r,t);if("system"===n._getType())return rv.fromTemplate(r,t);if(Oc.isInstance(n))return Qw.fromTemplate(n.content,n.role,t);throw new Error(`Could not coerce message prompt template from input. Received message type: "${n._getType()}".`)}function av(e){return"MessagesPlaceholder"===e.constructor.lc_name()}class iv extends Yw{static lc_name(){return"ChatPromptTemplate"}get lc_aliases(){return{promptMessages:"messages"}}constructor(e){if(super(e),Object.defineProperty(this,"promptMessages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),"mustache"===e.templateFormat&&void 0===e.validateTemplate&&(this.validateTemplate=!1),Object.assign(this,e),this.validateTemplate){const e=new Set;for(const t of this.promptMessages)if(!(t instanceof fc))for(const n of t.inputVariables)e.add(n);const t=this.inputVariables,n=new Set(this.partialVariables?t.concat(Object.keys(this.partialVariables)):t),r=new Set([...n].filter((t=>!e.has(t))));if(r.size>0)throw new Error(`Input variables \`${[...r]}\` are not used in any of the prompt messages.`);const s=new Set([...e].filter((e=>!n.has(e))));if(s.size>0)throw new Error(`Input variables \`${[...s]}\` are used in prompt messages but not in the prompt template.`)}}_getPromptType(){return"chat"}async _parseImagePrompts(e,t){if("string"==typeof e.content)return e;const n=await Promise.all(e.content.map((async e=>{if("image_url"!==e.type)return e;let n="";n="string"==typeof e.image_url?e.image_url:e.image_url.url;const r=Kw.fromTemplate(n,{templateFormat:this.templateFormat}),s=await r.format(t);return"string"!=typeof e.image_url&&"url"in e.image_url?e.image_url.url=s:e.image_url=s,e})));return e.content=n,e}async formatMessages(e){const t=await this.mergePartialAndUserVariables(e);let n=[];for(const e of this.promptMessages)if(e instanceof fc)n.push(await this._parseImagePrompts(e,t));else{const r=e.inputVariables.reduce(((n,r)=>{if(!(r in t||av(e)&&e.optional))throw new Error(`Missing value for input variable \`${r.toString()}\``);return n[r]=t[r],n}),{}),s=await e.formatMessages(r);n=n.concat(s)}return n}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new iv(r)}static fromTemplate(e,t){const n=Kw.fromTemplate(e,t),r=new tv({prompt:n});return this.fromMessages([r])}static fromMessages(e,t){const n=e.reduce(((e,n)=>e.concat(n instanceof iv?n.promptMessages:[sv(n,t)])),[]),r=e.reduce(((e,t)=>t instanceof iv?Object.assign(e,t.partialVariables):e),Object.create(null)),s=new Set;for(const e of n)if(!(e instanceof fc))for(const t of e.inputVariables)t in r||s.add(t);return new this({...t,inputVariables:[...s],promptMessages:n,partialVariables:r,templateFormat:t?.templateFormat})}static fromPromptMessages(e){return this.fromMessages(e)}}class ov extends ww{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"examples",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleSelector",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"examplePrompt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"suffix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"exampleSeparator",{enumerable:!0,configurable:!0,writable:!0,value:"\n\n"}),Object.defineProperty(this,"prefix",{enumerable:!0,configurable:!0,writable:!0,value:""}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),void 0!==this.examples&&void 0!==this.exampleSelector)throw new Error("Only one of 'examples' and 'example_selector' should be provided");if(void 0===this.examples&&void 0===this.exampleSelector)throw new Error("One of 'examples' and 'example_selector' should be provided");if(this.validateTemplate){let e=this.inputVariables;this.partialVariables&&(e=e.concat(Object.keys(this.partialVariables))),Ww(this.prefix+this.suffix,this.templateFormat,e)}}_getPromptType(){return"few_shot"}static lc_name(){return"FewShotPromptTemplate"}async getExamples(e){if(void 0!==this.examples)return this.examples;if(void 0!==this.exampleSelector)return this.exampleSelector.selectExamples(e);throw new Error("One of 'examples' and 'example_selector' should be provided")}async partial(e){const t=this.inputVariables.filter((t=>!(t in e))),n={...this.partialVariables??{},...e},r={...this,inputVariables:t,partialVariables:n};return new ov(r)}async format(e){const t=await this.mergePartialAndUserVariables(e),n=await this.getExamples(t),r=await Promise.all(n.map((e=>this.examplePrompt.format(e)))),s=[this.prefix,...r,this.suffix].join(this.exampleSeparator);return Hw(s,this.templateFormat,t)}serialize(){if(this.exampleSelector||!this.examples)throw new Error("Serializing an example selector is not currently supported");if(void 0!==this.outputParser)throw new Error("Serializing an output parser is not currently supported");return{_type:this._getPromptType(),input_variables:this.inputVariables,example_prompt:this.examplePrompt.serialize(),example_separator:this.exampleSeparator,suffix:this.suffix,prefix:this.prefix,template_format:this.templateFormat,examples:this.examples}}static async deserialize(e){const{example_prompt:t}=e;if(!t)throw new Error("Missing example prompt");const n=await Kw.deserialize(t);let r;if(!Array.isArray(e.examples))throw new Error("Invalid examples format. Only list or string are supported.");return r=e.examples,new ov({inputVariables:e.input_variables,examplePrompt:n,examples:r,exampleSeparator:e.example_separator,prefix:e.prefix,suffix:e.suffix,templateFormat:e.template_format})}}var lv=Object.freeze({__proto__:null,FewShotPromptTemplate:ov});class cv extends Rs{#T;constructor(e){super(e)}get executableAgent(){return{}}initialize(e,t){if(this.store=e,this.env=t,this.llmInstance){const e={...this.llmInstance.lc_kwargs,provider:this.llmInstance.lc_namespace[this.llmInstance.lc_namespace.length-1]};this.llmConfig=e}else{const e=function(e,t){return e?.apiKey?e.apiKey:{anthropic:t.ANTHROPIC_API_KEY,google:t.GOOGLE_API_KEY,mistral:t.MISTRAL_API_KEY,openai:t.OPENAI_API_KEY}[e?.provider]}(this.llmConfig,this.env);if(!e&&!this.llmConfig.apiBaseUrl)throw new Error("API key is missing. Please provide it through the Agent llmConfig or through the team env variable.");this.llmConfig.apiKey=e;const t={anthropic:mb,google:cw,mistral:fw,openai:Ig}[this.llmConfig.provider]||Ig;this.llmInstance=new t(this.llmConfig)}this.interactionsHistory=new yw}async workOnTask(e,t,n){const r=this.prepareAgentForTask(e,t,n);return this.#T=r.executableAgent,await this.agenticLoop(this,e,this.#T,r.initialFeedbackMessage)}async workOnFeedback(e,t){const n=t.map((e=>e.content)).join(", "),r=this.promptTemplates.WORK_ON_FEEDBACK_FEEDBACK({agent:this,task:e,feedback:n});return await this.agenticLoop(this,e,this.#T,r)}prepareAgentForTask(e,t,n){const r=Se(e.description,t),s=this.buildSystemMessage(this,e,r),a=this.buildInitialMessage(this,e,r,n);this.llmSystemMessage=s;const i=iv.fromMessages([new Ic(s),["placeholder","{chat_history}"],["human","{feedbackMessage}"]]).pipe(this.llmInstance);return{executableAgent:new lg({runnable:i,getMessageHistory:()=>this.interactionsHistory,inputMessagesKey:"feedbackMessage",historyMessagesKey:"chat_history"}),initialFeedbackMessage:a}}async agenticLoop(e,t,n,r){let s=r,a=null,i=0;const o=e.maxIterations;let l=null;for(;!a&&i<o&&!l;){try{e.handleIterationStart({agent:e,task:t,iterations:i,maxAgentIterations:o}),e.forceFinalAnswer&&i===o-2&&(s=this.promptTemplates.FORCE_FINAL_ANSWER_FEEDBACK({agent:e,task:t,iterations:i,maxAgentIterations:o}));const r=await this.executeThinking(e,t,n,s),l=r.parsedLLMOutput,c=this.determineActionType(l);switch(c){case Q:s=this.handleIssuesParsingLLMOutput({agent:e,task:t,output:r});break;case J:a=this.handleFinalAnswer({agent:e,task:t,parsedLLMOutput:l});break;case z:s=this.handleThought({agent:e,task:t,parsedLLMOutput:l});break;case ee:s=this.handleSelfQuestion({agent:e,task:t,parsedLLMOutput:l});break;case H:ke.debug(`â© Agent ${e.name} will be ${H}...`);{const n=l.action,r=this.tools.find((e=>e.name===n));if(r)try{s=await this.executeUsingTool({agent:e,task:t,parsedLLMOutput:l,tool:r})}catch(n){s=this.handleUsingToolError({agent:e,task:t,parsedLLMOutput:l,tool:r,error:n})}else s=this.handleToolDoesNotExist({agent:e,task:t,parsedLLMOutput:l,toolName:n})}break;case Z:s=this.handleObservation({agent:e,task:t,parsedLLMOutput:l});break;case se:s=this.handleWeirdOutput({agent:e,task:t,parsedLLMOutput:l});break;default:ke.warn(`Unhandled agent status: ${c}`)}}catch(n){"LLMInvocationError"===n.name?e.handleThinkingError({agent:e,task:t,error:n}):this.handleAgenticLoopError({agent:e,task:t,error:n,iterations:i,maxAgentIterations:o}),l=n;break}e.handleIterationEnd({agent:e,task:t,iterations:i,maxAgentIterations:o}),i++}return l?{error:"Execution stopped due to a critical error: "+l.message,metadata:{iterations:i,maxAgentIterations:o}}:a?(this.handleTaskCompleted({agent:e,task:t,parsedResultWithFinalAnswer:a,iterations:i,maxAgentIterations:o}),{result:a,metadata:{iterations:i,maxAgentIterations:o}}):i>=o?(this.handleMaxIterationsError({agent:e,task:t,iterations:i,maxAgentIterations:o}),{error:"Task incomplete: reached maximum iterations without final answer.",metadata:{iterations:i,maxAgentIterations:o}}):{error:"Execution terminated unexpectedly without results.",metadata:{iterations:i,maxAgentIterations:o}}}buildSystemMessage(e,t,n){return this.promptTemplates.SYSTEM_MESSAGE({agent:e,task:{...t,description:n}})}buildInitialMessage(e,t,n,r){return this.promptTemplates.INITIAL_MESSAGE({agent:e,task:{...t,description:n},context:r})}determineActionType(e){return null===e?Q:e.finalAnswer?J:"self_question"===e.action?e.thought?z:ee:e.action?H:e.observation?Z:se}handleIterationStart({agent:e,task:t,iterations:n,maxAgentIterations:r}){e.store.getState().handleAgentIterationStart({agent:e,task:t,iterations:n,maxAgentIterations:r})}handleIterationEnd({agent:e,task:t,iterations:n,maxAgentIterations:r}){e.store.getState().handleAgentIterationEnd({agent:e,task:t,iterations:n,maxAgentIterations:r})}async handleThinkingStart({agent:e,task:t,messages:n}){try{const r=n.flatMap((e=>e.map((e=>({type:e.constructor.name,content:e.content})))));return e.store.getState().handleAgentThinkingStart({agent:e,task:t,messages:r}),r}catch(e){throw ke.debug(`AGENT/handleThinkingStart: Error processing thinking messages: ${e.message}`),e}}async handleThinkingEnd({agent:e,task:t,output:n}){try{const r=new mg;if(!n.generations||!n.generations[0]||!n.generations[0][0].message)throw new Error("Invalid output structure");const{message:s}=n.generations[0][0],a=await r.invoke(s),i=function(e){try{return JSON.parse(e)}catch{const t={thought:/"thought"\s*:\s*"([^"]*)"/,action:/"action"\s*:\s*"([^"]*)"/,actionInput:/"actionInput"\s*:\s*({[^}]*})/,observation:/"observation"\s*:\s*"([^"]*)"/,isFinalAnswerReady:/"isFinalAnswerReady"\s*:\s*(true|false)/,finalAnswer:/"finalAnswer"\s*:\s*"([^"]*)"/};let n={};for(let r in t){const s=t[r],a=e.match(s);if(a)if("actionInput"===r)try{n[r]=JSON.parse(a[1].replace(/'/g,'"'))}catch{n[r]=null}else n[r]="isFinalAnswerReady"===r?"true"===a[1]:a[1]}return n}}(a),o={parsedLLMOutput:i,llmOutput:a,llmUsageStats:{inputTokens:s.usage_metadata?.input_tokens??-1,outputTokens:s.usage_metadata?.output_tokens??-1}};return e.store.getState().handleAgentThinkingEnd({agent:e,task:t,output:o}),o}catch(e){throw ke.debug(`AGENT/handleThinkingEnd: Error processing thinking result: ${e}`),e}}handleThinkingError({agent:e,task:t,error:n}){e.store.getState().handleAgentThinkingError({agent:e,task:t,error:n})}async executeThinking(e,t,n,r){return new Promise(((s,a)=>{n.invoke({feedbackMessage:r},{configurable:{sessionId:"foo-bar-baz"},callbacks:[{handleChatModelStart:(n,r)=>{e.handleThinkingStart({agent:e,task:t,messages:r}).catch((e=>{a(e)}))},handleLLMEnd:async n=>{e.handleThinkingEnd({agent:e,task:t,output:n}).then((e=>s(e))).catch((e=>{a(e)}))}}]}).catch((n=>{ke.error(`LLM_INVOCATION_ERROR: Error during LLM API call for Agent: ${e.name}, Task: ${t.id}. Details:`,n),a(new Te(`LLM API Error during executeThinking for Agent: ${e.name}, Task: ${t.id}`,n))}))}))}handleIssuesParsingLLMOutput({agent:e,task:t,output:n}){const r=new Error("Received an invalid JSON object from the LLM. Requesting a correctly formatted JSON response.",n.llmOutput);e.store.getState().handleAgentIssuesParsingLLMOutput({agent:e,task:t,output:n,error:r});return this.promptTemplates.INVALID_JSON_FEEDBACK({agent:e,task:t,llmOutput:n.llmOutput})}handleFinalAnswer({agent:e,task:t,parsedLLMOutput:n}){return n.finalAnswer&&"object"==typeof n.finalAnswer&&null!==n.finalAnswer&&(n.finalAnswer=JSON.stringify(n.finalAnswer)),e.store.getState().handleAgentFinalAnswer({agent:e,task:t,output:n}),n}handleThought({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleAgentThought({agent:e,task:t,output:n});let r=this.promptTemplates.THOUGHT_FEEDBACK({agent:e,task:t,thought:n.thought,parsedLLMOutput:n});if("self_question"===n.action&&n.actionInput){const s="object"==typeof n.actionInput?JSON.stringify(n.actionInput):n.actionInput;r=this.promptTemplates.THOUGHT_WITH_SELF_QUESTION_FEEDBACK({agent:e,task:t,thought:n.thought,question:s,parsedLLMOutput:n})}return r}handleSelfQuestion({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleAgentSelfQuestion({agent:e,task:t,output:n});return this.promptTemplates.SELF_QUESTION_FEEDBACK({agent:e,task:t,question:n.thought,parsedLLMOutput:n})}async executeUsingTool({agent:e,task:t,parsedLLMOutput:n,tool:r}){const s=n.actionInput;e.handleUsingToolStart({agent:e,task:t,tool:r,input:s});const a=await r.call(s);e.handleUsingToolEnd({agent:e,task:t,tool:r,output:a});return this.promptTemplates.TOOL_RESULT_FEEDBACK({agent:e,task:t,toolResult:a,parsedLLMOutput:n})}handleUsingToolStart({agent:e,task:t,tool:n,input:r}){e.store.getState().handleAgentToolStart({agent:e,task:t,tool:n,input:r})}handleUsingToolEnd({agent:e,task:t,tool:n,output:r}){e.store.getState().handleAgentToolEnd({agent:e,task:t,tool:n,output:r})}handleUsingToolError({agent:e,task:t,parsedLLMOutput:n,tool:r,error:s}){e.store.getState().handleAgentToolError({agent:e,task:t,tool:r,error:s});return this.promptTemplates.TOOL_ERROR_FEEDBACK({agent:e,task:t,toolName:n.action,error:s,parsedLLMOutput:n})}handleToolDoesNotExist({agent:e,task:t,parsedLLMOutput:n,toolName:r}){e.store.getState().handleAgentToolDoesNotExist({agent:e,task:t,toolName:r});return this.promptTemplates.TOOL_NOT_EXIST_FEEDBACK({agent:e,task:t,toolName:n.action,parsedLLMOutput:n})}handleObservation({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleAgentObservation({agent:e,task:t,output:n});return this.promptTemplates.OBSERVATION_FEEDBACK({agent:e,task:t,parsedLLMOutput:n})}handleWeirdOutput({agent:e,task:t,parsedLLMOutput:n}){e.store.getState().handleWeirdOutput({agent:e,task:t,output:n});return this.promptTemplates.WEIRD_OUTPUT_FEEDBACK({agent:e,task:t,parsedLLMOutput:n})}handleAgenticLoopError({agent:e,task:t,error:n,iterations:r,maxAgentIterations:s}){e.store.getState().handleAgentLoopError({agent:e,task:t,error:n,iterations:r,maxAgentIterations:s})}handleMaxIterationsError({agent:e,task:t,iterations:n,maxAgentIterations:r}){const s=new Error(`Agent ${e.name} reached the maximum number of iterations: [${r}] without finding a final answer.`);e.store.getState().handleAgentMaxIterationsError({agent:e,task:t,error:s,iterations:n,maxAgentIterations:r})}handleTaskCompleted({agent:e,task:t,parsedResultWithFinalAnswer:n,iterations:r,maxAgentIterations:s}){e.store.getState().handleAgentTaskCompleted({agent:e,task:t,result:n.finalAnswer,iterations:r,maxAgentIterations:s})}}const uv=[429,500,502,503,504],dv=Promise.resolve(globalThis.fetch??Promise.resolve().then((function(){return yv})).then((e=>e.default)));class hv extends Error{constructor(e){super(e),this.name="MistralAPIError"}}function pv(e){const t=new AbortController;return e.forEach((e=>{e&&(e.addEventListener("abort",(()=>{t.abort(e.reason)}),{once:!0}),e.aborted&&t.abort(e.reason))})),t.signal}var fv=Object.freeze({__proto__:null,default:class{constructor(e=process.env.MISTRAL_API_KEY,t="https://api.mistral.ai",n=5,r=120){this.endpoint=t,this.apiKey=e,this.maxRetries=n,this.timeout=r,this.endpoint.indexOf("inference.azure.com")&&(this.modelDefault="mistral")}async _fetch(...e){return(await dv)(...e)}_request=async function(e,t,n,r){const s=`${this.endpoint}/${t}`,a={method:e,headers:{"User-Agent":"mistral-client-js/0.3.0",Accept:n?.stream?"text/event-stream":"application/json","Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`},body:"get"!==e?JSON.stringify(n):null,signal:pv([AbortSignal.timeout(1e3*this.timeout),r])};for(let e=0;e<this.maxRetries;e++)try{const t=await this._fetch(s,a);if(t.ok){if(n?.stream){if(void 0===t.body.getReader)return t.body;{const e=t.body.getReader(),n=async function*(){try{for(;;){const{done:t,value:n}=await e.read();if(t)return;yield n}}finally{e.releaseLock()}};return n()}}return await t.json()}if(!uv.includes(t.status))throw new hv(`HTTP error! status: ${t.status} Response: \n${await t.text()}`);console.debug(`Retrying request on response status: ${t.status}`,`Response: ${await t.text()}`,`Attempt: ${e+1}`),await new Promise((t=>setTimeout(t,500*Math.pow(2,e+1))))}catch(t){if(console.error(`Request failed: ${t.message}`),"MistralAPIError"===t.name)throw t;if(e===this.maxRetries-1)throw t;await new Promise((t=>setTimeout(t,500*Math.pow(2,e+1))))}throw new Error("Max retries reached")};_makeChatCompletionRequest=function(e,t,n,r,s,a,i,o,l,c,u,d){if(!e&&!this.modelDefault)throw new hv("You must provide a model name");return{model:e??this.modelDefault,messages:t,tools:n??void 0,temperature:r??void 0,max_tokens:s??void 0,top_p:a??void 0,random_seed:i??void 0,stream:o??void 0,safe_prompt:(l||c)??void 0,tool_choice:u??void 0,response_format:d??void 0}};_makeCompletionRequest=function(e,t,n,r,s,a,i,o,l){if(!e&&!this.modelDefault)throw new hv("You must provide a model name");return{model:e??this.modelDefault,prompt:t,suffix:n??void 0,temperature:r??void 0,max_tokens:s??void 0,top_p:a??void 0,random_seed:i??void 0,stop:o??void 0,stream:l??void 0}};listModels=async function(){return await this._request("get","v1/models")};chat=async function({model:e,messages:t,tools:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,safeMode:o,safePrompt:l,toolChoice:c,responseFormat:u},{signal:d}={}){const h=this._makeChatCompletionRequest(e,t,n,r,s,a,i,!1,o,l,c,u);return await this._request("post","v1/chat/completions",h,d)};chatStream=async function*({model:e,messages:t,tools:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,safeMode:o,safePrompt:l,toolChoice:c,responseFormat:u},{signal:d}={}){const h=this._makeChatCompletionRequest(e,t,n,r,s,a,i,!0,o,l,c,u),p=await this._request("post","v1/chat/completions",h,d);let f="";const m=new TextDecoder;for await(const e of p){let t;for(f+=m.decode(e,{stream:!0});-1!==(t=f.indexOf("\n"));){const e=f.substring(0,t);if(f=f.substring(t+1),e.startsWith("data:")){const t=e.substring(6).trim();"[DONE]"!==t&&(yield JSON.parse(t))}}}};embeddings=async function({model:e,input:t}){const n={model:e,input:t};return await this._request("post","v1/embeddings",n)};completion=async function({model:e,prompt:t,suffix:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,stop:o},{signal:l}={}){const c=this._makeCompletionRequest(e,t,n,r,s,a,i,o,!1);return await this._request("post","v1/fim/completions",c,l)};completionStream=async function*({model:e,prompt:t,suffix:n,temperature:r,maxTokens:s,topP:a,randomSeed:i,stop:o},{signal:l}={}){const c=this._makeCompletionRequest(e,t,n,r,s,a,i,o,!0),u=await this._request("post","v1/fim/completions",c,l);let d="";const h=new TextDecoder;for await(const e of u){let t;for(d+=h.decode(e,{stream:!0});-1!==(t=d.indexOf("\n"));){const e=d.substring(0,t);if(d=d.substring(t+1),e.startsWith("data:")){const t=e.substring(6).trim();"[DONE]"!==t&&(yield JSON.parse(t))}}}}}}),mv={exports:{}};!function(e,t){var n=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==i)return i;throw new Error("unable to locate global object")}();e.exports=t=n.fetch,n.fetch&&(t.default=n.fetch.bind(n)),t.Headers=n.Headers,t.Request=n.Request,t.Response=n.Response}(mv,mv.exports);var gv=mv.exports,yv=r({__proto__:null,default:o(gv)},[gv]);e.Agent=class{constructor({type:e,...t}){this.agentInstance=this.createAgent(e,t),this.type=e||"ReactChampionAgent"}createAgent(e,t){return new cv(t)}workOnTask(e,t,n){return this.agentInstance.workOnTask(e,t,n)}workOnFeedback(e,t,n){return this.agentInstance.workOnFeedback(e,t,n)}setStatus(e){this.agentInstance.setStatus(e)}initialize(e,t){this.agentInstance.initialize(e,t)}get id(){return this.agentInstance.id}get name(){return this.agentInstance.name}get role(){return this.agentInstance.role}get goal(){return this.agentInstance.goal}get background(){return this.agentInstance.background}get tools(){return this.agentInstance.tools}get status(){return this.agentInstance.status}get llmConfig(){return this.agentInstance.llmConfig}get llmSystemMessage(){return this.agentInstance.llmSystemMessage}get forceFinalAnswer(){return this.agentInstance.forceFinalAnswer}get promptTemplates(){return this.agentInstance.promptTemplates}},e.Task=class{constructor({title:e="",description:n,expectedOutput:r,agent:s,isDeliverable:a=!1,externalValidationRequired:i=!1}){this.id=t.v4(),this.title=e,this.description=n,this.expectedOutput=r,this.isDeliverable=a,this.agent=s,this.status=ae,this.result=null,this.stats=null,this.duration=null,this.dependencies=[],this.interpolatedTaskDescription=null,this.feedbackHistory=[],this.externalValidationRequired=i}setStore(e){this.store=e}},e.Team=class{constructor({name:e,agents:t,tasks:n,logLevel:r,inputs:s={},env:a=null}){this.store=$t({name:e,agents:[],tasks:[],inputs:s,env:a,logLevel:r}),this.store.getState().addAgents(t),this.store.getState().addTasks(n)}async start(e=null){return new Promise(((t,n)=>{const r=this.store.subscribe((e=>e.teamWorkflowStatus),(e=>{const s=this.store.getState();switch(e){case ye:r(),t({status:e,result:s.workflowResult,stats:this.getWorkflowStats()});break;case ge:r(),n(new Error("Workflow encountered an error"));break;case be:r(),t({status:e,result:null,stats:this.getWorkflowStats()})}}));try{this.store.getState().startWorkflow(e)}catch(e){n(e),r()}}))}getStore(){return this.store}useStore(){return this.store}subscribeToChanges(e,t=[]){if(0===t.length)return this.store.subscribe(e);let n=t.reduce(((e,t)=>({...e,[t]:this.store.getState()[t]})),{});return this.store.subscribe((()=>{const r=this.store.getState();let s=!1;const a={};t.forEach((e=>{const t=r[e];t!==n[e]&&(s=!0,a[e]=t)})),s&&(n={...n,...a},e(a))}))}provideFeedback(e,t){this.store.getState().provideFeedback(e,t)}validateTask(e){this.store.getState().validateTask(e)}onWorkflowStatusChange(e){return this.store.subscribe((e=>e.teamWorkflowStatus),e)}getTasksByStatus(e){return this.store.getState().tasks.filter((t=>t.status===e))}getWorkflowStatus(){return this.store.getState().teamWorkflowStatus}getWorkflowResult(){const e=this.store.getState();return e.teamWorkflowStatus===ye?e.workflowResult:null}getTasks(){return this.store.getState().tasks}getWorkflowStats(){const e=this.store.getState().workflowLogs.find((e=>"WorkflowStatusUpdate"===e.logType&&("FINISHED"===e.workflowStatus||"BLOCKED"===e.workflowStatus)));if(e){const{startTime:t,endTime:n,duration:r,llmUsageStats:s,iterationCount:a,costDetails:i,teamName:o,taskCount:l,agentCount:c}=e.metadata;return{startTime:t,endTime:n,duration:r,llmUsageStats:s,iterationCount:a,costDetails:i,teamName:o,taskCount:l,agentCount:c}}return null}}}));
